
<!-- 
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                ‚ïë
‚ïë  ‚öñÔ∏è  OWNERSHIP NOTICE - HARDLOCKED                             ‚ïë
‚ïë                                                                ‚ïë
‚ïë  SOFTWARE OWNED BY: COLIN BEDFORD                             ‚ïë
‚ïë  COPYRIGHT: ¬© 2026 Colin Bedford                              ‚ïë
‚ïë  PROPERTY: Personal Intellectual Property                     ‚ïë
‚ïë                                                                ‚ïë
‚ïë  NOT OWNED BY: PAINTWORKZ PTY LTD                             ‚ïë
‚ïë  NOT PART OF BUSINESS ASSETS OR VALUATION                     ‚ïë
‚ïë                                                                ‚ïë
‚ïë  UNAUTHORIZED USE, COPYING, OR CLAIMING OWNERSHIP IS          ‚ïë
‚ïë  STRICTLY PROHIBITED AND MAY RESULT IN LEGAL ACTION.          ‚ïë
‚ïë                                                                ‚ïë
‚ïë  This notice is embedded in the source code and will remain   ‚ïë
‚ïë  in all versions of this software.                            ‚ïë
‚ïë                                                                ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<!--- 
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  üîÑ CACHE BUSTER - AUTOMATICALLY CLEARS OUTDATED CACHE       ‚ïë
‚ïë  Version: v1.7.24 | Updated: 2026-02-27                       ‚ïë
‚ïë  If version doesn't match, browser cache is cleared           ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
--->
<script>
(function() {
    const CURRENT_VERSION = 'v1.7.24';
    const VERSION_KEY = 'paintworkz_version';
    
    const storedVersion = localStorage.getItem(VERSION_KEY);
    
    // If version doesn't match, clear all caches and localStorage
    if (storedVersion !== CURRENT_VERSION) {
        console.log(`üîÑ VERSION CHANGE DETECTED: ${storedVersion || 'NONE'} ‚Üí ${CURRENT_VERSION}`);
        console.log('üóëÔ∏è Clearing old cache and localStorage...');
        
        // Clear localStorage (keeps jobHistory and other essential data)
        // Only clear UI/cache related items
        const keysToKeep = ['jobHistory', 'clientDatabase', 'appColors', 'adminAlerts'];
        const keysToDelete = [];
        
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!keysToKeep.includes(key) && key.includes('cache')) {
                keysToDelete.push(key);
            }
        }
        
        keysToDelete.forEach(key => {
            localStorage.removeItem(key);
            console.log(`  ‚úì Removed: ${key}`);
        });
        
        // Update version
        localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
        console.log(`‚úÖ Cache cleared. Version updated to: ${CURRENT_VERSION}`);
        
        // Force hard refresh
        if (window.location.pathname.includes('index.html')) {
            window.location.reload(true);
        }
    }
})();
</script>
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                       PAINTWORKZ PRO                            ‚ïë
‚ïë                    REVISION TRACKING                            ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë v1.7.24 | 2026-02-27 10:00 | ADMIN TABS FIX - COVER SHEET = SHOP LABEL - DELETE WARNING ‚ïë
‚ïë 1. ‚úì FIX: Client name edit syncs to all jobs referencing it REMOVED: Corrupted base64 logo (caused jsPDF failure)      ‚ïë
‚ïë 2. ‚úì FIX: Qty resets to 1 after add, cursor focuses on length REBUILT: 5 PDF functions (Estimate, Quote, Invoice, Mixing, Supply)            ‚ïë
‚ïë 3. ‚úì FIX: Color popup centered on screen, proper z-index ADDED: genPDF() main export function  ‚ïë
‚ïë 4. ‚úì ADD: Panel list filters (type/color/config/ss/ds/se) TESTED: All functions now functional ‚ïë 4. ‚úì ADD: Panel list filters (type/color/config/ss/ds/se) IMPROVED: Console logs non-critical errors error-safe        ‚ïë
‚ïë 5. ‚úì VERIFIED: Job auto-increment +manual override working VERIFIED: JavaScript syntax passes validation   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <title>PaintWorkz Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <style>
        :root {
            --gold: linear-gradient(145deg, #d4af37, #f9f1b0, #aa841e);
            --rainbow: linear-gradient(90deg, #ff3b30, #ff9500, #ffcc00, #4cd964, #5ac8fa, #007aff, #5856d6);
            --gs: #d4af37;
            --panel-clr: #34c759; --door-clr: #ff9500; --drawer-clr: #2196f3; --custom-clr: #af52de;
            --bg: #f2f2f7;
            --primary-dark: #212121;
            --accent-dark: #333333;
            --text-light: #666666;
            --btn-estimate: #2196f3;
            --btn-supply: #2196f3;
            --btn-mixing: #2196f3;
            --btn-invoice: #2196f3;
            --btn-quote: #2196f3;
            --btn-cover: #ff9800;
            --btn-label: #e91e63;
        }
        
        /* Scrollbar styling for Chrome/Safari */
        #clientsList::-webkit-scrollbar {
            width: 12px;
        }
        #clientsList::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 6px;
        }
        #clientsList::-webkit-scrollbar-thumb {
            background: #2196f3;
            border-radius: 6px;
        }
        #clientsList::-webkit-scrollbar-thumb:hover {
            background: #1976d2;
        }
        
        body { margin:0; font-family:-apple-system, system-ui, sans-serif; background:var(--bg); padding-bottom:140px; padding-top:0; -webkit-tap-highlight-color:transparent; }
        
        #globalNotificationsBanner { padding-top: env(safe-area-inset-top); }
        
        header { background:var(--rainbow); padding:env(safe-area-inset-top) 15px 5px; display:flex; align-items:center; justify-content:space-between; border-bottom:4px solid #aa841e; position:sticky; top:0; z-index:1000; height:80px; box-sizing: border-box; }
        .logo-box { background:linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); padding:6px 18px; border-radius:12px; border:2px solid #d4af37; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
        .logo-text { font-weight:900; font-size:56px; color:#d4af37; text-shadow:0 2px 4px rgba(0,0,0,0.5); letter-spacing:1px; }
        .icon-btn { font-size: 28px; padding: 0 10px; cursor: pointer; }

        .nav-tabs { display: flex; background: #000; position: fixed; top: 80px; left: 0; right: 0; z-index: 999; overflow-x: auto; border-bottom: 1px solid #333; }
        .nav-btn { flex:1; min-width:80px; padding:12px 0; color:#888; text-align:center; font-weight:900; font-size:10px; text-transform:uppercase; border:none; background:0 0; cursor:pointer; transition:all 0.2s; pointer-events:auto; z-index:100; position:relative; }
        .nav-btn.active { color:#fff; border-bottom:4px solid var(--gs); background:#111; }
        
        /* ===== MOBILE RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .container { padding: 10px; max-width: 100%; }
            .nav-tabs { position: fixed; top: 70px; border-bottom: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
            input, select { height:40px; font-size:14px; }
            label { font-size:9px; }
            .bubble-row { flex-direction: column; gap:8px; }
            .bubble-row > div { flex:1 !important; }
            .edge-row { gap: 5px; }
            .edge-box, .cam-btn { font-size:12px; padding:10px; flex:1; }
            .add-main-btn { padding:12px; font-size:13px; }
            .p-card { padding:8px; font-size:9px; min-width:70px; }
            #pDr, #pP, #pC, #pDo { min-width:60px; }
            button { padding:10px; font-size:12px; }
            .icon-btn { font-size:20px; }
            input[type="number"] { font-size:16px; }
        }
        
        @media (max-width: 480px) {
            header { height:70px; }
            .logo-text { font-size:16px; }
            .nav-tabs { position: fixed; top: 65px; border-bottom: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
            .nav-btn { min-width:60px; padding:10px 0; font-size:8px; }
            .container { padding:8px; }
            .bubble-unit input { font-size:14px; }
            .fm-row { gap:8px; }
            .fm-opt { padding:8px; font-size:10px; }
            #liveSq { font-size:36px; }
            .edge-row { gap:3px; }
            .edge-box { padding:8px; font-size:10px; min-width:30px; }
            .cam-btn { min-width:35px; padding:8px; }
            input, select { height:36px; font-size:13px; padding:0 8px; margin-bottom:6px; }
            .add-main-btn { width:100%; padding:10px; }
            .p-card { min-width:50px; padding:6px; }
            .card { padding:12px; margin-bottom:10px; }
        }
        
        /* Tablet optimizations */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container { padding: 12px; }
            .bubble-row { flex-direction: row; }
        }

        .sub-nav { display: flex; gap: 5px; margin-bottom: 15px; background: #e5e5ea; padding: 4px; border-radius: 10px; }
        .sub-btn { flex: 1; padding: 8px; border: none; border-radius: 7px; font-weight: 800; font-size: 11px; color: #666; background: transparent; cursor:pointer; transition:all 0.2s; }
        .sub-btn.active { background: #fff; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .container { padding: 15px; max-width: 600px; margin: auto; }
        .view-section { display:none !important; padding-top: 120px; padding-bottom: 80px; } .view-section.active { display:block !important; }
        #admin.view-section.active { display:flex !important; }
        .card { background:#fff; border-radius:12px; padding:15px; margin-bottom:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position:relative; overflow:visible; }

        label { font-size: 10px; font-weight: 900; color: #666; text-transform: uppercase; margin-bottom: 2px; display: block; }
        input, select { width:100%; height:45px; border-radius:8px; border:1px solid #ccc; padding:0 10px; font-size:16px; box-sizing:border-box; background:#fff; margin-bottom: 8px; font-weight: 600; }
        
        .db-list { max-height: 400px; overflow-y: auto; background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; }
        .db-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; font-weight: 600; }
        .db-del { color: red; font-weight: 900; padding: 5px; cursor:pointer; }
        .add-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-small { background: #000; color: var(--gs); border: none; border-radius: 8px; font-weight: 900; width: 60px; height:45px; cursor:pointer; transition:all 0.2s; }
        .btn-small:hover { background: #222; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-card { background: #f2f2f7; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer; transition:all 0.2s; }
        .form-card:active { transform: scale(0.98); background: #e5e5ea; }
        .form-card h4 { margin: 0 0 5px; font-size: 14px; color: #333; }
        .form-card p { margin: 0; font-size: 10px; color: #888; font-weight: 600; }

        .bubble-row { display: flex; gap: 6px; margin: 8px 0; }
        .fm-row { display:flex; background:#eee; border-radius:8px; padding:4px; margin-bottom:10px; height: 50px; align-items: center; box-sizing: border-box; }
        .fm-opt { flex:1; text-align:center; height: 42px; line-height: 42px; font-weight:900; font-size:12px; border-radius:6px; color:#aaa; cursor:pointer; transition:all 0.2s; }
        .fm-opt.active { background:#fff; color:#000; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        
        .bubble-unit { flex: 1; background: #fff; border: 1px solid #ccc; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 50px; box-sizing: border-box; }
        .bubble-unit input { border: none; background: transparent; text-align: center; font-size: 18px; font-weight: 900; height: 25px; margin:0; padding:0; width: 100%; }

        #prof-select { height: 50px !important; margin: 0; }

        .p-card { flex:1; background:#fff; border:2px solid #ddd; border-radius:8px; padding:8px 2px; text-align:center; font-weight:900; font-size:9px; color:#444; display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; transition:all 0.2s; }
        .p-card.active { border-color:var(--gs); background:#fff9e6; color:#000; }
        .p-card svg { width:22px; height:22px; stroke: currentColor; fill:none; stroke-width:2; }
        #pP.active { background:var(--panel-clr); color:#fff; border-color:var(--panel-clr); }
        #pD.active { background:var(--door-clr); color:#fff; border-color:var(--door-clr); }
        #pDr.active { background:var(--drawer-clr); color:#fff; border-color:var(--drawer-clr); }
        #pC.active { background:var(--custom-clr); color:#fff; border-color:var(--custom-clr); }

        .edge-row { display:flex; justify-content:space-between; align-items:center; margin:15px 0; gap:6px; }
        .edge-box { flex:1; height:45px; border-radius:8px; border:2px solid #ddd; background:#fff; display:flex; align-items:center; justify-content:center; font-weight:900; color:#ccc; font-size:14px; user-select:none; cursor:pointer; transition:all 0.2s; }
        .edge-box.active { background:#34c759; border-color:#28a745; color:#fff; }
        .edge-box.mode-sel.active { background:#333; border-color:var(--gs); color:var(--gs); }

        .cam-btn { font-size: 38px; cursor: pointer; padding: 0 10px; }
        .add-main-btn { width:100%; background:var(--gold); border:none; padding:20px; border-radius:40px; font-weight:900; font-size:20px; box-shadow:0 4px 15px rgba(212, 175, 55, 0.4); margin-top:10px; cursor:pointer; transition:all 0.2s; }
        .add-main-btn:active { transform: scale(0.98); }

        .part-label { display: flex; align-items: center; gap: 10px; padding: 10px; background: #fff; border-radius: 10px; margin-bottom: 8px; border: 1px solid #eee; position:relative; }
        .pl-qty { background: #000; color: var(--gs); min-width: 40px; height: 40px; border-radius: 8px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:16px; }
        .pl-center { flex:1; }
        .pl-dims { font-size: 18px; font-weight: 900;color: #000;line-height:1.1; }
        .edge-pill { display:inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 900; color: #fff; margin-right: 3px; }
        .pl-right { display: flex; flex-direction: column; align-items: center; min-width: 60px; border-left: 1px solid #eee; }
        .pl-mode { width: 35px; height: 35px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 12px; border: 2px solid; margin-bottom: 4px; }
        .del-btn { color: #ff3b30; font-size: 24px; border: none; background: none; cursor:pointer; transition:all 0.2s; }
        .del-btn:active { transform: scale(1.2); }

        .qty-controls { display:flex; flex-direction:column; align-items:center; gap:2px; min-width:45px; }
        .qty-btn { border:none; background:#eee; width:100%; border-radius:4px; font-weight:900; font-size:16px; cursor:pointer; transition:all 0.2s; padding:0; height:28px; }
        .qty-btn:active { background:#ddd; }

        .sticky-footer { background: #000; position: fixed; bottom: 0; left: 0; right: 0; height: 80px; border-top: 3px solid var(--gs); color: #fff; display: flex; justify-content: space-around; align-items: center; z-index: 2000; }
        .footer-item { text-align:center; }
        .footer-val { font-size:20px; font-weight:900; color:var(--gs); }
        .footer-label { font-size:9px; color:#aaa; }
        
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; padding: 12px 25px; border-radius: 30px; font-weight: 900; z-index: 3000; display: none; border: 1px solid var(--gs); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity:0; transform: translateX(-50%) translateY(20px); } to { opacity:1; transform: translateX(-50%) translateY(0); } }

        .pl-meta { font-size:10px; font-weight:700; color:#666; margin-top:2px; }

        /* COMPLETE JOB STAMP */
        .job-complete-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 24px;
            font-weight: 900;
            color: #34c759;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(52, 199, 89, 0.2);
            z-index: 50;
            border: 1.5px solid #34c759;
            padding: 2px 12px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.85);
            white-space: nowrap;
            line-height: 1;
        }
        
        /* ===== STICKY ADMIN LAYOUT ===== */
        #admin {
            flex-direction: column;
            height: calc(100vh - 200px);
            gap: 0;
        }
        
        .admin-header-section {
            position: sticky;
            top: 0;
            background: #fff;
            border-bottom: 2px solid #ddd;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        
        .admin-content-section {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 200px;
        }
        
        .admin-footer-section {
            position: sticky;
            bottom: 0;
            background: #f5f5f5;
            border-top: 2px solid #ddd;
            padding: 15px;
            z-index: 1000;
            max-height: 180px;
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .admin-tab-content {
            display: none !important;
        }
        
        .admin-tab-content.active {
            display: block !important;
            width: 100% !important;
            min-height: auto !important;
        }
    </style>
</head>
<body>
<!-- COPYRIGHT NOTICE -->
<div id="copyrightBanner" style="display:none;">
    ‚öñÔ∏è PaintWorkz Pro ¬© 2026 Colin Bedford | Unauthorized use prohibited
</div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" style="display:none !important; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:99999; justify-content:center; align-items:center; padding:0; margin:0;">
        <div style="background:#fff; border-radius:8px; width:95vw; height:95vh; max-width:1400px; display:flex; flex-direction:column; box-shadow:0 20px 60px rgba(0,0,0,0.6); margin:0; padding:0;">
            <!-- Header -->
            <div style="display:flex; justify-content:space-between; align-items:center; padding:20px 25px; border-bottom:2px solid #ddd; background:#f9f9f9; flex-shrink:0;">
                <h3 id="pdfPreviewTitle" style="margin:0; color:#333; font-size:18px;">üìÑ PDF Preview</h3>
                <button onclick="closePDFPreview()" style="border:none; background:none; font-size:28px; cursor:pointer; color:#666;">‚úï</button>
            </div>
            
            <!-- Loading Indicator -->
            <div id="pdfLoadingSpinner" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; z-index:100000; background:#fff; padding:40px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
                <div style="width:60px; height:60px; border:4px solid #f3f3f3; border-top:4px solid #d4af37; border-radius:50%; animation:spin 1s linear infinite;"></div>
                <p style="margin-top:15px; margin-bottom:0; color:#666; font-weight:bold;">Generating PDF...</p>
            </div>
            
            <!-- Preview Container -->
            <div id="pdfPreviewContainer" style="flex:1; overflow:auto; padding:15px; background:#e8e8e8; display:flex; justify-content:center; align-items:center; margin:0;">
                <iframe id="pdfPreviewIframe" style="width:100%; height:100%; border:none; background:#fff; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.1);"></iframe>
            </div>
            
            <!-- Footer Buttons -->
            <div style="display:flex; gap:12px; padding:20px 25px; border-top:2px solid #ddd; background:#f9f9f9; flex-shrink:0;">
                <button onclick="closePDFPreview()" style="flex:1; border:none; background:#e0e0e0; color:#333; padding:14px; border-radius:6px; font-weight:bold; cursor:pointer; font-size:14px;">‚Üê CANCEL</button>
                <button id="downloadPDFBtn" onclick="downloadCurrentPDF()" style="flex:1; border:none; background:#d4af37; color:#000; padding:14px; border-radius:6px; font-weight:bold; cursor:pointer; font-size:14px;">‚Üì DOWNLOAD PDF</button>
            </div>
        </div>
    </div>
    
    <!-- CHARGES MODAL - Appears before PDF generation -->
    <div id="chargesModal" style="display:none; position:fixed; top:50px; left:50%; transform:translateX(-50%); width:92%; max-width:420px; max-height:calc(100vh - 120px); background:rgba(0,0,0,0.7); z-index:99998; justify-content:center; align-items:center; padding:0; overflow:hidden; border-radius:12px;">
        <div style="background:#fff; border-radius:12px; width:100%; padding:14px; box-shadow:0 10px 40px rgba(0,0,0,0.3); overflow-y:auto; max-height:calc(100vh - 120px); display:flex; flex-direction:column;">
            <h2 style="margin:0 0 12px 0; color:#333; font-size:13px; font-weight:bold;">Additional Charges</h2>
            
            <!-- Paint Colour Surcharges - Dynamic per colour -->
            <div id="colourSurchargesContainer" style="margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #ddd; max-height:280px; overflow-y:auto; flex-shrink:0;">
                <p style="color:#999; font-size:10px; margin:0;">Loading colours...</p>
            </div>
            
            <!-- Delivery/Pickup Section -->
            <div style="margin-bottom:6px; padding-bottom:6px; border-bottom:1px solid #ddd; flex-shrink:0;">
                <label style="display:block; font-weight:bold; color:#333; margin-bottom:3px; font-size:9px;">Delivery Region:</label>
                <select id="deliveryRegionSelect" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:8px; background:#fff; cursor:pointer;">
                    <option value="0">None</option>
                    <option value="90">Warrnambool ($90)</option>
                    <option value="110">Geelong ($110)</option>
                    <option value="110">Mt Gambier ($110)</option>
                    <option value="250">Adelaide ($250)</option>
                    <option value="110">Horsham ($110)</option>
                    <option value="160">Ballarat ($160)</option>
                </select>
            </div>
            
            <!-- Courier Section -->
            <div style="margin-bottom:6px; padding-bottom:6px; border-bottom:1px solid #ddd; flex-shrink:0;">
                <label style="display:block; font-weight:bold; color:#333; margin-bottom:3px; font-size:9px;">Freight Charge:</label>
                <input type="number" id="freightChargeInput" value="0" min="0" step="5" placeholder="0.00" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:8px; box-sizing:border-box;">
            </div>
            
            <!-- Other Charges Section -->
            <div style="margin-bottom:6px; padding-bottom:6px; border-bottom:1px solid #ddd; flex-shrink:0;">
                <label style="display:block; font-weight:bold; color:#333; margin-bottom:3px; font-size:9px;">Other Charges:</label>
                <input type="text" id="otherChargeDesc" placeholder="e.g. Rush" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:8px; margin-bottom:2px; box-sizing:border-box;">
                <input type="number" id="otherChargeAmount" value="0" min="0" step="5" placeholder="Amount ($)" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:8px; box-sizing:border-box;">
            </div>
            
            <!-- Summary -->
            <div style="background:#f5f5f5; padding:8px; border-radius:4px; margin-bottom:10px; font-size:8px; flex-shrink:0;">
                <div style="margin-bottom:1px;"><strong>Colour:</strong> $<span id="summaryColourCharge">0.00</span></div>
                <div style="margin-bottom:1px;"><strong>Delivery:</strong> $<span id="summaryDeliveryCharge">0.00</span></div>
                <div style="margin-bottom:1px;"><strong>Freight:</strong> $<span id="summaryFreightCharge">0.00</span></div>
                <div style="margin-bottom:1px;"><strong>Other:</strong> $<span id="summaryOtherCharge">0.00</span></div>
                <div style="border-top:1px solid #ddd; padding-top:1px; margin-top:1px; margin-bottom:1px;"><strong>Subtotal:</strong> $<span id="summarySubtotalPlusCharges">0.00</span></div>
                <div style="border-top:1px solid #ddd; padding-top:1px; margin-top:1px;"><strong>GST:</strong> $<span id="summaryGST">0.00</span></div>
                <div style="border-top:2px solid #999; padding-top:2px; margin-top:2px; font-size:9px; font-weight:bold;"><strong>TOTAL:</strong> $<span id="summaryTotalCharge">0.00</span></div>
            </div>
            
            <!-- Buttons -->
            <div style="display:flex; gap:6px; flex-shrink:0;">
                <button onclick="closeChargesModal()" style="flex:1; border:none; background:#e0e0e0; color:#333; padding:6px; border-radius:4px; font-weight:bold; cursor:pointer; font-size:9px;">CANCEL</button>
                <button id="applyChargesBtn" onclick="applyChargesAndGenerate()" style="flex:1; border:none; background:#4caf50; color:#fff; padding:6px; border-radius:4px; font-weight:bold; cursor:pointer; font-size:9px;">APPLY & GEN</button>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Firebase SDK - Modern Modular Approach -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCddhnoWoJczM2yXemz2evZc-W2x7OnP00",
            authDomain: "paintworkz-42bc0.firebaseapp.com",
            projectId: "paintworkz-42bc0",
            storageBucket: "paintworkz-42bc0.firebasestorage.app",
            messagingSenderId: "298786193879",
            appId: "1:298786193879:web:8fd63ca63c109f8cd14b92"
        };
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('‚úì Firebase initialized successfully');
        } catch(fbError) {
            console.log('‚ÑπÔ∏è Firebase note (non-critical):', fbError.message);
            // Firebase will still work with explicit config - this error is from hosting environment check
        }
        
        // Export to window for global access - with proper function wrappers
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        
        // Export Firestore functions as window methods
        window.doc = doc;
        window.setDoc = setDoc;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDoc = getDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.getDocs = getDocs;
        
        // Auth functions
        window.createUserWithEmailAndPassword = (email, password) => createUserWithEmailAndPassword(auth, email, password);
        window.signInWithEmailAndPassword = (email, password) => signInWithEmailAndPassword(auth, email, password);
        window.signOut = () => signOut(auth);
        
        window.currentUser = null;
        window.realtimeSyncActive = false; // Guard against multiple listeners
        window.realtimeSyncUnsubscribe = null; // Store unsubscribe function
        
        // Set up auth listener
        onAuthStateChanged(auth, user => {
            window.currentUser = user;
            if (user) {
                const loginScreen = document.getElementById('loginScreen');
                const appContainer = document.getElementById('appContainer');
                if (loginScreen) loginScreen.style.display = 'none';
                if (appContainer) appContainer.style.display = 'block';
                
                // Initialize app (clear form, populate clients)
                setTimeout(() => {
                    if (typeof initializeApp === 'function') {
                        try {
                            initializeApp();
                        } catch(e) {
                            console.error('initializeApp error:', e);
                        }
                    }
                }, 100);
                
                // Load jobs from Firebase ONLY after document is fully loaded
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        setTimeout(() => {
                            if (window.loadAllDataFromFirebase) {
                                try {
                                    window.loadAllDataFromFirebase();
                                } catch (e) {
                                    console.error('loadAllDataFromFirebase error:', e);
                                }
                            }
                        }, 500);
                    });
                } else {
                    // DOM already loaded
                    setTimeout(() => {
                        if (window.loadAllDataFromFirebase) {
                            try {
                                window.loadAllDataFromFirebase();
                            } catch (e) {
                                console.error('loadAllDataFromFirebase error:', e);
                            }
                        }
                    }, 500);
                }
                
                // Only set up real-time sync ONCE per session (DISABLED by default due to memory issues)
                if (!window.realtimeSyncActive) {
                    // Real-time sync disabled to prevent memory leaks
                    // Users should manually refresh to get latest data from Firebase
                    console.log('‚ÑπÔ∏è Real-time sync disabled (manual refresh recommended)');
                    window.realtimeSyncActive = true;
                }
            } else {
                // Clean up listener when logging out
                if (window.realtimeSyncUnsubscribe) {
                    try {
                        window.realtimeSyncUnsubscribe();
                    } catch (e) {
                        console.warn('Error unsubscribing:', e);
                    }
                    window.realtimeSyncUnsubscribe = null;
                }
                window.realtimeSyncActive = false;
                
                const loginScreen = document.getElementById('loginScreen');
                const appContainer = document.getElementById('appContainer');
                if (loginScreen) loginScreen.style.display = 'block';
                if (appContainer) appContainer.style.display = 'none';
            }
        });
        
        // Set firebaseReady LAST - only after everything is initialized
        window.firebaseReady = true;
    </script>
    <!-- USER INFO -->
    <div id="userInfo"></div>

<!-- TOAST NOTIFICATION -->
<div id="toast" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#34c759; color:#fff; padding:12px 25px; border-radius:25px; font-weight:900; z-index:5000; font-size:11px; box-shadow:0 4px 12px rgba(52, 199, 89, 0.3); animation: slideUp 0.4s ease-out, slideDown 0.4s ease-in 2.6s forwards; white-space:nowrap;"></div>

<style>
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(100px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes slideDown {
    from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    to {
        opacity: 0;
        transform: translateX(-50%) translateY(100px);
    }
}
</style>

<!-- A3 SCHEDULE DATE RANGE MODAL -->
<div id="a3ScheduleModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:25px; border-radius:12px; width:90%; max-width:450px; box-shadow:0 10px 40px rgba(0,0,0,0.3); z-index:1001;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0; font-weight:bold; font-size:16px;">üìÖ A3 Work Schedule</h3>
            <button onclick="closeA3ScheduleModal()" style="border:none; background:none; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px;">‚úï</button>
        </div>
        
        <div style="margin-bottom:20px;">
            <p style="margin:0 0 15px 0; font-size:12px; color:#666;">Select time period for your work schedule:</p>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <button onclick="generateA3Schedule(7)" style="padding:12px; background:#2196f3; color:#fff; border:none; border-radius:6px; font-weight:bold; font-size:12px; cursor:pointer;">üìÖ 1 WEEK</button>
                <button onclick="generateA3Schedule(30)" style="padding:12px; background:#ff9500; color:#fff; border:none; border-radius:6px; font-weight:bold; font-size:12px; cursor:pointer;">üìÖ 1 MONTH</button>
                <button onclick="generateA3Schedule(90)" style="padding:12px; background:#4caf50; color:#fff; border:none; border-radius:6px; font-weight:bold; font-size:12px; cursor:pointer;">üìÖ 3 MONTHS</button>
                <button onclick="generateA3Schedule(365)" style="padding:12px; background:#9c27b0; color:#fff; border:none; border-radius:6px; font-weight:bold; font-size:12px; cursor:pointer;">üìÖ 1 YEAR</button>
            </div>
            
            <div style="border-top:1px solid #ddd; padding-top:15px;">
                <p style="margin:0 0 10px 0; font-size:12px; font-weight:bold; color:#333;">Or select custom dates:</p>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1;">
                        <label style="display:block; font-size:11px; color:#666; margin-bottom:4px;">From</label>
                        <input type="date" id="a3StartDate" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px;">
                    </div>
                    <div style="flex:1;">
                        <label style="display:block; font-size:11px; color:#666; margin-bottom:4px;">To</label>
                        <input type="date" id="a3EndDate" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px;">
                    </div>
                </div>
                <button onclick="generateA3ScheduleCustom()" style="width:100%; padding:10px; background:#673ab7; color:#fff; border:none; border-radius:6px; font-weight:bold; font-size:12px; cursor:pointer;">üìÖ GENERATE</button>
            </div>
        </div>
    </div>
</div>

<!-- TIMELINE EDITOR MODAL -->
<div id="timelineModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; flex-wrap:wrap;">
    <div style="background:#fff; padding:25px; border-radius:12px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); z-index:1001;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Edit Timeline</h3>
            <button onclick="closeTimelineModal()" style="border:none; background:none; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px;">‚úï</button>
        </div>
        
        <div id="timelineEditorContent"></div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="saveTimelineEdit()" style="flex:1; border:none; background:#34c759; color:#fff; padding:10px; border-radius:6px; font-weight:900; cursor:pointer;">SAVE</button>
            <button onclick="closeTimelineModal()" style="flex:1; border:none; background:#f0f0f0; color:#000; padding:10px; border-radius:6px; font-weight:900; cursor:pointer;">CANCEL</button>
        </div>
    </div>
</div>

<!-- PAINT FORMULA DATABASE MODAL -->
<!-- CALENDAR MODAL -->
<div id="calendarModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:5000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:16px; padding:20px; width:90%; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <button onclick="prevMonth()" style="border:none; background:#f0f0f0; width:40px; height:40px; border-radius:8px; font-weight:900; font-size:18px; cursor:pointer;" title="Previous month">‚Üê</button>
            <div style="text-align:center; flex:1;">
                <div id="monthYear" style="font-weight:900; font-size:16px; color:#000;"></div>
            </div>
            <button onclick="nextMonth()" style="border:none; background:#f0f0f0; width:40px; height:40px; border-radius:8px; font-weight:900; font-size:18px; cursor:pointer;" title="Next month">‚Üí</button>
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-bottom:15px;">
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">SU</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">MO</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">TU</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">WE</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">TH</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">FR</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">SA</div>
            <div id="calendarDays" style="grid-column:1/-1; display:grid; grid-template-columns:repeat(7,1fr); gap:4px;"></div>
        </div>
        
        <div style="display:flex; gap:8px;">
            <button onclick="closeCalendar()" style="flex:1; border:none; background:#f0f0f0; padding:12px; border-radius:8px; font-weight:900; cursor:pointer;">CANCEL</button>
            <button onclick="selectToday()" style="flex:1; border:none; background:var(--gs); padding:12px; border-radius:8px; font-weight:900; cursor:pointer;">TODAY</button>
        </div>
    </div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="position:fixed; top:0; left:0; right:0; bottom:0; background:linear-gradient(135deg, #d4af37, #f9f1b0); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
    <div style="background:#fff; border-radius:20px; padding:30px; width:100%; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="text-align:center; margin-bottom:30px;">
            <h1 style="margin:0; color:#d4af37; font-size:32px;">üé® PaintWorkz</h1>
            <p style="color:#666; margin:10px 0 0; font-size:14px;">Live Sync ‚Ä¢ All Devices</p>
        </div>
        
        <input type="email" id="loginEmail" placeholder="Email" style="margin-bottom:12px; padding:15px;">
        <input type="password" id="loginPassword" placeholder="Password" style="margin-bottom:20px; padding:15px;">
        
        <button onclick="handleLogin()" style="width:100%; background:#d4af37; border:none; padding:15px; border-radius:10px; font-weight:900; font-size:16px; cursor:pointer; margin-bottom:10px;">SIGN IN</button>
        <button onclick="trySignup()" style="width:100%; background:#333; color:#d4af37; border:2px solid #d4af37; padding:15px; border-radius:10px; font-weight:900; font-size:16px; cursor:pointer; font-size:14px;">CREATE ACCOUNT</button>
        
        <div id="loginError" style="color:red; font-weight:900; margin-top:15px; text-align:center; display:none;"></div>
    </div>
</div>

<!-- APP CONTAINER -->
<div id="appContainer" style="display:none;">

<header>
    <div class="icon-btn" onclick="tab('history')">üîç</div>
    <div class="logo-box" id="headerLogoBox" style="position:relative; width:calc(25vw); height:60px; display:flex; align-items:center; justify-content:center; padding:6px; box-sizing:border-box; margin-left:10px; border:2px solid #d4af37; border-radius:12px; background:linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); box-shadow:0 4px 12px rgba(0,0,0,0.3); transition:all 0.3s ease;">
        <img id="headerLogoImg" src="" style="height:100%; max-width:95%; display:none; object-fit:contain;" alt="Company Logo">
        <span class="logo-text" id="headerLogoText" style="font-size:20px; font-weight:900; color:#d4af37; text-shadow:0 2px 4px rgba(0,0,0,0.5); letter-spacing:1px;">PaintWorkz</span>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
        <div id="goBackBtn" class="icon-btn" onclick="goBackJob()" style="display:none;" title="Exit without saving if no changes made">‚Üê Back</div>
        <div class="icon-btn" onclick="saveJob()">üíæ</div>
    </div>
</header>

<div class="nav-tabs">
    <div class="nav-btn active" id="btn-measure" data-tab="measure">Measure</div>
    <div class="nav-btn" id="btn-history" data-tab="history">History</div>
    <div class="nav-btn" id="btn-db" data-tab="db">Database</div>
    <div class="nav-btn" id="btn-forms" data-tab="forms">Forms</div>
    <div class="nav-btn" id="btn-schedule" data-tab="schedule">Schedule</div>
    <div class="nav-btn" id="btn-admin" data-tab="admin">Admin</div>
</div>

<div class="container">
    
    <div id="measure" class="view-section active">
        <div class="card">
            <div style="display:flex; gap:8px; margin-bottom: 8px;">
                <div style="flex:2">
                    <label>Client</label>
                    <select id="cli"></select>
                </div>
                <div style="flex:1">
                    <label>Date Received</label>
                    <input type="text" id="dRec" placeholder="DD/MM/YY" inputmode="numeric" style="text-align:center;" onclick="openCalendar()">
                </div>
            </div>

            <div style="display:flex; gap:8px; margin-bottom: 8px;">
                <div style="flex:2">
                    <label>Job Name / Reference</label>
                    <input type="text" id="jNm" placeholder="e.g. Smith Residence">
                </div>
                <div style="flex:1">
                    <label>Job #</label>
                    <input type="text" id="jN" placeholder="####" style="text-align:center;">
                </div>
            </div>

            <div style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee; margin-bottom:10px;">
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <div style="flex:1">
                        <label>Brand</label>
                        <select id="p-brand" style="height:35px; font-size:12px;">
                            <option>Wattyl</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>Color Name</label>
                        <input type="text" id="p-color" placeholder="e.g. Lexicon" style="height:35px; font-size:12px;" oninput="openPaintFormulaSearch()">
                    </div>
                </div>
                <div style="display:flex; gap:8px;">
                    <div style="flex:1">
                        <label>Code / Formula</label>
                        <input type="text" id="p-code" placeholder="Formula (auto-search when typing)" style="height:35px; font-size:12px;" oninput="autoSearchFormulaOnType()">
                    </div>
                    <div style="flex:1">
                        <label>Finish</label>
                        <select id="p-finish" style="height:35px; font-size:12px;">
                            <option>Satin</option><option>Gloss</option><option>Matt</option><option>20% Gloss</option><option>30% Gloss</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <label>Part Type</label>
            <div class="bubble-row">
                <div id="pP" class="p-card active" onclick="setP('Panel')"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"></rect></svg>PANEL</div>
                <div id="pD" class="p-card" onclick="setP('Door')"><svg viewBox="0 0 24 24"><path d="M5 3h14v18H5V3zm10 9v1"></path></svg>DOOR</div>
                <div id="pDr" class="p-card" onclick="setP('Drawer')"><svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="6" rx="1"></rect><rect x="3" y="13" width="18" height="6" rx="1"></rect></svg>DRAWER</div>
                <div id="pC" class="p-card" onclick="setP('Custom')"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>CUSTOM</div>
            </div>

            <label>Description of Part</label>
            <input type="text" id="desc" placeholder="e.g. Pantry Door Left" style="text-transform: uppercase;">

            <div class="fm-row">
                <div id="fm-flat" class="fm-opt active" onclick="setFM('Flat')">FLAT</div>
                <div id="fm-mould" class="fm-opt" onclick="setFM('Moulded')">MOULDED</div>
            </div>

            <div class="bubble-row">
                <div class="bubble-unit" style="flex:0.8"><input type="number" id="thk" value="18" inputmode="decimal" oninput="up()"><div style="font-size:9px;color:#888;">THICK</div></div>
                <div style="flex:2"><select id="prof-select" oninput="up()"></select></div>
                <div class="bubble-unit" style="flex:0.8"><input type="number" id="qty" value="1" inputmode="numeric"><div style="font-size:9px;color:#888;">QTY</div></div>
            </div>

            <div class="bubble-row">
                <input type="number" id="h" placeholder="Length" inputmode="decimal" oninput="up()" style="height:55px; font-size:22px; text-align:center;">
                <input type="number" id="w" placeholder="Width" inputmode="decimal" oninput="up()" style="height:55px; font-size:22px; text-align:center;">
            </div>

            <label>Paint Mode</label>
            <div class="edge-row" style="margin-top:5px;">
                <div id="mSS" class="edge-box mode-sel active" onclick="setM('SS')">SS</div>
                <div id="mDS" class="edge-box mode-sel" onclick="setM('DS')">DS</div>
                <div id="mSE" class="edge-box mode-sel" onclick="setM('SE')">SE</div>
            </div>

            <label>Edge Treatment</label>
            <div class="edge-row">
                <div class="edge-box" id="E1" onclick="tE(this)">L</div>
                <div class="edge-box" id="E2" onclick="tE(this)">L</div>
                <div class="cam-btn" onclick="snap()">üì∏</div>
                <div class="edge-box" id="E3" onclick="tE(this)">S</div>
                <div class="edge-box" id="E4" onclick="tE(this)">S</div>
            </div>

            <div style="display: flex; flex-direction: column; align-items: center; padding: 15px 0; border-top: 1px solid #eee;">
                <div id="liveSq" style="font-size: 50px; font-weight: 900; color: var(--gs); line-height: 1;">0.000</div>
                <div style="font-size: 10px; font-weight: 900; color: #aaa;">CURRENT PART SQM (m¬≤)</div>
            </div>

            <button class="add-main-btn" onclick="addPart()">ADD PART +</button>
            
            <!-- JOB PHOTOS GALLERY -->
            <div id="jobPhotosContainer" style="margin-top:20px; padding:15px; background:#f5f5f5; border-radius:8px; border:1px solid #e0e0e0;">
                <p style="text-align:center; color:#999; font-size:11px; padding:10px;">No photos yet</p>
            </div>
        </div>
        
        <!-- FILTER BAR FOR PANEL LIST -->
        <div id="panelFilterBar" style="padding:12px 10px; background:#f9f9f9; border-bottom:1px solid #ddd; display:flex; gap:6px; flex-wrap:wrap; font-size:10px;">
            <button class="filter-btn active" onclick="filterPanels('all')" data-bg="#d4af37" data-color="#000" style="padding:6px 14px; border:none; background:#d4af37; color:#000; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 2px 4px rgba(0,0,0,0.1); transition:all 0.2s;">ALL</button>
            <button class="filter-btn" onclick="filterPanels('panel')" data-bg="#e8f4f8" data-color="#0288d1" style="padding:6px 14px; border:none; background:#e8f4f8; color:#0288d1; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">PANEL</button>
            <button class="filter-btn" onclick="filterPanels('door')" data-bg="#f3e5f5" data-color="#7b1fa2" style="padding:6px 14px; border:none; background:#f3e5f5; color:#7b1fa2; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">DOOR</button>
            <button class="filter-btn" onclick="filterPanels('drawer')" data-bg="#e3f2fd" data-color="#1565c0" style="padding:6px 14px; border:none; background:#e3f2fd; color:#1565c0; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">DRAWER</button>
            <button class="filter-btn" onclick="filterPanels('custom')" data-bg="#fce4ec" data-color="#c2185b" style="padding:6px 14px; border:none; background:#fce4ec; color:#c2185b; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">CUSTOM</button>
            <button class="filter-btn" onclick="filterPanels('moulded')" data-bg="#fff3e0" data-color="#e65100" style="padding:6px 14px; border:none; background:#fff3e0; color:#e65100; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">MOULDED</button>
            <button class="filter-btn" onclick="filterPanels('flat')" data-bg="#f1f8e9" data-color="#558b2f" style="padding:6px 14px; border:none; background:#f1f8e9; color:#558b2f; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">FLAT</button>
            <button class="filter-btn" onclick="filterPanels('ss')" data-bg="#e0f2f1" data-color="#00695c" style="padding:6px 14px; border:none; background:#e0f2f1; color:#00695c; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">S/S</button>
            <button class="filter-btn" onclick="filterPanels('ds')" data-bg="#ede7f6" data-color="#4527a0" style="padding:6px 14px; border:none; background:#ede7f6; color:#4527a0; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">D/S</button>
            <button class="filter-btn" onclick="filterPanels('se')" style="padding:6px 12px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-weight:900;">S/E</button>
            
            <!-- Paint Colour Filter -->
            <div style="display:flex; gap:8px; align-items:center; margin-top:12px;">
                <label style="font-weight:bold; color:#666; font-size:13px;">Paint Colour:</label>
                <select id="colourFilter" onchange="filterByColour(this.value)" style="padding:6px 12px; border:1px solid #ddd; border-radius:4px; background:#fff; cursor:pointer; font-weight:bold; color:#333; font-size:12px; min-width:180px;">
                    <option value="">-- ALL --</option>
                </select>
            </div>
        </div>
        
        <div id="list"></div>
    </div>

    <!-- Paint Formula Popup Modal -->
    <div id="paintFormulaModal" style="display:none !important; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;" onclick="if(event.target.id==='paintFormulaModal') closePaintFormulaModal();">
        <div style="position:relative; background:#fff; border-radius:12px; padding:20px; max-width:500px; width:90vw; max-height:80vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3); z-index:10000;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:2px solid #eee;">
                <h3 style="margin:0; font-size:13px; font-weight:900;" id="formulaTitle">Paint Formula</h3>
                <button onclick="closePaintFormulaModal()" style="background:none; border:none; font-size:20px; cursor:pointer; padding:0; width:24px; height:24px; line-height:1;">√ó</button>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
                <div>
                    <div style="font-size:9px; font-weight:900; color:#666; margin-bottom:3px;">COLOUR</div>
                    <div id="formulaColor" style="font-size:12px; font-weight:900;">-</div>
                </div>
                <div>
                    <div style="font-size:9px; font-weight:900; color:#666; margin-bottom:3px;">CODE</div>
                    <div id="formulaCode" style="font-size:12px; font-weight:900;">-</div>
                </div>
            </div>
            
            <div style="background:#f0f0f0; padding:8px; border-radius:4px; margin-bottom:10px;">
                <label style="font-size:9px; font-weight:900; display:block; margin-bottom:4px;">Litres to Mix</label>
                <input type="number" id="mixLitres" value="1" min="0.1" step="0.1" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:3px; font-size:12px; box-sizing:border-box; font-weight:900;" oninput="updateFormulaScaling()">
            </div>
            
            <div id="scaledFormula" style="background:#fafafa; padding:10px; border-radius:4px; margin-bottom:12px; font-size:10px; max-height:220px; overflow-y:auto; line-height:1.8;">
                <!-- Scaled formula will appear here -->
            </div>
            
            <div style="display:flex; gap:8px;">
                <button onclick="savePaintFormulaToJob()" style="flex:1; background:#34c759; color:#fff; border:none; padding:10px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer;">‚úì Save</button>
                <button onclick="closePaintFormulaModal()" style="flex:1; background:#e0e0e0; color:#333; border:none; padding:10px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="db" class="view-section">
        <div class="sub-nav" style="position:fixed; top:120px; left:0; right:0; background:#fff; z-index:99; border-bottom:2px solid var(--gs); padding:10px 15px; display:flex; gap:10px; border-radius:0; margin-bottom:0;">
            <button class="sub-btn active" id="sub-btn-clients" onclick="subTab('clients')">CLIENTS</button>
            <button class="sub-btn" id="sub-btn-profiles" onclick="subTab('profiles')">DOOR PROFILES</button>
            <button class="sub-btn" id="sub-btn-paint" onclick="subTab('paint')">PAINT</button>
        </div>

        <div id="sub-clients" class="sub-section active" style="margin-top:50px;">
            <div class="card">
                <div class="add-row">
                    <input type="text" id="new-client" placeholder="New Client Name" style="margin-bottom:0;">
                    <button class="btn-small" onclick="addClient()">ADD</button>
                </div>
                <div class="db-list" id="list-clients"></div>
            </div>
        </div>

        <div id="sub-profiles" class="sub-section" style="display:none;">
            <div class="card">
                <h4 style="margin-bottom:15px; font-weight:900;">Door Profiles</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Add new profiles or edit existing names. Profiles are used in your pricing matrix tiers.</p>
                
                
                <div class="add-row">
                    <input type="text" id="new-profile" placeholder="New Profile Name (e.g., Shaker, Ashlee)" style="margin-bottom:0;">
                    <button class="btn-small" onclick="addProfile()">ADD</button>
                </div>
                <div class="db-list" id="list-profiles" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="sub-paint" class="sub-section" style="display:none;">
            <div class="card">
                <h4 style="margin-bottom:15px; font-weight:900;">Paint Formula Database</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Manage your paint formulas. When you type a colour in the Measure tab, matching formulas will appear automatically.</p>
                
                <div style="margin-bottom:20px;">
                    <h5 style="margin-bottom:10px; font-weight:900; font-size:12px;">Add New Formula</h5>
                    <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #ddd;">
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <select id="newPaintBrand" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:12px; font-weight:900;">
                                <option value="">Select Brand</option>
                                <option value="Dulux">Dulux</option>
                                <option value="Wattyl">Wattyl</option>
                                <option value="Taubmans">Taubmans</option>
                                <option value="Haymes">Haymes</option>
                                <option value="British Paints">British Paints</option>
                                <option value="Evic">Evic</option>
                                <option value="Custom">Custom</option>
                            </select>
                            <input type="text" id="newPaintColor" placeholder="Colour Name (e.g., Lexicon)" style="flex:1.5; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:12px;">
                            <input type="text" id="newPaintCode" placeholder="Code (e.g., XTSW1E3)" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:12px;">
                        </div>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <select id="newPaintFinish" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:12px; font-weight:900;">
                                <option value="Satin">Satin</option>
                                <option value="Matt">Matt</option>
                                <option value="Semi Gloss">Semi Gloss</option>
                                <option value="Gloss">Gloss</option>
                            </select>
                            <input type="text" id="newPaintProduct" placeholder="Product (e.g., 690 30% XTint Poly)" style="flex:2; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:12px;">
                        </div>
                        <input type="text" id="newPaintVersion" placeholder="Version (e.g., DULUX WOC Series II (2018))" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px; box-sizing:border-box; font-size:12px;">
                        
                        <!-- Base Color & Multiple Base Codes -->
                        <div style="background:#fff; padding:10px; border-radius:6px; border:1px solid #eee; margin-bottom:10px;">
                            <div style="font-size:10px; font-weight:900; margin-bottom:8px; color:#666;">BASE COLOR (e.g., White, Clear, Green)</div>
                            <input type="text" id="baseColor" placeholder="Base Color" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; margin-bottom:10px; box-sizing:border-box;">
                            
                            <div style="font-size:10px; font-weight:900; margin-bottom:8px; color:#666;">BASE CODES (up to 3 codes @ grams)</div>
                            
                            <!-- Base Code 1 -->
                            <div style="display:flex; gap:8px; margin-bottom:6px;">
                                <input type="text" id="baseCode1" placeholder="Code 1" style="flex:0.6; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                                <input type="number" id="baseAmount1" placeholder="grams" step="0.01" style="flex:0.4; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                            </div>
                            
                            <!-- Base Code 2 -->
                            <div style="display:flex; gap:8px; margin-bottom:6px;">
                                <input type="text" id="baseCode2" placeholder="Code 2 (optional)" style="flex:0.6; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                                <input type="number" id="baseAmount2" placeholder="grams" step="0.01" style="flex:0.4; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                            </div>
                            
                            <!-- Base Code 3 -->
                            <div style="display:flex; gap:8px;">
                                <input type="text" id="baseCode3" placeholder="Code 3 (optional)" style="flex:0.6; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                                <input type="number" id="baseAmount3" placeholder="grams" step="0.01" style="flex:0.4; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                            </div>
                        </div>
                        
                        <!-- Tinters Section -->
                        <div style="background:#fff; padding:10px; border-radius:6px; border:1px solid #eee; margin-bottom:10px;">
                            <div style="font-size:10px; font-weight:900; margin-bottom:8px; color:#666;">TINTERS (code space grams per line)</div>
                            <textarea id="tintersList" placeholder="ITE303 5.88&#10;ITE306 5.95&#10;ITE310 5.75" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; min-height:60px; box-sizing:border-box; font-family:monospace;"></textarea>
                            <div style="font-size:9px; color:#999; margin-top:5px;">One tinter per line. Format: CODE GRAMS (just a space between them)</div>
                        </div>
                        
                        <button onclick="addNewPaintFormulaUI()" style="width:100%; padding:10px; background:#34c759; color:#fff; border:none; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">+ ADD FORMULA</button>
                    </div>
                </div>
                
                <div>
                    <div style="margin-bottom:10px; font-weight:900; font-size:12px;">
                        Existing Formulas (<span id="formulaCount">0</span>)
                        <input type="text" id="formulaSearch" placeholder="Search formula..." style="width:100%; padding:6px; margin-top:8px; border:1px solid #ddd; border-radius:4px; font-size:11px;" oninput="searchFormulas()">
                    </div>
                    <div id="paintFormulaList" style="background:#fff; border:1px solid #ddd; border-radius:8px; overflow:hidden; max-height:400px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="forms" class="view-section">
        <div class="card">
            <h3>Generate Form</h3>
            <div class="form-grid">
                <div id="form-estimate" class="form-card" onclick="genForm('Estimate')"><h4>Estimate</h4><p>Job breakdown only</p></div>
                <div id="form-supply" class="form-card" onclick="genForm('Supply Docket')"><h4>Supply Docket</h4><p>Part list for client</p></div>
                <div id="form-mixing" class="form-card" onclick="genForm('Mixing Card')"><h4>Mixing Card</h4><p>Paint shop formula</p></div>
                <div id="form-invoice" class="form-card" onclick="genForm('Invoice')"><h4>Invoice</h4><p>Dynamic length billing</p></div>
                <div id="form-quote" class="form-card" onclick="genForm('Quote Form')"><h4>Quote Form</h4><p>Raw vs Paint pricing</p></div>
                <div id="form-cover" class="form-card" onclick="genForm('Cover Sheet')" style="background:#fff3e0; border-color:#ff9800;"><h4>üìã Cover Sheet</h4><p>Job info summary</p></div>
                <div id="form-label" class="form-card" onclick="genForm('Shop Label')" style="background:#fce4ec; border-color:#e91e63;"><h4>üè∑Ô∏è Shop Label</h4><p>Print & post on job</p></div>
                <div id="form-paint-order" class="form-card" onclick="genForm('Paint Order')" style="background:#e8f5e9; border-color:#4caf50;"><h4>üé® Paint Order</h4><p>Manufacturing order form</p></div>
                <div id="form-a3schedule" class="form-card" onclick="openA3ScheduleModal()" style="background:#e8f5e9; border-color:#4caf50;"><h4>üìÖ A3 Schedule</h4><p>Work schedule view</p></div>
                <div id="form-batch" class="form-card" onclick="openBatchPrintModal()" style="background:#f3e5f5; border-color:#9c27b0;"><h4>üì¶ Batch Print</h4><p>Select & print multiple</p></div>
            </div>
        </div>
    </div>

    <div id="history" class="view-section">
        <div class="card">
            <h3>Job History</h3>
            <p style="color:#666; font-size:12px; margin-bottom:15px;">Save your current job using the üíæ button above to add it to history</p>
            
            <!-- Filter Buttons -->
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px;">
                <button onclick="filterHistory('all')" id="filter-all" style="background:#d4af37; color:#000; border:none; padding:8px 14px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">ALL</button>
                <button onclick="filterHistory('active')" id="filter-active" style="background:#f0f0f0; color:#666; border:none; padding:8px 14px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">ACTIVE</button>
                <button onclick="filterHistory('completed')" id="filter-completed" style="background:#f0f0f0; color:#666; border:none; padding:8px 14px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">COMPLETED</button>
            </div>
        </div>
        <div id="history-list"></div>
    </div>
    
    <div id="schedule" class="view-section" style="width:100vw; margin-left:calc(-50vw + 50%); position:relative;">
    

        <!-- Global Notifications -->
        <div class="card" style="background:#f0fdf4; border-left:5px solid #34c759; margin-left:0; margin-right:0;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:#34c759;">üîî Global Notifications</h3>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="notificationBadge" style="background:#ff3b30; color:#fff; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:12px;">0</span>
                    <button onclick="toggleNotifications()" style="border:none; background:#34c759; color:#fff; padding:6px 12px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚àí</button>
                </div>
            </div>
            <div id="globalNotifications" style="max-height:200px; overflow-y:auto; display:block;">
                <p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p>
            </div>
        </div>

        <div class="card" style="margin-left:0; margin-right:0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Jobs Chart</h3>
                <div style="display:flex; gap:8px;">
                    <button onclick="prevScheduleMonth()" style="border:none; background:#f0f0f0; width:35px; height:35px; border-radius:6px; font-weight:900; cursor:pointer;">‚Üê</button>
                    <button onclick="nextScheduleMonth()" style="border:none; background:#f0f0f0; width:35px; height:35px; border-radius:6px; font-weight:900; cursor:pointer;">‚Üí</button>
                    <button id="jobsChartToggleBtn" onclick="toggleJobsChart()" title="Minimize/Maximize" style="border:none; background:#2196f3; color:#fff; width:35px; height:35px; border-radius:6px; font-weight:900; cursor:pointer; font-size:18px;">‚àí</button>
                </div>
            </div>
            <div id="scheduleMonthYear" style="text-align:center; font-weight:900; font-size:16px; margin-bottom:15px; color:#000;"></div>
        </div>

        <!-- Jobs Chart Timeline - Full Width -->
        <div id="ganttWrapper" style="width:100vw; margin-left:calc(-50vw + 50%); background:#fff; padding:15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow-x:auto; overflow-y:hidden; min-height:600px; display:block; visibility:visible; scroll-behavior:smooth; cursor:grab;">
            <!-- Jobs Chart Container -->
            <div id="ganttChart" style="min-width:1200px; padding:0; display:flex; flex-direction:column; user-select:none;">
                <!-- Jobs chart will render here -->
            </div>
        </div>
        <div style="text-align:center; font-size:11px; color:#999; margin-top:8px;">‚Üê Scroll horizontally to view different months ‚Üí</div>

    </div>
    
    <div id="admin" class="view-section" style="flex-direction:column; height:calc(100vh - 200px);">
        
        <!-- Admin Sub-Tabs - Fixed below main tabs -->
        <div class="sub-nav" style="margin-bottom:0px; position:fixed; top:120px; left:0; right:0; background:#fff; z-index:99; border-bottom:2px solid var(--gs); padding:10px 15px; display:flex; gap:10px; border-radius:0;">
            <button class="sub-btn active" onclick="switchAdminTab('general')" id="admin-tab-general">General Settings</button>
            <button class="sub-btn" onclick="switchAdminTab('colours')" id="admin-tab-colours">Colours</button>
            <button class="sub-btn" onclick="switchAdminTab('clients')" id="admin-tab-clients">Clients</button>
            <button class="sub-btn" onclick="switchAdminTab('pricing')" id="admin-tab-pricing">Price Matrix</button>
        </div>
        
        <!-- Scrollable Content Area -->
        <div class="card" style="overflow-y:auto; flex:1; margin-bottom:80px; padding-bottom:20px; margin-top:50px;">
            <!-- General Settings Tab -->
            <div id="admin-tab-general-content" class="admin-tab-content active">
                <!-- VERSION DISPLAY - Always visible -->
                <div style="background:#f0f0f0; border:2px solid #2196f3; border-radius:6px; padding:15px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h4 style="margin:0; margin-bottom:5px; font-weight:900; color:#2196f3;">üîπ PaintWorkz Pro Version</h4>
                            <p style="margin:0; font-size:11px; color:#666;">Current installed version</p>
                        </div>
                        <div style="text-align:right;">
                            <div id="adminVersionDisplay" style="font-size:18px; font-weight:900; color:#2196f3; margin-bottom:3px;">v1.7.24</div>
                            <div id="adminVersionDate" style="font-size:10px; color:#666;">2026-02-27</div>
                        </div>
                    </div>
                    <div style="margin-top:10px; padding-top:10px; border-top:1px solid #ddd; font-size:9px; color:#999;">
                        ‚úì If version changes, <strong>clear cache</strong> with: Ctrl+Shift+Delete (browser) or Ctrl+Shift+R (hard refresh)
                    </div>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; margin-top:20px; font-weight:900;">Measure Tab Defaults</h4>
                    <button onclick="let container = document.getElementById('measure-defaults-container'); container.style.display = container.style.display === 'none' ? 'block' : 'none';" style="background:none; border:none; cursor:pointer; font-weight:900; font-size:18px; color:#999;">‚àí</button>
                </div>
                <div id="measure-defaults-container" style="display:none;">
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Set default values for new parts in the Measure tab</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Default Material Thickness (mm)</label>
                        <input type="number" id="defaultThickness" value="18" min="1" max="50" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Default SE Return Value (mm)</label>
                        <input type="number" id="defaultSEReturn" value="100" min="10" max="500" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                </div>
                <button onclick="saveDefaultSettings()" style="border:none; background:#34c759; color:#fff; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚úì SAVE DEFAULTS</button>
                </div>
                
                <hr style="margin:30px 0; border:none; border-top:1px solid #ddd;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; margin-top:20px; font-weight:900;">üåç Global Settings</h4>
                    <button onclick="let container = document.getElementById('global-settings-container'); container.style.display = container.style.display === 'none' ? 'block' : 'none';" style="background:none; border:none; cursor:pointer; font-weight:900; font-size:18px; color:#999;">‚àí</button>
                </div>
                <div id="global-settings-container" style="display:block;">
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Configure global app settings for measurements, precision, and AI features</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Measurement Units</label>
                        <select id="globalUnitsSelect" onchange="setUnits(this.value)" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                            <option value="METRIC">METRIC (mm)</option>
                            <option value="IMPERIAL">IMPERIAL (inches)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Measurement Precision</label>
                        <select id="globalPrecisionSelect" onchange="setPrecision(this.value)" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                            <option value="0.1">0.1 (nearest tenth)</option>
                            <option value="0.01">0.01 (nearest hundredth)</option>
                            <option value="0.001">0.001 (nearest thousandth)</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                    <div style="padding:12px; background:#f0f8ff; border-radius:6px; border-left:4px solid #2196f3;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">Colour Match Surcharge ($)</label>
                        <input type="number" id="colourMatchSurcharge" value="85" min="0" step="1" onchange="setColourMatchSurcharge(this.value)" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;">
                        <p style="font-size:10px; color:#999; margin-top:4px; margin-bottom:0;">Fixed flat rate for colour match surcharge</p>
                    </div>
                    <div style="padding:12px; background:#f0f8ff; border-radius:6px; border-left:4px solid #2196f3;">
                        <label style="display:flex; align-items:center; gap:8px; font-weight:900; font-size:11px; color:#666; cursor:pointer;">
                            <input type="checkbox" id="aiHelperToggle" onchange="toggleAIHelper(this.checked)" style="cursor:pointer; width:16px; height:16px;">
                            AI Helper Bot
                        </label>
                        <p style="font-size:10px; color:#999; margin-top:4px; margin-bottom:0;">Enable AI assistant for trade guidance</p>
                    </div>
                </div>
                
                <hr style="margin:30px 0; border:none; border-top:1px solid #ddd;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; margin-top:20px; font-weight:900;">üé® Paint Brands (Global Configuration)</h4>
                    <button onclick="let container = document.getElementById('paint-brands-container'); container.style.display = container.style.display === 'none' ? 'block' : 'none';" style="background:none; border:none; cursor:pointer; font-weight:900; font-size:18px; color:#999;">‚àí</button>
                </div>
                <div id="paint-brands-container" style="display:none;">
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Configure available paint brands for your region (e.g., Dulux, Wattyl for Australia; Benjamin Moore, Sherwin-Williams for USA)</p>
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Add New Brand</label>
                    <div style="display:grid; grid-template-columns:1fr 80px; gap:10px;">
                        <input type="text" id="newPaintBrandInput" placeholder="e.g., Benjamin Moore" style="padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                        <button onclick="addPaintBrand()" style="border:none; background:#34c759; color:#fff; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">+ ADD</button>
                    </div>
                </div>
                <div style="background:#f9f9f9; padding:12px; border-radius:6px; margin-bottom:15px;">
                    <p style="font-size:10px; font-weight:900; color:#666; margin-bottom:8px;">Available Brands:</p>
                    <div id="paintBrandsList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                </div>
                <button onclick="savePaintBrands()" style="border:none; background:#d4af37; color:#000; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">üíæ SAVE BRANDS</button>
                </div>
                
                <hr style="margin:30px 0; border:none; border-top:1px solid #ddd;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; margin-top:20px; font-weight:900;">Company Details (PDF Header)</h4>
                    <button onclick="let container = document.getElementById('company-details-container'); container.style.display = container.style.display === 'none' ? 'block' : 'none';" style="background:none; border:none; cursor:pointer; font-weight:900; font-size:18px; color:#999;">‚àí</button>
                </div>
                <div id="company-details-container" style="display:none;">
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Update your company information displayed on all PDF forms (Estimates, Quotes, Invoices, Supply Dockets)</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Company Name</label>
                        <input type="text" id="companyName" placeholder="Paintworkz" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Phone Number</label>
                        <input type="text" id="companyPhone" placeholder="0438 803 032" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Email Address</label>
                        <input type="email" id="companyEmail" placeholder="paint_workz@outlook.com" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Address</label>
                        <input type="text" id="companyAddress" placeholder="17 West Boundary Road, Hamilton 3300 VIC" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Company Logo (PNG - Circle Logo)</label>
                        <input type="file" id="companyLogo" accept="image/png" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:11px; box-sizing:border-box;">
                        <p style="font-size:10px; color:#999; margin-top:5px; margin-bottom:0;">Upload a PNG file for your circle logo (recommended size: 150x150px)</p>
                    </div>
                    <div style="grid-column:1 / -1; background:#fff3cd; padding:12px; border-radius:6px; border-left:4px solid #ffc107; margin-top:10px; margin-bottom:10px;">
                        <p style="font-size:10px; color:#856404; font-weight:900; margin:0;"><strong>üíæ Logo Storage:</strong> Logos are stored locally on this device. You'll need to upload them again on other computers you use.</p>
                    </div>
                    <div style="grid-column:1 / -1;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Header Logo (PNG - Full Brand Header)</label>
                        <input type="file" id="headerLogo" accept="image/png" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; font-size:11px; box-sizing:border-box;">
                        <p style="font-size:10px; color:#999; margin-top:5px; margin-bottom:0;">Upload a PNG file for your header/branding logo (recommended size: 1024x300px or similar aspect ratio)</p>
                    </div>
                </div>
                <button onclick="saveCompanyDetails()" style="border:none; background:#d4af37; color:#000; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer; margin-right:10px;">üíæ SAVE COMPANY DETAILS</button>
                <button onclick="resetCompanyDetails()" style="border:none; background:#ff9500; color:#fff; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚Üª RESET TO DEFAULTS</button>
                </div>
                
                <hr style="margin:30px 0; border:none; border-top:1px solid #ddd;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; margin-top:20px; font-weight:900;">API Integration Keys</h4>
                    <button onclick="let container = document.getElementById('api-keys-container'); container.style.display = container.style.display === 'none' ? 'block' : 'none';" style="background:none; border:none; cursor:pointer; font-weight:900; font-size:18px; color:#999;">‚àí</button>
                </div>
                <div id="api-keys-container" style="display:none;">
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Store your external API keys for third-party integrations and AI features</p>
                <div style="display:grid; grid-template-columns:1fr; gap:15px; margin-bottom:20px;">
                    <div style="padding:12px; background:#e8f5ff; border-radius:6px; border-left:4px solid #6200ea;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">ü§ñ Google Gemini API Key</label>
                        <input type="password" id="geminiApiKey" placeholder="AIza..." autocomplete="off" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;" oninput="saveGeminiApiKey(this.value)" onchange="saveGeminiApiKey(this.value)" onblur="validateAndSaveApiKey()">
                        <p style="font-size:10px; color:#999; margin-top:4px; margin-bottom:0;">Get free from <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#2196f3; text-decoration:none;">Google AI Studio ‚Üí</a> for AI chat features</p>
                        <div id="apiKeyStatus" style="font-size:10px; color:#34c759; margin-top:6px; font-weight:900; display:none;">‚úì API Key Saved</div>
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Evic ExpressTint API Key</label>
                        <input type="password" id="evicApiKey" placeholder="Enter your Evic API key" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                        <p style="font-size:10px; color:#999; margin-top:4px; margin-bottom:0;">Used to search and retrieve paint formulas from Evic's color database</p>
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Xero Integration API Key</label>
                        <input type="password" id="xeroApiKey" placeholder="Enter your Xero API key" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                        <p style="font-size:10px; color:#999; margin-top:4px; margin-bottom:0;">Used to integrate with Xero accounting software for invoicing and reporting</p>
                    </div>
                </div>
                <button onclick="saveApiKeys()" style="border:none; background:#2196f3; color:#fff; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">üîê SAVE API KEYS</button>
                </div>
                
                <hr style="margin:30px 0; border:none; border-top:1px solid #ddd;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; margin-top:20px; font-weight:900;">Additional Charges Configuration</h4>
                    <button onclick="let container = document.getElementById('additional-charges-container'); container.style.display = container.style.display === 'none' ? 'block' : 'none';" style="background:none; border:none; cursor:pointer; font-weight:900; font-size:18px; color:#999;">‚àí</button>
                </div>
                <div id="additional-charges-container" style="display:none;">
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Configure door colour multipliers and delivery region charges</p>
                
                <!-- Door Colour Multipliers -->
                <div style="margin-bottom:20px; padding:15px; background:#f5f5f5; border-radius:6px;">
                    <h5 style="margin:0 0 15px 0; font-weight:bold; font-size:12px;">Door Colour Multipliers (% of paint price)</h5>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Clear</label>
                            <input type="number" id="chargeClear" value="0" min="0" max="100" step="0.5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Standard</label>
                            <input type="number" id="chargeStandard" value="0" min="0" max="100" step="0.5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Light</label>
                            <input type="number" id="chargeLight" value="0" min="0" max="100" step="0.5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Dark</label>
                            <input type="number" id="chargeDark" value="15" min="0" max="100" step="0.5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Extra Tint</label>
                            <input type="number" id="chargeExtraTint" value="30" min="0" max="100" step="0.5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Undercoat (% of paint only)</label>
                            <input type="number" id="chargeUndercoat" value="80" min="0" max="100" step="0.5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Colour Match (Flat $)</label>
                            <div style="display:flex; gap:8px;">
                                <input type="number" id="chargeColourMatch" value="85" min="0" max="500" step="1" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                                <button onclick="document.getElementById('chargeColourMatch').value = 85; notify('‚úì Reset to $85');" style="border:none; background:#666; color:#fff; padding:8px 12px; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer; white-space:nowrap;">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Delivery Regions -->
                <div style="margin-bottom:20px; padding:15px; background:#f5f5f5; border-radius:6px;">
                    <h5 style="margin:0 0 15px 0; font-weight:bold; font-size:12px;">Delivery/Pickup Regions ($)</h5>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Warrnambool</label>
                            <input type="number" id="regionWarrnambool" value="90" min="0" step="5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Geelong</label>
                            <input type="number" id="regionGeelong" value="110" min="0" step="5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Mt Gambier</label>
                            <input type="number" id="regionMtGambier" value="110" min="0" step="5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Adelaide</label>
                            <input type="number" id="regionAdelaide" value="250" min="0" step="5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Horsham</label>
                            <input type="number" id="regionHorsham" value="110" min="0" step="5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">Ballarat</label>
                            <input type="number" id="regionBallarat" value="160" min="0" step="5" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                    </div>
                </div>
                
                <!-- Other Settings -->
                <div style="margin-bottom:20px; padding:15px; background:#f5f5f5; border-radius:6px;">
                    <h5 style="margin:0 0 15px 0; font-weight:bold; font-size:12px;">Other Settings</h5>
                    <div style="display:grid; grid-template-columns:1fr; gap:12px;">
                        <div>
                            <label style="display:block; font-weight:900; font-size:10px; color:#666; margin-bottom:4px;">GST Rate (%) - Applied to subtotal + charges</label>
                            <input type="number" id="gstRate" value="10" min="0" max="25" step="0.1" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:11px; box-sizing:border-box;">
                        </div>
                    </div>
                </div>
                
                <button onclick="saveAdditionalCharges()" style="border:none; background:#34c759; color:#fff; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚úì SAVE CHARGES</button>
                </div>
                
                <hr style="margin:30px 0; border:none; border-top:1px solid #ddd;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; margin-top:20px; font-weight:900;">Gantt Chart Timeline</h4>
                    <button onclick="let container = document.getElementById('timeline-settings-container'); container.style.display = container.style.display === 'none' ? 'block' : 'none';" style="background:none; border:none; cursor:pointer; font-weight:900; font-size:18px; color:#999;">‚àí</button>
                </div>
                <div id="timeline-settings-container" style="display:none;">
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Configure default timeline durations for the job Gantt chart (measured in days)</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Measure (m)</label>
                        <input type="number" id="timelineMeasure" value="1" min="1" max="30" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Sand 1st Coat (s1)</label>
                        <input type="number" id="timelineSand1" value="4" min="1" max="30" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Undercoat (u)</label>
                        <input type="number" id="timelineUndercoat" value="2" min="1" max="30" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Sand 2nd Coat (s2)</label>
                        <input type="number" id="timelineSand2" value="3" min="1" max="30" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Top Coat (t)</label>
                        <input type="number" id="timelineTopcoat" value="2" min="1" max="30" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Inspection (i)</label>
                        <input type="number" id="timelineInstall" value="2" min="1" max="30" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Completion/Delivery (c)</label>
                        <input type="number" id="timelineCompletion" value="1" min="1" max="30" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                </div>
                <button onclick="saveTimelineSettings()" style="border:none; background:#2196f3; color:#fff; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer; margin-right:10px;">‚úì SAVE TIMELINE</button>
                <button onclick="resetTimelineSettings()" style="border:none; background:#ff9500; color:#fff; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚Üª RESET DEFAULTS</button>
                </div>
                
                <hr style="margin:30px 0; border:none; border-top:1px solid #ddd;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; margin-top:20px; font-weight:900;">Notification Archive</h4>
                    <button onclick="toggleAdminAlerts()" style="background:none; border:none; cursor:pointer; font-weight:900; font-size:18px; color:#999;">‚àí</button>
                </div>
                <div id="admin-alerts-container" style="display:block;">
                    <div id="admin-alerts"></div>
                </div>
                
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Database Status</h4>
                <p style="font-size:11px; color:#666; margin-bottom:10px; background:#f0f0f0; padding:10px; border-radius:6px;">All systems operational. Job history is clean and synced.</p>
                
                <hr style="margin:30px 0; border:none; border-top:1px solid #ddd;">
                
                <div style="background:#f5f5f5; border-left:4px solid #d4af37; padding:15px; border-radius:6px; margin-top:20px;">
                    <p style="font-size:10px; color:#666; margin:0; line-height:1.6;">
                        <strong style="color:#333; font-weight:900;">PaintWorkz Pro</strong><br>
                        <span style="color:#999;"><strong>Created & Owned by Colin Bedford</strong></span><br>
                        <span id="currentDate" style="color:#999;">14 February 2026</span><br><br>
                        <span id="versionDisplay" style="color:#d4af37; font-weight:900;">v1.7.24 ADMIN TABS FIXED |</span><span id="versionDate" style="color:#d4af37; font-weight:900;"> 2026-02-27</span>
                    </p>
                </div>
            </div>
            
            <!-- Colours Tab -->
            <div id="admin-tab-colours-content" class="admin-tab-content">
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">üé® Form Button Colours</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Customize button colors for all form types - changes apply instantly</p>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <!-- Paint Order Button -->
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; border-left:4px solid #ff9800;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">üé® Paint Order</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="paint_order_picker" value="#e8f5e9" onchange="updateFormColor('form-paint-order', this.value)" style="width:50px; height:40px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">
                            <input type="text" id="paint_order_code" value="#e8f5e9" onchange="updateFormColor('form-paint-order', this.value)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;" placeholder="#e8f5e9">
                        </div>
                    </div>
                    
                    <!-- Estimate Button -->
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; border-left:4px solid #ff9800;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">üìä Estimate</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="estimate_picker" value="#ede7f6" onchange="updateFormColor('form-estimate', this.value)" style="width:50px; height:40px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">
                            <input type="text" id="estimate_code" value="#ede7f6" onchange="updateFormColor('form-estimate', this.value)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;" placeholder="#ede7f6">
                        </div>
                    </div>
                    
                    <!-- Quote Form Button -->
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; border-left:4px solid #ff9800;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">üí¨ Quote Form</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="quote_picker" value="#fff3cd" onchange="updateFormColor('form-quote', this.value)" style="width:50px; height:40px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">
                            <input type="text" id="quote_code" value="#fff3cd" onchange="updateFormColor('form-quote', this.value)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;" placeholder="#fff3cd">
                        </div>
                    </div>
                    
                    <!-- Mixing Card Button -->
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; border-left:4px solid #ff9800;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">üß™ Mixing Card</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="mixing_picker" value="#f3e5f5" onchange="updateFormColor('form-mixing', this.value)" style="width:50px; height:40px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">
                            <input type="text" id="mixing_code" value="#f3e5f5" onchange="updateFormColor('form-mixing', this.value)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;" placeholder="#f3e5f5">
                        </div>
                    </div>
                    
                    <!-- Supply Docket Button -->
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; border-left:4px solid #ff9800;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">üìã Supply Docket</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="supply_picker" value="#e3f2fd" onchange="updateFormColor('form-supply-docket', this.value)" style="width:50px; height:40px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">
                            <input type="text" id="supply_code" value="#e3f2fd" onchange="updateFormColor('form-supply-docket', this.value)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;" placeholder="#e3f2fd">
                        </div>
                    </div>
                    
                    <!-- Shop Label Button -->
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; border-left:4px solid #ff9800;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">üè∑Ô∏è Shop Label</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="shop_picker" value="#e0f2f1" onchange="updateFormColor('form-shop-label', this.value)" style="width:50px; height:40px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">
                            <input type="text" id="shop_code" value="#e0f2f1" onchange="updateFormColor('form-shop-label', this.value)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;" placeholder="#e0f2f1">
                        </div>
                    </div>
                    
                    <!-- Invoice Button -->
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; border-left:4px solid #ff9800;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">üí∞ Invoice</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="invoice_picker" value="#f0f8ff" onchange="updateFormColor('form-invoice', this.value)" style="width:50px; height:40px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">
                            <input type="text" id="invoice_code" value="#f0f8ff" onchange="updateFormColor('form-invoice', this.value)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;" placeholder="#f0f8ff">
                        </div>
                    </div>
                    
                    <!-- Cover Sheet Button -->
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; border-left:4px solid #ff9800;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">üìÑ Cover Sheet</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="cover_picker" value="#fce4ec" onchange="updateFormColor('form-cover-sheet', this.value)" style="width:50px; height:40px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">
                            <input type="text" id="cover_code" value="#fce4ec" onchange="updateFormColor('form-cover-sheet', this.value)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;" placeholder="#fce4ec">
                        </div>
                    </div>
                    
                    <!-- A3 Schedule Button -->
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; border-left:4px solid #ff9800;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">üìÖ A3 Schedule</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="a3_picker" value="#fff8e1" onchange="updateFormColor('form-a3-schedule', this.value)" style="width:50px; height:40px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">
                            <input type="text" id="a3_code" value="#fff8e1" onchange="updateFormColor('form-a3-schedule', this.value)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;" placeholder="#fff8e1">
                        </div>
                    </div>
                    
                    <!-- Batch Print Button -->
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; border-left:4px solid #ff9800;">
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:8px;">üì¶ Batch Print</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="color" id="batch_picker" value="#f3e5f5" onchange="updateFormColor('form-batch-print', this.value)" style="width:50px; height:40px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">
                            <input type="text" id="batch_code" value="#f3e5f5" onchange="updateFormColor('form-batch-print', this.value)" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box;" placeholder="#f3e5f5">
                        </div>
                    </div>
                </div>
                
                <hr style="margin:20px 0; border:none; border-top:1px solid #ddd;">
                
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Theme Colours</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Customize all colours throughout the app - changes apply instantly</p>
                <div id="colorCustomizerContent" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
            </div>
            
            <!-- Clients Database Tab -->
            <div id="admin-tab-clients-content" class="admin-tab-content">
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Client Database</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Scroll to see all clients or search by name</p>
                <button onclick="showAddClientForm()" style="border:none; background:#34c759; color:#fff; padding:12px 20px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer; width:100%; margin-bottom:15px;">‚ûï ADD NEW CLIENT</button>
                
                <!-- Search box -->
                <input type="text" id="clientSearchBox" placeholder="üîç Search clients..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:13px; box-sizing:border-box; margin-bottom:15px;" onkeyup="filterClientList()">
                
                <!-- Scrollable client list container with visible scrollbar -->
                <div style="border:1px solid #ddd; border-radius:8px; background:#fff; padding:0;">
                    <div id="clientsList" style="height:500px; overflow-y:scroll; display:flex; flex-direction:column; gap:0; padding:10px; scrollbar-width:thin; scrollbar-color:#2196f3 #f0f0f0;"></div>
                </div>
            </div>
            
            <!-- Price Matrix Tab -->
            <div id="admin-tab-pricing-content" class="admin-tab-content">
                <div id="admin-pricing-matrix" style="margin-top:15px;"></div>
            </div>
            
            <!-- Global Notifications & Jobs Chart -->
            <div style="margin-top:20px; padding-top:20px; border-top:2px solid #ddd;">
                
                <!-- Global Notifications -->
                <div class="card" style="background:#f0fdf4; border-left:5px solid #34c759; margin:0 0 15px 0; padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <h4 style="margin:0; color:#34c759; font-weight:900;">üîî Global Notifications</h4>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span id="notificationBadge" style="background:#ff3b30; color:#fff; border-radius:50%; width:20px; height:20px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:11px;">0</span>
                            <button onclick="toggleNotifications()" style="border:none; background:#34c759; color:#fff; padding:4px 10px; border-radius:6px; font-weight:900; font-size:10px; cursor:pointer;">‚àí</button>
                        </div>
                    </div>
                    <div id="globalNotifications" style="max-height:150px; overflow-y:auto; display:block; font-size:11px;">
                        <p style="color:#999; text-align:center; font-size:11px;">No notifications yet</p>
                    </div>
                </div>

                <!-- Jobs Chart -->
                <div class="card" style="margin:0; padding:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <h4 style="margin:0; font-weight:900;">üìÖ Jobs Chart</h4>
                        <div style="display:flex; gap:8px;">
                            <button onclick="prevScheduleMonth()" style="border:none; background:#f0f0f0; width:30px; height:30px; border-radius:6px; font-weight:900; cursor:pointer; font-size:12px;">‚Üê</button>
                            <button onclick="nextScheduleMonth()" style="border:none; background:#f0f0f0; width:30px; height:30px; border-radius:6px; font-weight:900; cursor:pointer; font-size:12px;">‚Üí</button>
                            <button id="jobsChartToggleBtn" onclick="toggleJobsChart()" title="Minimize/Maximize" style="border:none; background:#2196f3; color:#fff; width:30px; height:30px; border-radius:6px; font-weight:900; cursor:pointer; font-size:14px;">‚àí</button>
                        </div>
                    </div>
                    <div id="scheduleMonthYear" style="text-align:center; font-weight:900; font-size:14px; margin-bottom:12px; color:#000;"></div>
                </div>

                <!-- Jobs Chart Timeline -->
                <div id="ganttWrapper" style="background:#fff; padding:12px; border-radius:6px; border:1px solid #ddd; overflow-x:auto; overflow-y:hidden; min-height:300px; display:block; visibility:visible; scroll-behavior:smooth; cursor:grab; margin-top:10px;">
                    <div id="ganttChart" style="min-width:100%; padding:0; display:flex; flex-direction:column; user-select:none;">
                        <!-- Jobs chart will render here -->
                    </div>
                </div>
                <div style="text-align:center; font-size:10px; color:#999; margin-top:5px;">‚Üê Scroll to view different months ‚Üí</div>
                
            </div>
        </div>
        
        <!-- Removed fixed footer - moved notifications inside tab -->
    </div>
</div>

<!-- WORKLOAD SUMMARY CONTAINER - Shows only in Schedule/Admin -->
<div id="workloadSummaryContainer" style="display:none; background:#f9f9f9; border-top:1px solid #ddd; padding:12px 15px; position:fixed; bottom:60px; left:0; right:0; z-index:100;">
    <div class="card" style="margin:0; background:transparent;">
        <h4 style="margin-top:0; margin-bottom:8px; font-size:12px;">Workload Summary</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
            <div style="text-align:center; padding:8px;">
                <div id="totalActiveJobs" style="font-size:18px; font-weight:900; color:var(--gs);">0</div>
                <div style="font-size:9px; color:#666; font-weight:700;">Active Jobs</div>
            </div>
            <div style="text-align:center; padding:8px; border-left:1px solid #ddd; border-right:1px solid #ddd;">
                <div id="totalTasks" style="font-size:18px; font-weight:900; color:#ff9500;">0/0</div>
                <div style="font-size:9px; color:#666; font-weight:700;">Tasks Complete</div>
            </div>
            <div style="text-align:center; padding:8px;">
                <div id="totalWorkload" style="font-size:18px; font-weight:900; color:#2196f3;">0</div>
                <div style="font-size:9px; color:#666; font-weight:700;">SQM Workload</div>
            </div>
        </div>
    </div>
</div>

    <!-- Global Notifications Banner - Visible on all tabs -->
    <div id="globalNotificationsBanner" style="position:fixed; top:0; left:0; right:0; z-index:9999; background:linear-gradient(90deg, #fffef0 0%, #fffff8 100%); border-bottom:4px solid #ffc107; padding:16px; padding-top:20px; min-height:60px; max-height:250px; overflow-y:auto; display:none; box-shadow:0 4px 12px rgba(255, 193, 7, 0.3);">
        <div id="globalNotificationsList" style="margin:0;"></div>
    </div>
    
<div class="sticky-footer">
    <div class="footer-item" style="margin-left:15px;"><div class="footer-label">TOTAL SQM (m¬≤)</div><div class="footer-val" id="tA">0.000</div></div>
    <div style="flex:1; display:flex; justify-content:center; gap:20px; align-items:center;">
        <div class="icon-btn" onclick="genPDF()" style="color:#fff">üìÑ</div>
        <div onclick="openChatAI()" title="Chat with AI Helper" style="display:flex; align-items:center; justify-content:center; width:50px; height:50px; background:linear-gradient(135deg, #6200ea 0%, #7c3aed 100%); border-radius:50%; cursor:pointer; font-size:24px; color:#fff; box-shadow:0 4px 12px rgba(98, 0, 234, 0.4); transition:all 0.3s; border:2px solid rgba(255,255,255,0.3); animation:pulse 2s infinite;">üí¨</div>
        <style>
            @keyframes pulse {
                0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(98, 0, 234, 0.4); }
                50% { transform: scale(1.05); box-shadow: 0 6px 16px rgba(98, 0, 234, 0.6); }
            }
        </style>
        <div id="footerVersionDisplay" style="display:none; font-size:10px; color:#d4af37; font-weight:900;">‚öñÔ∏è PaintWorkz Pro ¬© 2026</div>
    </div>
    <div class="footer-item"><div class="footer-label">PARTS</div><div class="footer-val" id="tQ">0</div></div>
    <div class="icon-btn" onclick="handleLogout()" title="Logout" style="color:#ff3b30; font-size:24px; cursor:pointer; margin-right:15px;">üö™</div>
</div>

<script>
    ////////////////////////////////////////////////////////////////////////////////
    // üé® PAINTWORKZ PRO v1.6.0 GLOBAL (17 Feb 2026)
    ////////////////////////////////////////////////////////////////////////////////
    // LAST UPDATED: 17 Feb 2026
    // CHANGES: Filtered PDF generation, Job Filing Sheet, Inspection timeline fix
    // 
    // ‚ö†Ô∏è HARDCODED GANTT CHART DEFAULTS (Admin ‚Üí General Settings ‚Üí Gantt Chart):
    //    M (Measure) = 1 day
    //    S1 (Sand 1st Coat) = 4 days
    //    U (Undercoat) = 2 days
    //    S2 (Sand 2nd Coat) = 3 days
    //    T (Top Coat) = 2 days
    //    I (Inspection) = 2 days
    //    C (Completion/Delivery) = 1 day
    //
    // ‚ö†Ô∏è IMPORTANT: Keep this header updated with every code change!
    ////////////////////////////////////////////////////////////////////////////////
    
    console.log('%c‚öñÔ∏è  COPYRIGHT & OWNERSHIP NOTICE ‚öñÔ∏è ', 'background:#ff6b6b;color:#fff;font-weight:900;padding:10px;border-radius:4px;');
    console.log('%cPaintWorkz Pro - Designed & Owned by Colin Bedford', 'color:#ff6b6b;font-weight:900;font-size:14px;');
    console.log('%c‚ùå NOT OWNED BY PAINTWORKZ PTY LTD ‚ùå', 'color:#ff6b6b;font-weight:900;font-size:12px;');
    console.log('%cThis software is the personal intellectual property of Colin Bedford.', 'color:#ff0000;font-weight:bold;');
    console.log('%cUnauthorized copying, modification, or claiming ownership is prohibited.', 'color:#ff0000;font-weight:bold;');
    console.log('%cAll rights reserved ¬© 2026 Colin Bedford', 'color:#ff0000;font-weight:bold;');
    console.log('');
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è VERSION: v1.7.24-FINAL | 2026-02-27 | Colin Bedford ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
    // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ADMIN TABS FIXED | COVER SHEET FIXED | DELETE CONFIRMATION ADDED ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è
    console.log('%c ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è üé® PaintWorkz Pro v1.7.24-FINAL (2026-02-27) ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è ', 'background:#ff0000;color:#ffffff;font-weight:900;padding:12px;border-radius:6px;font-size:14px;');
    console.log('%c ADMIN TABS NOW WORKING | Cover Sheet = Shop Label | Delete Confirmation Added ', 'background:#00ff00;color:#000;font-weight:900;padding:10px;');
    console.log('‚úì Client Editor - Added STATE field (NSW/VIC/QLD/WA/SA/TAS/NT/ACT)');
    console.log('‚úì New Client Form - Added STATE field');
    console.log('‚úì CANCEL button now only way to close without saving');
    console.log('‚úì State field stored in client database and saved');
    console.log('‚úì Cover Sheet redesigned with full paint specs and client details');
    console.log('‚úì Filtered PDF generation complete');
    console.log('‚úÖ CRITICAL FIXES:');
    console.log('‚úì PDF button now shows form selection modal (not navigate to forms tab)');
    console.log('‚úì Disabled Firebase real-time sync (memory crashes fixed)');
    console.log('‚úì Improved error handling to prevent crashes');
    console.log('‚úì Door profile persistence fixed');
    console.log('‚úì Job completion toggle working');
    console.log('‚úì Measure sheet clears on save');
    console.log('‚úì Workload summary correctly excludes completed');
    // ====================================
    
    // Firebase already initialized at top of page
    let isSignup = false;

    // Wait for Firebase to be initialized before using it
    function waitForFirebase() {
        if (typeof auth !== 'undefined' && auth !== null) {
            // Firebase is ready, set up auth listener
            window.onAuthStateChanged((user) => {
              if (user) {
                window.currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('userInfo').innerHTML = `
                  <span style="font-weight:900;">üë§ ${user.email.split('@')[0]}</span>
                  <button id="logoutBtn" onclick="logout()" style="background:#ff3b30; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-weight:900; margin-left:10px;">Logout</button>
                `;
                loadDataFromFirestore();
              } else {
                window.currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('userInfo').innerHTML = '';
              }
            });
        } else {
            // Firebase not ready yet, try again
            setTimeout(waitForFirebase, 100);
        }
    }
    
    // Start waiting for Firebase
    waitForFirebase();

    // Login/Signup Handler
    function handleAuth() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');
      
      if (!email || !password) {
        errorDiv.innerHTML = '‚ö†Ô∏è Please enter email and password';
        return;
      }
      
      if (isSignup) {
        window.createUserWithEmailAndPassword(email, password)
          .then(result => {
            errorDiv.innerHTML = '‚úÖ Account created! Logging in...';
            setTimeout(() => {
              document.getElementById('loginEmail').value = '';
              document.getElementById('loginPassword').value = '';
            }, 1000);
          })
          .catch(error => {
            errorDiv.innerHTML = '‚ùå ' + error.message;
          });
      } else {
        window.signInWithEmailAndPassword(email, password)
          .then(result => {
            errorDiv.innerHTML = '‚úÖ Logged in successfully!';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
          })
          .catch(error => {
            errorDiv.innerHTML = '‚ùå ' + error.message;
          });
      }
    }

    function toggleSignup() {
      isSignup = !isSignup;
      document.getElementById('loginTitle').innerHTML = isSignup ? 'Create Account' : 'PaintWorkz Login';
      document.getElementById('loginBtn').innerHTML = isSignup ? 'Sign Up' : 'Login';
      document.getElementById('toggleBtn').innerHTML = isSignup ? 'Have an account? Login' : "Don't have an account? Sign Up";
      document.getElementById('loginError').innerHTML = '';
    }

    function logout() {
      window.signOut().then(() => {
      });
    }

    // Save data to Firestore
    async function saveDataToFirestore() {
      if (!window.currentUser) {
        return;
      }
      
      try {
        const data = {
          items: items,
          client: document.getElementById('cli')?.value || '',
          dateReceived: document.getElementById('dRec')?.value || '',
          totalSqm: document.getElementById('sqm')?.value || '',
          doorProfiles: doorProfiles,
          paintData: paintData,
          lastSaved: new Date().toISOString()
        };
        
        const measureDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'data', 'measureData');
        await window.setDoc(measureDocRef, data);
        
        const historyDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'history', 'jobs');
        await window.setDoc(historyDocRef, {
          history: history,
          lastUpdated: new Date().toISOString()
        });
        
      } catch (error) {
      }
    }

    // Load data from Firestore
    async function loadDataFromFirestore() {
      if (!window.currentUser) return;
      
      try {
        // Load measure data
        const measureDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'data', 'measureData');
        const measureDoc = await window.getDoc(measureDocRef);
        if (measureDoc.exists()) {
          const data = measureDoc.data();
          items = data.items || [];
          doorProfiles = data.doorProfiles || [];
          paintData = data.paintData || [];
          if (document.getElementById('cli')) document.getElementById('cli').value = data.client || '';
          if (document.getElementById('dRec')) document.getElementById('dRec').value = data.dateReceived || '';
          if (document.getElementById('sqm')) document.getElementById('sqm').value = data.totalSqm || '';
        }
        
        // Load job history
        const historyDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'history', 'jobs');
        const historyDoc = await window.getDoc(historyDocRef);
        if (historyDoc.exists()) {
          history = historyDoc.data().history || [];
        }
        
        // NOTE: Door profiles are NOT loaded from Firebase
        // They are ONLY loaded from localStorage to prevent stale data
        // Firebase is used for backup/sync only, not for restoration
        
        refreshLists();
        renderHistory();
        renderScheduleCalendar();
        initializeDefaultSettings();  // Load default thickness and SE return values
        initializeCompanyDetailsForm();  // Load company details for PDF headers
        initializeApiKeysForm();  // Load API keys from storage
        initializeTimelineSettings();  // Load Gantt chart timeline settings
        initializeAdditionalChargesForm();  // Load additional charges settings
      } catch (error) {
      }
    }

    // ==================== END FIREBASE SETUP ====================
    let items = [], mode = 'SS', pType = 'Panel', fmState = 'Flat', currentPanelFilter = 'all', currentColorFilter = '';
    
    // RESTORED MASTER LISTS
    let clients = ["ABM", "Absolute Kitchens", "Advanced Cabinetry", "AKC Kitchens", "Braw Creative", "Brian Moloney", "Cabinets & Stone", "Cabinets by Michael", "Chooka", "CKK", "Clover Doors", "Complete Style Joinery", "Concept 2 Reality", "Coronet Kitchens", "Create a Kitchen", "Creative Cabinetry", "Cutting Edge Joinery", "Driscolls Joinery", "Evolution Kitchens and Joinery", "Geoff Frost Builders", "GM Cabinets", "Grampians Joinery", "Grovedale Kitchens", "Gunning Concepts", "Hamilton Sheetmetal", "Harris Cabinets", "Howe Kitchens & Joinery", "Hy-Craft", "Jardines Cabinets", "Joinery by Jarrod", "Jonassons", "Kingston Kabinets", "Kitchens U Build", "Kyle Hendy", "Leighton Park", "Matthews Joinery", "Ocean Grove Joinery", "Onshore", "R J Walter", "Richardson Joinery", "Schier Cabinet Makers", "Snaauws Kitchens", "SRT Cabinetry", "Stawell Joinery", "Stephensons Kitchens", "T&J Kitchens", "Tony Lambert Kitchens", "Total Kitchen Solutions", "Trendset Kitchens", "Troy Turner", "Ultrabuild", "VG Cabinets", "VJS Geelong", "VJS Shepparton", "Walk in Client", "Westend Cabinetry"];
    
    // ========== GLOBAL ADMIN SETTINGS MODULE (v1.5.3+) ==========
    // Non-intrusive, modular configuration for:
    // - Measurement units (Metric/Imperial)
    // - Precision levels
    // - Predictive input memory
    // - AI Helper toggle
    
    const AdminSettings = {
        units: "METRIC",            // "METRIC" | "IMPERIAL"
        precision: 0.01,            // 0.1 | 0.01 | 0.001
        predictiveInput: true,      // remembers commonly used values
        aiHelperEnabled: true,      // AI helper bot toggle
        colourMatchSurcharge: 85     // Flat rate for colour match surcharge ($)
    };
    
    // Load AdminSettings from localStorage
    function loadAdminSettings() {
        const saved = localStorage.getItem('adminSettings');
        if (saved) {
            const loaded = JSON.parse(saved);
            Object.assign(AdminSettings, loaded);
            console.log('‚úì Admin Settings loaded from localStorage:', AdminSettings);
        }
    }
    
    // Save AdminSettings to localStorage
    function saveAdminSettings() {
        localStorage.setItem('adminSettings', JSON.stringify(AdminSettings));
        console.log('‚úì Admin Settings saved to localStorage:', AdminSettings);
    }
    
    // Unit conversion helpers
    function mmToInches(mm) {
        return mm / 25.4;
    }
    
    function inchesToMm(inches) {
        return inches * 25.4;
    }
    
    function formatMeasurement(valueMm) {
        let value = AdminSettings.units === "IMPERIAL"
            ? mmToInches(valueMm)
            : valueMm;
        return roundToPrecision(value, AdminSettings.precision);
    }
    
    function roundToPrecision(value, precision) {
        return Math.round(value / precision) * precision;
    }
    
    // Measurement input memory for predictive text
    const MeasurementMemory = {
        width: [],
        height: [],
        depth: []
    };
    
    function saveMeasurement(type, value) {
        if (!AdminSettings.predictiveInput) return;
        const list = MeasurementMemory[type];
        if (!list.includes(value)) {
            list.unshift(value);
            if (list.length > 10) list.pop();
        }
    }
    
    function getSuggestedMeasurements(type) {
        return AdminSettings.predictiveInput ? MeasurementMemory[type] : [];
    }
    
    function onMeasurementInput(type, rawValue) {
        let valueMm = AdminSettings.units === "IMPERIAL"
            ? inchesToMm(parseFloat(rawValue))
            : parseFloat(rawValue);
        valueMm = roundToPrecision(valueMm, AdminSettings.precision);
        saveMeasurement(type, valueMm);
        return valueMm;
    }
    
    // Setters for Admin UI controls
    function setUnits(value) {
        AdminSettings.units = value;
        saveAdminSettings();
        notify(`‚úì Units changed to: ${value}`);
    }
    
    function setPrecision(value) {
        AdminSettings.precision = parseFloat(value);
        saveAdminSettings();
        notify(`‚úì Precision set to: ${value}`);
    }
    
    function togglePredictiveInput(value) {
        AdminSettings.predictiveInput = value;
        saveAdminSettings();
        notify(`‚úì Predictive Input ${value ? 'enabled' : 'disabled'}`);
    }
    
    function toggleAIHelper(value) {
        AdminSettings.aiHelperEnabled = value;
        saveAdminSettings();
        notify(`‚úì AI Helper ${value ? 'enabled' : 'disabled'}`);
    }
    
    function saveGeminiApiKey(apiKey) {
        if (!apiKey || apiKey.length === 0) {
            localStorage.removeItem('geminiApiKey');
            const status = document.getElementById('apiKeyStatus');
            if (status) status.style.display = 'none';
            return;
        }
        
        localStorage.setItem('geminiApiKey', apiKey);
        console.log('‚úì Gemini API key saved to localStorage');
        
        // Show confirmation
        const status = document.getElementById('apiKeyStatus');
        if (status) {
            status.style.display = 'block';
            setTimeout(() => { status.style.display = 'none'; }, 3000);
        }
    }
    
    function validateAndSaveApiKey() {
        const input = document.getElementById('geminiApiKey');
        if (!input) return;
        
        const apiKey = input.value.trim();
        if (apiKey) {
            saveGeminiApiKey(apiKey);
        }
    }
    
    function getGeminiApiKey() {
        const key = localStorage.getItem('geminiApiKey');
        console.log('Retrieving Gemini API key from localStorage:', key ? '‚úì Found' : '‚úó Not found');
        return key || '';
    }
    
    function setColourMatchSurcharge(value) {
        loadAdditionalCharges().colourMatchFlatRate = parseFloat(value) || 85;
        saveAdminSettings();
        notify(`‚úì Colour Match Surcharge set to: $${loadAdditionalCharges().colourMatchFlatRate}`);
    }
    
    // UNIFIED COLOR SYSTEM - Simple and reliable
    function updateFormColor(buttonId, color) {
        // Validate hex color
        if (!color || !/^#[0-9A-F]{6}$/i.test(color)) {
            return;
        }
        
        color = color.toUpperCase();
        
        // Update button
        const btn = document.getElementById(buttonId);
        if (btn) {
            btn.style.background = color;
            btn.style.borderColor = color;
        }
        
        // Update BOTH inputs to match
        const suffix = buttonId.replace('form-', '').replace(/-/g, '_').toUpperCase();
        const colorPickerId = buttonId.replace('form-', '') + '_picker';
        const colorCodeId = buttonId.replace('form-', '') + '_code';
        
        const picker = document.getElementById(colorPickerId);
        const code = document.getElementById(colorCodeId);
        
        if (picker) picker.value = color;
        if (code) code.value = color;
        
        // Save
        localStorage.setItem(buttonId + '_color', color);
        
        if (typeof shouldNotify === 'undefined' || shouldNotify) notify(`‚úì ${buttonId.replace('form-', '').toUpperCase()} ‚Üí ${color}`);
    }
    
    // Load all colors on startup - silently
    function loadAllFormButtonColors() {
        const buttons = [
            'form-paint-order', 'form-estimate', 'form-quote', 'form-mixing',
            'form-supply-docket', 'form-shop-label', 'form-invoice', 
            'form-cover-sheet', 'form-a3-schedule', 'form-batch-print'
        ];
        
        buttons.forEach(buttonId => {
            const saved = localStorage.getItem(buttonId + '_color');
            if (saved && /^#[0-9A-F]{6}$/i.test(saved)) {
                // Load silently without notifications
                const btn = document.getElementById(buttonId);
                if (btn) {
                    btn.style.background = saved;
                    btn.style.borderColor = saved;
                }
                const colorPickerId = buttonId.replace('form-', '') + '_picker';
                const colorCodeId = buttonId.replace('form-', '') + '_code';
                const picker = document.getElementById(colorPickerId);
                const code = document.getElementById(colorCodeId);
                if (picker) picker.value = saved;
                if (code) code.value = saved;
            }
        });
    }
    
    // Load all form button colors on startup
    
    // Load on startup - initialize all colors and settings
    setTimeout(() => {
        loadAllFormButtonColors();
        
        // Load Gemini API key if it exists
        const apiKey = localStorage.getItem("geminiApiKey");
        if (apiKey && document.getElementById("geminiApiKey")) {
            document.getElementById("geminiApiKey").value = apiKey;
        }
    }, 500);
    
    // Load settings on app startup
    loadAdminSettings();
    // Default door profiles
    const DEFAULT_PROFILES = ["Plain (101)", "J-Mould (102)", "Sharknose (103)", "Bevelled Edge (104)", "Ashlee (201)", "Hamilton (202)", "Vertical Grooves (203)", "Tarrone (301)", "Bobby (302)", "Orford (303)", "Shaker (401)", "Shaker 45 (402)", "Shaker w/Lines (403)", "Jack (404)", "Georgia (501)", "Branxholme (502)", "Rosebrook (503)", "Benchtop", "Molding", "Custom"];
    
    let profiles = (function() {
        // Load from localStorage if available
        const saved = localStorage.getItem('doorProfiles');
        console.log('üìÇ Loading profiles from localStorage...');
        if (saved) {
            try {
                const loaded = JSON.parse(saved);
                
                // CRITICAL FIX: If profiles list is significantly shorter than defaults, it's outdated
                // (Users may have previously deleted or lost profiles accidentally)
                const expectedCount = DEFAULT_PROFILES.length;
                if (Array.isArray(loaded) && loaded.length > 0 && loaded.length < expectedCount * 0.7) {
                    console.warn(`‚ö†Ô∏è INCOMPLETE PROFILE LIST DETECTED (${loaded.length}/${expectedCount})`);
                    console.warn('   Restoring full default profile list...');
                    localStorage.removeItem('doorProfiles');
                    // Fall through to use defaults below
                } else if (Array.isArray(loaded) && loaded.length > 0) {
                    // Filter out any null/undefined/empty/duplicate entries
                    const cleaned = [];
                    const seen = new Set();
                    loaded.forEach(p => {
                        if (p && typeof p === 'string' && p.trim().length > 0 && !seen.has(p)) {
                            cleaned.push(p);
                            seen.add(p);
                        }
                    });
                    
                    if (cleaned.length === 0) {
                        console.warn('‚ö†Ô∏è All profiles were corrupt/empty, restoring defaults');
                        localStorage.removeItem('doorProfiles');
                    } else if (cleaned.length !== loaded.length) {
                        console.warn(`‚ö†Ô∏è Removed ${loaded.length - cleaned.length} corrupt/duplicate entries, kept ${cleaned.length}`);
                        localStorage.setItem('doorProfiles', JSON.stringify(cleaned));
                        console.log('  Cleaned profiles:', cleaned);
                        return cleaned;
                    } else {
                        return loaded;
                    }
                } else if (Array.isArray(loaded) && loaded.length === 0) {
                    console.warn('‚ö†Ô∏è doorProfiles array is empty, using defaults');
                    localStorage.removeItem('doorProfiles');
                } else {
                    console.warn('‚ö†Ô∏è doorProfiles is not a valid array, restoring defaults');
                    localStorage.removeItem('doorProfiles');
                }
            } catch(e) {
                console.error('Error loading door profiles from localStorage:', e);
                console.warn('‚ö†Ô∏è Restoring default door profiles');
                localStorage.removeItem('doorProfiles');
            }
        } else {
            console.log('‚ÑπÔ∏è No saved door profiles in localStorage, using defaults');
        }
        // Use defaults
        const defaults = [...DEFAULT_PROFILES];
        console.log('  Saving defaults to localStorage immediately...');
        localStorage.setItem('doorProfiles', JSON.stringify(defaults)); // SAVE DEFAULTS
        console.log('  ‚úì Defaults saved to localStorage');
        return defaults;
    })();
    
    // Log profiles initialization
    console.log('   Initial profiles array:', profiles);
    
    // Helper function to save profiles to localStorage
    function saveProfilesToStorage() {
        localStorage.setItem('doorProfiles', JSON.stringify(profiles));
    }
    
    // Restore all default profiles
    function restoreDefaultProfiles() {
        profiles = [...DEFAULT_PROFILES];
        saveProfilesToStorage(); // Save to localStorage
        
        // Try Firebase sync but don't fail if unavailable
        try {
            if (window.firebaseReady && window.currentUser) {
                syncProfilesToFirebase();
            } else {
                console.log('‚ÑπÔ∏è Firebase not ready, skipping profile sync');
            }
        } catch(e) {
            console.warn('‚ö†Ô∏è Firebase sync failed (non-critical):', e);
        }
        
        // Update UI
        try {
            renderPricingMatrix();
            checkForNewUnallocatedDoors();
            renderDB(); // Refresh admin display
        } catch(e) {
            console.warn('‚ö†Ô∏è UI update failed:', e);
        }
        
        notify('‚úì Door profiles restored to 20 defaults');
    }
    
    // ===== PAINT FORMULA DATABASE =====
    let paintDatabase = (function() {
        const saved = localStorage.getItem('paintFormulas');
        if (saved) {
            try {
                let loaded = JSON.parse(saved);
                if (Array.isArray(loaded) && loaded.length > 0) {
                    
                    // Migrate/fix old formulas that are missing new fields
                    loaded = loaded.map((f, idx) => {
                        const updated = { ...f };
                        let migrated = false;
                        
                        // Add missing evicCode
                        if (!updated.evicCode && updated.code) {
                            updated.evicCode = updated.code;
                            migrated = true;
                        }
                        
                        // Add missing baseType
                        if (!updated.baseType && updated.product) {
                            updated.baseType = updated.product;
                            migrated = true;
                        }
                        
                        // Add missing baseColor
                        if (!updated.baseColor) {
                            updated.baseColor = 'White';
                            migrated = true;
                        }
                        
                        // Fix whiteBase - ensure it has grams not amount
                        if (updated.baseTinters && !updated.whiteBase) {
                            updated.whiteBase = updated.baseTinters.map(item => ({
                                code: item.code,
                                grams: item.grams || item.amount || 0
                            }));
                            migrated = true;
                        }
                        
                        // Fix/calculate totalWeight if missing or wrong
                        if (!updated.totalWeight) {
                            let calculated = 0;
                            if (updated.whiteBase && Array.isArray(updated.whiteBase)) {
                                updated.whiteBase.forEach(item => {
                                    calculated += (item.grams || 0);
                                });
                            }
                            if (updated.colourants && Array.isArray(updated.colourants)) {
                                updated.colourants.forEach(item => {
                                    calculated += (item.amount || 0);
                                });
                            }
                            if (calculated > 0) {
                                updated.totalWeight = calculated;
                                migrated = true;
                            }
                        }
                        
                        if (migrated) {
                        }
                        
                        const tinterCount = (updated.colourants || []).length;
                        
                        return updated;
                    });
                    
                    // Save the migrated formulas back to localStorage
                    localStorage.setItem('paintFormulas', JSON.stringify(loaded));
                    return loaded;
                }
            } catch(e) {
                console.error('Error loading paint formulas:', e);
            }
        }
        
        // Default example formula
        const defaults = [
            {
                id: 'lexicon-690-30',
                brand: 'Evic',
                color: 'Lexicon',
                product: '690 30% XTint Poly',
                code: 'XTSW1E3',
                evicCode: 'XTSW1E3',
                baseType: '690 30% XTint Poly',
                baseColor: 'White',
                version: 'SW1E3 DULUX WOC Series II (2018)',
                finishes: ['Satin', 'Gloss', 'Matt'],
                baseSize: 1,
                baseTinters: [
                    { code: 'ITE003', grams: 7.47 },
                    { code: 'XB6930', grams: 1359.04 }
                ],
                whiteBase: [
                    { code: 'ITE003', grams: 7.47 },
                    { code: 'XB6930', grams: 1359.04 }
                ],
                colourants: [
                    { code: 'ITE303', amount: 5.88 },
                    { code: 'ITE306', amount: 5.95 },
                    { code: 'ITE310', amount: 5.75 }
                ],
                totalWeight: 1384.09,
                notes: '3 tinters'
            }
        ];
        
        defaults.forEach((f, idx) => {
            const tinterCount = (f.colourants || []).length;
        });
        localStorage.setItem('paintFormulas', JSON.stringify(defaults));
        return defaults;
    })();

    function savePaintFormulas() {
        console.log('üíæ SAVING FORMULAS TO LOCALSTORAGE & FIREBASE:');
        console.log('  Database has', paintDatabase.length, 'formulas');
        paintDatabase.forEach((f, idx) => {
        });
        
        // Save to localStorage (local backup)
        localStorage.setItem('paintFormulas', JSON.stringify(paintDatabase));
        console.log(`  ‚úì Saved to localStorage`);
        
        // Save to Firebase for cloud sync (if user is authenticated)
        try {
            if (typeof firebase !== 'undefined' && firebase.auth && typeof firebase.auth === 'function') {
                const currentUser = firebase.auth().currentUser;
                if (currentUser) {
                    const userId = currentUser.uid;
                    const dbRef = firebase.database().ref(`users/${userId}/paintFormulas`);
                    dbRef.set(paintDatabase, (error) => {
                        if (error) {
                            console.warn('‚ö†Ô∏è Firebase save failed:', error);
                        } else {
                            console.log('  ‚úì Synced to Firebase for all devices');
                        }
                    });
                }
            }
        } catch(e) {
            console.warn('‚ö†Ô∏è Firebase sync unavailable:', e.message);
        }
    }

    // Load paint formulas from Firebase on auth
    function loadPaintFormulasFromFirebase() {
        try {
            if (typeof firebase === 'undefined' || !firebase.auth || typeof firebase.auth !== 'function') {
                console.log('‚ÑπÔ∏è Firebase not ready - using localStorage');
                return;
            }
            
            const currentUser = firebase.auth().currentUser;
            if (!currentUser) {
                console.log('‚ÑπÔ∏è User not authenticated - using localStorage');
                return;
            }
            
            const userId = currentUser.uid;
            const dbRef = firebase.database().ref(`users/${userId}/paintFormulas`);
            
            dbRef.get().then((snapshot) => {
                if (snapshot.exists() && snapshot.val()) {
                    const firebaseFormulas = snapshot.val();
                    if (Array.isArray(firebaseFormulas) && firebaseFormulas.length > 0) {
                        paintDatabase = firebaseFormulas;
                        localStorage.setItem('paintFormulas', JSON.stringify(firebaseFormulas));
                        console.log('‚òÅÔ∏è Loaded', firebaseFormulas.length, 'formulas from Firebase');
                        renderPaintFormulaList();
                        return;
                    }
                }
                console.log('‚ÑπÔ∏è No formulas in Firebase, using localStorage');
            }).catch(error => {
                console.warn('‚ö†Ô∏è Firebase load failed:', error);
            });
        } catch(e) {
            console.warn('‚ö†Ô∏è Firebase not available:', e.message);
        }
    }
    
    // Load formulas from Firebase when user authenticates
    setTimeout(() => {
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    loadPaintFormulasFromFirebase();
                }
            });
        }
    }, 500);

    function getPaintFormula(colorName) {
        const formula = paintDatabase.find(f => 
            f.color.toLowerCase() === colorName.toLowerCase()
        );
        return formula || null;
    }

    function addOrUpdateFormula(formulaData) {
        const index = paintDatabase.findIndex(f => f.id === formulaData.id);
        if (index >= 0) {
            paintDatabase[index] = formulaData;
        } else {
            formulaData.id = 'formula-' + Date.now();
            paintDatabase.push(formulaData);
        }
        savePaintFormulas();
    }

    // ===== PAINT FORMULA UI FUNCTIONS =====
    let selectedFormula = null;

    function openPaintFormulaSearch() {
        const colorInput = document.getElementById('p-color').value.trim();
        
        if (!colorInput) {
            // Show all formulas if input is empty
            displayFormulaOptions(paintDatabase);
        } else {
            // Filter formulas by color name
            const matching = paintDatabase.filter(f =>
                f.color.toLowerCase().includes(colorInput.toLowerCase())
            );
            displayFormulaOptions(matching);
        }
    }

    function displayFormulaOptions(formulas) {
        if (formulas.length === 0) {
            notify('No matching formulas found');
            return;
        }
        
        // Show modal with first matching formula
        selectedFormula = formulas[0];
        displayPaintFormulaModal();
    }

    function displayPaintFormulaModal() {
        if (!selectedFormula) return;
        
        const modal = document.getElementById('paintFormulaModal');
        if (!modal) {
            console.error('Paint formula modal element not found!');
            return;
        }
        
        document.getElementById('formulaColor').textContent = selectedFormula.color;
        document.getElementById('formulaCode').textContent = selectedFormula.code;
        
        document.getElementById('mixLitres').value = '1';
        updateFormulaScaling();
        
        // Show as flex for proper centering
        modal.style.display = 'flex';
        console.log('‚úì Paint formula modal displayed');
    }

    function updateFormulaScaling() {
        if (!selectedFormula) return;
        
        const litres = parseFloat(document.getElementById('mixLitres').value) || 1;
        const scaleFactor = litres / selectedFormula.baseSize;
        
        let html = `<div style="font-size:12px; font-weight:900; margin-bottom:10px;">Scaled for ${litres}L:</div>`;
        
        html += '<div style="margin-bottom:10px;"><strong>Base Tinters:</strong></div>';
        selectedFormula.baseTinters.forEach(t => {
            const scaledAmount = (t.amount * scaleFactor).toFixed(2);
            html += `<div style="display:flex; justify-content:space-between; font-size:11px; margin:4px 0;">
                <span>${t.code}</span>
                <span style="color:#d4af37; font-weight:900;">${scaledAmount}g</span>
            </div>`;
        });
        
        html += '<div style="margin-top:10px; margin-bottom:10px;"><strong>Colourants:</strong></div>';
        selectedFormula.colourants.forEach(c => {
            const scaledAmount = (c.amount * scaleFactor).toFixed(2);
            html += `<div style="display:flex; justify-content:space-between; font-size:11px; margin:4px 0;">
                <span>${c.code}</span>
                <span style="color:#d4af37; font-weight:900;">${scaledAmount}g</span>
            </div>`;
        });
        
        document.getElementById('scaledFormula').innerHTML = html;
    }

    function savePaintFormulaToJob() {
        if (!selectedFormula) return;
        
        const litres = parseFloat(document.getElementById('mixLitres').value) || 1;
        
        // Populate form fields
        document.getElementById('p-color').value = selectedFormula.color;
        document.getElementById('p-code').value = `${selectedFormula.code} - ${selectedFormula.color} (${selectedFormula.product})`;
        
        // Note: Brand is NOT updated from formula - user can select their own brand
        // This allows using Wattyl, Dulux, or other brands with the same color
        
        // Save to job data
        const jobData = {
            paintFormula: selectedFormula,
            mixLitres: litres,
            savedAt: new Date().toLocaleString('en-AU')
        };
        
        // Store formula in current job
        if (window.currentJobData) {
            window.currentJobData.paintFormula = jobData;
        }
        
        // Also add to used formulas (optional, for history)
        if (!localStorage.getItem('usedFormulas')) {
            localStorage.setItem('usedFormulas', JSON.stringify([]));
        }
        const used = JSON.parse(localStorage.getItem('usedFormulas')) || [];
        if (!used.find(f => f.id === selectedFormula.id)) {
            used.push(selectedFormula);
            localStorage.setItem('usedFormulas', JSON.stringify(used));
        }
        
        closePaintFormulaModal();
        notify(`‚úì Formula saved: ${selectedFormula.color} (${litres}L)`);
        saveData(); // Save current job
    }

    function closePaintFormulaModal() {
        document.getElementById('paintFormulaModal').style.display = 'none';
        selectedFormula = null;
    }

    // ===== PAINT FORMULA DATABASE MANAGEMENT =====
    function renderPaintFormulaList(formulasToDisplay = null) {
        const list = document.getElementById('paintFormulaList');
        const countSpan = document.getElementById('formulaCount');
        
        if (!list) return;
        
        // Use provided array or default to paintDatabase
        const displayFormulas = formulasToDisplay || paintDatabase;
        
        // Update the count
        if (countSpan) {
            countSpan.innerText = displayFormulas.length;
        }
        
        if (displayFormulas.length === 0) {
            list.innerHTML = '<div style="padding:15px; text-align:center; color:#999; font-size:11px;">No formulas found.</div>';
            return;
        }
        
        let html = '';
        for (let i = 0; i < displayFormulas.length; i++) {
            const f = displayFormulas[i];
            // Find the actual index in paintDatabase for the edit/delete buttons
            const actualIndex = paintDatabase.findIndex(formula => formula.id === f.id);
            
            const baseTintCount = (f.baseTinters || []).length;
            const colCount = (f.colourants || []).length;
            
            // Build formula header: BRAND / COLOUR / FINISH
            const formulaHeader = `${f.brand || 'Brand'} / ${f.color} / ${f.finish || 'Satin'}`;
            
            html += '<div style="padding:12px; border-bottom:1px solid #eee;">';
            html += '<div style="font-weight:900; font-size:11px; margin-bottom:2px; color:#666;">üìã ' + formulaHeader + '</div>';
            html += '<div style="font-size:10px; color:#2196f3; margin-bottom:6px; font-weight:bold;">-' + (f.product || 'Product') + '</div>';
            html += '<div style="font-size:10px; color:#666; margin-bottom:6px;">Code: ' + (f.code || '---') + '</div>';
            html += '<div style="font-size:9px; color:#999; margin-bottom:8px;">' + baseTintCount + ' base codes ‚Ä¢ ' + colCount + ' colourants</div>';
            html += '<div style="display:flex; gap:6px;">';
            html += '<button onclick="editPaintFormula(' + actualIndex + ')" style="padding:4px 10px; background:#2196f3; color:#fff; border:none; border-radius:3px; font-size:9px; font-weight:900; cursor:pointer;">Edit</button>';
            html += '<button onclick="deletePaintFormula(' + actualIndex + ')" style="padding:4px 10px; background:#ff3b30; color:#fff; border:none; border-radius:3px; font-size:9px; font-weight:900; cursor:pointer;">Delete</button>';
            html += '</div></div>';
        }
        
        list.innerHTML = html;
    }


    function addNewPaintFormulaUI() {
        const brand = document.getElementById('newPaintBrand').value.trim();
        const color = document.getElementById('newPaintColor').value.trim();
        const code = document.getElementById('newPaintCode').value.trim();
        const finish = document.getElementById('newPaintFinish').value.trim() || 'Satin';
        const product = document.getElementById('newPaintProduct').value.trim();
        const version = document.getElementById('newPaintVersion').value.trim();
        const baseColor = document.getElementById('baseColor').value.trim();
        
        // Collect all base codes (1-3)
        const baseCodes = [];
        for (let i = 1; i <= 3; i++) {
            const codeInput = document.getElementById(`baseCode${i}`).value.trim();
            const amountInput = parseFloat(document.getElementById(`baseAmount${i}`).value) || 0;
            
            if (codeInput && amountInput > 0) {
                baseCodes.push({ code: codeInput, grams: amountInput });
            }
        }
        
        const tintersList = document.getElementById('tintersList').value.trim();
        
        // Validation
        if (!brand || brand === '') {
            notify('‚ùå Please select a Paint Brand');
            return;
        }
        if (!color || !code) {
            notify('‚ùå Please enter Colour and Code');
            return;
        }
        if (baseCodes.length === 0) {
            notify('‚ùå Please enter at least one Base Code with amount');
            return;
        }
        
        // Parse tinters (format: CODE @ GRAMS, one per line)
        const colourants = [];
        console.log('üìù TINTERS INPUT TEXT:\n' + tintersList);
        console.log('  Length of tintersList:', tintersList.length);
        
        if (tintersList && tintersList.trim().length > 0) {
            const lines = tintersList.split('\n');
            console.log('  Split into', lines.length, 'lines');
            
            lines.forEach((line, idx) => {
                const trimmed = line.trim();
                
                const match = trimmed.match(/^(\S+)\s+([\d,.]+)$/);  // Simple: CODE GRAMS (space-separated)
                console.log(`      Regex match:`, match ? 'SUCCESS' : 'FAILED');
                
                if (match) {
                    const amount = parseFloat(match[2].replace(',', '.'));  // Handle both , and . decimals
                    colourants.push({
                        code: match[1],
                        amount: amount
                    });
                } else {
                    console.log(`      ‚Üí NO MATCH (expected format: CODE GRAMS - just a space between)`);
                }
            });
        } else {
            console.log('  ‚ö†Ô∏è tintersList is empty or whitespace only');
        }
        
        console.log('‚úÖ FINAL: Captured', colourants.length, 'tinters:', colourants);
        
        // Calculate total weight from base codes + tinters (MOVED BEFORE LOGS)
        let totalWeight = 0;
        baseCodes.forEach(item => {
            totalWeight += (item.grams || 0);
        });
        colourants.forEach(item => {
            totalWeight += (item.amount || 0);
        });
        
        console.log('üìä TOTAL WEIGHT CALCULATION:');
        console.log('  Base codes total:', baseCodes.reduce((sum, b) => sum + (b.grams || 0), 0).toFixed(2) + 'g');
        console.log('  Tinters total:', colourants.reduce((sum, c) => sum + (c.amount || 0), 0).toFixed(2) + 'g');
        console.log('  Grand total:', totalWeight.toFixed(2) + 'g');
        
        // Create new formula with structured format INCLUDING BRAND & FINISH
        const newFormula = {
            id: 'formula-' + Date.now(),
            brand: brand,  // Use selected brand
            color: color,
            finish: finish,  // Use selected finish
            product: product || 'Custom Product',
            code: code,
            evicCode: code,  // Store the Evic code
            baseType: product || 'Custom',  // Base paint type
            baseColor: baseColor || 'White',  // NEW: Base paint color
            version: version || '',  // Version from user input
            finishes: [finish],  // Store finish in array
            baseSize: 1,
            baseTinters: baseCodes,
            whiteBase: baseCodes,  // WHITE BASE as array (now can have 1-3 items)
            colourants: colourants,
            totalWeight: totalWeight > 0 ? totalWeight : null,  // Auto-calculated
            notes: `${colourants.length} tinters`
        };
        
        paintDatabase.push(newFormula);
        console.log('‚úÖ FORMULA ADDED TO DATABASE:');
        console.log('  ID:', newFormula.id);
        console.log('  Colourants in formula:', newFormula.colourants);
        console.log('  Total formulas in DB:', paintDatabase.length);
        console.log('  Formula object:', newFormula);
        
        savePaintFormulas();
        
        // Clear form
        document.getElementById('newPaintBrand').value = '';
        document.getElementById('newPaintColor').value = '';
        document.getElementById('newPaintCode').value = '';
        document.getElementById('newPaintFinish').value = 'Satin';
        document.getElementById('newPaintProduct').value = '';
        document.getElementById('newPaintVersion').value = '';
        document.getElementById('baseColor').value = '';
        document.getElementById('baseCode1').value = '';
        document.getElementById('baseAmount1').value = '';
        document.getElementById('baseCode2').value = '';
        document.getElementById('baseAmount2').value = '';
        document.getElementById('baseCode3').value = '';
        document.getElementById('baseAmount3').value = '';
        document.getElementById('tintersList').value = '';
        
        renderPaintFormulaList();
        notify(`‚úì Formula added: ${brand} / ${color} / ${finish}`);
    }

    function editPaintFormula(idx) {
        const f = paintDatabase[idx];
        if (!f) {
            console.error('üî¥ EDIT ERROR: No formula at index', idx);
            console.log('  paintDatabase.length:', paintDatabase.length);
            return;
        }
        
        console.log('üîç EDITING FORMULA AT INDEX:', idx);
        console.log('  colourants array exists:', !!f.colourants);
        console.log('  colourants is array:', Array.isArray(f.colourants));
        console.log('  colourants length:', f.colourants ? f.colourants.length : 'null/undefined');
        
        if (f.colourants && f.colourants.length > 0) {
            console.log('  Tinters:');
            f.colourants.forEach((c, i) => {
            });
        } else {
            console.log('  ‚ö†Ô∏è NO TINTERS FOUND IN FORMULA');
        }
        
        // Build HTML for edit dialog
        let html = `
        <div style="font-size:12px; max-width:600px; max-height:600px; overflow-y:auto;">
            <div style="margin-bottom:12px;">
                <label style="font-weight:bold; display:block; margin-bottom:4px;">Paint Brand:</label>
                <select id="editBrand" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; font-weight:bold;">
                    <option value="">Select Brand</option>
                    <option value="Dulux">Dulux</option>
                    <option value="Wattyl">Wattyl</option>
                    <option value="Taubmans">Taubmans</option>
                    <option value="Haymes">Haymes</option>
                    <option value="British Paints">British Paints</option>
                    <option value="Evic">Evic</option>
                    <option value="Custom">Custom</option>
                </select>
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="font-weight:bold; display:block; margin-bottom:4px;">Color Name:</label>
                <input type="text" id="editColorName" value="${f.color || ''}" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="font-weight:bold; display:block; margin-bottom:4px;">Gloss Level:</label>
                <select id="editFinish" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; font-weight:bold;">
                    <option value="Satin">Satin</option>
                    <option value="Matt">Matt</option>
                    <option value="Semi Gloss">Semi Gloss</option>
                    <option value="Gloss">Gloss</option>
                </select>
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="font-weight:bold; display:block; margin-bottom:4px;">Evic Code:</label>
                <input type="text" id="editEvicCode" value="${f.evicCode || ''}" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="font-weight:bold; display:block; margin-bottom:4px;">Base Type:</label>
                <input type="text" id="editBaseType" value="${f.baseType || ''}" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="font-weight:bold; display:block; margin-bottom:4px;">Base Color:</label>
                <input type="text" id="editBaseColor" value="${f.baseColor || ''}" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;" placeholder="e.g., White, Clear, Green">
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="font-weight:bold; display:block; margin-bottom:4px;">Version:</label>
                <input type="text" id="editVersion" value="${f.version || ''}" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="font-weight:bold; display:block; margin-bottom:4px;">White Base Items (Format: CODE: GRAMS per line):</label>
                <p style="font-size:10px; color:#666; margin:0 0 6px 0;">Example:<br>ITE003: 7.47<br>XB6930: 1359.04</p>
                <textarea id="editWhiteBase" style="width:100%; height:80px; padding:6px; border:1px solid #ccc; border-radius:4px; font-family:monospace; font-size:11px; box-sizing:border-box;"></textarea>
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="font-weight:bold; display:block; margin-bottom:4px;">Tinters (Format: CODE GRAMS per line):</label>
                <p style="font-size:10px; color:#666; margin:0 0 6px 0;">Example:<br>ITE303 5.88<br>ITE306 5.95</p>
                <textarea id="editColourants" style="width:100%; height:80px; padding:6px; border:1px solid #ccc; border-radius:4px; font-family:monospace; font-size:11px; box-sizing:border-box;"></textarea>
            </div>
            
            <div style="margin-bottom:12px;">
                <label style="font-weight:bold; display:block; margin-bottom:4px;">Total Weight (grams):</label>
                <input type="text" id="editTotalWeight" value="${f.totalWeight || ''}" style="width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box;">
            </div>
        </div>
        `;
        
        // Show custom dialog with unique ID
        const dialog = document.createElement('div');
        dialog.id = 'paintFormulaEditDialog';
        dialog.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:10000;';
        dialog.innerHTML = `
            <div style="background:white; padding:20px; border-radius:8px; width:90%; max-width:600px; max-height:90vh; overflow-y:auto;">
                <h3 style="margin-top:0; color:#333;">Edit Formula: ${f.color}</h3>
                ${html}
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button onclick="closeFormulaDialog()" style="flex:1; padding:10px; background:#ccc; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Cancel</button>
                    <button onclick="saveFormulaEdit(${idx})" style="flex:1; padding:10px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Save</button>
                </div>
            </div>
        `;
        document.body.appendChild(dialog);
        
        // Use longer timeout and better DOM targeting to populate form fields
        setTimeout(() => {
            console.log('üîß ATTEMPTING TO POPULATE FORM FIELDS (500ms timeout)');
            
            const dialog = document.getElementById('paintFormulaEditDialog');
            if (!dialog) {
                console.error('  ‚ùå Dialog not found!');
                return;
            }
            
            // Set brand dropdown (with default fallback)
            const brandSelect = dialog.querySelector('#editBrand');
            if (brandSelect) {
                brandSelect.value = f.brand || 'Dulux';  // Default to Dulux if not set
                console.log('  ‚úì Set brand to:', f.brand || 'Dulux');
            }
            
            // Set finish dropdown (with default fallback)
            const finishSelect = dialog.querySelector('#editFinish');
            if (finishSelect) {
                finishSelect.value = f.finish || 'Satin';  // Default to Satin if not set
                console.log('  ‚úì Set finish to:', f.finish || 'Satin');
            }
            
            // Build the text content
            const whiteBaseText = (f.whiteBase && Array.isArray(f.whiteBase)) ? 
                f.whiteBase.map(item => `${item.code}: ${item.grams}`).join('\n') : '';
            const colourantsText = (f.colourants && Array.isArray(f.colourants)) ? 
                f.colourants.map(c => `${c.code} ${c.amount || c.grams}`).join('\n') : '';  // Space-separated
            
            console.log('  colourants array:', f.colourants);
            console.log('  colourantsText result:', JSON.stringify(colourantsText));
            
            const whiteBaseTA = dialog.querySelector('#editWhiteBase');
            const colourantsTA = dialog.querySelector('#editColourants');
            
            console.log('  Found whiteBaseTA:', !!whiteBaseTA);
            console.log('  Found colourantsTA:', !!colourantsTA);
            
            if (whiteBaseTA && whiteBaseText) {
                whiteBaseTA.value = whiteBaseText;
                console.log('  ‚úì Set whiteBase, value is now:', JSON.stringify(whiteBaseTA.value.substring(0, 50)));
            }
            
            if (colourantsTA && colourantsText) {
                colourantsTA.value = colourantsText;
                console.log('  ‚úì Set colourants, value is now:', JSON.stringify(colourantsTA.value.substring(0, 50)));
            } else if (colourantsTA) {
                console.log('  ‚ö†Ô∏è  colourantsTA found but colourantsText is empty!');
            }
        }, 500);  // Longer timeout for safety
    }
    
    function closeFormulaDialog() {
        const dialog = document.getElementById('paintFormulaEditDialog');
        if (dialog) {
            dialog.remove();
        }
    }
    
    function saveFormulaEdit(idx) {
        const f = paintDatabase[idx];
        if (!f) return;
        
        // Get values from dialog
        f.brand = document.getElementById('editBrand').value;
        f.color = document.getElementById('editColorName').value;
        f.finish = document.getElementById('editFinish').value;
        f.evicCode = document.getElementById('editEvicCode').value;
        f.baseType = document.getElementById('editBaseType').value;
        f.baseColor = document.getElementById('editBaseColor').value || 'White';  // Default to White
        f.version = document.getElementById('editVersion').value;
        // totalWeight will be parsed below
        
        // Helper to parse numbers with comma or period as decimal (ROBUST - with global replace)
        const parseNumber = (str) => {
            if (!str) return 0;
            let s = String(str).trim().replace(/\s/g, '');
            
            // If both comma and period exist, determine which is decimal
            if (s.includes(',') && s.includes('.')) {
                const lastCommaIdx = s.lastIndexOf(',');
                const lastPeriodIdx = s.lastIndexOf('.');
                if (lastCommaIdx > lastPeriodIdx) {
                    // Comma is decimal: "1.234,56" ‚Üí "1234,56" ‚Üí "1234.56"
                    return parseFloat(s.replace(/\./g, '').replace(',', '.'));
                } else {
                    // Period is decimal: "1,234.56" ‚Üí "1234.56"
                    return parseFloat(s.replace(/,/g, ''));  // GLOBAL flag to remove ALL commas
                }
            } else if (s.includes(',')) {
                // Only comma - treat as decimal (e.g., European "5,88")
                return parseFloat(s.replace(',', '.'));
            } else {
                // Only period or no separator
                return parseFloat(s);
            }
        };
        
        // Parse white base (accept both "CODE: GRAMS" and "CODE GRAMS" formats)
        const whiteBaseText = document.getElementById('editWhiteBase').value.trim();
        f.whiteBase = [];
        if (whiteBaseText) {
            console.log('üìù WHITE BASE TEXT:\n' + whiteBaseText);
            whiteBaseText.split('\n').forEach((line, idx) => {
                const match = line.match(/^(\S+)\s+[\s:]*\s*([\d,.]+)/);  // Accept both space and colon
                if (match) {
                    const grams = parseNumber(match[2]);
                    f.whiteBase.push({ code: match[1], grams: grams });  // Store as number
                }
            });
        }
        
        // Parse colourants (tinters)
        const colourantsText = document.getElementById('editColourants').value.trim();
        f.colourants = [];
        if (colourantsText) {
            console.log('üìù TINTERS TEXT:\n' + colourantsText);
            colourantsText.split('\n').forEach((line, idx) => {
                // Accept both: "CODE GRAMS" (space) or "CODE: GRAMS" (colon)
                const match = line.match(/^(\S+)\s+[\s:]*\s*([\d,.]+)/);
                if (match) {
                    const amount = parseNumber(match[2]);
                    f.colourants.push({ code: match[1], amount: amount });  // Store as number
                }
            });
        }
        
        // Parse and store total weight as number
        const totalWeightStr = document.getElementById('editTotalWeight').value.trim();
        
        // If total weight is empty, auto-calculate from white base + tinters
        if (!totalWeightStr) {
            let calculated = 0;
            if (f.whiteBase && Array.isArray(f.whiteBase)) {
                f.whiteBase.forEach(item => {
                    calculated += (item.grams || 0);
                });
            }
            if (f.colourants && Array.isArray(f.colourants)) {
                f.colourants.forEach(item => {
                    calculated += (item.amount || 0);
                });
            }
            f.totalWeight = calculated > 0 ? calculated : null;
        } else {
            f.totalWeight = parseNumber(totalWeightStr);
        }
        
        // Close dialog
        closeFormulaDialog();
        
        savePaintFormulas();
        renderPaintFormulaList();
        notify(`‚úì Formula updated: ${f.color}`);
    }

    function deletePaintFormula(idx) {
        const f = paintDatabase[idx];
        if (!f) return;
        
        if (confirm(`Delete formula "${f.color}"?`)) {
            paintDatabase.splice(idx, 1);
            savePaintFormulas();
            renderPaintFormulaList();
            notify(`‚úì Formula deleted: ${f.color}`);
        }
    }
    
    // Clear stale Firebase profile data and force fresh sync
    function clearFirebaseProfilesData() {
        if (!confirm('üö® CLEAR FIREBASE DATA:\n- Removes old Firebase profile data\n- Keeps your current door assignments\n- Syncs fresh to Firebase\n\nProceed?')) {
            return;
        }
        
        if (!window.firebaseReady || !window.currentUser) {
            alert('Firebase not ready. Please try again.');
            return;
        }
        
        try {
            console.log('üóëÔ∏è Clearing stale Firebase data...');
            
            // 1. Delete the old Firebase documents to remove stale data
            const configDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'config', 'doorProfiles');
            window.deleteDoc(configDoc).then(() => {
                console.log('‚úì Deleted old Firebase doorProfiles document');
            }).catch(err => {
                console.error('Note: Could not delete Firebase doc (may already be gone):', err);
            });
            
            // 2. Force immediate re-sync of CURRENT profiles and masterMatrix (not defaults!)
            setTimeout(() => {
                syncProfilesToFirebase();
                renderPricingMatrix();
                notify('‚úÖ Firebase cleared and current data re-synced!');
                console.log('‚úÖ Firebase sync complete');
            }, 500);
        } catch (error) {
            console.error('Error clearing Firebase:', error);
            alert('Error clearing Firebase. Check console.');
        }
    }
    
    // EXTREME: Clear ALL browser localStorage and reload
    function clearAllLocalStorage() {
        if (!confirm('‚ò¢Ô∏è EXTREME ACTION:\n\nThis will DELETE ALL browser storage:\n- All jobs\n- All profiles\n- All settings\n- Everything\n\nYou will need to hard refresh after.\n\nAre you 100% sure?')) {
            return;
        }
        
        try {
            console.log('‚ò¢Ô∏è CLEARING ALL LOCALSTORAGE...');
            localStorage.clear();
            console.log('‚úì All localStorage cleared');
            
            // Also try to clear sessionStorage
            sessionStorage.clear();
            console.log('‚úì sessionStorage cleared');
            
            notify('‚ò¢Ô∏è All storage cleared - Hard refreshing page...');
            
            // Force hard refresh
            setTimeout(() => {
                window.location.reload(true);
            }, 500);
        } catch (error) {
            console.error('Error clearing storage:', error);
            alert('Error during clear. Try manually clearing browser cache and refreshing.');
        }
    }
    
    // Diagnostic: Show what's actually in localStorage
    function diagnoseStorage() {
        console.log('=== PAINTWORKZ STORAGE DIAGNOSTIC ===');
        console.log('');
        
        // Check doorProfiles
        const doorProfilesStr = localStorage.getItem('doorProfiles');
        console.log('üìÅ doorProfiles in localStorage:');
        if (doorProfilesStr) {
            try {
                const parsed = JSON.parse(doorProfilesStr);
                console.log('‚úì Valid JSON, ' + parsed.length + ' items:');
            } catch(e) {
                console.error('‚úó CORRUPTED JSON:', e);
                console.log('Raw value:', doorProfilesStr);
            }
        } else {
            console.log('‚úó Empty (null)');
        }
        
        console.log('');
        console.log('üîß Current profiles array in memory: ' + profiles.length + ' items');
        
        console.log('');
        console.log('üìä masterMatrix tiers:');
        Object.keys(masterMatrix).forEach(tierName => {
            const count = Object.keys(masterMatrix[tierName]).length;
        });
        
        console.log('');
        const unallocated = getUnallocatedDoors();
        console.log('‚ö†Ô∏è Unallocated doors: ' + unallocated.length);
        
        console.log('');
        console.log('‚úÖ DIAGNOSTIC COMPLETE - Check console above for details');
        
        alert(`DIAGNOSTIC INFO (Check F12 Console):\n\n` +
              `doorProfiles in storage: ${doorProfilesStr ? 'YES (' + JSON.parse(doorProfilesStr).length + ' items)' : 'NO (null)'}\n` +
              `Current profiles in memory: ${profiles.length} items\n` +
              `Master matrix tiers: ${Object.keys(masterMatrix).length}\n` +
              `Unallocated doors: ${unallocated.length}\n\n` +
              `All details in console (F12)`);
    }
    
    // Check for new unallocated doors and show notification
    function checkForNewUnallocatedDoors() {
        // Removed - globalNotifications section no longer exists
    }

    window.onload = () => { 
        // Show copyright as popup notification (auto-dismiss after 4 seconds)
        notify('‚öñÔ∏è PaintWorkz Pro ¬© 2026 Colin Bedford | Unauthorized use prohibited', 4000);
        
        console.log('%cüõ°Ô∏è SECURITY: This application is protected intellectual property', 'background:#ff4444;color:#fff;font-weight:900;padding:8px;');
        console.log('%cOwner: Colin Bedford | All rights reserved ¬© 2026', 'color:#ff4444;font-weight:bold;');
        
        refreshLists();
        // loadData();  // DISABLED - don't auto-load old jobs on startup; users must explicitly load from History
        renderHistory();
        renderPaintFormulaList();  // Render paint formula list on load
        loadHeaderLogo(); // Load and display header logo from localStorage
        // Ensure prof-select is populated after a slight delay for safety
        setTimeout(() => {
            const profSel = document.getElementById('prof-select');
            if (profSel && profSel.options.length === 0) {
                console.log('‚ö†Ô∏è prof-select empty after load, repopulating...');
                refreshLists();
            }
        }, 100);
        // renderScheduleCalendar(); // Don't render until Schedule tab is clicked
    };

    // LOCAL STORAGE
    function saveData() {
        const jobData = {
            items: items,
            client: document.getElementById('cli').value,
            dateReceived: document.getElementById('dRec').value,
            jobName: document.getElementById('jNm').value,
            jobNum: document.getElementById('jN').value,
            brand: document.getElementById('p-brand').value,
            color: document.getElementById('p-color').value,
            code: document.getElementById('p-code').value,
            finish: document.getElementById('p-finish').value,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('currentJob', JSON.stringify(jobData));
    }

    // Populate client dropdown with unique clients from history
    function populateClientDropdown() {
        try {
            const clientSelect = document.getElementById('cli');
            if (!clientSelect) {
                console.warn('Client dropdown element not found');
                return;
            }
            
            // Build list of clients with proper deduplication
            const seen = new Set();
            const allClients = [];
            
            // 1. Get free from Google AI Studio ‚Üí client database (authoritative source)
            const db = getClientDatabase();
            Object.values(db).forEach(client => {
                if (client.name && !seen.has(client.name.toLowerCase())) {
                    allClients.push(client.name);
                    seen.add(client.name.toLowerCase());
                }
            });
            
            // 2. Get free from Google AI Studio ‚Üí job history (catch any missing clients)
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            history.forEach(job => {
                if (job.client && !seen.has(job.client.toLowerCase())) {
                    allClients.push(job.client);
                    seen.add(job.client.toLowerCase());
                }
            });
            
            // 3. Get free from Google AI Studio ‚Üí hardcoded clients array (legacy support)
            clients.forEach(client => {
                if (client && !seen.has(client.toLowerCase())) {
                    allClients.push(client);
                    seen.add(client.toLowerCase());
                }
            });
            
            // Sort alphabetically
            allClients.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            
            // Clear and rebuild dropdown
            clientSelect.innerHTML = '<option value="">-- Select or type client --</option>';
            allClients.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientSelect.appendChild(option);
            });
            
        } catch(e) {
            console.error('Error populating client dropdown:', e);
        }
    }
    
    // Initialize app on page load
    function initializeDefaultClients() {
        const db = getClientDatabase();
        
        // Only populate if database is empty
        if (Object.keys(db).length === 0) {
            const defaultClients = {
                'client-001': { id: 'client-001', name: 'Residential Properties', email: 'contact@residentialprops.com.au', phone: '(03) 8000 1234', address: '123 Main Street, Melbourne VIC 3000', createdDate: new Date().toISOString(), notes: 'Regular residential cabinet refurbishment' },
                'client-002': { id: 'client-002', name: 'Commercial Kitchens & Fit-out', email: 'sales@commkitchens.com.au', phone: '(03) 8001 5678', address: '456 Business Ave, Docklands VIC 3008', createdDate: new Date().toISOString(), notes: 'Commercial kitchen cabinet spraying specialist' },
                'client-003': { id: 'client-003', name: 'Interior Design Studio', email: 'projects@interiordesignco.com.au', phone: '(03) 8002 9012', address: '789 Creative Way, Collingwood VIC 3066', createdDate: new Date().toISOString(), notes: 'High-end residential cabinet refinishing' },
                'client-004': { id: 'client-004', name: 'Hotel & Hospitality Group', email: 'maintenance@hotelgroup.com.au', phone: '(03) 8003 3456', address: '321 Luxury Lane, South Yarra VIC 3141', createdDate: new Date().toISOString(), notes: 'Luxury hotel cabinet maintenance & refurbishment' },
                'client-005': { id: 'client-005', name: 'Builders & Developers', email: 'enquiry@buildersdev.com.au', phone: '(03) 8004 7890', address: '654 Construction St, Footscray VIC 3011', createdDate: new Date().toISOString(), notes: 'New build property kitchen & wardrobe cabinets' }
            };
            
            saveClientDatabase(defaultClients);
            console.log('‚úì Default clients populated to database');
        }
    }
    
    function loadHeaderLogo() {
        const headerLogo = localStorage.getItem('headerLogo');
        const logoImg = document.getElementById('headerLogoImg');
        const logoText = document.getElementById('headerLogoText');
        
        if (headerLogo && logoImg) {
            try {
                logoImg.src = headerLogo;
                logoImg.style.display = 'block';
                if (logoText) logoText.style.display = 'none';
                console.log('‚úì Header logo loaded');
            } catch(e) {
                console.warn('Error loading header logo:', e);
                if (logoText) logoText.style.display = 'block';
                if (logoImg) logoImg.style.display = 'none';
            }
        } else {
            if (logoText) logoText.style.display = 'block';
            if (logoImg) logoImg.style.display = 'none';
        }
    }
    
        function initializeApp() {
        console.log('üöÄ Initializing PaintWorkz...');
        
        // Update version display with current date
        const today = new Date();
        const dateStr = today.toLocaleDateString('en-AU', { day: '2-digit', month: 'long', year: 'numeric' });
        const versionDateEl = document.getElementById('versionDate');
        const currentDateEl = document.getElementById('currentDate');
        if (versionDateEl) versionDateEl.textContent = dateStr;
        if (currentDateEl) currentDateEl.textContent = dateStr;
        
        loadHeaderLogo();  // Load header logo on app init
        
        try {
            // Clear measure sheet on fresh load - INCLUDING PARTS LIST
            items = [];
            mode = 'SS';
            pType = 'Panel';
            fmState = 'Flat';
            currentPanelFilter = 'all';
            currentColorFilter = '';
            
            const cliEl = document.getElementById('cli');
            const dRecEl = document.getElementById('dRec');
            const jNmEl = document.getElementById('jNm');
            const jNEl = document.getElementById('jN');
            const pBrandEl = document.getElementById('p-brand');
            const pColorEl = document.getElementById('p-color');
            const pCodeEl = document.getElementById('p-code');
            const pFinishEl = document.getElementById('p-finish');
            
            // Save brand selection when it changes
            if (pBrandEl) {
                pBrandEl.addEventListener('change', function() {
                    localStorage.setItem('lastPaintBrand', this.value);
                });
            }
            
            if (cliEl) cliEl.value = '';
            if (dRecEl) dRecEl.value = '';
            if (jNmEl) jNmEl.value = '';
            if (jNEl) jNEl.value = '';
            if (pBrandEl) pBrandEl.value = 'Dulux';
            if (pColorEl) pColorEl.value = '';
            if (pCodeEl) pCodeEl.value = '';
            if (pFinishEl) pFinishEl.value = 'Satin';
            
            // Clear the parts list display
            const listEl = document.getElementById('list');
            if (listEl) listEl.innerHTML = '';
            
            const totSqmEl = document.getElementById('tA');
            const totPartsEl = document.getElementById('tQ');
            if (totSqmEl) totSqmEl.innerText = '0.000';
            if (totPartsEl) totPartsEl.innerText = '0';
            
            // Reset job mode flags
            isJobViewMode = false;
            currentEditingJobIndex = null;
            jobDataBeforeLoad = null;
            
            // Initialize default clients if database is empty
            initializeDefaultClients();
            
            // Populate client dropdown
            populateClientDropdown();
            
            // Populate paint brands dropdown
            populatePaintBrandsDropdown();
            
            // Render clients in admin tab
            renderClientsList();
            
            // Update Global Settings UI with current values
            updateGlobalSettingsUI();
            
            // Re-render measure sheet
            if (typeof render === 'function') {
                render();
            }
            
            console.log('‚úì App initialized - measure sheet cleared, clients loaded');
        } catch(e) {
            console.error('Error during app initialization:', e);
            console.warn('App continuing despite initialization error - some elements may not be ready yet');
        }
    }
    
    function loadData() {
        const saved = localStorage.getItem('currentJob');
        if (saved) {
            const jobData = JSON.parse(saved);
            items = jobData.items || [];
            document.getElementById('cli').value = jobData.client || '';
            document.getElementById('dRec').value = jobData.dateReceived || '';
            document.getElementById('jNm').value = jobData.jobName || '';
            document.getElementById('jN').value = jobData.jobNum || '';
            document.getElementById('p-brand').value = jobData.brand || 'Wattyl';
            document.getElementById('p-color').value = jobData.color || '';
            document.getElementById('p-code').value = jobData.code || '';
            document.getElementById('p-finish').value = jobData.finish || 'Satin';
            render();
        }
    }

    // Function to clean up duplicate jobs
    function checkForDuplicates() {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const seen = new Set();
        let hasDuplicates = false;
        
        history.forEach(job => {
            const key = `${job.jobNum}|${job.dateReceived}|${job.client}`;
            if (seen.has(key)) {
                hasDuplicates = true;
            }
            seen.add(key);
        });
        
        const warningEl = document.getElementById('duplicateWarning');
        if (warningEl) {
            warningEl.style.display = hasDuplicates ? 'block' : 'none';
        }
    }
    
    function removeDuplicateJobs() {
        try {
            let history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const originalCount = history.length;
            const seen = new Map();
            let cleaned = [];
            let duplicates = 0;
            
            // BACKUP before removing anything!
            localStorage.setItem('jobHistory_backup_' + Date.now(), JSON.stringify(history));
            
            history.forEach(job => {
                // Skip jobs with missing critical fields
                if (!job.jobNum || !job.dateReceived || !job.client) {
                    duplicates++;
                    console.warn('‚ö†Ô∏è Skipping job with missing fields:', job.jobNum);
                    return;
                }
                
                const key = `${job.jobNum}|${job.dateReceived}|${job.client}`;
                if (!seen.has(key)) {
                    seen.set(key, true);
                    cleaned.push(job);
                } else {
                    duplicates++;
                    console.log('‚ÑπÔ∏è Removing duplicate of:', job.jobNum);
                }
            });
            
            if (duplicates > 0) {
                // WARN user before deleting
                if (!confirm(`‚ö†Ô∏è CONFIRM: Delete ${duplicates} duplicate jobs?\n\nA backup has been saved. You can undo this action.`)) {
                    notify('‚ùå Cancelled - No jobs deleted');
                    return;
                }
                
                localStorage.setItem('jobHistory', JSON.stringify(cleaned));
                renderHistory();
                renderJobTasks();
                renderScheduleCalendar();
                notify(`‚úì Cleaned ${duplicates} duplicate jobs (${originalCount} ‚Üí ${cleaned.length})`);
            } else {
                notify('‚úì No duplicates found');
            }
        } catch(e) {
            console.error('Error removing duplicates:', e);
            notify('‚ö†Ô∏è Error cleaning duplicates');
        }
    }
    
    // Recovery function - restore from backup
    function recoverFromBackup() {
        const backups = [];
        for (let key in localStorage) {
            if (key.startsWith('jobHistory_backup_')) {
                backups.push(key);
            }
        }
        
        if (backups.length === 0) {
            notify('‚ùå No backups found');
            return;
        }
        
        // Get most recent backup
        const latestBackup = backups.sort().pop();
        const backupData = JSON.parse(localStorage.getItem(latestBackup));
        
        if (confirm(`Restore ${backupData.length} jobs from backup?\n\nThis will replace current job list.`)) {
            localStorage.setItem('jobHistory', JSON.stringify(backupData));
            renderHistory();
            renderJobTasks();
            renderScheduleCalendar();
            notify(`‚úì Restored ${backupData.length} jobs from backup!`);
        }
    }
    
    function saveJobToHistory() {
        console.log('üîç SAVING JOB - Items count: ' + items.length);
        console.log('  Items being saved:', items.map(i => ({ desc: i.desc, sqm: i.sqm, qty: i.qty })));
        
        const jobData = {
            items: items,
            client: document.getElementById('cli').value,
            dateReceived: document.getElementById('dRec').value,
            jobName: document.getElementById('jNm').value,
            jobNum: document.getElementById('jN').value,
            brand: document.getElementById('p-brand').value,
            color: document.getElementById('p-color').value,
            code: document.getElementById('p-code').value,
            finish: document.getElementById('p-finish').value,
            totalSqm: document.getElementById('tA')?.innerText || '0.000',
            totalParts: document.getElementById('tQ')?.innerText || '0',
            timestamp: new Date().toISOString(),
            savedDate: new Date().toLocaleString('en-AU'),
            completed: false  // Always false when saving new
        };
        
        
        // Get existing history
        let history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        // Check if we're overwriting an existing job
        if (currentEditingJobIndex !== null) {
            if (confirm(`Overwrite existing job #${jobData.jobNum}?`)) {
                history[currentEditingJobIndex] = jobData;
                currentEditingJobIndex = null; // Reset for next job
                notify('‚úì Job Updated');
                addAdminAlert('JOB_UPDATED', `‚úèÔ∏è JOB UPDATED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
            } else {
                return; // Don't save if user cancels
            }
        } else {
            // Add new job to history - CHECK FOR DUPLICATES FIRST
            const existingIdx = history.findIndex(j => j.jobNum === jobData.jobNum && j.dateReceived === jobData.dateReceived && j.client === jobData.client);
            
            if (existingIdx !== -1) {
                // Job with same number, date, and client already exists - update it instead
                if (confirm(`Job #${jobData.jobNum} already exists. Replace it?`)) {
                    history[existingIdx] = jobData;
                    notify('‚úì Job Updated (duplicate prevented)');
                    addAdminAlert('JOB_UPDATED', `‚úèÔ∏è JOB UPDATED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
                } else {
                    return;
                }
            } else {
                // New unique job
                history.unshift(jobData);
                notify('‚úì Job Saved');
                addAdminAlert('JOB_SAVED', `‚úÖ NEW JOB SAVED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
            }
        }
        
        // Keep only last 50 jobs
        history = history.slice(0, 50);
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        // Send appropriate notification based on what happened
        if (currentEditingJobIndex !== null) {
            addAdminAlert('JOB_UPDATED', `‚úèÔ∏è JOB UPDATED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
        } else if (history.length > 0 && history[0].jobNum === jobData.jobNum) {
            // Check if this was a duplicate update
            const duplicateMatches = history.filter(j => j.jobNum === jobData.jobNum).length;
            if (duplicateMatches > 1) {
                addAdminAlert('JOB_UPDATED', `‚úèÔ∏è JOB UPDATED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
            } else {
                addAdminAlert('JOB_SAVED', `‚úÖ NEW JOB SAVED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
            }
        }
        
        // Sync to Firebase immediately
        if (window.syncJobsToFirebase) {
            try {
                window.syncJobsToFirebase();
                console.log('üîÑ Job saved and synced to Firebase');
            } catch(e) {
                console.error('Firebase sync error on save:', e);
            }
        }
        
        // CLEAR FIRST - before rendering
        console.log('üßπ Starting measure sheet clear...');
        items = [];
        console.log('‚úì Cleared items array');
        
        // Clear all form fields with element existence checks
        try {
            const cliEl = document.getElementById('cli');
            if (cliEl) {
                cliEl.value = '';
                console.log('‚úì Cleared client');
            }
            
            const dRecEl = document.getElementById('dRec');
            if (dRecEl) {
                dRecEl.value = '';
                console.log('‚úì Cleared date received');
            }
            
            const jNmEl = document.getElementById('jNm');
            if (jNmEl) {
                jNmEl.value = '';
                console.log('‚úì Cleared job name');
            }
            
            const jNEl = document.getElementById('jN');
            if (jNEl) {
                jNEl.value = '';
                console.log('‚úì Cleared job number');
            }
            
            const pBrandEl = document.getElementById('p-brand');
            if (pBrandEl) {
                pBrandEl.value = 'Dulux';
                console.log('‚úì Reset paint brand to Dulux');
            }
            
            const pColorEl = document.getElementById('p-color');
            if (pColorEl) {
                pColorEl.value = '';
                console.log('‚úì Cleared paint colour');
            }
            
            const pCodeEl = document.getElementById('p-code');
            if (pCodeEl) {
                pCodeEl.value = '';
                console.log('‚úì Cleared paint code');
            }
            
            const pFinishEl = document.getElementById('p-finish');
            if (pFinishEl) {
                pFinishEl.value = 'Satin';
                console.log('‚úì Reset paint finish to Satin');
            }
            
            // Clear totals
            const totSqmEl = document.getElementById('tA');
            if (totSqmEl) {
                totSqmEl.innerText = '0.000';
                console.log('‚úì Cleared total SQM (m¬≤)');
            }
            
            const totPartsEl = document.getElementById('tQ');
            if (totPartsEl) {
                totPartsEl.innerText = '0';
                console.log('‚úì Cleared total parts');
            }
        } catch(e) {
            console.error('Error clearing form fields:', e);
        }
        
        console.log('‚úì All form fields cleared');
        
        // Clear the items list from localStorage too
        localStorage.removeItem('currentJob');
        console.log('‚úì Cleared currentJob from localStorage');
        
        // Now render the empty form
        render();
        console.log('‚úì Measure sheet re-rendered (empty)');
        
        // Then update other views
        renderHistory();
        renderJobTasks();
        renderScheduleCalendar();
        
        notify('‚úì Job Saved - Form ready for next entry');
        console.log('üìã Ready for next job entry');
    }

    let historyFilter = 'all';
    
    // Track deleted jobs in this session to prevent Firebase from pulling them back
    let deletedJobsThisSession = new Set();
    
    // Function to create unique job key
    function getJobKey(jobNum, dateReceived, client) {
        return `${jobNum}|${dateReceived}|${client}`;
    }
    
    // Function to check if a job has been deleted in this session
    function isJobDeleted(jobNum, dateReceived, client) {
        const key = getJobKey(jobNum, dateReceived, client);
        return deletedJobsThisSession.has(key);
    }
    
    // Function to mark a job as deleted in this session
    function markJobAsDeleted(jobNum, dateReceived, client) {
        const key = getJobKey(jobNum, dateReceived, client);
        deletedJobsThisSession.add(key);
    }

    function renderHistory() {
        const historyList = document.getElementById('history-list');
        if (!historyList) return;
        
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        if (history.length === 0) {
            historyList.innerHTML = '';
            return;
        }
        
        // FIRST: Filter out deleted jobs from this session (prevents Firebase resurrection)
        let filteredHistory = history.filter(j => {
            const isDeleted = isJobDeleted(j.jobNum, j.dateReceived, j.client);
            if (isDeleted) {
            }
            return !isDeleted;
        });
        
        // SECOND: Apply active/completed filter
        if (historyFilter === 'active') {
            filteredHistory = filteredHistory.filter(j => !j.completed);
        } else if (historyFilter === 'completed') {
            filteredHistory = filteredHistory.filter(j => j.completed === true);
        }
        
        historyList.innerHTML = '';
        if (filteredHistory.length === 0) {
            historyList.innerHTML = '<div class="card" style="text-align:center; color:#999;">No jobs match this filter</div>';
            return;
        }
        
        filteredHistory.forEach((job, idx) => {
            // Find original index in full history
            const originalIdx = history.indexOf(job);
            
            const jobDate = new Date(job.timestamp);
            const dateStr = jobDate.toLocaleDateString('en-AU');
            const isComplete = job.completed || false;
            
            historyList.innerHTML += `<div class="card" style="border-left:5px solid ${isComplete ? '#34c759' : 'var(--gs)'}; position:relative; ${isComplete ? 'background:#f0fff4;' : ''}; overflow:visible;">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px; position:relative; z-index:1;">
                    <div style="flex:1;">
                        <div style="font-weight:900; color:#000; font-size:14px;">
                            Job #${job.jobNum || 'N/A'}: ${job.jobName || 'Unnamed'}
                        </div>
                        <div style="font-size:11px; color:#666; font-weight:700;">${job.client || 'No Client'}</div>
                    </div>
                    <div style="font-size:11px; color:#999; font-weight:700; text-align:right;">
                        <div>${dateStr}</div>
                        <div>${new Date(job.timestamp).toLocaleTimeString('en-AU', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                </div>
                <div style="display:flex; gap:15px; padding:10px 0; border-top:1px solid #eee; border-bottom:1px solid #eee; margin-bottom:10px; position:relative; z-index:1;">
                    <div style="flex:1; text-align:center;">
                        <div style="font-size:16px; font-weight:900; color:var(--gs);">${job.totalSqm || '0.000'}</div>
                        <div style="font-size:9px; color:#999; font-weight:700;">SQM</div>
                    </div>
                    <div style="flex:1; text-align:center;">
                        <div style="font-size:16px; font-weight:900; color:var(--gs);">${job.totalParts || '0'}</div>
                        <div style="font-size:9px; color:#999; font-weight:700;">PARTS</div>
                    </div>
                    <div style="flex:1; text-align:center;">
                        <div style="font-size:13px; font-weight:900; color:#666;">${job.color || 'N/A'}</div>
                        <div style="font-size:9px; color:#999; font-weight:700;">${job.brand || 'N/A'}</div>
                    </div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; position:relative; z-index:1;">
                    <button onclick="loadJobFromHistory(${originalIdx})" style="flex:1; min-width:100px; border:none; background:#f0f0f0; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">LOAD</button>
                    ${!isComplete ? `<button onclick="completeJobById('${job.jobNum}', '${job.dateReceived}', '${job.client}')" style="flex:1; min-width:100px; border:none; background:var(--gold); color:#000; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">COMPLETE JOB</button>` : `<button onclick="toggleJobCompleteById('${job.jobNum}', '${job.dateReceived}', '${job.client}')" style="flex:1; min-width:100px; border:none; background:#34c759; color:#fff; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚úì COMPLETED</button>`}
                    <button onclick="deleteJobFromHistory(${originalIdx})" style="flex:1; min-width:80px; border:none; background:#ff3b3015; color:#ff3b30; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚ùå DELETE</button>
                </div>
            </div>`;
        });
        
        // Update client dropdown with latest clients from history
        populateClientDropdown();
    }

    function filterHistory(filter) {
        historyFilter = filter;
        
        // Update button styles
        document.getElementById('filter-all').style.background = filter === 'all' ? '#d4af37' : '#f0f0f0';
        document.getElementById('filter-all').style.color = filter === 'all' ? '#000' : '#666';
        
        document.getElementById('filter-active').style.background = filter === 'active' ? '#d4af37' : '#f0f0f0';
        document.getElementById('filter-active').style.color = filter === 'active' ? '#000' : '#666';
        
        document.getElementById('filter-completed').style.background = filter === 'completed' ? '#34c759' : '#f0f0f0';
        document.getElementById('filter-completed').style.color = filter === 'completed' ? '#fff' : '#666';
        
        renderHistory();
    }

    // Track the current job being edited (if loaded from history)
    let currentEditingJobIndex = null;
    let isJobViewMode = false; // Track if viewing job without editing
    let jobDataBeforeLoad = null; // Store original data to detect changes

    function loadJobFromHistory(index) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[index];
        
        if (!job) return;
        
        console.log('üìÇ LOADING JOB FROM HISTORY - Index:', index);
        console.log('  Job object items count:', job.items ? job.items.length : 'NO ITEMS PROPERTY');
        
        currentEditingJobIndex = index; // Track this job for overwrite
        isJobViewMode = true; // Set view mode
        
        items = job.items || [];
        console.log('üîç JOB LOADED FROM HISTORY - Job #' + job.jobNum + ', Items loaded: ' + items.length);
        items.forEach((it, idx) => {
            console.log('  Item ' + idx + ': ' + it.desc + ' | sqm: ' + it.sqm + ' | qty: ' + it.qty + ' | color: ' + it.color);
        });
        document.getElementById('cli').value = job.client || '';
        document.getElementById('dRec').value = job.dateReceived || '';
        document.getElementById('jNm').value = job.jobName || '';
        document.getElementById('jN').value = job.jobNum || '';
        // Get brand from first item if it exists, otherwise from job.brand
        document.getElementById('p-brand').value = (items[0]?.brand) || job.brand || 'Dulux';
        document.getElementById('p-color').value = job.color || (items[0]?.color) || '';
        document.getElementById('p-code').value = job.code || (items[0]?.code) || '';
        document.getElementById('p-finish').value = (items[0]?.finish) || job.finish || 'Satin';
        
        // Store original data to detect changes
        jobDataBeforeLoad = JSON.stringify({
            items: items,
            client: job.client,
            dateReceived: job.dateReceived,
            jobName: job.jobName,
            jobNum: job.jobNum,
            brand: job.brand,
            color: job.color,
            code: job.code,
            finish: job.finish
        });
        
        render();
        updateGoBackButton();
        tab('measure');
        notify('‚úì Job Loaded - View Only (changes can be saved)');
    }

    function updateGoBackButton() {
        const btn = document.getElementById('goBackBtn');
        if (isJobViewMode) {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    }

    function goBackJob() {
        // Get current data
        const currentData = JSON.stringify({
            items: items,
            client: document.getElementById('cli').value,
            dateReceived: document.getElementById('dRec').value,
            jobName: document.getElementById('jNm').value,
            jobNum: document.getElementById('jN').value,
            brand: document.getElementById('p-brand').value,
            color: document.getElementById('p-color').value,
            code: document.getElementById('p-code').value,
            finish: document.getElementById('p-finish').value
        });

        // Check if there are changes
        const hasChanges = currentData !== jobDataBeforeLoad;
        
        if (hasChanges) {
            if (confirm('You have unsaved changes. Save before going back?')) {
                saveJob();
                return;
            }
        }
        
        // Reset view mode and clear editing
        isJobViewMode = false;
        currentEditingJobIndex = null;
        jobDataBeforeLoad = null;
        items = [];
        updateGoBackButton();
        
        // Clear form
        document.getElementById('cli').value = '';
        document.getElementById('dRec').value = '';
        document.getElementById('jNm').value = '';
        document.getElementById('jN').value = '';
        document.getElementById('p-brand').value = localStorage.getItem('lastPaintBrand') || 'Dulux';
        document.getElementById('p-color').value = '';
        document.getElementById('p-code').value = '';
        document.getElementById('p-finish').value = 'Satin';
        
        render();
        tab('history');
        notify('‚úì Exited Job View');
    }

    // Delete a job from Firebase permanently
    function deleteJobFromFirebase(jobId) {
        if (!window.firebaseReady || !window.currentUser || !window.firebaseDb) {
            console.warn('Firebase not ready, cannot delete');
            return;
        }
        
        try {
            const jobDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'jobs', jobId);
            window.deleteDoc(jobDoc).then(() => {
            }).catch(err => {
                console.error('Firebase deletion error:', err);
            });
        } catch(e) {
            console.error('deleteJobFromFirebase error:', e);
        }
    }

    function deleteJobFromHistory(index) {
        let history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const jobToDelete = history[index];
        
        if (!jobToDelete) {
            console.error('‚ùå Job not found at index:', index);
            return;
        }
        
        // Show detailed confirmation with job details
        const confirmMsg = `‚ö†Ô∏è DELETE JOB PERMANENTLY?\n\n` +
            `Job #${jobToDelete.jobNum}\n` +
            `Client: ${jobToDelete.client}\n` +
            `Date: ${jobToDelete.dateReceived}\n\n` +
            `This CANNOT be undone!`;
        
        if (!confirm(confirmMsg)) {
            console.log('‚úì Job deletion cancelled by user');
            return;
        }
        
        // Confirmed - proceed with deletion
        if (!jobToDelete) {
            console.error('‚ùå Job not found at index:', index);
            return;
        }
        
        
        // Mark this deletion in session IMMEDIATELY (before any other operations)
        markJobAsDeleted(jobToDelete.jobNum, jobToDelete.dateReceived, jobToDelete.client);
        
        // Remove from history array
        history.splice(index, 1);
        localStorage.setItem('jobHistory', JSON.stringify(history));
        console.log(`‚úì Removed from localStorage`);
        
        // Verify deletion
        let verifyHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const stillExists = verifyHistory.some(j => j.jobNum === jobToDelete.jobNum && j.dateReceived === jobToDelete.dateReceived && j.client === jobToDelete.client);
        
        if (stillExists) {
            console.error('‚ùå CRITICAL: Job still exists after deletion attempt!');
            notify('‚ö†Ô∏è Error: Job deletion failed');
            return;
        }
        
        
        // Delete from Firebase DIRECTLY (not just sync)
        const jobId = jobToDelete.id || jobToDelete.jobNum;
            deleteJobFromFirebase(jobId);
            console.log(`‚úì Deletion sent to Firebase`);
            
            notify('‚úì Job permanently deleted');
            
            // Re-render history (will filter out deleted job even if Firebase brings it back)
            renderHistory();
            renderJobTasks();
            renderScheduleCalendar();
    }

    function completeJobById(jobNum, dateReceived, client) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        // Find job by unique identifiers
        const jobIdx = history.findIndex(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
        
        if (jobIdx < 0) {
            console.error('‚ùå Job not found:', jobNum, dateReceived, client);
            notify('‚ö†Ô∏è Error: Job not found');
            return;
        }
        
        const job = history[jobIdx];
        
        if (confirm(`Complete Job #${job.jobNum}?\n\nThis will:\n‚úì Mark job as complete\n‚úì Generate all PDFs\n‚úì Alert admins`)) {
            // Mark job as complete
            job.completed = true;
            job.completedDate = new Date().toISOString();
            job.dateCompleted = new Date().toLocaleDateString('en-AU');
            history[jobIdx] = job;
            localStorage.setItem('jobHistory', JSON.stringify(history));
            
            
            // Verify it was saved
            const verify = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const verifiedJob = verify.find(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
            if (verifiedJob && verifiedJob.completed) {
                console.log(`‚úì Verified: Job is now marked as completed in localStorage`);
            } else {
                console.error(`‚ùå FAILED: Job completion not saved properly!`);
                notify('‚ö†Ô∏è Error: Failed to save completion status');
                return;
            }
            
            // Sync to Firebase IMMEDIATELY
            if (window.syncJobsToFirebase) {
                try {
                    window.syncJobsToFirebase();
                    console.log('üîÑ Synced completion to Firebase');
                } catch(e) {
                    console.error('Firebase sync error:', e);
                }
            }
            
            // Generate batch PDFs
            generateBatchPDFs(job);
            
            // Alert admins
            alertAdmins(job);
            
            notify('‚úì Job Completed - PDFs Generated');
            showGlobalNotification(`‚úÖ JOB COMPLETED #${job.jobNum}\n${job.client} ‚Ä¢ ${job.totalParts} parts`, '#e8f5e9', '#34c759');
            
            // Re-render ALL views to show completion
            renderHistory();
            renderJobTasks();
            renderScheduleCalendar();
        }
    }
    
    // Kept for backwards compatibility but calls new function
    function completeJobBatch(index) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const jobAtIndex = history[index];
        if (jobAtIndex) {
            completeJobById(jobAtIndex.jobNum, jobAtIndex.dateReceived, jobAtIndex.client);
        }
    }

    // Toggle job completion by job identifiers (used by buttons in history)
    function toggleJobCompleteById(jobNum, dateReceived, client) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        // Find job by unique identifiers
        const jobIdx = history.findIndex(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
        
        if (jobIdx < 0) {
            console.error('‚ùå Job not found:', jobNum, dateReceived, client);
            notify('‚ö†Ô∏è Error: Job not found');
            return;
        }
        
        const job = history[jobIdx];
        
        if (confirm(`Unmark Job #${job.jobNum} as complete?\n\nThis will reopen the job for re-work.`)) {
            job.completed = false;
            job.completedDate = null;
            history[jobIdx] = job;
            localStorage.setItem('jobHistory', JSON.stringify(history));
            
            
            notify('üîÑ Job reopened - now active again');
            showGlobalNotification(`üîÑ JOB REOPENED #${job.jobNum}\n${job.client} ‚Ä¢ ${job.totalParts} parts`, '#fff3cd', '#ff9800');
            
            // Sync to Firebase
            if (window.syncJobsToFirebase) {
                try {
                    window.syncJobsToFirebase();
                    console.log('üîÑ Synced to Firebase');
                } catch(e) {
                    console.error('Firebase sync error:', e);
                }
            }
            
            notify('üîÑ Job reopened - now active again');
            
            // Show GLOBAL RED NOTIFICATION for reactivation
            showGlobalReactivationAlert(job);
            
            // Refresh the view
            renderHistory();
        }
    }

    // Show global red notification when job is reactivated
    function showGlobalReactivationAlert(job) {
        const alertArea = document.getElementById('globalNotifications');
        if (!alertArea) {
            console.log('Global notifications area not found (user not on Schedule tab)');
            return;
        }
        
        const alertId = `reactivation-${job.jobNum}-${Date.now()}`;
        
        // Remove "no notifications yet" placeholder if it exists
        const placeholder = alertArea.querySelector('p');
        if (placeholder) placeholder.remove();
        
        const alertHTML = `
            <div id="${alertId}" style="background:#ff3b30; color:#fff; padding:12px; border-radius:8px; font-weight:900; font-size:12px; margin-bottom:8px; transition:all 0.3s ease;">
                üö® JOB #${job.jobNum} REACTIVATED
            </div>
        `;
        
        alertArea.insertAdjacentHTML('beforeend', alertHTML);
        
        // Strike through after 10 seconds
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.textDecoration = 'line-through';
                alert.style.opacity = '0.5';
                alert.style.background = '#ff3b3080';
            }
        }, 10000);
        
        // Remove after 20 seconds
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(() => {
                    alert.remove();
                    // If no more alerts, show placeholder
                    if (alertArea.children.length === 0) {
                        alertArea.innerHTML = '<p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p>';
                    }
                }, 500);
            }
        }, 20000);
    }

    function generateBatchPDFs(job) {
        // Check if jsPDF is loaded
        if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
            notify('‚ùå PDF library not loaded. Please refresh the page.');
            console.error('jsPDF not available at window.jspdf');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Get job items for reference
        const items = job.items || [];
        
        // Create a zip-like multi-page document with all forms
        
        // Add logo at top
        const logoBase64 = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEA3ADcAAD/2wBDAAIBAQEBAQIBAQECAgICAgQDAgICAgUEBAMEBgUGBgYFBgYGBwkIBgcJBwYGCAsICQoKCgoKBggLDAsKDAkKCgr/2wBDAQICAgICAgUDAwUKBwYHCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgr/wAARCACeAKcDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9/KKKKACiiigApryKn3q8T/bo/wCChn7J/wDwTo+Esnxi/ar+KtpoOnsWj0vTY/32oatMB/qbW2X55m5GSAEQHLsq81/Pn+3T/wAHJH/BSH/gpN4h1H4U/sL6PqHwi+HbboZtQ0+6C6vdR5+9cagoH2UsCv7m3IcfMN8gzUVKlOjBzm0kurKhCVSXLFXZ+737cX/BYL/gnd/wT006VP2lP2kdGsdajk2R+EdHY6jrEjldwBtLfdJEpB/1koSPkZbJAP5W/tIf8HoGs+IdYvPBv7AX7EF9rMm5ls9e8dXbs8g6B/7PsctjqRm4B6ZA5A/Nf4V/8E+PBw1STxV8a/Et54q1e6mNxdeZcOsLysdzs7Z8yZixJLMwznkc19mfsyfstan4w1Sx8AfBP4fafZ/a76KyjS3EVrCZ3jnkjRmO0bmW2mwTnJTb94gH5itxN7ao6WW0J15L+VOy/Bs97C8P4mtHmqPlX3s4zxR/wV9/4OWf2qLFj4f8cWPw70u5YlodF8P6bpkgBIIAa6Et4gHYhhnuTXEf8Kl/4L1fF2c6h40/4KXeLrV25CTfFfWVAyeRtt12j8OPSvsy++B+ofD74CeG/wBoDWvEdpNpviCa6SOytIZPOs3trqC2ljm8xU2yhpSwQAgrGTnBFem/Cz4WaI37eS/sfeM9RuW02SSYWWu6XMiS3CGyN3bSYdXVQ6bMj5vvYB716OH4d8XM2o1K2HwUKcIRnJ87SdqbSno5XurrSx9vgPDmtisLVxCi3GnGpOV2lpSaU7Le8XJaeZ+eum/sIf8ABafIudN/4Kja9HMeW/4ul4iX9Qldb4Q8Af8ABzL8E7tL34Yf8FBNc14W5/cw3nxCl1GNsHIzFqkRjP4jkcHivurwVb6fNY6vPqTSibTdS8KW8aRuoBXUrN5rknI6q6EJ0wPvbjzXUeFNZsbj4zfCv4P42N4++H9v4h1HUmbI0+Rra5uHRUwN6BbfjLA/N3xXFX4d8YsHeTo0p2TbSa2UVJ9V0a6m9Tw3qcs+WD92Lk/e2UYKo38otP103Pi7Sf8Agu9/wcj/ALHWqwJ+1B+y7pfxD0u3VRfXsvgpWWVQASwvNFcW8bkc8oQP7vGK+r/2R/8Ag8g/YQ+K0sPhz9rT4V+K/hHqxkWOW+jjOtaWpzglpIES4TB6jyCAP4utd98Nfi74V1f9nBv2oPFAj0Hw5H4k/sX/AEpmkmNxhSCqovzL83bkbWOKr/HH/gmx+xJ+274St9e+MXwC0fVP7ctY7rTvFdjZNY6hKjAMkqXUQSVlIwdrEqc4IPSvDqcWZ5ktb2eeZfOnZ2co6q69dPukfNZpwRj8u5rprllKDutOeKTlG60uk1dH6O/A79o74C/tL+CofiL+z58YfDnjTQ5lXbqXhvWIbyJWZdwRzGx8t8dUbDDuBXag55r+cH4j/wDBA/8Abx/YE8eTftJ/8Ec/2ptfjv7ebzG8J3mpR2d9LCuWEJkO211BM4HlTogOf4jX0R/wTg/4OuvsnjmL9lX/AILBfDK4+GnjSxmFlP44TSZbW1NwWAVb+yZd9kSDkypui/iKxryPr8szjLc3o+0wtRS7rqvVbo+OxGFrYWXLUVj9tqKz/DHijw94y0C08VeFNfsdU0zULdZ7DUNPukmguYWAKyRyISrqQchgSCK0K9M5wooooAKKKKACiihmCjJoAQnBr4G/4Laf8F2vgZ/wSb+HH/CLaXBZ+Lvi/rti0nhnwQt1hLSM5Vb6/K/NFbg52oMPMVKoVAaRNT/guZ/wWU+HP/BJn9nBtW0xbTWvip4st5rf4e+F5ZAVEgGG1C6UEMLWEkEgYMr4jUrl3T+bf4Y/Db4o/tHfFDVP2w/2ufEd54m8XeKL9tSkm1jDPPI//LaRcbVAGBHEAFjVVAAAULw5hmGHy3DurVfourfZHVhMJVxlXkh832JPFGn/ARTX/BRn40XX7V37ePxG1TWr7VDm1sJ3MWy3ySkEMQ+W0tlz8saAE5JOCSzfYf7JX7EvxD+Nuga7N8GvA23w14FsUvPE8mk26yTWNqdzEw2iMJbqUpHKyxRgs5jIHzEZoaR8FviT8PPh3p/7UF98L9P8WeG9A8TWC+JvB8uqPBfSWMgSdDLGg8yCG6ibbDMRiTkoGwob601f4heGvhf4j8Mf8Fbv+CWbLeeF7jy9L8e/DtflltQdpfRrtAWaE4XFtIEZCEiRDlLdJ/d4Z8Mc840w9PM80l7LDVG40ldcrqKzjTqu96ftI/BKS1draH0NOeFwN6OHac+r8+xl/DO3+C/7BP7TXwz+JOvQ6H408E3oXS/F13qEUF+kMlwnnQarajZ+7Ro2WRMb2ECwlir3iRrY+P3grUv+CfP7butfDPwVdxWPhfxRNDrngG4gO6OOGWdLmyG7P3YL61hi5JIgRz/y1NYX7Ymr/CnVvhrpfxn+CWoXN58Hfiw0w8O2sdwY28JawXe5vPD0yLv2lZjJe2oICKxm2pKEtAM62+IL/ts/8E3JPCmt3QuPiR+zfI1xa+TAzSX3hdzHFcIC2HH2ZvKkOQCsUcYIyzFf6X4P4Ry3J8tozjh1ToN/Vq65UmuaX7upJdJ0qt6c2/stO7Wr+p4bzCl9YXtuvuVE/wCVv3ZesZbvs/I98+KOt+G/iB8Evir4W0zT2m0jUJNO+KvguzZh58NvqsbW16rKCRtt7iUFscAxsT2rgPBPxBWX9sz4B/GaC5df7Z0vw/BezsMbpIHOlXAP1Ns3/AWBrk/2QvjW3jbQdGsPEZkea3vNQ8J65ebtzS6V4gikELv6pBfiWZsnANwgAz04y/8AFWq+HfBHg2R7eSDVvBXiq/hkU/8ALEB7e4jUnsfN+0/l9a93BcP1svxGJy6sveXPB+k6Uo3+bhTm/OR/QnBeB9tQr4OW7U4fKrRlB/fKnCT85HsGneI7vw5efEux1i4HnWHjjQYNvTC2kuowAfgFUfhUVp4zvrL44TeN4Lth/wAIB+z7bi1bbzG82gwWqAfSbUQfzrhPj5rj2vxO+MhsJWWO88aG4gA7ob2d1b6Ykz/wKsW48avf6r4q03SGaWbxLouj6BbtG3RVe1c/UZswn4189isnUsG6/RxV/nClf8Ln2mXcOLEYV1mrxlCMZekoYVS/8k5vuZ7h8ftOuU/ZB/Zs/ZG8OzZ1bxXM/iC8hVeTJfXJhtGI78SyKPZa6b/gpb8eo/hz+0T4X+Dfw58SXOn6F8CvCFuq/Y5WDT3pjiKW7bSNysRZxsOytKTnpWx4eu/C17/wUr1LxZqdvG3g39njwOVUSjgJpdmIkXnIL/a5HK9D8oPWvkHwJpviX9tb9phtA1vVBaDxT4kn1zxpqnnCOOytIy81xMWbhVijMzDJwTtXrjP4BxdWisLZq9020+spu/XsrHFkGU4XMsRHG5hpQwtCriarav8AvcbKU3p1lGgrJWdnKJ+iH7EXx5+JOofAvwHqP7ROpx33iLxxeajeaay2qWn2DQLOLMmpXbnCLGHXAfA3iZCM81pft2/8Esv2O/8AgqL8J7e2+L/g4Q6w+mLN4X8daZbfZtW01ZIy8RyyhpIvn3G3mBU5zhWww8nu/i74FvrDXPjB450OS18Ipo9l/wCSX5fMg8K2zFNF8PRqwysuqTxm6mXp9mQBhtdWrqfgr8Z/HXwS8Lat+0j8Yxcav45+KWqQvpPhXT1LtcBX8uGCGNCTtVVNvCOMsLiU+ZHEpH4NWyWnh60a+Xy9nUWt07Ky6v1ey82raH878S8PvNK9fGU6Sp882o04rTnk+bkilZJU4P3pbKylqpq35xfBb9pz/gpX/wAGtHx/sfgj+0TaXvxM/Zt8Rag40u4tyxt9hOWm053J+w3a53yWbny5MOR94Tj+g79ln9qj4GftmfBHRP2hv2dPiBZ+JPCuvW/mWeoWjYaNx9+CZDhoZkPyvG4DKRgivHPjX8Jfgh+2L8H9c/Zk/aU8H6HrEepaPAPF3g86lHczaVJNHujIkTDxSowJjmUKwKbkxivxI8IeK/2qf+DUn9v2O3nu9Y8cfsxfErUm3wmZc3EK4HmcLsh1S1VlJwES6jGPlB/c/W5DxEswm8JiVy147ra9u3n3Xz9PxnHZfUwsr9P6+9PdPqf0vUVy3wV+M/wz/aE+FGgfGz4OeMbPxB4X8TaZFf6Lq+nyFo7iFxkHnlWByrIwDKwZWAIIHU19RecFFFFABXnf7Vf7THwq/Y6/Z78XftM/G3WmsvC/g3R5L/VJI13SSY+VIY1JG6WSQpGi5G53UZGa9DZtoziv57v+Dub9vLX/AI7fH/wX/wAEmfgZrwkh025t9Z+Iix7lV9SmTdZWsjd0ht3Ny4AZSZ4v4oiBMpRhFyk7JDjGUpWR+ffjH4vfGH/grh+2h4p/bk/aTleTTTqHk6FoLTNJa2FvGc22nwhjxDCjBnwAJJHZmBMj19QeCPCZ+HKeHfjl8WfgXq3if4e3GsT2lxbx6lNpKaq0cR8yG2vzEYVuELRssLvG07AxRFpNwXnvgj8NPhR8NdO8L/Dvxf8AEXTfBnheK5t7C68Sa4JGhtVkk+eZ1iVmZizM+AACSSSigsv2HefEP9uz/gnb4GvNIitfDv7R37MHiC9uo28O6xd2usaWNPky5jtdWtoxGhIz+7uIYUMh2wwyMxeurw14Xlx3xAszxcIyw1OXLTpzlKnGtJbxhUtyqaupWco3bSuj3sdWjk2DWHpu1SSu32/rZfM4X4hfFiKXwrH8ePgZ8TZvFngfR4zpieKpNLjj17wfFIVB0bxHpvCvYttbe2BZTSfPGbOYySzfN3hv9prVP2a/inqHxs/Z7sbFrHWbAQfEr4W30zXWj61pzIPMIzhp7ZizsrMoubViVl+dGkn9LuvhP8Ifjl4qj/aK/wCCNHxk1Zwt8QLWxZda/Z78bXUcerCFl2z2mny3BMWrWmxVT7DKXJj4IwRCPl7xnb+DviNrE+qeDPDE/wAOfiNpd07ax4BMUtvaz3SlzI2nCT95ZzDaoNhITl8iB+Ut1/0G4J4ZyOHtMPVUvZySjUp1I8s6ae0a9P8AlvrCvSvC/vLl1cvAoVJOotdf62fX8z6R8IfGn4ReDI9aSxutU1v9nT4ySLa+KNJLeZqng/VlCyQz8AKmoWrhZYpwCl5CkmPm8xIfN/gf8YPiJ/wT+/bdWHxhd6frVqJVtdRlsW3ab4j0m5j2+dDwqvb3VtJlTgBd4JCmPaPnvwh468SfDfV72NbfzLO+RrXXNFmQrHcR7slGTjayuAykYKOoYYIre+IPjRvHHgTTdCa6kvV0Et/wj15Mv763tZGMklm3OPLEjNIoHCu8pA/fHH6lQ4B+o4irhqi9rhsTB05t7yVrQqN/8/IpKM2v4kVGekoWf1WFxDdq8P4kPij/ADR6/ej6+PhvQvgj+0VrHwv8O6xe3nhXxJY48Jap52JbvTbzZc6XO7nHzJMlt5vAIaKZSAQRXReMvG1nr41zy7rzv+EgvrXWpJPK2GO82SefDtxwA9xMPcRqR1r538A/FJ/i58CbHTdQkjbXvALsIpFRvPudLnkzIhbPIimbzlXGf39yxOBiu+8L+ILjXLCW/u5vMn84SzNn7zE8t+J5/Gvi8Rw3VpVnUxb/AHtJKnN/zOLTjP8A7fiot+d10P6s8KczwuLqLmfNeN0+/K09fNctn6M9Y+MWt/2t4n1rVUb/AJCmjaPdS+8jWtuzf+PM1Q/suQ6RJ+0D4Z1LxFLt0/SdQ/te+DLkNFZRvduCP92Ij8a4ufVJmgmhu5GkaSFIo2Zs7VUjA+gAwKteGvElj4Ystbnmjb7XfaW1lp7oSPKaV0WRzg9PJ81Mf7dfmXEWBlgciq0F1SS+5Rv8kj+iMPldSnw5XwlF+9OKgmul4Rp3+S1+R6vrvxTvvDH7IXi7xVqOqCbxF8ZPG3lahJIfmFjZMLqVx3HmXVyg9CIm71n/ALPNnpvgP4TNZGFptc+Js32aS3tZDHcf2DFOFa1VxjY2oXYS13dFSCVmypNeVePPFNv4nv8AQfDs8/k6Voelx2kb9dil3mmfr8xMssrAdwVH13LLxh4j8Y+Jbqbw3c/ZbrULMWGniSYmPRdKihMTu5CHG233RlwM4aZsFmU1/D3H2YezxjpR/pbL8Pz8jz8dwzVjkdXDx9xVajq1G+0bRowflCMYSdv5Gvta+9aZ448PfEjxFdeIfHniFh8P/hxffb9a1C0uHt08Qa9INv7hozuVVWL7NalQTBbwGUYZSjdx4y/ae1L4CSW/xt8XaHb6l8avE1isHw18Hrahk8F6dMoSO6lgA+S7lj2LFByyRCNSTyD8z2Pxi8NWF7pOkfD3w42pWvhucx+C9BlsxN9u1JygfVLtAD5rs6KUtyGB2woSyQ4k9C8A+INf+DHjoyeE7Z/iJ+0d4nuXxfMq30PheaU/MUJ3JcX+OWkJMVuMg5IbH5e8bLVRlZ31e9n0susukV/28z87x/BdCjWi8TRbhGL5KTajzRWsnUltTpNvnxE+ulCCaTT9s+FPiKD9gaG9+MP7SPirUPEXxi8VWvm/8IgusSbNKiuHBNxqTpnzrqTC7YQGYADAUAyJ9MftZfsy/Cj/AIKPfseXHwa+PXgTUtP0zxdo8F/ZQ6pamHUNEvCm+3ulGQUmiY8rnDKWjcFHZT8V+B/Efgn9l7xilxM6/GD9oDVr5niZVfUtN8N3km1iVC86jfkjl1bYjADd8p3fSPwY8RfEH4FeMrzU/wBrr46S33jjx1NGLH4eWMJ1TULQeYv+lXskAK2yIjcRoEhRdxAJzjx8woVJ0vrGEvGpS1VunX3pbObf2V6en414hcOxx3+1yac5K6lZx9rFWSVCileFCmtqk7c299U38O/8G9n7avxb/wCCWP7d3iT/AIIi/to6qYdE1jxA3/CudWuZsW9rqco8yJYev+j6hG0boNw8ufC7d80m3+gmM7lzmvwU/wCDlv8AYiuPin8E9L/bu+EEV3aePfhPJE+oX2lt5dxLo/m+Z5wdcP5lrMRMjAjYjznnCkfpn/wRF/4KJaf/AMFKv+Ce3g348ahewN4t0+H+wviBawvkw6xaoiyyEY+UTo0dyq87VuAuSVJr9M4bzuln2VQxMdJbSXaS3+/deTP5nzDBywWIdN7br0PrqiiiveOI5n40fFjwZ8B/hH4m+NvxGv2tfD/hHQbzWdbuEXc0drbQPNKyj+JtiHC9zgV/I/8Aslav40/bL/as+KP7eXxXmkutV8ReIruaGS4zJ5M91IZGRGP3Vhh8uFVHSNgowABX7Xf8HVv/AWUr+FP7On/BP/xR+x14a+JtrH8Uvila21jDoNm/mXVrorXCNeXEw2ssUcsMcluu8qz+exTPlsR+VP8AwTS/4N5P+Cpn7dvwa09vE3i0fBP4S3ytd2tx4gs5EvNaEjHM62EJjkuAQqAPcvGrRiPyyygY83NsHWzDATw9KfK5aN9l1/DQ7MDiKeFxKqzV7a28+h7FrHxJvv2ZPBq+MvGfw9+E3j74e+KNPzr+g3nxa07TfEdqbeeZAosricrNEzhJBFNZ3SSeWjbVIVq4H4O/tC/AXRtduviX/wAE4P2xNX+C/izVNWjN54B8USR22m6lGUO6KUs76XdAyMcPM9nGke5Vts7SfuW1/wCDSz/gjp8FfD1tB+0P+1j42fUjbqt1fap400vSYZZcAFo4mtyUXOSFLuRnBJ614J+3X/waReF9N+EV1+0D/wAEnP2jtS8ZPpljNcv4P17ULa8fVwgyVsb60VI/M2hgIZEO8kDzF6H9c8P+Psr4PySjlEsKnCOk5Qlf2i3bqUanPSm79lB+atc8/MYVsdipYhuze3l5Jqz/ADPnH4+3Xwa8Ua7Hp/7WH7Pk/wAFfH0t0DY/FD4TWLP4c1KNXULcy6QWUCNjuYXNlKgbdvWCQjaeZ+OHin4g+MPDcOvftLtY/E/SkjktNB+OHhG8M9+h6Qx38rBZJgNvy22oxxXO1dsUsaA54f8AYB+Ffx8/aM+GXjTwH8I/ik1v4p8H30d74h+E3iLQZprTUY9xiF2Itk8IeOT93K1zDDHDvjJmG/C8v8SdG+Jn7O+tXms+J/BWoeCJv31nPf6RdPLpl7EyBZYI5g8iTo2cMFlkVs7doxiv7h4HzrhHiDL6eLwOYU+WlHm5ZycJUla8uXnftaK7qM61Gya5EjyY1a+Hqcs01r8n+n5Mra/q8uo3+2fXF1TyVVIdQaJlkljCgKr7uSVGF53YxtDFQKrWNzNYTedb/cb/AFkf+FcbZfGvwp4010i2+yWdxMfmjt7QW8cr+qoPkTP91Qq+ijpXVW12rj+dfvPDefcP8RZWq2U4iFaEdG4SjJJ9U+XRd9l6H0+DxHNZ7NHT+DPFl/8ADjxXD4r0Wd1t5laG8jjbG6GRSjofYqSMdOcHrX0D8LNQjW7+xRXAkiurYiGRTwy43If++ePqDXxn8ZPiHfeCvC6w6Of9MvpPKhbbnYP4mx69B+NfQX7Rv7Gn/BUv/gkXo3gv4t/tU/D1NS8B+Io7Vl1DTrsXENhcSxiU6fO+1XtbpV3ja6+WzK+xpNrEfgvil4ycG8K8Tf2JiozdXlXPOKTjG+sU9btpO7snZM/TeBeOMNwrnFP29/Z8yba+zf4tN7Na6bH0J5nmSW5P3mBP6VwXx7+Pvw5+A+hW2uePtQnBlMhsbG0j3TXEnACgEgYAYkkkAY9SAYvhj+0v8E/jFrFtpvgHx5aXF59nkf7BOrQzEnadqrIF3Ec5C56Z6V5P/wAFHfhzceMPh1D8R7C+W3u/CVw0lvD/AM9rZmiRiBj76yfMO21W64FfiHiRxNhZ8PSxGWVY1L7OLUlvq/VK+h/Z3EXHGIw/hzi844cqQrVINNNNSSUVBydr7pLZljwD+3x8E/iLraaPqE95oVzNLiH+1Il8mV2YKi+YpIXAPJYKMDrnFe7WOvSWWgXGiaSSv21h9uuFxukjUhljBx93eNxGcEhD/CM/Wn7Qv7F37Pv/AWX/g3R0D/goD4owa9HX4d6DeR4CePLVZLDSb3UE/HwBqpxI42yAM0X/8AsoXEn/BSbxpd40+Dt4W1yHz9yLbTpQZY5RlZDtgzMhI55AOtfVX/A0p+ytoX/BOT/goH8Pv22P2LfF+ueCPGPxYk1fUtUTw7dG1FpqkP2eOe6t2jIZTdC8czIcq7GQnIkYV4v/wAG3vwCuvHn/AAXu8Kpq3izR/G0PgVde8Q6z4g0i4lls7yVLGaBLmJ5o43kAvLqAhtgyw3DK4JxqU3UlZv3e3d+fkaRlyRvbU+nv+DtL/gmF+yl+zb4B8L/tf/Dbx54ssfF/iTxMNHn8N+IPE17rFtfxeVLPJPDJeSSy27o2CVEnlEMQFVvvR/8ABkhrfxZuPjb8cPDltrmoN4FtfCenXN9ppmY2serSXLLBKEJ2rI0EVypYDLLGAc7Rj0L/AIOofgV+1T/wUE/b2+Cf7C/7Kvwt1PxLqFn4Quda1A2m4Wll9pujALi7lI8u2jjWBv3jkZ83aMsVB/TL/gkH/wAE0/hn/wAEmf2RtJ/Zr0LxBDq3ijWLqTVfGniBE2nVdTaNFkaJSNy28SIkaKegGT8ztkpv92+ivZflYJdD+cL/AIKt6l8C/wBmX/gvj8YNb1XSfE0nhe38ZNqF1F4C8QR6XqVte3NnFctNBcyQyqjLdyGUjZyMqGU/MPIv22v2qNQ/az1fwz4L8MftGeMvHFlqF/HGt98WtP06HVNMYN5cNvJqnnyyS2y+a7MXaGLIDGPKBl/cz/go5+2f/wAEqv2RP2xNB/YMg/ZC+EvjLxV8VvF1jcfGrxZ498OR38VlbzXCuZ72byJZp7gBneFPuQHaf3SYI+Nf+Cd//BMP/gnj8dP+Djz4n/BP4ZaZpHxB+Bfgfwte+JtJ0ea5F9prSzJZQ/Yy4yJYre4v5PLDEsPs6BizKxP0WWcWZlhOH6mTqzpz7pNp3V3FtXV7Wdmr9bmVahF1faL+vU5v/g51/ZT/AOCXv7DngL4P/s3/ALMPwuttH+L2kaPbnXNY0NvLS/0lIWj8/UFyRLdyzKJFl++R5m4sCuPzd8Iz+K/in498C/Bjwh8UNB0y88VXVjZNruqXzwWtlczyCJRdSlCYVViN77SoHzZK81++37FH/BNn/gn/APtPf8Fnf2sItf8AhunjzwH8KfCvhzwtZeGfiFK2s2+n392kryfYJbh3khht47Hyo1J3R+dIqFUVQfNf+Cdv/BF//gnf4E/a41z9of45/BlNe8KfEr4var4U/Zr+EfiWRby3bTrVp2vNWuFkdvtMUaW9yIVl3ARReYfNaWGRNOHeOM94XwGJw+X4iVL6zGKk4txdlJNWs7pva/a/Q1lRcpadDzv9kj/g0o/aSX4weB/iB+23+2V8PbG00/X7HUYfB+j+fq8+rRxSpPNZbpjbInmRxlS8fnAA7trAYP6af8FevGH/AASt/aI8U+B/+CaH7fnxJ1631zx5rFpN4R8OeHZLuKSe9mlNpazPLDG0alZHbaJfkySWUjivENY/ZY/Z2+G//BzF8BvCX7O/hO60r/hC/gjr+u694XtdQc6RoltJFLp1pLZ2rHZab2uGjaOLah2xsEU7nf4q/wCCiPjq5+N3/B338K/CtqZLqHwj468G6XHDjHlJAY72XHsGmlavncVjMZmWI9riajnKTu5Sbk3bTVu7etikuW/p+djov+DnT/gj5/wTv/YM/Zi8K/tS/sq+Frz4c+Mz4qs9GtdF0e/lks9WTyZHaZklctBNGIlbzIyFY5DIWcOv5n/Ff49ftMaB8FF0/wDaV/Zm8SaLp/jTwxFF4Z8Ualot1p0WooY1eO6jaePZcq4O/dGQCHyDjAr9sv8Ag6B+FOu/thatge/sX/sC6fI8dh8QvHl9Jqt1CpaS1t4ms455lXBB2201w/PH7sZ4yR7B/wddeF9Aj/wCCKfiqCPR7cro3iLw+2m7oQ32Ui+hhBTP3T5cjJkc7WI6EinTxmIp0ZwUmoydmk9Gr21/E9rJ+Is8yGFSngKzhGrFqa0akmmtU01s3Z7o8o/4Nz9R17X/+Db34haV4oEjWNn/wnFppCyx4X7I1n5rhf7y+fLcc+u4dq/BH9kL9rbw3+z94c1Twz4r0TULyC8v47m3+w7P3Z27XJDEZJAXH0/P+in/glz8PPHnwm/4NbdG8LeHdBju/FHij4Y+I5tFsIZgpvLnWL6+NigJx87pdW6gepA57+f8AjT4Vf8E5P+Dcb/gnx8O/hD+0R8IPAfj7xh8RtYg0b4ma1c6Ja3V9qlrO7vfXax3ULtcWVorrGkBUBl2ZXe7tXnY7D4fGQnSrK6fLonZ3u2jfhTijOuDc4pZrlU1CtDmSbSkrONndNNbNn496v/wUU8M6ld2+i/B34Ya14j1a+UJb2bW+1vMPRQieY0hz/CBz2NdUPid/wVP+H+kN8V/Fv/BOX4g2XhuG1JvtZuPAOtW8a2ePmBuJIysaFe5G3HbFftT+zZ8DP2cf+CO3/BQLQP2VfhJ+yhomreIv2lPEGpan4C+Imj6TBbz6No9skFzq+lXUkjloreBI1uYFt8RSmSONokaJXfjvjt+1P/wVI8Nf8HCPgb9i79mn9oy68bfDe6XTde+JHhjUPBdiIPDOhtJi8Wa7ii3ZaJC0Ls0bebLGhDAqX8unw7ksYqn7G9+rb+fU/Qc38evFTOMR7aePcEvswjGMfus7363ufI//AMGcPhq5+L37f37QX7U+oaKkbWng+O0b5t32WTVNYyJRqVzJ9b1NRYzbSQ3RYrJJ1JbxYJFSbJFjuomCRo0Uch+g//AMGVv7KXgnwP8PiH4afsN/tBXGo/CPw/wBpL/AOJcHiC1/s74OHxnwYkF5FE8GpTzEyQuYR2wknAydgH9OVouj+IdJuNF1/SbW+srqMxXVneW6yRTIeqsrAhgfQivh39qv/g29/4JFftYXt74h8QfswWvg/WrzJk1r4dXj6O4bH3/ALPFm1Ld8tCST1zXxuacC8O5pU9p7P2c/wCaD5fw2/A9jC55mGGjyN80e0tT5C8Mftb/APCyPAUehfDL452viTw7au0kFvputRX9vatJG8TBQGcRZR3XaMY3Hoc1u+Lf2z/i5rY0Nddi0e+Xw7ZxWumrPp5VRFHJFIqsInTdzCmT6Z+teafFD/gyf+H1pJLq37Nf/BQLxNoN3EzGzi8UeE4rwng4Rp7We3Kc4ywjbj+E14d40/4Naf8Agr/8Kjv8F/8ABQzwfNaiTbA0ni7XrRivqUW1kCnjoCfrXJQ4X4my20cBmtSMVeyd9L79ba+hy42jwrm3N9ey6nNyUU3yrVRd4p6J2T1SvofZ3ib/AIK5ftK3Hiq28ZHwn4FW+s5llhZNIvNuVhmiAIN502zv+IU9iD5Lrv8AwUq/amtvFWpeLvDHjKx0O+1SS4a6bS9HhwfPMRkUecsmATEnfI59a+Yo/wDg3g/4LV6vJ9km/bz8FsM4PmfELXz/AO4+vRfAn/Bnn/wUA+IUscnx1/4KLeF9PsZcB5NJXVdZkC45/d3BtVPPbcM+1XHh7iiorVsxdttE/wDgF1KfC7qKp9Ri5KXMm0tJWtfrqea/tAfttR3t15Pxv/aJ8ya3sY7SPT9S1zcYbdBhY1tw3yqMdAoBI9evy18SP+Cinw+tLhtI+Fvhy+8Q30kgjt2aMwQOxOBtyDIxJ6LtGfWv2F+A3/Blx+wj4G1eLVfj9+0R8QPHyxKN2m2K2+jWszd9+wSzY9llU+5r9Ev2S/8AglP/AME9P2HreE/szfso+EvD99FjGvSWH23VGI7m8uTJP1GcBwAegFdmF4PwNOXPiKkqr83Zf5/ib/2vOnT9nhqcaceyX9L8D+eL9lP/AIIRf8Fh/wDgqBrVtq3xe8Oz/Bn4dzyJJLfeMLOWzeSFuf8AR9OyLi5YLyDMY0Of9YK/cv8A4Jf/APBBT9hX/gl5YW/ib4c+D38VfEL7O0d98RvFUay3p3EFhbRj93ZpxjEY3kcM79a+2QoH8Ipa+oo0KOHpqFKKiuyPLqValWXNN3YirsXaDS0UVsZhRRRQAUUUUAf/2Q==';
        try {
            doc.addImage(logoBase64, 'JPEG', 10, 10, 30, 28);
        } catch(e) {
            console.log('Logo add skipped');
        }
        
        let y = 50;
        doc.setFontSize(10);
        doc.text(`Job #: ${job.jobNum}`, 20, y);
        y += 5;
        doc.text(`Client: ${job.client}`, 20, y);
        y += 5;
        doc.text(`Job: ${job.jobName}`, 20, y);
        y += 5;
        doc.text(`Date: ${job.dateReceived || 'N/A'}`, 20, y);
        y += 10;
        
        // Parts table
        doc.setFontSize(9);
        const headers = ['Description', 'H√óW', 'Qty', 'Profile', 'Mode', 'SQM'];
        const colWidths = [50, 25, 15, 40, 20, 25];
        let x = 20;
        
        doc.setFillColor(0, 0, 0);
        doc.setTextColor(255, 255, 255);
        headers.forEach((h, i) => {
            doc.text(h, x, y);
            x += colWidths[i];
        });
        y += 8;
        doc.setTextColor(0, 0, 0);
        
        let totalSqm = 0;
        items.forEach(it => {
            x = 20;
            const rowSqm = parseFloat(it.sqm) * it.qty;
            totalSqm += rowSqm;
            
            doc.text(it.desc.substring(0, 20), x, y); x += colWidths[0];
            doc.text(`${it.h}√ó${it.w}`, x, y); x += colWidths[1];
            doc.text(it.qty.toString(), x, y); x += colWidths[2];
            doc.text(it.prof.substring(0, 15), x, y); x += colWidths[3];
            doc.text(it.mode, x, y); x += colWidths[4];
            doc.text(rowSqm.toFixed(3), x, y);
            
            y += 8;
            if (y > 280) {
                doc.addPage();
                y = 20;
            }
        });
        
        y += 5;
        doc.setFontSize(11);
        doc.text(`Total SQM (m¬≤): ${totalSqm.toFixed(3)}`, 20, y);
        doc.text(`Total Parts: ${items.length}`, 20, y + 10);
        
        // ===== PAGE 2: SUPPLY DOCKET =====
        doc.addPage();
        y = 20;
        doc.setFontSize(18);
        doc.text('SUPPLY DOCKET', 20, y);
        y += 10;
        doc.setFontSize(10);
        doc.text(`Client: ${job.client}`, 20, y);
        y += 5;
        doc.text(`Job #: ${job.jobNum} - ${job.jobName}`, 20, y);
        y += 5;
        doc.text(`Paint: ${job.brand} - ${job.color}`, 20, y);
        y += 5;
        doc.text(`Code: ${job.code} | Finish: ${job.finish}`, 20, y);
        y += 10;
        
        doc.setFontSize(9);
        x = 20;
        doc.setFillColor(0, 0, 0);
        doc.setTextColor(255, 255, 255);
        headers.forEach((h, i) => {
            doc.text(h, x, y);
            x += colWidths[i];
        });
        y += 8;
        doc.setTextColor(0, 0, 0);
        
        items.forEach(it => {
            x = 20;
            const rowSqm = parseFloat(it.sqm) * it.qty;
            
            doc.text(it.desc.substring(0, 20), x, y); x += colWidths[0];
            doc.text(`${it.h}√ó${it.w}`, x, y); x += colWidths[1];
            doc.text(it.qty.toString(), x, y); x += colWidths[2];
            doc.text(it.prof.substring(0, 15), x, y); x += colWidths[3];
            doc.text(it.mode, x, y); x += colWidths[4];
            doc.text(rowSqm.toFixed(3), x, y);
            
            y += 8;
            if (y > 280) {
                doc.addPage();
                y = 20;
            }
        });
        
        // ===== PAGE 3: MIXING CARD =====
        doc.addPage();
        y = 20;
        doc.setFontSize(18);
        doc.text('MIXING CARD - PAINT SHOP', 20, y);
        y += 12;
        doc.setFontSize(11);
        doc.text(`Brand: ${job.brand}`, 20, y);
        y += 6;
        doc.text(`Color: ${job.color}`, 20, y);
        y += 6;
        doc.text(`Code/Formula: ${job.code}`, 20, y);
        y += 6;
        doc.text(`Finish: ${job.finish}`, 20, y);
        y += 12;
        
        doc.setFontSize(9);
        doc.text(`Total SQM (m¬≤) Required: ${totalSqm.toFixed(3)}`, 20, y);
        y += 6;
        doc.text(`Jobs/Items: ${items.length}`, 20, y);
        y += 10;
        
        doc.setFontSize(10);
        doc.text(`Date: ${new Date().toLocaleDateString('en-AU')}`, 20, y);
        y += 6;
        doc.text(`Prepared by: ___________________`, 20, y);
        y += 6;
        doc.text(`Mixed by: ___________________`, 20, y);
        
        // Save combined PDF to localStorage instead of auto-download
        const filename = `Job_${job.jobNum}_${job.client.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        
        // Store PDF in localStorage or just skip auto-download
        try {
            const pdfData = doc.output('datauristring');
            // Could store in localStorage if needed, but for now just acknowledge it's ready
        } catch(e) {
        }
    }

    function alertAdmins(job) {
        const adminAlert = {
            timestamp: new Date().toISOString(),
            type: 'JOB_COMPLETED',
            jobNum: job.jobNum,
            jobName: job.jobName,
            client: job.client,
            totalSqm: job.totalSqm,
            totalParts: job.totalParts,
            completedDate: new Date().toLocaleString('en-AU'),
            message: `üéâ Job #${job.jobNum} (${job.jobName}) for ${job.client} has been COMPLETED. ${job.totalParts} parts, ${job.totalSqm} SQM (m¬≤). PDFs generated.`
        };
        
        // Store admin alerts in localStorage
        let adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        adminAlerts.unshift(adminAlert);
        adminAlerts = adminAlerts.slice(0, 100); // Keep last 100 alerts
        localStorage.setItem('adminAlerts', JSON.stringify(adminAlerts));
        
        // In a real app, this would send to a server/notification service
        
        // Show toast-style notification
        showAdminAlert(adminAlert.message);
    }
    
    // Generic function for all notification types
    function addAdminAlert(type, message, details = {}) {
        const adminAlert = {
            timestamp: new Date().toISOString(),
            type: type,
            message: message,
            ...details
        };
        let adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        adminAlerts.unshift(adminAlert);
        adminAlerts = adminAlerts.slice(0, 100);
        localStorage.setItem('adminAlerts', JSON.stringify(adminAlerts));
        showAdminAlert(message);
    }

    function showAdminAlert(message) {
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = 'position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:#34c759; color:#fff; padding:15px 25px; border-radius:30px; font-weight:900; z-index:4000; font-size:12px; border:2px solid #28a745; box-shadow:0 4px 15px rgba(52, 199, 89, 0.4);';
        alertDiv.innerText = message;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 4000);
    }

    function toggleAdminAlerts() {
        const container = document.getElementById('admin-alerts-container');
        const btn = event.target;
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btn.innerText = '‚àí';
        } else {
            container.style.display = 'none';
            btn.innerText = '+';
        }
    }

    function updateVersionDisplay() {
        const CURRENT_VERSION = 'v1.7.24';
        const CURRENT_DATE = '2026-02-27';
        
        const versionDisplay = document.getElementById('adminVersionDisplay');
        const versionDate = document.getElementById('adminVersionDate');
        
        if (versionDisplay) versionDisplay.innerText = CURRENT_VERSION;
        if (versionDate) versionDate.innerText = CURRENT_DATE;
        
        // Also update localStorage version
        localStorage.setItem('paintworkz_version', CURRENT_VERSION);
        
        console.log(`‚úÖ Version display updated: ${CURRENT_VERSION} | ${CURRENT_DATE}`);
    }
    
    function renderAdminAlerts() {
        const adminAlertsDiv = document.getElementById('admin-alerts');
        if (!adminAlertsDiv) return;
        
        const alerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        
        if (alerts.length === 0) {
            adminAlertsDiv.innerHTML = '<div class="card"><p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p></div>';
            return;
        }
        
        adminAlertsDiv.innerHTML = '';
        alerts.forEach((alert, i) => {
            const alertDate = new Date(alert.timestamp);
            let icon = 'üìå';
            let bgColor = '#f0f0f0';
            let borderColor = '#999';
            
            if (alert.type === 'JOB_COMPLETED') {
                icon = '‚úÖ';
                bgColor = '#f0fdf4';
                borderColor = '#34c759';
            } else if (alert.type === 'JOB_SAVED') {
                icon = '‚úÖ';
                bgColor = '#f0fdf4';
                borderColor = '#34c759';
            } else if (alert.type === 'JOB_UPDATED') {
                icon = '‚úèÔ∏è';
                bgColor = '#fffbf0';
                borderColor = '#ffc107';
            } else if (alert.type === 'NEW_CLIENT') {
                icon = 'üë§';
                bgColor = '#f0fdf4';
                borderColor = '#34c759';
            } else if (alert.type === 'CLIENT_DELETED') {
                icon = 'üóëÔ∏è';
                bgColor = '#fdf0f0';
                borderColor = '#ff3b30';
            } else if (alert.type === 'PROFILE_ADDED') {
                icon = 'üö™';
                bgColor = '#fff3e0';
                borderColor = '#ff9800';
            }
            
            adminAlertsDiv.innerHTML += `<div class="card" style="border-left:5px solid ${borderColor}; background:${bgColor}; margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                    <div style="flex:1;">
                        <div style="font-weight:900; color:#000; font-size:13px;">${icon} ${alert.message}</div>
                    </div>
                    <div style="font-size:10px; color:#888; font-weight:700; text-align:right; white-space:nowrap; margin-left:10px;">
                        <div>${alertDate.toLocaleDateString('en-AU')}</div>
                        <div>${alertDate.toLocaleTimeString('en-AU', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                </div>
            </div>`;
        });
    }

    function refreshLists() {
        console.log(`üîÑ REFRESHING LISTS (refreshLists called)`);
        console.log(`  Current profiles array:`, profiles);
        
        const cliSel = document.getElementById('cli'); 
        console.log(`  ‚úì Found cli dropdown element`);
        cliSel.innerHTML = '';
        clients.sort().forEach(c => { 
            let o = document.createElement('option'); 
            o.innerText=c; 
            cliSel.appendChild(o); 
        });
        
        const profSel = document.getElementById('prof-select'); 
        if (!profSel) {
            console.error('  ‚úó CRITICAL: prof-select element NOT FOUND!');
            return;
        }
        console.log(`  ‚úì Found prof-select dropdown element`);
        
        profSel.innerHTML = '';
        
        if (profiles.length === 0) {
            console.warn('  ‚ö†Ô∏è WARNING: profiles array is EMPTY!');
        }
        
        profiles.forEach((p, idx) => { 
            let o = document.createElement('option'); 
            o.value=p; 
            o.innerText=p; 
            profSel.appendChild(o); 
        });
        
        // Set default door profile to first available
        if (profSel.options.length > 0) {
            profSel.value = profSel.options[0].value;
        }
        
        
        if (profSel.options.length === 0 && profiles.length > 0) {
            console.error('  ‚úó CRITICAL ERROR: profiles.length=${profiles.length} but prof-select has 0 options!');
        }
        
        renderDB();
        console.log(`  ‚úì renderDB() called`);
    }


    // Navigate to Forms tab when PDF icon clicked
    function genPDF() {
        // Show a quick form selection modal from footer
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:8px; z-index:10000; box-shadow:0 4px 20px rgba(0,0,0,0.3); min-width:300px;';
        
        modal.innerHTML = `
            <h3 style="margin-top:0; text-align:center;">Quick PDF Generation</h3>
            <div style="display:grid; gap:10px;">
                <button onclick="genForm('Estimate'); closeFormModal();" style="padding:10px; background:#2196f3; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">üìä Estimate</button>
                <button onclick="genForm('Supply Docket'); closeFormModal();" style="padding:10px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">üìã Supply Docket</button>
                <button onclick="genForm('Mixing Card'); closeFormModal();" style="padding:10px; background:#FF9800; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">üé® Mixing Card</button>
                <button onclick="genForm('Invoice'); closeFormModal();" style="padding:10px; background:#9C27B0; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">üí∞ Invoice</button>
                <button onclick="genForm('Quote Form'); closeFormModal();" style="padding:10px; background:#00BCD4; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">üí¨ Quote Form</button>
                <button onclick="genForm('Cover Sheet'); closeFormModal();" style="padding:10px; background:#FFC107; color:#000; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">üìã Cover Sheet</button>
                <button onclick="genForm('Shop Label'); closeFormModal();" style="padding:10px; background:#E91E63; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">üè∑Ô∏è Shop Label</button>
                <button onclick="closeFormModal()" style="padding:10px; background:#999; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:bold;">Cancel</button>
            </div>
        `;
        
        modal.id = 'quickPDFModal';
        document.body.appendChild(modal);
    }
    
    function closeFormModal() {
        const modal = document.getElementById('quickPDFModal');
        if (modal) modal.remove();
    }

    function tab(t) {
        document.querySelectorAll('.view-section, .nav-btn').forEach(x => x.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.getElementById('btn-' + t).classList.add('active');
        
        // Populate paint brands dropdown when Measure tab is opened
        if (t === 'measure') {
            setTimeout(() => populatePaintBrandsDropdown(), 100);
        }
        
        // Show/hide version display - only in admin tab
        const versionDisplay = document.getElementById('footerVersionDisplay');
        if (versionDisplay) {
            versionDisplay.style.display = (t === 'admin') ? 'block' : 'none';
        }
        
        // Show/hide workload summary based on active tab
        const workloadContainer = document.getElementById('workloadSummaryContainer');
        if (workloadContainer) {
            if (t === 'schedule' || t === 'admin') {
                workloadContainer.style.display = 'block';
            } else {
                workloadContainer.style.display = 'none';
            }
        }
        
        // Render admin alerts when viewing admin tab
        if (t === 'admin') {
            renderAdminAlerts();
        }
        
        // Render schedule calendar and jobs chart when viewing schedule tab
        if (t === 'schedule') {
            renderScheduleCalendar();
        }
        
        // ALWAYS update workload summary when switching to schedule or admin tabs
        if (t === 'schedule' || t === 'admin') {
            renderJobTasks();
            console.log('üîÑ Updated workload summary for tab: ' + t);
        }
    }

    function subTab(t) {
        document.querySelectorAll('.sub-section').forEach(x => x.style.display = 'none');
        document.querySelectorAll('.sub-btn').forEach(x => x.classList.remove('active'));
        document.getElementById('sub-' + t).style.display = 'block';
        document.getElementById('sub-btn-' + t).classList.add('active');
        
        // Special handling for paint tab
        if (t === 'paint') {
            renderPaintFormulaList();
        }
    }

    // DATABASE OPS
    function renderDB() {
        console.log(`üìã renderDB() called`);
        console.log(`  profiles array:`, profiles);
        
        const cL = document.getElementById('list-clients'); 
        if (!cL) {
            console.error('  ‚úó CRITICAL: list-clients element NOT FOUND!');
            return;
        }
        cL.innerHTML = '';
        clients.sort().forEach((c, i) => { 
            cL.innerHTML += `<div class="db-item"><span>${c}</span></div>`; 
        });
        
        const pL = document.getElementById('list-profiles'); 
        if (!pL) {
            console.error('  ‚úó CRITICAL: list-profiles element NOT FOUND!');
            return;
        }
        pL.innerHTML = '';
        
        if (profiles.length === 0) {
            console.warn('  ‚ö†Ô∏è profiles array is EMPTY! Will show empty list');
            pL.innerHTML = '<p style="color:#999; text-align:center; font-size:11px;">No profiles yet. Add one above.</p>';
        } else {
            profiles.sort().forEach((p, i) => { 
                pL.innerHTML += `<div class="db-item" style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="flex:1;">${p}</span>
                    <button onclick="editProfile('${p}')" style="padding:2px 8px; background:#2196f3; color:#fff; border:none; border-radius:3px; font-size:9px; font-weight:900; cursor:pointer; margin-right:4px;">EDIT</button>
                </div>`; 
            });
        }
    }

    function addClient() { 
        let v = document.getElementById('new-client').value.trim(); 
        if(v && !clients.includes(v)){ 
            clients.push(v); 
            document.getElementById('new-client').value=''; 
            refreshLists();
            addAdminAlert('NEW_CLIENT', `‚úÖ NEW CLIENT ADDED: "${v}"`, {clientName: v});
        } else if (clients.includes(v)) {
            notify('Client Already Exists');
        }
    }
    
    function delCli(name) { 
        if(confirm("Delete " + name + "?")){ 
            clients = clients.filter(x => x !== name); 
            refreshLists();
            notify('Client Deleted');
        } 
    }
    
    function addProfile() { 
        let v = document.getElementById('new-profile').value.trim(); 
        if(v && !profiles.includes(v)){ 
            profiles.push(v); 
            console.log(`  Current profiles:`, profiles);
            
            saveProfilesToStorage(); // SAVE TO LOCALSTORAGE
            console.log(`  ‚úì Saved to localStorage`);
            
            document.getElementById('new-profile').value=''; 
            refreshLists();
            console.log(`  ‚úì Refreshed lists (dropdown should update)`);
            
            // Show global notification in red
            addAdminAlert('PROFILE_ADDED', `üö™ NEW DOOR PROFILE ADDED: "${v}"`, {profileName: v});
            
            // Update unallocated doors in price matrix if visible
            renderPricingMatrix();
            console.log(`  ‚úì Rendered price matrix`);
        } else if (profiles.includes(v)) {
            console.log(`  ‚úó Door already exists in profiles`);
            notify('Profile Already Exists');
        } else {
            console.log(`  ‚úó Empty input`);
        }
    }
    
    function delProf(name) { 
        if(confirm(`üö® PERMANENTLY DELETE: "${name}"?\n\nThis will remove it from your database!`)){ 
            console.log(`  ‚úì User confirmed deletion from database`);
            profiles = profiles.filter(x => x !== name); 
            saveProfilesToStorage();
            refreshLists();
            notify(`üóëÔ∏è ${name} deleted from database`);
        } else {
            console.log(`  ‚úó Deletion cancelled`);
        }
    }
    
    function editProfile(oldName) {
        const newName = prompt(`Rename profile:\n\n${oldName}`, oldName);
        if (newName && newName.trim() !== '') {
            const trimmed = newName.trim();
            if (trimmed === oldName) {
                return; // No change
            }
            if (profiles.includes(trimmed)) {
                alert('Profile name already exists');
                return;
            }
            profiles = profiles.map(p => p === oldName ? trimmed : p);
            refreshLists();
            notify('Profile Renamed');
        }
    }

    function setFM(v) {
        fmState = v;
        document.querySelectorAll('.fm-opt').forEach(o => o.classList.remove('active'));
        document.getElementById(v==='Flat'?'fm-flat':'fm-mould').classList.add('active');
        up();
    }

    function setP(t) {
        pType = t;
        document.querySelectorAll('.p-card').forEach(c => c.classList.remove('active'));
        const map = {'Panel':'pP', 'Door':'pD', 'Drawer':'pDr', 'Custom':'pC'};
        document.getElementById(map[t]).classList.add('active');
        const allE = ['E1','E2','E3','E4'];
        allE.forEach(id => document.getElementById(id).classList.remove('active'));
        if(t === 'Door' || t === 'Drawer') allE.forEach(id => document.getElementById(id).classList.add('active'));
        else if (mode === 'SE') document.getElementById('E1').classList.add('active');
        up();
    }

    function setM(m) {
        mode = m;
        document.querySelectorAll('.mode-sel').forEach(b => b.classList.remove('active'));
        document.getElementById('m' + m).classList.add('active');
        // REQUIREMENT: SE auto-selects one long edge by default
        if (m === 'SE') {
            document.getElementById('E1').classList.add('active'); 
        }
        up();
    }
    
    function tE(el) { 
        el.classList.toggle('active'); 
        up(); 
    }

    function up() {
        const h = parseFloat(document.getElementById('h').value) || 0;
        const w = parseFloat(document.getElementById('w').value) || 0;
        const thk = parseFloat(document.getElementById('thk').value) || 18;
        const eL = (document.getElementById('E1').classList.contains('active')?1:0) + (document.getElementById('E2').classList.contains('active')?1:0);
        const eS = (document.getElementById('E3').classList.contains('active')?1:0) + (document.getElementById('E4').classList.contains('active')?1:0);
        let area = (h * w);
        if(mode === 'DS') area *= 2;
        const defaults = loadDefaultSettings();
        if(mode === 'SE') area += ((eL * h) + (eS * w)) * defaults.seReturn;
        area += ((eL * h * thk) + (eS * w * thk));
        if (document.getElementById('liveSq')) document.getElementById('liveSq').innerText = (area / 1000000).toFixed(3);
    }
    
    // ===== CAMERA FUNCTIONALITY WITH TIMESTAMPS =====
    let jobPhotos = [];
    
    function snap() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const timestamp = new Date().toLocaleString('en-AU');
                    const photo = {
                        id: Date.now(),
                        data: event.target.result,
                        timestamp: timestamp,
                        linkedPart: null
                    };
                    jobPhotos.push(photo);
                    renderPhotoGallery();
                    notify(`üì∏ Photo captured: ${timestamp}`);
                };
                reader.readAsDataURL(file);
            }
        };
        input.click();
    }
    
    function renderPhotoGallery() {
        const container = document.getElementById('jobPhotosContainer');
        if (!container) return;
        
        if (jobPhotos.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999; font-size:11px; padding:10px;">No photos yet</p>';
            return;
        }
        
        let html = `<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:10px; margin-bottom:10px;">`;
        
        jobPhotos.forEach((photo, idx) => {
            html += `
                <div style="position:relative; cursor:pointer; border-radius:6px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
                    <img src="${photo.data}" style="width:100%; height:100%; object-fit:cover;" onclick="viewPhoto(${photo.id})">
                    <div style="position:absolute; top:2px; right:2px; background:rgba(0,0,0,0.7); color:#fff; font-size:8px; padding:2px 4px; border-radius:3px;">${jobPhotos.length}</div>
                    <button onclick="deletePhoto(${photo.id})" style="position:absolute; bottom:2px; right:2px; background:#ff3b30; border:none; color:#fff; padding:2px 4px; border-radius:3px; font-size:9px; cursor:pointer;">‚úï</button>
                </div>
            `;
        });
        
        html += `</div>`;
        html += `<p style="font-size:9px; color:#666; margin:10px 0 0 0;">üì∑ ${jobPhotos.length} photo${jobPhotos.length !== 1 ? 's' : ''} | Latest: ${jobPhotos[jobPhotos.length-1]?.timestamp}</p>`;
        
        container.innerHTML = html;
    }
    
    function viewPhoto(photoId) {
        const photo = jobPhotos.find(p => p.id === photoId);
        if (!photo) return;
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px;';
        modal.onclick = () => modal.remove();
        
        modal.innerHTML = `
            <div style="background:#fff; border-radius:8px; padding:0; max-width:90vw; max-height:90vh; display:flex; flex-direction:column;">
                <img src="${photo.data}" style="width:100%; height:auto; max-height:70vh; object-fit:contain; border-radius:8px 8px 0 0;">
                <div style="padding:15px; text-align:center;">
                    <p style="margin:0 0 10px 0; color:#666; font-size:12px;">üì∏ ${photo.timestamp}</p>
                    <button onclick="this.parentElement.parentElement.remove()" style="background:#007AFF; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold;">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    function deletePhoto(photoId) {
        jobPhotos = jobPhotos.filter(p => p.id !== photoId);
        renderPhotoGallery();
        notify('üì∏ Photo deleted');
    }
    
    function saveJobPhotos() {
        if (jobPhotos.length > 0) {
            const jobNum = document.getElementById('jN')?.value || 'job';
            localStorage.setItem(`jobPhotos_${jobNum}`, JSON.stringify(jobPhotos));
            notify(`‚úì ${jobPhotos.length} photo${jobPhotos.length !== 1 ? 's' : ''} saved`);
        }
    }
    
    function loadJobPhotos() {
        const jobNum = document.getElementById('jN')?.value;
        if (jobNum) {
            const saved = localStorage.getItem(`jobPhotos_${jobNum}`);
            if (saved) {
                jobPhotos = JSON.parse(saved);
                renderPhotoGallery();
            }
        }
    }

    function addPart() {
        const h = document.getElementById('h').value;
        const w = document.getElementById('w').value;
        const prof = document.getElementById('prof-select').value;
        const desc = document.getElementById('desc').value || "Part";
        
        if(!h || !w) return;
        const edges = [
            document.getElementById('E1').classList.contains('active'),
            document.getElementById('E2').classList.contains('active'),
            document.getElementById('E3').classList.contains('active'),
            document.getElementById('E4').classList.contains('active')
        ];
        // REQUIREMENT: Deduplication (Add 1 to existing if identical)
        let existing = items.find(it => 
            it.h === h && it.w === w && it.prof === prof && 
            it.fm === fmState && it.mode === mode && 
            JSON.stringify(it.e) === JSON.stringify(edges)
        );
        if (existing) {
            existing.qty += (parseInt(document.getElementById('qty').value) || 1);
            notify("Qty Updated");
        } else {
            const liveSqElement = document.getElementById('liveSq');
            const sqmValue = liveSqElement ? liveSqElement.innerText : '0.000';
            
            items.push({
                h, w, qty: (parseInt(document.getElementById('qty').value) || 1),
                desc: desc.toUpperCase(), prof: prof, fm: fmState,
                mode: mode, e: edges, sqm: sqmValue,
                brand: document.getElementById('p-brand').value,
                color: document.getElementById('p-color').value,
                code: document.getElementById('p-code').value,
                finish: document.getElementById('p-finish').value,
                type: pType,
                thk: document.getElementById('thk').value
            });
            notify("Part Added");
        }
        console.log('After addPart - Total items: ' + items.length);
        render();
        saveData(); // Auto-save to LocalStorage
        
        // Reset for next entry: qty back to 1, clear other fields
        document.getElementById('qty').value = '1';
        document.getElementById('h').value = ''; 
        document.getElementById('w').value = '';
        document.getElementById('desc').value = '';
        const defaults = loadDefaultSettings();
        document.getElementById('thk').value = defaults.thickness;  // Reset to default thickness
        
        // Focus on length (h) input for continuous data entry
        setTimeout(() => {
            const hInput = document.getElementById('h');
            if (hInput) hInput.focus();
        }, 50);
    }

    function filterPanels(filterType) {
        currentPanelFilter = filterType;
        
        // Update button styles - restore from data attributes
        const clickedBtn = event.target.tagName === 'BUTTON' ? event.target : event.target.closest('button');
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            // Restore original colors from data attributes
            const originalBg = btn.getAttribute('data-bg');
            const originalColor = btn.getAttribute('data-color');
            btn.style.background = originalBg;
            btn.style.color = originalColor;
            btn.style.fontWeight = '900';
        });
        
        if (clickedBtn) {
            // Clicked button gets highlighted with blue
            clickedBtn.style.background = '#2196f3';
            clickedBtn.style.color = '#fff';
            clickedBtn.style.fontWeight = '900';
        }
        
        render(); // Re-render with filter applied
    }
    
    // ===== COLOUR FILTER FUNCTIONS =====
    function updateColourDropdown() {
        const dropdown = document.getElementById('colourFilter');
        if (!dropdown) return;
        
        // Get unique colours from all items (not just filtered ones)
        const colours = [...new Set(items.map(it => it.color).filter(c => c && c.trim()))];
        colours.sort(); // Sort alphabetically
        
        // Save current selection
        const currentValue = dropdown.value;
        
        // Keep the "ALL" option
        dropdown.innerHTML = '<option value="">-- ALL --</option>';
        
        // Add each unique colour
        colours.forEach(colour => {
            const option = document.createElement('option');
            option.value = colour;
            option.textContent = colour;
            dropdown.appendChild(option);
        });
        
        // Restore selection if it still exists
        if (currentValue && colours.includes(currentValue)) {
            dropdown.value = currentValue;
        } else {
            dropdown.value = '';
        }
    }
    
    function filterByColour(colour) {
        currentColorFilter = colour;
        render(); // Re-render with colour filter applied
    }
    
    // ===== END COLOUR FILTER FUNCTIONS =====

    function calculateItemSQM(item) {
        // Recalculate SQM from scratch based on item properties
        const h = parseFloat(item.h) || 0;
        const w = parseFloat(item.w) || 0;
        const thk = parseFloat(item.thk) || 0;
        const mode = item.mode || 'SS';
        const edges = item.e || [false, false, false, false];
        
        // Base area
        let area = h * w;
        
        // Apply mode multiplier
        if (mode === 'DS') {
            area *= 2;  // Double-sided = double the area
        }
        
        // Load defaults for SE return
        const defaults = loadDefaultSettings();
        
        // Add edge areas for SE mode
        if (mode === 'SE') {
            const eL = (edges[0] ? 1 : 0) + (edges[1] ? 1 : 0);  // Left edges
            const eS = (edges[2] ? 1 : 0) + (edges[3] ? 1 : 0);  // Side edges
            area += ((eL * h) + (eS * w)) * defaults.seReturn;
        }
        
        // Add edge band area for all modes
        const eL = (edges[0] ? 1 : 0) + (edges[1] ? 1 : 0);  // Left edges
        const eS = (edges[2] ? 1 : 0) + (edges[3] ? 1 : 0);  // Side edges
        area += ((eL * h * thk) + (eS * w * thk));
        
        // Convert to m¬≤
        return area / 1000000;
    }
    
    function render() {
        console.log('RENDER() called - items.length: ' + items.length);
        const l = document.getElementById('list');
        if (!l) return; // Exit if list doesn't exist (not on measure tab)
        
        // Ensure paint brands dropdown is populated
        populatePaintBrandsDropdown();
        
        // IMPORTANT: Recalculate ALL item SQM values to ensure DS multiplier is applied correctly
        // This fixes historical issues where SQM was saved without DS multiplier
        items.forEach(item => {
            const calculatedSqm = calculateItemSQM(item);
            item.sqm = calculatedSqm.toFixed(3);
        });
        
        l.innerHTML = '';
        let tA = 0, tQ = 0;
        
        // Apply filter to items
        let filteredItems = items;
        if (currentPanelFilter !== 'all') {
            filteredItems = items.filter(it => {
                const filter = currentPanelFilter.toLowerCase();
                
                // Type filters: check it.type field (Door, Panel, Drawer, Custom)
                if (filter === 'panel' || filter === 'door' || filter === 'drawer' || filter === 'custom') {
                    return it.type.toLowerCase() === filter;
                } 
                // Finish filters: check it.fm field (Moulded, Flat)
                else if (filter === 'moulded' || filter === 'flat') {
                    return it.fm.toLowerCase() === filter;
                } 
                // Mode filters: check it.mode field (SS, DS, SE)
                else if (filter === 'ss' || filter === 'ds' || filter === 'se') {
                    return it.mode === filter.toUpperCase();
                }
                return true;
            });
        }
        
        // Apply colour filter on top of existing filters
        if (currentColorFilter) {
            filteredItems = filteredItems.filter(it => (it.color || '') === currentColorFilter);
        }
        
        // Update colour dropdown with available colours from ALL items (not just filtered)
        updateColourDropdown();
        
        filteredItems.forEach((it, i) => {
            const originalIndex = items.indexOf(it);
            // Use the recalculated SQM (already updated above)
            const rowSqm = parseFloat(it.sqm) * it.qty; 
            tA += rowSqm; 
            tQ += it.qty;
            
            // Get color for panel type
            const typeColors = {
                'panel': '#34c759',
                'door': '#ff9500',
                'drawer': '#2196f3',
                'custom': '#af52de'
            };
            const clr = typeColors[it.type.toLowerCase()] || '#666';
            
            // Count edges properly
            const leftEdgeCount = (it.e[0]?1:0) + (it.e[1]?1:0);  // E1=Top-Left, E2=Bottom-Left
            const sideEdgeCount = (it.e[2]?1:0) + (it.e[3]?1:0);  // E3=Top-Right, E4=Bottom-Right
            
            let mC = it.mode === 'SS' ? '#34c759' : (it.mode === 'DS' ? '#ff9500' : '#ff3b30');
            
            // Build edge badges - SEPARATE and COLORED with LR/SR for SE mode
            let edgeBadgesHTML = '';
            if (leftEdgeCount > 0) {
                const leftLabel = it.mode === 'SE' ? 'LR' : 'L';
                edgeBadgesHTML += `<span class="edge-pill" style="background:#f44336; color:#fff; font-weight:900; padding:2px 6px; border-radius:3px; font-size:10px;">${leftEdgeCount}${leftLabel}</span>`;
            }
            if (sideEdgeCount > 0) {
                const sideLabel = it.mode === 'SE' ? 'SR' : 'S';
                edgeBadgesHTML += `<span class="edge-pill" style="background:#2196f3; color:#fff; font-weight:900; padding:2px 6px; border-radius:3px; font-size:10px;">${sideEdgeCount}${sideLabel}</span>`;
            }
            if (leftEdgeCount === 0 && sideEdgeCount === 0) {
                edgeBadgesHTML += `<span class="edge-pill" style="background:#eee; color:#999; padding:2px 6px; border-radius:3px; font-size:10px;">No edges</span>`;
            }
            
            l.innerHTML += `<div class="part-label" style="border-left:5px solid ${clr}">
                <div class="qty-controls">
                    <button class="qty-btn" style="border-radius:4px 4px 0 0;" onclick="changeQty(${originalIndex}, 1)">+</button>
                    <div class="pl-qty" style="margin:0; border-radius:0;">${it.qty}</div>
                    <button class="qty-btn" style="border-radius:0 0 4px 4px;" onclick="changeQty(${originalIndex}, -1)">‚àí</button>
                </div>
                <div class="pl-center">
                    <div style="font-size:10px; font-weight:900; color:${clr}; text-transform:uppercase; line-height:1;">${it.desc} (${it.fm})</div>
                    <div style="font-size:10px; font-weight:700; color:#666; margin-bottom:2px;">${it.brand} - ${it.color} ‚Ä¢ ${it.finish}</div>
                    <div class="pl-dims">${it.h} √ó ${it.w} √ó ${it.thk}</div>
                    <div class="pl-meta">
                        <span style="font-weight:700; background:${clr}; color:#fff; padding:2px 6px; border-radius:3px; font-size:9px; text-transform:uppercase;">${it.type}</span>
                        <span style="font-weight:700;">${it.prof}</span>
                        <div style="display:flex; gap:4px; margin-top:4px;">
                            ${edgeBadgesHTML}
                        </div>
                    </div>
                </div>
                <div class="pl-right">
                    <div class="pl-mode" style="color:${mC}; border-color:${mC}; background:${mC}15">${it.mode}</div>
                    <div style="font-size:11px; font-weight:900;">${rowSqm.toFixed(3)}</div>
                </div>
                <button class="edit-btn" onclick="editItem(${originalIndex})" style="background:#2196f3; color:#fff; border:none; padding:8px 10px; border-radius:4px 0 0 4px; font-weight:900; cursor:pointer; font-size:12px;">‚úé</button><button class="del-btn" onclick="deleteItem(${originalIndex})">√ó</button>
            </div>`;
        });
        
        if (document.getElementById('tA')) document.getElementById('tA').innerText = tA.toFixed(3);
        if (document.getElementById('tQ')) document.getElementById('tQ').innerText = tQ;
    }

    function changeQty(index, delta) { 
        try {
            if (index < 0 || index >= items.length) {
                console.error('Invalid item index:', index);
                return;
            }
            items[index].qty += delta; 
            if (items[index].qty < 1) items[index].qty = 1; 
            render();
            saveData();
        } catch(e) {
            console.error('Error changing quantity:', e);
            notify('‚ö†Ô∏è Error updating quantity');
        }
    }

    function editItem(index) {
        try {
            if (index < 0 || index >= items.length) {
                console.error('Invalid item index:', index);
                return;
            }
            
            const item = items[index];
            
            let profOptions = profiles.map(p => `<option value="${p}" ${p === item.prof ? 'selected' : ''}>${p}</option>`).join('');
            
            // Get paint brands for dropdown
            const brands = getPaintBrands();
            let brandOptions = brands.map(b => `<option value="${b}" ${b === item.brand ? 'selected' : ''}>${b}</option>`).join('');
            
            // Add current brand if it's not in the list
            if (item.brand && !brands.includes(item.brand)) {
                brandOptions = `<option value="${item.brand}" selected>${item.brand}</option>` + brandOptions;
            }
            
            // Add a blank option and Custom at the top
            brandOptions = `<option value="">-- Select Brand --</option>${brandOptions}<option value="Custom">Custom</option>`;
            
            // Get all unique colors from items for dropdown
            const uniqueColors = new Set();
            items.forEach(it => {
                if (it.color && it.color.trim()) {
                    uniqueColors.add(it.color.trim());
                }
            });
            const sortedColors = Array.from(uniqueColors).sort();
            let colorOptions = sortedColors.map(c => `<option value="${c}" ${c === item.color ? 'selected' : ''}>${c}</option>`).join('');
            
            // Add current color if it's not in the list
            if (item.color && !sortedColors.includes(item.color)) {
                colorOptions = `<option value="${item.color}" selected>${item.color}</option>` + colorOptions;
            }
            
            // Add a blank option at the top for "no color"
            colorOptions = `<option value="">-- Select Colour --</option>` + colorOptions;
            
            const html = `
                <div style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; padding:25px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.3); z-index:10001; width:90%; max-width:500px; max-height:85vh; overflow-y:auto;">
                    <h3 style="margin-top:0; margin-bottom:20px; color:#333;">‚úé Edit Part</h3>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block; font-weight:900; margin-bottom:8px; font-size:12px; color:#666;">PART TYPE</label>
                        <div style="display:flex; gap:6px;">
                            <button onclick="setEditType(${index}, 'Door')" id="editType-Door" style="flex:1; padding:8px; background:${item.type === 'Door' ? '#2196f3' : '#f0f0f0'}; color:${item.type === 'Door' ? '#fff' : '#000'}; border:none; border-radius:4px; font-weight:900; font-size:12px; cursor:pointer;">DOOR</button>
                            <button onclick="setEditType(${index}, 'Panel')" id="editType-Panel" style="flex:1; padding:8px; background:${item.type === 'Panel' ? '#34c759' : '#f0f0f0'}; color:${item.type === 'Panel' ? '#fff' : '#000'}; border:none; border-radius:4px; font-weight:900; font-size:12px; cursor:pointer;">PANEL</button>
                            <button onclick="setEditType(${index}, 'Drawer')" id="editType-Drawer" style="flex:1; padding:8px; background:${item.type === 'Drawer' ? '#2196f3' : '#f0f0f0'}; color:${item.type === 'Drawer' ? '#fff' : '#000'}; border:none; border-radius:4px; font-weight:900; font-size:12px; cursor:pointer;">DRAWER</button>
                            <button onclick="setEditType(${index}, 'Custom')" id="editType-Custom" style="flex:1; padding:8px; background:${item.type === 'Custom' ? '#af52de' : '#f0f0f0'}; color:${item.type === 'Custom' ? '#fff' : '#000'}; border:none; border-radius:4px; font-weight:900; font-size:12px; cursor:pointer;">CUSTOM</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block; font-weight:900; margin-bottom:8px; font-size:12px; color:#666;">PANEL TYPE</label>
                        <div style="display:flex; gap:6px;">
                            <button onclick="setEditPanelType(${index}, 'Flat')" id="editPanel-Flat" style="flex:1; padding:8px; background:${item.panelType === 'Flat' ? '#17a2b8' : '#f0f0f0'}; color:${item.panelType === 'Flat' ? '#fff' : '#000'}; border:none; border-radius:4px; font-weight:900; font-size:12px; cursor:pointer;">FLAT</button>
                            <button onclick="setEditPanelType(${index}, 'Moulded')" id="editPanel-Moulded" style="flex:1; padding:8px; background:${item.panelType === 'Moulded' ? '#17a2b8' : '#f0f0f0'}; color:${item.panelType === 'Moulded' ? '#fff' : '#000'}; border:none; border-radius:4px; font-weight:900; font-size:12px; cursor:pointer;">MOULDED</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block; font-weight:900; margin-bottom:8px; font-size:12px; color:#666;">PAINT MODE</label>
                        <div style="display:flex; gap:6px;">
                            <button onclick="setEditEdgeConfig(${index}, 'SS')" id="editEdge-SS" style="flex:1; padding:8px; background:${item.edgeConfig === 'SS' ? '#17a2b8' : '#f0f0f0'}; color:${item.edgeConfig === 'SS' ? '#fff' : '#000'}; border:none; border-radius:4px; font-weight:900; font-size:12px; cursor:pointer;">SS</button>
                            <button onclick="setEditEdgeConfig(${index}, 'SE')" id="editEdge-SE" style="flex:1; padding:8px; background:${item.edgeConfig === 'SE' ? '#17a2b8' : '#f0f0f0'}; color:${item.edgeConfig === 'SE' ? '#fff' : '#000'}; border:none; border-radius:4px; font-weight:900; font-size:12px; cursor:pointer;">SE</button>
                            <button onclick="setEditEdgeConfig(${index}, 'DS')" id="editEdge-DS" style="flex:1; padding:8px; background:${item.edgeConfig === 'DS' ? '#17a2b8' : '#f0f0f0'}; color:${item.edgeConfig === 'DS' ? '#fff' : '#000'}; border:none; border-radius:4px; font-weight:900; font-size:12px; cursor:pointer;">DS</button>
                            <button onclick="setEditEdgeConfig(${index}, 'Custom')" id="editEdge-Custom" style="flex:1; padding:8px; background:${item.edgeConfig === 'Custom' ? '#17a2b8' : '#f0f0f0'}; color:${item.edgeConfig === 'Custom' ? '#fff' : '#000'}; border:none; border-radius:4px; font-weight:900; font-size:12px; cursor:pointer;">CUSTOM</button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block; font-weight:900; margin-bottom:8px; font-size:12px; color:#666;">DESCRIPTION</label>
                        <input type="text" id="editDescInput" value="${item.desc}" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px; box-sizing:border-box;">
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block; font-weight:900; margin-bottom:8px; font-size:12px; color:#666;">DOOR PROFILE</label>
                        <select id="editProfSelect" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:4px; font-size:14px; box-sizing:border-box;">
                            ${profOptions}
                        </select>
                    </div>
                    
                    <div style="margin-bottom:15px; padding:15px; background:#f0f8ff; border-radius:6px; border-left:4px solid #2196f3;">
                        <label style="display:block; font-weight:900; margin-bottom:8px; font-size:12px; color:#333;">üé® PAINT DETAILS</label>
                        
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:900; margin-bottom:4px; font-size:11px; color:#666;">Brand</label>
                            <select id="editBrandInput" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:12px; box-sizing:border-box;">
                                ${brandOptions}
                            </select>
                        </div>
                        
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:900; margin-bottom:4px; font-size:11px; color:#666;">Colour</label>
                            <select id="editColorInput" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:12px; box-sizing:border-box;">
                                ${colorOptions}
                            </select>
                        </div>
                        
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:900; margin-bottom:4px; font-size:11px; color:#666;">Code/Formula</label>
                            <input type="text" id="editCodeInput" value="${item.code || ''}" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:12px; box-sizing:border-box;">
                        </div>
                        
                        <div>
                            <label style="display:block; font-weight:900; margin-bottom:4px; font-size:11px; color:#666;">Finish</label>
                            <select id="editFinishInput" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:12px; box-sizing:border-box;">
                                <option value="Satin" ${item.finish === 'Satin' ? 'selected' : ''}>Satin</option>
                                <option value="Gloss" ${item.finish === 'Gloss' ? 'selected' : ''}>Gloss</option>
                                <option value="Matt" ${item.finish === 'Matt' ? 'selected' : ''}>Matt</option>
                                <option value="20% Gloss" ${item.finish === '20% Gloss' ? 'selected' : ''}>20% Gloss</option>
                                <option value="30% Gloss" ${item.finish === '30% Gloss' ? 'selected' : ''}>30% Gloss</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-top:25px;">
                        <button onclick="confirmEditItem(${index})" style="flex:1; padding:12px; background:#34c759; color:#fff; border:none; border-radius:4px; font-weight:900; font-size:13px; cursor:pointer;">‚úì SAVE CHANGES</button>
                        <button onclick="closeEditModal()" style="flex:1; padding:12px; background:#ddd; color:#000; border:none; border-radius:4px; font-weight:900; font-size:13px; cursor:pointer;">‚úï CANCEL</button>
                    </div>
                </div>
                <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000;" onclick="closeEditModal()"></div>
            `;
            
            // Remove any existing modal
            const existing = document.getElementById('editItemModal');
            if (existing) existing.remove();
            
            const modal = document.createElement('div');
            modal.id = 'editItemModal';
            modal.innerHTML = html;
            document.body.appendChild(modal);
            
            // Auto-focus the description input
            setTimeout(() => {
                const input = document.getElementById('editDescInput');
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
            
        } catch(e) {
            console.error('Error editing item:', e);
            notify('‚ö†Ô∏è Error opening edit dialog');
        }
    }
    
    function setEditType(index, type) {
        items[index].type = type;
        ['Door', 'Panel', 'Drawer', 'Custom'].forEach(t => {
            const btn = document.getElementById(`editType-${t}`);
            if (btn) {
                const colors = { 'Door': '#2196f3', 'Panel': '#34c759', 'Drawer': '#2196f3', 'Custom': '#af52de' };
                if (t === type) {
                    btn.style.background = colors[t];
                    btn.style.color = '#fff';
                } else {
                    btn.style.background = '#f0f0f0';
                    btn.style.color = '#000';
                }
            }
        });
    }
    
    function confirmEditItem(index) {
        try {
            const select = document.getElementById('editProfSelect');
            const descInput = document.getElementById('editDescInput');
            const brandInput = document.getElementById('editBrandInput');
            const colorInput = document.getElementById('editColorInput');
            const codeInput = document.getElementById('editCodeInput');
            const finishInput = document.getElementById('editFinishInput');
            
            if (!select || !descInput) return;
            
            const newProf = select.value;
            const newDesc = descInput.value.trim();
            const newBrand = brandInput.value.trim() || 'Dulux';
            const newColor = colorInput.value.trim();
            const newCode = codeInput.value.trim();
            const newFinish = finishInput.value || 'Satin';
            
            if (!newDesc) {
                notify('‚ö†Ô∏è Description cannot be empty');
                return;
            }
            
            items[index].prof = newProf;
            items[index].desc = newDesc.toUpperCase();
            items[index].brand = newBrand;
            items[index].color = newColor;
            items[index].code = newCode;
            items[index].finish = newFinish;
            
            render();
            saveData();
            closeEditModal();
            notify(`‚úì Part updated: ${newDesc} (${newBrand} ${newColor})`);
            
        } catch(e) {
            console.error('Error confirming edit:', e);
            notify('‚ö†Ô∏è Error updating part');
        }
    }
    
    function closeEditModal() {
        const modal = document.getElementById('editItemModal');
        if (modal) modal.remove();
    }

    function setEditType(index, type) {
        if (items[index]) {
            items[index].type = type;
            document.querySelectorAll('[id^="editType-"]').forEach(btn => {
                btn.style.background = btn.id === `editType-${type}` ? '#2196f3' : '#f0f0f0';
                btn.style.color = btn.id === `editType-${type}` ? '#fff' : '#000';
            });
        }
    }

    function setEditPanelType(index, panelType) {
        if (items[index]) {
            items[index].panelType = panelType;
            document.querySelectorAll('[id^="editPanel-"]').forEach(btn => {
                btn.style.background = btn.id === `editPanel-${panelType}` ? '#17a2b8' : '#f0f0f0';
                btn.style.color = btn.id === `editPanel-${panelType}` ? '#fff' : '#000';
            });
        }
    }

    function setEditEdgeConfig(index, edgeConfig) {
        if (items[index]) {
            items[index].edgeConfig = edgeConfig;
            document.querySelectorAll('[id^="editEdge-"]').forEach(btn => {
                btn.style.background = btn.id === `editEdge-${edgeConfig}` ? '#17a2b8' : '#f0f0f0';
                btn.style.color = btn.id === `editEdge-${edgeConfig}` ? '#fff' : '#000';
            });
        }
    }

    
    function deleteItem(index) {
        try {
            if (index < 0 || index >= items.length) {
                console.error('Invalid item index:', index);
                return;
            }
            
            // Get item details for confirmation
            const item = items[index];
            const itemDesc = item.desc || `Part ${index + 1}`;
            
            // Show confirmation dialog
            if (!confirm(`‚ö†Ô∏è Delete part: "${itemDesc}"?\n\nThis cannot be undone.`)) {
                return; // User clicked Cancel
            }
            
            items.splice(index, 1);
            render();
            saveData();
            notify('‚úì Part deleted');
        } catch(e) {
            console.error('Error deleting item:', e);
            notify('‚ö†Ô∏è Error deleting part');
        }
    }

    function notify(m, duration = 1500) { 
        const t = document.getElementById('toast');
        if (!t) return; // Exit if toast doesn't exist
        t.innerText = m; 
        t.style.display = 'block'; 
        setTimeout(()=>t.style.display='none', duration); 
    }
    
    // Update job history and send notification
    function updateJobHistory(history, jobIndex, notificationMessage = null) {
        if (!history || jobIndex === null || jobIndex < 0 || jobIndex >= history.length) return;
        
        const job = history[jobIndex];
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        // Auto-generate notification if not provided
        if (notificationMessage === null) {
            notificationMessage = `‚úèÔ∏è JOB UPDATED #${job.jobNum}\n${job.client} ‚Ä¢ ${job.totalParts} parts`;
        }
        
        // Send global notification
        if (notificationMessage) {
            showGlobalNotification(notificationMessage, '#e3f2fd', '#2196f3');
        }
        
    }
    
    // Show global notification in visible banner (on all tabs)
    function showGlobalNotification(message, bgColor = '#ffebee', borderColor = '#ff3b30') {
        const banner = document.getElementById('globalNotificationsBanner');
        const notifList = document.getElementById('globalNotificationsList');
        
        if (!banner || !notifList) {
            console.warn('Global notifications banner not found');
            return;
        }
        
        // Show banner
        banner.style.display = 'block';
        
        const notifDiv = document.createElement('div');
        notifDiv.style.cssText = `
            background: ${bgColor};
            border-left: 5px solid ${borderColor};
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            font-size: 13px;
            color: #222;
            font-weight: 900;
            white-space: pre-line;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        `;
        
        const messageSpan = document.createElement('div');
        messageSpan.style.flex = '1';
        messageSpan.innerText = message;
        
        const dismissBtn = document.createElement('button');
        dismissBtn.innerText = '‚úï';
        dismissBtn.style.cssText = `
            background: ${borderColor};
            color: #fff;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 900;
            margin-left: 8px;
            font-size: 12px;
        `;
        dismissBtn.onclick = () => {
            notifDiv.remove();
            if (notifList.children.length === 0) {
                banner.style.display = 'none';
            }
        };
        
        // Auto-dismiss after 8 seconds
        setTimeout(() => {
            if (notifDiv.parentElement) {
                notifDiv.remove();
                if (notifList.children.length === 0) {
                    banner.style.display = 'none';
                }
            }
        }, 8000);
        
        notifDiv.appendChild(messageSpan);
        notifDiv.appendChild(dismissBtn);
        notifList.appendChild(notifDiv);
        
        console.log('‚úÖ Global notification shown:', message);
    }

    function getProfilePrice(profileName) {
        if (!pricingMatrix || pricingMatrix.length === 0) return 0;
        const row = pricingMatrix.find(p => p.profile === profileName);
        return (row && row.satin) ? parseFloat(row.satin) || 0 : 0;
    }

    function calculateLinePrice(item) {
        let pricePerSqm = 125;
        if (item.fm === 'Moulded' && item.mld) {
            const profilePrice = getProfilePrice(item.mld);
            if (profilePrice > 0) pricePerSqm = profilePrice;
        }
        const sqm = parseFloat(item.sqm) || 0;
        const qty = parseInt(item.qty) || 1;
        return {
            pricePerSqm: pricePerSqm,
            lineCost: sqm * qty * pricePerSqm
        };
    }
    
    function getFilteredItems() {
        // Returns items matching current panel and color filters
        let filtered = items;
        
        if (currentPanelFilter !== 'all') {
            filtered = items.filter(it => {
                const filter = currentPanelFilter.toLowerCase();
                if (filter === 'panel' || filter === 'door' || filter === 'drawer' || filter === 'custom') {
                    return it.type.toLowerCase() === filter;
                } else if (filter === 'moulded' || filter === 'flat') {
                    return it.fm.toLowerCase() === filter;
                } else if (filter === 'ss' || filter === 'ds' || filter === 'se') {
                    return it.mode === filter.toUpperCase();
                }
                return true;
            });
        }
        
        if (currentColorFilter) {
            filtered = filtered.filter(it => (it.color || '') === currentColorFilter);
        }
        
        return filtered;
    }

    // ===== ESTIMATE COSTING CALCULATIONS =====

    function genForm(type) {
        try {
            // Check if we have active filters and get filtered items
            const hasFilters = currentPanelFilter !== 'all' || currentColorFilter !== '';
            const itemsToUse = hasFilters ? getFilteredItems() : items;
            
            
            // Cover Sheet, Shop Label, and Mixing Card don't require parts/items
            if (itemsToUse.length === 0 && type !== 'Cover Sheet' && type !== 'Shop Label' && type !== 'Mixing Card' && type !== 'Paint Order') {
                notify('‚ùå No items match the current filter');
                return;
            }
            
            // Check if jsPDF is loaded
            if (!window.jspdf || typeof window.jspdf.jsPDF === 'undefined') {
                notify('‚ùå PDF library not loaded. Please refresh the page.');
                console.error('jsPDF not available');
                return;
            }
            
            // Store items to use globally for PDF functions
            window.pdfItemsToUse = itemsToUse;
            
            // Show charges modal for forms that need additional charges
            if (type === 'Estimate' || type === 'Quote Form' || type === 'Invoice') {
                showChargesModal(type);
            } else if (type === 'Supply Docket') {
                genSupplyDocket();
            } else if (type === 'Mixing Card') {
                genMixingCard();
            } else if (type === 'Cover Sheet') {
                genCoverSheet();
            } else if (type === 'Shop Label') {
                genShopLabel();
            } else if (type === 'Paint Order') {
                genPaintOrder();
            } else {
                notify('Form type not yet implemented');
            }
            
            // Clear the override after a brief delay to allow PDF functions to execute
            setTimeout(() => {
                window.pdfItemsToUse = null;
            }, 500);
        } catch(error) {
            console.error('‚ùå PDF Generation Error:', error);
            notify('PDF Error: ' + error.message);
        }
    }
    
    // ===== PDF HEADER WITH LOGO HELPER =====
    function addPDFHeader(doc, title, logoBase64) {
        try {
            doc.addImage(logoBase64, 'JPEG', 10, 8, 25, 23);
        } catch(e) {}
        
        let y = 45;
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(title, 55, y);
        y += 10;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('Paintworkz', 55, y);
        y += 4;
        doc.text('17 West Boundary Road, Hamilton 3300 VIC', 55, y);
        y += 4;
        doc.text('Phone: 0438 803 032', 55, y);
        y += 4;
        doc.text('Email: paint_workz@outlook.com', 55, y);
        y += 8;
        
        return y;
    }

    // ===== SUPPLY DOCKET =====

    // ===== INVOICE (stub) =====
    function genEstimate() {
        try {
            if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                notify('‚ùå PDF library not loaded');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const itemsForPDF = window.pdfItemsToUse || items;
            
            // Get company settings
            const companySettings = JSON.parse(localStorage.getItem('companySettings')) || {
                name: 'Paintworkz',
                address: '17 West Boundary Road, Hamilton 3300 VIC',
                phone: '0438 803 032',
                email: 'paint_workz@outlook.com'
            };
            
            // Get job info
            const jobClient = document.getElementById('cli')?.value || '';
            const jobNum = document.getElementById('jNum')?.value || document.getElementById('jN')?.value || '';
            const jobName = document.getElementById('jNm')?.value || '';
            
            // Collect all unique colours from items - group by colour AND finish
            const colourGroups = {};
            items.forEach(item => {
                const brand = item.brand || '';
                const color = item.color || '';
                const finish = item.finish || 'Satin';
                const colourKey = brand && color ? `${brand} ${color} ${finish}` : (color ? `${color} ${finish}` : 'No Colour');
                if (!colourGroups[colourKey]) {
                    colourGroups[colourKey] = [];
                }
                colourGroups[colourKey].push(item);
            });
            
            // Pricing matrix
            const pricingMatrix = {
                'Plain': 125,
                'Shaker 45': 171, 'Ashlee': 171, 'Bevelled Edge': 171,
                'Branxholme': 171, 'Hamilton': 171, 'Tarrone': 171
            };
            
            // Get ALL profiles
            const allProfiles = [...new Set(items
                .map(it => it.prof)
                .filter(p => p && p.trim())
            )].sort();
            
            // Count items
            const totalItems = items.reduce((sum, item) => sum + parseInt(item.qty || 1), 0);
            
            // Header positioning
            let y = 25;
            let x = 15;
            
            // Logo
            const logoBase64 = localStorage.getItem('companyLogo');
            if (logoBase64) {
                try {
                    doc.addImage(logoBase64, 'PNG', 145, 5, 50, 50);
                } catch(e) {
                    console.warn('Error rendering company logo:', e);
                }
            }
            

            doc.setFontSize(32);
            doc.setTextColor(0, 0, 0);
            doc.text('ESTIMATE', x, y);
            y += 15;
            
            // Company details
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text(companySettings.name, x, y);
            y += 6;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(companySettings.address, x, y);
            y += 4;
            doc.text(`Email: ${companySettings.email}`, x, y);
            y += 4;
            doc.text(`Phone: ${companySettings.phone}`, x, y);
            y += 10;
            
            // Job details
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text(jobClient, x, y);
            y += 6;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const jobLabel = jobName ? `${jobName}  |  Job #${jobNum}` : `Job #${jobNum}`;
            doc.text(jobLabel, x, y);
            y += 5;
            
            const doorStyleText = allProfiles.length > 0 ? allProfiles.join(' / ') : 'Flat';
            doc.text(`Door Profiles: ${doorStyleText}`, x, y);
            y += 5;
            
            doc.setFont(undefined, 'bold');
            doc.text(`Total Parts: ${totalItems}`, x, y);
            y += 12;
            
            // Table headers definitions - expanded to use full page width (15mm margins each side = 180mm available)
            const headers = ['Qty', 'H', 'W', 'Thick', 'Moulded', 'Edges', 'Mode', 'Panel', 'Profile', 'SQ/MTR', '$/sq/m', 'Total'];
            const colWidths = [8, 15, 15, 13, 14, 13, 10, 15, 38, 10, 10, 18];
            const cellHeight = 6;
            
            // Process each colour group
            let grandTotal = 0;
            Object.entries(colourGroups).forEach((colourEntry, colourIndex) => {
                const [colourName, colourItems] = colourEntry;
                
                // Page break if needed
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                
                // Colour heading - Always show with black background and white text
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setFillColor(0, 0, 0);
                doc.setDrawColor(0, 0, 0);
                doc.rect(x, y, 180 - 2*x, 8, 'FD');
                doc.setTextColor(255, 255, 255);
                doc.text(`${colourName}`, x + 2, y + 5);
                y += 10;
                
                // Table headers - Black background with white text (proper contrast)
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                
                let startX = x;
                headers.forEach((header, i) => {
                    // Set colors BEFORE drawing each cell
                    doc.setDrawColor(0, 0, 0);
                    doc.setFillColor(0, 0, 0);  // Black background
                    doc.setTextColor(255, 255, 255);  // White text
                    
                    // Draw filled rectangle with border
                    doc.rect(startX, y, colWidths[i], cellHeight, 'FD');
                    
                    // Draw text on black background
                    doc.text(header, startX + colWidths[i]/2, y + cellHeight/2 + 1.2, { align: 'center', valign: 'middle' });
                    
                    startX += colWidths[i];
                });
                y += cellHeight;
                
                // Data rows
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                
                let colourTotal = 0;
                colourItems.forEach((item) => {
                    startX = x;
                    
                    const qty = item.qty || 1;
                    const height = item.h || '';
                    const width = item.w || '';
                    const thickness = item.thk || '';
                    
                    // Moulded: blank if not moulded
                    const panelType = item.type || '';
                    const mouldType = item.prof || '';
                    const isMoulded = (panelType.toLowerCase() === 'flat' || mouldType.toLowerCase().includes('plain') || mouldType === '') ? '' : 'Y';
                    
                    // Edges
                    let edgesDisplay = '';
                    if (item.e && Array.isArray(item.e)) {
                        const leftCount = (item.e[0]?1:0) + (item.e[1]?1:0);
                        const sideCount = (item.e[2]?1:0) + (item.e[3]?1:0);
                        const leftLabel = item.mode === 'SE' ? 'LR' : 'L';
                        const sideLabel = item.mode === 'SE' ? 'SR' : 'S';
                        let parts = [];
                        if (leftCount > 0) parts.push(leftCount + leftLabel);
                        if (sideCount > 0) parts.push(sideCount + sideLabel);
                        edgesDisplay = parts.join('/');
                    }
                    
                    const paintMode = item.mode || 'SS';
                    const panel = item.type || '';
                    const profile = item.prof || '';
                    
                    // Calculate sqm and pricing
                    const sqm = parseFloat(item.sqm) || 0;
                    
                    // Extract profile name without the (###) suffix for pricing lookup
                    const profileBase = profile.replace(/\s*\(\d+\)\s*$/, '').trim();
                    const pricePerSqm = pricingMatrix[profileBase] || pricingMatrix[profile] || 125;
                    const rowTotal = sqm * pricePerSqm * qty;
                    colourTotal += rowTotal;
                    grandTotal += rowTotal;
                    
                    // Data array now includes SQ/MTR column
                    const data = [qty, height, width, thickness, isMoulded, edgesDisplay, paintMode, panel, profile, sqm.toFixed(3), pricePerSqm.toFixed(0), rowTotal.toFixed(2)];
                    
                    // Draw cells
                    data.forEach((value, i) => {
                        doc.setDrawColor(150, 150, 150);
                        doc.setTextColor(0, 0, 0);
                        
                        doc.rect(startX, y, colWidths[i], cellHeight);
                        doc.text(value.toString(), startX + colWidths[i]/2, y + cellHeight/2 + 0.8, { align: 'center', valign: 'middle', maxWidth: colWidths[i] - 0.5 });
                        startX += colWidths[i];
                    });
                    y += cellHeight;
                });
                
                // Colour subtotal
                y += 3;  // Extra spacing
                doc.setFont(undefined, 'bold');
                doc.setFontSize(9);
                // Calculate x position for Total column (sum of all column widths before it)
                const totalColX = x + (8+16+16+14+14+15+10+15+26+12+12);
                doc.text(`Subtotal (${colourName}):`, x, y);
                doc.text(`$${colourTotal.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                y += 8;
                
                // Add colour-specific surcharge if applicable
                if (appliedCharges && appliedCharges.colourSurcharges) {
                    console.log(`üé® Processing surcharges for colour: "${colourName}"`);
                    console.log(`   Available colours in appliedCharges:`, Object.keys(appliedCharges.colourSurcharges));
                    const multipliers = appliedCharges.colourSurcharges[colourName] || [];
                    console.log(`   Multipliers for this colour:`, multipliers);
                    if (multipliers && Array.isArray(multipliers) && multipliers.length > 0) {
                        const chargesData = loadAdditionalCharges();
                        console.log(`   Loaded chargesData.colourMatchFlatRate: $${chargesData.colourMatchFlatRate}`);
                        multipliers.forEach(multiplier => {
                            if (multiplier > 0) {
                                doc.setFont(undefined, 'normal');
                                doc.setFontSize(8);
                                let surcharge = (multiplier === 1.3 || multiplier === 1.30) ? chargesData.colourMatchFlatRate : (colourTotal * multiplier);
                                console.log(`     Applying surcharge - multiplier: ${multiplier}, surcharge amount: $${surcharge.toFixed(2)}`);
                                
                                const surchargeLabel = multiplier === 0.05 ? '(Standard/Light +5%)' : 
                                                     multiplier === 0.15 ? '(Dark +15%)' :
                                                     multiplier === 0.30 ? '(Extra Tint +30%)' :
                                                     multiplier === 0.80 ? '(Undercoat 80%)' :
                                                     multiplier === 1.3 || multiplier === 1.30 ? `(Colour Match $${chargesData.colourMatchFlatRate})` : '';
                                
                                doc.text(`  Paint Colour Surcharge ${surchargeLabel}:`, x, y);
                                doc.text(`$${surcharge.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                                y += 8;
                                grandTotal += surcharge;
                            }
                        });
                    } else {
                        console.log(`   ‚ö†Ô∏è No multipliers found for colour: "${colourName}"`);
                    }
                } else {
                    console.log(`‚ö†Ô∏è appliedCharges or colourSurcharges not available`);
                }
                y += 4;
            });
            
            // Page break: ensure charges and totals stay together
            if (y > 220) {
                doc.addPage();
                y = 25;
            }
            
            // Add all other charges with better spacing
            const totalColX = x + (8+16+16+14+14+15+10+15+26+12+12);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            
            // Add separator line
            y += 8;
            doc.setDrawColor(200, 200, 200);
            doc.line(x, y, totalColX + 15, y);
            y += 6;
            
            // Show additional charges clearly
            if (appliedCharges && appliedCharges.deliveryCharge > 0) {
                doc.text(`Delivery/Pickup (${appliedCharges.deliveryRegionLabel}):`, x, y);
                doc.text(`$${appliedCharges.deliveryCharge.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                grandTotal += appliedCharges.deliveryCharge;
                y += 6;
            }
            
            if (appliedCharges && appliedCharges.courierCost > 0) {
                doc.text(`Freight Charge:`, x, y);
                doc.text(`$${appliedCharges.courierCost.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                grandTotal += appliedCharges.courierCost;
                y += 6;
            }
            
            if (appliedCharges && appliedCharges.otherChargeAmount > 0) {
                doc.text(`${appliedCharges.otherChargeDesc || 'Other Charges'}:`, x, y);
                doc.text(`$${appliedCharges.otherChargeAmount.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                grandTotal += appliedCharges.otherChargeAmount;
                y += 6;
            }
            
            // Calculate and display GST
            const gstRate = appliedCharges && appliedCharges.gstRate ? appliedCharges.gstRate : 0.10;
            const gstAmount = grandTotal * gstRate;
            
            // Check if we need a new page for the final summary
            if (y > 265) {
                doc.addPage();
                y = 25;
            }
            
            // Final summary section
            y += 5;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            doc.text(`Subtotal (inc. charges):`, x, y);
            doc.text(`$${grandTotal.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
            y += 7;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            doc.text(`GST (${(gstRate*100).toFixed(1)}%):`, x, y);
            doc.text(`$${gstAmount.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
            y += 10;
            
            // Grand total with GST
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            const totalWithGST = grandTotal + gstAmount;
            doc.text(`TOTAL ESTIMATE (Inc GST): $${totalWithGST.toFixed(2)}`, x, y);
            
            // Bottom border line
            y += 2;
            doc.setDrawColor(0, 0, 0);
            doc.line(x, y, totalColX + 15, y);
            
            // 15mm Footer Zone (reserved)
            doc.setDrawColor(200, 200, 200);  // Light gray separator
            doc.line(15, 285, 195, 285);  // Separator line at 285mm (12mm from bottom)
            
            // Footer
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, x, 290);
            doc.text('¬© 2026 - PaintWorkz Pro Software', x, 293);
            
            // Show preview modal (like Supply Docket)
            const filename = `Invoice_${jobClient.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            const pdfDataUri = doc.output('datauristring');
            showPDFPreview(pdfDataUri, filename, 'üßæ Invoice Preview');
            notify('‚úì Invoice Ready - Review & Download');
            // Reset charges for next PDF
            appliedCharges = { 
                colourMultiplier: 0, 
                colourMultiplierLabel: 'NONE', 
                deliveryCharge: 0, 
                deliveryRegionLabel: 'None',
                courierCost: 0,
                otherChargeDesc: '',
                otherChargeAmount: 0,
                gstRate: 0.10
            };
            console.log('‚úì Estimate PDF generated successfully');
            
        } catch(err) {
            console.error('Estimate generation error:', err);
            notify('‚ùå Error: ' + err.message);
        }
    }



    function genInvoice() {
        try {
            if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                notify('‚ùå PDF library not loaded');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const itemsForPDF = window.pdfItemsToUse || items;
            
            // Get company settings
            const companySettings = JSON.parse(localStorage.getItem('companySettings')) || {
                name: 'Paintworkz',
                address: '17 West Boundary Road, Hamilton 3300 VIC',
                phone: '0438 803 032',
                email: 'paint_workz@outlook.com'
            };
            
            // Get job info
            const jobClient = document.getElementById('cli')?.value || '';
            const jobNum = document.getElementById('jNum')?.value || document.getElementById('jN')?.value || '';
            const jobName = document.getElementById('jNm')?.value || '';
            
            // Collect all unique colours from items - group by colour AND finish
            const colourGroups = {};
            items.forEach(item => {
                const brand = item.brand || '';
                const color = item.color || '';
                const finish = item.finish || 'Satin';
                const colourKey = brand && color ? `${brand} ${color} ${finish}` : (color ? `${color} ${finish}` : 'No Colour');
                if (!colourGroups[colourKey]) {
                    colourGroups[colourKey] = [];
                }
                colourGroups[colourKey].push(item);
            });
            
            // Pricing matrix
            const pricingMatrix = {
                'Plain': 125,
                'Shaker 45': 171, 'Ashlee': 171, 'Bevelled Edge': 171,
                'Branxholme': 171, 'Hamilton': 171, 'Tarrone': 171
            };
            
            // Get ALL profiles
            const allProfiles = [...new Set(items
                .map(it => it.prof)
                .filter(p => p && p.trim())
            )].sort();
            
            // Count items
            const totalItems = items.reduce((sum, item) => sum + parseInt(item.qty || 1), 0);
            
            // Header positioning
            let y = 25;
            let x = 15;
            
            // Logo
            const logoBase64 = localStorage.getItem('companyLogo');
            if (logoBase64) {
                try {
                    doc.addImage(logoBase64, 'PNG', 145, 5, 50, 50);
                } catch(e) {
                    console.warn('Error rendering company logo:', e);
                }
            }
            

            doc.setFontSize(32);
            doc.setTextColor(0, 0, 0);
            doc.text('INVOICE', x, y);
            y += 15;
            
            // Company details
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text(companySettings.name, x, y);
            y += 6;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(companySettings.address, x, y);
            y += 4;
            doc.text(`Email: ${companySettings.email}`, x, y);
            y += 4;
            doc.text(`Phone: ${companySettings.phone}`, x, y);
            y += 10;
            
            // Job details
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text(jobClient, x, y);
            y += 6;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const jobLabel = jobName ? `${jobName}  |  Job #${jobNum}` : `Job #${jobNum}`;
            doc.text(jobLabel, x, y);
            y += 5;
            
            const doorStyleText = allProfiles.length > 0 ? allProfiles.join(' / ') : 'Flat';
            doc.text(`Door Profiles: ${doorStyleText}`, x, y);
            y += 5;
            
            doc.setFont(undefined, 'bold');
            doc.text(`Total Parts: ${totalItems}`, x, y);
            y += 12;
            
            // Table headers definitions - expanded to use full page width (15mm margins each side = 180mm available)
            const headers = ['Qty', 'H', 'W', 'Thick', 'Moulded', 'Edges', 'Mode', 'Panel', 'Profile', 'SQ/MTR', '$/sq/m', 'Total'];
            const colWidths = [8, 15, 15, 13, 14, 13, 10, 15, 38, 10, 10, 18];
            const cellHeight = 6;
            
            // Process each colour group
            let grandTotal = 0;
            Object.entries(colourGroups).forEach((colourEntry, colourIndex) => {
                const [colourName, colourItems] = colourEntry;
                
                // Page break if needed
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                
                // Colour heading - Always show with black background and white text
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setFillColor(0, 0, 0);
                doc.setDrawColor(0, 0, 0);
                doc.rect(x, y, 180 - 2*x, 8, 'FD');
                doc.setTextColor(255, 255, 255);
                doc.text(`${colourName}`, x + 2, y + 5);
                y += 10;
                
                // Table headers - Black background with white text (proper contrast)
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                
                let startX = x;
                headers.forEach((header, i) => {
                    // Set colors BEFORE drawing each cell
                    doc.setDrawColor(0, 0, 0);
                    doc.setFillColor(0, 0, 0);  // Black background
                    doc.setTextColor(255, 255, 255);  // White text
                    
                    // Draw filled rectangle with border
                    doc.rect(startX, y, colWidths[i], cellHeight, 'FD');
                    
                    // Draw text on black background
                    doc.text(header, startX + colWidths[i]/2, y + cellHeight/2 + 1.2, { align: 'center', valign: 'middle' });
                    
                    startX += colWidths[i];
                });
                y += cellHeight;
                
                // Data rows
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                
                let colourTotal = 0;
                colourItems.forEach((item) => {
                    startX = x;
                    
                    const qty = item.qty || 1;
                    const height = item.h || '';
                    const width = item.w || '';
                    const thickness = item.thk || '';
                    
                    // Moulded: blank if not moulded
                    const panelType = item.type || '';
                    const mouldType = item.prof || '';
                    const isMoulded = (panelType.toLowerCase() === 'flat' || mouldType.toLowerCase().includes('plain') || mouldType === '') ? '' : 'Y';
                    
                    // Edges
                    let edgesDisplay = '';
                    if (item.e && Array.isArray(item.e)) {
                        const leftCount = (item.e[0]?1:0) + (item.e[1]?1:0);
                        const sideCount = (item.e[2]?1:0) + (item.e[3]?1:0);
                        const leftLabel = item.mode === 'SE' ? 'LR' : 'L';
                        const sideLabel = item.mode === 'SE' ? 'SR' : 'S';
                        let parts = [];
                        if (leftCount > 0) parts.push(leftCount + leftLabel);
                        if (sideCount > 0) parts.push(sideCount + sideLabel);
                        edgesDisplay = parts.join('/');
                    }
                    
                    const paintMode = item.mode || 'SS';
                    const panel = item.type || '';
                    const profile = item.prof || '';
                    
                    // Calculate sqm and pricing
                    const sqm = parseFloat(item.sqm) || 0;
                    
                    // Extract profile name without the (###) suffix for pricing lookup
                    const profileBase = profile.replace(/\s*\(\d+\)\s*$/, '').trim();
                    const pricePerSqm = pricingMatrix[profileBase] || pricingMatrix[profile] || 125;
                    const rowTotal = sqm * pricePerSqm * qty;
                    colourTotal += rowTotal;
                    grandTotal += rowTotal;
                    
                    // Data array now includes SQ/MTR column
                    const data = [qty, height, width, thickness, isMoulded, edgesDisplay, paintMode, panel, profile, sqm.toFixed(3), pricePerSqm.toFixed(0), rowTotal.toFixed(2)];
                    
                    // Draw cells
                    data.forEach((value, i) => {
                        doc.setDrawColor(150, 150, 150);
                        doc.setTextColor(0, 0, 0);
                        
                        doc.rect(startX, y, colWidths[i], cellHeight);
                        doc.text(value.toString(), startX + colWidths[i]/2, y + cellHeight/2 + 0.8, { align: 'center', valign: 'middle', maxWidth: colWidths[i] - 0.5 });
                        startX += colWidths[i];
                    });
                    y += cellHeight;
                });
                
                // Colour subtotal
                y += 3;  // Extra spacing
                doc.setFont(undefined, 'bold');
                doc.setFontSize(9);
                // Calculate x position for Total column (sum of all column widths before it)
                const totalColX = x + (8+16+16+14+14+15+10+15+26+12+12);
                doc.text(`Subtotal (${colourName}):`, x, y);
                doc.text(`$${colourTotal.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                y += 8;
                
                // Add colour-specific surcharge if applicable
                if (appliedCharges && appliedCharges.colourSurcharges) {
                    console.log(`üé® Processing surcharges for colour: "${colourName}"`);
                    console.log(`   Available colours in appliedCharges:`, Object.keys(appliedCharges.colourSurcharges));
                    const multipliers = appliedCharges.colourSurcharges[colourName] || [];
                    console.log(`   Multipliers for this colour:`, multipliers);
                    if (multipliers && Array.isArray(multipliers) && multipliers.length > 0) {
                        const chargesData = loadAdditionalCharges();
                        console.log(`   Loaded chargesData.colourMatchFlatRate: $${chargesData.colourMatchFlatRate}`);
                        multipliers.forEach(multiplier => {
                            if (multiplier > 0) {
                                doc.setFont(undefined, 'normal');
                                doc.setFontSize(8);
                                let surcharge = (multiplier === 1.3 || multiplier === 1.30) ? chargesData.colourMatchFlatRate : (colourTotal * multiplier);
                                console.log(`     Applying surcharge - multiplier: ${multiplier}, surcharge amount: $${surcharge.toFixed(2)}`);
                                
                                const surchargeLabel = multiplier === 0.05 ? '(Standard/Light +5%)' : 
                                                     multiplier === 0.15 ? '(Dark +15%)' :
                                                     multiplier === 0.30 ? '(Extra Tint +30%)' :
                                                     multiplier === 0.80 ? '(Undercoat 80%)' :
                                                     multiplier === 1.3 || multiplier === 1.30 ? `(Colour Match $${chargesData.colourMatchFlatRate})` : '';
                                
                                doc.text(`  Paint Colour Surcharge ${surchargeLabel}:`, x, y);
                                doc.text(`$${surcharge.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                                y += 8;
                                grandTotal += surcharge;
                            }
                        });
                    } else {
                        console.log(`   ‚ö†Ô∏è No multipliers found for colour: "${colourName}"`);
                    }
                } else {
                    console.log(`‚ö†Ô∏è appliedCharges or colourSurcharges not available`);
                }
                y += 4;
            });
            
            // Page break: ensure charges and totals stay together
            if (y > 220) {
                doc.addPage();
                y = 25;
            }
            
            // Add all other charges with better spacing
            const totalColX = x + (8+16+16+14+14+15+10+15+26+12+12);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            
            // Add separator line
            y += 8;
            doc.setDrawColor(200, 200, 200);
            doc.line(x, y, totalColX + 15, y);
            y += 6;
            
            // Show additional charges clearly
            if (appliedCharges && appliedCharges.deliveryCharge > 0) {
                doc.text(`Delivery/Pickup (${appliedCharges.deliveryRegionLabel}):`, x, y);
                doc.text(`$${appliedCharges.deliveryCharge.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                grandTotal += appliedCharges.deliveryCharge;
                y += 6;
            }
            
            if (appliedCharges && appliedCharges.courierCost > 0) {
                doc.text(`Freight Charge:`, x, y);
                doc.text(`$${appliedCharges.courierCost.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                grandTotal += appliedCharges.courierCost;
                y += 6;
            }
            
            if (appliedCharges && appliedCharges.otherChargeAmount > 0) {
                doc.text(`${appliedCharges.otherChargeDesc || 'Other Charges'}:`, x, y);
                doc.text(`$${appliedCharges.otherChargeAmount.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                grandTotal += appliedCharges.otherChargeAmount;
                y += 6;
            }
            
            // Calculate and display GST
            const gstRate = appliedCharges && appliedCharges.gstRate ? appliedCharges.gstRate : 0.10;
            const gstAmount = grandTotal * gstRate;
            
            // Check if we need a new page for the final summary
            if (y > 265) {
                doc.addPage();
                y = 25;
            }
            
            // Final summary section
            y += 5;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            doc.text(`Subtotal (inc. charges):`, x, y);
            doc.text(`$${grandTotal.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
            y += 7;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            doc.text(`GST (${(gstRate*100).toFixed(1)}%):`, x, y);
            doc.text(`$${gstAmount.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
            y += 10;
            
            // Grand total with GST
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            const totalWithGST = grandTotal + gstAmount;
            doc.text(`TOTAL ESTIMATE (Inc GST): $${totalWithGST.toFixed(2)}`, x, y);
            
            // Bottom border line
            y += 2;
            doc.setDrawColor(0, 0, 0);
            doc.line(x, y, totalColX + 15, y);
            
            // 15mm Footer Zone (reserved)
            doc.setDrawColor(200, 200, 200);  // Light gray separator
            doc.line(15, 285, 195, 285);  // Separator line at 285mm (12mm from bottom)
            
            // Footer
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, x, 290);
            doc.text('¬© 2026 - PaintWorkz Pro Software', x, 293);
            
            // Show preview modal (like Supply Docket)
            const filename = `Invoice_${jobClient.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            const pdfDataUri = doc.output('datauristring');
            showPDFPreview(pdfDataUri, filename, 'üßæ Invoice Preview');
            notify('‚úì Invoice Ready - Review & Download');
            // Reset charges for next PDF
            appliedCharges = { 
                colourMultiplier: 0, 
                colourMultiplierLabel: 'NONE', 
                deliveryCharge: 0, 
                deliveryRegionLabel: 'None',
                courierCost: 0,
                otherChargeDesc: '',
                otherChargeAmount: 0,
                gstRate: 0.10
            };
            console.log('‚úì Estimate PDF generated successfully');
            
        } catch(err) {
            console.error('Estimate generation error:', err);
            notify('‚ùå Error: ' + err.message);
        }
    }



    function genQuoteForm() {
        try {
            if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                notify('‚ùå PDF library not loaded');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const itemsForPDF = window.pdfItemsToUse || items;
            
            // Get company settings
            const companySettings = JSON.parse(localStorage.getItem('companySettings')) || {
                name: 'Paintworkz',
                address: '17 West Boundary Road, Hamilton 3300 VIC',
                phone: '0438 803 032',
                email: 'paint_workz@outlook.com'
            };
            
            // Get job info
            const jobClient = document.getElementById('cli')?.value || '';
            const jobNum = document.getElementById('jNum')?.value || document.getElementById('jN')?.value || '';
            const jobName = document.getElementById('jNm')?.value || '';
            
            // Collect all unique colours from items - group by colour AND finish
            const colourGroups = {};
            items.forEach(item => {
                const brand = item.brand || '';
                const color = item.color || '';
                const finish = item.finish || 'Satin';
                const colourKey = brand && color ? `${brand} ${color} ${finish}` : (color ? `${color} ${finish}` : 'No Colour');
                if (!colourGroups[colourKey]) {
                    colourGroups[colourKey] = [];
                }
                colourGroups[colourKey].push(item);
            });
            
            // Pricing matrix
            const pricingMatrix = {
                'Plain': 125,
                'Shaker 45': 171, 'Ashlee': 171, 'Bevelled Edge': 171,
                'Branxholme': 171, 'Hamilton': 171, 'Tarrone': 171
            };
            
            // Get ALL profiles
            const allProfiles = [...new Set(items
                .map(it => it.prof)
                .filter(p => p && p.trim())
            )].sort();
            
            // Count items
            const totalItems = items.reduce((sum, item) => sum + parseInt(item.qty || 1), 0);
            
            // Header positioning
            let y = 25;
            let x = 15;
            
            // Logo
            const logoBase64 = localStorage.getItem('companyLogo');
            if (logoBase64) {
                try {
                    doc.addImage(logoBase64, 'PNG', 145, 5, 50, 50);
                } catch(e) {
                    console.warn('Error rendering company logo:', e);
                }
            }
            

            doc.setFontSize(32);
            doc.setTextColor(0, 0, 0);
            doc.text('QUOTE', x, y);
            doc.setTextColor(0, 0, 0); // Reset to black
            y += 15;
            
            // Company details
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text(companySettings.name, x, y);
            y += 6;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(companySettings.address, x, y);
            y += 4;
            doc.text(`Email: ${companySettings.email}`, x, y);
            y += 4;
            doc.text(`Phone: ${companySettings.phone}`, x, y);
            y += 10;
            
            // Job details
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text(jobClient, x, y);
            y += 6;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const jobLabel = jobName ? `${jobName}  |  Job #${jobNum}` : `Job #${jobNum}`;
            doc.text(jobLabel, x, y);
            y += 5;
            
            const doorStyleText = allProfiles.length > 0 ? allProfiles.join(' / ') : 'Flat';
            doc.text(`Door Profiles: ${doorStyleText}`, x, y);
            y += 5;
            
            doc.setFont(undefined, 'bold');
            doc.text(`Total Parts: ${totalItems}`, x, y);
            y += 12;
            
            // Table headers definitions - expanded to use full page width (15mm margins each side = 180mm available)
            const headers = ['Qty', 'H', 'W', 'Thick', 'Moulded', 'Edges', 'Mode', 'Panel', 'Profile', 'SQ/MTR', '$/sq/m', 'Total'];
            const colWidths = [8, 15, 15, 13, 14, 13, 10, 15, 38, 10, 10, 18];
            const cellHeight = 6;
            
            // Process each colour group
            let grandTotal = 0;
            Object.entries(colourGroups).forEach((colourEntry, colourIndex) => {
                const [colourName, colourItems] = colourEntry;
                
                // Page break if needed
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                
                // Colour heading - Always show with black background and white text
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setFillColor(0, 0, 0);
                doc.setDrawColor(0, 0, 0);
                doc.rect(x, y, 180 - 2*x, 8, 'FD');
                doc.setTextColor(255, 255, 255);
                doc.text(`${colourName}`, x + 2, y + 5);
                y += 10;
                
                // Table headers - Black background with white text (proper contrast)
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                
                let startX = x;
                headers.forEach((header, i) => {
                    // Set colors BEFORE drawing each cell
                    doc.setDrawColor(0, 0, 0);
                    doc.setFillColor(0, 0, 0);  // Black background
                    doc.setTextColor(255, 255, 255);  // White text
                    
                    // Draw filled rectangle with border
                    doc.rect(startX, y, colWidths[i], cellHeight, 'FD');
                    
                    // Draw text on black background
                    doc.text(header, startX + colWidths[i]/2, y + cellHeight/2 + 1.2, { align: 'center', valign: 'middle' });
                    
                    startX += colWidths[i];
                });
                y += cellHeight;
                
                // Data rows
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.setTextColor(0, 0, 0);
                
                let colourTotal = 0;
                colourItems.forEach((item) => {
                    startX = x;
                    
                    const qty = item.qty || 1;
                    const height = item.h || '';
                    const width = item.w || '';
                    const thickness = item.thk || '';
                    
                    // Moulded: blank if not moulded
                    const panelType = item.type || '';
                    const mouldType = item.prof || '';
                    const isMoulded = (panelType.toLowerCase() === 'flat' || mouldType.toLowerCase().includes('plain') || mouldType === '') ? '' : 'Y';
                    
                    // Edges
                    let edgesDisplay = '';
                    if (item.e && Array.isArray(item.e)) {
                        const leftCount = (item.e[0]?1:0) + (item.e[1]?1:0);
                        const sideCount = (item.e[2]?1:0) + (item.e[3]?1:0);
                        const leftLabel = item.mode === 'SE' ? 'LR' : 'L';
                        const sideLabel = item.mode === 'SE' ? 'SR' : 'S';
                        let parts = [];
                        if (leftCount > 0) parts.push(leftCount + leftLabel);
                        if (sideCount > 0) parts.push(sideCount + sideLabel);
                        edgesDisplay = parts.join('/');
                    }
                    
                    const paintMode = item.mode || 'SS';
                    const panel = item.type || '';
                    const profile = item.prof || '';
                    
                    // Calculate sqm and pricing
                    const sqm = parseFloat(item.sqm) || 0;
                    
                    // Extract profile name without the (###) suffix for pricing lookup
                    const profileBase = profile.replace(/\s*\(\d+\)\s*$/, '').trim();
                    const pricePerSqm = pricingMatrix[profileBase] || pricingMatrix[profile] || 125;
                    const rowTotal = sqm * pricePerSqm * qty;
                    colourTotal += rowTotal;
                    grandTotal += rowTotal;
                    
                    // Data array now includes SQ/MTR column
                    const data = [qty, height, width, thickness, isMoulded, edgesDisplay, paintMode, panel, profile, sqm.toFixed(3), pricePerSqm.toFixed(0), rowTotal.toFixed(2)];
                    
                    // Draw cells
                    data.forEach((value, i) => {
                        doc.setDrawColor(150, 150, 150);
                        doc.setTextColor(0, 0, 0);
                        
                        doc.rect(startX, y, colWidths[i], cellHeight);
                        doc.text(value.toString(), startX + colWidths[i]/2, y + cellHeight/2 + 0.8, { align: 'center', valign: 'middle', maxWidth: colWidths[i] - 0.5 });
                        startX += colWidths[i];
                    });
                    y += cellHeight;
                });
                
                // Colour subtotal
                y += 3;  // Extra spacing
                doc.setFont(undefined, 'bold');
                doc.setFontSize(9);
                // Calculate x position for Total column (sum of all column widths before it)
                const totalColX = x + (8+16+16+14+14+15+10+15+26+12+12);
                doc.text(`Subtotal (${colourName}):`, x, y);
                doc.text(`$${colourTotal.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                y += 8;
                
                // Add colour-specific surcharge if applicable
                if (appliedCharges && appliedCharges.colourSurcharges) {
                    console.log(`üé® Processing surcharges for colour: "${colourName}"`);
                    console.log(`   Available colours in appliedCharges:`, Object.keys(appliedCharges.colourSurcharges));
                    const multipliers = appliedCharges.colourSurcharges[colourName] || [];
                    console.log(`   Multipliers for this colour:`, multipliers);
                    if (multipliers && Array.isArray(multipliers) && multipliers.length > 0) {
                        const chargesData = loadAdditionalCharges();
                        console.log(`   Loaded chargesData.colourMatchFlatRate: $${chargesData.colourMatchFlatRate}`);
                        multipliers.forEach(multiplier => {
                            if (multiplier > 0) {
                                doc.setFont(undefined, 'normal');
                                doc.setFontSize(8);
                                let surcharge = (multiplier === 1.3 || multiplier === 1.30) ? chargesData.colourMatchFlatRate : (colourTotal * multiplier);
                                console.log(`     Applying surcharge - multiplier: ${multiplier}, surcharge amount: $${surcharge.toFixed(2)}`);
                                
                                const surchargeLabel = multiplier === 0.05 ? '(Standard/Light +5%)' : 
                                                     multiplier === 0.15 ? '(Dark +15%)' :
                                                     multiplier === 0.30 ? '(Extra Tint +30%)' :
                                                     multiplier === 0.80 ? '(Undercoat 80%)' :
                                                     multiplier === 1.3 || multiplier === 1.30 ? `(Colour Match $${chargesData.colourMatchFlatRate})` : '';
                                
                                doc.text(`  Paint Colour Surcharge ${surchargeLabel}:`, x, y);
                                doc.text(`$${surcharge.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                                y += 8;
                                grandTotal += surcharge;
                            }
                        });
                    } else {
                        console.log(`   ‚ö†Ô∏è No multipliers found for colour: "${colourName}"`);
                    }
                } else {
                    console.log(`‚ö†Ô∏è appliedCharges or colourSurcharges not available`);
                }
                y += 4;
            });
            
            // Page break: ensure charges and totals stay together
            if (y > 220) {
                doc.addPage();
                y = 25;
            }
            
            // Add all other charges with better spacing
            const totalColX = x + (8+16+16+14+14+15+10+15+26+12+12);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            
            // Add separator line
            y += 8;
            doc.setDrawColor(200, 200, 200);
            doc.line(x, y, totalColX + 15, y);
            y += 6;
            
            // Show additional charges clearly
            if (appliedCharges && appliedCharges.deliveryCharge > 0) {
                doc.text(`Delivery/Pickup (${appliedCharges.deliveryRegionLabel}):`, x, y);
                doc.text(`$${appliedCharges.deliveryCharge.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                grandTotal += appliedCharges.deliveryCharge;
                y += 6;
            }
            
            if (appliedCharges && appliedCharges.courierCost > 0) {
                doc.text(`Freight Charge:`, x, y);
                doc.text(`$${appliedCharges.courierCost.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                grandTotal += appliedCharges.courierCost;
                y += 6;
            }
            
            if (appliedCharges && appliedCharges.otherChargeAmount > 0) {
                doc.text(`${appliedCharges.otherChargeDesc || 'Other Charges'}:`, x, y);
                doc.text(`$${appliedCharges.otherChargeAmount.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
                grandTotal += appliedCharges.otherChargeAmount;
                y += 6;
            }
            
            // Calculate and display GST
            const gstRate = appliedCharges && appliedCharges.gstRate ? appliedCharges.gstRate : 0.10;
            const gstAmount = grandTotal * gstRate;
            
            // Check if we need a new page for the final summary
            if (y > 265) {
                doc.addPage();
                y = 25;
            }
            
            // Final summary section
            y += 5;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            doc.text(`Subtotal (inc. charges):`, x, y);
            doc.text(`$${grandTotal.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
            y += 7;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            doc.text(`GST (${(gstRate*100).toFixed(1)}%):`, x, y);
            doc.text(`$${gstAmount.toFixed(2)}`, totalColX + 8, y, { align: 'right' });
            y += 10;
            
            // Grand total with GST
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            const totalWithGST = grandTotal + gstAmount;
            doc.text(`TOTAL ESTIMATE (Inc GST): $${totalWithGST.toFixed(2)}`, x, y);
            
            // Bottom border line
            y += 2;
            doc.setDrawColor(0, 0, 0);
            doc.line(x, y, totalColX + 15, y);
            
            // 15mm Footer Zone (reserved)
            doc.setDrawColor(200, 200, 200);  // Light gray separator
            doc.line(15, 285, 195, 285);  // Separator line at 285mm (12mm from bottom)
            
            // Footer
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text(`Generated: ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}`, x, 290);
            
            doc.text('¬© 2026 - PaintWorkz Pro Software', x, 293);
            // Show preview modal (like Supply Docket)
            const filename = `Invoice_${jobClient.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            const pdfDataUri = doc.output('datauristring');
            showPDFPreview(pdfDataUri, filename, 'üßæ Invoice Preview');
            notify('‚úì Invoice Ready - Review & Download');
            // Reset charges for next PDF
            appliedCharges = { 
                colourMultiplier: 0, 
                colourMultiplierLabel: 'NONE', 
                deliveryCharge: 0, 
                deliveryRegionLabel: 'None',
                courierCost: 0,
                otherChargeDesc: '',
                otherChargeAmount: 0,
                gstRate: 0.10
            };
            console.log('‚úì Estimate PDF generated successfully');
            
        } catch(err) {
            console.error('Estimate generation error:', err);
            notify('‚ùå Error: ' + err.message);
        }
    }



    function genSupplyDocket() {
        if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
            notify('‚ùå PDF library not loaded');
            return;
        }
        
        // Use filtered items if available, otherwise use all items
        const itemsForPDF = window.pdfItemsToUse || items;
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        
        // Get company settings from localStorage or use defaults
        const companySettings = JSON.parse(localStorage.getItem('companySettings')) || {
            name: 'Paintworkz',
            address: '17 West Boundary Road, Hamilton 3300 VIC',
            phone: '0438 803 032',
            email: 'paint_workz@outlook.com'
        };
        
        // Get job info
        const jobClient = document.getElementById('cli')?.value || '';
        const jobNum = document.getElementById('jNum')?.value || document.getElementById('jN')?.value || '';
        const jobName = document.getElementById('jNm')?.value || '';
        
        // Collect ALL unique colours from filtered items
        const allColours = [...new Set(itemsForPDF
            .map(it => {
                const brand = it.brand || '';
                const color = it.color || '';
                const finish = it.finish || 'Satin';
                return brand && color ? `${brand} ${color} ${finish}` : (color ? `${color} ${finish}` : '');
            })
            .filter(c => c && c.trim())
        )];
        const paintColorDisplay = allColours.length > 0 ? allColours.join(' / ') : (document.getElementById('p-color')?.value || '');
        
        // Get ALL profiles including Plain
        const allProfiles = [...new Set(items
            .map(it => it.prof)
            .filter(p => p && p.trim())
        )].sort();
        
        // Count items
        const totalItems = itemsForPDF.reduce((sum, item) => sum + parseInt(item.qty || 1), 0);
        
        // ===== HEADER WITH LOGO & COMPANY INFO =====
        let y = 25;  // Increased to 25 to ensure 15mm+ blank space at top, then content starts
        let x = 15;
        
        // Try to load logo from localStorage
        const logoBase64 = localStorage.getItem('companyLogo');
        
        // Add logo in top right if exists
        if (logoBase64) {
            try {
                doc.addImage(logoBase64, 'PNG', 145, 5, 50, 50);
            } catch(e) {}
        }
        
        // DOUBLED header size
        doc.setFontSize(32);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('SUPPLY DOCKET', x, y);
        y += 14;
        
        // ===== COMPANY DETAILS (LARGER) =====
        doc.setFontSize(13);
        doc.setFont(undefined, 'bold');
        doc.text(companySettings.name, x, y);
        y += 6;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(companySettings.address, x, y);
        y += 4;
        
        doc.text(`Email: ${companySettings.email}`, x, y);
        y += 4;
        
        doc.text(`Phone: ${companySettings.phone}`, x, y);
        y += 10;  // Increased spacing from 7 to 10
        
        // ===== JOB DETAILS =====
        doc.setFontSize(13);
        doc.setFont(undefined, 'bold');
        doc.text(`${jobClient}`, x, y);
        y += 6;
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const jobLabel = jobName ? `${jobName}  |  Job #${jobNum}` : `Job #${jobNum}`;
        doc.text(jobLabel, x, y);
        y += 5;
        
        const doorStyleText = allProfiles.length > 0 ? allProfiles.join(' / ') : 'Flat';
        doc.text(`Door Profiles: ${doorStyleText}`, x, y);
        y += 5;
        
        doc.text(`Paint Colour: ${paintColorDisplay}`, x, y);
        y += 5;
        
        doc.setFont(undefined, 'bold');
        doc.text(`Total Parts: ${totalItems}`, x, y);
        y += 12;  // Increased margin from 8 to 12 for top space above table
        
        // ===== TABLE - FULL WIDTH =====
        const margin = 10;
        const pageWidth = doc.internal.pageSize.getWidth();
        
        // Column headers - Description moved to LAST column
        const headers = ['Qty', 'H', 'W', 'Thick', 'Moulded', 'Edges', 'Mode', 'Panel', 'Profile', 'Colour', 'Description'];
        // Full page width = 210mm - 30mm margins = 190mm (Moulded: 13‚Üí15, Colour: 19‚Üí24, Description: 44‚Üí37)
        const colWidths = [7, 16, 16, 12, 15, 13, 8, 14, 28, 24, 37];
        const cellHeight = 7;
        
        // Draw header row
        doc.setFont(undefined, 'bold');
        doc.setFontSize(8);
        
        let startX = margin;
        headers.forEach((header, i) => {
            // Set colors
            doc.setFillColor(0, 0, 0);
            doc.setDrawColor(0, 0, 0);
            doc.setTextColor(255, 255, 255);
            
            // Draw cell
            doc.rect(startX, y, colWidths[i], cellHeight, 'FD');
            
            // Draw text CENTERED
            doc.text(header, startX + colWidths[i]/2, y + cellHeight/2 + 0.8, { 
                align: 'center', 
                valign: 'middle',
                maxWidth: colWidths[i] - 0.5 
            });
            startX += colWidths[i];
        });
        y += cellHeight;
        
        // Draw data rows
        doc.setFont(undefined, 'normal');
        doc.setFontSize(8);
        
        itemsForPDF.forEach((item) => {
            startX = margin;
            
            // Prepare data
            const qty = item.qty || 1;
            const height = item.h || '';
            const width = item.w || '';
            const thickness = item.thk || '';
            
            // Moulded: Y/N (but show blank for N) - based on panel type and profile
            // Flat panels = No Mould, Plain profiles = No Mould
            const panelType = item.type || '';
            const mouldType = item.prof || '';
            const isMouldedValue = (
                panelType.toLowerCase() === 'flat' || 
                mouldType.toLowerCase().includes('plain') ||
                mouldType === ''
            ) ? '' : 'Y';
            
            // EDGES - properly calculate from array of booleans
            let edgesDisplay = '';
            if (item.e && Array.isArray(item.e)) {
                const leftCount = (item.e[0]?1:0) + (item.e[1]?1:0);
                const sideCount = (item.e[2]?1:0) + (item.e[3]?1:0);
                const leftLabel = item.mode === 'SE' ? 'LR' : 'L';
                const sideLabel = item.mode === 'SE' ? 'SR' : 'S';
                
                let parts = [];
                if (leftCount > 0) parts.push(leftCount + leftLabel);
                if (sideCount > 0) parts.push(sideCount + sideLabel);
                edgesDisplay = parts.join('/');
            }
            
            // Paint mode
            const paintMode = item.mode || 'SS';
            
            // Profile/Mould type
            const profile = item.prof || '';
            
            // Paint colour WITH BRAND
            const itemBrand = item.brand || '';
            const itemColor = item.color || '';
            const colourDisplay = itemBrand && itemColor ? `${itemBrand} ${itemColor}` : itemColor;
            
            // Description - only if filled out (not empty)
            const description = item.desc || '';
            
            const data = [qty, height, width, thickness, isMouldedValue, edgesDisplay, paintMode, panelType, profile, colourDisplay, description];
            
            // Draw cells
            data.forEach((value, i) => {
                doc.setDrawColor(150, 150, 150);
                doc.setTextColor(0, 0, 0);
                
                // Draw border
                doc.rect(startX, y, colWidths[i], cellHeight);
                
                // Special handling for Colour column (index 9) - smaller font and 2-line support
                if (i === 9) {
                    // Colour column - use smaller font and allow text wrapping
                    doc.setFontSize(7);
                    const displayText = value.toString();
                    doc.text(displayText, startX + colWidths[i]/2, y + cellHeight/2, { 
                        align: 'center',
                        valign: 'middle',
                        maxWidth: colWidths[i] - 1
                    });
                    doc.setFontSize(8); // Reset font size
                } else {
                    // All other columns - normal font
                    const displayText = value.toString().substring(0, 40);
                    doc.text(displayText, startX + colWidths[i]/2, y + cellHeight/2 + 0.8, { 
                        align: 'center',
                        valign: 'middle',
                        maxWidth: colWidths[i] - 0.5
                    });
                }
                startX += colWidths[i];
            });
            y += cellHeight;
            
            // Page break - leave room for footer
            if (y > 260) {
                // Add footer with bigger timestamp
                const now = new Date();
                const timestamp = now.toLocaleString('en-AU');
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(80, 80, 80);
                doc.text(`Generated: ${timestamp}`, 15, doc.internal.pageSize.getHeight() - 10);
                
                doc.text('¬© 2026 - PaintWorkz Pro Software', 15, doc.internal.pageSize.getHeight() - 7);
                doc.addPage();
                y = 20;
                
                // Redraw header on new page
                doc.setFont(undefined, 'bold');
                doc.setFontSize(8);
                startX = margin;
                headers.forEach((header, i) => {
                    doc.setFillColor(0, 0, 0);
                    doc.setDrawColor(0, 0, 0);
                    doc.setTextColor(255, 255, 255);
                    doc.rect(startX, y, colWidths[i], cellHeight, 'FD');
                    doc.text(header, startX + colWidths[i]/2, y + cellHeight/2 + 0.8, { 
                        align: 'center',
                        valign: 'middle',
                        maxWidth: colWidths[i] - 0.5
                    });
                    startX += colWidths[i];
                });
                y += cellHeight;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
            }
        });
        
        // Add footer on last page
        const now = new Date();
        const timestamp = now.toLocaleString('en-AU');
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(80, 80, 80);
        doc.text(`Generated: ${timestamp}`, 15, doc.internal.pageSize.getHeight() - 10);
        
        doc.text('¬© 2026 - PaintWorkz Pro Software', 15, doc.internal.pageSize.getHeight() - 7);
        // Show preview
        const pdfDataUri = doc.output('datauristring');
        const filename = `SupplyDocket_${jobClient.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        showPDFPreview(pdfDataUri, filename, 'üì¶ Supply Docket Preview');
        notify("‚úì Supply Docket Ready - Review & Download");
    }

    
    function genMixingCard() {
        try {
            if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                notify('‚ùå PDF library not loaded. Please refresh.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            
            // Get job data
            const jobClient = document.getElementById('cli')?.value || 'Client Name';
            const jobNum = document.getElementById('jNum')?.value || document.getElementById('jN')?.value || '';
            const jobName = document.getElementById('jNm')?.value || 'Job Name';
            const dateReceived = document.getElementById('dat')?.value || new Date().toLocaleDateString('en-AU');
            const totalSQM = parseFloat(document.getElementById('tA')?.innerText || '0') || 0;  // FIX: was 'tot', should be 'tA'
            console.log('MIXING CARD START - totalSQM: ' + totalSQM + ', items: ' + items.length);
            
            // Get paint data - use FIRST ITEM'S BRAND (all items should have same brand per part logic)
            const paintBrand = (items[0]?.brand) || document.getElementById('p-brand')?.value || 'Dulux';
            const paintFinish = (items[0]?.finish) || document.getElementById('p-finish')?.value || 'Satin';
            
            // Get unique colors from items in measure tab (same logic as shop label)
            const uniqueColors = new Set();
            items.forEach(item => {
                if (item.color && item.color.trim()) {
                    uniqueColors.add(item.color.trim());
                }
            });
            
            // Convert to array and sort
            const colors = Array.from(uniqueColors).sort();
            console.log('MIXING CARD - Detected colors:', colors.join(', '), 'Total items:', items.length);
            console.log('MIXING CARD - All item colors:', items.map(i => i.color));
            
            
            if (colors.length === 0) {
                notify('‚ùå Assign colors to all parts in Measure tab');
                return;
            }
            
            // Get logo
            const headerLogo = localStorage.getItem('headerLogo') || localStorage.getItem('headerLogoBase64') || '';
            
            // Create one PDF document for all colors
            const doc = new jsPDF('p', 'mm', 'a4');
            let colorPageCount = 0;
            
            // Generate one page per color
            colors.forEach((color, colorIndex) => {
                
                if (colorPageCount > 0) {
                    // Add new page for each additional color
                    doc.addPage();
                }
                
                let y = 15;
                const pageHeight = doc.internal.pageSize.getHeight();
                
                // ===== LOGO =====
                if (headerLogo) {
                    try {
                        doc.addImage(headerLogo, 'PNG', 145, 5, 50, 20);
                    } catch(e) {}
                }
                
                // ===== TITLE =====
                doc.setFontSize(28);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('MIXING CARD', 20, y);
                y += 12;
                
                // ===== PAINT INFO BOX - SIMPLE BLACK TEXT ON WHITE TO SAVE INK =====
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);  // Black text instead of white
                doc.setFillColor(255, 255, 255);  // White background instead of gold
                doc.setDrawColor(200, 200, 200);  // Light gray border instead of dark
                doc.setLineWidth(1);
                doc.rect(20, y, 170, 24, 'FD');  // Reduced from 32 to 24
                
                // Format: Brand | Color | Finish - fill the box with 5mm margins
                const paintInfo = `${paintBrand} | ${color.toUpperCase()} | ${paintFinish}`;
                doc.text(paintInfo, 25, y + 16);  // Adjusted y position for smaller box
                y += 28;  // Gap BELOW paint box
                y += 8;   // Additional spacing before job details (symmetric with top)
                
                // Lookup formula for this color (used in tint formula section below)
                const formula = paintDatabase.find(f => 
                    f.color && f.color.toLowerCase() === color.toLowerCase()
                );
                
                // ===== CALCULATE SQM FOR THIS COLOR ONLY =====
                let colorSQM = 0;
                const itemsForColor = [];
                items.forEach(item => {
                    // Normalize color comparison: trim whitespace, lowercase, handle case
                    const itemColor = (item.color || '').trim().toLowerCase();
                    const searchColor = color.toLowerCase();
                    
                    if (itemColor && itemColor === searchColor) {
                        const sqm = parseFloat(item.sqm) || 0;
                        const qty = parseInt(item.qty) || 1;
                        const itemTotalSqm = sqm * qty;  // Multiply by qty to get total for this item
                        console.log('    ‚Üí Item matched: ' + item.desc + ' | sqm: ' + sqm + ' | qty: ' + qty + ' | total: ' + itemTotalSqm);
                        colorSQM += itemTotalSqm;
                        itemsForColor.push({ desc: item.desc, sqm: item.sqm, qty: item.qty });
                    }
                });
                
                console.log('MIXING CARD - Color "' + color + '": ' + itemsForColor.length + ' items matched, colorSQM=' + colorSQM);
                
                // If no items matched this color, use proportional amount
                if (colorSQM === 0 && totalSQM > 0) {
                    colorSQM = totalSQM / colors.length;
                    console.log('  ‚Üí No items matched, using proportional: ' + colorSQM);
                }
                console.log('MIXING CARD COLOR - color: ' + color + ', colorSQM: ' + colorSQM + ', totalSQM: ' + totalSQM);
                
                // ===== JOB DETAILS - LARGER FONTS =====
                const leftCol = 20;
                const rightCol = 110;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Job Name', leftCol, y);
                doc.text('Job #', rightCol, y);
                y += 6;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(13);
                doc.text(jobName.substring(0, 30), leftCol, y);
                doc.text(jobNum, rightCol, y);
                y += 10;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Client', leftCol, y);
                doc.text('Date', rightCol, y);
                y += 6;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(13);
                doc.text(jobClient.substring(0, 40), leftCol, y);
                doc.text(dateReceived, rightCol, y);
                y += 12;
                
                // Count total parts for this color
                let partCount = 0;
                items.forEach(item => {
                    const itemColor = (item.color || '').trim().toLowerCase();
                    const searchColor = color.toLowerCase();
                    
                    if (itemColor && itemColor === searchColor) {
                        partCount += parseInt(item.qty) || 1;
                    }
                });
                
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('SQ Metres', leftCol, y);
                doc.text('Parts', (leftCol + rightCol) / 2, y);
                doc.text('Paint Required', rightCol, y);
                y += 6;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(14);
                doc.setTextColor(200, 30, 30);
                doc.text(colorSQM.toFixed(2) + ' m¬≤', leftCol, y);
                doc.text(String(partCount), (leftCol + rightCol) / 2, y);
                
                // Calculate paint qty: 0.2L per m¬≤
                const paintQty = (colorSQM * 0.2).toFixed(1);
                doc.text(paintQty + ' L', rightCol, y);
                y += 14;
                
                // ===== DIVIDER =====
                doc.setDrawColor(170, 132, 30);
                doc.setLineWidth(1.5);
                doc.line(20, y, 190, y);
                y += 8;
                
                doc.setTextColor(0, 0, 0);
                
                // ===== TINTS/COLOURANTS - EXPANDED FOR FULL EVIC FORMULA =====
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('TINT FORMULA - EVIC DETAILS', 20, y);
                y += 5;
                
                // Add subtitle showing this is for 1 litre
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(200, 30, 30);
                doc.text('(Weights for 1 Litre of Paint)', 20, y);
                doc.setTextColor(0, 0, 0);
                y += 8;
                
                doc.setFontSize(11);  // INCREASED from 9
                doc.setFont(undefined, 'normal');
                
                // Draw formula box
                const boxHeight = pageHeight - y - 30;
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.rect(20, y, 170, boxHeight);
                
                let boxY = y + 10;  // INCREASED from 5 - more top padding
                
                if (formula) {
                    // Show Evic Code and Base Type at top - ALWAYS, EVEN IF EMPTY
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    
                    // ALWAYS show Evic Code
                    const evicCodeValue = formula.evicCode || '_____________________________';
                    doc.text(`Evic Code: ${evicCodeValue}`, 25, boxY);
                    boxY += 7;
                    
                    // ALWAYS show Base Type
                    const baseTypeValue = formula.baseType || '______________________________';
                    doc.text(`Base Type: ${baseTypeValue}`, 25, boxY);
                    boxY += 7;
                    
                    // Show Base Color
                    const baseColorValue = formula.baseColor || 'White';
                    doc.text(`Base Color: ${baseColorValue}`, 25, boxY);
                    boxY += 7;
                    
                    // Show version if available
                    if (formula.version) {
                        doc.text(`Version: ${formula.version}`, 25, boxY);
                        boxY += 7;
                    }
                    
                    boxY += 5;  // Just add spacing, no divider line
                    
                    // BASE section - ALWAYS SHOW HEADER
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Base:', 25, boxY);
                    doc.text('RUNNING TOTAL', 140, boxY);  // MOVED LEFT from 155 to give right margin
                    boxY += 7;
                    
                    // Show base items if available, otherwise show placeholders
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    
                    let runningTotal = 0;
                    const baseItemsToShow = 3;  // Always show 3 base item rows
                    
                    if (formula.whiteBase && formula.whiteBase.length > 0) {
                        formula.whiteBase.forEach((item, idx) => {
                            const code = item.code || '';
                            // Robust parsing: handle "1,359.04", "1.359,04", "1359.04", etc.
                            let gramStr = String(item.grams || '0').trim();
                            let grams = 0;
                            
                            
                            // Remove any spaces
                            gramStr = gramStr.replace(/\s/g, '');
                            
                            // If it contains both comma and period, determine which is decimal
                            if (gramStr.includes(',') && gramStr.includes('.')) {
                                // Find which comes last (that's the decimal separator)
                                const lastCommaIdx = gramStr.lastIndexOf(',');
                                const lastPeriodIdx = gramStr.lastIndexOf('.');
                                if (lastCommaIdx > lastPeriodIdx) {
                                    // Comma is decimal: "1.234,56" ‚Üí remove periods, replace comma with period
                                    grams = parseFloat(gramStr.replace(/\./g, '').replace(',', '.'));
                                } else {
                                    // Period is decimal: "1,234.56" ‚Üí remove commas
                                    grams = parseFloat(gramStr.replace(/,/g, ''));
                                }
                            } else if (gramStr.includes(',')) {
                                // Only comma: could be decimal or thousand separator
                                if (gramStr.split(',')[1]?.length === 2) {
                                    // Likely decimal: "1,234" or "5,88"
                                    grams = parseFloat(gramStr.replace(',', '.'));
                                } else {
                                    // Likely thousand separator (European): "1,359.04" stored as "1,359"
                                    grams = parseFloat(gramStr.replace(',', '.'));
                                }
                            } else if (gramStr.includes('.')) {
                                // Only period: parseFloat directly
                                grams = parseFloat(gramStr);
                            } else {
                                // No separator: just a number
                                grams = parseFloat(gramStr);
                            }
                            
                            grams = isNaN(grams) ? 0 : grams;
                            runningTotal += grams;
                            doc.text(`${code}: ${grams.toFixed(2)}g`, 30, boxY);
                            doc.text(`${runningTotal.toFixed(2)}g`, 140, boxY);
                            boxY += 5;
                        });
                        // Fill remaining rows with blanks
                        for (let i = formula.whiteBase.length; i < baseItemsToShow; i++) {
                            doc.text(`Item ${i + 1}: _____________ g`, 30, boxY);
                            doc.text('_________ g', 140, boxY);  // MOVED LEFT
                            boxY += 5;
                        }
                    } else {
                        // No base items - show all placeholders
                        for (let i = 0; i < baseItemsToShow; i++) {
                            doc.text(`Item ${i + 1}: _____________ g`, 30, boxY);
                            doc.text('_________ g', 140, boxY);  // MOVED LEFT
                            boxY += 5;
                        }
                    }
                    boxY += 2;
                    
                    // TINTERS section - ALWAYS SHOW HEADER
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('TINTERS:', 25, boxY);
                    doc.text('RUNNING TOTAL', 140, boxY);  // MOVED LEFT from 155
                    boxY += 7;
                    
                    // Show tinters - show ALL actual tinters, fill remaining to 4 rows with placeholders numbered properly
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    
                    const minTintersToShow = 4;  // Always show at least 4 rows
                    let tinterRunningTotal = 0;
                    let actualTinterCount = 0;
                    
                    if (formula.colourants && formula.colourants.length > 0) {
                        // Show ALL actual tinter data first
                        formula.colourants.forEach((tint, idx) => {
                            const code = tint.code || '';
                            // Robust parsing: handle all decimal formats
                            let gramStr = String(tint.amount || tint.grams || '0').trim();
                            let grams = 0;
                            
                            gramStr = gramStr.replace(/\s/g, '');
                            
                            if (gramStr.includes(',') && gramStr.includes('.')) {
                                const lastCommaIdx = gramStr.lastIndexOf(',');
                                const lastPeriodIdx = gramStr.lastIndexOf('.');
                                if (lastCommaIdx > lastPeriodIdx) {
                                    grams = parseFloat(gramStr.replace(/\./g, '').replace(',', '.'));
                                } else {
                                    grams = parseFloat(gramStr.replace(/,/g, ''));
                                }
                            } else if (gramStr.includes(',')) {
                                grams = parseFloat(gramStr.replace(',', '.'));
                            } else if (gramStr.includes('.')) {
                                grams = parseFloat(gramStr);
                            } else {
                                grams = parseFloat(gramStr);
                            }
                            
                            grams = isNaN(grams) ? 0 : grams;
                            const name = tint.name || '';
                            tinterRunningTotal += grams;
                            doc.text(`${code}: ${grams.toFixed(2)}g ${name}`, 30, boxY);
                            doc.text(`${tinterRunningTotal.toFixed(2)}g`, 140, boxY);
                            boxY += 5;
                            actualTinterCount++;
                        });
                        
                        // Fill remaining with placeholder rows numbered from where we left off
                        for (let i = actualTinterCount; i < minTintersToShow; i++) {
                            doc.text(`Tint ${i + 1}: _____________ g`, 30, boxY);
                            doc.text('_________ g', 140, boxY);
                            boxY += 5;
                        }
                    } else {
                        // No tinters - show all 4 placeholder rows
                        for (let i = 0; i < minTintersToShow; i++) {
                            doc.text(`Tint ${i + 1}: _____________ g`, 30, boxY);
                            doc.text('_________ g', 140, boxY);
                            boxY += 5;
                        }
                    }
                    
                    boxY += 3;
                    
                    // Total weight - ALWAYS SHOW with robust parsing
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    
                    let totalWeightValue = '_______________ grams';
                    if (formula.totalWeight) {
                        let twStr = String(formula.totalWeight).trim();
                        let totalWeight = 0;
                        
                        console.log(`üíæ PAGE 2 TOTAL WEIGHT PROCESSING:`);
                        
                        twStr = twStr.replace(/\s/g, '').replace('g', '').replace('grams', '');
                        
                        if (twStr.includes(',') && twStr.includes('.')) {
                            const lastCommaIdx = twStr.lastIndexOf(',');
                            const lastPeriodIdx = twStr.lastIndexOf('.');
                            if (lastCommaIdx > lastPeriodIdx) {
                                totalWeight = parseFloat(twStr.replace(/\./g, '').replace(',', '.'));
                            } else {
                                totalWeight = parseFloat(twStr.replace(/,/g, ''));
                            }
                        } else if (twStr.includes(',')) {
                            totalWeight = parseFloat(twStr.replace(',', '.'));
                        } else if (twStr.includes('.')) {
                            totalWeight = parseFloat(twStr);
                        } else {
                            totalWeight = parseFloat(twStr);
                        }
                        
                        totalWeightValue = isNaN(totalWeight) ? '_______________ grams' : `${totalWeight.toFixed(2)} grams`;
                    } else {
                        console.log(`  ‚ö†Ô∏è NO TOTAL WEIGHT IN FORMULA`);
                    }
                    
                    doc.text(`TOTAL WEIGHT: ${totalWeightValue}`, 25, boxY);
                } else {
                    // Blank template with LARGER fonts - SAME FORMAT AS FILLED
                    let blankBoxY = boxY + 5;  // Add padding for blank template too
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Evic Code: _____________________________', 25, blankBoxY);
                    blankBoxY += 7;
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Base Type: ______________________________', 25, blankBoxY);
                    blankBoxY += 7;
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Base Color: ______________________________', 25, blankBoxY);
                    blankBoxY += 7;
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('Base:', 25, blankBoxY);
                    doc.text('RUNNING TOTAL', 140, blankBoxY);  // MOVED LEFT from 155
                    blankBoxY += 7;
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    for (let i = 0; i < 3; i++) {
                        doc.text(`Item ${i + 1}: _____________ g`, 30, blankBoxY);
                        doc.text('_________ g', 140, blankBoxY);  // MOVED LEFT
                        blankBoxY += 6;
                    }
                    blankBoxY += 3;
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text('TINTERS:', 25, blankBoxY);
                    doc.text('RUNNING TOTAL', 140, blankBoxY);  // MOVED LEFT from 155
                    blankBoxY += 7;
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    for (let i = 0; i < 4; i++) {
                        doc.text(`Tint ${i + 1}: _____________ g`, 30, blankBoxY);
                        doc.text('_________ g', 140, blankBoxY);  // MOVED LEFT
                        blankBoxY += 6;
                    }
                    blankBoxY += 2;
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('TOTAL WEIGHT: _______________ grams', 25, blankBoxY);
                }
                
                // ===== FOOTER AT BOTTOM =====
                doc.setFontSize(9);
                doc.setFont(undefined, 'italic');
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated: ${new Date().toLocaleDateString('en-AU')} | ${color} | Base: ${paintQty}L | SQM: ${colorSQM.toFixed(2)}`, 20, pageHeight - 8);
                
                doc.text('¬© 2026 - PaintWorkz Pro Software', 20, pageHeight - 5);
                
                // ===== SECOND PAGE - SCALED FORMULA FOR JOB REQUIREMENT =====
                // Add new page for scaled recipe
                doc.addPage();
                let y2 = 15;
                
                // Logo on second page
                if (headerLogo) {
                    try {
                        doc.addImage(headerLogo, 'PNG', 145, 5, 50, 20);
                    } catch(e) {}
                }
                
                // Title
                doc.setFontSize(28);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('MIXING CARD', 20, y2);
                y2 += 12;
                
                // Paint info box
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.setFillColor(255, 255, 255);
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(1);
                doc.rect(20, y2, 170, 24, 'FD');
                doc.text(paintInfo, 25, y2 + 16);
                y2 += 28;
                y2 += 8;
                
                // Job details (same as page 1)
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Job Name', 20, y2);
                doc.text('Job #', 110, y2);
                y2 += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(13);
                doc.text(jobName.substring(0, 30), 20, y2);
                doc.text(jobNum, 110, y2);
                y2 += 10;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Client', 20, y2);
                doc.text('Date', 110, y2);
                y2 += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(13);
                doc.text(jobClient.substring(0, 40), 20, y2);
                doc.text(dateReceived, 110, y2);
                y2 += 10;
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('SQM', 20, y2);
                doc.text('Paint Required', 110, y2);
                y2 += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(13);
                doc.text(colorSQM.toFixed(2), 20, y2);
                doc.text(paintQty + ' L', 110, y2);
                y2 += 12;
                
                // TINT FORMULA HEADER - SCALED VERSION
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text('TINT FORMULA - EVIC DETAILS', 20, y2);
                y2 += 5;
                
                // Add subtitle showing this is SCALED for job requirement
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(200, 30, 30);
                doc.text(`(Weights for ${paintQty} Litres of Paint - Job Requirement)`, 20, y2);
                doc.setTextColor(0, 0, 0);
                y2 += 8;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                // Draw formula box
                const boxHeight2 = pageHeight - y2 - 30;
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.rect(20, y2, 170, boxHeight2);
                
                let boxY2 = y2 + 10;
                const scaleFactor = parseFloat(paintQty); // Multiply all weights by this factor
                
                if (formula) {
                    // Show Evic Code and Base Type at top
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Evic Code: ${formula.evicCode || '_____________________________'}`, 25, boxY2);
                    boxY2 += 7;
                    doc.text(`Base Type: ${formula.baseType || '______________________________'}`, 25, boxY2);
                    boxY2 += 7;
                    doc.text(`Base Color: ${formula.baseColor || 'White'}`, 25, boxY2);
                    boxY2 += 7;
                    if (formula.version) {
                        doc.text(`Version: ${formula.version}`, 25, boxY2);
                        boxY2 += 7;
                    }
                    
                    boxY2 += 5;
                    
                    // BASE section with SCALED values
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('Base:', 25, boxY2);
                    doc.text('RUNNING TOTAL', 140, boxY2);
                    boxY2 += 7;
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    
                    let runningTotal2 = 0;
                    const baseItemsToShow2 = 3;
                    
                    if (formula.whiteBase && formula.whiteBase.length > 0) {
                        formula.whiteBase.forEach((item, idx) => {
                            const code = item.code || '';
                            let gramStr = String(item.grams || '0').trim();
                            let grams = parseFloat(gramStr.replace(/[\s,]/g, '.'));
                            grams = isNaN(grams) ? 0 : grams;
                            
                            // SCALE the grams
                            const scaledGrams = grams * scaleFactor;
                            runningTotal2 += scaledGrams;
                            
                            doc.text(`${code}: ${scaledGrams.toFixed(2)}g`, 30, boxY2);
                            doc.text(`${runningTotal2.toFixed(2)}g`, 140, boxY2);
                            boxY2 += 5;
                        });
                        
                        // Fill remaining rows
                        for (let i = formula.whiteBase.length; i < baseItemsToShow2; i++) {
                            doc.text(`Item ${i + 1}: _____________ g`, 30, boxY2);
                            doc.text('_________ g', 140, boxY2);
                            boxY2 += 5;
                        }
                    } else {
                        for (let i = 0; i < baseItemsToShow2; i++) {
                            doc.text(`Item ${i + 1}: _____________ g`, 30, boxY2);
                            doc.text('_________ g', 140, boxY2);
                            boxY2 += 5;
                        }
                    }
                    boxY2 += 2;
                    
                    // TINTERS section with SCALED values
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('TINTERS:', 25, boxY2);
                    doc.text('RUNNING TOTAL', 140, boxY2);
                    boxY2 += 7;
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    
                    const minTintersToShow2 = 4;
                    let tinterRunningTotal2 = 0;
                    let actualTinterCount2 = 0;
                    
                    if (formula.colourants && formula.colourants.length > 0) {
                        formula.colourants.forEach((tint, idx) => {
                            const code = tint.code || '';
                            let gramStr = String(tint.amount || tint.grams || '0').trim();
                            let grams = parseFloat(gramStr.replace(/[\s,]/g, '.'));
                            grams = isNaN(grams) ? 0 : grams;
                            
                            // SCALE the grams
                            const scaledGrams = grams * scaleFactor;
                            const name = tint.name || '';
                            tinterRunningTotal2 += scaledGrams;
                            
                            doc.text(`${code}: ${scaledGrams.toFixed(2)}g ${name}`, 30, boxY2);
                            doc.text(`${tinterRunningTotal2.toFixed(2)}g`, 140, boxY2);
                            boxY2 += 5;
                            actualTinterCount2++;
                        });
                        
                        for (let i = actualTinterCount2; i < minTintersToShow2; i++) {
                            doc.text(`Tint ${i + 1}: _____________ g`, 30, boxY2);
                            doc.text('_________ g', 140, boxY2);
                            boxY2 += 5;
                        }
                    } else {
                        for (let i = 0; i < minTintersToShow2; i++) {
                            doc.text(`Tint ${i + 1}: _____________ g`, 30, boxY2);
                            doc.text('_________ g', 140, boxY2);
                            boxY2 += 5;
                        }
                    }
                    
                    boxY2 += 3;
                    
                    // TOTAL WEIGHT for scaled version
                    const totalBase = formula.whiteBase ? formula.whiteBase.reduce((sum, item) => {
                        let grams = parseFloat(String(item.grams || '0').replace(/[\s,]/g, '.'));
                        return sum + (isNaN(grams) ? 0 : grams);
                    }, 0) : 0;
                    
                    const totalTinters = formula.colourants ? formula.colourants.reduce((sum, item) => {
                        let grams = parseFloat(String(item.amount || item.grams || '0').replace(/[\s,]/g, '.'));
                        return sum + (isNaN(grams) ? 0 : grams);
                    }, 0) : 0;
                    
                    const totalWeight2 = (totalBase + totalTinters) * scaleFactor;
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`TOTAL WEIGHT: ${totalWeight2.toFixed(2)} grams`, 25, boxY2);
                }
                
                // Footer for second page
                doc.setFontSize(9);
                doc.setFont(undefined, 'italic');
                doc.setTextColor(100, 100, 100);
                doc.text(`Generated: ${new Date().toLocaleDateString('en-AU')} | ${color} | Scaled: ${paintQty}L | SQM: ${colorSQM.toFixed(2)}`, 20, pageHeight - 8);
                doc.text('¬© 2026 - PaintWorkz Pro Software', 20, pageHeight - 5);
                
                colorPageCount++;
            });
            
            // Save combined PDF with all colors
            const pdfDataUri = doc.output('datauristring');
            const filename = `MixingCard_${jobNum}_${new Date().toISOString().split('T')[0]}.pdf`;
            
            showPDFPreview(pdfDataUri, filename, 'üé® Mixing Card Preview');
            if (colors.length > 1) {
                notify(`‚úì Mixing Card Ready - ${colors.length} pages (one per color)`);
            } else {
                notify('‚úì Mixing Card Ready');
            }
        } catch (err) {
            console.error('Mixing card error:', err);
            notify('‚ùå Error generating mixing card');
        }
    }
                
    function genCoverSheet() {
        // COVER SHEET - passes isCoverSheet=true to auto-fill finish date
        genShopLabel(true);
    }
    
    function genShopLabel(isCoverSheet = false) {
        try {
            if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                notify('‚ùå PDF library not loaded. Please refresh.');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            
            // Get job data
            const jobClient = document.getElementById('cli')?.value || 'CLIENT';
            const jobNum = document.getElementById('jNum')?.value || document.getElementById('jN')?.value || 'XXX';
            const jobName = document.getElementById('jNm')?.value || 'Job Name';
            const dateReceived = document.getElementById('dat')?.value || new Date().toLocaleDateString('en-AU');
            const totalSQM = parseFloat(document.getElementById('tot')?.innerText || '0') || 0;
            
            // Get job completion date from history (if marked complete)
            let dateFinished = '';
            const jobHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            console.log(`üìã Looking for job: #${jobNum} | Client: ${jobClient} | Date: ${dateReceived}`);
            console.log(`üìã Total jobs in history: ${jobHistory.length}`);
            
            const currentJob = jobHistory.find(j => j.jobNum === jobNum && j.client === jobClient && j.dateReceived === dateReceived);
            if (currentJob) {
                console.log(`‚úÖ FOUND job in history:`, currentJob);
                if (currentJob.dateCompleted) {
                    dateFinished = currentJob.dateCompleted;
                    console.log(`‚úÖ Found completion date: ${dateFinished}`);
                } else {
                    console.warn(`‚ö†Ô∏è Job found but no dateCompleted field`);
                }
            } else {
                console.warn(`‚ùå Job NOT found in history`);
                console.log(`Available jobs:`, jobHistory.map(j => `#${j.jobNum} | ${j.client} | ${j.dateReceived}`));
            }
            
            // Get scheduled finish date from job timeline (for shop label)
            let scheduledFinish = '';
            if (currentJob && currentJob.timeline) {
                scheduledFinish = getScheduledFinishDate(dateReceived, currentJob.timeline);
                console.log(`üìÖ Scheduled finish: ${scheduledFinish}`);
            } else if (currentJob) {
                console.warn(`‚ö†Ô∏è Job found but no timeline field`);
            }
            
            // Paint data - get brand/finish from FIRST ITEM (all parts should have same brand)
            const defaultBrand = (items[0]?.brand) || document.getElementById('p-brand')?.value || 'Dulux';
            const defaultFinish = (items[0]?.finish) || document.getElementById('p-finish')?.value || 'Satin';
            
            // Get unique colors from items in measure tab
            const uniqueColors = new Set();
            items.forEach(item => {
                if (item.color && item.color.trim()) {
                    uniqueColors.add(item.color.trim());
                }
            });
            
            // Convert to array and sort
            const colors = Array.from(uniqueColors).sort();
            
            console.log('üé® Shop Label Color Detection:', {
                uniqueColors: Array.from(uniqueColors),
                colorCount: colors.length,
                itemCount: items.length
            });
            
            if (colors.length === 0) {
                notify('‚ùå No paint colors found in items. Assign colors to all parts in Measure tab.');
                return;
            }
            
            // Create one PDF with one page per color
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let colorPageCount = 0;
            
            colors.forEach((color, colorIndex) => {
                
                if (colorPageCount > 0) {
                    doc.addPage();
                }
                
                let y = 8;
                
                // ===== GET BRAND AND FINISH FOR THIS COLOR FROM ITEMS =====
                // Look for first item with this color to get brand/finish
                let colorBrand = defaultBrand;
                let colorFinish = defaultFinish;
                
                const colorItem = items.find(item => {
                    const itemColor = (item.color || '').trim().toLowerCase();
                    return itemColor && itemColor === color.toLowerCase();
                });
                if (colorItem) {
                    colorBrand = colorItem.brand || defaultBrand;
                    colorFinish = colorItem.finish || defaultFinish;
                }
                
                
                // ===== HEADER BOX WITH ENLARGED LOGO & ROUNDED CORNERS =====
                const headerX = 12;
                const headerY = y;
                const headerWidth = pageWidth - 24;
                const headerHeight = 32;
                
                // Gold rounded border box
                doc.setDrawColor(212, 175, 55);
                doc.setLineWidth(2.5);
                doc.setFillColor(245, 245, 245);
                doc.rect(headerX, headerY, headerWidth, headerHeight, 'FD');
                
                // Enlarged PAINTWORKZ branding (18pt, gold) - CENTERED IN BOX
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(212, 175, 55);
                const paintworkzText = 'PAINTWORKZ';
                const paintworkzWidth = doc.getTextWidth(paintworkzText);
                const headerCenterX = headerX + (headerWidth - paintworkzWidth) / 2;
                doc.text(paintworkzText, headerCenterX, headerY + 12);
                
                // Subtitle & contact - CENTERED IN BOX
                doc.setFontSize(7);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                const subtitleText = 'Ph: 0438 803 032';
                const subtitleWidth = doc.getTextWidth(subtitleText);
                const subtitleX = headerX + (headerWidth - subtitleWidth) / 2;
                doc.text(subtitleText, subtitleX, headerY + 19);
                
                const addressText = '17 West Boundary Rd, Hamilton 3300 VIC';
                const addressWidth = doc.getTextWidth(addressText);
                const addressX = headerX + (headerWidth - addressWidth) / 2;
                doc.text(addressText, addressX, headerY + 25);
                
                y += headerHeight + 10;
                
                // ===== JOB NUMBER - CENTERED AND LARGE =====
                doc.setFontSize(56);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(200, 30, 30);
                const jobNumWidth = doc.getTextWidth(`Job: ${jobNum}`);
                doc.text(`Job: ${jobNum}`, (pageWidth - jobNumWidth) / 2, y + 18);
                y += 30;
                
                // Gold separator line
                doc.setDrawColor(170, 132, 30);
                doc.setLineWidth(3);
                doc.line(20, y, pageWidth - 20, y);
                y += 12;
                
                // ===== CUSTOMER NAME - VERY LARGE - CENTERED =====
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                const customerName = jobClient.toUpperCase();
                const customerWidth = doc.getTextWidth(customerName);
                doc.text(customerName, (pageWidth - customerWidth) / 2, y);
                y += 12;
                
                // ===== JOB NAME & DATE - CENTERED =====
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                const jobText = `Job: ${jobName}`;
                const jobWidth = doc.getTextWidth(jobText);
                doc.text(jobText, (pageWidth - jobWidth) / 2, y);
                y += 8;
                
                const dateText = `Date Received: ${dateReceived}`;
                const dateWidth = doc.getTextWidth(dateText);
                doc.text(dateText, (pageWidth - dateWidth) / 2, y);
                y += 6;
                
                // Finish Date - auto-filled ONLY for cover sheet, scheduled for shop label
                let finishDateText;
                if (isCoverSheet && dateFinished) {
                    finishDateText = `Finish Date: ${dateFinished}`;
                } else if (isCoverSheet) {
                    finishDateText = 'Finish Date: Pending';
                } else if (scheduledFinish) {
                    finishDateText = `Scheduled Finish: ${scheduledFinish}`;
                } else {
                    finishDateText = 'Scheduled Finish: _____________________';
                }
                const finishDateWidth = doc.getTextWidth(finishDateText);
                doc.text(finishDateText, (pageWidth - finishDateWidth) / 2, y);
                y += 10;
                
                // ===== CALCULATIONS FOR THIS COLOR =====
                let colorSQM = 0;
                let colorProfiles = {};
                
                items.forEach(item => {
                    const itemColor = (item.color || '').trim().toLowerCase();
                    const searchColor = color.toLowerCase();
                    
                    if (itemColor && itemColor === searchColor) {
                        const sqm = parseFloat(item.sqm) || 0;
                        const qty = parseInt(item.qty) || 1;
                        colorSQM += (sqm * qty);  // Multiply by qty to get total for this item
                        const profile = item.profile || 'Various';
                        colorProfiles[profile] = (colorProfiles[profile] || 0) + qty;
                    }
                });
                
                // If no items matched, use proportional
                if (colorSQM === 0 && totalSQM > 0) {
                    colorSQM = totalSQM / colors.length;
                }
                
                const paintRequired = (colorSQM * 0.2).toFixed(1);
                
                // Calculate total parts for this color
                let colorPartCount = 0;
                items.forEach(item => {
                    const itemColor = (item.color || '').trim().toLowerCase();
                    const searchColor = color.toLowerCase();
                    
                    if (itemColor && itemColor === searchColor) {
                        const qty = parseInt(item.qty) || 1;
                        colorPartCount += qty;
                    }
                });
                
                // ===== KEY METRICS - CENTERED - SQM, PART QTY, AND PAINT =====
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(200, 30, 30);
                
                const sqmText = `SQM: ${colorSQM.toFixed(2)} m¬≤`;
                const sqmWidth = doc.getTextWidth(sqmText);
                doc.text(sqmText, (pageWidth - sqmWidth) / 2, y);
                y += 8;
                
                const partText = `Part Qty: ${colorPartCount}`;
                const partWidth = doc.getTextWidth(partText);
                doc.text(partText, (pageWidth - partWidth) / 2, y);
                y += 8;
                
                const paintText = `PAINT: ${paintRequired} L`;
                const paintWidth = doc.getTextWidth(paintText);
                doc.text(paintText, (pageWidth - paintWidth) / 2, y);
                y += 12;
                
                // ===== DIVIDER - CENTERED =====
                doc.setDrawColor(170, 132, 30);
                doc.setLineWidth(1.5);
                const centerX = pageWidth / 2;
                doc.line(centerX - 50, y, centerX + 50, y);  // Centered divider line
                y += 12;
                
                // ===== PAINT DETAILS - CENTERED =====
                const paintDetailsText = `${colorBrand} | ${color.toUpperCase()} | ${colorFinish}`;
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                const paintDetailsWidth = doc.getTextWidth(paintDetailsText);
                doc.text(paintDetailsText, (pageWidth - paintDetailsWidth) / 2, y);
                y += 12;
                
                // ===== DOOR PROFILES - SEPARATE MOULDED, FLAT & CUSTOM =====
                console.log('üîç Shop Label Debug:', {
                    color: color,
                    totalItems: items.length,
                    items: items.map(i => ({
                        prof: i.prof,
                        fm: i.fm,
                        type: i.type,
                        desc: i.desc,
                        qty: i.qty,
                        color: i.color
                    }))
                });
                
                let mouldedParts = {};
                let flatParts = {};
                let customParts = {};
                let mouldedCount = 0;
                let flatCount = 0;
                let customCount = 0;
                let allPartCount = 0;
                
                items.forEach(item => {
                    const itemColor = (item.color || '').toLowerCase().trim();
                    const targetColor = (color || '').toLowerCase().trim();
                    const colorMatch = itemColor === targetColor; // Only match exact color
                    
                    if (colorMatch) {
                        const profile = (item.prof || item.profile || 'Various').trim();
                        const qty = parseInt(item.qty) || 1;
                        const isMoulded = (item.fm || '').toLowerCase() === 'moulded';
                        const isCustom = (item.type || '').toUpperCase() === 'CUSTOM';
                        
                        allPartCount += qty;
                        
                        if (isCustom) {
                            const customDesc = (item.desc || 'Custom').toUpperCase();
                            customParts[customDesc] = (customParts[customDesc] || 0) + qty;
                            customCount += qty;
                        } else if (isMoulded) {
                            mouldedParts[profile] = (mouldedParts[profile] || 0) + qty;
                            mouldedCount += qty;
                        } else {
                            flatParts[profile] = (flatParts[profile] || 0) + qty;
                            flatCount += qty;
                        }
                    }
                });
                
                console.log('üìä Profile Counts:', {
                    mouldedCount,
                    flatCount,
                    customCount,
                    allPartCount,
                    mouldedParts,
                    flatParts,
                    customParts
                });
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                const mouldedHeaderText = 'MOULDED PARTS';
                const mouldedHeaderWidth = doc.getTextWidth(mouldedHeaderText);
                doc.text(mouldedHeaderText, (pageWidth - mouldedHeaderWidth) / 2, y);
                y += 7;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                if (mouldedCount > 0) {
                    Object.entries(mouldedParts).forEach(([profile, qty]) => {
                        const mouldedText = `‚Ä¢ ${profile}: ${qty}`;
                        const mouldedWidth = doc.getTextWidth(mouldedText);
                        doc.text(mouldedText, (pageWidth - mouldedWidth) / 2, y);
                        y += 6;
                    });
                    y += 2;
                } else {
                    const noneText = 'None';
                    const noneWidth = doc.getTextWidth(noneText);
                    doc.text(noneText, (pageWidth - noneWidth) / 2, y);
                    y += 6;
                    y += 2;
                }
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                const flatHeaderText = 'FLAT PANEL PARTS';
                const flatHeaderWidth = doc.getTextWidth(flatHeaderText);
                doc.text(flatHeaderText, (pageWidth - flatHeaderWidth) / 2, y);
                y += 7;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                if (flatCount > 0) {
                    Object.entries(flatParts).forEach(([profile, qty]) => {
                        const flatText = `‚Ä¢ ${profile}: ${qty}`;
                        const flatWidth = doc.getTextWidth(flatText);
                        doc.text(flatText, (pageWidth - flatWidth) / 2, y);
                        y += 6;
                    });
                    y += 2;
                } else {
                    const flatNoneText = 'None';
                    const flatNoneWidth = doc.getTextWidth(flatNoneText);
                    doc.text(flatNoneText, (pageWidth - flatNoneWidth) / 2, y);
                    y += 6;
                    y += 2;
                }
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                const customHeaderText = 'CUSTOM PARTS';
                const customHeaderWidth = doc.getTextWidth(customHeaderText);
                doc.text(customHeaderText, (pageWidth - customHeaderWidth) / 2, y);
                y += 7;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                if (customCount > 0) {
                    Object.entries(customParts).forEach(([desc, qty]) => {
                        const customText = `‚Ä¢ ${desc}: ${qty}`;
                        const customWidth = doc.getTextWidth(customText);
                        doc.text(customText, (pageWidth - customWidth) / 2, y);
                        y += 6;
                    });
                } else {
                    const customNoneText = 'None';
                    const customNoneWidth = doc.getTextWidth(customNoneText);
                    doc.text(customNoneText, (pageWidth - customNoneWidth) / 2, y);
                    y += 6;
                }
                
                y += 8;
                
                // Define bottom margin for spacing calculations
                const bottomMargin = 15; // 15mm margin at bottom
                
                // Limit how far down parts can extend before blue box
                const maxYBeforeBlueBox = pageHeight - bottomMargin - 50;
                if (y > maxYBeforeBlueBox) {
                    y = maxYBeforeBlueBox;
                }
                
                // ===== FORM SEPARATOR - MOVED TO FOOTER =====
                // Will be rendered at bottom on same line as Generated
                
                // ===== COLOR SWATCH BOX - SMALL BOX ABOVE FOOTER WITH CLEARANCE =====
                const swatchX = 20;
                const swatchY = pageHeight - bottomMargin - 20;  // Moved down lower on page
                const swatchWidth = pageWidth - 40;
                const swatchHeight = 20;  // Much smaller height
                
                // Dark border box
                doc.setDrawColor(50, 50, 50);
                doc.setLineWidth(2);
                doc.setFillColor(100, 150, 200);
                doc.rect(swatchX, swatchY, swatchWidth, swatchHeight, 'FD');
                
                // Paint brand, color, finish - CENTERED BOTH HORIZONTALLY AND VERTICALLY
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                const swatchText = `${colorBrand} | ${color.toUpperCase()} | ${colorFinish}`;
                const swatchTextWidth = doc.getTextWidth(swatchText);
                const swatchCenterX = swatchX + (swatchWidth - swatchTextWidth) / 2;
                const swatchCenterY = swatchY + (swatchHeight / 2) + 2;  // Centered vertically in box
                doc.text(swatchText, swatchCenterX, swatchCenterY);
                
                // ===== FOOTER - RESPECTING 15MM MARGIN =====
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                doc.setTextColor(100, 100, 100);
                const footerText = `Generated: ${new Date().toLocaleDateString('en-AU')} | ‚öñÔ∏è PaintWorkz Pro ¬© 2026`;
                doc.text(footerText, 20, pageHeight - 8);
                
                doc.text('¬© 2026 - PaintWorkz Pro Software', 20, pageHeight - 5);
                // ===== PAINT FORM TEXT - BOTTOM RIGHT ON FOOTER LINE =====
                if (colors.length > 1) {
                    const formText = `PAINT FORM ${colorPageCount + 1} OF ${colors.length}`;
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(200, 30, 30);
                    const formWidth = doc.getTextWidth(formText);
                    doc.text(formText, pageWidth - formWidth - 10, pageHeight - 8);  // Right aligned at footer line
                }
                
                // ===== CUT-HERE indicator for multi-form jobs - REMOVED =====
                // No cut line needed
                
                colorPageCount++;
            });
            
            const filename = `ShopLabel_${jobNum}_${jobClient.replace(/\\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            const pdfDataUri = doc.output('datauristring');
            showPDFPreview(pdfDataUri, filename, 'üè∑Ô∏è Shop Label Preview');
            
            if (colors.length > 1) {
                notify(`‚úì Shop Label Ready - ${colors.length} pages (one per color)`);
            } else {
                notify('‚úì Shop Label Ready - Print & Post on Trolley');
            }
            
        } catch(err) {
            console.error('‚ùå Shop Label Error:', err);
            notify('‚ùå Error: ' + err.message);
        }
    }

    function openA3ScheduleModal() {
        const modal = document.getElementById('a3ScheduleModal');
        if (modal) {
            modal.style.display = 'flex';
            // Set default dates
            const today = new Date();
            document.getElementById('a3StartDate').valueAsDate = today;
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 30);
            document.getElementById('a3EndDate').valueAsDate = endDate;
        }
    }
    
    function closeA3ScheduleModal() {
        const modal = document.getElementById('a3ScheduleModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    function genPaintOrder() {
        try {
            const jsPDF = window.jspdf.jsPDF;
            const doc = new jsPDF('p', 'mm', 'a4');
            const items = window.pdfItemsToUse || window.items || [];
            const currentJob = JSON.parse(localStorage.getItem('currentJob')) || {};
            const currentClient = JSON.parse(localStorage.getItem('currentClient')) || {};
            const logoBase64 = localStorage.getItem('companyLogo');
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 10;
            let pageY = 8;
            
            // PAGE 1 - FORMATTED A4 FORM - SPREAD OUT WITH BIG HANDWRITING BOXES
            const marginL = 12;
            let yPos = 8;
            
            // Logo and header
            if (logoBase64) {
                try {
                    doc.addImage(logoBase64, 'PNG', marginL, yPos, 20, 18);
                } catch(e) {}
            }
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('Paint Order Form', pageWidth / 2, yPos + 5, { align: 'center' });
            
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.text('17 West Boundary Road Hamilton 3300', pageWidth / 2, yPos + 13, { align: 'center' });
            doc.text('Phone: 0438803032', pageWidth / 2, yPos + 16, { align: 'center' });
            doc.text('Email: paint_workz@outlook.com', pageWidth / 2, yPos + 19, { align: 'center' });
            
            yPos = 32;
            doc.setDrawColor(0);
            doc.setLineWidth(0.4);
            
            // BIG HANDWRITING BOXES - TALL & JOINED IN MIDDLE
            const boxW = (pageWidth - 2 * marginL) / 2 - 1.5;  // Two columns joined in middle
            const boxH = 18;  // MUCH TALLER for handwriting
            const midX = marginL + boxW + 3;  // Center gap
            
            // Row 1: Customer | Date
            doc.rect(marginL, yPos, boxW, boxH);
            doc.rect(midX, yPos, boxW, boxH);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Customer:', marginL + 2, yPos + 4);
            doc.text('Date:', midX + 2, yPos + 4);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(currentClient.name || '', marginL + 28, yPos + 4);
            doc.text(new Date().toLocaleDateString(), midX + 18, yPos + 4);
            yPos += boxH + 4;
            
            // Row 2: Address | Date Required
            doc.rect(marginL, yPos, boxW, boxH);
            doc.rect(midX, yPos, boxW, boxH);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Address:', marginL + 2, yPos + 4);
            doc.text('Date Required:', midX + 2, yPos + 4);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text((currentClient.address || '').substring(0, 40), marginL + 22, yPos + 4);
            yPos += boxH + 4;
            
            // Row 3: Contact | Job Ref
            doc.rect(marginL, yPos, boxW, boxH);
            doc.rect(midX, yPos, boxW, boxH);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Contact Number:', marginL + 2, yPos + 4);
            doc.text('Job Reference:', midX + 2, yPos + 4);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text(currentClient.phone || '', marginL + 36, yPos + 4);
            doc.text('Job #' + (currentJob.jobNo || currentJob.id || ''), midX + 30, yPos + 4);
            yPos += boxH + 8;
            
            // Edge Profile
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Edge Profile:', marginL, yPos);
            doc.setFontSize(8);
            doc.text('(Circle)', marginL, yPos + 3);
            yPos += 8;
            
            const edgeOpts = ['Square', '1mm Pencil', '2mm Pencil', '3mm Pencil'];
            const edgeX = [marginL + 12, marginL + 50, marginL + 90, marginL + 130];
            edgeOpts.forEach((opt, i) => {
                doc.circle(edgeX[i], yPos + 1, 1.5);
                doc.setFontSize(8);
                doc.text(opt, edgeX[i] + 4, yPos + 1.5);
            });
            yPos += 27;
            
            // Door Style
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Door Style:', marginL, yPos);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            doc.text('‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶', marginL + 32, yPos);
            yPos += 27;
            
            // Door Colour
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('Door Colour:', marginL, yPos);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            doc.text('‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶', marginL + 32, yPos);
            yPos += 32;
            
            // Gloss Level - SMALLER BOXES (4 options: Matt, Satin, Semi Gloss, Gloss)
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('Gloss Level:', marginL, yPos - 1);
            doc.setFontSize(8);
            doc.text('(Circle)', marginL, yPos + 2.5);
            
            const glossOpts = ['Matt', 'Satin', 'Semi Gloss', 'Gloss'];
            const glossBoxW = 28;  // SMALLER width
            let glossX = marginL + 42;
            glossOpts.forEach(g => {
                doc.rect(glossX, yPos, glossBoxW, 10);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.text(g, glossX + 2, yPos + 5.5);
                glossX += glossBoxW + 3;
            });
            yPos += 20;
            
            // Board Thickness - SMALLER BOXES (6 options: 18mm, 19mm, 21mm, 25mm, 32mm, OTHER)
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('Board Thickness:', marginL, yPos - 1);
            doc.setFontSize(8);
            doc.text('(Circle)', marginL, yPos + 2.5);
            
            const thickOpts = ['18mm', '19mm', '21mm', '25mm', '32mm', 'OTHER'];
            const thickBoxW = 22;  // SMALLER width to fit 6 boxes
            let thickX = marginL + 38;
            thickOpts.forEach(t => {
                doc.rect(thickX, yPos, thickBoxW, 10);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(7);
                doc.text(t, thickX + 1, yPos + 5.5);
                thickX += thickBoxW + 2;
            });
            yPos += 30;
            
            // Stretch down to 15mm from bottom (282mm on A4)
            const bottomMargin = 15;
            const pageHeight = doc.internal.pageSize.getHeight();
            const maxY = pageHeight - bottomMargin;
            const spacerY = maxY - yPos - 25;  // Account for measured by section + footer
            
            // Add spacing to push form down to near footer
            if (spacerY > 20) {
                yPos += (spacerY - 10);  // Leave some room for measured by
            }
            
            // Measured by
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            doc.text('Measured by Paintworkz', marginL, yPos);
            doc.text('‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶', marginL + 42, yPos);
            doc.text('DATE', pageWidth - marginL - 16, yPos);
            yPos += 7;
            
            doc.setFontSize(7);
            doc.text('*Door (has a face route)  Panel (has no face route)          *Mark R on edges you want returned. NOT x', marginL, yPos);
            
            // PAGE 2 - ITEMS TABLE
            doc.addPage();
            pageY = 10;
            
            if (logoBase64) {
                try {
                    doc.addImage(logoBase64, 'PNG', margin, pageY, 20, 18);
                } catch(e) {}
            }
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Paint Order Form', pageWidth / 2, pageY + 7, { align: 'center' });
            
            pageY = 35;
            
            // Table headers
            const cols = [13, 22, 12, 17, 17, 17, 20, 70];
            const headers = ['Line No', 'Door/Panel', 'Qty', 'Height (mm)', 'Width (mm)', 'Edge Profile', 'Paint Options', 'Description/Diagram'];
            
            doc.setLineWidth(0.4);
            let colX = margin;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(7);
            
            headers.forEach((h, i) => {
                doc.rect(colX, pageY, cols[i], 8);
                doc.text(h, colX + cols[i]/2, pageY + 4, { align: 'center', maxWidth: cols[i] - 1 });
                colX += cols[i];
            });
            
            pageY += 9;
            
            // Item rows - 9mm height to fit all 25 rows on one page
            doc.setFont(undefined, 'normal');
            doc.setFontSize(7);
            const maxRows = 25;
            
            for (let i = 0; i < maxRows; i++) {
                const item = items[i];
                const rowData = item ? [
                    (i + 1).toString(),
                    (item.desc || 'Door').substring(0, 10),
                    (item.qty || 1).toString(),
                    (item.h || 0).toString(),
                    (item.w || 0).toString(),
                    (item.prof || 'Plain').substring(0, 10),
                    item.doubleSide ? 'DS' : 'SS',
                    ''
                ] : [(i + 1).toString(), '', '', '', '', '', '', ''];
                
                colX = margin;
                rowData.forEach((data, j) => {
                    doc.rect(colX, pageY, cols[j], 9);
                    doc.text(data, colX + 1, pageY + 4.5, { maxWidth: cols[j] - 2 });
                    colX += cols[j];
                });
                pageY += 9;
            }
            
            pageY += 3;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            doc.text('NOTES -----', margin, pageY);
            
            const filename = `Paint_Order_${currentJob.jobNo || 'Job'}_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`;
            // Add copyright footer to both pages
            const totalPages = doc.internal.pages.length - 1;
            for (let p = 1; p <= totalPages; p++) {
                doc.setPage(p);
                doc.setFontSize(6);
                doc.setTextColor(180, 180, 180);
                doc.setFont(undefined, 'italic');
                doc.text('¬© 2026 - PaintWorkz Pro Software', 10, pageHeight - 8);
            }
            const pdfData = doc.output('dataurlstring');
            showPDFPreview(pdfData, filename, 'Paint Order');
            
            notify('‚úì Paint Order Ready - Review & Download');
            
        } catch(error) {
            console.error('‚ùå Paint Order Error:', error);
            notify('Paint Order Error: ' + error.message);
        }
    }
    
    function generateA3Schedule(days) {
        closeA3ScheduleModal();
        printA3Schedule(days);
    }
    
    function generateA3ScheduleCustom() {
        const startDate = document.getElementById('a3StartDate').valueAsDate;
        const endDate = document.getElementById('a3EndDate').valueAsDate;
        
        if (!startDate || !endDate) {
            notify('‚ùå Please select both dates');
            return;
        }
        
        if (startDate > endDate) {
            notify('‚ùå Start date must be before end date');
            return;
        }
        
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        closeA3ScheduleModal();
        printA3Schedule(days, startDate);
    }
    
    function printA3Schedule(days = 90, startDateObj = null) {
        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a3');
            
            const headerLogo = localStorage.getItem('headerLogo') || localStorage.getItem('headerLogoBase64') || '';
            const companySettings = JSON.parse(localStorage.getItem('companySettings')) || {
                name: 'Paintworkz',
                phone: '0438 803 032',
                email: 'paint_workz@outlook.com'
            };
            
            let y = 12;
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            
            // ===== LOGO =====
            if (headerLogo) {
                try { doc.addImage(headerLogo, 'PNG', 350, 8, 35, 18); } catch(e) {}
            }
            
            // ===== HEADER =====
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('WORK SCHEDULE', 20, y);
            y += 10;
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(33, 33, 33);
            doc.text(`${companySettings.name} | ${companySettings.phone}`, 20, y);
            y += 8;
            
            const today = startDateObj || new Date();
            if (!startDateObj) today.setHours(0, 0, 0, 0);
            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + days - 1);
            doc.text(`${today.toLocaleDateString('en-AU')} to ${endDate.toLocaleDateString('en-AU')} (${days} days)`, 20, y);
            y += 15;
            
            // Load jobs
            let jobHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const activeJobs = jobHistory.filter(job => !job.completed).slice(0, 50);
            
            // ===== SIMPLE TABLE =====
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(255, 255, 255);
            doc.setFillColor(50, 50, 50);
            
            // Table headers
            const colX = { jobId: 20, client: 80, details: 220, status: 320 };
            const rowHeight = 8;
            
            doc.rect(colX.jobId, y, 55, rowHeight, 'F');
            doc.text('JOB #', colX.jobId + 2, y + 5);
            
            doc.rect(colX.client, y, 135, rowHeight, 'F');
            doc.text('CLIENT', colX.client + 2, y + 5);
            
            doc.rect(colX.details, y, 95, rowHeight, 'F');
            doc.text('DETAILS', colX.details + 2, y + 5);
            
            doc.rect(colX.status, y, 55, rowHeight, 'F');
            doc.text('STATUS', colX.status + 2, y + 5);
            
            y += rowHeight;
            
            // Table rows
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            
            let rowNum = 0;
            for (let idx = 0; idx < activeJobs.length && rowNum < 40; idx++) {
                const job = activeJobs[idx];
                
                // Parse date
                let daysAgo = 0;
                if (job.dateReceived) {
                    if (job.dateReceived.includes('/')) {
                        const [d, m, yr] = job.dateReceived.split('/');
                        const jobDate = new Date(parseInt('20' + yr), parseInt(m) - 1, parseInt(d));
                        daysAgo = Math.ceil((today - jobDate) / (1000 * 60 * 60 * 24));
                    }
                }
                
                // Alternate row colors
                if (rowNum % 2 === 0) {
                    doc.setFillColor(245, 245, 245);
                    doc.rect(colX.jobId, y, 335, rowHeight, 'F');
                }
                
                // Draw borders
                doc.setDrawColor(200, 200, 200);
                doc.setLineWidth(0.2);
                doc.rect(colX.jobId, y, 55, rowHeight);
                doc.rect(colX.client, y, 135, rowHeight);
                doc.rect(colX.details, y, 95, rowHeight);
                doc.rect(colX.status, y, 55, rowHeight);
                
                // Job number
                doc.setTextColor(0, 0, 0);
                doc.text(`#${job.jobNum}`, colX.jobId + 2, y + 5);
                
                // Client
                const clientName = job.client || 'N/A';
                doc.text(clientName.substring(0, 30), colX.client + 2, y + 5);
                
                // Details (SQM, colours, paint qty)
                let details = '';
                if (job.totalSQM) details += `${job.totalSQM.toFixed(1)}m¬≤ `;
                if (job.items && job.items.length > 0) {
                    const colours = [...new Set(job.items.map(i => i.color))].filter(c => c);
                    if (colours.length > 0) details += `| ${colours.join('/')}`;
                }
                doc.setFontSize(8);
                doc.text(details.substring(0, 25), colX.details + 2, y + 5);
                
                // Status
                doc.setFontSize(9);
                const status = daysAgo <= 3 ? 'RECENT' : (daysAgo <= 14 ? 'ACTIVE' : 'PENDING');
                doc.text(status, colX.status + 2, y + 5);
                
                y += rowHeight;
                rowNum++;
                
                if (y > pageHeight - 15) {
                    doc.addPage();
                    y = 12;
                }
            }
            
            y += 5;
            doc.setFontSize(8);
            doc.setFont(undefined, 'italic');
            doc.setTextColor(120, 120, 120);
            doc.text(`Generated: ${new Date().toLocaleString('en-AU')} | ${companySettings.name}`, 20, pageHeight - 10);
            
            const filename = `A3_Schedule_${new Date().toISOString().split('T')[0]}.pdf`;
            const pdfDataUri = doc.output('datauristring');
            showPDFPreview(pdfDataUri, filename, 'üìÖ A3 Schedule');
            notify('‚úì A3 Schedule Ready - Landscape A3 format');
            
        } catch(err) {
            console.error('A3 Schedule Error:', err);
            notify('‚ùå Error: ' + err.message);
        }
    }

    // ===== BATCH PRINT MODAL =====
    function openBatchPrintModal() {
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:5000;';
        
        const content = document.createElement('div');
        content.style.cssText = 'background:#fff; border-radius:12px; padding:20px; max-width:450px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3);';
        
        content.innerHTML = `
            <h3 style="margin-top:0; margin-bottom:15px; font-weight:900;">üì¶ Batch Print - Shop/Floor Forms</h3>
            
            <div style="margin-bottom:20px; padding:15px; background:#f5f5f5; border-radius:6px;">
                <p style="margin:0 0 12px 0; font-weight:900; font-size:12px;">Select Forms & Quantity:</p>
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; padding:10px; background:#fff; border-radius:4px; border:1px solid #ddd;">
                    <input type="checkbox" id="batch-supply" class="batch-form-check" style="width:18px; height:18px; cursor:pointer;">
                    <label for="batch-supply" style="flex:1; cursor:pointer; font-size:12px; margin:0; font-weight:900;">üìã Supply Docket</label>
                    <input type="number" id="qty-supply" value="1" min="1" max="50" style="width:50px; padding:6px; border:1px solid #ccc; border-radius:4px; font-size:12px; text-align:center;">
                </div>
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; padding:10px; background:#fff; border-radius:4px; border:1px solid #ddd;">
                    <input type="checkbox" id="batch-mixing" class="batch-form-check" style="width:18px; height:18px; cursor:pointer;">
                    <label for="batch-mixing" style="flex:1; cursor:pointer; font-size:12px; margin:0; font-weight:900;">üé® Mixing Card</label>
                    <input type="number" id="qty-mixing" value="1" min="1" max="50" style="width:50px; padding:6px; border:1px solid #ccc; border-radius:4px; font-size:12px; text-align:center;">
                </div>
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; padding:10px; background:#fff; border-radius:4px; border:1px solid #ddd;">
                    <input type="checkbox" id="batch-cover" class="batch-form-check" style="width:18px; height:18px; cursor:pointer;">
                    <label for="batch-cover" style="flex:1; cursor:pointer; font-size:12px; margin:0; font-weight:900;">üìã Cover Sheet</label>
                    <input type="number" id="qty-cover" value="1" min="1" max="50" style="width:50px; padding:6px; border:1px solid #ccc; border-radius:4px; font-size:12px; text-align:center;">
                </div>
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:0; padding:10px; background:#fff; border-radius:4px; border:1px solid #ddd;">
                    <input type="checkbox" id="batch-label" class="batch-form-check" style="width:18px; height:18px; cursor:pointer;">
                    <label for="batch-label" style="flex:1; cursor:pointer; font-size:12px; margin:0; font-weight:900;">üè∑Ô∏è Shop Label</label>
                    <input type="number" id="qty-label" value="1" min="1" max="50" style="width:50px; padding:6px; border:1px solid #ccc; border-radius:4px; font-size:12px; text-align:center;">
                </div>
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:0; padding:10px; background:#fff; border-radius:4px; border:1px solid #ddd;">
                    <input type="checkbox" id="batch-paintorder" class="batch-form-check" style="width:18px; height:18px; cursor:pointer;">
                    <label for="batch-paintorder" style="flex:1; cursor:pointer; font-size:12px; margin:0; font-weight:900;">üé® Paint Order</label>
                    <input type="number" id="qty-paintorder" value="1" min="1" max="50" style="width:50px; padding:6px; border:1px solid #ccc; border-radius:4px; font-size:12px; text-align:center;">
                </div>
                
                <hr style="margin:15px 0; border:none; border-top:1px solid #ddd;">
                
                <p style="margin:12px 0 10px 0; font-weight:900; font-size:12px; color:#666;">üîê ADMIN ONLY - Financial Forms:</p>
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; padding:10px; background:#fef9e7; border-radius:4px; border:1px solid #ddd;">
                    <input type="checkbox" id="batch-estimate" class="batch-form-check" style="width:18px; height:18px; cursor:pointer;">
                    <label for="batch-estimate" style="flex:1; cursor:pointer; font-size:12px; margin:0; font-weight:900;">üìÑ Estimate</label>
                    <input type="number" id="qty-estimate" value="1" min="1" max="50" style="width:50px; padding:6px; border:1px solid #ccc; border-radius:4px; font-size:12px; text-align:center;">
                </div>
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px; padding:10px; background:#fef9e7; border-radius:4px; border:1px solid #ddd;">
                    <input type="checkbox" id="batch-quote" class="batch-form-check" style="width:18px; height:18px; cursor:pointer;">
                    <label for="batch-quote" style="flex:1; cursor:pointer; font-size:12px; margin:0; font-weight:900;">üí∞ Quote</label>
                    <input type="number" id="qty-quote" value="1" min="1" max="50" style="width:50px; padding:6px; border:1px solid #ccc; border-radius:4px; font-size:12px; text-align:center;">
                </div>
                
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:0; padding:10px; background:#fef9e7; border-radius:4px; border:1px solid #ddd;">
                    <input type="checkbox" id="batch-invoice" class="batch-form-check" style="width:18px; height:18px; cursor:pointer;">
                    <label for="batch-invoice" style="flex:1; cursor:pointer; font-size:12px; margin:0; font-weight:900;">üìë Invoice</label>
                    <input type="number" id="qty-invoice" value="1" min="1" max="50" style="width:50px; padding:6px; border:1px solid #ccc; border-radius:4px; font-size:12px; text-align:center;">
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button onclick="this.closest('div').parentElement.parentElement.remove();" style="padding:12px; background:#e0e0e0; color:#333; border:none; border-radius:6px; font-weight:900; cursor:pointer; font-size:13px;">CANCEL</button>
                <button onclick="executeBatchPrint()" style="padding:12px; background:#4caf50; color:#fff; border:none; border-radius:6px; font-weight:900; cursor:pointer; font-size:13px;">üì¶ PRINT</button>
            </div>
        `;
        
        modal.appendChild(content);
        document.body.appendChild(modal);
    }
    
    function selectBatchCategory(category) {
        const shopForms = ['batch-estimate', 'batch-supply', 'batch-mixing', 'batch-cover', 'batch-label', 'batch-paintorder'];
        const adminForms = ['batch-quote', 'batch-invoice'];
        
        const allForms = document.querySelectorAll('.batch-form-check');
        allForms.forEach(check => check.checked = false);
        
        if (category === 'shop') {
            shopForms.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) elem.checked = true;
            });
        } else if (category === 'admin') {
            adminForms.forEach(id => {
                const elem = document.getElementById(id);
                if (elem) elem.checked = true;
            });
        }
    }
    
    function executeBatchPrint() {
        const forms = [];
        const formQuantities = {
            'batch-supply': { name: 'Supply Docket', qty: parseInt(document.getElementById('qty-supply')?.value || '1') || 1, func: 'genSupplyDocket' },
            'batch-mixing': { name: 'Mixing Card', qty: parseInt(document.getElementById('qty-mixing')?.value || '1') || 1, func: 'genMixingCard' },
            'batch-cover': { name: 'Cover Sheet', qty: parseInt(document.getElementById('qty-cover')?.value || '1') || 1, func: 'genCoverSheet' },
            'batch-label': { name: 'Shop Label', qty: parseInt(document.getElementById('qty-label')?.value || '1') || 1, func: 'genShopLabel' },
            'batch-paintorder': { name: 'Paint Order', qty: parseInt(document.getElementById('qty-paintorder')?.value || '1') || 1, func: 'genPaintOrder' },
            'batch-estimate': { name: 'Estimate', qty: parseInt(document.getElementById('qty-estimate')?.value || '1') || 1, func: 'genEstimate' },
            'batch-quote': { name: 'Quote', qty: parseInt(document.getElementById('qty-quote')?.value || '1') || 1, func: 'genQuoteForm' },
            'batch-invoice': { name: 'Invoice', qty: parseInt(document.getElementById('qty-invoice')?.value || '1') || 1, func: 'genInvoice' }
        };
        
        for (const [id, formData] of Object.entries(formQuantities)) {
            if (document.getElementById(id)?.checked) {
                for (let i = 0; i < formData.qty; i++) {
                    forms.push(formData);
                }
            }
        }
        
        if (forms.length === 0) {
            notify('‚ùå Please select at least one form');
            return;
        }
        
        // Close modal
        document.querySelectorAll('div[style*="z-index:5000"]').forEach(el => {
            if (el.textContent.includes('Batch Print')) el.remove();
        });
        
        // Generate forms in sequence
        notify(`üì¶ Generating ${forms.length} forms...`);
        window.autoPrintMode = true;  // Enable auto-print for batch mode
        let completed = 0;
        forms.forEach((formData, index) => {
            setTimeout(() => {
                // formData now has { name, qty, func } structure
                if (formData.func === 'genSupplyDocket') genSupplyDocket();
                else if (formData.func === 'genMixingCard') genMixingCard();
                else if (formData.func === 'genCoverSheet') genCoverSheet();
                else if (formData.func === 'genShopLabel') genShopLabel();
                else if (formData.func === 'genPaintOrder') genPaintOrder();
                else if (formData.func === 'genEstimate') genEstimate();
                else if (formData.func === 'genQuoteForm') genQuoteForm();
                else if (formData.func === 'genInvoice') genInvoice();
                
                completed++;
                if (completed === forms.length) {
                    notify(`‚úì Batch print complete: ${forms.length} forms generated`);
                    window.autoPrintMode = false;  // Disable after batch complete
                }
            }, index * 100); // Slight delay between each
        });
    }

    function saveJob() { 
        try {
            saveData();
            saveJobToHistory(); // This will show its own notification
            
            // Clear view mode when saving
            isJobViewMode = false;
            jobDataBeforeLoad = null;
            updateGoBackButton();
            
            // Auto-increment job number
            try {
                const currentJobNum = document.getElementById('jN').value;
                if (currentJobNum) {
                    // Extract number from job number (handle formats like "001", "1", "JOB001", etc)
                    const match = currentJobNum.match(/\d+/);
                    if (match) {
                        const nextNum = String(parseInt(match[0]) + 1).padStart(match[0].length, '0');
                        const prefix = currentJobNum.substring(0, currentJobNum.indexOf(match[0]));
                        const suffix = currentJobNum.substring(currentJobNum.indexOf(match[0]) + match[0].length);
                        document.getElementById('jN').value = prefix + nextNum + suffix;
                    }
                }
            } catch(e) {
                console.error('Error auto-incrementing job number:', e);
            }
            
            // Clear measure sheet and panel list
            setTimeout(() => {
                try {
                    items = [];
                    const hEl = document.getElementById('h');
                    if (hEl) hEl.value = '';
                    const wEl = document.getElementById('w');
                    if (wEl) wEl.value = '';
                    const descEl = document.getElementById('desc');
                    if (descEl) descEl.value = '';
                    const jNmEl = document.getElementById('jNm');
                    if (jNmEl) jNmEl.value = '';
                    
                    render(); // Re-render to clear UI
                    tab('history'); // Navigate to history tab
                    renderHistory();
                } catch(e) {
                    console.error('Error clearing measure sheet:', e);
                }
            }, 500);
        } catch(e) {
            console.error('Error in saveJob:', e);
            notify('‚ö†Ô∏è Error saving job');
        }
    }
    
    function startNewJob() {
        currentEditingJobIndex = null; // Reset editing index when starting new job
        clearAllData(); // This will also clear the form
    }
    
    function clearAllData() {
        if (confirm('Are you absolutely sure? This will delete all data and cannot be undone.')) {
            items = [];
            currentEditingJobIndex = null;
            jobPhotos = [];
            localStorage.removeItem('currentJob');
            document.getElementById('h').value = '';
            document.getElementById('w').value = '';
            document.getElementById('desc').value = '';
            document.getElementById('dRec').value = '';
            document.getElementById('jNm').value = '';
            document.getElementById('jN').value = '';
            renderPhotoGallery();
            render();
            notify('All Data Cleared');
        }
    }

    // CALENDAR FUNCTIONALITY
    let calendarDate = new Date();

    function openCalendar() {
        calendarDate = new Date();
        renderCalendar();
        document.getElementById('calendarModal').style.display = 'flex';
    }

    function closeCalendar() {
        document.getElementById('calendarModal').style.display = 'none';
    }

    function prevMonth() {
        calendarDate.setMonth(calendarDate.getMonth() - 1);
        renderCalendar();
    }

    function nextMonth() {
        calendarDate.setMonth(calendarDate.getMonth() + 1);
        renderCalendar();
    }

    function renderCalendar() {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        
        // Set month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        if (document.getElementById('monthYear')) document.getElementById('monthYear').innerText = `${monthNames[month]} ${year}`;
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        let daysHTML = '';
        
        // Previous month's days
        for (let i = firstDay - 1; i >= 0; i--) {
            daysHTML += `<div style="padding:8px; text-align:center; color:#ccc; font-weight:900; background:#f9f9f9; border-radius:6px;">${daysInPrevMonth - i}</div>`;
        }
        
        // Current month's days
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            const dateStr = `${day.toString().padStart(2, '0')}/${(month + 1).toString().padStart(2, '0')}/${year.toString().slice(-2)}`;
            daysHTML += `<div onclick="selectDate('${dateStr}')" style="padding:8px; text-align:center; font-weight:900; background:${isToday ? 'var(--gs)' : '#fff'}; color:${isToday ? '#000' : '#333'}; border:${isToday ? '2px solid var(--gs)' : '1px solid #eee'}; border-radius:6px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='${isToday ? 'var(--gs)' : '#fff'}'">${day}</div>`;
        }
        
        // Next month's days
        const totalCells = firstDay + daysInMonth;
        const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let day = 1; day <= remainingCells; day++) {
            daysHTML += `<div style="padding:8px; text-align:center; color:#ccc; font-weight:900; background:#f9f9f9; border-radius:6px;">${day}</div>`;
        }
        
        document.getElementById('calendarDays').innerHTML = daysHTML;
    }

    function selectDate(dateStr) {
        document.getElementById('dRec').value = dateStr;
        saveData();
        notify(`Date Set: ${dateStr}`);
        closeCalendar();
        // Refresh schedule calendar
        renderScheduleCalendar();
    }

    function selectToday() {
        const today = new Date();
        const dateStr = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear().toString().slice(-2)}`;
        selectDate(dateStr);
    }

    // SCHEDULE CALENDAR FUNCTIONALITY
    let scheduleCalendarDate = null;
    
    function initScheduleCalendar() {
        if (!scheduleCalendarDate || isNaN(scheduleCalendarDate.getTime())) {
            scheduleCalendarDate = new Date();
            scheduleCalendarDate.setHours(0, 0, 0, 0);
        }
    }

    function renderScheduleCalendar() {
        initScheduleCalendar();  // Ensure date is initialized
        
        // FORCE SCHEDULE CONTAINER TO BE VISIBLE
        const scheduleContainer = document.getElementById('schedule');
        if (scheduleContainer) {
            scheduleContainer.style.display = 'block';
            scheduleContainer.style.visibility = 'visible';
            scheduleContainer.style.minHeight = 'auto';
        }
        
        // Ensure scheduleCalendarDate is valid
        if (!scheduleCalendarDate || isNaN(scheduleCalendarDate.getTime())) {
            scheduleCalendarDate = new Date();
            scheduleCalendarDate.setHours(0, 0, 0, 0);
        }
        
        const year = scheduleCalendarDate.getFullYear();
        const month = scheduleCalendarDate.getMonth();
        
        // Set month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        if (document.getElementById('scheduleMonthYear')) document.getElementById('scheduleMonthYear').innerText = `${monthNames[month]} ${year}`;
        
        renderGanttChart(year, month);
        renderGlobalNotifications();
        renderJobTasks(); // Update workload summary
        checkForDuplicates(); // Show warning if duplicates exist
    }
    
    function renderGanttChart(year, month) {
        // FORCE WRAPPER TO BE VISIBLE
        const ganttWrapper = document.getElementById('ganttWrapper');
        if (ganttWrapper) {
            ganttWrapper.style.display = 'block';
            ganttWrapper.style.visibility = 'visible';
            ganttWrapper.style.opacity = '1';
        }
        
        const ganttChart = document.getElementById('ganttChart');
        if (!ganttChart) {
            return;
        }
        
        // FORCE VISIBILITY BEFORE RENDERING
        ganttChart.style.display = 'flex';
        ganttChart.style.visibility = 'visible';
        ganttChart.style.minHeight = 'auto';
        ganttChart.style.opacity = '1';
        
        // Check if element is visible
        const style = window.getComputedStyle(ganttChart);
        
        try {
            let fullHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            
        
        // Sort by received date - newest first
        let history = fullHistory.filter(job => !job.completed).sort((a, b) => {
            let dateA = new Date();
            let dateB = new Date();
            
            // Parse dateReceived in DD/MM/YY format
            if (a.dateReceived) {
                if (a.dateReceived.includes('/')) {
                    const [day, month, year] = a.dateReceived.split('/');
                    dateA = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                } else if (a.dateReceived.includes('-')) {
                    dateA = new Date(a.dateReceived);
                }
            }
            
            if (b.dateReceived) {
                if (b.dateReceived.includes('/')) {
                    const [day, month, year] = b.dateReceived.split('/');
                    dateB = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                } else if (b.dateReceived.includes('-')) {
                    dateB = new Date(b.dateReceived);
                }
            }
            
            return dateB - dateA;
        });
        
        // SCHEDULE VIEW: Show 90 days starting from selected month
        const today = new Date(year, month, 1);
        today.setHours(0, 0, 0, 0);
        
        // Generate 90 days continuously from today
        const allDays = [];
        for (let i = 0; i < 90; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() + i);
            allDays.push({ day: date.getDate(), date, isWeekday: isWeekday(date), month: date.getMonth(), year: date.getFullYear() });
        }
        
        // Update header to show date range
        const lastDate = allDays[allDays.length - 1].date;
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const dateRangeText = `${monthNames[today.getMonth()]} ${today.getDate()} - ${monthNames[lastDate.getMonth()]} ${lastDate.getDate()}`;
        if (document.getElementById('scheduleMonthYear')) document.getElementById('scheduleMonthYear').innerText = dateRangeText;
        
        // Create header with dates (ALL DAYS - weekends grayed out)
        const timelineWidth = allDays.length * 28;
        let ganttHTML = '<div style="display:flex; gap:0; margin-bottom:0; position:sticky; top:0; background:#fff; z-index:10; border-bottom:2px solid #ddd; min-height:28px; align-items:stretch;">';
        
        // Job names column - MUST MATCH job info width (170px) - EXACT same styling
        ganttHTML += '<div style="width:170px; min-width:170px; max-width:170px; font-weight:900; font-size:10px; padding:6px 6px; border-right:2px solid #ddd; color:#000; line-height:1.2; background:#f9f9f9; box-sizing:border-box; display:flex; align-items:center;">DATE</div>';
        
        // Wrap date columns in container with exact calculated width
        ganttHTML += `<div style="width:${timelineWidth}px; min-width:${timelineWidth}px; max-width:${timelineWidth}px; display:flex; gap:0; min-height:28px;">`;
        
        // Date columns - ALL DAYS (weekends lighter) - EXACT 28px box
        allDays.forEach(({ day, date, isWeekday: isWD }) => {
            const dayName = ['S', 'M', 'T', 'W', 'T', 'F', 'S'][date.getDay()];
            const bgColor = isWD ? '#f0f0f0' : '#f9f9f9';
            const textColor = isWD ? '#666' : '#ccc';
            ganttHTML += `<div style="width:28px; min-width:28px; max-width:28px; height:28px; text-align:center; font-weight:900; font-size:9px; padding:2px 0; background:${bgColor}; border:1px solid #eee; color:${textColor}; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; justify-content:center; line-height:1.1;">${dayName}<br>${day}</div>`;
        });
        ganttHTML += '</div>';  // Close date columns container
        ganttHTML += '</div>';  // Close header row
        
        // Jobs timeline
        ganttHTML += '<div style="width:100%; display:flex; flex-direction:column; gap:0;">';
        let jobCount = 0;
        history.forEach((job, filteredIdx) => {
            // Find original index in full history
            const originalIdx = fullHistory.findIndex(j => j === job);
            
            if (job && !job.completed) {
                jobCount++;
                // Handle date in DD/MM/YY or YYYY-MM-DD format
                let jobDate = new Date();
                if (job.dateReceived) {
                    try {
                        if (job.dateReceived.includes('/')) {
                            // DD/MM/YY format
                            const [day, jobMonth, jobYear] = job.dateReceived.split('/');
                            jobDate = new Date(parseInt('20' + jobYear), parseInt(jobMonth) - 1, parseInt(day));
                        } else if (job.dateReceived.includes('-')) {
                            // YYYY-MM-DD format
                            jobDate = new Date(job.dateReceived);
                        }
                    } catch (e) {
                        jobDate = new Date(); // Default to today if parsing fails
                    }
                }
                
                // Initialize job phases tracking if not exists
                if (!job.phases) job.phases = {};
                
                // Get custom timeline for this job or use defaults
                const jobTimeline = job.timeline || getDefaultTimeline();
                
                // Calculate cumulative phase boundaries (durations, not end days)
                // Since timeline values are DURATIONS, calculate running totals
                const measuringDays = jobTimeline.measuring || 1;
                const sanding1Days = jobTimeline.sanding1 || 4;
                const undercoatDays = jobTimeline.undercoat || 2;
                const sanding2Days = jobTimeline.sanding2 || 3;
                const topCoatDays = jobTimeline.topcoat || 2;
                const inspectDays = jobTimeline.inspect || 2;
                const completeDays = jobTimeline.complete || 1;
                
                // Calculate running totals (cumulative end days)
                const measuringEnd = measuringDays;
                const sanding1End = measuringEnd + sanding1Days;
                const undercoatEnd = sanding1End + undercoatDays;
                const sanding2End = undercoatEnd + sanding2Days;
                const topCoatEnd = sanding2End + topCoatDays;
                const inspectEnd = topCoatEnd + inspectDays;
                const completionDay = inspectEnd + completeDays;
                
                // Job header with info and timeline - Alternate background every 2nd job

                const jobBgColor = jobCount % 2 === 0 ? '#ffffff' : '#f5f5f5';
                const timelineWidth = allDays.length * 28;
                ganttHTML += `<div style="margin-bottom:0; padding-bottom:0; display:flex; gap:0; background:${jobBgColor}; border:1px solid #ddd; border-bottom:2px solid #bbb;">
                    <!-- Left Column: Job Info -->
                    <div style="width:170px; min-width:170px; max-width:170px; font-weight:900; font-size:10px; padding:6px 6px; border-right:2px solid #ddd; color:#000; line-height:1.2; background:#f9f9f9; box-sizing:border-box;">
                        <div style="color:#d4af37; font-size:11px; font-weight:900;">#${job.jobNum} - ${job.jobName || 'Unnamed'}</div>
                        <div style="font-size:9px; color:#000; margin-top:2px; font-weight:900;">${job.client}</div>
                        <div style="font-size:7px; color:#2196f3; font-weight:900; margin-top:1px;">üìê ${parseFloat(job.totalSqm || 0).toFixed(2)} m¬≤</div>
                        <button onclick="editJobTimeline(${originalIdx})" style="font-size:8px; padding:2px 4px; border:none; background:#2196f3; color:#fff; border-radius:2px; cursor:pointer; margin-top:1px; width:100%;">‚úèÔ∏è Edit</button>
                    </div>
                    
                    <!-- Right Column: Timeline bars + Phase checkboxes stacked -->
                    <div style="display:flex; flex-direction:column; gap:0; width:${timelineWidth}px; min-width:${timelineWidth}px; max-width:${timelineWidth}px;">
                        <!-- Timeline bars row -->
                        <div style="display:flex; gap:0;">`;
                
                // Timeline bars - ALL DAYS but NEVER work on weekends
                allDays.forEach(({ day, date: cellDate, isWeekday: isWD }) => {
                    let barHTML = '';
                    
                    // WEEKEND = ALWAYS EMPTY, NO WORK
                    if (!isWD) {
                        barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:#fafafa; border:1px solid #f0f0f0; box-sizing:border-box;"></div>`;
                    }
                    // WEEKDAY ONLY = check phase
                    else if (isWD) {
                        // Weekday - count which working day this is from job start
                        const workingDayNum = getWorkingDayNumber(jobDate, cellDate);
                        
                        if (workingDayNum < 1) {
                            // Before job start
                            barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:#f9f9f9; border:1px solid #eee; box-sizing:border-box;"></div>`;
                        } else {
                            // Job has started - assign to phase
                            let phaseKey = '';
                            let phaseColor = '';
                            let phaseLabel = '';
                            let isStrikeThrough = false;
                            
                            // Assign working day to phase (simple whole day allocation)
                            if (workingDayNum <= measuringEnd) {
                                phaseKey = 'measuring';
                                phaseColor = '#2196f3';
                                phaseLabel = 'M';
                                isStrikeThrough = job.phases && job.phases.measuring;
                            } else if (workingDayNum <= sanding1End) {
                                phaseKey = 'sanding1';
                                phaseColor = '#ff9500';
                                phaseLabel = 'S1';
                                isStrikeThrough = job.phases && job.phases.sanding1;
                            } else if (workingDayNum <= undercoatEnd) {
                                phaseKey = 'undercoat';
                                phaseColor = '#8b4513';
                                phaseLabel = 'U';
                                isStrikeThrough = job.phases && job.phases.undercoat;
                            } else if (workingDayNum <= sanding2End) {
                                phaseKey = 'sanding2';
                                phaseColor = '#ff9500';
                                phaseLabel = 'S2';
                                isStrikeThrough = job.phases && job.phases.sanding2;
                            } else if (workingDayNum <= topCoatEnd) {
                                phaseKey = 'topcoat';
                                phaseColor = '#9c27b0';
                                phaseLabel = 'T';
                                isStrikeThrough = job.phases && job.phases.topcoat;
                            } else if (workingDayNum <= inspectEnd) {
                                phaseKey = 'inspect';
                                phaseColor = '#673ab7';
                                phaseLabel = 'I';
                                isStrikeThrough = job.phases && job.phases.inspect;
                            } else if (workingDayNum <= completionDay) {
                                phaseKey = 'complete';
                                phaseColor = '#34c759';
                                phaseLabel = 'C';
                                isStrikeThrough = job.phases && job.phases.complete;
                            }
                            
                            if (phaseKey) {
                                barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:${phaseColor}; border:1px solid ${phaseColor}; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:900; color:#fff; position:relative; cursor:pointer; box-sizing:border-box; ${isStrikeThrough ? 'opacity:0.5; text-decoration:line-through;' : ''}" onclick="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', '${phaseKey}')" title="Click to mark complete">
                                    <span>${phaseLabel}</span>
                                    ${isStrikeThrough ? '<svg style="position:absolute; width:24px; height:24px;" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><line x1="3" y1="3" x2="21" y2="21"/></svg>' : ''}
                                </div>`;
                            } else {
                                barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:#f9f9f9; border:1px solid #eee; box-sizing:border-box;"></div>`;
                            }
                        }
                    }
                    
                    ganttHTML += barHTML;
                });
                
                ganttHTML += '</div>';  // Close timeline bars row
                ganttHTML += `<div style="display:flex; gap:8px; padding:4px 6px; background:transparent; flex-wrap:wrap; align-items:center;">
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.measuring ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'measuring')" style="width:13px; height:13px; cursor:pointer;">
                            <span>M</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.sanding1 ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'sanding1')" style="width:13px; height:13px; cursor:pointer;">
                            <span>S1</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.undercoat ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'undercoat')" style="width:13px; height:13px; cursor:pointer;">
                            <span>U</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.sanding2 ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'sanding2')" style="width:13px; height:13px; cursor:pointer;">
                            <span>S2</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.topcoat ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'topcoat')" style="width:13px; height:13px; cursor:pointer;">
                            <span>T</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.inspect ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'inspect')" style="width:13px; height:13px; cursor:pointer;">
                            <span>I</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.complete ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'complete')" style="width:13px; height:13px; cursor:pointer;">
                            <span>C</span>
                        </label>
                        <button onclick="markJobComplete(${originalIdx})" style="border:none; background:#34c759; color:#fff; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">‚úì DONE</button>
                        </div>
                    </div>
                </div>`;
            }
        });
        ganttHTML += '</div>';
        
        // Legend
        ganttHTML += `<div style="margin-top:15px;">
            <div style="background:#f0f0f0; padding:10px; border-radius:6px; margin-bottom:10px;">
                <p style="margin:0 0 8px 0; font-weight:900; font-size:11px; color:#333;">üìÖ Timeline Counts WORKING DAYS ONLY</p>
                <p style="margin:0; font-size:9px; color:#666;"><strong>Example:</strong> If Measuring = 2 days, it shows M/T (Mon-Tue). If Sanding = 8 days starting Wed, it shows W/T/F (3) + skip weekend + M/T/W/T (4) = 8 working days total across 2 weeks</p>
            </div>
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; font-size:8px; font-weight:900;">
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#2196f3; border:1px solid #1976d2; border-radius:2px;"></div>
                <span>M = Measuring</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#ff9500; border:1px solid #f57c00; border-radius:2px;"></div>
                <span>S1/S2 = Sanding</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#8b4513; border:1px solid #5c2e0a; border-radius:2px;"></div>
                <span>U = Undercoat</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#9c27b0; border:1px solid #7b1fa2; border-radius:2px;"></div>
                <span>T = Top Coat</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#673ab7; border:1px solid #512da8; border-radius:2px;"></div>
                <span>I = Inspect</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#34c759; border:1px solid #28a745; border-radius:2px;"></div>
                <span>C = Complete</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#fafafa; border:1px solid #f0f0f0; border-radius:2px;"></div>
                <span>Weekend (no work)</span>
            </div>
        </div>`;
        
        ganttChart.innerHTML = ganttHTML;
        
        } catch (error) {
            console.error('Schedule render error:', error);
            ganttChart.innerHTML = `<div style="padding:20px; color:#ff3b30; background:#ffebee; border-radius:6px;"><strong>Error loading schedule:</strong> ${error.message}</div>`;
        }
    }


    
    function toggleGanttCell(jobIdx, phaseKey) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[jobIdx];
        
        if (!job) return;
        if (!job.phases) job.phases = {};
        
        job.phases[phaseKey] = !job.phases[phaseKey];
        
        history[jobIdx] = job;
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        // Sync to Firebase in background (async)
        if (window.syncJobsToFirebase) {
            setTimeout(() => window.syncJobsToFirebase(), 100);
        }
        
        // Update workload summary ONLY (don't re-render entire schedule)
        renderJobTasks();
        
        // Show notification
        notify(job.phases[phaseKey] ? `‚úì ${phaseKey} marked complete` : `‚óã ${phaseKey} marked pending`);
    }
    
    function renderGlobalNotifications() {
        const notificationsDiv = document.getElementById('globalNotifications');
        if (!notificationsDiv) return;
        
        const adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        updateNotificationBadge();
        
        if (adminAlerts.length === 0) {
            notificationsDiv.innerHTML = '<p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p>';
            return;
        }
        
        let notificationsHTML = '';
        adminAlerts.slice(0, 10).forEach((alert, i) => {
            const alertDate = new Date(alert.timestamp);
            let typeLabel = '';
            let typeColor = '#34c759';
            
            if (alert.type === 'JOB_COMPLETED') {
                typeLabel = '‚úÖ Completed';
                typeColor = '#34c759';
            } else if (alert.type === 'JOB_UPDATED') {
                typeLabel = '‚úèÔ∏è Updated';
                typeColor = '#ffc107';
            } else if (alert.type === 'JOB_SAVED') {
                typeLabel = '‚úÖ Saved';
                typeColor = '#34c759';
            } else if (alert.type === 'NEW_CLIENT') {
                typeLabel = 'üë§ New Client';
                typeColor = '#34c759';
            } else if (alert.type === 'CLIENT_DELETED') {
                typeLabel = 'üóëÔ∏è Deleted';
                typeColor = '#ff3b30';
            } else if (alert.type === 'PROFILE_ADDED') {
                typeLabel = 'üö™ New Profile';
                typeColor = '#ff9800';
            } else {
                typeLabel = alert.type;
            }
            
            notificationsHTML += `<div style="padding:10px; border-bottom:1px solid #ddd; background:#fff; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:4px;">
                        <div style="font-weight:900; color:${typeColor}; font-size:11px;">${typeLabel}</div>
                        <button onclick="deleteAdminAlert(${i})" style="background:#ff3b30; color:#fff; border:none; padding:4px 8px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer; white-space:nowrap; margin-left:8px;">‚úï</button>
                    </div>
                    <div style="font-size:10px; color:#000; font-weight:700; margin:2px 0;">${alert.message}</div>
                    <div style="font-size:9px; color:#999; margin-top:4px;">
                        ${alertDate.toLocaleDateString('en-AU')} ${alertDate.toLocaleTimeString('en-AU', {hour: '2-digit', minute: '2-digit'})}
                    </div>
                </div>
            </div>`;
        });
        
        if (adminAlerts.length > 10) {
            notificationsHTML += `<div style="padding:10px; text-align:center; color:#999; font-size:10px;">+${adminAlerts.length - 10} more notifications</div>`;
        }
        
        notificationsDiv.innerHTML = notificationsHTML;
    }
    
    // Delete individual admin alert
    function deleteAdminAlert(index) {
        const adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        adminAlerts.splice(index, 1);
        localStorage.setItem('adminAlerts', JSON.stringify(adminAlerts));
        renderGlobalNotifications();
        updateNotificationBadge();
    }
    
    // Toggle notifications visibility and update badge
    function toggleNotifications() {
        const notifDiv = document.getElementById('globalNotifications');
        const badge = document.getElementById('notificationBadge');
        const btn = event.target;
        
        if (notifDiv.style.display === 'none') {
            // Show notifications
            notifDiv.style.display = 'block';
            btn.innerText = '‚àí';
        } else {
            // Hide notifications
            notifDiv.style.display = 'none';
            btn.innerText = '+';
        }
    }
    
    // Update notification badge count
    function updateNotificationBadge() {
        const adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            badge.innerText = adminAlerts.length;
            badge.style.display = adminAlerts.length > 0 ? 'flex' : 'none';
        }
    }
    
    
    // Show red notification for unallocated doors
    function showUnallocatedDoorsNotification(unallocated) {
        const alertArea = document.getElementById('globalNotifications');
        if (!alertArea) return;
        
        // Check if notification already exists
        const existingAlert = alertArea.querySelector('[data-alert="unallocated-doors"]');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        // Remove placeholder
        const placeholder = alertArea.querySelector('p');
        if (placeholder) placeholder.remove();
        
        const alertHTML = `
            <div data-alert="unallocated-doors" style="background:#ffebee; border-left:4px solid #ff3b30; padding:12px; margin-bottom:8px; border-radius:4px; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="font-weight:900; color:#ff3b30; margin-bottom:6px; font-size:12px;">
                        ‚ö†Ô∏è ${unallocated.length} DOOR(S) NEED ALLOCATING
                    </div>
                    <div style="color:#d32f2f; font-size:11px;">
                        ${unallocated.map(d => `‚Ä¢ ${d.name}`).join('<br>')}
                    </div>
                    <div style="margin-top:8px; display:flex; gap:8px;">
                        <button onclick="tab('admin'); setTimeout(() => switchAdminTab('pricing'), 200)" style="background:#ff3b30; color:#fff; border:none; padding:6px 12px; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer;">
                            GO TO MATRIX ‚Üí
                        </button>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" style="background:#ff3b30; color:#fff; border:none; padding:6px 12px; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer; white-space:nowrap; margin-left:8px; height:fit-content;">
                    ‚úï DISMISS
                </button>
            </div>
        `;
        
        alertArea.innerHTML += alertHTML;
    }

    // Helper function to get the calendar date that corresponds to N working days from a start date
    // Helper function to check if a day is a weekday (Monday-Friday)
    const isWeekday = (date) => {
        const dayOfWeek = date.getDay();
        return dayOfWeek !== 0 && dayOfWeek !== 6; // 0=Sunday, 6=Saturday
    };
    
    // Helper to count working days from start date to a calendar date
    function getWorkingDayNumber(startDate, targetDate) {
        let count = 0;
        let currentDate = new Date(startDate);
        
        while (currentDate <= targetDate) {
            if (isWeekday(currentDate)) {
                count++;
            }
            if (currentDate.toDateString() === targetDate.toDateString()) {
                return count;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return -1; // Target date is before start date
    }
    
    

    function toggleJobPhaseById(jobNum, dateReceived, client, phaseKey) {
        try {
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            
            // Find job by unique identifiers (not by array index)
            const jobIdx = history.findIndex(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
            
            if (jobIdx < 0) {
                console.error('‚ùå Job not found:', jobNum, dateReceived, client);
                notify('‚ö†Ô∏è Error: Job not found');
                return;
            }
            
            const job = history[jobIdx];
            if (!job.phases) job.phases = {};
            
            // Get current state BEFORE toggle
            const wasComplete = job.phases[phaseKey] || false;
            
            // Toggle the phase
            job.phases[phaseKey] = !wasComplete;
            const isNowComplete = job.phases[phaseKey];
            
            
            // Update in history
            history[jobIdx] = job;
            localStorage.setItem('jobHistory', JSON.stringify(history));
            
            // Sync to Firebase
            if (window.syncJobsToFirebase) {
                try {
                    window.syncJobsToFirebase();
                    console.log('üîÑ Synced to Firebase');
                } catch(e) {
                    console.error('Firebase sync error:', e);
                }
            }
            
            // Update workload summary
            renderJobTasks();
            
            // Show notification
            notify(isNowComplete ? `‚úì ${phaseKey} done` : `‚óã ${phaseKey} reset`);
            
            // Re-render Gantt chart
            renderScheduleCalendar();
            
        } catch(e) {
            console.error('toggleJobPhaseById error:', e);
            notify('‚ö†Ô∏è Error updating phase');
        }
    }

    function toggleJobPhase(jobIdx, phaseKey) {
        toggleGanttCell(jobIdx, phaseKey);
    }

    function markJobComplete(jobIdx) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[jobIdx];
        
        if (!job) {
            alert('Error: Job not found');
            return;
        }
        
        // Check if all phases are complete
        if (!job.phases || !job.phases.measuring || !job.phases.sanding || !job.phases.topcoat || !job.phases.inspect || !job.phases.complete) {
            if (!confirm('Not all phases are marked complete. Complete job anyway?')) {
                return;
            }
        }
        
        
        // Mark job as complete
        job.completed = true;
        job.completedDate = new Date().toISOString();
        
        history[jobIdx] = job;
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        
        // Generate PDFs and alert admins
        try {
            generateBatchPDFs(job);
        } catch(e) {
        }
        
        try {
            alertAdmins(job);
        } catch(e) {
        }
        
        renderHistory();
        renderScheduleCalendar();
        notify('‚úì Job Marked Complete');
        
        // Switch to History tab to show completed job
        setTimeout(() => {
            tab('history');
            filterHistory('completed');
        }, 500);
    }
    
    function switchAdminTab(tab) {
        console.log(`üîÑ Switching to admin tab: ${tab}`);
        console.log(`Current time: ${new Date().toLocaleTimeString()}`);
        
        // Check if admin view is visible
        const adminView = document.getElementById('admin');
        if (adminView) {
            const adminStyle = window.getComputedStyle(adminView);
            console.log(`  Admin view display: ${adminStyle.display}`);
            console.log(`  Admin view visibility: ${adminStyle.visibility}`);
        }
        
        // Remove active class from ALL tabs
        const allTabs = ['admin-tab-general-content', 'admin-tab-colours-content', 'admin-tab-clients-content', 'admin-tab-pricing-content'];
        allTabs.forEach(tabId => {
            const el = document.getElementById(tabId);
            if (el) {
                el.classList.remove('active');
                console.log(`  ‚úì Removed .active from ${tabId}`);
            }
        });
        
        // Remove active button classes
        const allBtns = ['admin-tab-general', 'admin-tab-colours', 'admin-tab-clients', 'admin-tab-pricing'];
        allBtns.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btn) {
                btn.classList.remove('active');
            }
        });
        
        // Show selected tab
        const tabEl = document.getElementById(`admin-tab-${tab}-content`);
        const btnEl = document.getElementById(`admin-tab-${tab}`);
        
        if (tabEl) {
            tabEl.classList.add('active');
            const tabStyle = window.getComputedStyle(tabEl);
            console.log(`  ‚úÖ ADDED .active to admin-tab-${tab}-content`);
            console.log(`  Computed display: ${tabStyle.display}`);
            console.log(`  Computed visibility: ${tabStyle.visibility}`);
            console.log(`  Computed height: ${tabStyle.height}`);
            console.log(`  Computed position: ${tabStyle.position}`);
            
            // Scroll tab into view
            setTimeout(() => {
                tabEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                console.log(`  üìç Scrolled tab into view`);
            }, 100);
        } else {
            console.error(`  ‚ùå Could NOT find element: admin-tab-${tab}-content`);
        }
        
        if (btnEl) {
            btnEl.classList.add('active');
        }
        
        // Render content
        setTimeout(() => {
            if (tab === 'general') {
                updateVersionDisplay();
                renderAdminAlerts();
                renderAdminGanttChart();
            } else if (tab === 'colours') {
                if (!window.appColors || Object.keys(window.appColors).length === 0) {
                    window.appColors = JSON.parse(JSON.stringify(defaultColors));
                    localStorage.setItem('appColors', JSON.stringify(window.appColors));
                }
                renderColorCustomizer();
            } else if (tab === 'clients') {
                const searchBox = document.getElementById('clientSearchBox');
                if (searchBox) searchBox.value = '';
                renderClientsList();
            } else if (tab === 'pricing') {
                renderPricingMatrix();
                checkForNewUnallocatedDoors();
            }
        }, 50);
    }

    // PAINT FORMULA MANAGER
    
    function addNewPaintFormula() {
        const brand = document.getElementById('newPaintBrand')?.value.trim();
        const color = document.getElementById('newPaintColor')?.value.trim();
        const formula = document.getElementById('newPaintFormula')?.value.trim();
        
        if (!brand || !color || !formula) {
            alert('Please fill in all fields');
            return;
        }
        
        const formulas = getPaintFormulas();
        formulas.push({ brand, color, formula });
        savePaintFormulas(formulas);
        
        document.getElementById('newPaintBrand').value = '';
        document.getElementById('newPaintColor').value = '';
        document.getElementById('newPaintFormula').value = '';
        
        renderPaintFormulaList();
        notify('‚úì Formula Added');
    }
    
    function deletePaintFormulaDB(idx) {
        if (confirm('Delete this formula?')) {
            const formulas = getPaintFormulas();
            formulas.splice(idx, 1);
            savePaintFormulas(formulas);
            renderPaintFormulaList();
            notify('‚úì Formula Deleted');
        }
    }

    function renderPaintFormulaManager() {
        // Deprecated - now using Database tab instead
        renderPaintFormulaList();
    }

    // COLOR CUSTOMIZER
    const defaultColors = {
        'Primary Blue': '#2196f3',
        'Gold/Highlight': '#d4af37',
        'Success Green': '#34c759',
        'Sanding Phase 1 (S1)': '#ff9500',
        'Sanding Phase 2 (S2)': '#ff9500',
        'Error Red': '#ff3b30',
        'Measuring Blue (M)': '#2196f3',
        'Undercoat Brown (U)': '#8b4513',
        'TopCoat Purple (T)': '#9c27b0',
        'Inspect Purple (I)': '#673ab7',
        'Complete Green (C)': '#34c759',
        'Background Light': '#f9f9f9',
        'Border Gray': '#ddd',
        'Text Dark': '#000',
        'Text Gray': '#666',
        'PANEL Button': '#34c759',
        'DOOR Button': '#ff9500',
        'DRAWER Button': '#2196f3',
        'CUSTOM Button': '#af52de',
        'FLAT Mode Active': '#fff',
        'FLAT Mode Inactive': '#f5f5f5',
        'MOULDED Mode Active': '#fff',
        'MOULDED Mode Inactive': '#f5f5f5',
        'SS Mode Background': '#333',
        'SS Mode Text': '#d4af37',
        'DS Mode Background': '#333',
        'DS Mode Text': '#d4af37',
        'SE Mode Background': '#333',
        'SE Mode Text': '#d4af37',
        '1LR Edge Active': '#34c759',
        '2SR Edge Active': '#34c759',
        'Estimate Form Header': '#2196f3',
        'Quote Form Header': '#ff9500',
        'Invoice Form Header': '#34c759',
        'Mixing Card Header': '#2196f3',
        'Supply Docket Header': '#2196f3',
        'Cover Sheet Header': '#ff9800',
        'A3 Schedule Header': '#d4af37',
        'Shop Label Header': '#212121',
        'Batch Print Button': '#9c27b0'
    };
    
    const colorDescriptions = {
        'Primary Blue': 'üíæ SAVE button, Edit pencil icons, SQM (m¬≤) display (#) in schedule row',
        'Gold/Highlight': 'üè∑Ô∏è Job numbers (#001, #002, #003) displayed in schedule',
        'Success Green': '‚úì SAVE & ‚úì DONE buttons, complete checkmarks, success messages',
        'Sanding Phase 1 (S1)': 'üü† Sanding Phase 1 bar (S1) in Gantt timeline',
        'Sanding Phase 2 (S2)': 'üü† Sanding Phase 2 bar (S2) in Gantt timeline',
        'Error Red': '‚ùå Delete (√ó) buttons throughout app',
        'Measuring Blue (M)': 'üîµ Measuring Phase bar (M) in Gantt timeline',
        'Undercoat Brown (U)': 'üü§ Undercoat Phase bar (U) in Gantt timeline',
        'TopCoat Purple (T)': 'üü£ Top Coat Phase bar (T) in Gantt timeline',
        'Inspect Purple (I)': 'üü£ Inspect & Wrap Phase bar (I) in Gantt timeline',
        'Complete Green (C)': '‚úì Complete Phase bar (C) in Gantt timeline',
        'Background Light': '‚¨ú Checkboxes container, light card backgrounds',
        'Border Gray': '‚îÅ‚îÅ All borders, divider lines, frame edges',
        'Text Dark': 'Primary text color - job titles, headings',
        'Text Gray': 'Secondary text - labels, metadata, timestamps',
        'PANEL Button': 'üü© PANEL button in Measure tab (part type selector)',
        'DOOR Button': 'üü† DOOR button in Measure tab (part type selector)',
        'DRAWER Button': 'üü¶ DRAWER button in Measure tab (part type selector)',
        'CUSTOM Button': 'üü™ CUSTOM button in Measure tab (part type selector)',
        'FLAT Mode Active': 'üî≤ FLAT button when SELECTED (active state)',
        'FLAT Mode Inactive': '‚¨ú FLAT button when NOT selected (inactive state)',
        'MOULDED Mode Active': 'üî≤ MOULDED button when SELECTED (active state)',
        'MOULDED Mode Inactive': '‚¨ú MOULDED button when NOT selected (inactive state)',
        'SS Mode Background': '‚¨õ SS (Single Sided) edge mode background when SELECTED',
        'SS Mode Text': 'üü® SS (Single Sided) edge mode text color when SELECTED',
        'DS Mode Background': '‚¨õ DS (Double Sided) edge mode background when SELECTED',
        'DS Mode Text': 'üü® DS (Double Sided) edge mode text color when SELECTED',
        'SE Mode Background': '‚¨õ SE (Single Edge) mode background when SELECTED',
        'SE Mode Text': 'üü® SE (Single Edge) mode text color when SELECTED',
        '1LR Edge Active': 'üü¢ 1LR (One Left/Right) edge checkbox active color when CHECKED',
        '2SR Edge Active': 'üü¢ 2SR (Two Side Right) edge checkbox active color when CHECKED',
        'Estimate Form Header': 'üìã Estimate form header & title color',
        'Quote Form Header': 'üí¨ Quote form header & title color',
        'Invoice Form Header': 'üí∞ Invoice form header & title color',
        'Mixing Card Header': 'üé® Mixing card title & header color',
        'Supply Docket Header': 'üì¶ Supply docket header color',
        'Cover Sheet Header': 'üìÑ Cover sheet title & header color',
        'A3 Schedule Header': 'üìÖ A3 schedule title color',
        'Shop Label Header': 'üè∑Ô∏è Shop label title color',
        'Batch Print Button': 'üì¶ Batch Print form card button color in Forms tab'
    };
    
    // Initialize appColors globally - must be accessible from all functions
    window.appColors = JSON.parse(localStorage.getItem('appColors')) || {};
    
    // Merge in any missing default colors (handles updates when new colors are added)
    Object.keys(defaultColors).forEach(key => {
        if (!window.appColors.hasOwnProperty(key)) {
            window.appColors[key] = defaultColors[key];
        }
    });
    
    // Save merged colors back to localStorage to persist
    localStorage.setItem('appColors', JSON.stringify(window.appColors));
    
    // Normalize hex colors from 3-digit to 6-digit format
    function normalizeHex(hex) {
        if (!hex) return '#000000';
        if (hex.length === 4) {
            // Convert 3-digit hex to 6-digit: #abc -> #aabbcc
            return '#' + hex[1] + hex[1] + hex[2] + hex[2] + hex[3] + hex[3];
        }
        return hex;
    }
    
    function renderColorCustomizer() {
        console.log('renderColorCustomizer called');
        const target = document.getElementById('colorCustomizerContent');
        if (!target) {
            console.error('‚ùå colorCustomizerContent div not found!');
            return;
        }
        console.log('‚úì Found target div:', target);
        
        if (!window.appColors) {
            console.warn('‚ö†Ô∏è appColors not initialized, using defaults');
            window.appColors = defaultColors;
        }
        
        console.log(`üìù Rendering ${Object.keys(window.appColors).length} colors`);
        
        let html = '';
        
        Object.keys(window.appColors).forEach(colorName => {
            let colorValue = window.appColors[colorName];
            colorValue = normalizeHex(colorValue);
            const description = colorDescriptions[colorName] || '';
            html += `
                <div style="padding:12px; border:1px solid #dddddd; border-radius:6px; background:#ffffff;">
                    <label style="display:block; font-weight:900; font-size:12px; margin-bottom:2px; color:#000000;">${colorName}</label>
                    <div style="font-size:10px; color:#666666; margin-bottom:10px; line-height:1.4;">${description}</div>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <input type="color" value="${colorValue}" id="color_${colorName.replace(/[^a-zA-Z0-9]/g, '_')}" onchange="updateAppColor('${colorName}', this.value)" style="width:50px; height:40px; border:1px solid #dddddd; border-radius:4px; cursor:pointer;">
                        <input type="text" value="${colorValue}" id="colorText_${colorName.replace(/[^a-zA-Z0-9]/g, '_')}" onchange="updateAppColor('${colorName}', this.value)" style="flex:1; padding:8px; border:1px solid #dddddd; border-radius:4px; font-size:11px; font-family:monospace;">
                    </div>
                    <div id="preview_${colorName.replace(/[^a-zA-Z0-9]/g, '_')}" style="padding:12px; border-radius:4px; background:${colorValue}; color:${parseInt(colorValue.replace('#', ''), 16) > 0x888888 ? '#000000' : '#ffffff'}; font-weight:900; text-align:center; font-size:12px;">Preview</div>
                </div>
            `;
        });
        
        html += `<div style="grid-column:1/-1; margin-top:10px; padding:10px; background:#f0f0f0; border-radius:6px; text-align:center;">
            <button onclick="resetAppColors()" style="padding:10px 20px; background:#999999; color:#ffffff; border:none; border-radius:6px; font-weight:900; cursor:pointer;">RESET TO DEFAULT</button>
        </div>`;
        
        target.innerHTML = html;
        console.log(`‚úì Rendered ${Object.keys(window.appColors).length} colors to DOM`);
    }
    
    function updateAppColor(colorName, colorValue) {
        window.appColors[colorName] = colorValue;
        localStorage.setItem('appColors', JSON.stringify(window.appColors));
        
        const safeId = colorName.replace(/[^a-zA-Z0-9]/g, '_');
        
        // Update color input and text field
        const colorInput = document.getElementById('color_' + safeId);
        const colorText = document.getElementById('colorText_' + safeId);
        
        if (colorInput) colorInput.value = colorValue;
        if (colorText) colorText.value = colorValue;
        
        // Update preview box - use direct ID lookup
        const previewDiv = document.getElementById('preview_' + safeId);
        if (previewDiv) {
            previewDiv.style.background = colorValue;
            const textColor = parseInt(colorValue.replace('#', ''), 16) > 0x888888 ? '#000' : '#fff';
            previewDiv.style.color = textColor;
        }
        
        applyAppColors();
        notify('‚úì Color Updated');
    }
    
    function resetAppColors() {
        if (confirm('Reset all colors to default?')) {
            window.appColors = JSON.parse(JSON.stringify(defaultColors));
            localStorage.setItem('appColors', JSON.stringify(window.appColors));
            renderColorCustomizer();
            applyAppColors();
            notify('‚úì Colors Reset');
        }
    }
    
    function applyFormButtonColors() {
        // Estimate
        const estimateBtn = document.getElementById('form-estimate');
        if (estimateBtn) {
            const estimateColor = window.appColors['Estimate Form Header'] || '#2196f3';
            estimateBtn.style.background = estimateColor;
            estimateBtn.style.borderColor = estimateColor;
        }
        
        // Supply Docket
        const supplyBtn = document.getElementById('form-supply');
        if (supplyBtn) {
            const supplyColor = window.appColors['Supply Docket Header'] || '#2196f3';
            supplyBtn.style.background = supplyColor;
            supplyBtn.style.borderColor = supplyColor;
        }
        
        // Mixing Card
        const mixingBtn = document.getElementById('form-mixing');
        if (mixingBtn) {
            const mixingColor = window.appColors['Mixing Card Header'] || '#2196f3';
            mixingBtn.style.background = mixingColor;
            mixingBtn.style.borderColor = mixingColor;
        }
        
        // Invoice
        const invoiceBtn = document.getElementById('form-invoice');
        if (invoiceBtn) {
            const invoiceColor = window.appColors['Invoice Form Header'] || '#34c759';
            invoiceBtn.style.background = invoiceColor;
            invoiceBtn.style.borderColor = invoiceColor;
        }
        
        // Quote Form
        const quoteBtn = document.getElementById('form-quote');
        if (quoteBtn) {
            const quoteColor = window.appColors['Quote Form Header'] || '#ff9500';
            quoteBtn.style.background = quoteColor;
            quoteBtn.style.borderColor = quoteColor;
        }
        
        // Cover Sheet
        const coverBtn = document.getElementById('form-cover');
        if (coverBtn) {
            const coverColor = window.appColors['Cover Sheet Header'] || '#ff9800';
            coverBtn.style.background = coverColor;
            coverBtn.style.borderColor = coverColor;
        }
        
        // Shop Label
        const labelBtn = document.getElementById('form-label');
        if (labelBtn) {
            const labelColor = window.appColors['Shop Label Header'] || '#212121';
            labelBtn.style.background = labelColor;
            labelBtn.style.borderColor = labelColor;
        }
        
        // A3 Schedule
        const a3Btn = document.getElementById('form-a3schedule');
        if (a3Btn) {
            const a3Color = window.appColors['A3 Schedule Header'] || '#4caf50';
            a3Btn.style.background = a3Color;
            a3Btn.style.borderColor = a3Color;
        }
        
        // Batch Print
        const batchBtn = document.getElementById('form-batch');
        if (batchBtn) {
            const batchColor = window.appColors['Batch Print Button'] || '#9c27b0';
            batchBtn.style.background = batchColor;
            batchBtn.style.borderColor = batchColor;
        }
    }
    
    function applyAppColors() {
        const root = document.documentElement;
        
        // Apply all colors from appColors to corresponding CSS variables
        Object.keys(window.appColors).forEach(colorName => {
            const colorValue = window.appColors[colorName];
            
            // Convert color name to CSS variable format
            // Examples: "Primary Blue" -> "--primary-blue", "SS Mode Background" -> "--ss-mode-background"
            const cssVarName = '--' + colorName.toLowerCase().replace(/\s+/g, '-');
            
            root.style.setProperty(cssVarName, colorValue);
        });
        
        // Apply specific colors to important CSS variables used in styles
        root.style.setProperty('--primary-blue', window.appColors['Primary Blue']);
        root.style.setProperty('--gold', window.appColors['Gold/Highlight']);
        root.style.setProperty('--success', window.appColors['Success Green']);
        root.style.setProperty('--warning', window.appColors['Warning Orange']);
        root.style.setProperty('--error', window.appColors['Error Red']);
        
        // Apply form button colors
        applyFormButtonColors();
    }
    
    // Apply colors on page load
    applyAppColors();
    const defaultMasterMatrix = {
        "Tier 1": { 101: ["Plain", 125, 125, 152, 152], 102: ["J-Mould", 148, 148, 171, 171], 103: ["Sharknose", 148, 148, 171, 171], 104: ["Bevelled Edge", 148, 148, 171, 171] },
        "Tier 2": { 201: ["Ashlee", 148, 148, 171, 171], 202: ["Hamilton", 148, 148, 171, 171], 203: ["Vertical Grooves", 148, 148, 171, 171] },
        "Tier 3": { 301: ["Tarrone", 156, 156, 182, 182], 302: ["Bobby", 156, 156, 182, 182], 303: ["Orford", 156, 156, 182, 182] },
        "Tier 4": { 401: ["Shaker", 171, 171, 194, 194], 402: ["Shaker 45", 171, 171, 194, 194], 403: ["Shaker w/Lines", 180, 180, 203, 203], 404: ["Jack", 180, 180, 203, 203] },
        "Tier 5": { 501: ["Georgia", 183, 183, 211, 211], 502: ["Branxholme", 183, 183, 211, 211], 503: ["Rosebrook", 183, 183, 211, 211] },
        "Other": { 600: ["Benchtop", 160, 160, 160, 160], 700: ["Molding", 110, 110, 110, 110] }
    };
    
    // Load from localStorage or use defaults
    let storedMatrix = null;
    try {
        storedMatrix = JSON.parse(localStorage.getItem('masterMatrix'));
    } catch (e) {
        // If parsing fails, use defaults
    }
    
    let masterMatrix = (storedMatrix && Object.keys(storedMatrix).length > 0) ? storedMatrix : defaultMasterMatrix;
    
    // Always ensure defaults are saved
    localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
    
    // ==================== PAINTWORKZ PDF ENGINE ====================
    // Advanced PDF generation system for Estimates, Quotes, Invoices
    const PaintWorkzEngine = {
        // Data sanitization rules
        rules: {
            filterEdges: (text) => ['0S', '0L', '0SL', '0SR', '0l'].includes(text?.toUpperCase()) ? "" : text,
            getSeries: (code) => code ? code.toString().charAt(0) + "00" : "100"
        },

        // Pricing calculator - integrates with masterMatrix
        calculatePricing: function(part) {
            let paintPrice = 125; // default
            
            // Search through tiers for door profile match
            for (const tierName in masterMatrix) {
                for (const code in masterMatrix[tierName]) {
                    const door = masterMatrix[tierName][code];
                    if (door[0].toLowerCase() === (part.doorProfile || '').toLowerCase()) {
                        // Format: [name, clear, matt, satin, semi, gloss]
                        const finishIndex = part.finish === 'Clear' ? 1 : 
                                          part.finish === 'Matt' ? 2 :
                                          part.finish === 'Satin' ? 3 :
                                          part.finish === 'Semi-Gloss' ? 4 : 5; // Gloss
                        paintPrice = door[finishIndex] || 125;
                        break;
                    }
                }
            }
            
            // SQM calculation
            const sqm = (parseFloat(part.width || 0) / 1000) * (parseFloat(part.height || 0) / 1000) * parseInt(part.qty || 1);
            
            // Multipliers
            let paintMult = 1.0;
            if (part.paintMode === 'DS') paintMult = 2.0;
            if (part.paintMode === 'SE') paintMult = 1.2;
            
            const paintTotal = sqm * paintPrice * paintMult;
            
            return {
                sqm: sqm.toFixed(3),
                paint: paintTotal.toFixed(2),
                total: paintTotal.toFixed(2)
            };
        },

        // Main PDF generator
        generatePDF: function(formType, parts) {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("PDF library not loaded. Please refresh page.");
                return;
            }
            
            const doc = new jsPDF('p', 'mm', 'a4');
            const clientName = document.getElementById('cli')?.value || "Client";
            const jobName = document.getElementById('jNm')?.value || "Job";
            
            if (!parts || parts.length === 0) {
                alert("No parts to generate PDF.");
                return;
            }
            
            // Header
            doc.setFontSize(16).setFont(undefined, 'bold');
            doc.text(`PAINTWORKZ ${formType.toUpperCase()}`, 14, 15);
            
            doc.setFontSize(10).setFont(undefined, 'normal');
            doc.text(`Client: ${clientName}`, 14, 22);
            doc.text(`Job: ${jobName}`, 14, 27);
            doc.text(`Date: ${new Date().toLocaleDateString('en-AU')}`, 14, 32);
            
            // Table headers based on form type
            let columns, body;
            
            if (formType === 'Quote') {
                columns = ["Qty", "Description", "Profile", "Finish", "Price"];
                body = parts.map(p => {
                    const pricing = this.calculatePricing(p);
                    return [
                        p.qty,
                        p.description || `${p.height}x${p.width}x${p.thickness}`,
                        p.doorProfile || "N/A",
                        p.finish || "Satin",
                        `$${pricing.total}`
                    ];
                });
            } else {
                columns = ["Qty", "Description", "Dimensions (LxWxT)", "Specification", "Edges"];
                body = parts.map(p => {
                    const dimString = `${p.height} x ${p.width} x ${p.thickness}`;
                    const specString = `${p.type || 'Panel'} - ${p.paintMode || 'SS'}`;
                    const cleanEdges = this.rules.filterEdges(p.edgeText);
                    return [
                        p.qty,
                        p.description || dimString,
                        dimString,
                        specString,
                        cleanEdges || "‚Äî"
                    ];
                });
            }
            
            // Render table
            doc.autoTable({
                startY: 38,
                head: [columns],
                body: body,
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 3, valign: 'middle' },
                headStyles: { fillColor: [50, 50, 50], textColor: [212, 175, 55] },
                columnStyles: { 0: { halign: 'center', fontStyle: 'bold' } },
                didDrawPage: (data) => {
                    doc.setFontSize(8);
                    doc.text(`Page ${doc.internal.getNumberOfPages()}`, 14, doc.internal.pageSize.height - 10);
                }
            });
            
            // Totals
            let finalY = doc.lastAutoTable.finalY + 10;
            const totals = parts.reduce((acc, p) => {
                const pr = this.calculatePricing(p);
                acc.sqm += parseFloat(pr.sqm);
                acc.total += parseFloat(pr.total);
                return acc;
            }, { sqm: 0, total: 0 });
            
            doc.setFontSize(10).setFont(undefined, 'bold');
            doc.text(`Total SQM: ${totals.sqm.toFixed(3)} m¬≤`, 14, finalY);
            doc.text(`Total (ex GST): $${totals.total.toFixed(2)}`, 14, finalY + 6);
            
            doc.save(`${formType}_${jobName}.pdf`);
        }
    };
    // ==================== PDF PREVIEW SYSTEM ====================
    let currentPDFData = null;
    let currentPDFFilename = 'document.pdf';
    
    function closePDFPreview() {
        const modal = document.getElementById('pdfPreviewModal');
        if (modal) {
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
        }
        const spinner = document.getElementById('pdfLoadingSpinner');
        if (spinner) {
            spinner.style.display = 'none';
        }
        currentPDFData = null;
        console.log('‚úì Preview closed');
    }
    
    function downloadCurrentPDF() {
        if (!currentPDFData) {
            alert('No PDF to download');
            return;
        }
        const link = document.createElement('a');
        link.href = currentPDFData;
        link.download = currentPDFFilename;
        link.click();
    }
    
    function showPDFPreview(pdfDataUri, filename, title) {
        console.log('üîç showPDFPreview called with:', filename);
        
        // Check if we're in batch print auto-print mode
        const autoPrint = window.autoPrintMode === true;
        
        try {
            const modal = document.getElementById('pdfPreviewModal');
            const spinner = document.getElementById('pdfLoadingSpinner');
            const iframe = document.getElementById('pdfPreviewIframe');
            
            if (!modal) {
                console.error('‚ùå Modal element not found!');
                alert('Error: Preview modal not found');
                return;
            }
            
            console.log('‚úì Modal found, showing...');
            
            // Show modal
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            
            // Show spinner
            spinner.style.display = 'block';
            
            // Set title
            document.getElementById('pdfPreviewTitle').textContent = title || 'PDF Preview';
            
            // Load PDF into iframe
            console.log('üìÑ Loading PDF into iframe...');
            iframe.src = pdfDataUri;
            
            // Hide spinner and auto-print if needed
            iframe.onload = () => {
                console.log('‚úì PDF loaded in iframe');
                spinner.style.display = 'none';
                
                if (autoPrint) {
                    // Auto-print for batch mode
                    console.log('üñ®Ô∏è Auto-printing...');
                    setTimeout(() => {
                        try {
                            iframe.contentWindow.print();
                        } catch(e) {
                            console.error('Auto-print error:', e);
                        }
                    }, 500);
                }
            };
            
            // Fallback: hide spinner after 3 seconds anyway
            setTimeout(() => {
                spinner.style.display = 'none';
            }, 3000);
            
            currentPDFData = pdfDataUri;
            currentPDFFilename = filename;
            
            console.log('‚úì PDF preview ready');
        } catch(err) {
            console.error('‚ùå Error in showPDFPreview:', err);
        }
    }
    // ==================== END PDF PREVIEW SYSTEM ====================
    
    // ==================== CHARGES MODAL SYSTEM ====================
    let pendingFormType = null;
    let appliedCharges = { 
        colourMultiplier: 0, 
        colourMultiplierLabel: 'NONE', 
        deliveryCharge: 0, 
        deliveryRegionLabel: 'None',
        courierCost: 0,
        otherChargeDesc: '',
        otherChargeAmount: 0,
        gstRate: 0.10
    };
    
    function showChargesModal(formType) {
        pendingFormType = formType;
        const modal = document.getElementById('chargesModal');
        if (modal) {
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
        }
        
        // Get all unique colours from items
        const uniqueColours = [...new Set(items
            .map(it => {
                const brand = it.brand || '';
                const color = it.color || '';
                const finish = it.finish || 'Satin';
                return brand && color ? `${brand} ${color} ${finish}` : (color ? `${color} ${finish}` : '');
            })
            .filter(c => c && c.trim())
        )];
        
        // Build colour surcharge selectors - MULTI-SELECT with checkboxes
        let colourHTML = '';
        if (uniqueColours.length > 0) {
            colourHTML = '<div style="margin-bottom:8px;"><label style="display:block; font-weight:bold; color:#333; margin-bottom:6px; font-size:11px;">üé® Paint Colour Surcharges:</label>';
            
            uniqueColours.forEach((colour, idx) => {
                const containerId = `colourSurcharges_${idx}`;
                colourHTML += `<div style="margin-bottom:8px; padding:8px; background:#f9f9f9; border-radius:4px; border-left:3px solid #2196f3;">
                    <div style="font-weight:900; font-size:10px; color:#000; margin-bottom:5px;">${colour}</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; font-size:9px;">
                        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
                            <input type="checkbox" class="surcharge-check" data-colour="${colour}" data-type="Clear" data-mult="0" style="cursor:pointer; width:14px; height:14px;">
                            <span>Clear</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
                            <input type="checkbox" class="surcharge-check" data-colour="${colour}" data-type="Standard" data-mult="0.05" style="cursor:pointer; width:14px; height:14px;">
                            <span>Std +5%</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
                            <input type="checkbox" class="surcharge-check" data-colour="${colour}" data-type="Light" data-mult="0.05" style="cursor:pointer; width:14px; height:14px;">
                            <span>Light +5%</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
                            <input type="checkbox" class="surcharge-check" data-colour="${colour}" data-type="Dark" data-mult="0.15" style="cursor:pointer; width:14px; height:14px;">
                            <span>Dark +15%</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
                            <input type="checkbox" class="surcharge-check" data-colour="${colour}" data-type="ExtraTint" data-mult="0.3" style="cursor:pointer; width:14px; height:14px;">
                            <span>Tint +30%</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
                            <input type="checkbox" class="surcharge-check" data-colour="${colour}" data-type="Undercoat" data-mult="0.8" style="cursor:pointer; width:14px; height:14px;">
                            <span>UC +80%</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:4px; cursor:pointer;">
                            <input type="checkbox" class="surcharge-check" data-colour="${colour}" data-type="ColourMatch" data-mult="1.3" style="cursor:pointer; width:14px; height:14px;">
                            <span>Colour Match</span>
                        </label>
                    </div>
                </div>`;
            });
            
            colourHTML += '</div>';
        } else {
            colourHTML = '<div style="margin-bottom:8px;"><p style="color:#999; font-size:10px; margin:0;">No colours specified</p></div>';
        }
        
        // Insert into modal
        const colourContainer = document.getElementById('colourSurchargesContainer');
        if (colourContainer) {
            colourContainer.innerHTML = colourHTML;
            
            // Attach change handlers to checkboxes
            document.querySelectorAll('.surcharge-check').forEach(checkbox => {
                checkbox.addEventListener('change', updateChargesSummary);
            });
        }
        
        // Reset other fields
        document.getElementById('deliveryRegionSelect').value = '0';
        document.getElementById('freightChargeInput').value = '0';
        document.getElementById('otherChargeDesc').value = '';
        document.getElementById('otherChargeAmount').value = '0';
        
        // Reinitialize colour surcharge tracking - now stores arrays
        window.colourSurcharges = {};
        uniqueColours.forEach((colour, idx) => {
            window.colourSurcharges[colour] = []; // Store as array for multiple surcharges
        });
        
        // Initialize summary on modal open
        setTimeout(() => updateChargesSummary(), 100);
    }
    
    function closeChargesModal() {
        const modal = document.getElementById('chargesModal');
        if (modal) {
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
        }
        pendingFormType = null;
    }
    
    function updateChargesSummary() {
        console.log('üîç updateChargesSummary() called');
        // Get all colour surcharges - now MULTIPLE per colour from checkboxes
        const colourSurcharges = {}; // { 'Wattyl Lexicon Satin': [0.15, 1.3], ... }
        
        document.querySelectorAll('.surcharge-check:checked').forEach(checkbox => {
            const colour = checkbox.getAttribute('data-colour');
            const mult = parseFloat(checkbox.getAttribute('data-mult')) || 0;
            const type = checkbox.getAttribute('data-type');
            
            console.log(`  ‚úì Checkbox found: ${type} (${mult}) for colour: ${colour}`);
            
            if (!colourSurcharges[colour]) {
                colourSurcharges[colour] = [];
            }
            colourSurcharges[colour].push(mult);
        });
        
        console.log('üì¶ colourSurcharges object:', colourSurcharges);
        
        // Calculate subtotal grouped by colour
        let colorSubtotals = {}; // { 'Wattyl Lexicon Satin': 1000, ... }
        let subtotal = 0;
        
        items.forEach(item => {
            const qty = parseInt(item.qty) || 1;
            const height = parseInt(item.h) || 0;
            const width = parseInt(item.w) || 0;
            const sqm = (height * width) / 1000000;
            let pricePerSqm = 125;
            
            // Check for moulded profile pricing
            const profile = item.prof || '';
            const profileBase = profile.replace(/\s*\(\d+\)\s*$/, '').trim();
            const pricingMatrix = {
                'Plain': 125,
                'Shaker 45': 171, 'Ashlee': 171, 'Bevelled Edge': 171,
                'Branxholme': 171, 'Hamilton': 171, 'Tarrone': 171
            };
            pricePerSqm = pricingMatrix[profileBase] || pricingMatrix[profile] || 125;
            const itemTotal = sqm * pricePerSqm * qty;
            
            // Group by colour
            const brand = item.brand || '';
            const color = item.color || '';
            const finish = item.finish || 'Satin';
            const colourKey = brand && color ? `${brand} ${color} ${finish}` : (color ? `${color} ${finish}` : 'No Colour');
            
            if (!colorSubtotals[colourKey]) colorSubtotals[colourKey] = 0;
            colorSubtotals[colourKey] += itemTotal;
            subtotal += itemTotal;
        });
        
        // Calculate total colour surcharges - NOW HANDLES MULTIPLE SURCHARGES
        let totalColourSurcharge = 0;
        let surchargeDetails = []; // Track all surcharges for display
        const chargesData = loadAdditionalCharges();  // Load flat rate for colour match
        
        Object.entries(colorSubtotals).forEach(([colour, colourSubtotal]) => {
            const multipliers = colourSurcharges[colour] || [];
            
            if (multipliers && multipliers.length > 0) {
                // Sum all selected surcharges for this colour
                let colourTotalSurcharge = 0;
                
                multipliers.forEach(mult => {
                    if (mult > 0) {
                        // Check if this is Colour Match (use flat rate)
                        let surcharge;
                        if (mult === 1.3 || mult === 1.30) {
                            // Colour Match - use flat rate
                            surcharge = chargesData.colourMatchFlatRate;
                            surchargeDetails.push(`${colour}: Colour Match = $${surcharge.toFixed(2)}`);
                        } else if (mult === 0.8) {
                            // Undercoat (special handling - only on paint portion)
                            surcharge = colourSubtotal * 0.35 * mult;
                            surchargeDetails.push(`${colour}: ${(mult * 100).toFixed(0)}% = $${surcharge.toFixed(2)}`);
                        } else {
                            // Other multipliers (percentage-based)
                            surcharge = colourSubtotal * mult;
                            surchargeDetails.push(`${colour}: ${(mult * 100).toFixed(0)}% = $${surcharge.toFixed(2)}`);
                        }
                        colourTotalSurcharge += surcharge;
                    }
                });
                
                totalColourSurcharge += colourTotalSurcharge;
            }
        });
        
        // NOW calculate delivery, courier, and other charges
        const deliveryCharge = parseFloat(document.getElementById('deliveryRegionSelect').value) || 0;
        const courierCost = parseFloat(document.getElementById('freightChargeInput').value) || 0;
        const otherChargeAmount = parseFloat(document.getElementById('otherChargeAmount').value) || 0;
        
        const subtotalPlusCharges = subtotal + totalColourSurcharge + deliveryCharge + courierCost + otherChargeAmount;
        
        const chargesDataForGST = loadAdditionalCharges();
        const gstRate = chargesDataForGST.gstRate || 0.10;
        const gstAmount = subtotalPlusCharges * gstRate;
        const totalWithGST = subtotalPlusCharges + gstAmount;
        
        document.getElementById('summaryColourCharge').textContent = totalColourSurcharge.toFixed(2);
        document.getElementById('summaryDeliveryCharge').textContent = deliveryCharge.toFixed(2);
        document.getElementById('summaryFreightCharge').textContent = courierCost.toFixed(2);
        document.getElementById('summaryOtherCharge').textContent = otherChargeAmount.toFixed(2);
        document.getElementById('summarySubtotalPlusCharges').textContent = subtotalPlusCharges.toFixed(2);
        document.getElementById('summaryGST').textContent = gstAmount.toFixed(2);
        document.getElementById('summaryTotalCharge').textContent = totalWithGST.toFixed(2);
        
        // Update applied charges with per-colour data (NOW MULTI-SURCHARGE ARRAYS)
        appliedCharges.colourSurcharges = colourSurcharges;
        appliedCharges.totalColourSurcharge = totalColourSurcharge;
        appliedCharges.surchargeDetails = surchargeDetails;
        appliedCharges.deliveryCharge = deliveryCharge;
        appliedCharges.courierCost = courierCost;
        appliedCharges.otherChargeDesc = document.getElementById('otherChargeDesc').value || '';
        appliedCharges.otherChargeAmount = otherChargeAmount;
        appliedCharges.gstRate = gstRate;
        
        console.log('üíæ appliedCharges.colourSurcharges set to:', appliedCharges.colourSurcharges);
        console.log('‚úÖ Total colour surcharge: $' + totalColourSurcharge.toFixed(2));
        
        // Get labels for PDF
        const deliveryOpt = document.getElementById('deliveryRegionSelect').options[document.getElementById('deliveryRegionSelect').selectedIndex];
        appliedCharges.deliveryRegionLabel = deliveryOpt.text;
    }
    
    document.addEventListener('change', function(e) {
        if (e.target.id === 'deliveryRegionSelect' || e.target.id === 'freightChargeInput' || e.target.id === 'otherChargeAmount' || e.target.id === 'otherChargeDesc' || e.target.classList.contains('surcharge-check')) {
            updateChargesSummary();
        }
    });
    
    document.addEventListener('input', function(e) {
        if (e.target.id === 'freightChargeInput' || e.target.id === 'otherChargeAmount') {
            updateChargesSummary();
        }
    });
    
    function applyChargesAndGenerate() {
        console.log('üîÑ Applying charges, pendingFormType:', pendingFormType);
        console.log('üìä Current appliedCharges:', appliedCharges);
        
        try {
            // SAVE the form type BEFORE closing modal (which sets it to null)
            const formType = pendingFormType;
            console.log('üíæ Saved formType:', formType);
            
            // Store charges before closing modal
            const currentCharges = { ...appliedCharges };
            console.log('‚úì Charges stored:', currentCharges);
            
            // Close modal (this sets pendingFormType = null)
            closeChargesModal();
            console.log('‚úì Modal closed');
            
            // Small delay to ensure modal is fully closed before PDF generation
            setTimeout(() => {
                try {
                    console.log('üé¨ Starting PDF generation for:', formType);
                    
                    // Generate PDF based on SAVED form type
                    if (formType === 'Estimate') {
                        console.log('üìã Calling genEstimate()...');
                        genEstimate();
                    } else if (formType === 'Quote Form' || formType === 'Quote') {
                        console.log('üìÑ Calling PaintWorkzEngine.generatePDF()...');
                        genQuoteForm();
                    } else if (formType === 'Invoice') {
                        console.log('üßæ Calling genInvoice()...');
                        genInvoice();
                    } else {
                        console.error('‚ùå Unknown form type:', formType);
                        notify('‚ùå Error: Unknown form type: ' + formType);
                    }
                } catch(err) {
                    console.error('‚ùå Error during PDF generation:', err);
                    console.error('Stack:', err.stack);
                    notify('‚ùå PDF Error: ' + err.message);
                }
            }, 150);
            
        } catch(err) {
            console.error('‚ùå Error in applyChargesAndGenerate:', err);
            notify('‚ùå Error: ' + err.message);
        }
    }
    // ==================== END CHARGES MODAL SYSTEM ====================
    
    function getSortedTierNames() {
        // Sort tier names: Tier 1, 2, 3, 4, 5, then Other
        const tierNames = Object.keys(masterMatrix);
        return tierNames.sort((a, b) => {
            // Extract numbers from "Tier X"
            const aMatch = a.match(/Tier (\d+)/);
            const bMatch = b.match(/Tier (\d+)/);
            
            if (aMatch && bMatch) {
                // Both are "Tier X" - sort by number
                return parseInt(aMatch[1]) - parseInt(bMatch[1]);
            } else if (aMatch) {
                // a is "Tier X", b is something else - a comes first
                return -1;
            } else if (bMatch) {
                // b is "Tier X", a is something else - b comes first
                return 1;
            } else {
                // Neither are "Tier X" - alphabetical
                return a.localeCompare(b);
            }
        });
    }
    
    // ===== CLIENT DATABASE FUNCTIONS =====
    function getClientDatabase() {
        const db = localStorage.getItem('clientDatabase');
        return db ? JSON.parse(db) : {};
    }
    
    function saveClientDatabase(db) {
        localStorage.setItem('clientDatabase', JSON.stringify(db));
    }
    
    function filterClientList() {
        const searchBox = document.getElementById('clientSearchBox');
        const searchTerm = searchBox.value.toLowerCase().trim();
        const clientRows = document.querySelectorAll('[data-client-name]');
        
        clientRows.forEach(row => {
            const clientName = row.getAttribute('data-client-name').toLowerCase();
            if (clientName.includes(searchTerm) || searchTerm === '') {
                row.style.display = 'flex';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function renderClientsList() {
        console.log('renderClientsList called');
        const clientsDiv = document.getElementById('clientsList');
        if (!clientsDiv) {
            console.error('‚ùå clientsList div not found!');
            return;
        }
        console.log('‚úì Found clientsList div');
        
        try {
            const seen = new Set();
            const allClients = [];
            
            // 1. Get free from Google AI Studio ‚Üí client database (authoritative source)
            const db = getClientDatabase();
            console.log(`üìä Client database has ${Object.keys(db).length} clients`);
            Object.entries(db).forEach(([clientId, client]) => {
                if (client.name && !seen.has(client.name.toLowerCase())) {
                    // Include the ID from the database key
                    const clientWithId = { ...client, id: clientId };
                    allClients.push(clientWithId);
                    seen.add(client.name.toLowerCase());
                }
            });
            
            // 2. Get free from Google AI Studio ‚Üí job history (catch any missing clients)
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            history.forEach(job => {
                if (job.client && !seen.has(job.client.toLowerCase())) {
                    const clientId = 'client-' + btoa(job.client.toLowerCase()).replace(/[^a-zA-Z0-9]/g, '');
                    allClients.push({
                        id: clientId,
                        name: job.client,
                        contactName: '',
                        landline: '',
                        mobile: '',
                        email1: '',
                        email2: '',
                        address: '',
                        town: '',
                        postcode: ''
                    });
                    seen.add(job.client.toLowerCase());
                }
            });
            
            // 3. Get free from Google AI Studio ‚Üí hardcoded clients array (restore full list)
            if (typeof clients !== 'undefined' && Array.isArray(clients)) {
                clients.forEach(clientName => {
                    if (clientName && !seen.has(clientName.toLowerCase())) {
                        const clientId = 'client-' + btoa(clientName.toLowerCase()).replace(/[^a-zA-Z0-9]/g, '');
                        allClients.push({
                            id: clientId,
                            name: clientName,
                            contactName: '',
                            landline: '',
                            mobile: '',
                            email1: '',
                            email2: '',
                            address: '',
                            town: '',
                            postcode: ''
                        });
                        seen.add(clientName.toLowerCase());
                    }
                });
            }
            
            
            // Sort alphabetically by name
            allClients.sort((a, b) => a.name.localeCompare(b.name));
            
            
            
            if (allClients.length === 0) {
                clientsDiv.innerHTML = '<p style="text-align:center; color:#999; font-size:12px; padding:20px;">No clients yet. Add one to get started!</p>';
                return;
            }
            
            let html = '';
            allClients.forEach(client => {
                const clientId = client.id || '';
                console.log('Rendering client:', client.name, 'ID:', clientId);
                html += `<div data-client-name="${client.name}" data-client-id="${clientId}" style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:#fff; border-bottom:1px solid #f0f0f0; flex-shrink:0;">
                    <div style="flex:1;">
                        <div style="font-weight:900; font-size:13px; color:#333;">${client.name}</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="editClientBtn" style="background:#2196f3; color:#fff; border:none; padding:8px 14px; border-radius:4px; font-weight:900; font-size:11px; cursor:pointer;">‚úèÔ∏è EDIT</button>
                        <button class="deleteClientBtn" style="background:#ff3b30; color:#fff; border:none; padding:8px 14px; border-radius:4px; font-weight:900; font-size:11px; cursor:pointer;">üóëÔ∏è DELETE</button>
                    </div>
                </div>`;
            });
            
            clientsDiv.innerHTML = html;
            
            // Add event listeners to edit/delete buttons
            document.querySelectorAll('.editClientBtn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const clientId = this.closest('[data-client-id]').getAttribute('data-client-id');
                    const clientName = this.closest('[data-client-name]').getAttribute('data-client-name');
                    console.log('Edit button clicked for:', clientName, 'ID:', clientId);
                    showEditClientForm(clientId, clientName);
                });
            });
            
            document.querySelectorAll('.deleteClientBtn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    const clientId = this.closest('[data-client-id]').getAttribute('data-client-id');
                    const clientName = this.closest('[data-client-name]').getAttribute('data-client-name');
                    if(confirm(`Delete ${clientName}?`)) {
                        deleteClient(clientId);
                    }
                });
            });
        } catch(e) {
            console.error('Error rendering clients list:', e);
            clientsDiv.innerHTML = '<p style="color:red; padding:20px;">Error loading clients</p>';
        }
    }
    function showEditClientForm(clientId, clientName) {
        console.log('Opening edit form for clientId:', clientId, 'clientName:', clientName);
        const db = getClientDatabase();
        console.log('Database keys:', Object.keys(db));
        
        let client = db[clientId];
        
        // Fallback 1: search by ID property
        if (!client) {
            console.warn('Direct lookup failed - searching by id property...');
            for (let key in db) {
                if (db[key] && db[key].id === clientId) {
                    client = db[key];
                    console.log('Found by id property:', client.name);
                    break;
                }
            }
        }
        
        // Fallback 2: search by name (for clients from job history or hardcoded list)
        if (!client && clientName) {
            console.warn('ID search failed - searching by client name:', clientName);
            for (let key in db) {
                if (db[key] && db[key].name && db[key].name.toLowerCase() === clientName.toLowerCase()) {
                    client = db[key];
                    console.log('Found by name:', client.name);
                    break;
                }
            }
        }
        
        // Fallback 3: create new client entry if not found
        if (!client) {
            console.warn('Client not in database - creating new entry for:', clientName);
            client = {
                id: clientId,
                name: clientName || '',
                contactName: '',
                landline: '',
                mobile: '',
                email1: '',
                email2: '',
                address: '',
                town: '',
                postcode: ''
            };
        }
        
        console.log('Using client:', client.name);
        
        const modalId = 'editClientModal-' + Date.now();
        const overlayId = 'editOverlay-' + Date.now();
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.innerHTML = `
            <div style="background:#fff; border-radius:12px; padding:20px; border:2px solid #2196f3; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:5000; max-width:90%; width:500px; max-height:85vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                <h3 style="margin-top:0; margin-bottom:20px; font-weight:900;">‚úèÔ∏è Edit Client</h3>
                
                <label style="margin-top:10px; font-weight:900; font-size:11px; color:#666;">Client Company Name *</label>
                <input type="text" id="modalClientName" value="${client.name || ''}" placeholder="e.g., ABC Kitchens" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Contact Person Name</label>
                <input type="text" id="modalClientContactName" value="${client.contactName || ''}" placeholder="e.g., John Smith" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Landline</label>
                        <input type="tel" id="modalClientLandline" value="${client.landline || ''}" placeholder="(03) 1234 5678" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Mobile</label>
                        <input type="tel" id="modalClientMobile" value="${client.mobile || ''}" placeholder="0438 803 032" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                </div>
                
                <label style="font-weight:900; font-size:11px; color:#666;">Email Address 1</label>
                <input type="email" id="modalClientEmail1" value="${client.email1 || client.email || ''}" placeholder="john@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Email Address 2 (Optional)</label>
                <input type="email" id="modalClientEmail2" value="${client.email2 || ''}" placeholder="jane@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Street Address</label>
                <input type="text" id="modalClientAddress" value="${client.address || ''}" placeholder="123 Main Street" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Town/City</label>
                        <input type="text" id="modalClientTown" value="${client.town || ''}" placeholder="Geelong" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Postcode</label>
                        <input type="text" id="modalClientPostcode" value="${client.postcode || ''}" placeholder="3220" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                </div>
                
                <label style="font-weight:900; font-size:11px; color:#666;">State</label>
                <select id="modalClientState" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    <option value="">-- Select State --</option>
                    <option value="NSW" ${client.state === 'NSW' ? 'selected' : ''}>NSW</option>
                    <option value="VIC" ${client.state === 'VIC' ? 'selected' : ''}>VIC</option>
                    <option value="QLD" ${client.state === 'QLD' ? 'selected' : ''}>QLD</option>
                    <option value="WA" ${client.state === 'WA' ? 'selected' : ''}>WA</option>
                    <option value="SA" ${client.state === 'SA' ? 'selected' : ''}>SA</option>
                    <option value="TAS" ${client.state === 'TAS' ? 'selected' : ''}>TAS</option>
                    <option value="NT" ${client.state === 'NT' ? 'selected' : ''}>NT</option>
                    <option value="ACT" ${client.state === 'ACT' ? 'selected' : ''}>ACT</option>
                </select>
                
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button onclick="saveNewClient('${clientId}', '${modalId}', '${overlayId}')" style="flex:1; background:#2196f3; color:#fff; border:none; padding:12px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer;">‚úì Save</button>
                    <button onclick="document.getElementById('${modalId}').remove(); document.getElementById('${overlayId}').remove();" style="flex:1; background:#e0e0e0; color:#333; border:none; padding:12px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer;">Cancel</button>
                </div>
            </div>
        `;
        const overlay = document.createElement('div');
        overlay.id = overlayId;
        overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:4999;';
        // REMOVED: overlay.onclick handler - This was clearing data on accidental clicks
        // Now only Cancel button will close without saving
        document.body.appendChild(overlay);
        document.body.appendChild(modal);
        document.getElementById('modalClientName').focus();
    }
    
    function showAddClientForm() {
        const newId = 'client-' + Date.now();
        const modalId = 'addClientModal-' + Date.now();
        const overlayId = 'addOverlay-' + Date.now();
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.innerHTML = `
            <div style="background:#fff; border-radius:12px; padding:20px; border:2px solid #34c759; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:5000; max-width:90%; width:500px; max-height:85vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                <h3 style="margin-top:0; margin-bottom:20px; font-weight:900;">‚ûï Add New Client</h3>
                
                <label style="margin-top:10px; font-weight:900; font-size:11px; color:#666;">Client Company Name *</label>
                <input type="text" id="modalClientName" placeholder="e.g., ABC Kitchens" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Contact Person Name</label>
                <input type="text" id="modalClientContactName" placeholder="e.g., John Smith" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Landline</label>
                        <input type="tel" id="modalClientLandline" placeholder="(03) 1234 5678" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Mobile</label>
                        <input type="tel" id="modalClientMobile" placeholder="0438 803 032" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                </div>
                
                <label style="font-weight:900; font-size:11px; color:#666;">Email Address 1</label>
                <input type="email" id="modalClientEmail1" placeholder="john@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Email Address 2 (Optional)</label>
                <input type="email" id="modalClientEmail2" placeholder="jane@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Street Address</label>
                <input type="text" id="modalClientAddress" placeholder="123 Main Street" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <div style="display:grid; grid-template-columns:2fr 1fr; gap:10px;">
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Town/Suburb</label>
                        <input type="text" id="modalClientTown" placeholder="Sydney" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Postcode</label>
                        <input type="text" id="modalClientPostcode" placeholder="2000" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                </div>
                
                <label style="font-weight:900; font-size:11px; color:#666;">State</label>
                <select id="modalClientState" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    <option value="">-- Select State --</option>
                    <option value="NSW">NSW</option>
                    <option value="VIC">VIC</option>
                    <option value="QLD">QLD</option>
                    <option value="WA">WA</option>
                    <option value="SA">SA</option>
                    <option value="TAS">TAS</option>
                    <option value="NT">NT</option>
                    <option value="ACT">ACT</option>
                </select>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="document.getElementById('${modalId}').remove(); document.getElementById('${overlayId}').remove();" style="padding:12px; border:1px solid #ccc; background:#fff; border-radius:6px; font-weight:900; cursor:pointer;">CANCEL</button>
                    <button onclick="saveNewClient('${newId}')" style="padding:12px; border:none; background:#34c759; color:#fff; border-radius:6px; font-weight:900; cursor:pointer;">‚úÖ ADD CLIENT</button>
                </div>
            </div>
        `;
        const overlay = document.createElement('div');
        overlay.id = overlayId;
        overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; z-index:4999; background:rgba(0,0,0,0.3); cursor:pointer;';
        // REMOVED: overlay.onclick handler - This was clearing data on accidental clicks
        // Now only CANCEL button will close without saving
        document.body.appendChild(overlay);
        document.body.appendChild(modal);
        document.getElementById('modalClientName').focus();
    }
    
    function editClient(clientId) {
        const db = getClientDatabase();
        const client = db[clientId];
        if (!client) {
            notify('‚ùå Client not found');
            return;
        }
        
        const modalId = 'editClientModal-' + Date.now();
        const overlayId = 'editOverlay-' + Date.now();
        
        const overlay = document.createElement('div');
        overlay.id = overlayId;
        overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; z-index:4999; background:rgba(0,0,0,0.3); cursor:pointer;';
        
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:5000; background:#fff; border-radius:12px; padding:20px; border:2px solid #2196f3; max-width:90%; width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.3);';
        modal.innerHTML = `
            <h3 style="margin-top:0; margin-bottom:20px; font-weight:900;">‚úèÔ∏è Edit Client</h3>
            
            <label style="margin-top:0; display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Company Name *</label>
            <input type="text" id="editClientName" value="${client.name}" placeholder="e.g., ABC Kitchens" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
            
            <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Contact Person Name</label>
            <input type="text" id="editClientContactName" value="${client.contactName || ''}" placeholder="e.g., John Smith" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Landline</label>
                    <input type="tel" id="editClientLandline" value="${client.landline || ''}" placeholder="(03) 1234 5678" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
                </div>
                <div>
                    <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Mobile</label>
                    <input type="tel" id="editClientMobile" value="${client.mobile || ''}" placeholder="0438 803 032" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
                </div>
            </div>
            
            <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Email Address 1</label>
            <input type="email" id="editClientEmail1" value="${client.email1 || client.email || ''}" placeholder="john@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
            
            <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Email Address 2 (Optional)</label>
            <input type="email" id="editClientEmail2" value="${client.email2 || ''}" placeholder="jane@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
            
            <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Street Address</label>
            <input type="text" id="editClientAddress" value="${client.address || ''}" placeholder="123 Main Street" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
            
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Town/Suburb</label>
                    <input type="text" id="editClientTown" value="${client.town || ''}" placeholder="Sydney" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
                </div>
                <div>
                    <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Postcode</label>
                    <input type="text" id="editClientPostcode" value="${client.postcode || ''}" placeholder="2000" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
                </div>
            </div>
            
            <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">State</label>
            <select id="editClientState" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
                <option value="">-- Select State --</option>
                <option value="NSW" ${client.state === 'NSW' ? 'selected' : ''}>NSW</option>
                <option value="VIC" ${client.state === 'VIC' ? 'selected' : ''}>VIC</option>
                <option value="QLD" ${client.state === 'QLD' ? 'selected' : ''}>QLD</option>
                <option value="WA" ${client.state === 'WA' ? 'selected' : ''}>WA</option>
                <option value="SA" ${client.state === 'SA' ? 'selected' : ''}>SA</option>
                <option value="TAS" ${client.state === 'TAS' ? 'selected' : ''}>TAS</option>
                <option value="NT" ${client.state === 'NT' ? 'selected' : ''}>NT</option>
                <option value="ACT" ${client.state === 'ACT' ? 'selected' : ''}>ACT</option>
            </select>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button id="editCancelBtn" style="padding:12px; border:1px solid #ccc; background:#fff; border-radius:6px; font-weight:900; cursor:pointer; font-size:12px;">CANCEL</button>
                <button id="editSaveBtn" style="padding:12px; border:none; background:#2196f3; color:#fff; border-radius:6px; font-weight:900; cursor:pointer; font-size:12px;">üíæ SAVE</button>
            </div>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(modal);
        
        // Add event listeners after modal is in DOM
        document.getElementById('editCancelBtn').addEventListener('click', () => {
            modal.remove();
            overlay.remove();
        });
        
        document.getElementById('editSaveBtn').addEventListener('click', () => {
            const newName = document.getElementById('editClientName').value.trim();
            const contactName = document.getElementById('editClientContactName').value.trim();
            const landline = document.getElementById('editClientLandline').value.trim();
            const mobile = document.getElementById('editClientMobile').value.trim();
            const email1 = document.getElementById('editClientEmail1').value.trim();
            const email2 = document.getElementById('editClientEmail2').value.trim();
            const address = document.getElementById('editClientAddress').value.trim();
            const town = document.getElementById('editClientTown').value.trim();
            const postcode = document.getElementById('editClientPostcode').value.trim();
            const state = document.getElementById('editClientState').value.trim();
            
            if (!newName) {
                alert('Company name is required!');
                return;
            }
            
            // CRITICAL: Capture OLD name BEFORE updating database
            const db = getClientDatabase();
            const oldName = db[clientId].name;
            
            // Now update the database with ALL fields
            db[clientId] = { 
                id: clientId, 
                name: newName, 
                contactName: contactName,
                landline: landline,
                mobile: mobile,
                email1: email1,
                email2: email2,
                address: address,
                town: town,
                postcode: postcode,
                state: state,
                createdDate: db[clientId].createdDate 
            };
            saveClientDatabase(db);
            
            
            // SYNC: Update all jobs that reference this client in ALL storage locations
            let jobsSynced = 0;
            
            // 1. Update paintworkz-jobs (working jobs)
            try {
                const jobsJson = localStorage.getItem('paintworkz-jobs') || '[]';
                let jobs = JSON.parse(jobsJson);
                jobs = jobs.map(job => {
                    if (job.client && job.client.id === clientId) {
                        job.client.name = newName;
                        job.client.contactName = contactName;
                        job.client.landline = landline;
                        job.client.mobile = mobile;
                        job.client.email1 = email1;
                        job.client.email2 = email2;
                        job.client.address = address;
                        job.client.town = town;
                        job.client.postcode = postcode;
                        jobsSynced++;
                    }
                    return job;
                });
                localStorage.setItem('paintworkz-jobs', JSON.stringify(jobs));
            } catch(e) {
                console.error('Error syncing to working jobs:', e);
            }
            
            // 2. Update jobHistory (saved/completed jobs)
            try {
                const historyJson = localStorage.getItem('jobHistory') || '[]';
                let history = JSON.parse(historyJson);
                let historySynced = 0;
                history = history.map(job => {
                    // Match by ID if available
                    if (job.client && job.client.id === clientId) {
                        job.client.name = newName;
                        job.client.email = email;
                        job.client.phone = phone;
                        job.client.address = address;
                        historySynced++;
                    } 
                    // Match by OLD name if no ID (legacy jobs)
                    else if (job.clientName === oldName) {
                        job.clientName = newName;
                        historySynced++;
                    }
                    return job;
                });
                localStorage.setItem('jobHistory', JSON.stringify(history));
                jobsSynced += historySynced;
            } catch(e) {
                console.error('Error syncing to job history:', e);
            }
            
            // 3. Update current job form if it's this client
            try {
                const currentClientField = document.getElementById('cli');
                if (currentClientField && currentClientField.value === oldName) {
                    currentClientField.value = newName;
                    console.log('‚úì Updated current job client field');
                }
            } catch(e) {
                console.warn('Could not update current job client field:', e);
            }
            
            modal.remove();
            overlay.remove();
            notify(`‚úì Client Updated: ${newName}\n(${jobsSynced} jobs synced)`);
            renderClientsList();
            populateClientDropdown();  // Refresh dropdown to show updated names without duplicates
            renderHistory();  // Refresh history to show updated names
        });
        
        // REMOVED: overlay.addEventListener('click') - This was clearing data on accidental clicks outside modal
        // Now only CANCEL button will close without saving
        
        document.getElementById('editClientName').focus();
    }
    
    function saveNewClient(clientId, modalId, overlayId) {
        try {
            const name = document.getElementById('modalClientName').value.trim();
            const contactName = document.getElementById('modalClientContactName').value.trim();
            const landline = document.getElementById('modalClientLandline').value.trim();
            const mobile = document.getElementById('modalClientMobile').value.trim();
            const email1 = document.getElementById('modalClientEmail1').value.trim();
            const email2 = document.getElementById('modalClientEmail2').value.trim();
            const address = document.getElementById('modalClientAddress').value.trim();
            const town = document.getElementById('modalClientTown').value.trim();
            const postcode = document.getElementById('modalClientPostcode').value.trim();
            const state = document.getElementById('modalClientState').value.trim();
            
            if (!name) {
                alert('Client name is required!');
                return;
            }
            
            const db = getClientDatabase();
            db[clientId] = { 
                id: clientId, 
                name, 
                contactName, 
                landline, 
                mobile, 
                email1, 
                email2, 
                address, 
                town, 
                postcode,
                state,
                createdDate: new Date().toISOString()
            };
            saveClientDatabase(db);
            
            // Close modal and overlay using passed IDs
            if (modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.remove();
            }
            if (overlayId) {
                const overlay = document.getElementById(overlayId);
                if (overlay) overlay.remove();
            }
            
            // Fallback cleanup if IDs didn't work
            document.querySelectorAll('div[style*="z-index:5000"], div[style*="z-index:4999"]').forEach(el => el.remove());
            
            addAdminAlert('NEW_CLIENT', `‚úÖ NEW CLIENT ADDED: "${name}"`, {clientName: name});
            renderClientsList();
            notify(`‚úì Client Saved: ${name}`);
            
        } catch(err) {
            console.error('‚ùå Error saving client:', err);
            notify('‚ùå Error saving client: ' + err.message);
            // Emergency cleanup on error
            document.querySelectorAll('div[style*="z-index:5000"], div[style*="z-index:4999"]').forEach(el => el.remove());
        }
    }
    
    
    // Type-ahead dropdown for client search and selection

    function deleteClient(clientId) {
        const db = getClientDatabase();
        
        // Try to find client by ID first
        let client = db[clientId];
        let clientName = client ? client.name : null;
        
        // If not found by ID, try to extract name from the hash-based ID and search
        if (!clientName) {
            // Look through all clients to find matching ID
            Object.values(db).forEach(c => {
                const hashId = 'client-' + btoa(c.name.toLowerCase()).replace(/[^a-zA-Z0-9]/g, '');
                if (hashId === clientId) {
                    client = c;
                    clientName = c.name;
                }
            });
        }
        
        if (!clientName) {
            console.error(`Client not found: ${clientId}`);
            return;
        }
        
        // 1. Delete from database if it exists
        if (client && client.id) {
            delete db[client.id];
            saveClientDatabase(db);
        }
        
        // 2. Remove ALL jobs with this client from job history
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const originalCount = history.length;
        const filteredHistory = history.filter(job => job.client && job.client.toLowerCase() !== clientName.toLowerCase());
        localStorage.setItem('jobHistory', JSON.stringify(filteredHistory));
        
        // 3. Remove from legacy clients array
        if (typeof clients !== 'undefined' && Array.isArray(clients)) {
            const originalLen = clients.length;
            clients = clients.filter(c => c && c.toLowerCase() !== clientName.toLowerCase());
        }
        
        addAdminAlert('CLIENT_DELETED', `üóëÔ∏è CLIENT DELETED: "${clientName}"`, {clientName: clientName});
        
        // Refresh the lists
        renderClientsList(); // Admin tab
        populateClientDropdown(); // Measure tab
        console.log(`‚úì Client lists refreshed`);
    }
    
    function renderPricingMatrix() {
        console.log('renderPricingMatrix called');
        const target = document.getElementById('admin-pricing-matrix');
        if (!target) {
            console.error('‚ùå admin-pricing-matrix div not found!');
            return;
        }
        console.log('‚úì Found admin-pricing-matrix div');
        
        
        let html = `
            <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
                <button onclick="clearFirebaseProfilesData()" style="background:#2196f3; color:#fff; border:none; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">
                    üîÑ SYNC TO FIREBASE (Keep Assignments)
                </button>
                <button onclick="diagnoseStorage()" style="background:#9c27b0; color:#fff; border:none; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;" title="Debug: Check console (F12) to see what's in storage">
                    üîç DIAGNOSE STORAGE
                </button>
            </div>
            <p style="font-size:10px; color:#666; margin-bottom:15px; background:#fffaf0; padding:10px; border-radius:4px; border-left:3px solid #ff9500;">
                <strong style="color:#2196f3;">‚úì Sync to Firebase:</strong> Clears stale Firebase, keeps YOUR current assignments<br>
                <strong style="color:#9c27b0;">üîç Diagnose:</strong> Shows exactly what's in browser storage (check console F12)
            </p>
            
            <table style="width:100%; border-collapse:collapse; font-size:10px; background:#fff;">
                <tr style="background:#000; color:var(--gs); font-weight:900;">
                    <th style="padding:8px; text-align:left; width:150px;">Profile</th>
                    <th style="padding:8px; text-align:center;">Matt</th>
                    <th style="padding:8px; text-align:center;">Satin</th>
                    <th style="padding:8px; text-align:center;">Semi-Gloss</th>
                    <th style="padding:8px; text-align:center;">Gloss</th>
                </tr>
        `;
        
        const sortedTiers = getSortedTierNames();
        sortedTiers.forEach(tierName => {
            html += `<tr style="background:#eee;"><td colspan="5" style="padding:8px; font-weight:900; color:#000;">${tierName}</td></tr>`;
            
            const tier = masterMatrix[tierName];
            Object.keys(tier).forEach(code => {
                const data = tier[code];
                const profileName = data[0];
                const prices = data.slice(1);
                
                html += `<tr>
                    <td style="padding:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:900; cursor:pointer;" onclick="editDoorName('${tierName}', ${code}, '${profileName}')" title="Click to edit name">${profileName}</div>
                                <div style="font-size:9px; color:#999;">(${code})</div>
                            </div>
                            <div style="display:flex; gap:4px;">
                                <button onclick="editDoorTier('${tierName}', ${code}, '${profileName}')" style="background:#2196f3; color:#fff; border:none; padding:4px 6px; border-radius:3px; font-weight:900; font-size:9px; cursor:pointer;" title="Change tier">üîÑ</button>
                                <button onclick="deleteDoorFromMatrix('${tierName}', ${code}, '${profileName}')" style="background:#ff3b30; color:#fff; border:none; padding:4px 6px; border-radius:3px; font-weight:900; font-size:9px; cursor:pointer;" title="Delete door">‚úï</button>
                            </div>
                        </div>
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[0]}" onchange="updatePricingMatrix('${tierName}', ${code}, 0, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[1]}" onchange="updatePricingMatrix('${tierName}', ${code}, 1, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[2]}" onchange="updatePricingMatrix('${tierName}', ${code}, 2, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[3]}" onchange="updatePricingMatrix('${tierName}', ${code}, 3, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                </tr>`;
            });
        });
        
        // GET UNALLOCATED DOORS FIRST (before using them in HTML)
        const unallocatedDoors = getUnallocatedDoors();
        
        // Unallocated Doors Section
        html += `<tr style="background:#fff3cd; border-top:3px solid #ffb300;"><td colspan="5" style="padding:12px; font-weight:900; color:#000; font-size:12px;">‚ö†Ô∏è UNALLOCATED DOORS (${unallocatedDoors.length} to assign)</td></tr>
        <tr style="background:#ffe0b2;"><td colspan="5" style="padding:10px; font-size:10px; color:#000; border-bottom:2px solid #ff9800;">
            <strong>üìã HOW TO ALLOCATE:</strong><br>
            1Ô∏è‚É£ Set prices for each finish (or use defaults)<br>
            2Ô∏è‚É£ Select a tier from the dropdown<br>
            3Ô∏è‚É£ Click <strong>‚úì ASSIGN TO TIER</strong><br>
            üóëÔ∏è To delete a door permanently: use the <strong>‚úï button in this table</strong>
        </td></tr>`;
        
        if (unallocatedDoors.length > 0) {
            unallocatedDoors.forEach(door => {
                html += `<tr style="background:#fffaf0;">
                    <td style="padding:8px; max-width:150px;">
                        <div style="font-weight:900; word-break:break-word;">${door.name}</div>
                        <div style="font-size:9px; color:#999;">Unassigned</div>
                    </td>
                    <td colspan="5" style="padding:8px; text-align:center;">
                        <div style="display:flex; gap:5px; margin-bottom:5px; flex-wrap:wrap; justify-content:center;">
                            <input type="number" inputmode="numeric" id="unalloc_matt_${door.code}" value="125" placeholder="Matt" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                            <input type="number" inputmode="numeric" id="unalloc_satin_${door.code}" value="125" placeholder="Satin" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                            <input type="number" inputmode="numeric" id="unalloc_semigloss_${door.code}" value="152" placeholder="Semi" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                            <input type="number" inputmode="numeric" id="unalloc_gloss_${door.code}" value="152" placeholder="Gloss" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                        </div>
                        <select id="unalloc_tier_${door.code}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:10px; margin-bottom:5px;">
                            <option value="">Select Tier...</option>
                            ${getSortedTierNames().map(t => `<option value="${t}">${t}</option>`).join('')}
                        </select>
                        <div style="display:flex; gap:5px;">
                            <button onclick="assignDoorToTier('${door.code}', '${door.name}')" style="flex:1; padding:8px; background:#34c759; color:#fff; border:none; border-radius:4px; font-weight:900; font-size:11px; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1);">‚úì ASSIGN</button>
                            <button onclick="deleteUnallocatedDoor('${door.code}', '${door.name}')" style="padding:8px 6px; background:#ff3b30; color:#fff; border:none; border-radius:4px; font-weight:900; font-size:11px; cursor:pointer;" title="Delete door permanently">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>`;
            });
        } else {
            html += `<tr style="background:#fffaf0;"><td colspan="5" style="padding:12px; text-align:center; color:#999; font-size:11px;">‚úì All doors allocated!</td></tr>`;
        }
        
        html += `</table>`;
        target.innerHTML = html;
    }
    
    function getUnallocatedDoors() {
        // Get doors that are in database but not in price matrix tiers
        const doorsInMatrix = new Set();
        Object.values(masterMatrix).forEach(tier => {
            Object.keys(tier).forEach(code => {
                const doorName = tier[code][0];
                // Add both the full name and the base name (without code suffix)
                doorsInMatrix.add(doorName);
                // Also add without parenthetical code suffix
                const baseNameOnly = doorName.split('(')[0].trim();
                doorsInMatrix.add(baseNameOnly);
            });
        });
        
        console.log('üîç Doors in matrix:', Array.from(doorsInMatrix));
        console.log('üìã All profiles:', profiles);
        
        const unallocated = [];
        profiles.forEach((profileName, idx) => {
            // Extract base name (without code suffix like "(101)")
            const baseName = profileName.split('(')[0].trim();
            
            // Check if either full name or base name is in matrix
            const isAllocated = doorsInMatrix.has(profileName) || doorsInMatrix.has(baseName);
            
            if (!isAllocated) {
                console.warn(`  ‚ö†Ô∏è NOT FOUND: "${profileName}" (base: "${baseName}")`);
                unallocated.push({ name: profileName, code: 9000 + idx });
            } else {
            }
        });
        
        return unallocated;
    }
    
    function assignDoorToTier(code, doorName) {
        const tier = document.getElementById(`unalloc_tier_${code}`).value;
        if (!tier) {
            alert('Please select a tier');
            return;
        }
        
        const matt = parseFloat(document.getElementById(`unalloc_matt_${code}`).value) || 125;
        const satin = parseFloat(document.getElementById(`unalloc_satin_${code}`).value) || 125;
        const semiGloss = parseFloat(document.getElementById(`unalloc_semigloss_${code}`).value) || 152;
        const gloss = parseFloat(document.getElementById(`unalloc_gloss_${code}`).value) || 152;
        
        
        // Add to tier
        const newCode = parseInt(Object.keys(masterMatrix[tier]).sort().reverse()[0]) + 1;
        masterMatrix[tier][newCode] = [doorName, matt, satin, semiGloss, gloss];
        
        localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
        
        // NOTE: DO NOT remove from profiles array!
        // Door should remain in profiles (ALL doors) and just be marked as allocated in masterMatrix
        
        // Sync to Firebase
        syncProfilesToFirebase();
        
        renderPricingMatrix();
        refreshLists(); // Update measure tab dropdown
        notify(`‚úì ${doorName} assigned to ${tier}`);
    }
    
    function deleteUnallocatedDoor(code, doorName) {
        if (!confirm(`üö® DELETE PERMANENTLY: "${doorName}"?\n\nThis will remove it from your profile database!`)) {
            console.log(`  ‚úó Deletion cancelled`);
            return;
        }
        
        console.log(`  ‚úì User confirmed deletion`);
        
        // Remove from profiles array
        profiles = profiles.filter(p => p !== doorName);
        saveProfilesToStorage(); // SAVE TO STORAGE
        console.log(`  Current profiles:`, profiles);
        
        // Sync to Firebase
        syncProfilesToFirebase();
        
        renderPricingMatrix();
        refreshLists(); // Update database tab
        notify(`üóëÔ∏è ${doorName} permanently deleted`);
    }
    
    function updatePricingMatrix(tier, code, priceIndex, val) {
        masterMatrix[tier][code][priceIndex + 1] = parseFloat(val);
        localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
        notify('‚úì Price Updated');
    }
    
    // Edit door name in price matrix
    function editDoorName(tier, code, oldName) {
        const newName = prompt(`Edit door name:\n\nCurrent: ${oldName}`, oldName);
        if (newName && newName.trim() !== '' && newName.trim() !== oldName) {
            const trimmed = newName.trim();
            // Update in masterMatrix
            masterMatrix[tier][code][0] = trimmed;
            localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
            
            // Update in profiles array
            const idx = profiles.indexOf(oldName);
            if (idx > -1) {
                profiles[idx] = trimmed;
                saveProfilesToStorage();
            }
            
            renderPricingMatrix();
            notify(`‚úì Renamed to "${trimmed}"`);
        }
    }
    
    // Change door tier in price matrix
    function editDoorTier(tier, code, doorName) {
        const tierNames = getSortedTierNames();
        let selection = 'EXISTING TIERS:\n';
        tierNames.forEach(t => selection += '  ‚Ä¢ ' + t + '\n');
        
        const newTier = prompt(`Move "${doorName}" to which tier?\n\n${selection}\n(Type "Tier X" to move to existing or create new)`, tier);
        
        if (!newTier || newTier === tier) {
            return; // No change or cancelled
        }
        
        const trimmedTier = newTier.trim();
        
        // Get the door data
        const doorData = masterMatrix[tier][code];
        
        // Check if tier exists
        if (!masterMatrix[trimmedTier]) {
            // Create new tier
            masterMatrix[trimmedTier] = {};
        }
        
        // Find new code in target tier (next available)
        const newCode = parseInt(Object.keys(masterMatrix[trimmedTier]).sort().reverse()[0] || 0) + 1;
        
        // Move to new tier
        masterMatrix[trimmedTier][newCode] = doorData;
        delete masterMatrix[tier][code];
        
        // If old tier is now empty, delete it
        if (Object.keys(masterMatrix[tier]).length === 0) {
            delete masterMatrix[tier];
        }
        
        localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
        
        renderPricingMatrix();
        notify(`‚úì Moved to ${trimmedTier}`);
    }
    
    // Delete door from price matrix (returns it to unallocated)
    function deleteDoorFromMatrix(tier, code, doorName) {
        if (!confirm(`Remove "${doorName}" from ${tier}?\n\nIt will appear as unallocated.`)) {
            return;
        }
        
        delete masterMatrix[tier][code];
        localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
        
        renderPricingMatrix();
        notify(`üóëÔ∏è Removed from tier`);
    }

    // TIMELINE EDITOR
    let timelineEditMode = null; // 'default' or jobIdx
    let timelineEditData = {};

    function getScheduledFinishDate(dateReceived, jobTimeline) {
        if (!dateReceived || !jobTimeline) return null;
        
        // Parse received date
        const received = new Date(dateReceived);
        if (isNaN(received.getTime())) return null;
        
        // Sum all timeline days
        const totalDays = 
            (jobTimeline.measuring || 1) +
            (jobTimeline.sanding1 || 4) +
            (jobTimeline.undercoat || 2) +
            (jobTimeline.sanding2 || 3) +
            (jobTimeline.topcoat || 2) +
            (jobTimeline.inspect || 2) +
            (jobTimeline.complete || 1);
        
        // Add days to received date
        const scheduled = new Date(received);
        scheduled.setDate(scheduled.getDate() + totalDays);
        
        // Format as DD/MM/YYYY
        const day = String(scheduled.getDate()).padStart(2, '0');
        const month = String(scheduled.getMonth() + 1).padStart(2, '0');
        const year = scheduled.getFullYear();
        
        return `${day}/${month}/${year}`;
    }

    function getDefaultTimeline() {
        const defaults = JSON.parse(localStorage.getItem('defaultTimeline')) || {
            measuring: 2,
            sanding1: 16,
            undercoat: 18,
            sanding2: 20,
            topcoat: 22,
            inspect: 24,
            complete: 25
        };
        return defaults;
    }

    function editDefaultTimeline() {
        timelineEditMode = 'default';
        timelineEditData = getDefaultTimeline();
        renderTimelineEditor();
    }
    
    // ===== TIMELINE SETTINGS FUNCTIONS =====
    function saveTimelineSettings() {
        const timeline = {
            measuring: parseInt(document.getElementById('timelineMeasure')?.value) || 2,
            sanding1: parseInt(document.getElementById('timelineSand1')?.value) || 3,
            undercoat: parseInt(document.getElementById('timelineUndercoat')?.value) || 3,
            sanding2: parseInt(document.getElementById('timelineSand2')?.value) || 2,
            topcoat: parseInt(document.getElementById('timelineTopcoat')?.value) || 4,
            inspect: parseInt(document.getElementById('timelineInstall')?.value) || 2,
            complete: parseInt(document.getElementById('timelineCompletion')?.value) || 1
        };
        
        localStorage.setItem('defaultTimeline', JSON.stringify(timeline));
        showGlobalNotification('‚úì GANTT CHART TIMELINE SAVED', '#e8f5e9', '#2196f3');
        console.log('‚úì Timeline settings saved:', timeline);
    }
    
    function resetTimelineSettings() {
        const defaults = {
            measuring: 2,
            sanding1: 3,
            undercoat: 3,
            sanding2: 2,
            topcoat: 4,
            inspect: 2,
            complete: 1
        };
        
        localStorage.setItem('defaultTimeline', JSON.stringify(defaults));
        initializeTimelineSettings();
        showGlobalNotification('‚úì TIMELINE RESET TO DEFAULTS', '#fff3e0', '#ff9500');
        console.log('‚úì Timeline reset to defaults:', defaults);
    }
    
    function initializeTimelineSettings() {
        const timeline = JSON.parse(localStorage.getItem('defaultTimeline')) || {
            measuring: 2,
            sanding1: 3,
            undercoat: 3,
            sanding2: 2,
            topcoat: 4,
            inspect: 2,
            complete: 1
        };
        
        const fields = {
            'timelineMeasure': timeline.measuring,
            'timelineSand1': timeline.sanding1,
            'timelineUndercoat': timeline.undercoat,
            'timelineSand2': timeline.sanding2,
            'timelineTopcoat': timeline.topcoat,
            'timelineInstall': timeline.inspect,
            'timelineCompletion': timeline.complete
        };
        
        Object.entries(fields).forEach(([fieldId, value]) => {
            const field = document.getElementById(fieldId);
            if (field) field.value = value;
        });
        
        console.log('‚úì Timeline settings initialized:', timeline);
    }
    
    // ===== END TIMELINE SETTINGS FUNCTIONS =====
    
    // Load default settings
    function loadDefaultSettings() {
        const settings = JSON.parse(localStorage.getItem('paintworkz-defaults')) || {};
        return {
            thickness: settings.thickness || 18,
            seReturn: settings.seReturn || 100
        };
    }
    
    // Save default settings
    function updateGlobalSettingsUI() {
        // Update dropdown and checkbox values to match current AdminSettings
        const unitsSelect = document.getElementById('globalUnitsSelect');
        const precisionSelect = document.getElementById('globalPrecisionSelect');
        const predictiveToggle = document.getElementById('predictiveInputToggle');
        const aiHelperToggle = document.getElementById('aiHelperToggle');
        const colourMatchInput = document.getElementById('colourMatchSurcharge');
        
        if (unitsSelect) unitsSelect.value = AdminSettings.units;
        if (precisionSelect) precisionSelect.value = AdminSettings.precision;
        if (predictiveToggle) predictiveToggle.checked = AdminSettings.predictiveInput;
        if (aiHelperToggle) aiHelperToggle.checked = AdminSettings.aiHelperEnabled;
        if (colourMatchInput) colourMatchInput.value = loadAdditionalCharges().colourMatchFlatRate;
        
        console.log('‚úì Global Settings UI updated');
        renderPaintBrandsList();
    }
    
    // Paint Brands Management
    function getPaintBrands() {
        const saved = localStorage.getItem('paintBrands');
        // Default brands for Australia
        const defaultBrands = ['Wattyl', 'Dulux', 'Taubmans', 'Haymes', 'British Paints', 'Evic'];
        
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                // If it's an array with at least 1 item, use it
                if (Array.isArray(parsed) && parsed.length > 0) {
                    console.log('‚úì Paint brands loaded from localStorage:', parsed);
                    return parsed;
                }
            } catch(e) {
                console.warn('‚ö†Ô∏è Could not parse paintBrands from localStorage, using defaults');
            }
        }
        
        // If nothing saved or error, use and save defaults
        console.log('‚úì Using default paint brands (first time):', defaultBrands);
        savePaintBrands(defaultBrands);
        return defaultBrands;
    }
    
    function savePaintBrands(brands) {
        localStorage.setItem('paintBrands', JSON.stringify(brands));
        console.log('‚úì Paint brands saved:', brands);
    }
    
    function addPaintBrand() {
        const input = document.getElementById('newPaintBrandInput');
        const brand = input.value.trim();
        
        if (!brand) {
            alert('Please enter a brand name');
            return;
        }
        
        const brands = getPaintBrands();
        if (brands.includes(brand)) {
            alert('Brand already exists');
            return;
        }
        
        brands.push(brand);
        savePaintBrands(brands);
        renderPaintBrandsList();
        input.value = '';
        notify(`‚úì Brand Added: ${brand}`);
    }
    
    function removePaintBrand(brandName) {
        if (!confirm(`Remove "${brandName}" from paint brands?`)) return;
        
        const brands = getPaintBrands();
        const filtered = brands.filter(b => b !== brandName);
        savePaintBrands(filtered);
        renderPaintBrandsList();
        notify(`‚úì Brand Removed: ${brandName}`);
    }
    
    function renderPaintBrandsList() {
        const container = document.getElementById('paintBrandsList');
        if (!container) return;
        
        const brands = getPaintBrands();
        let html = '';
        
        brands.forEach(brand => {
            html += `<div style="background:#fff; padding:6px 12px; border-radius:20px; border:1px solid #ddd; display:flex; align-items:center; gap:8px; font-size:11px;">
                <span style="font-weight:900;">${brand}</span>
                <button onclick="removePaintBrand('${brand}')" style="background:none; border:none; color:#ff3b30; font-weight:900; font-size:14px; cursor:pointer; padding:0; width:18px; height:18px; line-height:18px;">√ó</button>
            </div>`;
        });
        
        container.innerHTML = html || '<span style="color:#999; font-size:10px;">No brands configured</span>';
    }
    
    function populatePaintBrandsDropdown() {
        const select = document.getElementById('p-brand');
        if (!select) return;
        
        const brands = getPaintBrands();
        select.innerHTML = '';
        
        brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand;
            option.textContent = brand;
            select.appendChild(option);
        });
        
        // Add Custom option at the end
        const customOption = document.createElement('option');
        customOption.value = 'Custom';
        customOption.textContent = 'Custom';
        select.appendChild(customOption);
        
        // Set to remembered brand OR Dulux default
        const lastBrand = localStorage.getItem('lastPaintBrand') || 'Dulux';
        if (brands.includes(lastBrand)) {
            select.value = lastBrand;
        } else if (brands.includes('Dulux')) {
            select.value = 'Dulux';
        } else if (brands.length > 0) {
            select.value = brands[0];
        }
    }
    
    function openChatAI() {
        if (!AdminSettings.aiHelperEnabled) {
            notify('üí¨ AI Helper is disabled. Enable in Admin ‚Üí Global Settings');
            return;
        }
        
        // Create chat modal if it doesn't exist
        let chatModal = document.getElementById('aiChatModal');
        if (!chatModal) {
            chatModal = document.createElement('div');
            chatModal.id = 'aiChatModal';
            
            // Detect if mobile
            const isMobile = window.innerWidth <= 480;
            const modalWidth = isMobile ? 'calc(100vw - 20px)' : '380px';
            const modalHeight = isMobile ? 'calc(100vh - 180px)' : '500px';
            const modalRight = isMobile ? '10px' : '20px';
            const modalTop = isMobile ? '90px' : '80px';
            
            chatModal.innerHTML = `
                <div style="position:fixed; top:${modalTop}; right:${modalRight}; width:${modalWidth}; max-width:100%; height:${modalHeight}; max-height:calc(100vh - 150px); background:#fff; border-radius:12px; box-shadow:0 8px 32px rgba(98, 0, 234, 0.2); z-index:5000; display:flex; flex-direction:column; border:2px solid #6200ea; box-sizing:border-box;">
                    <!-- Header -->
                    <div style="background:linear-gradient(135deg, #6200ea 0%, #7c3aed 100%); color:#fff; padding:16px; border-radius:10px 10px 0 0; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:900; font-size:14px;">ü§ñ PaintWorkz AI Helper</div>
                            <div style="font-size:10px; opacity:0.9; margin-top:2px;">Trade Guidance & Support</div>
                        </div>
                        <button onclick="closeChatAI()" style="background:none; border:none; color:#fff; font-size:20px; cursor:pointer; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center;">√ó</button>
                    </div>
                    
                    <!-- Messages Area -->
                    <div id="aiChatMessages" style="flex:1; overflow-y:auto; padding:16px; display:flex; flex-direction:column; gap:12px; background:#f9f9f9;">
                        <div style="background:#e8d5ff; color:#333; padding:10px; border-radius:8px; font-size:12px; line-height:1.4;">
                            <strong>üëã Hello!</strong> I'm your AI Assistant. Ask me questions about paint colours, job planning, measurements, or any trade-related topics!
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div style="padding:12px; border-top:1px solid #eee; display:flex; gap:8px;">
                        <input type="text" id="aiChatInput" placeholder="Ask me anything..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:12px; box-sizing:border-box;" onkeypress="if(event.key==='Enter') sendAIMessage();">
                        <button onclick="sendAIMessage()" style="background:#6200ea; color:#fff; border:none; padding:10px 16px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer; min-width:50px;">SEND</button>
                    </div>
                </div>
            `;
            document.body.appendChild(chatModal);
        }
        
        chatModal.style.display = 'flex';
        document.getElementById('aiChatInput').focus();
    }
    
    function closeChatAI() {
        const chatModal = document.getElementById('aiChatModal');
        if (chatModal) {
            chatModal.style.display = 'none';
        }
    }
    
    function sendAIMessage() {
        const input = document.getElementById('aiChatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        const messagesDiv = document.getElementById('aiChatMessages');
        
        // Add user message to chat
        const userMsgDiv = document.createElement('div');
        userMsgDiv.style.cssText = 'align-self:flex-end; background:#6200ea; color:#fff; padding:10px 14px; border-radius:8px; max-width:280px; font-size:12px; word-wrap:break-word;';
        userMsgDiv.textContent = message;
        messagesDiv.appendChild(userMsgDiv);
        
        // Clear input
        input.value = '';
        
        // Show thinking indicator
        const thinkingDiv = document.createElement('div');
        thinkingDiv.id = 'aiThinking';
        thinkingDiv.style.cssText = 'background:#f0e6ff; color:#666; padding:10px; border-radius:8px; font-size:12px;';
        thinkingDiv.textContent = 'ü§î Thinking...';
        messagesDiv.appendChild(thinkingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Send to Gemini API
        getAIResponse(message, thinkingDiv, messagesDiv);
    }
    
    async function getAIResponse(userMessage, thinkingDiv, messagesDiv) {
        try {
            // Get context from current job/settings
            const context = {
                units: AdminSettings.units,
                precision: AdminSettings.precision,
                brands: getPaintBrands(),
                currentJob: window.currentJob || null
            };
            
            const apiKey = getGeminiApiKey();
            
            console.log('Attempting to use Gemini API key:', apiKey ? apiKey.substring(0, 10) + '...' : 'NONE');
            
            if (!apiKey || apiKey.trim().length === 0) {
                // No API key configured
                if (thinkingDiv && thinkingDiv.parentNode) {
                    thinkingDiv.remove();
                }
                
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'background:#ffe8e8; color:#666; padding:10px; border-radius:8px; font-size:11px; line-height:1.4;';
                errorDiv.innerHTML = '<strong>‚öôÔ∏è API Key Required</strong><br>1. Go to Admin ‚Üí General Settings<br>2. Paste your Gemini API key<br>3. Reload the page (Ctrl+R)<br>4. Try again<br><br><a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#2196f3; text-decoration:none;">Get free Gemini API key ‚Üí</a>';
                messagesDiv.appendChild(errorDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                return;
            }
            
            const prompt = `You are a helpful AI assistant for PaintWorkz Pro, a painting and joinery job management system. 

Context: 
- User's settings: Units=${context.units}, Precision=${context.precision}
- Available paint brands: ${context.brands.join(', ')}
- Current job: ${context.currentJob ? context.currentJob.jobName : 'No active job'}

User question: ${userMessage}

Provide helpful, concise advice about painting, joinery, measurements, job planning, or using PaintWorkz Pro. Keep responses under 150 words.`;
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [
                        {
                            parts: [
                                {
                                    text: prompt
                                }
                            ]
                        }
                    ]
                })
            });
            
            if (!response.ok) {
                throw new Error('API error: ' + response.status);
            }
            
            const data = await response.json();
            const aiResponse = data.candidates[0].content.parts[0].text;
            
            // Remove thinking indicator
            if (thinkingDiv && thinkingDiv.parentNode) {
                thinkingDiv.remove();
            }
            
            // Add AI response
            const aiMsgDiv = document.createElement('div');
            aiMsgDiv.style.cssText = 'background:#e8d5ff; color:#333; padding:10px 14px; border-radius:8px; max-width:280px; font-size:12px; word-wrap:break-word; line-height:1.4;';
            aiMsgDiv.innerHTML = '<strong>ü§ñ</strong> ' + aiResponse;
            messagesDiv.appendChild(aiMsgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
        } catch (error) {
            console.error('AI error detailed:', error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            
            if (thinkingDiv && thinkingDiv.parentNode) {
                thinkingDiv.remove();
            }
            
            let errorMsg = '';
            if (error.message && error.message.includes('API error:')) {
                errorMsg = `API Error: ${error.message}. Check your API key is valid.`;
            } else if (error.message && error.message.includes('Failed to fetch')) {
                errorMsg = 'Network error. Check your internet connection and API key.';
            } else {
                errorMsg = `Error: ${error.message || 'Unknown error'}`;
            }
            
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'background:#ffe8e8; color:#666; padding:10px; border-radius:8px; font-size:11px;';
            errorDiv.innerHTML = `<strong>‚ö†Ô∏è ${errorMsg}</strong>`;
            messagesDiv.appendChild(errorDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }
    
    function saveDefaultSettings() {
        const thickness = parseFloat(document.getElementById('defaultThickness')?.value) || 18;
        const seReturn = parseFloat(document.getElementById('defaultSEReturn')?.value) || 100;
        
        const settings = {
            thickness: thickness,
            seReturn: seReturn
        };
        
        localStorage.setItem('paintworkz-defaults', JSON.stringify(settings));
        showGlobalNotification(`‚úì DEFAULTS SAVED\nThickness: ${thickness}mm ‚Ä¢ SE Return: ${seReturn}mm`, '#e8f5e9', '#34c759');
        console.log('‚úì Default settings saved:', settings);
    }
    
    // Load defaults on page load
    function initializeDefaultSettings() {
        const settings = loadDefaultSettings();
        const thkInput = document.getElementById('defaultThickness');
        const seInput = document.getElementById('defaultSEReturn');
        
        if (thkInput) thkInput.value = settings.thickness;
        if (seInput) seInput.value = settings.seReturn;
        
        // Also set measure tab thickness field to default
        const measureThk = document.getElementById('thk');
        if (measureThk) measureThk.value = settings.thickness;
        
        console.log('‚úì Default settings loaded:', settings);
    }
    
    // ===== COMPANY DETAILS FUNCTIONS =====
    function saveCompanyDetails() {
        const name = document.getElementById('companyName')?.value || 'Paintworkz';
        const phone = document.getElementById('companyPhone')?.value || '0438 803 032';
        const email = document.getElementById('companyEmail')?.value || 'paint_workz@outlook.com';
        const address = document.getElementById('companyAddress')?.value || '17 West Boundary Road, Hamilton 3300 VIC';
        
        const settings = {
            name: name,
            phone: phone,
            email: email,
            address: address
        };
        
        localStorage.setItem('companySettings', JSON.stringify(settings));
        
        const logoInput = document.getElementById('companyLogo');
        const headerLogoInput = document.getElementById('headerLogo');
        
        const hasCompanyLogo = logoInput && logoInput.files && logoInput.files[0];
        const hasHeaderLogo = headerLogoInput && headerLogoInput.files && headerLogoInput.files[0];
        
        let pendingReads = 0;
        
        // Count how many file reads we need to do
        if (hasCompanyLogo) pendingReads++;
        if (hasHeaderLogo) pendingReads++;
        
        // Helper function to check if we're done and show notification
        const checkComplete = () => {
            pendingReads--;
            if (pendingReads === 0) {
                const message = (hasCompanyLogo || hasHeaderLogo) 
                    ? `‚úì COMPANY DETAILS SAVED\nLogos uploaded` 
                    : `‚úì COMPANY DETAILS SAVED\nName: ${name}`;
                showGlobalNotification(message, '#e8f5e9', '#34c759');
                console.log('‚úì Company details saved:', settings);
                
                // Reload header logo if it was updated
                if (hasHeaderLogo) {
                    setTimeout(() => loadHeaderLogo(), 100);
                }
            }
        };
        
        // Save company logo if provided
        if (hasCompanyLogo) {
            const file = logoInput.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem('companyLogo', e.target.result);
                console.log('‚úì Company logo saved');
                checkComplete();
            };
            reader.onerror = (e) => {
                console.error('‚ùå Error reading company logo:', e);
                checkComplete();
            };
            reader.readAsDataURL(file);
        }
        
        // Save header logo if provided
        if (hasHeaderLogo) {
            const file = headerLogoInput.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                localStorage.setItem('headerLogo', e.target.result);
                console.log('‚úì Header logo saved');
                checkComplete();
            };
            reader.onerror = (e) => {
                console.error('‚ùå Error reading header logo:', e);
                checkComplete();
            };
            reader.readAsDataURL(file);
        }
        
        // If no logos, show notification immediately
        if (pendingReads === 0) {
            showGlobalNotification(`‚úì COMPANY DETAILS SAVED\nName: ${name}`, '#e8f5e9', '#34c759');
            console.log('‚úì Company details saved (no logos):', settings);
        }
    }
    
        function resetCompanyDetails() {
        if (confirm('Reset company details to defaults?')) {
            localStorage.removeItem('companySettings');
            localStorage.removeItem('companyLogo');
            localStorage.removeItem('headerLogo');
            initializeCompanyDetailsForm();
            showGlobalNotification('‚úì RESET TO DEFAULTS', '#fff3e0', '#ff9500');
        }
    }
    
    
    function initializeCompanyDetailsForm() {
        const defaults = {
            name: 'Paintworkz',
            address: '17 West Boundary Road, Hamilton 3300 VIC',
            phone: '0438 803 032',
            email: 'paint_workz@outlook.com'
        };
        
        const saved = JSON.parse(localStorage.getItem('companySettings')) || {};
        const settings = { ...defaults, ...saved };
        
        const nameInput = document.getElementById('companyName');
        const phoneInput = document.getElementById('companyPhone');
        const emailInput = document.getElementById('companyEmail');
        const addressInput = document.getElementById('companyAddress');
        
        if (nameInput) nameInput.value = settings.name;
        if (phoneInput) phoneInput.value = settings.phone;
        if (emailInput) emailInput.value = settings.email;
        if (addressInput) addressInput.value = settings.address;
        
        // Load and display header logo in app header
        loadHeaderLogo();
        
        console.log('‚úì Company details form initialized');
    }
    
    // ===== API KEY FUNCTIONS =====
    function saveApiKeys() {
        const evicKey = document.getElementById('evicApiKey')?.value || '';
        const xeroKey = document.getElementById('xeroApiKey')?.value || '';
        
        const apiKeys = {
            evic: evicKey,
            xero: xeroKey,
            savedAt: new Date().toLocaleString('en-AU')
        };
        
        localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
        notify('üîê API Keys saved successfully');
        console.log('‚úì API keys saved');
    }
    
    function initializeApiKeysForm() {
        const saved = JSON.parse(localStorage.getItem('apiKeys')) || {};
        
        const evicInput = document.getElementById('evicApiKey');
        const xeroInput = document.getElementById('xeroApiKey');
        
        if (evicInput) evicInput.value = saved.evic || '';
        if (xeroInput) xeroInput.value = saved.xero || '';
        
        console.log('‚úì API keys form initialized');
    }
    
    // ===== ADDITIONAL CHARGES FUNCTIONS =====
    function saveAdditionalCharges() {
        const charges = {
            colourMultipliers: {
                Clear: parseFloat(document.getElementById('chargeClear')?.value || 0) / 100,
                Standard: parseFloat(document.getElementById('chargeStandard')?.value || 0) / 100,
                Light: parseFloat(document.getElementById('chargeLight')?.value || 0) / 100,
                Dark: parseFloat(document.getElementById('chargeDark')?.value || 15) / 100,
                'Extra Tint': parseFloat(document.getElementById('chargeExtraTint')?.value || 30) / 100,
                Undercoat: parseFloat(document.getElementById('chargeUndercoat')?.value || 80) / 100,
                'Colour Match': 1.30  // Keep as marker for colour match
            },
            colourMatchFlatRate: parseFloat(document.getElementById('chargeColourMatch')?.value || 85),  // NEW: Flat rate for colour match
            deliveryRegions: {
                Warrnambool: parseFloat(document.getElementById('regionWarrnambool')?.value || 90),
                Geelong: parseFloat(document.getElementById('regionGeelong')?.value || 110),
                'Mt Gambier': parseFloat(document.getElementById('regionMtGambier')?.value || 110),
                Adelaide: parseFloat(document.getElementById('regionAdelaide')?.value || 250),
                Horsham: parseFloat(document.getElementById('regionHorsham')?.value || 110),
                Ballarat: parseFloat(document.getElementById('regionBallarat')?.value || 160)
            },
            gstRate: parseFloat(document.getElementById('gstRate')?.value || 10) / 100
        };
        
        localStorage.setItem('additionalCharges', JSON.stringify(charges));
        showGlobalNotification('‚úì ADDITIONAL CHARGES SAVED', '#e8f5e9', '#34c759');
        console.log('‚úì Additional charges saved:', charges);
    }
    
    function loadAdditionalCharges() {
        const defaults = {
            colourMultipliers: {
                Clear: 0,
                Standard: 0,
                Light: 0,
                Dark: 0.15,
                'Extra Tint': 0.30,
                Undercoat: 0.80,
                'Colour Match': 1.30  // Keep as marker
            },
            colourMatchFlatRate: 85,  // NEW: Default flat rate
            deliveryRegions: {
                Warrnambool: 90,
                Geelong: 110,
                'Mt Gambier': 110,
                Adelaide: 250,
                Horsham: 110,
                Ballarat: 160
            },
            gstRate: 0.10
        };
        
        const saved = JSON.parse(localStorage.getItem('additionalCharges')) || {};
        
        // MIGRATION: Convert old Colour Match percentage format to new flat rate format
        if (saved.colourMultipliers && saved.colourMultipliers['Colour Match'] && saved.colourMatchFlatRate === undefined) {
            // Old format detected - migrate to new format
            const oldMultiplier = saved.colourMultipliers['Colour Match'];
            // Convert percentage to flat rate: if it was 1.30 (130%), use default $85
            saved.colourMatchFlatRate = 85;
            console.log('‚úì Migrated Colour Match from percentage (1.30) to flat rate ($85)');
        }
        
        // Properly merge nested objects
        return {
            colourMultipliers: { ...defaults.colourMultipliers, ...(saved.colourMultipliers || {}) },
            colourMatchFlatRate: saved.colourMatchFlatRate !== undefined ? saved.colourMatchFlatRate : defaults.colourMatchFlatRate,
            deliveryRegions: { ...defaults.deliveryRegions, ...(saved.deliveryRegions || {}) },
            gstRate: saved.gstRate !== undefined ? saved.gstRate : defaults.gstRate
        };
    }
    
    function initializeAdditionalChargesForm() {
        const charges = loadAdditionalCharges();
        
        // Load colour multipliers
        document.getElementById('chargeClear').value = (charges.colourMultipliers.Clear * 100).toFixed(1);
        document.getElementById('chargeStandard').value = (charges.colourMultipliers.Standard * 100).toFixed(1);
        document.getElementById('chargeLight').value = (charges.colourMultipliers.Light * 100).toFixed(1);
        document.getElementById('chargeDark').value = (charges.colourMultipliers.Dark * 100).toFixed(1);
        document.getElementById('chargeExtraTint').value = (charges.colourMultipliers['Extra Tint'] * 100).toFixed(1);
        document.getElementById('chargeUndercoat').value = (charges.colourMultipliers.Undercoat * 100).toFixed(1);
        document.getElementById('chargeColourMatch').value = charges.colourMatchFlatRate;  // Load flat rate instead of percentage
        
        // Load delivery regions
        document.getElementById('regionWarrnambool').value = charges.deliveryRegions.Warrnambool;
        document.getElementById('regionGeelong').value = charges.deliveryRegions.Geelong;
        document.getElementById('regionMtGambier').value = charges.deliveryRegions['Mt Gambier'];
        document.getElementById('regionAdelaide').value = charges.deliveryRegions.Adelaide;
        document.getElementById('regionHorsham').value = charges.deliveryRegions.Horsham;
        document.getElementById('regionBallarat').value = charges.deliveryRegions.Ballarat;
        
        // Load GST rate
        document.getElementById('gstRate').value = (charges.gstRate * 100).toFixed(1);
        
        console.log('‚úì Additional charges form initialized');
    }

    function editJobTimeline(jobIdx) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[jobIdx];
        
        if (!job) return;
        
        timelineEditMode = jobIdx;
        timelineEditData = job.timeline || getDefaultTimeline();
        renderTimelineEditor();
    }

    function renderTimelineEditor() {
        const content = document.getElementById('timelineEditorContent');
        if (!content) return;
        
        content.innerHTML = `
            <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
                <p style="font-size:11px; color:#666; margin-bottom:15px; font-weight:900;">Configure default timeline durations for the job Gantt chart (measured in days)</p>
                
                <div style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight:900; font-size:12px; color:#333;">MEASURE (M)</label>
                    <input type="number" id="edit_measuring" value="${timelineEditData.measuring || 1}" min="1" max="30" oninput="updateTimelinePreview()" style="width:60px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; text-align:center; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight:900; font-size:12px; color:#333;">SAND 1ST COAT (S1)</label>
                    <input type="number" id="edit_sanding1" value="${timelineEditData.sanding1 || 4}" min="1" max="30" oninput="updateTimelinePreview()" style="width:60px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; text-align:center; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight:900; font-size:12px; color:#333;">UNDERCOAT (U)</label>
                    <input type="number" id="edit_undercoat" value="${timelineEditData.undercoat || 2}" min="1" max="30" oninput="updateTimelinePreview()" style="width:60px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; text-align:center; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight:900; font-size:12px; color:#333;">SAND 2ND COAT (S2)</label>
                    <input type="number" id="edit_sanding2" value="${timelineEditData.sanding2 || 3}" min="1" max="30" oninput="updateTimelinePreview()" style="width:60px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; text-align:center; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight:900; font-size:12px; color:#333;">TOP COAT (T)</label>
                    <input type="number" id="edit_topcoat" value="${timelineEditData.topcoat || 2}" min="1" max="30" oninput="updateTimelinePreview()" style="width:60px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; text-align:center; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight:900; font-size:12px; color:#333;">INSPECTION (I)</label>
                    <input type="number" id="edit_inspect" value="${timelineEditData.inspect || 2}" min="1" max="30" oninput="updateTimelinePreview()" style="width:60px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; text-align:center; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight:900; font-size:12px; color:#333;">COMPLETION/DELIVERY (C)</label>
                    <input type="number" id="edit_complete" value="${timelineEditData.complete || 1}" min="1" max="30" oninput="updateTimelinePreview()" style="width:60px; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px; text-align:center; box-sizing:border-box;">
                </div>
                
                <div id="timelinePreview" style="background:#e8f5e9; padding:12px; border-radius:6px; border-left:4px solid #34c759; margin-top:15px;">
                    <div style="font-size:10px; color:#333; font-weight:700; line-height:1.8;">
                        <strong style="font-size:11px;">üìÖ Total Duration Preview:</strong><br>
                        MEASURE: 1 day<br>
                        SAND 1ST COAT: 4 days<br>
                        UNDERCOAT: 2 days<br>
                        SAND 2ND COAT: 3 days<br>
                        TOP COAT: 2 days<br>
                        INSPECTION: 2 days<br>
                        COMPLETION/DELIVERY: 1 day
                    </div>
                </div>
            </div>
        `;
        
        updateTimelinePreview();
        document.getElementById('timelineModal').style.display = 'flex';
    }

    function updateTimelinePreview() {
        const measuring = parseInt(document.getElementById('edit_measuring')?.value) || 1;
        const sanding1 = parseInt(document.getElementById('edit_sanding1')?.value) || 4;
        const undercoat = parseInt(document.getElementById('edit_undercoat')?.value) || 2;
        const sanding2 = parseInt(document.getElementById('edit_sanding2')?.value) || 3;
        const topcoat = parseInt(document.getElementById('edit_topcoat')?.value) || 2;
        const inspect = parseInt(document.getElementById('edit_inspect')?.value) || 2;
        const complete = parseInt(document.getElementById('edit_complete')?.value) || 1;
        
        const total = measuring + sanding1 + undercoat + sanding2 + topcoat + inspect + complete;
        
        const preview = document.getElementById('timelinePreview');
        if (preview) {
            preview.innerHTML = `
                <div style="font-size:10px; color:#333; font-weight:700; line-height:1.8;">
                    <strong style="font-size:11px;">üìÖ Total Duration: ${total} days</strong><br>
                    <span style="color:#2196f3; font-weight:900;">MEASURE (M):</span> ${measuring} days<br>
                    <span style="color:#ff9500; font-weight:900;">SAND 1ST COAT (S1):</span> ${sanding1} days<br>
                    <span style="color:#8b4513; font-weight:900;">UNDERCOAT (U):</span> ${undercoat} days<br>
                    <span style="color:#ff9500; font-weight:900;">SAND 2ND COAT (S2):</span> ${sanding2} days<br>
                    <span style="color:#9c27b0; font-weight:900;">TOP COAT (T):</span> ${topcoat} days<br>
                    <span style="color:#673ab7; font-weight:900;">INSPECTION (I):</span> ${inspect} days<br>
                    <span style="color:#34c759; font-weight:900;">COMPLETION/DELIVERY (C):</span> ${complete} days
                </div>
            `;
        }
    }

    function saveTimelineEdit() {
        const measuring = parseInt(document.getElementById('edit_measuring').value);
        const sanding1 = parseInt(document.getElementById('edit_sanding1').value);
        const undercoat = parseInt(document.getElementById('edit_undercoat').value);
        const sanding2 = parseInt(document.getElementById('edit_sanding2').value);
        const topcoat = parseInt(document.getElementById('edit_topcoat').value);
        const inspect = parseInt(document.getElementById('edit_inspect').value);
        const complete = parseInt(document.getElementById('edit_complete').value);
        
        const timeline = { measuring, sanding1, undercoat, sanding2, topcoat, inspect, complete };
        
        if (timelineEditMode === 'default') {
            // Save default timeline
            localStorage.setItem('defaultTimeline', JSON.stringify(timeline));
            notify('‚úì Default Timeline Updated');
        } else {
            // Save job-specific timeline
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const job = history[timelineEditMode];
            if (job) {
                job.timeline = timeline;
                history[timelineEditMode] = job;
                localStorage.setItem('jobHistory', JSON.stringify(history));
                notify('‚úì Job Timeline Updated');
            }
        }
        
        closeTimelineModal();
        renderScheduleCalendar();
    }

    function closeTimelineModal() {
        document.getElementById('timelineModal').style.display = 'none';
        timelineEditMode = null;
    }

    function prevScheduleMonth() {
        console.log('‚óÄ Previous month clicked');
        console.log('Current date before:', scheduleCalendarDate);
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() - 1);
        console.log('Current date after:', scheduleCalendarDate);
        console.log('Rendering calendar...');
        renderScheduleCalendar();
        console.log('‚úì Calendar rendered');
    }

    function nextScheduleMonth() {
        console.log('‚ñ∂ Next month clicked');
        console.log('Current date before:', scheduleCalendarDate);
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() + 1);
        console.log('Current date after:', scheduleCalendarDate);
        console.log('Rendering calendar...');
        renderScheduleCalendar();
        console.log('‚úì Calendar rendered');
    }
    
    function toggleJobsChart() {
        const wrapper = document.getElementById('ganttWrapper');
        const monthYear = document.getElementById('scheduleMonthYear');
        const btn = document.getElementById('jobsChartToggleBtn');
        
        if (!wrapper) return;
        
        const isMinimized = localStorage.getItem('jobsChartMinimized') === 'true';
        
        if (isMinimized) {
            // Restore (maximize)
            wrapper.style.display = 'block';
            monthYear.style.display = 'block';
            btn.textContent = '‚àí';
            btn.style.background = '#2196f3';
            btn.title = 'Minimize';
            localStorage.setItem('jobsChartMinimized', 'false');
            console.log('üìä Jobs Chart maximized');
        } else {
            // Minimize
            wrapper.style.display = 'none';
            monthYear.style.display = 'none';
            btn.textContent = '+';
            btn.style.background = '#666';
            btn.title = 'Maximize';
            localStorage.setItem('jobsChartMinimized', 'true');
            console.log('üìä Jobs Chart minimized');
        }
    }
    
    // Restore Jobs Chart state on page load
    function restoreJobsChartState() {
        const isMinimized = localStorage.getItem('jobsChartMinimized') === 'true';
        if (isMinimized) {
            const wrapper = document.getElementById('ganttWrapper');
            const monthYear = document.getElementById('scheduleMonthYear');
            const btn = document.getElementById('jobsChartToggleBtn');
            if (wrapper && monthYear && btn) {
                wrapper.style.display = 'none';
                monthYear.style.display = 'none';
                btn.textContent = '+';
                btn.style.background = '#666';
            }
        }
    }
    
    // Restore on page load
    setTimeout(restoreJobsChartState, 500);
    
    function prevAdminScheduleMonth() {
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() - 1);
        renderAdminGanttChart();
    }

    function nextAdminScheduleMonth() {
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() + 1);
        renderAdminGanttChart();
    }
    
    function renderAdminGanttChart() {
        // Initialize scheduleCalendarDate if not set
        if (!scheduleCalendarDate || isNaN(scheduleCalendarDate?.getTime())) {
            scheduleCalendarDate = new Date();
            scheduleCalendarDate.setHours(0, 0, 0, 0);
        }
        
        const year = scheduleCalendarDate.getFullYear();
        const month = scheduleCalendarDate.getMonth();
        
        // Set month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        if (document.getElementById('adminScheduleMonthYear')) document.getElementById('adminScheduleMonthYear').innerText = `${monthNames[month]} ${year}`;
        
        const ganttChart = document.getElementById('adminGanttChart');
        if (!ganttChart) return;
        
        try {
            let fullHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            
            // Sort by received date - newest first
            let history = fullHistory
                .filter(job => !job.completed)
                .filter(job => !isJobDeleted(job.jobNum, job.dateReceived, job.client)) // Exclude deleted jobs
                .sort((a, b) => {
                    let dateA = new Date();
                    let dateB = new Date();
                    
                    // Parse dateReceived in DD/MM/YY format
                    if (a.dateReceived) {
                        if (a.dateReceived.includes('/')) {
                            const [day, month, year] = a.dateReceived.split('/');
                            dateA = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                        } else if (a.dateReceived.includes('-')) {
                            dateA = new Date(a.dateReceived);
                        }
                    }
                    
                    if (b.dateReceived) {
                        if (b.dateReceived.includes('/')) {
                            const [day, month, year] = b.dateReceived.split('/');
                            dateB = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                        } else if (b.dateReceived.includes('-')) {
                            dateB = new Date(b.dateReceived);
                        }
                    }
                    
                    return dateB - dateA;
                });
            
            // Build Gantt HTML
            let ganttHTML = '';
            
            // Define phases/timelines
            const phases = ['Prep', 'Paint', 'Assemble', 'Quality'];
            
            // Header
            ganttHTML += `<table style="border-collapse:collapse; width:100%;">
                <tr style="background:#000; color:#fff; border-bottom:3px solid #d4af37;">
                    <th style="padding:12px; text-align:left; width:200px; font-weight:900; font-size:12px;">JOB</th>
                    ${phases.map(p => `<th style="padding:12px; text-align:center; font-weight:900; font-size:11px; border-right:1px solid #fff;">${p}</th>`).join('')}
                </tr>`;
            
            // Rows
            history.forEach((job, idx) => {
                const jobPhases = job.phases || {};
                
                ganttHTML += `<tr style="border-bottom:1px solid #ddd; background:${idx % 2 === 0 ? '#fff' : '#f9f9f9'};">
                    <td style="padding:12px; font-weight:900; font-size:11px; border-right:1px solid #ddd;">
                        <div style="margin-bottom:4px;">#${job.jobNum}</div>
                        <div style="font-size:9px; color:#666;">${job.client}</div>
                    </td>
                    ${phases.map(phase => {
                        const isChecked = jobPhases[phase] || false;
                        return `<td style="text-align:center; padding:8px; border-right:1px solid #ddd;">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleGanttCell(${idx}, '${phase}')" style="width:18px; height:18px; cursor:pointer;">
                        </td>`;
                    }).join('')}
                </tr>`;
            });
            
            ganttHTML += '</table>';
            ganttChart.innerHTML = ganttHTML;
            
        } catch(e) {
            console.error('Error rendering admin Gantt chart:', e);
        }
    }

    function renderJobTasks() {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        let completedTasks = 0;
        let totalTasks = 0;
        
        // Count phases ONLY for ACTIVE (non-completed) jobs
        history.forEach((job, jobIdx) => {
            // Only count tasks for active jobs (not marked as completed)
            if (job.dateReceived && !job.completed) {
                // 7 phases per job: measuring, sanding1, undercoat, sanding2, topcoat, sanding2, topcoat, inspect, complete
                totalTasks += 7;
                
                // Count which phases are completed
                if (job.phases) {
                    if (job.phases.measuring) completedTasks++;
                    if (job.phases.sanding1) completedTasks++;
                    if (job.phases.undercoat) completedTasks++;
                    if (job.phases.sanding2) completedTasks++;
                    if (job.phases.topcoat) completedTasks++;
                    if (job.phases.inspect) completedTasks++;
                    if (job.phases.complete) completedTasks++;
                }
            }
        });
        
        // Update summary
        const activeJobs = history.filter(j => !j.completed).length;
        const totalSqm = history.filter(j => !j.completed).reduce((sum, j) => sum + parseFloat(j.totalSqm || 0), 0);
        
        if (document.getElementById('totalActiveJobs')) document.getElementById('totalActiveJobs').innerText = activeJobs;
        if (document.getElementById('totalTasks')) document.getElementById('totalTasks').innerText = `${completedTasks}/${totalTasks}`;
        if (document.getElementById('totalWorkload')) document.getElementById('totalWorkload').innerText = totalSqm.toFixed(1);
        
    }

    // PAINT FORMULA MANAGEMENT
    let paintFormulas = JSON.parse(localStorage.getItem('paintFormulas')) || {};

    function openFormulaPopup() {
        const brand = document.getElementById('p-brand').value;
        const color = document.getElementById('p-color').value || "Standard";
        const current = paintFormulas[`${brand}-${color}`] || "10% Thinner, 2:1 Hardener";
        
        let overlay = document.createElement('div');
        overlay.id = 'formula-pop';
        overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
        overlay.innerHTML = `
            <div class="card" style="width:100%; max-width:400px; border:2px solid var(--gs);">
                <h3 style="margin-top:0;">‚öóÔ∏è ${brand} Paint Formula</h3>
                <p style="font-size:10px; color:#666; margin-bottom:10px;">Editing mix for: <strong>${color}</strong></p>
                <label>Formula Mix Instructions:</label>
                <textarea id="fEdit" style="width:100%; height:100px; border-radius:8px; border:1px solid #ccc; padding:10px; font-family:monospace; font-size:12px; margin-bottom:10px; box-sizing:border-box;">${current}</textarea>
                <div style="display:flex; gap:10px;">
                    <button onclick="saveFormula('${brand}','${color}')" style="flex:1; background:var(--gs); color:#000; border:none; padding:12px; border-radius:8px; font-weight:900; cursor:pointer;">‚úì SAVE</button>
                    <button onclick="closeFormulaPopup()" style="flex:1; background:#444; color:#fff; border:none; border-radius:8px; font-weight:900; cursor:pointer;">CLOSE</button>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
    }

    function closeFormulaPopup() {
        const popup = document.getElementById('formula-pop');
        if (popup) popup.remove();
    }

    function saveFormula(brand, color) {
        const val = document.getElementById('fEdit').value;
        paintFormulas[`${brand}-${color}`] = val;
        localStorage.setItem('paintFormulas', JSON.stringify(paintFormulas));
        closeFormulaPopup();
        notify("‚úì Formula Saved");
    }

    // PAINT FORMULA DATABASE FUNCTIONS
    function getPaintFormulas() {
        return JSON.parse(localStorage.getItem('paintFormulaDB')) || [];
    }


    function openPaintFormulaDatabase() {
        document.getElementById('paintFormulaModal').style.display = 'flex';
        renderPaintFormulaList();
    }


    function searchPaintFormulas() {
        const brand = document.getElementById('formulaSearchBrand').value.toLowerCase();
        const color = document.getElementById('formulaSearchColor').value.toLowerCase();
        const formulas = getPaintFormulas();
        const content = document.getElementById('formulaListContent');
        
        const filtered = formulas.filter(f => 
            f.brand.toLowerCase().includes(brand) && 
            f.color.toLowerCase().includes(color)
        );
        
        if (filtered.length === 0) {
            content.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:11px;">No matching formulas found</div>';
            return;
        }
        
        content.innerHTML = '';
        filtered.forEach((formula, origIdx) => {
            const idx = formulas.indexOf(formula);
            content.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="font-weight:900; font-size:11px; color:#000;">${formula.brand} - ${formula.color}</div>
                    <div style="font-size:10px; color:#666; margin-top:3px;">${formula.formula}</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="selectPaintFormula(${idx})" style="border:none; background:#2196f3; color:#fff; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">SELECT</button>
                    <button onclick="deletePaintFormula(${idx})" style="border:none; background:#ff3b3015; color:#ff3b30; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">DELETE</button>
                </div>
            </div>`;
        });
    }


    function selectPaintFormula(idx) {
        const formulas = getPaintFormulas();
        const formula = formulas[idx];
        
        // Populate measure page fields - color and code only (brand is user's choice)
        // document.getElementById('p-brand').value = formula.brand;  // User selects brand separately
        document.getElementById('p-color').value = formula.color;
        document.getElementById('p-code').value = formula.formula;
        
        closePaintFormulaModal();
        notify(`‚úì Selected: ${formula.color} - Code: ${formula.formula}`);
    }


    function autoSearchFormula() {
        const brand = document.getElementById('p-brand').value.trim();
        const color = document.getElementById('p-color').value.trim();
        
        if (!brand || !color) return;
        
        const formulas = getPaintFormulas();
        const match = formulas.find(f => 
            f.brand.toLowerCase() === brand.toLowerCase() && 
            f.color.toLowerCase() === color.toLowerCase()
        );
        
        if (match) {
            document.getElementById('p-code').value = match.formula;
            notify(`‚úì Formula: ${match.formula}`);
        } else {
            notify('Formula not found in database');
        }
    }

    function autoSearchFormulaOnType() {
        const brand = document.getElementById('p-brand').value.trim();
        const color = document.getElementById('p-color').value.trim();
        const code = document.getElementById('p-code').value.trim();
        
        // If code field already has text, don't override (user is typing manually)
        if (code && code.length > 0) return;
        
        if (!brand || !color) return;
        
        const formulas = getPaintFormulas();
        const match = formulas.find(f => 
            f.brand.toLowerCase() === brand.toLowerCase() && 
            f.color.toLowerCase() === color.toLowerCase()
        );
        
        if (match) {
            document.getElementById('p-code').value = match.formula;
        }
    }

    // ============ FIREBASE FUNCTIONS ============

    // Login function
    function handleLogin() {
        // Check if Firebase functions are actually available
        if (!window.firebaseAuth || !window.signInWithEmailAndPassword) {
            alert('Firebase not ready yet, please wait a moment and try again');
            return;
        }
        
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        if (!email || !password) {
            errorDiv.textContent = 'Please fill in all fields';
            errorDiv.style.display = 'block';
            return;
        }
        
        window.signInWithEmailAndPassword(email, password)
            .then(() => {
                errorDiv.style.display = 'none';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
            })
            .catch(error => {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            });
    }

    // Signup wrapper function  
    function trySignup() {
        
        if (!window.firebaseReady) {
            // Wait a moment and try again
            setTimeout(() => {
                if (window.firebaseReady) {
                    handleSignup();
                } else {
                    alert('Firebase is still loading. Please wait a moment and try again.');
                }
            }, 1000);
            return;
        }
        
        handleSignup();
    }

    // Signup function
    function handleSignup() {
        
        if (!window.firebaseAuth || !window.createUserWithEmailAndPassword) {
            alert('Firebase not ready yet, please wait a moment and try again');
            return;
        }
        
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        
        if (!email || !password) {
            errorDiv.textContent = 'Please fill in all fields';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (password.length < 6) {
            errorDiv.textContent = 'Password must be at least 6 characters';
            errorDiv.style.display = 'block';
            return;
        }
        
        window.createUserWithEmailAndPassword(email, password)
            .then(() => {
                errorDiv.style.display = 'none';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                notify('Account created! You are now logged in.');
            })
            .catch(error => {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            });
    }

    // Logout function
    function handleLogout() {
        if (confirm('Log out?')) {
            window.signOut();
        }
    }

    // Save job data to Firebase
    function saveJobToFirebase(jobData) {
        if (!window.currentUser) return;
        
        const jobId = jobData.id || Date.now().toString();
        const jobRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'jobs', jobId);
        window.setDoc(jobRef, {
            ...jobData,
            lastModified: new Date().toISOString(),
            userId: window.currentUser.uid
        }, { merge: true });
    }

    // Load all jobs from Firebase
    async function loadAllDataFromFirebase() {
        if (!window.currentUser) return;
        
        try {
            // Build reference to jobs subcollection properly
            const userDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid);
            const jobsCollectionRef = window.collection(userDocRef, 'jobs');
            const snapshot = await window.getDocs(jobsCollectionRef);
            const jobs = [];
            snapshot.forEach(doc => {
                jobs.push({ ...doc.data(), id: doc.id });
            });
            
            // Update localStorage with Firebase data (for compatibility)
            localStorage.setItem('jobHistory', JSON.stringify(jobs));
            fullHistory = jobs;
            history = jobs.filter(j => !j.completed);
            
            // Update UI - wrapped in try/catch
            try {
                if (typeof renderHistory === 'function') renderHistory();
            } catch (e) {
                console.warn('renderHistory error:', e);
            }
        } catch (err) {
            console.error('Error loading jobs from Firebase:', err);
        }
    }

    // Set up real-time listener for jobs
    function setupRealtimeSync() {
        // Guard: Only set up once
        if (window.realtimeSyncActive) {
            console.log('‚ö†Ô∏è Real-time sync already active, skipping duplicate setup');
            return;
        }
        
        if (!window.currentUser) {
            console.warn('setupRealtimeSync: No current user');
            return;
        }
        
        try {
            console.log('üîÑ Setting up real-time sync listener...');
            const userDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid);
            const jobsCollectionRef = window.collection(userDocRef, 'jobs');
            
            // Store the unsubscribe function so we can clean up later
            window.realtimeSyncUnsubscribe = window.onSnapshot(jobsCollectionRef, 
                snapshot => {
                    try {
                        const jobs = [];
                        snapshot.forEach(doc => {
                            jobs.push({ ...doc.data(), id: doc.id });
                        });
                        
                        // Only update if data actually changed
                        const currentHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
                        if (JSON.stringify(currentHistory) !== JSON.stringify(jobs)) {
                            localStorage.setItem('jobHistory', JSON.stringify(jobs));
                            
                            // Only re-render if on history tab to avoid excessive re-renders
                            const historySection = document.getElementById('history');
                            if (historySection && historySection.classList.contains('active')) {
                                renderHistory();
                            }
                        }
                    } catch (e) {
                        console.error('Error processing snapshot:', e);
                    }
                }, 
                error => {
                    console.error('Realtime sync error:', error);
                }
            );
            
            console.log('‚úì Real-time sync listener established');
        } catch (e) {
            console.error('setupRealtimeSync error:', e);
        }
    }

    // Track last synced data to avoid redundant syncs
    let lastSyncedData = '';
    let lastSyncTime = 0;
    const SYNC_DEBOUNCE_MS = 2000; // Minimum 2 seconds between syncs
    
    // Helper function to sync all jobs to Firebase
    function syncJobsToFirebase() {
        // Guard: Wait for Firebase to be ready and user to be logged in
        if (!window.firebaseReady || !window.currentUser || !window.firebaseDb || !window.doc || !window.setDoc) {
            console.warn('Firebase not ready or user not logged in. Sync delayed.');
            return;
        }
        
        // Rate limiting - prevent sync spam
        const now = Date.now();
        if (now - lastSyncTime < SYNC_DEBOUNCE_MS) {
            console.log('‚è±Ô∏è Sync rate limited (too soon)');
            return;
        }
        lastSyncTime = now;
        
        try {
            const jobHistory = JSON.parse(localStorage.getItem('jobHistory') || '[]');
            const currentData = JSON.stringify(jobHistory);
            
            // Only sync if data actually changed
            if (currentData === lastSyncedData) {
                console.log('‚ÑπÔ∏è Data unchanged, skipping Firebase sync');
                return;
            }
            
            lastSyncedData = currentData;
            
            jobHistory.forEach(job => {
                try {
                    const jobId = job.id || job.jobNum || Date.now().toString();
                    const jobDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'jobs', jobId);
                    window.setDoc(jobDoc, {
                        ...job,
                        id: jobId,
                        lastModified: new Date().toISOString(),
                        userId: window.currentUser.uid
                    }, { merge: true }).catch(err => console.error('Firestore sync error for job', jobId, ':', err));
                } catch(e) {
                    console.error('Error syncing individual job:', e);
                }
            });
            
            console.log('‚úì Firebase sync complete');
        } catch (error) {
            console.error('syncJobsToFirebase error:', error);
            // Don't crash the app, just log the error
        }
    }

    // Sync door profiles and price matrix to Firebase
    // This OVERWRITES the Firebase data with current local state
    function syncProfilesToFirebase() {
        if (!window.firebaseReady || !window.currentUser || !window.firebaseDb || !window.doc || !window.setDoc) {
            console.warn('Firebase not ready or user not logged in. Profile sync delayed.');
            return;
        }

        try {
            const configDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'config', 'doorProfiles');
            window.setDoc(configDoc, {
                doorProfiles: profiles,
                masterMatrix: masterMatrix,
                lastModified: new Date().toISOString(),
                userId: window.currentUser.uid,
                syncVersion: Date.now() // Force overwrite of old data
            }, { merge: false }).then(() => {
            }).catch(err => {
                console.error('‚ùå Error syncing door profiles to Firebase:', err);
            });
        } catch (error) {
            console.error('syncProfilesToFirebase error:', error);
        }
    }

    // Override localStorage.setItem to auto-sync to Firebase
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
        originalSetItem.call(this, key, value);
        
        // Whenever jobHistory is updated, sync to Firebase
        if (key === 'jobHistory' && window.currentUser) {
            // Retry sync if Firebase isn't quite ready yet
            if (!window.firebaseReady) {
                setTimeout(() => {
                    if (window.currentUser) syncJobsToFirebase();
                }, 500);
            } else {
                syncJobsToFirebase();
            }
        }
    };

    // Attach tab navigation event listeners (run immediately and on DOMContentLoaded for safety)
    function attachTabListeners() {
        document.querySelectorAll('[data-tab]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const tabName = this.getAttribute('data-tab');
                if (typeof tab === 'function') {
                    tab(tabName);
                }
            });
        });
    }
    
    // Try immediately
    setTimeout(attachTabListeners, 100);
    
    // Also attach on DOMContentLoaded in case script runs before DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        attachTabListeners();
        setTimeout(() => {
            populatePaintBrandsDropdown();
            // Only render the VISIBLE tab on page load (General Settings)
            // Other tabs will render when clicked
            setTimeout(() => {
                renderAdminAlerts();
                renderAdminGanttChart();
            }, 50);
        }, 100);
    });

    // Render paint formulas in database view
    
    function selectAndShowFormula(index) {
        selectedFormula = paintDatabase[index];
        displayPaintFormulaModal();
    }
    
    // Search formulas
    function searchFormulas() {
        const query = document.getElementById('formulaSearch').value.toLowerCase();
        
        if (!query) {
            renderPaintFormulaList(paintDatabase);
            return;
        }
        
        const filtered = paintDatabase.filter(f => 
            f.color.toLowerCase().includes(query) ||
            f.product.toLowerCase().includes(query) ||
            f.code.toLowerCase().includes(query)
        );
        
        renderPaintFormulaList(filtered);
    }

</script>

</div> <!-- Close appContainer -->
</body>
</html>

