<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                       PAINTWORKZ PRO 4.8                        ‚ïë
‚ïë                    REVISION TRACKING                            ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë 1.4.1 | 2026-02-14 | CREDIT NOTE added + Syntax error fixed + Defaults working            ‚ïë
‚ïë 1. ‚úì FIX: Client name edit syncs to all jobs referencing it REMOVED: Corrupted base64 logo (caused jsPDF failure)      ‚ïë
‚ïë 2. ‚úì FIX: Qty resets to 1 after add, cursor focuses on length REBUILT: 5 PDF functions (Estimate, Quote, Invoice, Mixing, Supply)            ‚ïë
‚ïë 3. ‚úì FIX: Color popup centered on screen, proper z-index ADDED: genPDF() main export function  ‚ïë
‚ïë 4. ‚úì ADD: Panel list filters (type/color/config/ss/ds/se) TESTED: All functions now functional ‚ïë 4. ‚úì ADD: Panel list filters (type/color/config/ss/ds/se) IMPROVED: Console logs non-critical errors error-safe        ‚ïë
‚ïë 5. ‚úì VERIFIED: Job auto-increment +manual override working VERIFIED: JavaScript syntax passes validation   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <title>PaintWorkz Pro 4.8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <style>
        :root {
            --gold: linear-gradient(145deg, #d4af37, #f9f1b0, #aa841e);
            --rainbow: linear-gradient(90deg, #ff3b30, #ff9500, #ffcc00, #4cd964, #5ac8fa, #007aff, #5856d6);
            --gs: #d4af37;
            --panel-clr: #34c759; --door-clr: #ff9500; --drawer-clr: #2196f3; --custom-clr: #af52de;
            --bg: #f2f2f7;
        }
        
        /* Scrollbar styling for Chrome/Safari */
        #clientsList::-webkit-scrollbar {
            width: 12px;
        }
        #clientsList::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 6px;
        }
        #clientsList::-webkit-scrollbar-thumb {
            background: #2196f3;
            border-radius: 6px;
        }
        #clientsList::-webkit-scrollbar-thumb:hover {
            background: #1976d2;
        }
        
        body { margin:0; font-family:-apple-system, system-ui, sans-serif; background:var(--bg); padding-bottom:140px; padding-top:0; -webkit-tap-highlight-color:transparent; }
        
        #globalNotificationsBanner { padding-top: env(safe-area-inset-top); }
        
        header { background:var(--rainbow); padding:env(safe-area-inset-top) 15px 5px; display:flex; align-items:center; justify-content:space-between; border-bottom:4px solid #aa841e; position:sticky; top:0; z-index:1000; height:80px; box-sizing: border-box; }
        .logo-box { background:#000; padding:6px 18px; border-radius:50px; border:2px solid var(--gs); }
        .logo-text { font-weight:900; font-size:20px; background:var(--gold); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .icon-btn { font-size: 28px; padding: 0 10px; cursor: pointer; }

        .nav-tabs { display: flex; background: #000; position: sticky; top: 80px; z-index: 999; overflow-x: auto; border-bottom: 1px solid #333; }
        .nav-btn { flex:1; min-width:80px; padding:12px 0; color:#888; text-align:center; font-weight:900; font-size:10px; text-transform:uppercase; border:none; background:0 0; cursor:pointer; transition:all 0.2s; pointer-events:auto; z-index:100; position:relative; }
        .nav-btn.active { color:#fff; border-bottom:4px solid var(--gs); background:#111; }

        .sub-nav { display: flex; gap: 5px; margin-bottom: 15px; background: #e5e5ea; padding: 4px; border-radius: 10px; }
        .sub-btn { flex: 1; padding: 8px; border: none; border-radius: 7px; font-weight: 800; font-size: 11px; color: #666; background: transparent; cursor:pointer; transition:all 0.2s; }
        .sub-btn.active { background: #fff; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .container { padding: 15px; max-width: 600px; margin: auto; }
        .view-section { display:none; } .view-section.active { display:block; }
        .card { background:#fff; border-radius:12px; padding:15px; margin-bottom:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position:relative; overflow:visible; }

        label { font-size: 10px; font-weight: 900; color: #666; text-transform: uppercase; margin-bottom: 2px; display: block; }
        input, select { width:100%; height:45px; border-radius:8px; border:1px solid #ccc; padding:0 10px; font-size:16px; box-sizing:border-box; background:#fff; margin-bottom: 8px; font-weight: 600; }
        
        .db-list { max-height: 400px; overflow-y: auto; background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; }
        .db-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; font-weight: 600; }
        .db-del { color: red; font-weight: 900; padding: 5px; cursor:pointer; }
        .add-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-small { background: #000; color: var(--gs); border: none; border-radius: 8px; font-weight: 900; width: 60px; height:45px; cursor:pointer; transition:all 0.2s; }
        .btn-small:hover { background: #222; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-card { background: #f2f2f7; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer; transition:all 0.2s; }
        .form-card:active { transform: scale(0.98); background: #e5e5ea; }
        .form-card h4 { margin: 0 0 5px; font-size: 14px; color: #333; }
        .form-card p { margin: 0; font-size: 10px; color: #888; font-weight: 600; }

        .bubble-row { display: flex; gap: 6px; margin: 8px 0; }
        .fm-row { display:flex; background:#eee; border-radius:8px; padding:4px; margin-bottom:10px; height: 50px; align-items: center; box-sizing: border-box; }
        .fm-opt { flex:1; text-align:center; height: 42px; line-height: 42px; font-weight:900; font-size:12px; border-radius:6px; color:#aaa; cursor:pointer; transition:all 0.2s; }
        .fm-opt.active { background:#fff; color:#000; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        
        .bubble-unit { flex: 1; background: #fff; border: 1px solid #ccc; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 50px; box-sizing: border-box; }
        .bubble-unit input { border: none; background: transparent; text-align: center; font-size: 18px; font-weight: 900; height: 25px; margin:0; padding:0; width: 100%; }

        #prof-select { height: 50px !important; margin: 0; }

        .p-card { flex:1; background:#fff; border:2px solid #ddd; border-radius:8px; padding:8px 2px; text-align:center; font-weight:900; font-size:9px; color:#444; display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; transition:all 0.2s; }
        .p-card.active { border-color:var(--gs); background:#fff9e6; color:#000; }
        .p-card svg { width:22px; height:22px; stroke: currentColor; fill:none; stroke-width:2; }

        .edge-row { display:flex; justify-content:space-between; align-items:center; margin:15px 0; gap:6px; }
        .edge-box { flex:1; height:45px; border-radius:8px; border:2px solid #ddd; background:#fff; display:flex; align-items:center; justify-content:center; font-weight:900; color:#ccc; font-size:14px; user-select:none; cursor:pointer; transition:all 0.2s; }
        .edge-box.active { background:#34c759; border-color:#28a745; color:#fff; }
        .edge-box.mode-sel.active { background:#333; border-color:var(--gs); color:var(--gs); }

        .cam-btn { font-size: 38px; cursor: pointer; padding: 0 10px; }
        .add-main-btn { width:100%; background:var(--gold); border:none; padding:20px; border-radius:40px; font-weight:900; font-size:20px; box-shadow:0 4px 15px rgba(212, 175, 55, 0.4); margin-top:10px; cursor:pointer; transition:all 0.2s; }
        .add-main-btn:active { transform: scale(0.98); }

        .part-label { display: flex; align-items: center; gap: 10px; padding: 10px; background: #fff; border-radius: 10px; margin-bottom: 8px; border: 1px solid #eee; position:relative; }
        .pl-qty { background: #000; color: var(--gs); min-width: 40px; height: 40px; border-radius: 8px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:16px; }
        .pl-center { flex:1; }
        .pl-dims { font-size: 18px; font-weight: 900;color: #000;line-height:1.1; }
        .edge-pill { display:inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 900; color: #fff; margin-right: 3px; }
        .pl-right { display: flex; flex-direction: column; align-items: center; min-width: 60px; border-left: 1px solid #eee; }
        .pl-mode { width: 35px; height: 35px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 12px; border: 2px solid; margin-bottom: 4px; }
        .del-btn { color: #ff3b30; font-size: 24px; border: none; background: none; cursor:pointer; transition:all 0.2s; }
        .del-btn:active { transform: scale(1.2); }

        .qty-controls { display:flex; flex-direction:column; align-items:center; gap:2px; min-width:45px; }
        .qty-btn { border:none; background:#eee; width:100%; border-radius:4px; font-weight:900; font-size:16px; cursor:pointer; transition:all 0.2s; padding:0; height:28px; }
        .qty-btn:active { background:#ddd; }

        .sticky-footer { background: #000; position: fixed; bottom: 0; left: 0; right: 0; height: 80px; border-top: 3px solid var(--gs); color: #fff; display: flex; justify-content: space-around; align-items: center; z-index: 2000; }
        .footer-item { text-align:center; }
        .footer-val { font-size:20px; font-weight:900; color:var(--gs); }
        .footer-label { font-size:9px; color:#aaa; }
        
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; padding: 12px 25px; border-radius: 30px; font-weight: 900; z-index: 3000; display: none; border: 1px solid var(--gs); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity:0; transform: translateX(-50%) translateY(20px); } to { opacity:1; transform: translateX(-50%) translateY(0); } }

        .pl-meta { font-size:10px; font-weight:700; color:#666; margin-top:2px; }

        /* COMPLETE JOB STAMP */
        .job-complete-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 24px;
            font-weight: 900;
            color: #34c759;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(52, 199, 89, 0.2);
            z-index: 50;
            border: 1.5px solid #34c759;
            padding: 2px 12px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.85);
            white-space: nowrap;
            line-height: 1;
        }
    </style>
</head>
<body>
    <!-- Firebase SDK - Modern Modular Approach -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCddhnoWoJczM2yXemz2evZc-W2x7OnP00",
            authDomain: "paintworkz-42bc0.firebaseapp.com",
            projectId: "paintworkz-42bc0",
            storageBucket: "paintworkz-42bc0.firebasestorage.app",
            messagingSenderId: "298786193879",
            appId: "1:298786193879:web:8fd63ca63c109f8cd14b92"
        };
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('‚úì Firebase initialized successfully');
        } catch(fbError) {
            console.log('‚ÑπÔ∏è Firebase note (non-critical):', fbError.message);
            // Firebase will still work with explicit config - this error is from hosting environment check
        }
        
        // Export to window for global access - with proper function wrappers
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        
        // Export Firestore functions as window methods
        window.doc = doc;
        window.setDoc = setDoc;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDoc = getDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.getDocs = getDocs;
        
        // Auth functions
        window.createUserWithEmailAndPassword = (email, password) => createUserWithEmailAndPassword(auth, email, password);
        window.signInWithEmailAndPassword = (email, password) => signInWithEmailAndPassword(auth, email, password);
        window.signOut = () => signOut(auth);
        
        window.currentUser = null;
        window.realtimeSyncActive = false; // Guard against multiple listeners
        window.realtimeSyncUnsubscribe = null; // Store unsubscribe function
        
        // Set up auth listener
        onAuthStateChanged(auth, user => {
            window.currentUser = user;
            if (user) {
                const loginScreen = document.getElementById('loginScreen');
                const appContainer = document.getElementById('appContainer');
                if (loginScreen) loginScreen.style.display = 'none';
                if (appContainer) appContainer.style.display = 'block';
                
                // Initialize app (clear form, populate clients)
                setTimeout(() => {
                    if (typeof initializeApp === 'function') {
                        try {
                            initializeApp();
                        } catch(e) {
                            console.error('initializeApp error:', e);
                        }
                    }
                }, 100);
                
                // Load jobs from Firebase ONLY after document is fully loaded
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        setTimeout(() => {
                            if (window.loadAllDataFromFirebase) {
                                try {
                                    window.loadAllDataFromFirebase();
                                } catch (e) {
                                    console.error('loadAllDataFromFirebase error:', e);
                                }
                            }
                        }, 500);
                    });
                } else {
                    // DOM already loaded
                    setTimeout(() => {
                        if (window.loadAllDataFromFirebase) {
                            try {
                                window.loadAllDataFromFirebase();
                            } catch (e) {
                                console.error('loadAllDataFromFirebase error:', e);
                            }
                        }
                    }, 500);
                }
                
                // Only set up real-time sync ONCE per session (DISABLED by default due to memory issues)
                if (!window.realtimeSyncActive) {
                    // Real-time sync disabled to prevent memory leaks
                    // Users should manually refresh to get latest data from Firebase
                    console.log('‚ÑπÔ∏è Real-time sync disabled (manual refresh recommended)');
                    window.realtimeSyncActive = true;
                }
            } else {
                // Clean up listener when logging out
                if (window.realtimeSyncUnsubscribe) {
                    try {
                        window.realtimeSyncUnsubscribe();
                    } catch (e) {
                        console.warn('Error unsubscribing:', e);
                    }
                    window.realtimeSyncUnsubscribe = null;
                }
                window.realtimeSyncActive = false;
                
                const loginScreen = document.getElementById('loginScreen');
                const appContainer = document.getElementById('appContainer');
                if (loginScreen) loginScreen.style.display = 'block';
                if (appContainer) appContainer.style.display = 'none';
            }
        });
        
        // Set firebaseReady LAST - only after everything is initialized
        window.firebaseReady = true;
    </script>
    <!-- USER INFO -->
    <div id="userInfo"></div>

<!-- TOAST NOTIFICATION -->
<div id="toast" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#34c759; color:#fff; padding:12px 25px; border-radius:25px; font-weight:900; z-index:5000; font-size:11px; box-shadow:0 4px 12px rgba(52, 199, 89, 0.3); animation: slideUp 0.4s ease-out, slideDown 0.4s ease-in 2.6s forwards; white-space:nowrap;"></div>

<style>
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(100px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes slideDown {
    from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    to {
        opacity: 0;
        transform: translateX(-50%) translateY(100px);
    }
}
</style>

<!-- TIMELINE EDITOR MODAL -->
<div id="timelineModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; flex-wrap:wrap;">
    <div style="background:#fff; padding:25px; border-radius:12px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); z-index:1001;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Edit Timeline</h3>
            <button onclick="closeTimelineModal()" style="border:none; background:none; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px;">‚úï</button>
        </div>
        
        <div id="timelineEditorContent"></div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="saveTimelineEdit()" style="flex:1; border:none; background:#34c759; color:#fff; padding:10px; border-radius:6px; font-weight:900; cursor:pointer;">SAVE</button>
            <button onclick="closeTimelineModal()" style="flex:1; border:none; background:#f0f0f0; color:#000; padding:10px; border-radius:6px; font-weight:900; cursor:pointer;">CANCEL</button>
        </div>
    </div>
</div>

<!-- PAINT FORMULA DATABASE MODAL -->
<!-- CALENDAR MODAL -->
<div id="calendarModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:5000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:16px; padding:20px; width:90%; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <button onclick="prevMonth()" style="border:none; background:#f0f0f0; width:40px; height:40px; border-radius:8px; font-weight:900; font-size:18px; cursor:pointer;" title="Previous month">‚Üê</button>
            <div style="text-align:center; flex:1;">
                <div id="monthYear" style="font-weight:900; font-size:16px; color:#000;"></div>
            </div>
            <button onclick="nextMonth()" style="border:none; background:#f0f0f0; width:40px; height:40px; border-radius:8px; font-weight:900; font-size:18px; cursor:pointer;" title="Next month">‚Üí</button>
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-bottom:15px;">
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">SU</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">MO</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">TU</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">WE</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">TH</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">FR</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">SA</div>
            <div id="calendarDays" style="grid-column:1/-1; display:grid; grid-template-columns:repeat(7,1fr); gap:4px;"></div>
        </div>
        
        <div style="display:flex; gap:8px;">
            <button onclick="closeCalendar()" style="flex:1; border:none; background:#f0f0f0; padding:12px; border-radius:8px; font-weight:900; cursor:pointer;">CANCEL</button>
            <button onclick="selectToday()" style="flex:1; border:none; background:var(--gs); padding:12px; border-radius:8px; font-weight:900; cursor:pointer;">TODAY</button>
        </div>
    </div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="position:fixed; top:0; left:0; right:0; bottom:0; background:linear-gradient(135deg, #d4af37, #f9f1b0); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
    <div style="background:#fff; border-radius:20px; padding:30px; width:100%; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="text-align:center; margin-bottom:30px;">
            <h1 style="margin:0; color:#d4af37; font-size:32px;">üé® PaintWorkz</h1>
            <p style="color:#666; margin:10px 0 0; font-size:14px;">Live Sync ‚Ä¢ All Devices</p>
        </div>
        
        <input type="email" id="loginEmail" placeholder="Email" style="margin-bottom:12px; padding:15px;">
        <input type="password" id="loginPassword" placeholder="Password" style="margin-bottom:20px; padding:15px;">
        
        <button onclick="handleLogin()" style="width:100%; background:#d4af37; border:none; padding:15px; border-radius:10px; font-weight:900; font-size:16px; cursor:pointer; margin-bottom:10px;">SIGN IN</button>
        <button onclick="trySignup()" style="width:100%; background:#333; color:#d4af37; border:2px solid #d4af37; padding:15px; border-radius:10px; font-weight:900; font-size:16px; cursor:pointer; font-size:14px;">CREATE ACCOUNT</button>
        
        <div id="loginError" style="color:red; font-weight:900; margin-top:15px; text-align:center; display:none;"></div>
    </div>
</div>

<!-- APP CONTAINER -->
<div id="appContainer" style="display:none;">

<header>
    <div class="icon-btn" onclick="tab('history')">üîç</div>
    <div class=\"logo-box\"><span class=\"logo-text\">PaintWorkz</span></div>
    <div style="display:flex; gap:10px; align-items:center;">
        <div id="goBackBtn" class="icon-btn" onclick="goBackJob()" style="display:none;" title="Exit without saving if no changes made">‚Üê Back</div>
        <div class="icon-btn" onclick="saveJob()">üíæ</div>
    </div>
</header>

<div class="nav-tabs">
    <div class="nav-btn active" id="btn-measure" data-tab="measure">Measure</div>
    <div class="nav-btn" id="btn-history" data-tab="history">History</div>
    <div class="nav-btn" id="btn-db" data-tab="db">Database</div>
    <div class="nav-btn" id="btn-forms" data-tab="forms">Forms</div>
    <div class="nav-btn" id="btn-schedule" data-tab="schedule">Schedule</div>
    <div class="nav-btn" id="btn-admin" data-tab="admin">Admin</div>
</div>

<div class="container">
    
    <div id="measure" class="view-section active">
        <div class="card">
            <div style="display:flex; gap:8px; margin-bottom: 8px;">
                <div style="flex:2">
                    <label>Client</label>
                    <select id="cli"></select>
                </div>
                <div style="flex:1">
                    <label>Date Received</label>
                    <input type="text" id="dRec" placeholder="DD/MM/YY" inputmode="numeric" style="text-align:center;" onclick="openCalendar()">
                </div>
            </div>

            <div style="display:flex; gap:8px; margin-bottom: 8px;">
                <div style="flex:2">
                    <label>Job Name / Reference</label>
                    <input type="text" id="jNm" placeholder="e.g. Smith Residence">
                </div>
                <div style="flex:1">
                    <label>Job #</label>
                    <input type="text" id="jN" placeholder="####" style="text-align:center;">
                </div>
            </div>

            <div style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee; margin-bottom:10px;">
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <div style="flex:1">
                        <label>Brand</label>
                        <select id="p-brand" style="height:35px; font-size:12px;">
                            <option>Wattyl</option>
                            <option>Dulux</option>
                            <option>Taubmans</option>
                            <option>Haymes</option>
                            <option>British Paints</option>
                            <option>Evic</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>Color Name</label>
                        <input type="text" id="p-color" placeholder="e.g. Lexicon" style="height:35px; font-size:12px;" oninput="openPaintFormulaSearch()">
                    </div>
                </div>
                <div style="display:flex; gap:8px;">
                    <div style="flex:1">
                        <label>Code / Formula</label>
                        <input type="text" id="p-code" placeholder="Formula (auto-search when typing)" style="height:35px; font-size:12px;" oninput="autoSearchFormulaOnType()">
                    </div>
                    <div style="flex:1">
                        <label>Finish</label>
                        <select id="p-finish" style="height:35px; font-size:12px;">
                            <option>Satin</option><option>Gloss</option><option>Matt</option><option>20% Gloss</option><option>30% Gloss</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <label>Part Type</label>
            <div class="bubble-row">
                <div id="pP" class="p-card active" onclick="setP('Panel')"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"></rect></svg>PANEL</div>
                <div id="pD" class="p-card" onclick="setP('Door')"><svg viewBox="0 0 24 24"><path d="M5 3h14v18H5V3zm10 9v1"></path></svg>DOOR</div>
                <div id="pDr" class="p-card" onclick="setP('Drawer')"><svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="6" rx="1"></rect><rect x="3" y="13" width="18" height="6" rx="1"></rect></svg>DRAWER</div>
                <div id="pC" class="p-card" onclick="setP('Custom')"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>CUSTOM</div>
            </div>

            <label>Description of Part</label>
            <input type="text" id="desc" placeholder="e.g. Pantry Door Left" style="text-transform: uppercase;">

            <div class="fm-row">
                <div id="fm-flat" class="fm-opt active" onclick="setFM('Flat')">FLAT</div>
                <div id="fm-mould" class="fm-opt" onclick="setFM('Moulded')">MOULDED</div>
            </div>

            <div class="bubble-row">
                <div class="bubble-unit" style="flex:0.8"><input type="number" id="thk" value="18" inputmode="decimal" oninput="up()"><div style="font-size:9px;color:#888;">THICK</div></div>
                <div style="flex:2"><select id="prof-select" oninput="up()"></select></div>
                <div class="bubble-unit" style="flex:0.8"><input type="number" id="qty" value="1" inputmode="numeric"><div style="font-size:9px;color:#888;">QTY</div></div>
            </div>

            <div class="bubble-row">
                <input type="number" id="h" placeholder="Length" inputmode="decimal" oninput="up()" style="height:55px; font-size:22px; text-align:center;">
                <input type="number" id="w" placeholder="Width" inputmode="decimal" oninput="up()" style="height:55px; font-size:22px; text-align:center;">
            </div>

            <label>Paint Mode</label>
            <div class="edge-row" style="margin-top:5px;">
                <div id="mSS" class="edge-box mode-sel active" onclick="setM('SS')">SS</div>
                <div id="mDS" class="edge-box mode-sel" onclick="setM('DS')">DS</div>
                <div id="mSE" class="edge-box mode-sel" onclick="setM('SE')">SE</div>
            </div>

            <label>Edge Treatment</label>
            <div class="edge-row">
                <div class="edge-box" id="E1" onclick="tE(this)">L</div>
                <div class="edge-box" id="E2" onclick="tE(this)">L</div>
                <div class="cam-btn" onclick="snap()">üì∏</div>
                <div class="edge-box" id="E3" onclick="tE(this)">S</div>
                <div class="edge-box" id="E4" onclick="tE(this)">S</div>
            </div>

            <div style="display: flex; flex-direction: column; align-items: center; padding: 15px 0; border-top: 1px solid #eee;">
                <div id="liveSq" style="font-size: 50px; font-weight: 900; color: var(--gs); line-height: 1;">0.000</div>
                <div style="font-size: 10px; font-weight: 900; color: #aaa;">CURRENT PART SQM (m¬≤)</div>
            </div>

            <button class="add-main-btn" onclick="addPart()">ADD PART +</button>
        </div>
        
        <!-- FILTER BAR FOR PANEL LIST -->
        <div id="panelFilterBar" style="padding:12px 10px; background:#f9f9f9; border-bottom:1px solid #ddd; display:flex; gap:6px; flex-wrap:wrap; font-size:10px;">
            <button class="filter-btn active" onclick="filterPanels('all')" data-bg="#d4af37" data-color="#000" style="padding:6px 14px; border:none; background:#d4af37; color:#000; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 2px 4px rgba(0,0,0,0.1); transition:all 0.2s;">ALL</button>
            <button class="filter-btn" onclick="filterPanels('panel')" data-bg="#e8f4f8" data-color="#0288d1" style="padding:6px 14px; border:none; background:#e8f4f8; color:#0288d1; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">PANEL</button>
            <button class="filter-btn" onclick="filterPanels('door')" data-bg="#f3e5f5" data-color="#7b1fa2" style="padding:6px 14px; border:none; background:#f3e5f5; color:#7b1fa2; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">DOOR</button>
            <button class="filter-btn" onclick="filterPanels('drawer')" data-bg="#e3f2fd" data-color="#1565c0" style="padding:6px 14px; border:none; background:#e3f2fd; color:#1565c0; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">DRAWER</button>
            <button class="filter-btn" onclick="filterPanels('custom')" data-bg="#fce4ec" data-color="#c2185b" style="padding:6px 14px; border:none; background:#fce4ec; color:#c2185b; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">CUSTOM</button>
            <button class="filter-btn" onclick="filterPanels('moulded')" data-bg="#fff3e0" data-color="#e65100" style="padding:6px 14px; border:none; background:#fff3e0; color:#e65100; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">MOULDED</button>
            <button class="filter-btn" onclick="filterPanels('flat')" data-bg="#f1f8e9" data-color="#558b2f" style="padding:6px 14px; border:none; background:#f1f8e9; color:#558b2f; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">FLAT</button>
            <button class="filter-btn" onclick="filterPanels('ss')" data-bg="#e0f2f1" data-color="#00695c" style="padding:6px 14px; border:none; background:#e0f2f1; color:#00695c; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">S/S</button>
            <button class="filter-btn" onclick="filterPanels('ds')" data-bg="#ede7f6" data-color="#4527a0" style="padding:6px 14px; border:none; background:#ede7f6; color:#4527a0; border-radius:20px; cursor:pointer; font-weight:900; box-shadow:0 1px 3px rgba(0,0,0,0.08); transition:all 0.2s;">D/S</button>
            <button class="filter-btn" onclick="filterPanels('se')" style="padding:6px 12px; border:1px solid #ddd; background:#fff; border-radius:4px; cursor:pointer; font-weight:900;">S/E</button>
        </div>
        
        <div id="list"></div>
    </div>

    <!-- Paint Formula Popup Modal -->
    <div id="paintFormulaModal" style="display:none !important; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;" onclick="if(event.target.id==='paintFormulaModal') closePaintFormulaModal();">
        <div style="position:relative; background:#fff; border-radius:12px; padding:20px; max-width:500px; width:90vw; max-height:80vh; overflow-y:auto; box-shadow:0 8px 32px rgba(0,0,0,0.3); z-index:10000;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:2px solid #eee;">
                <h3 style="margin:0; font-size:13px; font-weight:900;" id="formulaTitle">Paint Formula</h3>
                <button onclick="closePaintFormulaModal()" style="background:none; border:none; font-size:20px; cursor:pointer; padding:0; width:24px; height:24px; line-height:1;">√ó</button>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;">
                <div>
                    <div style="font-size:9px; font-weight:900; color:#666; margin-bottom:3px;">COLOUR</div>
                    <div id="formulaColor" style="font-size:12px; font-weight:900;">-</div>
                </div>
                <div>
                    <div style="font-size:9px; font-weight:900; color:#666; margin-bottom:3px;">CODE</div>
                    <div id="formulaCode" style="font-size:12px; font-weight:900;">-</div>
                </div>
            </div>
            
            <div style="background:#f0f0f0; padding:8px; border-radius:4px; margin-bottom:10px;">
                <label style="font-size:9px; font-weight:900; display:block; margin-bottom:4px;">Litres to Mix</label>
                <input type="number" id="mixLitres" value="1" min="0.1" step="0.1" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:3px; font-size:12px; box-sizing:border-box; font-weight:900;" oninput="updateFormulaScaling()">
            </div>
            
            <div id="scaledFormula" style="background:#fafafa; padding:10px; border-radius:4px; margin-bottom:12px; font-size:10px; max-height:220px; overflow-y:auto; line-height:1.8;">
                <!-- Scaled formula will appear here -->
            </div>
            
            <div style="display:flex; gap:8px;">
                <button onclick="savePaintFormulaToJob()" style="flex:1; background:#34c759; color:#fff; border:none; padding:10px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer;">‚úì Save</button>
                <button onclick="closePaintFormulaModal()" style="flex:1; background:#e0e0e0; color:#333; border:none; padding:10px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="db" class="view-section">
        <div class="sub-nav">
            <button class="sub-btn active" id="sub-btn-clients" onclick="subTab('clients')">CLIENTS</button>
            <button class="sub-btn" id="sub-btn-profiles" onclick="subTab('profiles')">DOOR PROFILES</button>
            <button class="sub-btn" id="sub-btn-paint" onclick="subTab('paint')">PAINT</button>
        </div>

        <div id="sub-clients" class="sub-section active">
            <div class="card">
                <div class="add-row">
                    <input type="text" id="new-client" placeholder="New Client Name" style="margin-bottom:0;">
                    <button class="btn-small" onclick="addClient()">ADD</button>
                </div>
                <div class="db-list" id="list-clients"></div>
            </div>
        </div>

        <div id="sub-profiles" class="sub-section" style="display:none;">
            <div class="card">
                <h4 style="margin-bottom:15px; font-weight:900;">Door Profiles</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Add new profiles or edit existing names. Profiles are used in your pricing matrix tiers.</p>
                
                
                <div class="add-row">
                    <input type="text" id="new-profile" placeholder="New Profile Name (e.g., Shaker, Ashlee)" style="margin-bottom:0;">
                    <button class="btn-small" onclick="addProfile()">ADD</button>
                </div>
                <div class="db-list" id="list-profiles" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="sub-paint" class="sub-section" style="display:none;">
            <div class="card">
                <h4 style="margin-bottom:15px; font-weight:900;">Paint Formula Database</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Manage your paint formulas. When you type a colour in the Measure tab, matching formulas will appear automatically.</p>
                
                <div style="margin-bottom:20px;">
                    <h5 style="margin-bottom:10px; font-weight:900; font-size:12px;">Add New Formula</h5>
                    <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #ddd;">
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="text" id="newPaintColor" placeholder="Colour Name (e.g., Lexicon)" style="flex:1.5; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:12px;">
                            <input type="text" id="newPaintCode" placeholder="Code (e.g., XTSW1E3)" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box; font-size:12px;">
                        </div>
                        <input type="text" id="newPaintProduct" placeholder="Product (e.g., 690 30% XTint Poly)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px; box-sizing:border-box; font-size:12px;">
                        
                        <!-- 1L Base Section -->
                        <div style="background:#fff; padding:10px; border-radius:6px; border:1px solid #eee; margin-bottom:10px;">
                            <div style="font-size:10px; font-weight:900; margin-bottom:8px; color:#666;">1L BASE (code @ grams)</div>
                            <div style="display:flex; gap:8px;">
                                <input type="text" id="baseCode" placeholder="Base Code" style="flex:0.6; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                                <input type="number" id="baseAmount" placeholder="grams" step="0.01" style="flex:0.4; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; box-sizing:border-box;">
                            </div>
                        </div>
                        
                        <!-- Tinters Section -->
                        <div style="background:#fff; padding:10px; border-radius:6px; border:1px solid #eee; margin-bottom:10px;">
                            <div style="font-size:10px; font-weight:900; margin-bottom:8px; color:#666;">TINTERS (each line: code @ grams)</div>
                            <textarea id="tintersList" placeholder="ITE303 @ 5.88&#10;ITE306 @ 5.95&#10;ITE310 @ 5.75" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; min-height:60px; box-sizing:border-box; font-family:monospace;"></textarea>
                            <div style="font-size:9px; color:#999; margin-top:5px;">One tinter per line. Format: CODE @ GRAMS</div>
                        </div>
                        
                        <button onclick="addNewPaintFormulaUI()" style="width:100%; padding:10px; background:#34c759; color:#fff; border:none; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">+ ADD FORMULA</button>
                    </div>
                </div>
                
                <div>
                    <h5 style="margin-bottom:10px; font-weight:900; font-size:12px;">Existing Formulas (${paintDatabase.length})</h5>
                    <div id="paintFormulaList" style="background:#fff; border:1px solid #ddd; border-radius:8px; overflow:hidden; max-height:400px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="forms" class="view-section">
        <div class="card">
            <h3>Generate Form</h3>
            <div class="form-grid">
                <div class="form-card" onclick="genForm('Estimate')"><h4>Estimate</h4><p>Job breakdown only</p></div>
                <div class="form-card" onclick="genForm('Supply Docket')"><h4>Supply Docket</h4><p>Part list for client</p></div>
                <div class="form-card" onclick="genForm('Mixing Card')"><h4>Mixing Card</h4><p>Paint shop formula</p></div>
                <div class="form-card" onclick="genForm('Invoice')"><h4>Invoice</h4><p>Dynamic length billing</p></div>
                <div class="form-card" onclick="genForm('Quote Form')"><h4>Quote Form</h4><p>Raw vs Paint pricing</p></div>
                <div class="form-card" onclick="printA3Schedule()" style="background:#e8f5e9; border-color:#4caf50;"><h4>üìÖ A3 Schedule</h4><p>90-day continuous view</p></div>
            </div>
        </div>
    </div>

    <div id="history" class="view-section">
        <div class="card">
            <h3>Job History</h3>
            <p style="color:#666; font-size:12px; margin-bottom:15px;">Save your current job using the üíæ button above to add it to history</p>
            
            <!-- Filter Buttons -->
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px;">
                <button onclick="filterHistory('all')" id="filter-all" style="background:#d4af37; color:#000; border:none; padding:8px 14px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">ALL</button>
                <button onclick="filterHistory('active')" id="filter-active" style="background:#f0f0f0; color:#666; border:none; padding:8px 14px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">ACTIVE</button>
                <button onclick="filterHistory('completed')" id="filter-completed" style="background:#f0f0f0; color:#666; border:none; padding:8px 14px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">COMPLETED</button>
            </div>
        </div>
        <div id="history-list"></div>
    </div>
    
    <div id="schedule" class="view-section" style="width:100vw; margin-left:calc(-50vw + 50%); position:relative;">
    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:#fff; border-radius:12px; width:90%; max-width:900px; height:90%; display:flex; flex-direction:column; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid #eee; background:#f9f9f9; border-radius:12px 12px 0 0;">
                <h3 id="pdfPreviewTitle" style="margin:0; color:#333;">PDF Preview</h3>
                <button onclick="closePDFPreview()" style="border:none; background:none; font-size:24px; cursor:pointer; color:#999;">‚úï</button>
            </div>
            
            <!-- Preview Container -->
            <div id="pdfPreviewContainer" style="flex:1; overflow:auto; padding:20px; background:#f5f5f5; display:flex; justify-content:center; align-items:flex-start;">
                <iframe id="pdfPreviewIframe" style="width:100%; height:100%; border:none; background:#fff; border-radius:8px;"></iframe>
            </div>
            
            <!-- Footer Buttons -->
            <div style="display:flex; gap:10px; padding:20px; border-top:1px solid #eee; background:#f9f9f9; border-radius:0 0 12px 12px;">
                <button onclick="closePDFPreview()" style="flex:1; border:none; background:#f0f0f0; color:#333; padding:12px; border-radius:8px; font-weight:900; cursor:pointer; font-size:14px;">CANCEL</button>
                <button id="downloadPDFBtn" onclick="downloadCurrentPDF()" style="flex:1; border:none; background:#d4af37; color:#000; padding:12px; border-radius:8px; font-weight:900; cursor:pointer; font-size:14px;">‚úì DOWNLOAD PDF</button>
            </div>
        </div>
    </div>

        <!-- Global Notifications -->
        <div class="card" style="background:#f0fdf4; border-left:5px solid #34c759; margin-left:0; margin-right:0;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:#34c759;">üîî Global Notifications</h3>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="notificationBadge" style="background:#ff3b30; color:#fff; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:12px;">0</span>
                    <button onclick="toggleNotifications()" style="border:none; background:#34c759; color:#fff; padding:6px 12px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚àí</button>
                </div>
            </div>
            <div id="globalNotifications" style="max-height:200px; overflow-y:auto; display:block;">
                <p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p>
            </div>
        </div>

        <div class="card" style="margin-left:0; margin-right:0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Jobs Chart</h3>
                <div style="display:flex; gap:8px;">
                    <button onclick="prevScheduleMonth()" style="border:none; background:#f0f0f0; width:35px; height:35px; border-radius:6px; font-weight:900; cursor:pointer;">‚Üê</button>
                    <button onclick="nextScheduleMonth()" style="border:none; background:#f0f0f0; width:35px; height:35px; border-radius:6px; font-weight:900; cursor:pointer;">‚Üí</button>
                    <button id="jobsChartToggleBtn" onclick="toggleJobsChart()" title="Minimize/Maximize" style="border:none; background:#2196f3; color:#fff; width:35px; height:35px; border-radius:6px; font-weight:900; cursor:pointer; font-size:18px;">‚àí</button>
                </div>
            </div>
            <div id="scheduleMonthYear" style="text-align:center; font-weight:900; font-size:16px; margin-bottom:15px; color:#000;"></div>
        </div>

        <!-- Jobs Chart Timeline - Full Width -->
        <div id="ganttWrapper" style="width:100vw; margin-left:calc(-50vw + 50%); background:#fff; padding:15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow-x:auto; overflow-y:hidden; min-height:600px; display:block; visibility:visible; scroll-behavior:smooth; cursor:grab;">
            <!-- Jobs Chart Container -->
            <div id="ganttChart" style="min-width:1200px; padding:0; display:flex; flex-direction:column; user-select:none;">
                <!-- Jobs chart will render here -->
            </div>
        </div>
        <div style="text-align:center; font-size:11px; color:#999; margin-top:8px;">‚Üê Scroll horizontally to view different months ‚Üí</div>

    </div>
    
    <div id="admin" class="view-section">
        <h3 style="margin-bottom:10px;">Admin Settings</h3>
        
        <!-- Admin Sub-Tabs - Under Header -->
        <div class="sub-nav" style="margin-bottom:15px;">
            <button class="sub-btn active" onclick="switchAdminTab('general')" id="admin-tab-general">General Settings</button>
            <button class="sub-btn" onclick="switchAdminTab('colours')" id="admin-tab-colours">Colours</button>
            <button class="sub-btn" onclick="switchAdminTab('clients')" id="admin-tab-clients">Clients</button>
            <button class="sub-btn" onclick="switchAdminTab('pricing')" id="admin-tab-pricing">Price Matrix</button>
        </div>
        
        <div class="card">
            <!-- General Settings Tab -->
            <div id="admin-tab-general-content">
                <div style="background:linear-gradient(135deg, #f0f0f0 0%, #fff 100%); border-left:5px solid #d4af37; padding:15px; border-radius:8px; margin-bottom:20px;">
                    <p style="margin:0; font-size:12px; color:#333; line-height:1.6; font-weight:700;">
                        <strong>üé® PAINTWORKZ PRO</strong><br>
                        Created by Colin Bedford<br>
                        Paintworkz PTY LTD<br>
                        <span style="color:#666; font-size:11px;">Date: 14/02/2026</span><br>
                        <span style="color:#d4af37; font-weight:900; font-size:11px;">Current Version: <span id="versionDisplay">v1.4.1</span></span>
                    </p>
                </div>
                
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Measure Tab Defaults</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Set default values for new parts in the Measure tab</p>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Default Material Thickness (mm)</label>
                        <input type="number" id="defaultThickness" value="18" min="1" max="50" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="display:block; font-weight:900; font-size:11px; color:#666; margin-bottom:5px;">Default SE Return Value (mm)</label>
                        <input type="number" id="defaultSEReturn" value="100" min="10" max="500" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:12px; box-sizing:border-box;">
                    </div>
                </div>
                <button onclick="saveDefaultSettings()" style="border:none; background:#34c759; color:#fff; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚úì SAVE DEFAULTS</button>
                
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Default Timeline Settings</h4>
                <p style="font-size:11px; color:#666; margin-bottom:10px;">Edit the default timeline phases for all new jobs</p>
                <button onclick="editDefaultTimeline()" style="border:none; background:#2196f3; color:#fff; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚öôÔ∏è EDIT DEFAULT TIMELINE</button>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; margin-bottom:10px;">
                    <h4 style="margin:0; font-weight:900;">Notification Archive</h4>
                    <button onclick="toggleAdminAlerts()" style="background:none; border:none; cursor:pointer; font-weight:900; font-size:18px; color:#999;">‚àí</button>
                </div>
                <div id="admin-alerts-container" style="display:block;">
                    <div id="admin-alerts"></div>
                </div>
                
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Database Status</h4>
                <p style="font-size:11px; color:#666; margin-bottom:10px; background:#f0f0f0; padding:10px; border-radius:6px;">All systems operational. Job history is clean and synced.</p>
                
                <hr style="margin:30px 0; border:none; border-top:1px solid #ddd;">
                
                <div style="background:#f5f5f5; border-left:4px solid #d4af37; padding:15px; border-radius:6px; margin-top:20px;">
                    <p style="font-size:10px; color:#666; margin:0; line-height:1.6;">
                        <strong style="color:#333; font-weight:900;">PaintWorkz Pro</strong><br>
                        <span style="color:#999;">Created by Colin Bedford</span><br>
                        <span style="color:#999;">Paintworkz PTY LTD</span><br>
                        <span style="color:#999;">14 February 2026</span><br><br>
                        <span id="versionDisplay" style="color:#d4af37; font-weight:900;">Current Version: v1.4.1</span>
                    </p>
                </div>
            </div>
            
            <!-- Colours Tab -->
            <div id="admin-tab-colours-content" style="display:none;">
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Theme Colours</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Customize colours throughout the app</p>
                <div id="colorCustomizerContent" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
            </div>
            
            <!-- Clients Database Tab -->
            <div id="admin-tab-clients-content" style="display:none;">
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Client Database</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Scroll to see all clients or search by name</p>
                <button onclick="showAddClientForm()" style="border:none; background:#34c759; color:#fff; padding:12px 20px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer; width:100%; margin-bottom:15px;">‚ûï ADD NEW CLIENT</button>
                
                <!-- Search box -->
                <input type="text" id="clientSearchBox" placeholder="üîç Search clients..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; font-size:13px; box-sizing:border-box; margin-bottom:15px;" onkeyup="filterClientList()">
                
                <!-- Scrollable client list container with visible scrollbar -->
                <div style="border:1px solid #ddd; border-radius:8px; background:#fff; padding:0;">
                    <div id="clientsList" style="height:500px; overflow-y:scroll; display:flex; flex-direction:column; gap:0; padding:10px; scrollbar-width:thin; scrollbar-color:#2196f3 #f0f0f0;"></div>
                </div>
            </div>
            
            <!-- Price Matrix Tab -->
            <div id="admin-tab-pricing-content" style="display:none;">
                <div id="admin-pricing-matrix" style="margin-top:15px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- WORKLOAD SUMMARY CONTAINER - Shows only in Schedule/Admin -->
<div id="workloadSummaryContainer" style="display:none; background:#f9f9f9; border-top:1px solid #ddd; padding:12px 15px; position:fixed; bottom:60px; left:0; right:0; z-index:100;">
    <div class="card" style="margin:0; background:transparent;">
        <h4 style="margin-top:0; margin-bottom:8px; font-size:12px;">Workload Summary</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
            <div style="text-align:center; padding:8px;">
                <div id="totalActiveJobs" style="font-size:18px; font-weight:900; color:var(--gs);">0</div>
                <div style="font-size:9px; color:#666; font-weight:700;">Active Jobs</div>
            </div>
            <div style="text-align:center; padding:8px; border-left:1px solid #ddd; border-right:1px solid #ddd;">
                <div id="totalTasks" style="font-size:18px; font-weight:900; color:#ff9500;">0/0</div>
                <div style="font-size:9px; color:#666; font-weight:700;">Tasks Complete</div>
            </div>
            <div style="text-align:center; padding:8px;">
                <div id="totalWorkload" style="font-size:18px; font-weight:900; color:#2196f3;">0</div>
                <div style="font-size:9px; color:#666; font-weight:700;">SQM Workload</div>
            </div>
        </div>
    </div>
</div>

    <!-- Global Notifications Banner - Visible on all tabs -->
    <div id="globalNotificationsBanner" style="position:fixed; top:0; left:0; right:0; z-index:9999; background:linear-gradient(90deg, #fffef0 0%, #fffff8 100%); border-bottom:4px solid #ffc107; padding:16px; padding-top:20px; min-height:60px; max-height:250px; overflow-y:auto; display:none; box-shadow:0 4px 12px rgba(255, 193, 7, 0.3);">
        <div id="globalNotificationsList" style="margin:0;"></div>
    </div>
    
<div class="sticky-footer">
    <div class="footer-item" style="margin-left:15px;"><div class="footer-label">TOTAL SQM (m¬≤)</div><div class="footer-val" id="tA">0.000</div></div>
    <div style="flex:1; display:flex; justify-content:center; gap:20px; align-items:center;">
        <div class="icon-btn" onclick="genPDF()" style="color:#fff">üìÑ</div>
        <div id="footerVersionDisplay" style="display:none; font-size:10px; color:#d4af37; font-weight:900;">PaintWorkz Pro v1.4.1</div>
    </div>
    <div class="footer-item"><div class="footer-label">PARTS</div><div class="footer-val" id="tQ">0</div></div>
    <div class="icon-btn" onclick="handleLogout()" title="Logout" style="color:#ff3b30; font-size:24px; cursor:pointer; margin-right:15px;">üö™</div>
</div>

<script>
    // ===== PAINTWORKZ REVISION INFO =====
    console.log('%c üé® PaintWorkz Pro 4.8 1.1.6 (2026-02-12) ', 'background:#d4af37;color:#000;font-weight:900;padding:8px;border-radius:4px;');
    console.log('‚úÖ CRITICAL FIXES:');
    console.log('‚úì Disabled Firebase real-time sync (memory crashes fixed)');
    console.log('‚úì Improved error handling to prevent crashes');
    console.log('‚úì Door profile persistence fixed');
    console.log('‚úì Job completion toggle working');
    console.log('‚úì Measure sheet clears on save');
    console.log('‚úì Workload summary correctly excludes completed');
    // ====================================
    
    // Firebase already initialized at top of page
    let isSignup = false;

    // Wait for Firebase to be initialized before using it
    function waitForFirebase() {
        if (typeof auth !== 'undefined' && auth !== null) {
            // Firebase is ready, set up auth listener
            window.onAuthStateChanged((user) => {
              if (user) {
                window.currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('userInfo').innerHTML = `
                  <span style="font-weight:900;">üë§ ${user.email.split('@')[0]}</span>
                  <button id="logoutBtn" onclick="logout()" style="background:#ff3b30; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-weight:900; margin-left:10px;">Logout</button>
                `;
                loadDataFromFirestore();
              } else {
                window.currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('userInfo').innerHTML = '';
              }
            });
        } else {
            // Firebase not ready yet, try again
            setTimeout(waitForFirebase, 100);
        }
    }
    
    // Start waiting for Firebase
    waitForFirebase();

    // Login/Signup Handler
    function handleAuth() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');
      
      if (!email || !password) {
        errorDiv.innerHTML = '‚ö†Ô∏è Please enter email and password';
        return;
      }
      
      if (isSignup) {
        window.createUserWithEmailAndPassword(email, password)
          .then(result => {
            errorDiv.innerHTML = '‚úÖ Account created! Logging in...';
            setTimeout(() => {
              document.getElementById('loginEmail').value = '';
              document.getElementById('loginPassword').value = '';
            }, 1000);
          })
          .catch(error => {
            errorDiv.innerHTML = '‚ùå ' + error.message;
          });
      } else {
        window.signInWithEmailAndPassword(email, password)
          .then(result => {
            errorDiv.innerHTML = '‚úÖ Logged in successfully!';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
          })
          .catch(error => {
            errorDiv.innerHTML = '‚ùå ' + error.message;
          });
      }
    }

    function toggleSignup() {
      isSignup = !isSignup;
      document.getElementById('loginTitle').innerHTML = isSignup ? 'Create Account' : 'PaintWorkz Login';
      document.getElementById('loginBtn').innerHTML = isSignup ? 'Sign Up' : 'Login';
      document.getElementById('toggleBtn').innerHTML = isSignup ? 'Have an account? Login' : "Don't have an account? Sign Up";
      document.getElementById('loginError').innerHTML = '';
    }

    function logout() {
      window.signOut().then(() => {
      });
    }

    // Save data to Firestore
    async function saveDataToFirestore() {
      if (!window.currentUser) {
        return;
      }
      
      try {
        const data = {
          items: items,
          client: document.getElementById('cli')?.value || '',
          dateReceived: document.getElementById('dRec')?.value || '',
          totalSqm: document.getElementById('sqm')?.value || '',
          doorProfiles: doorProfiles,
          paintData: paintData,
          lastSaved: new Date().toISOString()
        };
        
        const measureDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'data', 'measureData');
        await window.setDoc(measureDocRef, data);
        
        const historyDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'history', 'jobs');
        await window.setDoc(historyDocRef, {
          history: history,
          lastUpdated: new Date().toISOString()
        });
        
      } catch (error) {
      }
    }

    // Load data from Firestore
    async function loadDataFromFirestore() {
      if (!window.currentUser) return;
      
      try {
        // Load measure data
        const measureDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'data', 'measureData');
        const measureDoc = await window.getDoc(measureDocRef);
        if (measureDoc.exists()) {
          const data = measureDoc.data();
          items = data.items || [];
          doorProfiles = data.doorProfiles || [];
          paintData = data.paintData || [];
          if (document.getElementById('cli')) document.getElementById('cli').value = data.client || '';
          if (document.getElementById('dRec')) document.getElementById('dRec').value = data.dateReceived || '';
          if (document.getElementById('sqm')) document.getElementById('sqm').value = data.totalSqm || '';
        }
        
        // Load job history
        const historyDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'history', 'jobs');
        const historyDoc = await window.getDoc(historyDocRef);
        if (historyDoc.exists()) {
          history = historyDoc.data().history || [];
        }
        
        // NOTE: Door profiles are NOT loaded from Firebase
        // They are ONLY loaded from localStorage to prevent stale data
        // Firebase is used for backup/sync only, not for restoration
        
        refreshLists();
        renderHistory();
        renderScheduleCalendar();
        initializeDefaultSettings();  // Load default thickness and SE return values
      } catch (error) {
      }
    }

    // ==================== END FIREBASE SETUP ====================
    let items = [], mode = 'SS', pType = 'Panel', fmState = 'Flat', currentPanelFilter = 'all';
    
    // RESTORED MASTER LISTS
    let clients = ["ABM", "Absolute Kitchens", "Advanced Cabinetry", "AKC Kitchens", "Braw Creative", "Brian Moloney", "Cabinets & Stone", "Cabinets by Michael", "Chooka", "CKK", "Clover Doors", "Complete Style Joinery", "Concept 2 Reality", "Coronet Kitchens", "Create a Kitchen", "Creative Cabinetry", "Cutting Edge Joinery", "Driscolls Joinery", "Evolution Kitchens and Joinery", "Geoff Frost Builders", "GM Cabinets", "Grampians Joinery", "Grovedale Kitchens", "Gunning Concepts", "Hamilton Sheetmetal", "Harris Cabinets", "Howe Kitchens & Joinery", "Hy-Craft", "Jardines Cabinets", "Joinery by Jarrod", "Jonassons", "Kingston Kabinets", "Kitchens U Build", "Kyle Hendy", "Leighton Park", "Matthews Joinery", "Ocean Grove Joinery", "Onshore", "R J Walter", "Richardson Joinery", "Schier Cabinet Makers", "Snaauws Kitchens", "SRT Cabinetry", "Stawell Joinery", "Stephensons Kitchens", "T&J Kitchens", "Tony Lambert Kitchens", "Total Kitchen Solutions", "Trendset Kitchens", "Troy Turner", "Ultrabuild", "VG Cabinets", "VJS Geelong", "VJS Shepparton", "Walk in Client", "Westend Cabinetry"];
    // Default door profiles
    const DEFAULT_PROFILES = ["Plain (101)", "J-Mould (102)", "Sharknose (103)", "Bevelled Edge (104)", "Ashlee (201)", "Hamilton (202)", "Vertical Grooves (203)", "Tarrone (301)", "Bobby (302)", "Orford (303)", "Shaker (401)", "Shaker 45 (402)", "Shaker w/Lines (403)", "Jack (404)", "Georgia (501)", "Branxholme (502)", "Rosebrook (503)", "Benchtop", "Molding", "Custom"];
    
    let profiles = (function() {
        // Load from localStorage if available
        const saved = localStorage.getItem('doorProfiles');
        console.log('üìÇ Loading profiles from localStorage...');
        if (saved) {
            try {
                const loaded = JSON.parse(saved);
                console.log(`  Found ${loaded.length} profiles in localStorage:`, loaded);
                
                // CRITICAL FIX: If profiles list is significantly shorter than defaults, it's outdated
                // (Users may have previously deleted or lost profiles accidentally)
                const expectedCount = DEFAULT_PROFILES.length;
                if (Array.isArray(loaded) && loaded.length > 0 && loaded.length < expectedCount * 0.7) {
                    console.warn(`‚ö†Ô∏è INCOMPLETE PROFILE LIST DETECTED (${loaded.length}/${expectedCount})`);
                    console.warn('   Restoring full default profile list...');
                    localStorage.removeItem('doorProfiles');
                    // Fall through to use defaults below
                } else if (Array.isArray(loaded) && loaded.length > 0) {
                    // Filter out any null/undefined/empty/duplicate entries
                    const cleaned = [];
                    const seen = new Set();
                    loaded.forEach(p => {
                        if (p && typeof p === 'string' && p.trim().length > 0 && !seen.has(p)) {
                            cleaned.push(p);
                            seen.add(p);
                        }
                    });
                    
                    if (cleaned.length === 0) {
                        console.warn('‚ö†Ô∏è All profiles were corrupt/empty, restoring defaults');
                        localStorage.removeItem('doorProfiles');
                    } else if (cleaned.length !== loaded.length) {
                        console.warn(`‚ö†Ô∏è Removed ${loaded.length - cleaned.length} corrupt/duplicate entries, kept ${cleaned.length}`);
                        localStorage.setItem('doorProfiles', JSON.stringify(cleaned));
                        console.log('  Cleaned profiles:', cleaned);
                        return cleaned;
                    } else {
                        console.log(`‚úì Loaded ${loaded.length} door profiles from localStorage`);
                        return loaded;
                    }
                } else if (Array.isArray(loaded) && loaded.length === 0) {
                    console.warn('‚ö†Ô∏è doorProfiles array is empty, using defaults');
                    localStorage.removeItem('doorProfiles');
                } else {
                    console.warn('‚ö†Ô∏è doorProfiles is not a valid array, restoring defaults');
                    localStorage.removeItem('doorProfiles');
                }
            } catch(e) {
                console.error('Error loading door profiles from localStorage:', e);
                console.warn('‚ö†Ô∏è Restoring default door profiles');
                localStorage.removeItem('doorProfiles');
            }
        } else {
            console.log('‚ÑπÔ∏è No saved door profiles in localStorage, using defaults');
        }
        // Use defaults
        const defaults = [...DEFAULT_PROFILES];
        console.log(`‚úì Using default ${DEFAULT_PROFILES.length} door profiles`);
        console.log('  Saving defaults to localStorage immediately...');
        localStorage.setItem('doorProfiles', JSON.stringify(defaults)); // SAVE DEFAULTS
        console.log('  ‚úì Defaults saved to localStorage');
        return defaults;
    })();
    
    // Log profiles initialization
    console.log(`‚úÖ PROFILES INITIALIZED: ${profiles.length} doors loaded`);
    console.log('   Initial profiles array:', profiles);
    
    // Helper function to save profiles to localStorage
    function saveProfilesToStorage() {
        localStorage.setItem('doorProfiles', JSON.stringify(profiles));
        console.log(`‚úì Saved ${profiles.length} door profiles to localStorage`);
    }
    
    // Restore all default profiles
    function restoreDefaultProfiles() {
        profiles = [...DEFAULT_PROFILES];
        saveProfilesToStorage(); // Save to localStorage
        console.log(`‚úì Restored ${profiles.length} default door profiles`);
        
        // Try Firebase sync but don't fail if unavailable
        try {
            if (window.firebaseReady && window.currentUser) {
                syncProfilesToFirebase();
            } else {
                console.log('‚ÑπÔ∏è Firebase not ready, skipping profile sync');
            }
        } catch(e) {
            console.warn('‚ö†Ô∏è Firebase sync failed (non-critical):', e);
        }
        
        // Update UI
        try {
            renderPricingMatrix();
            checkForNewUnallocatedDoors();
            renderDB(); // Refresh admin display
        } catch(e) {
            console.warn('‚ö†Ô∏è UI update failed:', e);
        }
        
        notify('‚úì Door profiles restored to 20 defaults');
    }
    
    // ===== PAINT FORMULA DATABASE =====
    let paintDatabase = (function() {
        const saved = localStorage.getItem('paintFormulas');
        if (saved) {
            try {
                const loaded = JSON.parse(saved);
                if (Array.isArray(loaded) && loaded.length > 0) {
                    console.log(`‚úì Loaded ${loaded.length} paint formulas from localStorage`);
                    return loaded;
                }
            } catch(e) {
                console.error('Error loading paint formulas:', e);
            }
        }
        
        // Default example formula
        const defaults = [
            {
                id: 'lexicon-690-30',
                brand: 'Evic',
                color: 'Lexicon',
                product: '690 30% XTint Poly',
                code: 'XTSW1E3',
                finishes: ['Satin', 'Gloss', 'Matt'],
                baseSize: 1,
                baseTinters: [
                    { code: 'ITE003', amount: 7.47 },
                    { code: 'XB6930', amount: 1359.04, name: 'White Base' }
                ],
                colourants: [
                    { code: 'ITE303', amount: 5.88 },
                    { code: 'ITE306', amount: 5.95 },
                    { code: 'ITE310', amount: 5.75 }
                ],
                notes: 'DULUX WOC Series II 2018'
            }
        ];
        
        console.log(`‚úì Using ${defaults.length} default paint formulas`);
        localStorage.setItem('paintFormulas', JSON.stringify(defaults));
        return defaults;
    })();

    function savePaintFormulas() {
        localStorage.setItem('paintFormulas', JSON.stringify(paintDatabase));
        console.log(`‚úì Saved ${paintDatabase.length} paint formulas to localStorage`);
    }

    function getPaintFormula(colorName) {
        const formula = paintDatabase.find(f => 
            f.color.toLowerCase() === colorName.toLowerCase()
        );
        return formula || null;
    }

    function addOrUpdateFormula(formulaData) {
        const index = paintDatabase.findIndex(f => f.id === formulaData.id);
        if (index >= 0) {
            paintDatabase[index] = formulaData;
        } else {
            formulaData.id = 'formula-' + Date.now();
            paintDatabase.push(formulaData);
        }
        savePaintFormulas();
        console.log(`‚úì Saved formula: ${formulaData.color}`);
    }

    // ===== PAINT FORMULA UI FUNCTIONS =====
    let selectedFormula = null;

    function openPaintFormulaSearch() {
        const colorInput = document.getElementById('p-color').value.trim();
        
        if (!colorInput) {
            // Show all formulas if input is empty
            displayFormulaOptions(paintDatabase);
        } else {
            // Filter formulas by color name
            const matching = paintDatabase.filter(f =>
                f.color.toLowerCase().includes(colorInput.toLowerCase())
            );
            displayFormulaOptions(matching);
        }
    }

    function displayFormulaOptions(formulas) {
        if (formulas.length === 0) {
            notify('No matching formulas found');
            return;
        }
        
        // Show modal with first matching formula
        selectedFormula = formulas[0];
        displayPaintFormulaModal();
    }

    function displayPaintFormulaModal() {
        if (!selectedFormula) return;
        
        const modal = document.getElementById('paintFormulaModal');
        if (!modal) {
            console.error('Paint formula modal element not found!');
            return;
        }
        
        document.getElementById('formulaColor').textContent = selectedFormula.color;
        document.getElementById('formulaCode').textContent = selectedFormula.code;
        
        document.getElementById('mixLitres').value = '1';
        updateFormulaScaling();
        
        // Show as flex for proper centering
        modal.style.display = 'flex';
        console.log('‚úì Paint formula modal displayed');
    }

    function updateFormulaScaling() {
        if (!selectedFormula) return;
        
        const litres = parseFloat(document.getElementById('mixLitres').value) || 1;
        const scaleFactor = litres / selectedFormula.baseSize;
        
        let html = `<div style="font-size:12px; font-weight:900; margin-bottom:10px;">Scaled for ${litres}L:</div>`;
        
        html += '<div style="margin-bottom:10px;"><strong>Base Tinters:</strong></div>';
        selectedFormula.baseTinters.forEach(t => {
            const scaledAmount = (t.amount * scaleFactor).toFixed(2);
            html += `<div style="display:flex; justify-content:space-between; font-size:11px; margin:4px 0;">
                <span>${t.code}</span>
                <span style="color:#d4af37; font-weight:900;">${scaledAmount}g</span>
            </div>`;
        });
        
        html += '<div style="margin-top:10px; margin-bottom:10px;"><strong>Colourants:</strong></div>';
        selectedFormula.colourants.forEach(c => {
            const scaledAmount = (c.amount * scaleFactor).toFixed(2);
            html += `<div style="display:flex; justify-content:space-between; font-size:11px; margin:4px 0;">
                <span>${c.code}</span>
                <span style="color:#d4af37; font-weight:900;">${scaledAmount}g</span>
            </div>`;
        });
        
        document.getElementById('scaledFormula').innerHTML = html;
    }

    function savePaintFormulaToJob() {
        if (!selectedFormula) return;
        
        const litres = parseFloat(document.getElementById('mixLitres').value) || 1;
        
        // Populate form fields
        document.getElementById('p-color').value = selectedFormula.color;
        document.getElementById('p-code').value = `${selectedFormula.code} - ${selectedFormula.color} (${selectedFormula.product})`;
        
        // Save to job data
        const jobData = {
            paintFormula: selectedFormula,
            mixLitres: litres,
            savedAt: new Date().toLocaleString('en-AU')
        };
        
        // Store formula in current job
        if (window.currentJobData) {
            window.currentJobData.paintFormula = jobData;
        }
        
        // Also add to used formulas (optional, for history)
        if (!localStorage.getItem('usedFormulas')) {
            localStorage.setItem('usedFormulas', JSON.stringify([]));
        }
        const used = JSON.parse(localStorage.getItem('usedFormulas')) || [];
        if (!used.find(f => f.id === selectedFormula.id)) {
            used.push(selectedFormula);
            localStorage.setItem('usedFormulas', JSON.stringify(used));
        }
        
        closePaintFormulaModal();
        notify(`‚úì Formula saved: ${selectedFormula.color} (${litres}L)`);
        saveData(); // Save current job
    }

    function closePaintFormulaModal() {
        document.getElementById('paintFormulaModal').style.display = 'none';
        selectedFormula = null;
    }

    // ===== PAINT FORMULA DATABASE MANAGEMENT =====
    function renderPaintFormulaList() {
        const list = document.getElementById('paintFormulaList');
        if (!list) return;
        
        if (paintDatabase.length === 0) {
            list.innerHTML = '<div style="padding:15px; text-align:center; color:#999; font-size:11px;">No formulas yet. Add one above.</div>';
            return;
        }
        
        let html = '';
        paintDatabase.forEach((f, idx) => {
            html += `
            <div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:900; font-size:12px;">${f.color}</div>
                    <div style="font-size:10px; color:#666; margin-top:3px;">
                        <div>${f.code} - ${f.product}</div>
                    </div>
                </div>
                <div style="display:flex; gap:6px;">
                    <button onclick="editPaintFormula(${idx})" style="padding:4px 10px; background:#2196f3; color:#fff; border:none; border-radius:3px; font-size:9px; font-weight:900; cursor:pointer;">Edit</button>
                    <button onclick="deletePaintFormula(${idx})" style="padding:4px 10px; background:#ff3b30; color:#fff; border:none; border-radius:3px; font-size:9px; font-weight:900; cursor:pointer;">Delete</button>
                </div>
            </div>
            `;
        });
        
        list.innerHTML = html;
    }

    function addNewPaintFormulaUI() {
        const color = document.getElementById('newPaintColor').value.trim();
        const code = document.getElementById('newPaintCode').value.trim();
        const product = document.getElementById('newPaintProduct').value.trim();
        const baseCode = document.getElementById('baseCode').value.trim();
        const baseAmount = parseFloat(document.getElementById('baseAmount').value) || 0;
        const tintersList = document.getElementById('tintersList').value.trim();
        
        if (!color || !code || !baseCode || !baseAmount) {
            notify('Please enter Colour, Code, Base Code, and Base Amount');
            return;
        }
        
        // Parse tinters (format: CODE @ GRAMS, one per line)
        const colourants = [];
        if (tintersList) {
            tintersList.split('\n').forEach(line => {
                const match = line.trim().match(/^(\S+)\s*@\s*([\d.]+)$/);
                if (match) {
                    colourants.push({
                        code: match[1],
                        amount: parseFloat(match[2])
                    });
                }
            });
        }
        
        // Create new formula with structured format
        const newFormula = {
            id: 'formula-' + Date.now(),
            brand: 'Evic',
            color: color,
            product: product || 'Custom Product',
            code: code,
            finishes: ['Satin'],
            baseSize: 1,
            baseTinters: [
                { code: baseCode, amount: baseAmount }
            ],
            colourants: colourants,
            notes: `${colourants.length} tinters`
        };
        
        paintDatabase.push(newFormula);
        savePaintFormulas();
        
        // Clear form
        document.getElementById('newPaintColor').value = '';
        document.getElementById('newPaintCode').value = '';
        document.getElementById('newPaintProduct').value = '';
        document.getElementById('baseCode').value = '';
        document.getElementById('baseAmount').value = '';
        document.getElementById('tintersList').value = '';
        
        renderPaintFormulaList();
        notify(`‚úì Formula added: ${color} (${colourants.length} tinters)`);
    }

    function editPaintFormula(idx) {
        const f = paintDatabase[idx];
        if (!f) return;
        
        const newColor = prompt('Edit Color Name:', f.color);
        if (newColor === null) return;
        
        f.color = newColor;
        savePaintFormulas();
        renderPaintFormulaList();
        notify(`‚úì Formula updated: ${newColor}`);
    }

    function deletePaintFormula(idx) {
        const f = paintDatabase[idx];
        if (!f) return;
        
        if (confirm(`Delete formula "${f.color}"?`)) {
            paintDatabase.splice(idx, 1);
            savePaintFormulas();
            renderPaintFormulaList();
            notify(`‚úì Formula deleted: ${f.color}`);
        }
    }
    
    // Clear stale Firebase profile data and force fresh sync
    function clearFirebaseProfilesData() {
        if (!confirm('üö® CLEAR FIREBASE DATA:\n- Removes old Firebase profile data\n- Keeps your current door assignments\n- Syncs fresh to Firebase\n\nProceed?')) {
            return;
        }
        
        if (!window.firebaseReady || !window.currentUser) {
            alert('Firebase not ready. Please try again.');
            return;
        }
        
        try {
            console.log('üóëÔ∏è Clearing stale Firebase data...');
            
            // 1. Delete the old Firebase documents to remove stale data
            const configDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'config', 'doorProfiles');
            window.deleteDoc(configDoc).then(() => {
                console.log('‚úì Deleted old Firebase doorProfiles document');
            }).catch(err => {
                console.error('Note: Could not delete Firebase doc (may already be gone):', err);
            });
            
            // 2. Force immediate re-sync of CURRENT profiles and masterMatrix (not defaults!)
            setTimeout(() => {
                console.log(`üì§ Syncing current state to Firebase (${profiles.length} profiles, ${Object.keys(masterMatrix).length} tiers)`);
                syncProfilesToFirebase();
                renderPricingMatrix();
                notify('‚úÖ Firebase cleared and current data re-synced!');
                console.log('‚úÖ Firebase sync complete');
            }, 500);
        } catch (error) {
            console.error('Error clearing Firebase:', error);
            alert('Error clearing Firebase. Check console.');
        }
    }
    
    // EXTREME: Clear ALL browser localStorage and reload
    function clearAllLocalStorage() {
        if (!confirm('‚ò¢Ô∏è EXTREME ACTION:\n\nThis will DELETE ALL browser storage:\n- All jobs\n- All profiles\n- All settings\n- Everything\n\nYou will need to hard refresh after.\n\nAre you 100% sure?')) {
            return;
        }
        
        try {
            console.log('‚ò¢Ô∏è CLEARING ALL LOCALSTORAGE...');
            localStorage.clear();
            console.log('‚úì All localStorage cleared');
            
            // Also try to clear sessionStorage
            sessionStorage.clear();
            console.log('‚úì sessionStorage cleared');
            
            notify('‚ò¢Ô∏è All storage cleared - Hard refreshing page...');
            
            // Force hard refresh
            setTimeout(() => {
                window.location.reload(true);
            }, 500);
        } catch (error) {
            console.error('Error clearing storage:', error);
            alert('Error during clear. Try manually clearing browser cache and refreshing.');
        }
    }
    
    // Diagnostic: Show what's actually in localStorage
    function diagnoseStorage() {
        console.log('=== PAINTWORKZ STORAGE DIAGNOSTIC ===');
        console.log('');
        
        // Check doorProfiles
        const doorProfilesStr = localStorage.getItem('doorProfiles');
        console.log('üìÅ doorProfiles in localStorage:');
        if (doorProfilesStr) {
            try {
                const parsed = JSON.parse(doorProfilesStr);
                console.log('‚úì Valid JSON, ' + parsed.length + ' items:');
                parsed.forEach((p, i) => console.log(`  [${i}] ${p}`));
            } catch(e) {
                console.error('‚úó CORRUPTED JSON:', e);
                console.log('Raw value:', doorProfilesStr);
            }
        } else {
            console.log('‚úó Empty (null)');
        }
        
        console.log('');
        console.log('üîß Current profiles array in memory: ' + profiles.length + ' items');
        profiles.forEach((p, i) => console.log(`  [${i}] ${p}`));
        
        console.log('');
        console.log('üìä masterMatrix tiers:');
        Object.keys(masterMatrix).forEach(tierName => {
            const count = Object.keys(masterMatrix[tierName]).length;
            console.log(`  ${tierName}: ${count} doors`);
        });
        
        console.log('');
        const unallocated = getUnallocatedDoors();
        console.log('‚ö†Ô∏è Unallocated doors: ' + unallocated.length);
        unallocated.forEach(d => console.log(`  - ${d.name}`));
        
        console.log('');
        console.log('‚úÖ DIAGNOSTIC COMPLETE - Check console above for details');
        
        alert(`DIAGNOSTIC INFO (Check F12 Console):\n\n` +
              `doorProfiles in storage: ${doorProfilesStr ? 'YES (' + JSON.parse(doorProfilesStr).length + ' items)' : 'NO (null)'}\n` +
              `Current profiles in memory: ${profiles.length} items\n` +
              `Master matrix tiers: ${Object.keys(masterMatrix).length}\n` +
              `Unallocated doors: ${unallocated.length}\n\n` +
              `All details in console (F12)`);
    }
    
    // Check for new unallocated doors and show notification
    function checkForNewUnallocatedDoors() {
        // Removed - globalNotifications section no longer exists
    }

    window.onload = () => { 
        refreshLists();
        loadData();
        renderHistory();
        // Ensure prof-select is populated after a slight delay for safety
        setTimeout(() => {
            const profSel = document.getElementById('prof-select');
            if (profSel && profSel.options.length === 0) {
                console.log('‚ö†Ô∏è prof-select empty after load, repopulating...');
                refreshLists();
            }
        }, 100);
        // renderScheduleCalendar(); // Don't render until Schedule tab is clicked
    };

    // LOCAL STORAGE
    function saveData() {
        const jobData = {
            items: items,
            client: document.getElementById('cli').value,
            dateReceived: document.getElementById('dRec').value,
            jobName: document.getElementById('jNm').value,
            jobNum: document.getElementById('jN').value,
            brand: document.getElementById('p-brand').value,
            color: document.getElementById('p-color').value,
            code: document.getElementById('p-code').value,
            finish: document.getElementById('p-finish').value,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('currentJob', JSON.stringify(jobData));
    }

    // Populate client dropdown with unique clients from history
    function populateClientDropdown() {
        try {
            const clientSelect = document.getElementById('cli');
            if (!clientSelect) {
                console.warn('Client dropdown element not found');
                return;
            }
            
            // Build list of clients with proper deduplication
            const seen = new Set();
            const allClients = [];
            
            // 1. Get from client database (authoritative source)
            const db = getClientDatabase();
            Object.values(db).forEach(client => {
                if (client.name && !seen.has(client.name.toLowerCase())) {
                    allClients.push(client.name);
                    seen.add(client.name.toLowerCase());
                }
            });
            
            // 2. Get from job history (catch any missing clients)
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            history.forEach(job => {
                if (job.client && !seen.has(job.client.toLowerCase())) {
                    allClients.push(job.client);
                    seen.add(job.client.toLowerCase());
                }
            });
            
            // 3. Get from hardcoded clients array (legacy support)
            clients.forEach(client => {
                if (client && !seen.has(client.toLowerCase())) {
                    allClients.push(client);
                    seen.add(client.toLowerCase());
                }
            });
            
            // Sort alphabetically
            allClients.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
            
            // Clear and rebuild dropdown
            clientSelect.innerHTML = '<option value="">-- Select or type client --</option>';
            allClients.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientSelect.appendChild(option);
            });
            
            console.log(`‚úì Populated ${allClients.length} unique clients (deduped, no duplicates)`);
        } catch(e) {
            console.error('Error populating client dropdown:', e);
        }
    }
    
    // Initialize app on page load
    function initializeDefaultClients() {
        const db = getClientDatabase();
        
        // Only populate if database is empty
        if (Object.keys(db).length === 0) {
            const defaultClients = {
                'client-001': { id: 'client-001', name: 'Residential Properties', email: 'contact@residentialprops.com.au', phone: '(03) 8000 1234', address: '123 Main Street, Melbourne VIC 3000', createdDate: new Date().toISOString(), notes: 'Regular residential cabinet refurbishment' },
                'client-002': { id: 'client-002', name: 'Commercial Kitchens & Fit-out', email: 'sales@commkitchens.com.au', phone: '(03) 8001 5678', address: '456 Business Ave, Docklands VIC 3008', createdDate: new Date().toISOString(), notes: 'Commercial kitchen cabinet spraying specialist' },
                'client-003': { id: 'client-003', name: 'Interior Design Studio', email: 'projects@interiordesignco.com.au', phone: '(03) 8002 9012', address: '789 Creative Way, Collingwood VIC 3066', createdDate: new Date().toISOString(), notes: 'High-end residential cabinet refinishing' },
                'client-004': { id: 'client-004', name: 'Hotel & Hospitality Group', email: 'maintenance@hotelgroup.com.au', phone: '(03) 8003 3456', address: '321 Luxury Lane, South Yarra VIC 3141', createdDate: new Date().toISOString(), notes: 'Luxury hotel cabinet maintenance & refurbishment' },
                'client-005': { id: 'client-005', name: 'Builders & Developers', email: 'enquiry@buildersdev.com.au', phone: '(03) 8004 7890', address: '654 Construction St, Footscray VIC 3011', createdDate: new Date().toISOString(), notes: 'New build property kitchen & wardrobe cabinets' }
            };
            
            saveClientDatabase(defaultClients);
            console.log('‚úì Default clients populated to database');
        }
    }
    
    function initializeApp() {
        console.log('üöÄ Initializing PaintWorkz...');
        
        try {
            // Clear measure sheet on fresh load
            items = [];
            
            const cliEl = document.getElementById('cli');
            const dRecEl = document.getElementById('dRec');
            const jNmEl = document.getElementById('jNm');
            const jNEl = document.getElementById('jN');
            const pBrandEl = document.getElementById('p-brand');
            const pColorEl = document.getElementById('p-color');
            const pCodeEl = document.getElementById('p-code');
            const pFinishEl = document.getElementById('p-finish');
            
            if (cliEl) cliEl.value = '';
            if (dRecEl) dRecEl.value = '';
            if (jNmEl) jNmEl.value = '';
            if (jNEl) jNEl.value = '';
            if (pBrandEl) pBrandEl.value = 'Wattyl';
            if (pColorEl) pColorEl.value = '';
            if (pCodeEl) pCodeEl.value = '';
            if (pFinishEl) pFinishEl.value = 'Satin';
            
            const totSqmEl = document.getElementById('tA');
            const totPartsEl = document.getElementById('tQ');
            if (totSqmEl) totSqmEl.innerText = '0.000';
            if (totPartsEl) totPartsEl.innerText = '0';
            
            // Initialize default clients if database is empty
            initializeDefaultClients();
            
            // Populate client dropdown
            populateClientDropdown();
            
            // Render clients in admin tab
            renderClientsList();
            
            // Re-render measure sheet
            if (typeof render === 'function') {
                render();
            }
            
            console.log('‚úì App initialized - measure sheet cleared, clients loaded');
        } catch(e) {
            console.error('Error during app initialization:', e);
            console.warn('App continuing despite initialization error - some elements may not be ready yet');
        }
    }
    
    function loadData() {
        const saved = localStorage.getItem('currentJob');
        if (saved) {
            const jobData = JSON.parse(saved);
            items = jobData.items || [];
            document.getElementById('cli').value = jobData.client || '';
            document.getElementById('dRec').value = jobData.dateReceived || '';
            document.getElementById('jNm').value = jobData.jobName || '';
            document.getElementById('jN').value = jobData.jobNum || '';
            document.getElementById('p-brand').value = jobData.brand || 'Wattyl';
            document.getElementById('p-color').value = jobData.color || '';
            document.getElementById('p-code').value = jobData.code || '';
            document.getElementById('p-finish').value = jobData.finish || 'Satin';
            render();
        }
    }

    // Function to clean up duplicate jobs
    function checkForDuplicates() {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const seen = new Set();
        let hasDuplicates = false;
        
        history.forEach(job => {
            const key = `${job.jobNum}|${job.dateReceived}|${job.client}`;
            if (seen.has(key)) {
                hasDuplicates = true;
            }
            seen.add(key);
        });
        
        const warningEl = document.getElementById('duplicateWarning');
        if (warningEl) {
            warningEl.style.display = hasDuplicates ? 'block' : 'none';
        }
    }
    
    function removeDuplicateJobs() {
        try {
            let history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const seen = new Map();
            let cleaned = [];
            let duplicates = 0;
            
            history.forEach(job => {
                // Skip jobs with missing critical fields
                if (!job.jobNum || !job.dateReceived || !job.client) {
                    duplicates++;
                    return;
                }
                
                const key = `${job.jobNum}|${job.dateReceived}|${job.client}`;
                if (!seen.has(key)) {
                    seen.set(key, true);
                    cleaned.push(job);
                } else {
                    duplicates++;
                }
            });
            
            if (duplicates > 0) {
                localStorage.setItem('jobHistory', JSON.stringify(cleaned));
                renderHistory();
                renderJobTasks();
                renderScheduleCalendar();
                notify(`‚úì Cleaned ${duplicates} duplicate/invalid jobs!`);
            } else {
                notify('‚úì No duplicates found');
            }
        } catch(e) {
            console.error('Error removing duplicates:', e);
            notify('‚ö†Ô∏è Error cleaning duplicates');
        }
    }
    
    function saveJobToHistory() {
        const jobData = {
            items: items,
            client: document.getElementById('cli').value,
            dateReceived: document.getElementById('dRec').value,
            jobName: document.getElementById('jNm').value,
            jobNum: document.getElementById('jN').value,
            brand: document.getElementById('p-brand').value,
            color: document.getElementById('p-color').value,
            code: document.getElementById('p-code').value,
            finish: document.getElementById('p-finish').value,
            totalSqm: document.getElementById('tA')?.innerText || '0.000',
            totalParts: document.getElementById('tQ')?.innerText || '0',
            timestamp: new Date().toISOString(),
            savedDate: new Date().toLocaleString('en-AU'),
            completed: false  // Always false when saving new
        };
        
        
        // Get existing history
        let history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        // Check if we're overwriting an existing job
        if (currentEditingJobIndex !== null) {
            if (confirm(`Overwrite existing job #${jobData.jobNum}?`)) {
                history[currentEditingJobIndex] = jobData;
                currentEditingJobIndex = null; // Reset for next job
                notify('‚úì Job Updated');
                addAdminAlert('JOB_UPDATED', `‚úèÔ∏è JOB UPDATED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
            } else {
                return; // Don't save if user cancels
            }
        } else {
            // Add new job to history - CHECK FOR DUPLICATES FIRST
            const existingIdx = history.findIndex(j => j.jobNum === jobData.jobNum && j.dateReceived === jobData.dateReceived && j.client === jobData.client);
            
            if (existingIdx !== -1) {
                // Job with same number, date, and client already exists - update it instead
                if (confirm(`Job #${jobData.jobNum} already exists. Replace it?`)) {
                    history[existingIdx] = jobData;
                    notify('‚úì Job Updated (duplicate prevented)');
                    addAdminAlert('JOB_UPDATED', `‚úèÔ∏è JOB UPDATED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
                } else {
                    return;
                }
            } else {
                // New unique job
                history.unshift(jobData);
                notify('‚úì Job Saved');
                addAdminAlert('JOB_SAVED', `‚úÖ NEW JOB SAVED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
            }
        }
        
        // Keep only last 50 jobs
        history = history.slice(0, 50);
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        // Send appropriate notification based on what happened
        if (currentEditingJobIndex !== null) {
            addAdminAlert('JOB_UPDATED', `‚úèÔ∏è JOB UPDATED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
        } else if (history.length > 0 && history[0].jobNum === jobData.jobNum) {
            // Check if this was a duplicate update
            const duplicateMatches = history.filter(j => j.jobNum === jobData.jobNum).length;
            if (duplicateMatches > 1) {
                addAdminAlert('JOB_UPDATED', `‚úèÔ∏è JOB UPDATED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
            } else {
                addAdminAlert('JOB_SAVED', `‚úÖ NEW JOB SAVED #${jobData.jobNum} ‚Ä¢ ${jobData.client}`, {jobNum: jobData.jobNum, client: jobData.client, totalParts: jobData.totalParts});
            }
        }
        
        // Sync to Firebase immediately
        if (window.syncJobsToFirebase) {
            try {
                window.syncJobsToFirebase();
                console.log('üîÑ Job saved and synced to Firebase');
            } catch(e) {
                console.error('Firebase sync error on save:', e);
            }
        }
        
        // CLEAR FIRST - before rendering
        console.log('üßπ Starting measure sheet clear...');
        items = [];
        console.log('‚úì Cleared items array');
        
        // Clear all form fields with element existence checks
        try {
            const cliEl = document.getElementById('cli');
            if (cliEl) {
                cliEl.value = '';
                console.log('‚úì Cleared client');
            }
            
            const dRecEl = document.getElementById('dRec');
            if (dRecEl) {
                dRecEl.value = '';
                console.log('‚úì Cleared date received');
            }
            
            const jNmEl = document.getElementById('jNm');
            if (jNmEl) {
                jNmEl.value = '';
                console.log('‚úì Cleared job name');
            }
            
            const jNEl = document.getElementById('jN');
            if (jNEl) {
                jNEl.value = '';
                console.log('‚úì Cleared job number');
            }
            
            const pBrandEl = document.getElementById('p-brand');
            if (pBrandEl) {
                pBrandEl.value = 'Wattyl';
                console.log('‚úì Reset paint brand to Wattyl');
            }
            
            const pColorEl = document.getElementById('p-color');
            if (pColorEl) {
                pColorEl.value = '';
                console.log('‚úì Cleared paint colour');
            }
            
            const pCodeEl = document.getElementById('p-code');
            if (pCodeEl) {
                pCodeEl.value = '';
                console.log('‚úì Cleared paint code');
            }
            
            const pFinishEl = document.getElementById('p-finish');
            if (pFinishEl) {
                pFinishEl.value = 'Satin';
                console.log('‚úì Reset paint finish to Satin');
            }
            
            // Clear totals
            const totSqmEl = document.getElementById('tA');
            if (totSqmEl) {
                totSqmEl.innerText = '0.000';
                console.log('‚úì Cleared total SQM (m¬≤)');
            }
            
            const totPartsEl = document.getElementById('tQ');
            if (totPartsEl) {
                totPartsEl.innerText = '0';
                console.log('‚úì Cleared total parts');
            }
        } catch(e) {
            console.error('Error clearing form fields:', e);
        }
        
        console.log('‚úì All form fields cleared');
        
        // Clear the items list from localStorage too
        localStorage.removeItem('currentJob');
        console.log('‚úì Cleared currentJob from localStorage');
        
        // Now render the empty form
        render();
        console.log('‚úì Measure sheet re-rendered (empty)');
        
        // Then update other views
        renderHistory();
        renderJobTasks();
        renderScheduleCalendar();
        
        notify('‚úì Job Saved - Form ready for next entry');
        console.log('üìã Ready for next job entry');
    }

    let historyFilter = 'all';
    
    // Track deleted jobs in this session to prevent Firebase from pulling them back
    let deletedJobsThisSession = new Set();
    
    // Function to create unique job key
    function getJobKey(jobNum, dateReceived, client) {
        return `${jobNum}|${dateReceived}|${client}`;
    }
    
    // Function to check if a job has been deleted in this session
    function isJobDeleted(jobNum, dateReceived, client) {
        const key = getJobKey(jobNum, dateReceived, client);
        return deletedJobsThisSession.has(key);
    }
    
    // Function to mark a job as deleted in this session
    function markJobAsDeleted(jobNum, dateReceived, client) {
        const key = getJobKey(jobNum, dateReceived, client);
        deletedJobsThisSession.add(key);
        console.log(`üìå Marked job as deleted in session: ${key} (Total deleted: ${deletedJobsThisSession.size})`);
    }

    function renderHistory() {
        const historyList = document.getElementById('history-list');
        if (!historyList) return;
        
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        if (history.length === 0) {
            historyList.innerHTML = '';
            return;
        }
        
        // FIRST: Filter out deleted jobs from this session (prevents Firebase resurrection)
        let filteredHistory = history.filter(j => {
            const isDeleted = isJobDeleted(j.jobNum, j.dateReceived, j.client);
            if (isDeleted) {
                console.log(`üö´ Filtering out deleted job #${j.jobNum} from display`);
            }
            return !isDeleted;
        });
        
        // SECOND: Apply active/completed filter
        if (historyFilter === 'active') {
            filteredHistory = filteredHistory.filter(j => !j.completed);
        } else if (historyFilter === 'completed') {
            filteredHistory = filteredHistory.filter(j => j.completed === true);
        }
        
        historyList.innerHTML = '';
        if (filteredHistory.length === 0) {
            historyList.innerHTML = '<div class="card" style="text-align:center; color:#999;">No jobs match this filter</div>';
            return;
        }
        
        filteredHistory.forEach((job, idx) => {
            // Find original index in full history
            const originalIdx = history.indexOf(job);
            
            const jobDate = new Date(job.timestamp);
            const dateStr = jobDate.toLocaleDateString('en-AU');
            const isComplete = job.completed || false;
            
            historyList.innerHTML += `<div class="card" style="border-left:5px solid ${isComplete ? '#34c759' : 'var(--gs)'}; position:relative; ${isComplete ? 'background:#f0fff4;' : ''}; overflow:visible;">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px; position:relative; z-index:1;">
                    <div style="flex:1;">
                        <div style="font-weight:900; color:#000; font-size:14px;">
                            Job #${job.jobNum || 'N/A'}: ${job.jobName || 'Unnamed'}
                        </div>
                        <div style="font-size:11px; color:#666; font-weight:700;">${job.client || 'No Client'}</div>
                    </div>
                    <div style="font-size:11px; color:#999; font-weight:700; text-align:right;">
                        <div>${dateStr}</div>
                        <div>${new Date(job.timestamp).toLocaleTimeString('en-AU', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                </div>
                <div style="display:flex; gap:15px; padding:10px 0; border-top:1px solid #eee; border-bottom:1px solid #eee; margin-bottom:10px; position:relative; z-index:1;">
                    <div style="flex:1; text-align:center;">
                        <div style="font-size:16px; font-weight:900; color:var(--gs);">${job.totalSqm || '0.000'}</div>
                        <div style="font-size:9px; color:#999; font-weight:700;">SQM</div>
                    </div>
                    <div style="flex:1; text-align:center;">
                        <div style="font-size:16px; font-weight:900; color:var(--gs);">${job.totalParts || '0'}</div>
                        <div style="font-size:9px; color:#999; font-weight:700;">PARTS</div>
                    </div>
                    <div style="flex:1; text-align:center;">
                        <div style="font-size:13px; font-weight:900; color:#666;">${job.color || 'N/A'}</div>
                        <div style="font-size:9px; color:#999; font-weight:700;">${job.brand || 'N/A'}</div>
                    </div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; position:relative; z-index:1;">
                    <button onclick="loadJobFromHistory(${originalIdx})" style="flex:1; min-width:100px; border:none; background:#f0f0f0; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">LOAD</button>
                    ${!isComplete ? `<button onclick="completeJobById('${job.jobNum}', '${job.dateReceived}', '${job.client}')" style="flex:1; min-width:100px; border:none; background:var(--gold); color:#000; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">COMPLETE JOB</button>` : `<button onclick="toggleJobCompleteById('${job.jobNum}', '${job.dateReceived}', '${job.client}')" style="flex:1; min-width:100px; border:none; background:#34c759; color:#fff; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚úì COMPLETED</button>`}
                    <button onclick="deleteJobFromHistory(${originalIdx})" style="flex:1; min-width:80px; border:none; background:#ff3b3015; color:#ff3b30; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">DELETE</button>
                </div>
            </div>`;
        });
        
        // Update client dropdown with latest clients from history
        populateClientDropdown();
    }

    function filterHistory(filter) {
        historyFilter = filter;
        
        // Update button styles
        document.getElementById('filter-all').style.background = filter === 'all' ? '#d4af37' : '#f0f0f0';
        document.getElementById('filter-all').style.color = filter === 'all' ? '#000' : '#666';
        
        document.getElementById('filter-active').style.background = filter === 'active' ? '#d4af37' : '#f0f0f0';
        document.getElementById('filter-active').style.color = filter === 'active' ? '#000' : '#666';
        
        document.getElementById('filter-completed').style.background = filter === 'completed' ? '#34c759' : '#f0f0f0';
        document.getElementById('filter-completed').style.color = filter === 'completed' ? '#fff' : '#666';
        
        renderHistory();
    }

    // Track the current job being edited (if loaded from history)
    let currentEditingJobIndex = null;
    let isJobViewMode = false; // Track if viewing job without editing
    let jobDataBeforeLoad = null; // Store original data to detect changes

    function loadJobFromHistory(index) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[index];
        
        if (!job) return;
        
        currentEditingJobIndex = index; // Track this job for overwrite
        isJobViewMode = true; // Set view mode
        
        items = job.items || [];
        document.getElementById('cli').value = job.client || '';
        document.getElementById('dRec').value = job.dateReceived || '';
        document.getElementById('jNm').value = job.jobName || '';
        document.getElementById('jN').value = job.jobNum || '';
        document.getElementById('p-brand').value = job.brand || 'Wattyl';
        document.getElementById('p-color').value = job.color || '';
        document.getElementById('p-code').value = job.code || '';
        document.getElementById('p-finish').value = job.finish || 'Satin';
        
        // Store original data to detect changes
        jobDataBeforeLoad = JSON.stringify({
            items: items,
            client: job.client,
            dateReceived: job.dateReceived,
            jobName: job.jobName,
            jobNum: job.jobNum,
            brand: job.brand,
            color: job.color,
            code: job.code,
            finish: job.finish
        });
        
        render();
        updateGoBackButton();
        tab('measure');
        notify('‚úì Job Loaded - View Only (changes can be saved)');
    }

    function updateGoBackButton() {
        const btn = document.getElementById('goBackBtn');
        if (isJobViewMode) {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    }

    function goBackJob() {
        // Get current data
        const currentData = JSON.stringify({
            items: items,
            client: document.getElementById('cli').value,
            dateReceived: document.getElementById('dRec').value,
            jobName: document.getElementById('jNm').value,
            jobNum: document.getElementById('jN').value,
            brand: document.getElementById('p-brand').value,
            color: document.getElementById('p-color').value,
            code: document.getElementById('p-code').value,
            finish: document.getElementById('p-finish').value
        });

        // Check if there are changes
        const hasChanges = currentData !== jobDataBeforeLoad;
        
        if (hasChanges) {
            if (confirm('You have unsaved changes. Save before going back?')) {
                saveJob();
                return;
            }
        }
        
        // Reset view mode and clear editing
        isJobViewMode = false;
        currentEditingJobIndex = null;
        jobDataBeforeLoad = null;
        items = [];
        updateGoBackButton();
        
        // Clear form
        document.getElementById('cli').value = '';
        document.getElementById('dRec').value = '';
        document.getElementById('jNm').value = '';
        document.getElementById('jN').value = '';
        document.getElementById('p-brand').value = 'Wattyl';
        document.getElementById('p-color').value = '';
        document.getElementById('p-code').value = '';
        document.getElementById('p-finish').value = 'Satin';
        
        render();
        tab('history');
        notify('‚úì Exited Job View');
    }

    // Delete a job from Firebase permanently
    function deleteJobFromFirebase(jobId) {
        if (!window.firebaseReady || !window.currentUser || !window.firebaseDb) {
            console.warn('Firebase not ready, cannot delete');
            return;
        }
        
        try {
            const jobDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'jobs', jobId);
            window.deleteDoc(jobDoc).then(() => {
                console.log(`‚úì Deleted job ${jobId} from Firebase`);
            }).catch(err => {
                console.error('Firebase deletion error:', err);
            });
        } catch(e) {
            console.error('deleteJobFromFirebase error:', e);
        }
    }

    function deleteJobFromHistory(index) {
        if (confirm('Delete this job from history permanently?')) {
            let history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const deletedJob = history[index];
            
            if (!deletedJob) {
                console.error('‚ùå Job not found at index:', index);
                return;
            }
            
            console.log(`üóëÔ∏è Permanently deleting Job #${deletedJob.jobNum}`);
            
            // Mark this deletion in session IMMEDIATELY (before any other operations)
            markJobAsDeleted(deletedJob.jobNum, deletedJob.dateReceived, deletedJob.client);
            
            // Remove from history array
            history.splice(index, 1);
            localStorage.setItem('jobHistory', JSON.stringify(history));
            console.log(`‚úì Removed from localStorage`);
            
            // Verify deletion
            let verifyHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const stillExists = verifyHistory.some(j => j.jobNum === deletedJob.jobNum && j.dateReceived === deletedJob.dateReceived && j.client === deletedJob.client);
            
            if (stillExists) {
                console.error('‚ùå CRITICAL: Job still exists after deletion attempt!');
                notify('‚ö†Ô∏è Error: Job deletion failed');
                return;
            }
            
            console.log(`‚úì Deletion verified - Job #${deletedJob.jobNum} is gone from localStorage`);
            
            // Delete from Firebase DIRECTLY (not just sync)
            const jobId = deletedJob.id || deletedJob.jobNum;
            deleteJobFromFirebase(jobId);
            console.log(`‚úì Deletion sent to Firebase`);
            
            notify('‚úì Job permanently deleted');
            
            // Re-render history (will filter out deleted job even if Firebase brings it back)
            renderHistory();
            renderJobTasks();
            renderScheduleCalendar();
        }
    }

    function completeJobById(jobNum, dateReceived, client) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        // Find job by unique identifiers
        const jobIdx = history.findIndex(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
        
        if (jobIdx < 0) {
            console.error('‚ùå Job not found:', jobNum, dateReceived, client);
            notify('‚ö†Ô∏è Error: Job not found');
            return;
        }
        
        const job = history[jobIdx];
        
        if (confirm(`Complete Job #${job.jobNum}?\n\nThis will:\n‚úì Mark job as complete\n‚úì Generate all PDFs\n‚úì Alert admins`)) {
            // Mark job as complete
            job.completed = true;
            job.completedDate = new Date().toISOString();
            history[jobIdx] = job;
            localStorage.setItem('jobHistory', JSON.stringify(history));
            
            console.log(`‚úÖ Job #${job.jobNum} marked as complete`);
            console.log(`üìÖ Completion date: ${job.completedDate}`);
            
            // Verify it was saved
            const verify = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const verifiedJob = verify.find(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
            if (verifiedJob && verifiedJob.completed) {
                console.log(`‚úì Verified: Job is now marked as completed in localStorage`);
            } else {
                console.error(`‚ùå FAILED: Job completion not saved properly!`);
                notify('‚ö†Ô∏è Error: Failed to save completion status');
                return;
            }
            
            // Sync to Firebase IMMEDIATELY
            if (window.syncJobsToFirebase) {
                try {
                    window.syncJobsToFirebase();
                    console.log('üîÑ Synced completion to Firebase');
                } catch(e) {
                    console.error('Firebase sync error:', e);
                }
            }
            
            // Generate batch PDFs
            generateBatchPDFs(job);
            
            // Alert admins
            alertAdmins(job);
            
            notify('‚úì Job Completed - PDFs Generated');
            showGlobalNotification(`‚úÖ JOB COMPLETED #${job.jobNum}\n${job.client} ‚Ä¢ ${job.totalParts} parts`, '#e8f5e9', '#34c759');
            
            // Re-render ALL views to show completion
            renderHistory();
            renderJobTasks();
            renderScheduleCalendar();
        }
    }
    
    // Kept for backwards compatibility but calls new function
    function completeJobBatch(index) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const jobAtIndex = history[index];
        if (jobAtIndex) {
            completeJobById(jobAtIndex.jobNum, jobAtIndex.dateReceived, jobAtIndex.client);
        }
    }

    // Toggle job completion by job identifiers (used by buttons in history)
    function toggleJobCompleteById(jobNum, dateReceived, client) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        // Find job by unique identifiers
        const jobIdx = history.findIndex(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
        
        if (jobIdx < 0) {
            console.error('‚ùå Job not found:', jobNum, dateReceived, client);
            notify('‚ö†Ô∏è Error: Job not found');
            return;
        }
        
        const job = history[jobIdx];
        
        if (confirm(`Unmark Job #${job.jobNum} as complete?\n\nThis will reopen the job for re-work.`)) {
            job.completed = false;
            job.completedDate = null;
            history[jobIdx] = job;
            localStorage.setItem('jobHistory', JSON.stringify(history));
            
            console.log(`üìã Job #${job.jobNum} unmarked as complete`);
            
            notify('üîÑ Job reopened - now active again');
            showGlobalNotification(`üîÑ JOB REOPENED #${job.jobNum}\n${job.client} ‚Ä¢ ${job.totalParts} parts`, '#fff3cd', '#ff9800');
            
            // Sync to Firebase
            if (window.syncJobsToFirebase) {
                try {
                    window.syncJobsToFirebase();
                    console.log('üîÑ Synced to Firebase');
                } catch(e) {
                    console.error('Firebase sync error:', e);
                }
            }
            
            notify('üîÑ Job reopened - now active again');
            
            // Show GLOBAL RED NOTIFICATION for reactivation
            showGlobalReactivationAlert(job);
            
            // Refresh the view
            renderHistory();
        }
    }

    // Show global red notification when job is reactivated
    function showGlobalReactivationAlert(job) {
        const alertArea = document.getElementById('globalNotifications');
        if (!alertArea) {
            console.log('Global notifications area not found (user not on Schedule tab)');
            return;
        }
        
        const alertId = `reactivation-${job.jobNum}-${Date.now()}`;
        
        // Remove "no notifications yet" placeholder if it exists
        const placeholder = alertArea.querySelector('p');
        if (placeholder) placeholder.remove();
        
        const alertHTML = `
            <div id="${alertId}" style="background:#ff3b30; color:#fff; padding:12px; border-radius:8px; font-weight:900; font-size:12px; margin-bottom:8px; transition:all 0.3s ease;">
                üö® JOB #${job.jobNum} REACTIVATED
            </div>
        `;
        
        alertArea.insertAdjacentHTML('beforeend', alertHTML);
        
        // Strike through after 10 seconds
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.textDecoration = 'line-through';
                alert.style.opacity = '0.5';
                alert.style.background = '#ff3b3080';
            }
        }, 10000);
        
        // Remove after 20 seconds
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(() => {
                    alert.remove();
                    // If no more alerts, show placeholder
                    if (alertArea.children.length === 0) {
                        alertArea.innerHTML = '<p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p>';
                    }
                }, 500);
            }
        }, 20000);
    }

    function generateBatchPDFs(job) {
        // Check if jsPDF is loaded
        if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
            notify('‚ùå PDF library not loaded. Please refresh the page.');
            console.error('jsPDF not available at window.jspdf');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Get job items for reference
        const items = job.items || [];
        
        // Create a zip-like multi-page document with all forms
        
        // Add logo at top
        const logoBase64 = 'data:image/jpeg;base64,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';
        try {
            doc.addImage(logoBase64, 'JPEG', 10, 10, 30, 28);
        } catch(e) {
            console.log('Logo add skipped');
        }
        
        let y = 50;
        doc.setFontSize(10);
        doc.text(`Job #: ${job.jobNum}`, 20, y);
        y += 5;
        doc.text(`Client: ${job.client}`, 20, y);
        y += 5;
        doc.text(`Job: ${job.jobName}`, 20, y);
        y += 5;
        doc.text(`Date: ${job.dateReceived || 'N/A'}`, 20, y);
        y += 10;
        
        // Parts table
        doc.setFontSize(9);
        const headers = ['Description', 'H√óW', 'Qty', 'Profile', 'Mode', 'SQM'];
        const colWidths = [50, 25, 15, 40, 20, 25];
        let x = 20;
        
        doc.setFillColor(0, 0, 0);
        doc.setTextColor(255, 255, 255);
        headers.forEach((h, i) => {
            doc.text(h, x, y);
            x += colWidths[i];
        });
        y += 8;
        doc.setTextColor(0, 0, 0);
        
        let totalSqm = 0;
        items.forEach(it => {
            x = 20;
            const rowSqm = parseFloat(it.sqm) * it.qty;
            totalSqm += rowSqm;
            
            doc.text(it.desc.substring(0, 20), x, y); x += colWidths[0];
            doc.text(`${it.h}√ó${it.w}`, x, y); x += colWidths[1];
            doc.text(it.qty.toString(), x, y); x += colWidths[2];
            doc.text(it.prof.substring(0, 15), x, y); x += colWidths[3];
            doc.text(it.mode, x, y); x += colWidths[4];
            doc.text(rowSqm.toFixed(3), x, y);
            
            y += 8;
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
        });
        
        y += 5;
        doc.setFontSize(11);
        doc.text(`Total SQM (m¬≤): ${totalSqm.toFixed(3)}`, 20, y);
        doc.text(`Total Parts: ${items.length}`, 20, y + 10);
        
        // ===== PAGE 2: SUPPLY DOCKET =====
        doc.addPage();
        y = 20;
        doc.setFontSize(18);
        doc.text('SUPPLY DOCKET', 20, y);
        y += 10;
        doc.setFontSize(10);
        doc.text(`Client: ${job.client}`, 20, y);
        y += 5;
        doc.text(`Job #: ${job.jobNum} - ${job.jobName}`, 20, y);
        y += 5;
        doc.text(`Paint: ${job.brand} - ${job.color}`, 20, y);
        y += 5;
        doc.text(`Code: ${job.code} | Finish: ${job.finish}`, 20, y);
        y += 10;
        
        doc.setFontSize(9);
        x = 20;
        doc.setFillColor(0, 0, 0);
        doc.setTextColor(255, 255, 255);
        headers.forEach((h, i) => {
            doc.text(h, x, y);
            x += colWidths[i];
        });
        y += 8;
        doc.setTextColor(0, 0, 0);
        
        items.forEach(it => {
            x = 20;
            const rowSqm = parseFloat(it.sqm) * it.qty;
            
            doc.text(it.desc.substring(0, 20), x, y); x += colWidths[0];
            doc.text(`${it.h}√ó${it.w}`, x, y); x += colWidths[1];
            doc.text(it.qty.toString(), x, y); x += colWidths[2];
            doc.text(it.prof.substring(0, 15), x, y); x += colWidths[3];
            doc.text(it.mode, x, y); x += colWidths[4];
            doc.text(rowSqm.toFixed(3), x, y);
            
            y += 8;
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
        });
        
        // ===== PAGE 3: MIXING CARD =====
        doc.addPage();
        y = 20;
        doc.setFontSize(18);
        doc.text('MIXING CARD - PAINT SHOP', 20, y);
        y += 12;
        doc.setFontSize(11);
        doc.text(`Brand: ${job.brand}`, 20, y);
        y += 6;
        doc.text(`Color: ${job.color}`, 20, y);
        y += 6;
        doc.text(`Code/Formula: ${job.code}`, 20, y);
        y += 6;
        doc.text(`Finish: ${job.finish}`, 20, y);
        y += 12;
        
        doc.setFontSize(9);
        doc.text(`Total SQM (m¬≤) Required: ${totalSqm.toFixed(3)}`, 20, y);
        y += 6;
        doc.text(`Jobs/Items: ${items.length}`, 20, y);
        y += 10;
        
        doc.setFontSize(10);
        doc.text(`Date: ${new Date().toLocaleDateString('en-AU')}`, 20, y);
        y += 6;
        doc.text(`Prepared by: ___________________`, 20, y);
        y += 6;
        doc.text(`Mixed by: ___________________`, 20, y);
        
        // Save combined PDF to localStorage instead of auto-download
        const filename = `Job_${job.jobNum}_${job.client.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        
        // Store PDF in localStorage or just skip auto-download
        try {
            const pdfData = doc.output('datauristring');
            // Could store in localStorage if needed, but for now just acknowledge it's ready
        } catch(e) {
        }
    }

    function alertAdmins(job) {
        const adminAlert = {
            timestamp: new Date().toISOString(),
            type: 'JOB_COMPLETED',
            jobNum: job.jobNum,
            jobName: job.jobName,
            client: job.client,
            totalSqm: job.totalSqm,
            totalParts: job.totalParts,
            completedDate: new Date().toLocaleString('en-AU'),
            message: `üéâ Job #${job.jobNum} (${job.jobName}) for ${job.client} has been COMPLETED. ${job.totalParts} parts, ${job.totalSqm} SQM (m¬≤). PDFs generated.`
        };
        
        // Store admin alerts in localStorage
        let adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        adminAlerts.unshift(adminAlert);
        adminAlerts = adminAlerts.slice(0, 100); // Keep last 100 alerts
        localStorage.setItem('adminAlerts', JSON.stringify(adminAlerts));
        
        // In a real app, this would send to a server/notification service
        
        // Show toast-style notification
        showAdminAlert(adminAlert.message);
    }
    
    // Generic function for all notification types
    function addAdminAlert(type, message, details = {}) {
        const adminAlert = {
            timestamp: new Date().toISOString(),
            type: type,
            message: message,
            ...details
        };
        let adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        adminAlerts.unshift(adminAlert);
        adminAlerts = adminAlerts.slice(0, 100);
        localStorage.setItem('adminAlerts', JSON.stringify(adminAlerts));
        showAdminAlert(message);
    }

    function showAdminAlert(message) {
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = 'position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:#34c759; color:#fff; padding:15px 25px; border-radius:30px; font-weight:900; z-index:4000; font-size:12px; border:2px solid #28a745; box-shadow:0 4px 15px rgba(52, 199, 89, 0.4);';
        alertDiv.innerText = message;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 4000);
    }

    function toggleAdminAlerts() {
        const container = document.getElementById('admin-alerts-container');
        const btn = event.target;
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btn.innerText = '‚àí';
        } else {
            container.style.display = 'none';
            btn.innerText = '+';
        }
    }

    function renderAdminAlerts() {
        const adminAlertsDiv = document.getElementById('admin-alerts');
        if (!adminAlertsDiv) return;
        
        const alerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        
        if (alerts.length === 0) {
            adminAlertsDiv.innerHTML = '<div class="card"><p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p></div>';
            return;
        }
        
        adminAlertsDiv.innerHTML = '';
        alerts.forEach((alert, i) => {
            const alertDate = new Date(alert.timestamp);
            let icon = 'üìå';
            let bgColor = '#f0f0f0';
            let borderColor = '#999';
            
            if (alert.type === 'JOB_COMPLETED') {
                icon = '‚úÖ';
                bgColor = '#f0fdf4';
                borderColor = '#34c759';
            } else if (alert.type === 'JOB_SAVED') {
                icon = '‚úÖ';
                bgColor = '#f0fdf4';
                borderColor = '#34c759';
            } else if (alert.type === 'JOB_UPDATED') {
                icon = '‚úèÔ∏è';
                bgColor = '#fffbf0';
                borderColor = '#ffc107';
            } else if (alert.type === 'NEW_CLIENT') {
                icon = 'üë§';
                bgColor = '#f0fdf4';
                borderColor = '#34c759';
            } else if (alert.type === 'CLIENT_DELETED') {
                icon = 'üóëÔ∏è';
                bgColor = '#fdf0f0';
                borderColor = '#ff3b30';
            } else if (alert.type === 'PROFILE_ADDED') {
                icon = 'üö™';
                bgColor = '#fff3e0';
                borderColor = '#ff9800';
            }
            
            adminAlertsDiv.innerHTML += `<div class="card" style="border-left:5px solid ${borderColor}; background:${bgColor}; margin-bottom:10px;">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                    <div style="flex:1;">
                        <div style="font-weight:900; color:#000; font-size:13px;">${icon} ${alert.message}</div>
                    </div>
                    <div style="font-size:10px; color:#888; font-weight:700; text-align:right; white-space:nowrap; margin-left:10px;">
                        <div>${alertDate.toLocaleDateString('en-AU')}</div>
                        <div>${alertDate.toLocaleTimeString('en-AU', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                </div>
            </div>`;
        });
    }

    function refreshLists() {
        console.log(`üîÑ REFRESHING LISTS (refreshLists called)`);
        console.log(`  Current profiles array:`, profiles);
        console.log(`  profiles.length = ${profiles.length}`);
        
        const cliSel = document.getElementById('cli'); 
        console.log(`  ‚úì Found cli dropdown element`);
        cliSel.innerHTML = '';
        clients.sort().forEach(c => { 
            let o = document.createElement('option'); 
            o.innerText=c; 
            cliSel.appendChild(o); 
        });
        console.log(`  ‚úì Populated cli with ${clients.length} clients`);
        
        const profSel = document.getElementById('prof-select'); 
        if (!profSel) {
            console.error('  ‚úó CRITICAL: prof-select element NOT FOUND!');
            return;
        }
        console.log(`  ‚úì Found prof-select dropdown element`);
        
        profSel.innerHTML = '';
        console.log(`  Clearing prof-select... adding ${profiles.length} profiles:`);
        
        if (profiles.length === 0) {
            console.warn('  ‚ö†Ô∏è WARNING: profiles array is EMPTY!');
        }
        
        profiles.forEach((p, idx) => { 
            console.log(`    [${idx}] Adding option: "${p}"`);
            let o = document.createElement('option'); 
            o.value=p; 
            o.innerText=p; 
            profSel.appendChild(o); 
        });
        
        // Set default door profile to first available
        if (profSel.options.length > 0) {
            profSel.value = profSel.options[0].value;
        }
        
        console.log(`  ‚úì Final prof-select count: ${profSel.options.length} options`);
        
        if (profSel.options.length === 0 && profiles.length > 0) {
            console.error('  ‚úó CRITICAL ERROR: profiles.length=${profiles.length} but prof-select has 0 options!');
        }
        
        renderDB();
        console.log(`  ‚úì renderDB() called`);
    }

    function tab(t) {
        document.querySelectorAll('.view-section, .nav-btn').forEach(x => x.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.getElementById('btn-' + t).classList.add('active');
        
        // Show/hide version display - only in admin tab
        const versionDisplay = document.getElementById('footerVersionDisplay');
        if (versionDisplay) {
            versionDisplay.style.display = (t === 'admin') ? 'block' : 'none';
        }
        
        // Show/hide workload summary based on active tab
        const workloadContainer = document.getElementById('workloadSummaryContainer');
        if (workloadContainer) {
            if (t === 'schedule' || t === 'admin') {
                workloadContainer.style.display = 'block';
            } else {
                workloadContainer.style.display = 'none';
            }
        }
        
        // Render admin alerts when viewing admin tab
        if (t === 'admin') {
            renderAdminAlerts();
        }
        
        // Render schedule calendar and jobs chart when viewing schedule tab
        if (t === 'schedule') {
            renderScheduleCalendar();
            renderGanttChart();
        }
        
        // ALWAYS update workload summary when switching to schedule or admin tabs
        if (t === 'schedule' || t === 'admin') {
            renderJobTasks();
            console.log('üîÑ Updated workload summary for tab: ' + t);
        }
    }

    function subTab(t) {
        document.querySelectorAll('.sub-section').forEach(x => x.style.display = 'none');
        document.querySelectorAll('.sub-btn').forEach(x => x.classList.remove('active'));
        document.getElementById('sub-' + t).style.display = 'block';
        document.getElementById('sub-btn-' + t).classList.add('active');
        
        // Special handling for paint tab
        if (t === 'paint') {
            renderPaintFormulaList();
        }
    }

    // DATABASE OPS
    function renderDB() {
        console.log(`üìã renderDB() called`);
        console.log(`  profiles array:`, profiles);
        console.log(`  profiles.length = ${profiles.length}`);
        
        const cL = document.getElementById('list-clients'); 
        if (!cL) {
            console.error('  ‚úó CRITICAL: list-clients element NOT FOUND!');
            return;
        }
        cL.innerHTML = '';
        clients.sort().forEach((c, i) => { 
            cL.innerHTML += `<div class="db-item"><span>${c}</span></div>`; 
        });
        console.log(`  ‚úì Rendered ${clients.length} clients`);
        
        const pL = document.getElementById('list-profiles'); 
        if (!pL) {
            console.error('  ‚úó CRITICAL: list-profiles element NOT FOUND!');
            return;
        }
        pL.innerHTML = '';
        console.log(`  Rendering ${profiles.length} profiles...`);
        
        if (profiles.length === 0) {
            console.warn('  ‚ö†Ô∏è profiles array is EMPTY! Will show empty list');
            pL.innerHTML = '<p style="color:#999; text-align:center; font-size:11px;">No profiles yet. Add one above.</p>';
        } else {
            profiles.sort().forEach((p, i) => { 
                console.log(`    [${i}] Rendering: "${p}"`);
                pL.innerHTML += `<div class="db-item" style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="flex:1;">${p}</span>
                    <button onclick="editProfile('${p}')" style="padding:2px 8px; background:#2196f3; color:#fff; border:none; border-radius:3px; font-size:9px; font-weight:900; cursor:pointer; margin-right:4px;">EDIT</button>
                </div>`; 
            });
            console.log(`  ‚úì Rendered all ${profiles.length} profiles to DOM`);
        }
    }

    function addClient() { 
        let v = document.getElementById('new-client').value.trim(); 
        if(v && !clients.includes(v)){ 
            clients.push(v); 
            document.getElementById('new-client').value=''; 
            refreshLists();
            addAdminAlert('NEW_CLIENT', `‚úÖ NEW CLIENT ADDED: "${v}"`, {clientName: v});
        } else if (clients.includes(v)) {
            notify('Client Already Exists');
        }
    }
    
    function delCli(name) { 
        if(confirm("Delete " + name + "?")){ 
            clients = clients.filter(x => x !== name); 
            refreshLists();
            notify('Client Deleted');
        } 
    }
    
    function addProfile() { 
        let v = document.getElementById('new-profile').value.trim(); 
        console.log(`üö™ Adding new profile: "${v}"`);
        if(v && !profiles.includes(v)){ 
            profiles.push(v); 
            console.log(`  ‚úì Added to profiles array. Total: ${profiles.length}`);
            console.log(`  Current profiles:`, profiles);
            
            saveProfilesToStorage(); // SAVE TO LOCALSTORAGE
            console.log(`  ‚úì Saved to localStorage`);
            
            document.getElementById('new-profile').value=''; 
            refreshLists();
            console.log(`  ‚úì Refreshed lists (dropdown should update)`);
            
            // Show global notification in red
            addAdminAlert('PROFILE_ADDED', `üö™ NEW DOOR PROFILE ADDED: "${v}"`, {profileName: v});
            
            // Update unallocated doors in price matrix if visible
            renderPricingMatrix();
            console.log(`  ‚úì Rendered price matrix`);
        } else if (profiles.includes(v)) {
            console.log(`  ‚úó Door already exists in profiles`);
            notify('Profile Already Exists');
        } else {
            console.log(`  ‚úó Empty input`);
        }
    }
    
    function delProf(name) { 
        console.log(`üóëÔ∏è DATABASE TAB DELETE BUTTON CLICKED for: ${name}`);
        if(confirm(`üö® PERMANENTLY DELETE: "${name}"?\n\nThis will remove it from your database!`)){ 
            console.log(`  ‚úì User confirmed deletion from database`);
            profiles = profiles.filter(x => x !== name); 
            saveProfilesToStorage();
            console.log(`  ‚úì Removed from profiles. Now ${profiles.length} items`);
            refreshLists();
            notify(`üóëÔ∏è ${name} deleted from database`);
        } else {
            console.log(`  ‚úó Deletion cancelled`);
        }
    }
    
    function editProfile(oldName) {
        const newName = prompt(`Rename profile:\n\n${oldName}`, oldName);
        if (newName && newName.trim() !== '') {
            const trimmed = newName.trim();
            if (trimmed === oldName) {
                return; // No change
            }
            if (profiles.includes(trimmed)) {
                alert('Profile name already exists');
                return;
            }
            profiles = profiles.map(p => p === oldName ? trimmed : p);
            refreshLists();
            notify('Profile Renamed');
        }
    }

    function setFM(v) {
        fmState = v;
        document.querySelectorAll('.fm-opt').forEach(o => o.classList.remove('active'));
        document.getElementById(v==='Flat'?'fm-flat':'fm-mould').classList.add('active');
        up();
    }

    function setP(t) {
        pType = t;
        document.querySelectorAll('.p-card').forEach(c => c.classList.remove('active'));
        const map = {'Panel':'pP', 'Door':'pD', 'Drawer':'pDr', 'Custom':'pC'};
        document.getElementById(map[t]).classList.add('active');
        const allE = ['E1','E2','E3','E4'];
        allE.forEach(id => document.getElementById(id).classList.remove('active'));
        if(t === 'Door' || t === 'Drawer') allE.forEach(id => document.getElementById(id).classList.add('active'));
        else if (mode === 'SE') document.getElementById('E1').classList.add('active');
        up();
    }

    function setM(m) {
        mode = m;
        document.querySelectorAll('.mode-sel').forEach(b => b.classList.remove('active'));
        document.getElementById('m' + m).classList.add('active');
        // REQUIREMENT: SE auto-selects one long edge by default
        if (m === 'SE') {
            document.getElementById('E1').classList.add('active'); 
        }
        up();
    }
    
    function tE(el) { 
        el.classList.toggle('active'); 
        up(); 
    }

    function up() {
        const h = parseFloat(document.getElementById('h').value) || 0;
        const w = parseFloat(document.getElementById('w').value) || 0;
        const thk = parseFloat(document.getElementById('thk').value) || 18;
        const eL = (document.getElementById('E1').classList.contains('active')?1:0) + (document.getElementById('E2').classList.contains('active')?1:0);
        const eS = (document.getElementById('E3').classList.contains('active')?1:0) + (document.getElementById('E4').classList.contains('active')?1:0);
        let area = (h * w);
        if(mode === 'DS') area *= 2;
        const defaults = loadDefaultSettings();
        if(mode === 'SE') area += ((eL * h) + (eS * w)) * defaults.seReturn;
        area += ((eL * h * thk) + (eS * w * thk));
        if (document.getElementById('liveSq')) document.getElementById('liveSq').innerText = (area / 1000000).toFixed(3);
    }

    function addPart() {
        const h = document.getElementById('h').value;
        const w = document.getElementById('w').value;
        const prof = document.getElementById('prof-select').value;
        const desc = document.getElementById('desc').value || "Part";
        
        if(!h || !w) return;
        const edges = [
            document.getElementById('E1').classList.contains('active'),
            document.getElementById('E2').classList.contains('active'),
            document.getElementById('E3').classList.contains('active'),
            document.getElementById('E4').classList.contains('active')
        ];
        // REQUIREMENT: Deduplication (Add 1 to existing if identical)
        let existing = items.find(it => 
            it.h === h && it.w === w && it.prof === prof && 
            it.fm === fmState && it.mode === mode && 
            JSON.stringify(it.e) === JSON.stringify(edges)
        );
        if (existing) {
            existing.qty += (parseInt(document.getElementById('qty').value) || 1);
            notify("Qty Updated");
        } else {
            const liveSqElement = document.getElementById('liveSq');
            const sqmValue = liveSqElement ? liveSqElement.innerText : '0.000';
            
            items.push({
                h, w, qty: (parseInt(document.getElementById('qty').value) || 1),
                desc: desc.toUpperCase(), prof: prof, fm: fmState,
                mode: mode, e: edges, sqm: sqmValue,
                brand: document.getElementById('p-brand').value,
                color: document.getElementById('p-color').value,
                code: document.getElementById('p-code').value,
                finish: document.getElementById('p-finish').value,
                type: pType,
                thk: document.getElementById('thk').value
            });
            notify("Part Added");
        }
        render();
        saveData(); // Auto-save to LocalStorage
        
        // Reset for next entry: qty back to 1, clear other fields
        document.getElementById('qty').value = '1';
        document.getElementById('h').value = ''; 
        document.getElementById('w').value = '';
        document.getElementById('desc').value = '';
        const defaults = loadDefaultSettings();
        document.getElementById('thk').value = defaults.thickness;  // Reset to default thickness
        
        // Focus on length (h) input for continuous data entry
        setTimeout(() => {
            const hInput = document.getElementById('h');
            if (hInput) hInput.focus();
        }, 50);
    }

    function filterPanels(filterType) {
        currentPanelFilter = filterType;
        
        // Update button styles - restore from data attributes
        const clickedBtn = event.target.tagName === 'BUTTON' ? event.target : event.target.closest('button');
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            // Restore original colors from data attributes
            const originalBg = btn.getAttribute('data-bg');
            const originalColor = btn.getAttribute('data-color');
            btn.style.background = originalBg;
            btn.style.color = originalColor;
            btn.style.fontWeight = '900';
        });
        
        if (clickedBtn) {
            // Clicked button gets highlighted with blue
            clickedBtn.style.background = '#2196f3';
            clickedBtn.style.color = '#fff';
            clickedBtn.style.fontWeight = '900';
        }
        
        render(); // Re-render with filter applied
    }

    function render() {
        const l = document.getElementById('list');
        if (!l) return; // Exit if list doesn't exist (not on measure tab)
        
        l.innerHTML = '';
        let tA = 0, tQ = 0;
        
        // Apply filter to items
        let filteredItems = items;
        if (currentPanelFilter !== 'all') {
            filteredItems = items.filter(it => {
                const filter = currentPanelFilter.toLowerCase();
                
                // Type filters: check it.type field (Door, Panel, Drawer, Custom)
                if (filter === 'panel' || filter === 'door' || filter === 'drawer' || filter === 'custom') {
                    return it.type.toLowerCase() === filter;
                } 
                // Finish filters: check it.fm field (Moulded, Flat)
                else if (filter === 'moulded' || filter === 'flat') {
                    return it.fm.toLowerCase() === filter;
                } 
                // Mode filters: check it.mode field (SS, DS, SE)
                else if (filter === 'ss' || filter === 'ds' || filter === 'se') {
                    return it.mode === filter.toUpperCase();
                }
                return true;
            });
        }
        
        filteredItems.forEach((it, i) => {
            const originalIndex = items.indexOf(it);
            const rowSqm = parseFloat(it.sqm) * it.qty; 
            tA += rowSqm; 
            tQ += it.qty;
            
            // Get color for panel type
            const typeColors = {
                'panel': '#34c759',
                'door': '#ff9500',
                'drawer': '#2196f3',
                'custom': '#af52de'
            };
            const clr = typeColors[it.type.toLowerCase()] || '#666';
            
            // Count edges properly
            const leftEdgeCount = (it.e[0]?1:0) + (it.e[1]?1:0);  // E1=Top-Left, E2=Bottom-Left
            const sideEdgeCount = (it.e[2]?1:0) + (it.e[3]?1:0);  // E3=Top-Right, E4=Bottom-Right
            
            let mC = it.mode === 'SS' ? '#34c759' : (it.mode === 'DS' ? '#ff9500' : '#ff3b30');
            
            // Build edge badges - SEPARATE and COLORED with LR/SR for SE mode
            let edgeBadgesHTML = '';
            if (leftEdgeCount > 0) {
                const leftLabel = it.mode === 'SE' ? 'LR' : 'L';
                edgeBadgesHTML += `<span class="edge-pill" style="background:#f44336; color:#fff; font-weight:900; padding:2px 6px; border-radius:3px; font-size:10px;">${leftEdgeCount}${leftLabel}</span>`;
            }
            if (sideEdgeCount > 0) {
                const sideLabel = it.mode === 'SE' ? 'SR' : 'S';
                edgeBadgesHTML += `<span class="edge-pill" style="background:#2196f3; color:#fff; font-weight:900; padding:2px 6px; border-radius:3px; font-size:10px;">${sideEdgeCount}${sideLabel}</span>`;
            }
            if (leftEdgeCount === 0 && sideEdgeCount === 0) {
                edgeBadgesHTML += `<span class="edge-pill" style="background:#eee; color:#999; padding:2px 6px; border-radius:3px; font-size:10px;">No edges</span>`;
            }
            
            l.innerHTML += `<div class="part-label" style="border-left:5px solid ${clr}">
                <div class="qty-controls">
                    <button class="qty-btn" style="border-radius:4px 4px 0 0;" onclick="changeQty(${originalIndex}, 1)">+</button>
                    <div class="pl-qty" style="margin:0; border-radius:0;">${it.qty}</div>
                    <button class="qty-btn" style="border-radius:0 0 4px 4px;" onclick="changeQty(${originalIndex}, -1)">‚àí</button>
                </div>
                <div class="pl-center">
                    <div style="font-size:10px; font-weight:900; color:${clr}; text-transform:uppercase; line-height:1;">${it.desc} (${it.fm})</div>
                    <div style="font-size:10px; font-weight:700; color:#666; margin-bottom:2px;">${it.brand} - ${it.color} ‚Ä¢ ${it.finish}</div>
                    <div class="pl-dims">${it.h} √ó ${it.w} √ó ${it.thk}</div>
                    <div class="pl-meta">
                        <span style="font-weight:700; background:${clr}; color:#fff; padding:2px 6px; border-radius:3px; font-size:9px; text-transform:uppercase;">${it.type}</span>
                        <span style="font-weight:700;">${it.prof}</span>
                        <div style="display:flex; gap:4px; margin-top:4px;">
                            ${edgeBadgesHTML}
                        </div>
                    </div>
                </div>
                <div class="pl-right">
                    <div class="pl-mode" style="color:${mC}; border-color:${mC}; background:${mC}15">${it.mode}</div>
                    <div style="font-size:11px; font-weight:900;">${rowSqm.toFixed(3)}</div>
                </div>
                <button class="del-btn" onclick="deleteItem(${originalIndex})">√ó</button>
            </div>`;
        });
        
        if (document.getElementById('tA')) document.getElementById('tA').innerText = tA.toFixed(3);
        if (document.getElementById('tQ')) document.getElementById('tQ').innerText = tQ;
    }

    function changeQty(index, delta) { 
        try {
            if (index < 0 || index >= items.length) {
                console.error('Invalid item index:', index);
                return;
            }
            items[index].qty += delta; 
            if (items[index].qty < 1) items[index].qty = 1; 
            render();
            saveData();
        } catch(e) {
            console.error('Error changing quantity:', e);
            notify('‚ö†Ô∏è Error updating quantity');
        }
    }

    function deleteItem(index) {
        try {
            if (index < 0 || index >= items.length) {
                console.error('Invalid item index:', index);
                return;
            }
            items.splice(index, 1);
            render();
            saveData();
            notify('Part Removed');
        } catch(e) {
            console.error('Error deleting item:', e);
            notify('‚ö†Ô∏è Error deleting part');
        }
    }

    function notify(m) { 
        const t = document.getElementById('toast');
        if (!t) return; // Exit if toast doesn't exist
        t.innerText = m; 
        t.style.display = 'block'; 
        setTimeout(()=>t.style.display='none', 1500); 
    }
    
    // Update job history and send notification
    function updateJobHistory(history, jobIndex, notificationMessage = null) {
        if (!history || jobIndex === null || jobIndex < 0 || jobIndex >= history.length) return;
        
        const job = history[jobIndex];
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        // Auto-generate notification if not provided
        if (notificationMessage === null) {
            notificationMessage = `‚úèÔ∏è JOB UPDATED #${job.jobNum}\n${job.client} ‚Ä¢ ${job.totalParts} parts`;
        }
        
        // Send global notification
        if (notificationMessage) {
            showGlobalNotification(notificationMessage, '#e3f2fd', '#2196f3');
        }
        
        console.log(`üìù Job #${job.jobNum} updated and saved to history`);
    }
    
    // Show global notification in visible banner (on all tabs)
    function showGlobalNotification(message, bgColor = '#ffebee', borderColor = '#ff3b30') {
        const banner = document.getElementById('globalNotificationsBanner');
        const notifList = document.getElementById('globalNotificationsList');
        
        if (!banner || !notifList) {
            console.warn('Global notifications banner not found');
            return;
        }
        
        // Show banner
        banner.style.display = 'block';
        
        const notifDiv = document.createElement('div');
        notifDiv.style.cssText = `
            background: ${bgColor};
            border-left: 5px solid ${borderColor};
            border-radius: 6px;
            padding: 14px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            font-size: 13px;
            color: #222;
            font-weight: 900;
            white-space: pre-line;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        `;
        
        const messageSpan = document.createElement('div');
        messageSpan.style.flex = '1';
        messageSpan.innerText = message;
        
        const dismissBtn = document.createElement('button');
        dismissBtn.innerText = '‚úï';
        dismissBtn.style.cssText = `
            background: ${borderColor};
            color: #fff;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 900;
            margin-left: 8px;
            font-size: 12px;
        `;
        dismissBtn.onclick = () => {
            notifDiv.remove();
            if (notifList.children.length === 0) {
                banner.style.display = 'none';
            }
        };
        
        // Auto-dismiss after 8 seconds
        setTimeout(() => {
            if (notifDiv.parentElement) {
                notifDiv.remove();
                if (notifList.children.length === 0) {
                    banner.style.display = 'none';
                }
            }
        }, 8000);
        
        notifDiv.appendChild(messageSpan);
        notifDiv.appendChild(dismissBtn);
        notifList.appendChild(notifDiv);
        
        console.log('‚úÖ Global notification shown:', message);
    }

    function getProfilePrice(profileName) {
        if (!pricingMatrix || pricingMatrix.length === 0) return 0;
        const row = pricingMatrix.find(p => p.profile === profileName);
        return (row && row.satin) ? parseFloat(row.satin) || 0 : 0;
    }

    function calculateLinePrice(item) {
        let pricePerSqm = 125;
        if (item.fm === 'Moulded' && item.mld) {
            const profilePrice = getProfilePrice(item.mld);
            if (profilePrice > 0) pricePerSqm = profilePrice;
        }
        const sqm = parseFloat(item.sqm) || 0;
        const qty = parseInt(item.qty) || 1;
        return {
            pricePerSqm: pricePerSqm,
            lineCost: sqm * qty * pricePerSqm
        };
    }

    // ===== ESTIMATE COSTING CALCULATIONS =====
    function calculateLinePrice(item) {
        const qty = parseInt(item.qty) || 1;
        const sqmPerPart = parseFloat(item.sqm) || 0;
        const totalSqm = sqmPerPart * qty;
        
        let pricePerSqm = 125; // Default flat panel price
        
        // Check if moulded and get profile price from localStorage
        if (item.fm === 'Moulded' && item.mld) {
            try {
                const pricingData = JSON.parse(localStorage.getItem('pricingMatrix')) || {};
                const profileName = item.mld;
                
                // Look for the profile in pricing data
                if (pricingData[profileName]) {
                    // Use satin price as default (can be made dynamic based on gloss level)
                    pricePerSqm = parseFloat(pricingData[profileName].satin) || 125;
                }
            } catch(e) {
                console.warn('Error reading pricing data:', e);
            }
        } else {
            // Flat panel = $125/sqm
            pricePerSqm = 125;
        }
        
        const lineCost = totalSqm * pricePerSqm;
        
        return {
            pricePerSqm: pricePerSqm,
            lineCost: lineCost,
            totalSqm: totalSqm
        };
    }

    function genForm(type) {
        try {
            if (items.length === 0) {
                notify('‚ùå Add parts first');
                return;
            }
            
            // Check if jsPDF is loaded
            if (!window.jspdf || typeof window.jspdf.jsPDF === 'undefined') {
                notify('‚ùå PDF library not loaded. Please refresh the page.');
                console.error('jsPDF not available');
                return;
            }
            
            // Use PaintWorkzEngine for PDF generation
            if (type === 'Estimate' || type === 'Quote Form') {
                PaintWorkzEngine.generatePDF(type, items);
                notify(`‚úì ${type} PDF generated`);
            } else if (type === 'Supply Docket') {
                genSupplyDocket();
            } else if (type === 'Mixing Card') {
                genMixingCard();
            } else if (type === 'Invoice') {
                genInvoice();
            } else {
                notify('Form type not yet implemented');
            }
        } catch(error) {
            console.error('‚ùå PDF Generation Error:', error);
            notify('PDF Error: ' + error.message);
        }
    }
    
    // ===== PDF HEADER WITH LOGO HELPER =====
    function addPDFHeader(doc, title, logoBase64) {
        try {
            doc.addImage(logoBase64, 'JPEG', 10, 8, 25, 23);
        } catch(e) {}
        
        let y = 45;
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text(title, 55, y);
        y += 10;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('Paintworkz', 55, y);
        y += 4;
        doc.text('17 West Boundary Road, Hamilton 3300 VIC', 55, y);
        y += 4;
        doc.text('Phone: 0438 803 032', 55, y);
        y += 4;
        doc.text('Email: paint_workz@outlook.com', 55, y);
        y += 8;
        
        return y;
    }

    // ===== SUPPLY DOCKET =====
    function genMixingCard() {
    try {
        if (!window.jspdf || !window.jspdf.jsPDF) {
            notify('‚ùå PDF library loading... Please wait');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const job = window.currentJob || {};
        const paintColor = job.paintColor || 'Color TBD';
        
        doc.setFontSize(16);
        doc.text('MIXING CARD', 20, 20);
        
        doc.setFontSize(12);
        doc.text('Paint Colour: ' + paintColor, 20, 40);
        
        doc.setFontSize(10);
        doc.text('Date: ' + new Date().toLocaleDateString(), 20, 60);
        doc.text('Job ID: ' + (job.jobId || 'N/A'), 20, 75);
        
        doc.text('Mix Instructions: (To be added)', 20, 100);
        doc.text('Volume: (To be calculated)', 20, 115);
        
        doc.save(`MixingCard_${paintColor.replace(/\s/g, '_')}.pdf`);
        notify('‚úì Mixing Card downloaded');
        
    } catch(err) {
        console.error('Mixing card error:', err);
        notify('‚ùå Error: ' + err.message);
    }
}

    // ===== INVOICE (stub) =====
    function genInvoice() {
    try {
        if (!window.jspdf || !window.jspdf.jsPDF) {
            notify('‚ùå PDF library loading...');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const job = window.currentJob || {};
        
        doc.setFontSize(16);
        doc.text('INVOICE', 20, 20);
        
        doc.setFontSize(10);
        doc.text('Invoice #: (Auto-generated)', 20, 40);
        doc.text('Job ID: ' + (job.jobId || 'N/A'), 20, 50);
        doc.text('Date: ' + new Date().toLocaleDateString(), 20, 60);
        
        doc.text('Services:', 20, 80);
        doc.text('Painting services: TBD', 25, 90);
        
        doc.text('Total: $0.00', 20, 110);
        
        doc.save(`Invoice_${job.jobId || 'Job'}.pdf`);
        notify('‚úì Invoice downloaded');
        
    } catch(err) {
        console.error('Invoice error:', err);
        notify('‚ùå Error: ' + err.message);
    }
}

    // ===== QUOTE FORM (stub) =====
    function genQuoteForm() {
        if (items.length === 0) {
            notify('‚ùå Add parts first');
            return;
        }
        PaintWorkzEngine.generatePDF('Quote', items);
    }

// Main PDF export function - routes to estimate
function genPDF() {
    genEstimate();
}

    function genEstimate() {
    try {
        // Verify jsPDF is loaded
        if (!window.jspdf || !window.jspdf.jsPDF) {
            notify('‚ùå PDF library loading... Please wait and try again');
            console.error('jsPDF not ready');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Get job data
        const job = window.currentJob || {};
        const items = job.items || [];
        const client = job.client || {};
        
        // Title
        doc.setFontSize(20);
        doc.text('ESTIMATE', 20, 20);
        
        // Company info
        doc.setFontSize(10);
        doc.text('Paintworkz Pro', 20, 35);
        doc.text('17 West Boundary Road, Hamilton 3300 VIC', 20, 42);
        doc.text('Phone: 0438 803 032', 20, 49);
        
        // Client info
        doc.setFontSize(12);
        doc.text('Bill To:', 20, 65);
        doc.setFontSize(10);
        doc.text(client.name || 'Client Name', 20, 73);
        doc.text(client.address || 'Address', 20, 80);
        doc.text(client.phone || 'Phone', 20, 87);
        
        // Items table
        let y = 110;
        doc.setFontSize(10);
        doc.text('ITEMS TO PAINT:', 20, y);
        y += 10;
        
        items.forEach((item, idx) => {
            const text = `${idx + 1}. Qty ${item.qty} - ${item.h}√ó${item.w}√ó${item.thk || 18}mm (${item.fm === 'Moulded' ? item.mld : 'Flat'})`;
            doc.text(text, 25, y);
            y += 8;
        });
        
        // Footer
        doc.setFontSize(8);
        doc.text('This is an estimate only. Final pricing may vary based on site conditions.', 20, doc.internal.pageSize.height - 10);
        
        // Save
        doc.save(`Estimate_${job.jobId || 'Job'}.pdf`);
        notify('‚úì Estimate downloaded');
        console.log('‚úì Estimate PDF generated successfully');
        
    } catch(err) {
        console.error('Estimate generation error:', err);
        notify('‚ùå Error generating estimate: ' + err.message);
    }
}

    function genSupplyDocket() {
        // Check if jsPDF is loaded
        if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
            notify('‚ùå PDF library not loaded. Please refresh the page.');
            console.error('jsPDF not available at window.jspdf');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const logoBase64 = 'data:image/jpeg;base64,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';
        
        try {
            doc.addImage(logoBase64, 'JPEG', 10, 8, 25, 23);
        } catch(e) {}
        
        let y = 45;
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('SUPPLY DOCKET', 55, y);
        y += 10;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('Paintworkz', 55, y);
        y += 3;
        doc.text('17 West Boundary Road, Hamilton 3300 VIC', 55, y);
        y += 3;
        doc.text('Phone: 0438 803 032 | Email: paint_workz@outlook.com', 55, y);
        y += 8;
        
        // Job info
        const jobClient = document.getElementById('cli')?.value || 'N/A';
        const jobNum = document.getElementById('jNum')?.value || document.getElementById('jN')?.value || 'N/A';
        const jobName = document.getElementById('jNm')?.value || 'N/A';
        const doorStyle = document.getElementById('prof')?.value || 'N/A';
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('JOB DETAILS', 15, y);
        y += 7;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Customer: ${jobClient}`, 15, y);
        y += 5;
        doc.text(`Job Name: ${jobName}`, 15, y);
        y += 5;
        doc.text(`Job Number: ${jobNum}`, 15, y);
        y += 5;
        doc.text(`Door Style: ${doorStyle}`, 15, y);
        y += 10;
        
        // Parts list
        doc.setFont(undefined, 'bold');
        doc.setFontSize(10);
        doc.text('PARTS LIST', 15, y);
        y += 8;
        
        // Table header - Single row format
        doc.setFontSize(8);
        doc.setFillColor(220, 220, 220);
        const headers = ['Qty', 'Height', 'Width', 'Moulded', 'Mode', 'Edges', 'Panel Type', 'Mould Type'];
        const colWidths = [12, 20, 20, 15, 14, 18, 20, 25];
        let x = 15;
        
        // Draw header row
        headers.forEach((h, i) => {
            doc.rect(x, y - 4, colWidths[i], 6, 'F');
            doc.setTextColor(0);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(7);
            doc.text(h, x + 1, y, { maxWidth: colWidths[i] - 2, align: 'center' });
            x += colWidths[i];
        });
        y += 7;
        
        // Table rows - Single line per item
        doc.setFont(undefined, 'normal');
        doc.setFontSize(7);
        items.forEach(it => {
            x = 15;
            
            const qty = parseInt(it.qty) || 1;
            const height = it.height || it.h || '‚Äî';
            const width = it.width || it.w || '‚Äî';
            const moulded = (it.moulded || it.type === 'moulded') ? 'Y' : 'N';
            const mode = it.paintMode || it.mode || 'SS';
            const edges = it.edgeText || it.edges || '‚Äî';
            const panelType = it.type || 'Panel';
            const mouldType = it.doorProfile || it.mld || it.fm || '‚Äî';
            
            // Draw cells
            const cellData = [qty, height, width, moulded, mode, edges, panelType, mouldType];
            cellData.forEach((cell, i) => {
                doc.text(String(cell), x + colWidths[i]/2, y, { align: 'center', maxWidth: colWidths[i] - 2 });
                x += colWidths[i];
            });
            
            y += 5;
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
        });
        
        y += 5;
        doc.setFontSize(8);
        doc.text(`Total Items: ${items.length}`, 15, y);
        y += 5;
        doc.text(`Date: ${new Date().toLocaleDateString('en-AU')}`, 15, y);
        
        // Show preview instead of auto-download
        const pdfDataUri = doc.output('datauristring');
        const filename = `SupplyDocket_${jobClient.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        showPDFPreview(pdfDataUri, filename, 'üì¶ Supply Docket Preview');
        notify("‚úì Supply Docket Ready - Review & Download");
    }

    function genMixingCard() {
        // Check if jsPDF is loaded
        if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
            notify('‚ùå PDF library not loaded. Please refresh the page.');
            console.error('jsPDF not available at window.jspdf');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const logoBase64 = 'data:image/jpeg;base64,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';
        
        try {
            doc.addImage(logoBase64, 'JPEG', 10, 8, 25, 23);
        } catch(e) {}
        
        let y = 45;
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('MIXING CARD', 55, y);
        y += 10;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('Paintworkz - Paint Shop Formula', 55, y);
        y += 8;
        
        // Job & Paint info
        const jobName = document.getElementById('jNm')?.value || 'N/A';
        const doorStyle = document.getElementById('prof')?.value || 'N/A';
        const doorColour = document.getElementById('col')?.value || 'N/A';
        const paintColor = document.getElementById('p-color')?.value || 'N/A';
        const paintCode = document.getElementById('p-code')?.value || 'N/A';
        const paintFinish = document.getElementById('p-finish')?.value || 'N/A';
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('JOB & PAINT DETAILS', 15, y);
        y += 7;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Job: ${jobName}`, 15, y);
        y += 5;
        doc.text(`Door Style: ${doorStyle} | Colour: ${doorColour}`, 15, y);
        y += 5;
        doc.text(`Paint: ${paintColor} (${paintFinish})`, 15, y);
        y += 5;
        doc.text(`Code/Formula: ${paintCode}`, 15, y);
        y += 12;
        
        // Mixing instructions
        doc.setFont(undefined, 'bold');
        doc.setFontSize(10);
        doc.text('FORMULA FOR MIXING', 15, y);
        y += 8;
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(9);
        doc.text('Total Quantity: _____ Litres', 15, y);
        y += 8;
        
        // Instructions box
        doc.setDrawColor(0);
        doc.setLineWidth(0.5);
        doc.rect(15, y, 170, 80);
        
        doc.setFontSize(8);
        doc.text('MIX INSTRUCTIONS:', 20, y + 5);
        doc.text('1. Pour white base into container', 20, y + 12);
        doc.text('2. Add tinters as per formula below', 20, y + 19);
        doc.text('3. Stir thoroughly for 5+ minutes', 20, y + 26);
        doc.text('4. Let settle for 15 minutes', 20, y + 33);
        doc.text('5. Test on sample before application', 20, y + 40);
        doc.text('Date Mixed: _________  Mixed By: ______________', 20, y + 52);
        doc.text('Quality Check: ______  Inspector: ______________', 20, y + 60);
        y += 90;
        
        doc.setFont(undefined, 'bold');
        doc.setFontSize(9);
        doc.text('FORMULA (amount per 1L)', 15, y);
        y += 7;
        
        doc.setFontSize(8);
        doc.text('[To be completed from paint database formula]', 15, y);
        y += 30;
        
        doc.setFont(undefined, 'italic');
        doc.setFontSize(7);
        doc.text(`Generated: ${new Date().toLocaleString('en-AU')}`, 15, y);
        
        doc.save(`MixingCard_${jobName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        notify("Mixing Card Downloaded");
    }


    // A3 PRINTABLE SCHEDULE (Continuous 90-day view)
    function printA3Schedule() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Create HTML for printing
        let html = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>A3 Schedule - Paintworkz</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #fff; }
        @page { size: A3 landscape; margin: 10mm; }
        @media print {
            body { margin: 0; padding: 0; }
            .no-print { display: none !important; }
        }
        .schedule-container { width: 100%; border-collapse: collapse; }
        .schedule-header { 
            background: #2196f3; color: #fff; padding: 15px; 
            text-align: center; font-size: 24px; font-weight: 900;
            page-break-after: avoid;
        }
        .date-range {
            font-size: 14px; color: #666; margin-top: 10px; text-align: center;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { 
            background: #f0f0f0; padding: 8px; border: 1px solid #999; 
            font-weight: 900; font-size: 11px; text-align: center;
            page-break-inside: avoid;
        }
        td { 
            padding: 6px; border: 1px solid #ddd; font-size: 10px; 
            height: 40px; vertical-align: top;
        }
        .job-cell { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .weekend { background: #f5f5f5; }
        button { 
            background: #2196f3; color: #fff; border: none; padding: 10px 20px; 
            border-radius: 6px; font-weight: 900; cursor: pointer; margin: 10px;
        }
        .no-print { margin: 15px; }
    </style>
</head>
<body>
    <div class="no-print" style="text-align:center;">
        <button onclick="window.print()">üñ®Ô∏è PRINT THIS SCHEDULE</button>
        <button onclick="window.close()">‚úï CLOSE</button>
    </div>
    
    <div class="schedule-header">
        üìÖ PAINTWORKZ - 90 DAY SCHEDULE
        <div class="date-range">Continuous 90-day rolling schedule</div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th style="width:15%;">JOB ID</th>
                <th style="width:20%;">CLIENT</th>`;
        
        // Add date headers for 90 days
        const monthNames = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
        for (let i = 0; i < 90; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() + i);
            const dayLetter = ['S', 'M', 'T', 'W', 'T', 'F', 'S'][date.getDay()];
            const dayNum = date.getDate();
            const monthLetter = monthNames[date.getMonth()];
            html += `<th style="width:1.3%; font-size:9px; padding:3px;">${dayLetter}<br>${dayNum}${monthLetter}</th>`;
        }
        
        html += `</tr></thead><tbody>`;
        
        // Add jobs
        try {
            const jobHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const activeJobs = jobHistory.filter(job => !job.completed).slice(0, 20); // Limit to 20 rows
            
            activeJobs.forEach(job => {
                html += `<tr>
                    <td style="font-weight:900;">${job.jobNum || 'N/A'}</td>
                    <td>${job.client?.name || job.clientName || 'Unknown'}</td>`;
                
                // Add empty cells for schedule
                for (let i = 0; i < 90; i++) {
                    const bgColor = (i % 7 === 0 || i % 7 === 6) ? '#f5f5f5' : '#fff';
                    html += `<td style="background:${bgColor};"></td>`;
                }
                
                html += `</tr>`;
            });
            
            if (activeJobs.length === 0) {
                html += `<tr><td colspan="92" style="text-align:center; color:#999;">No active jobs</td></tr>`;
            }
        } catch (e) {
            html += `<tr><td colspan="92" style="text-align:center; color:#f44336;">Error loading jobs</td></tr>`;
        }
        
        html += `</tbody></table>
        
        <div style="margin-top: 20px; font-size: 10px; color: #999; text-align: center;">
            Created: ${new Date().toLocaleDateString('en-AU')} ‚Ä¢ Paintworkz Pro
        </div>
    </body>
</html>`;
        
        // Open in new window and print
        const printWindow = window.open('', '', 'height=800,width=1200');
        printWindow.document.write(html);
        printWindow.document.close();
        setTimeout(() => printWindow.print(), 500);
        
        notify('‚úì A3 Schedule ready for print');
    }

    function saveJob() { 
        try {
            saveData();
            saveJobToHistory(); // This will show its own notification
            
            // Clear view mode when saving
            isJobViewMode = false;
            jobDataBeforeLoad = null;
            updateGoBackButton();
            
            // Auto-increment job number
            try {
                const currentJobNum = document.getElementById('jN').value;
                if (currentJobNum) {
                    // Extract number from job number (handle formats like "001", "1", "JOB001", etc)
                    const match = currentJobNum.match(/\d+/);
                    if (match) {
                        const nextNum = String(parseInt(match[0]) + 1).padStart(match[0].length, '0');
                        const prefix = currentJobNum.substring(0, currentJobNum.indexOf(match[0]));
                        const suffix = currentJobNum.substring(currentJobNum.indexOf(match[0]) + match[0].length);
                        document.getElementById('jN').value = prefix + nextNum + suffix;
                    }
                }
            } catch(e) {
                console.error('Error auto-incrementing job number:', e);
            }
            
            // Clear measure sheet and panel list
            setTimeout(() => {
                try {
                    items = [];
                    const hEl = document.getElementById('h');
                    if (hEl) hEl.value = '';
                    const wEl = document.getElementById('w');
                    if (wEl) wEl.value = '';
                    const descEl = document.getElementById('desc');
                    if (descEl) descEl.value = '';
                    const jNmEl = document.getElementById('jNm');
                    if (jNmEl) jNmEl.value = '';
                    
                    render(); // Re-render to clear UI
                    tab('history'); // Navigate to history tab
                    renderHistory();
                } catch(e) {
                    console.error('Error clearing measure sheet:', e);
                }
            }, 500);
        } catch(e) {
            console.error('Error in saveJob:', e);
            notify('‚ö†Ô∏è Error saving job');
        }
    }

    let cameraStream = null;
    let isVideoBroadcasting = false;

    function snap() { 
        if (!isVideoBroadcasting) {
            startCamera();
        } else {
            capturePhoto();
        }
    }

    function startCamera() {
        const constraints = {
            video: { facingMode: 'environment' },
            audio: false
        };
        
        navigator.mediaDevices.getUserMedia(constraints)
            .then(stream => {
                cameraStream = stream;
                isVideoBroadcasting = true;
                
                let cameraModal = document.getElementById('cameraModal');
                if (!cameraModal) {
                    cameraModal = document.createElement('div');
                    cameraModal.id = 'cameraModal';
                    cameraModal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999;';
                    document.body.appendChild(cameraModal);
                }
                
                let videoEl = document.getElementById('cameraVideo');
                if (!videoEl) {
                    videoEl = document.createElement('video');
                    videoEl.id = 'cameraVideo';
                    videoEl.style.cssText = 'width:100%; height:100%; object-fit:cover;';
                    cameraModal.innerHTML = '';
                    cameraModal.appendChild(videoEl);
                    
                    const buttons = document.createElement('div');
                    buttons.style.cssText = 'position:absolute; bottom:20px; left:0; right:0; display:flex; gap:10px; justify-content:center; padding:0 20px;';
                    
                    const captureBtn = document.createElement('button');
                    captureBtn.id = 'cameraCaptureBtn';
                    captureBtn.textContent = 'üì∏ CAPTURE';
                    captureBtn.style.cssText = 'background:#34c759; color:#fff; border:none; padding:12px 24px; border-radius:8px; font-weight:900; font-size:14px; cursor:pointer;';
                    captureBtn.addEventListener('click', capturePhoto);
                    
                    const closeBtn = document.createElement('button');
                    closeBtn.id = 'cameraCloseBtn';
                    closeBtn.textContent = '‚úï CLOSE';
                    closeBtn.style.cssText = 'background:#ff3b30; color:#fff; border:none; padding:12px 24px; border-radius:8px; font-weight:900; font-size:14px; cursor:pointer;';
                    closeBtn.addEventListener('click', closeCamera);
                    
                    buttons.appendChild(captureBtn);
                    buttons.appendChild(closeBtn);
                    cameraModal.appendChild(buttons);
                }
                
                cameraModal.style.display = 'flex';
                videoEl.srcObject = stream;
                videoEl.play();
                notify('üì∏ Camera Active - Tap CAPTURE to take photo');
            })
            .catch(error => {
                console.error('Camera error:', error);
                notify('‚ùå Camera access denied. Check permissions.');
            });
    }

    function capturePhoto() {
        if (!cameraStream) return;
        
        const video = document.getElementById('cameraVideo');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        const photoData = canvas.toDataURL('image/jpeg');
        savePhotoToJob(photoData);
        closeCamera();
    }

    function closeCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
            isVideoBroadcasting = false;
        }
        const cameraModal = document.getElementById('cameraModal');
        if (cameraModal) cameraModal.style.display = 'none';
    }

    function savePhotoToJob(photoData) {
        if (!currentJob) {
            notify('‚ùå No active job. Create a job first.');
            return;
        }
        currentJob.photos = currentJob.photos || [];
        currentJob.photos.push({
            timestamp: new Date().toISOString(),
            data: photoData
        });
        saveData();
        notify('‚úì Photo saved to job');
    }

    function clearAllData() {
        if (confirm('Are you absolutely sure? This will delete all data and cannot be undone.')) {
            items = [];
            currentEditingJobIndex = null; // Reset editing index
            localStorage.removeItem('currentJob');
            document.getElementById('h').value = '';
            document.getElementById('w').value = '';
            document.getElementById('desc').value = '';
            document.getElementById('dRec').value = '';
            document.getElementById('jNm').value = '';
            document.getElementById('jN').value = '';
            render();
            notify('All Data Cleared');
        }
    }
    
    function startNewJob() {
        currentEditingJobIndex = null; // Reset editing index when starting new job
        clearAllData(); // This will also clear the form
    }

    // CALENDAR FUNCTIONALITY
    let calendarDate = new Date();

    function openCalendar() {
        calendarDate = new Date();
        renderCalendar();
        document.getElementById('calendarModal').style.display = 'flex';
    }

    function closeCalendar() {
        document.getElementById('calendarModal').style.display = 'none';
    }

    function prevMonth() {
        calendarDate.setMonth(calendarDate.getMonth() - 1);
        renderCalendar();
    }

    function nextMonth() {
        calendarDate.setMonth(calendarDate.getMonth() + 1);
        renderCalendar();
    }

    function renderCalendar() {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        
        // Set month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        if (document.getElementById('monthYear')) document.getElementById('monthYear').innerText = `${monthNames[month]} ${year}`;
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        let daysHTML = '';
        
        // Previous month's days
        for (let i = firstDay - 1; i >= 0; i--) {
            daysHTML += `<div style="padding:8px; text-align:center; color:#ccc; font-weight:900; background:#f9f9f9; border-radius:6px;">${daysInPrevMonth - i}</div>`;
        }
        
        // Current month's days
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            const dateStr = `${day.toString().padStart(2, '0')}/${(month + 1).toString().padStart(2, '0')}/${year.toString().slice(-2)}`;
            daysHTML += `<div onclick="selectDate('${dateStr}')" style="padding:8px; text-align:center; font-weight:900; background:${isToday ? 'var(--gs)' : '#fff'}; color:${isToday ? '#000' : '#333'}; border:${isToday ? '2px solid var(--gs)' : '1px solid #eee'}; border-radius:6px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='${isToday ? 'var(--gs)' : '#fff'}'">${day}</div>`;
        }
        
        // Next month's days
        const totalCells = firstDay + daysInMonth;
        const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let day = 1; day <= remainingCells; day++) {
            daysHTML += `<div style="padding:8px; text-align:center; color:#ccc; font-weight:900; background:#f9f9f9; border-radius:6px;">${day}</div>`;
        }
        
        document.getElementById('calendarDays').innerHTML = daysHTML;
    }

    function selectDate(dateStr) {
        document.getElementById('dRec').value = dateStr;
        saveData();
        notify(`Date Set: ${dateStr}`);
        closeCalendar();
        // Refresh schedule calendar
        renderScheduleCalendar();
    }

    function selectToday() {
        const today = new Date();
        const dateStr = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear().toString().slice(-2)}`;
        selectDate(dateStr);
    }

    // SCHEDULE CALENDAR FUNCTIONALITY
    let scheduleCalendarDate = new Date();

    function renderScheduleCalendar() {
        
        // FORCE SCHEDULE CONTAINER TO BE VISIBLE
        const scheduleContainer = document.getElementById('schedule');
        if (scheduleContainer) {
            scheduleContainer.style.display = 'block';
            scheduleContainer.style.visibility = 'visible';
            scheduleContainer.style.minHeight = 'auto';
        }
        
        const year = scheduleCalendarDate.getFullYear();
        const month = scheduleCalendarDate.getMonth();
        
        // Set month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        if (document.getElementById('scheduleMonthYear')) document.getElementById('scheduleMonthYear').innerText = `${monthNames[month]} ${year}`;
        
        renderGanttChart(year, month);
        renderGlobalNotifications();
        renderJobTasks(); // Update workload summary
        checkForDuplicates(); // Show warning if duplicates exist
    }
    
    function renderGanttChart(year, month) {
        // FORCE WRAPPER TO BE VISIBLE
        const ganttWrapper = document.getElementById('ganttWrapper');
        if (ganttWrapper) {
            ganttWrapper.style.display = 'block';
            ganttWrapper.style.visibility = 'visible';
            ganttWrapper.style.opacity = '1';
        }
        
        const ganttChart = document.getElementById('ganttChart');
        if (!ganttChart) {
            return;
        }
        
        // FORCE VISIBILITY BEFORE RENDERING
        ganttChart.style.display = 'flex';
        ganttChart.style.visibility = 'visible';
        ganttChart.style.minHeight = 'auto';
        ganttChart.style.opacity = '1';
        
        // Check if element is visible
        const style = window.getComputedStyle(ganttChart);
        
        try {
            let fullHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            
        
        // Sort by received date - newest first
        let history = fullHistory.filter(job => !job.completed).sort((a, b) => {
            let dateA = new Date();
            let dateB = new Date();
            
            // Parse dateReceived in DD/MM/YY format
            if (a.dateReceived) {
                if (a.dateReceived.includes('/')) {
                    const [day, month, year] = a.dateReceived.split('/');
                    dateA = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                } else if (a.dateReceived.includes('-')) {
                    dateA = new Date(a.dateReceived);
                }
            }
            
            if (b.dateReceived) {
                if (b.dateReceived.includes('/')) {
                    const [day, month, year] = b.dateReceived.split('/');
                    dateB = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                } else if (b.dateReceived.includes('-')) {
                    dateB = new Date(b.dateReceived);
                }
            }
            
            return dateB - dateA;
        });
        
        // CONTINUOUS SCHEDULE VIEW: Show 90 days starting from today (not month-based)
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Generate 90 days continuously from today
        const allDays = [];
        for (let i = 0; i < 90; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() + i);
            allDays.push({ day: date.getDate(), date, isWeekday: isWeekday(date), month: date.getMonth(), year: date.getFullYear() });
        }
        
        // Update header to show date range
        const lastDate = allDays[allDays.length - 1].date;
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const dateRangeText = `${monthNames[today.getMonth()]} ${today.getDate()} - ${monthNames[lastDate.getMonth()]} ${lastDate.getDate()}`;
        if (document.getElementById('scheduleMonthYear')) document.getElementById('scheduleMonthYear').innerText = dateRangeText;
        
        // Create header with dates (ALL DAYS - weekends grayed out)
        const timelineWidth = allDays.length * 28;
        let ganttHTML = '<div style="display:flex; gap:0; margin-bottom:0; position:sticky; top:0; background:#fff; z-index:10; border-bottom:2px solid #ddd; min-height:28px; align-items:stretch;">';
        
        // Job names column - MUST MATCH job info width (170px) - EXACT same styling
        ganttHTML += '<div style="width:170px; min-width:170px; max-width:170px; font-weight:900; font-size:9px; padding:5px 6px; border-right:2px solid #ddd; color:#000; line-height:1.2; background:#f9f9f9; box-sizing:border-box; display:flex; align-items:center;">DATE</div>';
        
        // Wrap date columns in container with exact calculated width
        ganttHTML += `<div style="width:${timelineWidth}px; min-width:${timelineWidth}px; max-width:${timelineWidth}px; display:flex; gap:0; min-height:28px;">`;
        
        // Date columns - ALL DAYS (weekends lighter) - EXACT 28px box
        allDays.forEach(({ day, date, isWeekday: isWD }) => {
            const dayName = ['S', 'M', 'T', 'W', 'T', 'F', 'S'][date.getDay()];
            const bgColor = isWD ? '#f0f0f0' : '#f9f9f9';
            const textColor = isWD ? '#666' : '#ccc';
            ganttHTML += `<div style="width:28px; min-width:28px; max-width:28px; height:28px; text-align:center; font-weight:900; font-size:9px; padding:2px 0; background:${bgColor}; border:1px solid #eee; color:${textColor}; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; justify-content:center; line-height:1.1;">${dayName}<br>${day}</div>`;
        });
        ganttHTML += '</div>';  // Close date columns container
        ganttHTML += '</div>';  // Close header row
        
        // Jobs timeline
        ganttHTML += '<div style="width:100%; display:flex; flex-direction:column; gap:0;">';
        let jobCount = 0;
        history.forEach((job, filteredIdx) => {
            // Find original index in full history
            const originalIdx = fullHistory.findIndex(j => j === job);
            
            if (job && !job.completed) {
                jobCount++;
                // Handle date in DD/MM/YY or YYYY-MM-DD format
                let jobDate = new Date();
                if (job.dateReceived) {
                    try {
                        if (job.dateReceived.includes('/')) {
                            // DD/MM/YY format
                            const [day, jobMonth, jobYear] = job.dateReceived.split('/');
                            jobDate = new Date(parseInt('20' + jobYear), parseInt(jobMonth) - 1, parseInt(day));
                        } else if (job.dateReceived.includes('-')) {
                            // YYYY-MM-DD format
                            jobDate = new Date(job.dateReceived);
                        }
                    } catch (e) {
                        jobDate = new Date(); // Default to today if parsing fails
                    }
                }
                
                // Initialize job phases tracking if not exists
                if (!job.phases) job.phases = {};
                
                // Get custom timeline for this job or use defaults
                const jobTimeline = job.timeline || getDefaultTimeline();
                const measuringEnd = jobTimeline.measuring;
                const sanding1End = jobTimeline.sanding1;
                const undercoatEnd = jobTimeline.undercoat;
                const sanding2End = jobTimeline.sanding2;
                const topCoatEnd = jobTimeline.topcoat;
                const inspectEnd = jobTimeline.inspect;
                const completionDay = jobTimeline.complete;
                // Job header with info and timeline - Alternate background every 2nd job
                const jobBgColor = jobCount % 2 === 0 ? '#ffffff' : '#f5f5f5';
                const timelineWidth = allDays.length * 28;
                ganttHTML += `<div style="margin-bottom:0; padding-bottom:0; display:flex; gap:0; background:${jobBgColor}; border:1px solid #ddd; border-bottom:2px solid #bbb;">
                    <!-- Left Column: Job Info -->
                    <div style="width:170px; min-width:170px; max-width:170px; font-weight:900; font-size:9px; padding:5px 6px; border-right:2px solid #ddd; color:#000; line-height:1.2; background:#f9f9f9; box-sizing:border-box;">
                        <div style="color:#d4af37; font-size:10px;">#${job.jobNum}</div>
                        <div style="font-size:8px; color:#666; margin-top:1px;">${job.client}</div>
                        <div style="font-size:7px; color:#2196f3; font-weight:900; margin-top:1px;">üìê ${parseFloat(job.totalSqm || 0).toFixed(2)} m¬≤</div>
                        <button onclick="editJobTimeline(${originalIdx})" style="font-size:7px; padding:1px 3px; border:none; background:#2196f3; color:#fff; border-radius:2px; cursor:pointer; margin-top:1px; width:100%;">‚úèÔ∏è Edit</button>
                    </div>
                    
                    <!-- Right Column: Timeline bars + Phase checkboxes stacked -->
                    <div style="display:flex; flex-direction:column; gap:0; width:${timelineWidth}px; min-width:${timelineWidth}px; max-width:${timelineWidth}px;">
                        <!-- Timeline bars row -->
                        <div style="display:flex; gap:0;">`;
                
                // Timeline bars - ALL DAYS but NEVER work on weekends
                allDays.forEach(({ day, date: cellDate, isWeekday: isWD }) => {
                    let barHTML = '';
                    
                    // WEEKEND = ALWAYS EMPTY, NO WORK
                    if (!isWD) {
                        barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:#fafafa; border:1px solid #f0f0f0; box-sizing:border-box;"></div>`;
                    }
                    // WEEKDAY ONLY = check phase
                    else if (isWD) {
                        // Weekday - count which working day this is from job start
                        const workingDayNum = getWorkingDayNumber(jobDate, cellDate);
                        
                        if (workingDayNum < 1) {
                            // Before job start
                            barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:#f9f9f9; border:1px solid #eee; box-sizing:border-box;"></div>`;
                        } else {
                            // Job has started - assign to phase
                            let phaseKey = '';
                            let phaseColor = '';
                            let phaseLabel = '';
                            let isStrikeThrough = false;
                            
                            // Assign working day to phase (simple whole day allocation)
                            if (workingDayNum <= measuringEnd) {
                                phaseKey = 'measuring';
                                phaseColor = '#2196f3';
                                phaseLabel = 'M';
                                isStrikeThrough = job.phases && job.phases.measuring;
                            } else if (workingDayNum <= sanding1End) {
                                phaseKey = 'sanding1';
                                phaseColor = '#ff9500';
                                phaseLabel = 'S1';
                                isStrikeThrough = job.phases && job.phases.sanding1;
                            } else if (workingDayNum <= undercoatEnd) {
                                phaseKey = 'undercoat';
                                phaseColor = '#8b4513';
                                phaseLabel = 'U';
                                isStrikeThrough = job.phases && job.phases.undercoat;
                            } else if (workingDayNum <= sanding2End) {
                                phaseKey = 'sanding2';
                                phaseColor = '#ff9500';
                                phaseLabel = 'S2';
                                isStrikeThrough = job.phases && job.phases.sanding2;
                            } else if (workingDayNum <= topCoatEnd) {
                                phaseKey = 'topcoat';
                                phaseColor = '#9c27b0';
                                phaseLabel = 'T';
                                isStrikeThrough = job.phases && job.phases.topcoat;
                            } else if (workingDayNum <= inspectEnd) {
                                phaseKey = 'inspect';
                                phaseColor = '#673ab7';
                                phaseLabel = 'I';
                                isStrikeThrough = job.phases && job.phases.inspect;
                            } else if (workingDayNum <= completionDay) {
                                phaseKey = 'complete';
                                phaseColor = '#34c759';
                                phaseLabel = 'C';
                                isStrikeThrough = job.phases && job.phases.complete;
                            }
                            
                            if (phaseKey) {
                                barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:${phaseColor}; border:1px solid ${phaseColor}; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:900; color:#fff; position:relative; cursor:pointer; box-sizing:border-box; ${isStrikeThrough ? 'opacity:0.5; text-decoration:line-through;' : ''}" onclick="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', '${phaseKey}')" title="Click to mark complete">
                                    <span>${phaseLabel}</span>
                                    ${isStrikeThrough ? '<svg style="position:absolute; width:24px; height:24px;" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><line x1="3" y1="3" x2="21" y2="21"/></svg>' : ''}
                                </div>`;
                            } else {
                                barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:#f9f9f9; border:1px solid #eee; box-sizing:border-box;"></div>`;
                            }
                        }
                    }
                    
                    ganttHTML += barHTML;
                });
                
                ganttHTML += '</div>';  // Close timeline bars row
                ganttHTML += `<div style="display:flex; gap:8px; padding:4px 6px; background:transparent; flex-wrap:wrap; align-items:center;">
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.measuring ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'measuring')" style="width:13px; height:13px; cursor:pointer;">
                            <span>M</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.sanding1 ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'sanding1')" style="width:13px; height:13px; cursor:pointer;">
                            <span>S1</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.undercoat ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'undercoat')" style="width:13px; height:13px; cursor:pointer;">
                            <span>U</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.sanding2 ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'sanding2')" style="width:13px; height:13px; cursor:pointer;">
                            <span>S2</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.topcoat ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'topcoat')" style="width:13px; height:13px; cursor:pointer;">
                            <span>T</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.inspect ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'inspect')" style="width:13px; height:13px; cursor:pointer;">
                            <span>I</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.complete ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'complete')" style="width:13px; height:13px; cursor:pointer;">
                            <span>C</span>
                        </label>
                        <button onclick="markJobComplete(${originalIdx})" style="border:none; background:#34c759; color:#fff; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">‚úì DONE</button>
                        </div>
                    </div>
                </div>`;
            }
        });
        ganttHTML += '</div>';
        
        // Legend
        ganttHTML += `<div style="margin-top:15px;">
            <div style="background:#f0f0f0; padding:10px; border-radius:6px; margin-bottom:10px;">
                <p style="margin:0 0 8px 0; font-weight:900; font-size:11px; color:#333;">üìÖ Timeline Counts WORKING DAYS ONLY</p>
                <p style="margin:0; font-size:9px; color:#666;"><strong>Example:</strong> If Measuring = 2 days, it shows M/T (Mon-Tue). If Sanding = 8 days starting Wed, it shows W/T/F (3) + skip weekend + M/T/W/T (4) = 8 working days total across 2 weeks</p>
            </div>
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; font-size:8px; font-weight:900;">
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#2196f3; border:1px solid #1976d2; border-radius:2px;"></div>
                <span>M = Measuring</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#ff9500; border:1px solid #f57c00; border-radius:2px;"></div>
                <span>S1/S2 = Sanding</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#8b4513; border:1px solid #5c2e0a; border-radius:2px;"></div>
                <span>U = Undercoat</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#9c27b0; border:1px solid #7b1fa2; border-radius:2px;"></div>
                <span>T = Top Coat</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#673ab7; border:1px solid #512da8; border-radius:2px;"></div>
                <span>I = Inspect</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#34c759; border:1px solid #28a745; border-radius:2px;"></div>
                <span>C = Complete</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#fafafa; border:1px solid #f0f0f0; border-radius:2px;"></div>
                <span>Weekend (no work)</span>
            </div>
        </div>`;
        
        ganttChart.innerHTML = ganttHTML;
        
        // COUNT ACTUAL JOB DIVS IN DOM
        const jobDivs = ganttChart.querySelectorAll('div[style*="margin-bottom:12px"]');
        jobDivs.forEach((div, idx) => {
        });
        } catch (error) {
            ganttChart.innerHTML = `<div style="padding:20px; color:#ff3b30; background:#ffebee; border-radius:6px;"><strong>Error loading schedule:</strong> ${error.message}</div>`;
        }
    }


    
    function toggleGanttCell(jobIdx, phaseKey) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[jobIdx];
        
        if (!job) return;
        if (!job.phases) job.phases = {};
        
        job.phases[phaseKey] = !job.phases[phaseKey];
        
        history[jobIdx] = job;
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        // Sync to Firebase in background (async)
        if (window.syncJobsToFirebase) {
            setTimeout(() => window.syncJobsToFirebase(), 100);
        }
        
        // Update workload summary ONLY (don't re-render entire schedule)
        renderJobTasks();
        
        // Show notification
        notify(job.phases[phaseKey] ? `‚úì ${phaseKey} marked complete` : `‚óã ${phaseKey} marked pending`);
    }
    
    function renderGlobalNotifications() {
        const notificationsDiv = document.getElementById('globalNotifications');
        if (!notificationsDiv) return;
        
        const adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        updateNotificationBadge();
        
        if (adminAlerts.length === 0) {
            notificationsDiv.innerHTML = '<p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p>';
            return;
        }
        
        let notificationsHTML = '';
        adminAlerts.slice(0, 10).forEach((alert, i) => {
            const alertDate = new Date(alert.timestamp);
            let typeLabel = '';
            let typeColor = '#34c759';
            
            if (alert.type === 'JOB_COMPLETED') {
                typeLabel = '‚úÖ Completed';
                typeColor = '#34c759';
            } else if (alert.type === 'JOB_UPDATED') {
                typeLabel = '‚úèÔ∏è Updated';
                typeColor = '#ffc107';
            } else if (alert.type === 'JOB_SAVED') {
                typeLabel = '‚úÖ Saved';
                typeColor = '#34c759';
            } else if (alert.type === 'NEW_CLIENT') {
                typeLabel = 'üë§ New Client';
                typeColor = '#34c759';
            } else if (alert.type === 'CLIENT_DELETED') {
                typeLabel = 'üóëÔ∏è Deleted';
                typeColor = '#ff3b30';
            } else if (alert.type === 'PROFILE_ADDED') {
                typeLabel = 'üö™ New Profile';
                typeColor = '#ff9800';
            } else {
                typeLabel = alert.type;
            }
            
            notificationsHTML += `<div style="padding:10px; border-bottom:1px solid #ddd; background:#fff; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:4px;">
                        <div style="font-weight:900; color:${typeColor}; font-size:11px;">${typeLabel}</div>
                        <button onclick="deleteAdminAlert(${i})" style="background:#ff3b30; color:#fff; border:none; padding:4px 8px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer; white-space:nowrap; margin-left:8px;">‚úï</button>
                    </div>
                    <div style="font-size:10px; color:#000; font-weight:700; margin:2px 0;">${alert.message}</div>
                    <div style="font-size:9px; color:#999; margin-top:4px;">
                        ${alertDate.toLocaleDateString('en-AU')} ${alertDate.toLocaleTimeString('en-AU', {hour: '2-digit', minute: '2-digit'})}
                    </div>
                </div>
            </div>`;
        });
        
        if (adminAlerts.length > 10) {
            notificationsHTML += `<div style="padding:10px; text-align:center; color:#999; font-size:10px;">+${adminAlerts.length - 10} more notifications</div>`;
        }
        
        notificationsDiv.innerHTML = notificationsHTML;
    }
    
    // Delete individual admin alert
    function deleteAdminAlert(index) {
        const adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        adminAlerts.splice(index, 1);
        localStorage.setItem('adminAlerts', JSON.stringify(adminAlerts));
        renderGlobalNotifications();
        updateNotificationBadge();
        console.log(`‚úì Dismissed alert ${index}`);
    }
    
    // Toggle notifications visibility and update badge
    function toggleNotifications() {
        const notifDiv = document.getElementById('globalNotifications');
        const badge = document.getElementById('notificationBadge');
        const btn = event.target;
        
        if (notifDiv.style.display === 'none') {
            // Show notifications
            notifDiv.style.display = 'block';
            btn.innerText = '‚àí';
        } else {
            // Hide notifications
            notifDiv.style.display = 'none';
            btn.innerText = '+';
        }
    }
    
    // Update notification badge count
    function updateNotificationBadge() {
        const adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            badge.innerText = adminAlerts.length;
            badge.style.display = adminAlerts.length > 0 ? 'flex' : 'none';
        }
    }
    
    function checkForNewUnallocatedDoors() {
        const unallocated = getUnallocatedDoors();
        if (unallocated.length > 0) {
            console.log(`‚ö†Ô∏è Found ${unallocated.length} unallocated door(s):`);
            unallocated.forEach(door => console.log(`  - ${door.name}`));
            showUnallocatedDoorsNotification(unallocated);
        }
    }
    
    // Show red notification for unallocated doors
    function showUnallocatedDoorsNotification(unallocated) {
        const alertArea = document.getElementById('globalNotifications');
        if (!alertArea) return;
        
        // Check if notification already exists
        const existingAlert = alertArea.querySelector('[data-alert="unallocated-doors"]');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        // Remove placeholder
        const placeholder = alertArea.querySelector('p');
        if (placeholder) placeholder.remove();
        
        const alertHTML = `
            <div data-alert="unallocated-doors" style="background:#ffebee; border-left:4px solid #ff3b30; padding:12px; margin-bottom:8px; border-radius:4px; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="font-weight:900; color:#ff3b30; margin-bottom:6px; font-size:12px;">
                        ‚ö†Ô∏è ${unallocated.length} DOOR(S) NEED ALLOCATING
                    </div>
                    <div style="color:#d32f2f; font-size:11px;">
                        ${unallocated.map(d => `‚Ä¢ ${d.name}`).join('<br>')}
                    </div>
                    <div style="margin-top:8px; display:flex; gap:8px;">
                        <button onclick="tab('admin'); setTimeout(() => switchAdminTab('pricing'), 200)" style="background:#ff3b30; color:#fff; border:none; padding:6px 12px; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer;">
                            GO TO MATRIX ‚Üí
                        </button>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" style="background:#ff3b30; color:#fff; border:none; padding:6px 12px; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer; white-space:nowrap; margin-left:8px; height:fit-content;">
                    ‚úï DISMISS
                </button>
            </div>
        `;
        
        alertArea.innerHTML += alertHTML;
        console.log(`üîî Shown notification for ${unallocated.length} unallocated door(s)`);
    }

    // Helper function to get the calendar date that corresponds to N working days from a start date
    // Helper function to check if a day is a weekday (Monday-Friday)
    const isWeekday = (date) => {
        const dayOfWeek = date.getDay();
        return dayOfWeek !== 0 && dayOfWeek !== 6; // 0=Sunday, 6=Saturday
    };
    
    // Helper to count working days from start date to a calendar date
    function getWorkingDayNumber(startDate, targetDate) {
        let count = 0;
        let currentDate = new Date(startDate);
        
        while (currentDate <= targetDate) {
            if (isWeekday(currentDate)) {
                count++;
            }
            if (currentDate.toDateString() === targetDate.toDateString()) {
                return count;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return -1; // Target date is before start date
    }
    
    

    function toggleJobPhaseById(jobNum, dateReceived, client, phaseKey) {
        try {
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            
            // Find job by unique identifiers (not by array index)
            const jobIdx = history.findIndex(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
            
            if (jobIdx < 0) {
                console.error('‚ùå Job not found:', jobNum, dateReceived, client);
                notify('‚ö†Ô∏è Error: Job not found');
                return;
            }
            
            const job = history[jobIdx];
            if (!job.phases) job.phases = {};
            
            // Get current state BEFORE toggle
            const wasComplete = job.phases[phaseKey] || false;
            
            // Toggle the phase
            job.phases[phaseKey] = !wasComplete;
            const isNowComplete = job.phases[phaseKey];
            
            console.log(`üìã Job #${jobNum} - Phase "${phaseKey}": ${wasComplete ? '‚úì' : '‚óã'} ‚Üí ${isNowComplete ? '‚úì' : '‚óã'}`);
            
            // Update in history
            history[jobIdx] = job;
            localStorage.setItem('jobHistory', JSON.stringify(history));
            
            // Sync to Firebase
            if (window.syncJobsToFirebase) {
                try {
                    window.syncJobsToFirebase();
                    console.log('üîÑ Synced to Firebase');
                } catch(e) {
                    console.error('Firebase sync error:', e);
                }
            }
            
            // Update workload summary
            renderJobTasks();
            
            // Show notification
            notify(isNowComplete ? `‚úì ${phaseKey} done` : `‚óã ${phaseKey} reset`);
            
            // Re-render Gantt chart
            renderScheduleCalendar();
            
        } catch(e) {
            console.error('toggleJobPhaseById error:', e);
            notify('‚ö†Ô∏è Error updating phase');
        }
    }

    function toggleJobPhase(jobIdx, phaseKey) {
        toggleGanttCell(jobIdx, phaseKey);
    }

    function markJobComplete(jobIdx) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[jobIdx];
        
        if (!job) {
            alert('Error: Job not found');
            return;
        }
        
        // Check if all phases are complete
        if (!job.phases || !job.phases.measuring || !job.phases.sanding || !job.phases.topcoat || !job.phases.inspect || !job.phases.complete) {
            if (!confirm('Not all phases are marked complete. Complete job anyway?')) {
                return;
            }
        }
        
        
        // Mark job as complete
        job.completed = true;
        job.completedDate = new Date().toISOString();
        
        history[jobIdx] = job;
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        
        // Generate PDFs and alert admins
        try {
            generateBatchPDFs(job);
        } catch(e) {
        }
        
        try {
            alertAdmins(job);
        } catch(e) {
        }
        
        renderHistory();
        renderScheduleCalendar();
        notify('‚úì Job Marked Complete');
        
        // Switch to History tab to show completed job
        setTimeout(() => {
            tab('history');
            filterHistory('completed');
        }, 500);
    }

    function switchAdminTab(tab) {
        // Hide all admin tabs
        document.getElementById('admin-tab-general-content').style.display = 'none';
        document.getElementById('admin-tab-colours-content').style.display = 'none';
        const clientsContent = document.getElementById('admin-tab-clients-content');
        if (clientsContent) clientsContent.style.display = 'none';
        document.getElementById('admin-tab-pricing-content').style.display = 'none';
        
        // Remove active class from all buttons
        document.getElementById('admin-tab-general').classList.remove('active');
        document.getElementById('admin-tab-colours').classList.remove('active');
        const clientsBtn = document.getElementById('admin-tab-clients');
        if (clientsBtn) clientsBtn.classList.remove('active');
        document.getElementById('admin-tab-pricing').classList.remove('active');
        
        // Show selected tab and mark button as active
        if (tab === 'general') {
            document.getElementById('admin-tab-general-content').style.display = 'block';
            document.getElementById('admin-tab-general').classList.add('active');
            renderAdminAlerts(); // Refresh all notifications
        } else if (tab === 'colours') {
            document.getElementById('admin-tab-colours-content').style.display = 'block';
            document.getElementById('admin-tab-colours').classList.add('active');
            renderColorCustomizer();
        } else if (tab === 'clients') {
            if (clientsContent) {
                clientsContent.style.display = 'block';
                if (clientsBtn) clientsBtn.classList.add('active');
                const searchBox = document.getElementById('clientSearchBox');
                if (searchBox) searchBox.value = '';
                renderClientsList();
            }
        } else if (tab === 'pricing') {
            document.getElementById('admin-tab-pricing-content').style.display = 'block';
            document.getElementById('admin-tab-pricing').classList.add('active');
            renderPricingMatrix(); // Load pricing matrix when tab opens
            checkForNewUnallocatedDoors(); // Check and notify about unallocated doors
        }
    }

    // PAINT FORMULA MANAGER
    function renderPaintFormulaList() {
        const target = document.getElementById('paintFormulaList');
        if (!target) return;
        
        const formulas = getPaintFormulas();
        
        let html = '';
        
        if (formulas.length === 0) {
            html += `<div style="padding:20px; text-align:center; color:#999; font-size:11px;">No formulas yet. Add one above!</div>`;
        } else {
            formulas.forEach((f, idx) => {
                html += `<div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                    <div style="flex:1;">
                        <div style="font-weight:900; font-size:12px; color:#000;">${f.brand} - ${f.color}</div>
                        <div style="font-size:10px; color:#666; margin-top:3px;">${f.formula}</div>
                    </div>
                    <button onclick="deletePaintFormulaDB(${idx})" style="padding:4px 10px; background:#ff3b3015; color:#ff3b30; border:none; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer;">DELETE</button>
                </div>`;
            });
        }
        
        target.innerHTML = html;
    }
    
    function addNewPaintFormula() {
        const brand = document.getElementById('newPaintBrand')?.value.trim();
        const color = document.getElementById('newPaintColor')?.value.trim();
        const formula = document.getElementById('newPaintFormula')?.value.trim();
        
        if (!brand || !color || !formula) {
            alert('Please fill in all fields');
            return;
        }
        
        const formulas = getPaintFormulas();
        formulas.push({ brand, color, formula });
        savePaintFormulas(formulas);
        
        document.getElementById('newPaintBrand').value = '';
        document.getElementById('newPaintColor').value = '';
        document.getElementById('newPaintFormula').value = '';
        
        renderPaintFormulaList();
        notify('‚úì Formula Added');
    }
    
    function deletePaintFormulaDB(idx) {
        if (confirm('Delete this formula?')) {
            const formulas = getPaintFormulas();
            formulas.splice(idx, 1);
            savePaintFormulas(formulas);
            renderPaintFormulaList();
            notify('‚úì Formula Deleted');
        }
    }

    function renderPaintFormulaManager() {
        // Deprecated - now using Database tab instead
        renderPaintFormulaList();
    }

    // COLOR CUSTOMIZER
    const defaultColors = {
        'Primary Blue': '#2196f3',
        'Gold/Highlight': '#d4af37',
        'Success Green': '#34c759',
        'Sanding Phase 1 (S1)': '#ff9500',
        'Sanding Phase 2 (S2)': '#ff9500',
        'Error Red': '#ff3b30',
        'Measuring Blue (M)': '#2196f3',
        'Undercoat Brown (U)': '#8b4513',
        'TopCoat Purple (T)': '#9c27b0',
        'Inspect Purple (I)': '#673ab7',
        'Complete Green (C)': '#34c759',
        'Background Light': '#f9f9f9',
        'Border Gray': '#ddd',
        'Text Dark': '#000',
        'Text Gray': '#666',
        'PANEL Button': '#34c759',
        'DOOR Button': '#ff9500',
        'DRAWER Button': '#2196f3',
        'CUSTOM Button': '#af52de',
        'FLAT Mode Active': '#fff',
        'FLAT Mode Inactive': '#f5f5f5',
        'MOULDED Mode Active': '#fff',
        'MOULDED Mode Inactive': '#f5f5f5',
        'SS Mode Background': '#333',
        'SS Mode Text': '#d4af37',
        'DS Mode Background': '#333',
        'DS Mode Text': '#d4af37',
        'SE Mode Background': '#333',
        'SE Mode Text': '#d4af37',
        '1LR Edge Active': '#34c759',
        '2SR Edge Active': '#34c759'
    };
    
    const colorDescriptions = {
        'Primary Blue': 'üíæ SAVE button, Edit pencil icons, SQM (m¬≤) display (#) in schedule row',
        'Gold/Highlight': 'üè∑Ô∏è Job numbers (#001, #002, #003) displayed in schedule',
        'Success Green': '‚úì SAVE & ‚úì DONE buttons, complete checkmarks, success messages',
        'Sanding Phase 1 (S1)': 'üü† Sanding Phase 1 bar (S1) in Gantt timeline',
        'Sanding Phase 2 (S2)': 'üü† Sanding Phase 2 bar (S2) in Gantt timeline',
        'Error Red': '‚ùå Delete (√ó) buttons throughout app',
        'Measuring Blue (M)': 'üîµ Measuring Phase bar (M) in Gantt timeline',
        'Undercoat Brown (U)': 'üü§ Undercoat Phase bar (U) in Gantt timeline',
        'TopCoat Purple (T)': 'üü£ Top Coat Phase bar (T) in Gantt timeline',
        'Inspect Purple (I)': 'üü£ Inspect & Wrap Phase bar (I) in Gantt timeline',
        'Complete Green (C)': '‚úì Complete Phase bar (C) in Gantt timeline',
        'Background Light': '‚¨ú Checkboxes container, light card backgrounds',
        'Border Gray': '‚îÅ‚îÅ All borders, divider lines, frame edges',
        'Text Dark': 'Primary text color - job titles, headings',
        'Text Gray': 'Secondary text - labels, metadata, timestamps',
        'PANEL Button': 'üü© PANEL button in Measure tab (part type selector)',
        'DOOR Button': 'üü† DOOR button in Measure tab (part type selector)',
        'DRAWER Button': 'üü¶ DRAWER button in Measure tab (part type selector)',
        'CUSTOM Button': 'üü™ CUSTOM button in Measure tab (part type selector)',
        'FLAT Mode Active': 'üî≤ FLAT button when SELECTED (active state)',
        'FLAT Mode Inactive': '‚¨ú FLAT button when NOT selected (inactive state)',
        'MOULDED Mode Active': 'üî≤ MOULDED button when SELECTED (active state)',
        'MOULDED Mode Inactive': '‚¨ú MOULDED button when NOT selected (inactive state)',
        'SS Mode Background': '‚¨õ SS (Single Sided) edge mode background when SELECTED',
        'SS Mode Text': 'üü® SS (Single Sided) edge mode text color when SELECTED',
        'DS Mode Background': '‚¨õ DS (Double Sided) edge mode background when SELECTED',
        'DS Mode Text': 'üü® DS (Double Sided) edge mode text color when SELECTED',
        'SE Mode Background': '‚¨õ SE (Single Edge) mode background when SELECTED',
        'SE Mode Text': 'üü® SE (Single Edge) mode text color when SELECTED',
        '1LR Edge Active': 'üü¢ 1LR (One Left/Right) edge checkbox active color when CHECKED',
        '2SR Edge Active': 'üü¢ 2SR (Two Side Right) edge checkbox active color when CHECKED'
    };
    
    let appColors = JSON.parse(localStorage.getItem('appColors')) || defaultColors;
    
    function renderColorCustomizer() {
        const target = document.getElementById('colorCustomizerContent');
        if (!target) return;
        
        let html = '';
        
        Object.keys(appColors).forEach(colorName => {
            const colorValue = appColors[colorName];
            const description = colorDescriptions[colorName] || '';
            html += `
                <div style="padding:12px; border:1px solid #ddd; border-radius:6px; background:#fff;">
                    <label style="display:block; font-weight:900; font-size:12px; margin-bottom:2px; color:#000;">${colorName}</label>
                    <div style="font-size:10px; color:#666; margin-bottom:10px; line-height:1.4;">${description}</div>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <input type="color" value="${colorValue}" id="color_${colorName.replace(/[^a-zA-Z0-9]/g, '_')}" onchange="updateAppColor('${colorName}', this.value)" style="width:50px; height:40px; border:1px solid #ddd; border-radius:4px; cursor:pointer;">
                        <input type="text" value="${colorValue}" id="colorText_${colorName.replace(/[^a-zA-Z0-9]/g, '_')}" onchange="updateAppColor('${colorName}', this.value)" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; font-family:monospace;">
                    </div>
                    <div style="padding:12px; border-radius:4px; background:${colorValue}; color:${parseInt(colorValue.replace('#', ''), 16) > 0x888888 ? '#000' : '#fff'}; font-weight:900; text-align:center; font-size:12px;">Preview</div>
                </div>
            `;
        });
        
        html += `<div style="grid-column:1/-1; margin-top:10px; padding:10px; background:#f0f0f0; border-radius:6px; text-align:center;">
            <button onclick="resetAppColors()" style="padding:10px 20px; background:#999; color:#fff; border:none; border-radius:6px; font-weight:900; cursor:pointer;">RESET TO DEFAULT</button>
        </div>`;
        
        target.innerHTML = html;
    }
    
    function updateAppColor(colorName, colorValue) {
        appColors[colorName] = colorValue;
        localStorage.setItem('appColors', JSON.stringify(appColors));
        
        const safeId = colorName.replace(/[^a-zA-Z0-9]/g, '_');
        
        // Update color input and text field
        const colorInput = document.getElementById('color_' + safeId);
        const colorText = document.getElementById('colorText_' + safeId);
        
        if (colorInput) colorInput.value = colorValue;
        if (colorText) colorText.value = colorValue;
        
        applyAppColors();
        notify('‚úì Color Updated');
    }
    
    function resetAppColors() {
        if (confirm('Reset all colors to default?')) {
            appColors = JSON.parse(JSON.stringify(defaultColors));
            localStorage.setItem('appColors', JSON.stringify(appColors));
            renderColorCustomizer();
            applyAppColors();
            notify('‚úì Colors Reset');
        }
    }
    
    function applyAppColors() {
        const root = document.documentElement;
        root.style.setProperty('--primary-blue', appColors['Primary Blue']);
        root.style.setProperty('--gold', appColors['Gold/Highlight']);
        root.style.setProperty('--success', appColors['Success Green']);
        root.style.setProperty('--warning', appColors['Warning Orange']);
        root.style.setProperty('--error', appColors['Error Red']);
    }
    
    // Apply colors on page load
    applyAppColors();
    const defaultMasterMatrix = {
        "Tier 1": { 101: ["Plain", 125, 125, 152, 152], 102: ["J-Mould", 148, 148, 171, 171], 103: ["Sharknose", 148, 148, 171, 171], 104: ["Bevelled Edge", 148, 148, 171, 171] },
        "Tier 2": { 201: ["Ashlee", 148, 148, 171, 171], 202: ["Hamilton", 148, 148, 171, 171], 203: ["Vertical Grooves", 148, 148, 171, 171] },
        "Tier 3": { 301: ["Tarrone", 156, 156, 182, 182], 302: ["Bobby", 156, 156, 182, 182], 303: ["Orford", 156, 156, 182, 182] },
        "Tier 4": { 401: ["Shaker", 171, 171, 194, 194], 402: ["Shaker 45", 171, 171, 194, 194], 403: ["Shaker w/Lines", 180, 180, 203, 203], 404: ["Jack", 180, 180, 203, 203] },
        "Tier 5": { 501: ["Georgia", 183, 183, 211, 211], 502: ["Branxholme", 183, 183, 211, 211], 503: ["Rosebrook", 183, 183, 211, 211] },
        "Other": { 600: ["Benchtop", 160, 160, 160, 160], 700: ["Molding", 110, 110, 110, 110] }
    };
    
    // Load from localStorage or use defaults
    let storedMatrix = null;
    try {
        storedMatrix = JSON.parse(localStorage.getItem('masterMatrix'));
    } catch (e) {
        // If parsing fails, use defaults
    }
    
    let masterMatrix = (storedMatrix && Object.keys(storedMatrix).length > 0) ? storedMatrix : defaultMasterMatrix;
    
    // Always ensure defaults are saved
    localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
    
    // ==================== PAINTWORKZ PDF ENGINE ====================
    // Advanced PDF generation system for Estimates, Quotes, Invoices
    const PaintWorkzEngine = {
        // Data sanitization rules
        rules: {
            filterEdges: (text) => ['0S', '0L', '0SL', '0SR', '0l'].includes(text?.toUpperCase()) ? "" : text,
            getSeries: (code) => code ? code.toString().charAt(0) + "00" : "100"
        },

        // Pricing calculator - integrates with masterMatrix
        calculatePricing: function(part) {
            let paintPrice = 125; // default
            
            // Search through tiers for door profile match
            for (const tierName in masterMatrix) {
                for (const code in masterMatrix[tierName]) {
                    const door = masterMatrix[tierName][code];
                    if (door[0].toLowerCase() === (part.doorProfile || '').toLowerCase()) {
                        // Format: [name, clear, matt, satin, semi, gloss]
                        const finishIndex = part.finish === 'Clear' ? 1 : 
                                          part.finish === 'Matt' ? 2 :
                                          part.finish === 'Satin' ? 3 :
                                          part.finish === 'Semi-Gloss' ? 4 : 5; // Gloss
                        paintPrice = door[finishIndex] || 125;
                        break;
                    }
                }
            }
            
            // SQM calculation
            const sqm = (parseFloat(part.width || 0) / 1000) * (parseFloat(part.height || 0) / 1000) * parseInt(part.qty || 1);
            
            // Multipliers
            let paintMult = 1.0;
            if (part.paintMode === 'DS') paintMult = 2.0;
            if (part.paintMode === 'SE') paintMult = 1.2;
            
            const paintTotal = sqm * paintPrice * paintMult;
            
            return {
                sqm: sqm.toFixed(3),
                paint: paintTotal.toFixed(2),
                total: paintTotal.toFixed(2)
            };
        },

        // Main PDF generator
        generatePDF: function(formType, parts) {
            const { jsPDF } = window.jspdf;
            if (!jsPDF) {
                alert("PDF library not loaded. Please refresh page.");
                return;
            }
            
            const doc = new jsPDF('p', 'mm', 'a4');
            const clientName = document.getElementById('cli')?.value || "Client";
            const jobName = document.getElementById('jNm')?.value || "Job";
            
            if (!parts || parts.length === 0) {
                alert("No parts to generate PDF.");
                return;
            }
            
            // Header
            doc.setFontSize(16).setFont(undefined, 'bold');
            doc.text(`PAINTWORKZ ${formType.toUpperCase()}`, 14, 15);
            
            doc.setFontSize(10).setFont(undefined, 'normal');
            doc.text(`Client: ${clientName}`, 14, 22);
            doc.text(`Job: ${jobName}`, 14, 27);
            doc.text(`Date: ${new Date().toLocaleDateString('en-AU')}`, 14, 32);
            
            // Table headers based on form type
            let columns, body;
            
            if (formType === 'Quote') {
                columns = ["Qty", "Description", "Profile", "Finish", "Price"];
                body = parts.map(p => {
                    const pricing = this.calculatePricing(p);
                    return [
                        p.qty,
                        p.description || `${p.height}x${p.width}x${p.thickness}`,
                        p.doorProfile || "N/A",
                        p.finish || "Satin",
                        `$${pricing.total}`
                    ];
                });
            } else {
                columns = ["Qty", "Description", "Dimensions (LxWxT)", "Specification", "Edges"];
                body = parts.map(p => {
                    const dimString = `${p.height} x ${p.width} x ${p.thickness}`;
                    const specString = `${p.type || 'Panel'} - ${p.paintMode || 'SS'}`;
                    const cleanEdges = this.rules.filterEdges(p.edgeText);
                    return [
                        p.qty,
                        p.description || dimString,
                        dimString,
                        specString,
                        cleanEdges || "‚Äî"
                    ];
                });
            }
            
            // Render table
            doc.autoTable({
                startY: 38,
                head: [columns],
                body: body,
                theme: 'grid',
                styles: { fontSize: 9, cellPadding: 3, valign: 'middle' },
                headStyles: { fillColor: [50, 50, 50], textColor: [212, 175, 55] },
                columnStyles: { 0: { halign: 'center', fontStyle: 'bold' } },
                didDrawPage: (data) => {
                    doc.setFontSize(8);
                    doc.text(`Page ${doc.internal.getNumberOfPages()}`, 14, doc.internal.pageSize.height - 10);
                }
            });
            
            // Totals
            let finalY = doc.lastAutoTable.finalY + 10;
            const totals = parts.reduce((acc, p) => {
                const pr = this.calculatePricing(p);
                acc.sqm += parseFloat(pr.sqm);
                acc.total += parseFloat(pr.total);
                return acc;
            }, { sqm: 0, total: 0 });
            
            doc.setFontSize(10).setFont(undefined, 'bold');
            doc.text(`Total SQM: ${totals.sqm.toFixed(3)} m¬≤`, 14, finalY);
            doc.text(`Total (ex GST): $${totals.total.toFixed(2)}`, 14, finalY + 6);
            
            doc.save(`${formType}_${jobName}.pdf`);
            console.log(`‚úì PDF generated: ${formType} for ${jobName}`);
        }
    };
    // ==================== PDF PREVIEW SYSTEM ====================
    let currentPDFData = null; // Store current PDF for download
    let currentPDFFilename = 'document.pdf';
    
    function closePDFPreview() {
        document.getElementById('pdfPreviewModal').style.display = 'none';
        currentPDFData = null;
    }
    
    function downloadCurrentPDF() {
        if (!currentPDFData) {
            alert('No PDF to download');
            return;
        }
        const link = document.createElement('a');
        link.href = currentPDFData;
        link.download = currentPDFFilename;
        link.click();
        console.log(`‚úì Downloaded: ${currentPDFFilename}`);
    }
    
    function showPDFPreview(pdfDataUri, filename, title) {
        currentPDFData = pdfDataUri;
        currentPDFFilename = filename;
        document.getElementById('pdfPreviewTitle').textContent = title || 'PDF Preview';
        document.getElementById('pdfPreviewIframe').src = pdfDataUri;
        document.getElementById('pdfPreviewModal').style.display = 'flex';
    }
    // ==================== END PDF PREVIEW SYSTEM ====================
    
    function getSortedTierNames() {
        // Sort tier names: Tier 1, 2, 3, 4, 5, then Other
        const tierNames = Object.keys(masterMatrix);
        return tierNames.sort((a, b) => {
            // Extract numbers from "Tier X"
            const aMatch = a.match(/Tier (\d+)/);
            const bMatch = b.match(/Tier (\d+)/);
            
            if (aMatch && bMatch) {
                // Both are "Tier X" - sort by number
                return parseInt(aMatch[1]) - parseInt(bMatch[1]);
            } else if (aMatch) {
                // a is "Tier X", b is something else - a comes first
                return -1;
            } else if (bMatch) {
                // b is "Tier X", a is something else - b comes first
                return 1;
            } else {
                // Neither are "Tier X" - alphabetical
                return a.localeCompare(b);
            }
        });
    }
    
    // ===== CLIENT DATABASE FUNCTIONS =====
    function getClientDatabase() {
        const db = localStorage.getItem('clientDatabase');
        return db ? JSON.parse(db) : {};
    }
    
    function saveClientDatabase(db) {
        localStorage.setItem('clientDatabase', JSON.stringify(db));
    }
    
    function filterClientList() {
        const searchBox = document.getElementById('clientSearchBox');
        const searchTerm = searchBox.value.toLowerCase().trim();
        const clientRows = document.querySelectorAll('[data-client-name]');
        
        clientRows.forEach(row => {
            const clientName = row.getAttribute('data-client-name').toLowerCase();
            if (clientName.includes(searchTerm) || searchTerm === '') {
                row.style.display = 'flex';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function renderClientsList() {
        const clientsDiv = document.getElementById('clientsList');
        if (!clientsDiv) return;
        
        try {
            const seen = new Set();
            const allClients = [];
            
            // 1. Get from client database (authoritative source)
            const db = getClientDatabase();
            Object.values(db).forEach(client => {
                if (client.name && !seen.has(client.name.toLowerCase())) {
                    allClients.push(client);
                    seen.add(client.name.toLowerCase());
                }
            });
            
            // 2. Get from job history (catch any missing clients)
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            history.forEach(job => {
                if (job.client && !seen.has(job.client.toLowerCase())) {
                    const clientId = 'client-' + btoa(job.client.toLowerCase()).replace(/[^a-zA-Z0-9]/g, '');
                    allClients.push({
                        id: clientId,
                        name: job.client,
                        contactName: '',
                        landline: '',
                        mobile: '',
                        email1: '',
                        email2: '',
                        address: '',
                        town: '',
                        postcode: ''
                    });
                    seen.add(job.client.toLowerCase());
                }
            });
            
            // 3. Get from hardcoded clients array (restore full list)
            if (typeof clients !== 'undefined' && Array.isArray(clients)) {
                clients.forEach(clientName => {
                    if (clientName && !seen.has(clientName.toLowerCase())) {
                        const clientId = 'client-' + btoa(clientName.toLowerCase()).replace(/[^a-zA-Z0-9]/g, '');
                        allClients.push({
                            id: clientId,
                            name: clientName,
                            contactName: '',
                            landline: '',
                            mobile: '',
                            email1: '',
                            email2: '',
                            address: '',
                            town: '',
                            postcode: ''
                        });
                        seen.add(clientName.toLowerCase());
                    }
                });
            }
            
            
            // Sort alphabetically by name
            allClients.sort((a, b) => a.name.localeCompare(b.name));
            
            console.log(`‚úì Admin Clients: ${allClients.length} clients loaded`);
            
            
            if (allClients.length === 0) {
                clientsDiv.innerHTML = '<p style="text-align:center; color:#999; font-size:12px; padding:20px;">No clients yet. Add one to get started!</p>';
                return;
            }
            
            let html = '';
            allClients.forEach(client => {
                html += `<div data-client-name="${client.name}" style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:#fff; border-bottom:1px solid #f0f0f0; flex-shrink:0;">
                    <div style="flex:1;">
                        <div style="font-weight:900; font-size:13px; color:#333;">${client.name}</div>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button onclick="showEditClientForm('${client.id}')" style="background:#2196f3; color:#fff; border:none; padding:8px 14px; border-radius:4px; font-weight:900; font-size:11px; cursor:pointer;">‚úèÔ∏è EDIT</button>
                        <button onclick="if(confirm('Delete ${client.name}?')) { deleteClient('${client.id}'); }" style="background:#ff3b30; color:#fff; border:none; padding:8px 14px; border-radius:4px; font-weight:900; font-size:11px; cursor:pointer;">üóëÔ∏è DELETE</button>
                    </div>
                </div>`;
            });
            
            clientsDiv.innerHTML = html;
        } catch(e) {
            console.error('Error rendering clients list:', e);
            clientsDiv.innerHTML = '<p style="color:red; padding:20px;">Error loading clients</p>';
        }
    }
    function showEditClientForm(clientId) {
        const db = getClientDatabase();
        const client = db[clientId];
        if (!client) return;
        
        const modal = document.createElement('div');
        modal.innerHTML = `
            <div style="background:#fff; border-radius:12px; padding:20px; border:2px solid #2196f3; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:5000; max-width:90%; width:500px; max-height:85vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                <h3 style="margin-top:0; margin-bottom:20px; font-weight:900;">‚úèÔ∏è Edit Client</h3>
                
                <label style="margin-top:10px; font-weight:900; font-size:11px; color:#666;">Client Company Name *</label>
                <input type="text" id="modalClientName" value="${client.name || ''}" placeholder="e.g., ABC Kitchens" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Contact Person Name</label>
                <input type="text" id="modalClientContactName" value="${client.contactName || ''}" placeholder="e.g., John Smith" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Landline</label>
                        <input type="tel" id="modalClientLandline" value="${client.landline || ''}" placeholder="(03) 1234 5678" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Mobile</label>
                        <input type="tel" id="modalClientMobile" value="${client.mobile || ''}" placeholder="0438 803 032" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                </div>
                
                <label style="font-weight:900; font-size:11px; color:#666;">Email Address 1</label>
                <input type="email" id="modalClientEmail1" value="${client.email1 || client.email || ''}" placeholder="john@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Email Address 2 (Optional)</label>
                <input type="email" id="modalClientEmail2" value="${client.email2 || ''}" placeholder="jane@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Street Address</label>
                <input type="text" id="modalClientAddress" value="${client.address || ''}" placeholder="123 Main Street" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Town/City</label>
                        <input type="text" id="modalClientTown" value="${client.town || ''}" placeholder="Geelong" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Postcode</label>
                        <input type="text" id="modalClientPostcode" value="${client.postcode || ''}" placeholder="3220" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button onclick="saveNewClient('${clientId}')" style="flex:1; background:#2196f3; color:#fff; border:none; padding:12px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer;">‚úì Save</button>
                    <button onclick="document.querySelector('div[style*=\"z-index:5000\"]').remove()" style="flex:1; background:#e0e0e0; color:#333; border:none; padding:12px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer;">Cancel</button>
                </div>
            </div>
        `;
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:4999;';
        overlay.onclick = () => { overlay.remove(); modal.remove(); };
        document.body.appendChild(overlay);
        document.body.appendChild(modal);
        document.getElementById('modalClientName').focus();
    }
    
    function showAddClientForm() {
        const newId = 'client-' + Date.now();
        const modal = document.createElement('div');
        modal.innerHTML = `
            <div style="background:#fff; border-radius:12px; padding:20px; border:2px solid #34c759; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:5000; max-width:90%; width:500px; max-height:85vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                <h3 style="margin-top:0; margin-bottom:20px; font-weight:900;">‚ûï Add New Client</h3>
                
                <label style="margin-top:10px; font-weight:900; font-size:11px; color:#666;">Client Company Name *</label>
                <input type="text" id="modalClientName" placeholder="e.g., ABC Kitchens" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Contact Person Name</label>
                <input type="text" id="modalClientContactName" placeholder="e.g., John Smith" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Landline</label>
                        <input type="tel" id="modalClientLandline" placeholder="(03) 1234 5678" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Mobile</label>
                        <input type="tel" id="modalClientMobile" placeholder="0438 803 032" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                </div>
                
                <label style="font-weight:900; font-size:11px; color:#666;">Email Address 1</label>
                <input type="email" id="modalClientEmail1" placeholder="john@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Email Address 2 (Optional)</label>
                <input type="email" id="modalClientEmail2" placeholder="jane@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <label style="font-weight:900; font-size:11px; color:#666;">Street Address</label>
                <input type="text" id="modalClientAddress" placeholder="123 Main Street" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                
                <div style="display:grid; grid-template-columns:2fr 1fr; gap:10px;">
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Town/Suburb</label>
                        <input type="text" id="modalClientTown" placeholder="Sydney" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                    <div>
                        <label style="font-weight:900; font-size:11px; color:#666;">Postcode</label>
                        <input type="text" id="modalClientPostcode" placeholder="2000" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box;">
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <button onclick="document.querySelector('div[style*=z-index:5000]').parentNode.removeChild(document.querySelector('div[style*=z-index:5000]')); document.querySelector('div[style*=z-index:4999]').remove();" style="padding:12px; border:1px solid #ccc; background:#fff; border-radius:6px; font-weight:900; cursor:pointer;">CANCEL</button>
                    <button onclick="saveNewClient('${newId}')" style="padding:12px; border:none; background:#34c759; color:#fff; border-radius:6px; font-weight:900; cursor:pointer;">‚úÖ ADD CLIENT</button>
                </div>
            </div>
            <div style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:4999; background:rgba(0,0,0,0.3);"></div>
        `;
        document.body.appendChild(modal);
        document.getElementById('modalClientName').focus();
    }
    
    function editClient(clientId) {
        const db = getClientDatabase();
        const client = db[clientId];
        if (!client) {
            notify('‚ùå Client not found');
            return;
        }
        
        const modalId = 'editClientModal-' + Date.now();
        const overlayId = 'editOverlay-' + Date.now();
        
        const overlay = document.createElement('div');
        overlay.id = overlayId;
        overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; z-index:4999; background:rgba(0,0,0,0.3); cursor:pointer;';
        
        const modal = document.createElement('div');
        modal.id = modalId;
        modal.style.cssText = 'position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:5000; background:#fff; border-radius:12px; padding:20px; border:2px solid #2196f3; max-width:90%; width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.3);';
        modal.innerHTML = `
            <h3 style="margin-top:0; margin-bottom:20px; font-weight:900;">‚úèÔ∏è Edit Client</h3>
            
            <label style="margin-top:0; display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Company Name *</label>
            <input type="text" id="editClientName" value="${client.name}" placeholder="e.g., ABC Kitchens" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
            
            <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Contact Person Name</label>
            <input type="text" id="editClientContactName" value="${client.contactName || ''}" placeholder="e.g., John Smith" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Landline</label>
                    <input type="tel" id="editClientLandline" value="${client.landline || ''}" placeholder="(03) 1234 5678" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
                </div>
                <div>
                    <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Mobile</label>
                    <input type="tel" id="editClientMobile" value="${client.mobile || ''}" placeholder="0438 803 032" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
                </div>
            </div>
            
            <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Email Address 1</label>
            <input type="email" id="editClientEmail1" value="${client.email1 || client.email || ''}" placeholder="john@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
            
            <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Email Address 2 (Optional)</label>
            <input type="email" id="editClientEmail2" value="${client.email2 || ''}" placeholder="jane@example.com" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
            
            <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Street Address</label>
            <input type="text" id="editClientAddress" value="${client.address || ''}" placeholder="123 Main Street" style="margin-bottom:15px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
            
            <div style="display:grid; grid-template-columns:2fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Town/Suburb</label>
                    <input type="text" id="editClientTown" value="${client.town || ''}" placeholder="Sydney" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
                </div>
                <div>
                    <label style="display:block; font-weight:900; font-size:11px; margin-bottom:5px;">Postcode</label>
                    <input type="text" id="editClientPostcode" value="${client.postcode || ''}" placeholder="2000" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing:border-box; font-size:12px;">
                </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button id="editCancelBtn" style="padding:12px; border:1px solid #ccc; background:#fff; border-radius:6px; font-weight:900; cursor:pointer; font-size:12px;">CANCEL</button>
                <button id="editSaveBtn" style="padding:12px; border:none; background:#2196f3; color:#fff; border-radius:6px; font-weight:900; cursor:pointer; font-size:12px;">üíæ SAVE</button>
            </div>
        `;
        
        document.body.appendChild(overlay);
        document.body.appendChild(modal);
        
        // Add event listeners after modal is in DOM
        document.getElementById('editCancelBtn').addEventListener('click', () => {
            modal.remove();
            overlay.remove();
        });
        
        document.getElementById('editSaveBtn').addEventListener('click', () => {
            const newName = document.getElementById('editClientName').value.trim();
            const contactName = document.getElementById('editClientContactName').value.trim();
            const landline = document.getElementById('editClientLandline').value.trim();
            const mobile = document.getElementById('editClientMobile').value.trim();
            const email1 = document.getElementById('editClientEmail1').value.trim();
            const email2 = document.getElementById('editClientEmail2').value.trim();
            const address = document.getElementById('editClientAddress').value.trim();
            const town = document.getElementById('editClientTown').value.trim();
            const postcode = document.getElementById('editClientPostcode').value.trim();
            
            if (!newName) {
                alert('Company name is required!');
                return;
            }
            
            // CRITICAL: Capture OLD name BEFORE updating database
            const db = getClientDatabase();
            const oldName = db[clientId].name;
            
            // Now update the database with ALL fields
            db[clientId] = { 
                id: clientId, 
                name: newName, 
                contactName: contactName,
                landline: landline,
                mobile: mobile,
                email1: email1,
                email2: email2,
                address: address,
                town: town,
                postcode: postcode,
                createdDate: db[clientId].createdDate 
            };
            saveClientDatabase(db);
            
            console.log(`‚úèÔ∏è EDITING CLIENT: "${oldName}" ‚Üí "${newName}"`);
            
            // SYNC: Update all jobs that reference this client in ALL storage locations
            let jobsSynced = 0;
            
            // 1. Update paintworkz-jobs (working jobs)
            try {
                const jobsJson = localStorage.getItem('paintworkz-jobs') || '[]';
                let jobs = JSON.parse(jobsJson);
                jobs = jobs.map(job => {
                    if (job.client && job.client.id === clientId) {
                        job.client.name = newName;
                        job.client.contactName = contactName;
                        job.client.landline = landline;
                        job.client.mobile = mobile;
                        job.client.email1 = email1;
                        job.client.email2 = email2;
                        job.client.address = address;
                        job.client.town = town;
                        job.client.postcode = postcode;
                        jobsSynced++;
                    }
                    return job;
                });
                localStorage.setItem('paintworkz-jobs', JSON.stringify(jobs));
                console.log(`‚úì Synced to ${jobsSynced} working jobs`);
            } catch(e) {
                console.error('Error syncing to working jobs:', e);
            }
            
            // 2. Update jobHistory (saved/completed jobs)
            try {
                const historyJson = localStorage.getItem('jobHistory') || '[]';
                let history = JSON.parse(historyJson);
                let historySynced = 0;
                history = history.map(job => {
                    // Match by ID if available
                    if (job.client && job.client.id === clientId) {
                        job.client.name = newName;
                        job.client.email = email;
                        job.client.phone = phone;
                        job.client.address = address;
                        historySynced++;
                    } 
                    // Match by OLD name if no ID (legacy jobs)
                    else if (job.clientName === oldName) {
                        job.clientName = newName;
                        historySynced++;
                    }
                    return job;
                });
                localStorage.setItem('jobHistory', JSON.stringify(history));
                jobsSynced += historySynced;
                console.log(`‚úì Synced to ${historySynced} job history entries (total: ${jobsSynced})`);
            } catch(e) {
                console.error('Error syncing to job history:', e);
            }
            
            // 3. Update current job form if it's this client
            try {
                const currentClientField = document.getElementById('cli');
                if (currentClientField && currentClientField.value === oldName) {
                    currentClientField.value = newName;
                    console.log('‚úì Updated current job client field');
                }
            } catch(e) {
                console.warn('Could not update current job client field:', e);
            }
            
            console.log(`‚úÖ CLIENT UPDATED: ${oldName} ‚Üí ${newName} (${jobsSynced} jobs synced)`);
            modal.remove();
            overlay.remove();
            notify(`‚úì Client Updated: ${newName}\n(${jobsSynced} jobs synced)`);
            renderClientsList();
            populateClientDropdown();  // Refresh dropdown to show updated names without duplicates
            renderHistory();  // Refresh history to show updated names
        });
        
        overlay.addEventListener('click', () => {
            modal.remove();
            overlay.remove();
        });
        
        document.getElementById('editClientName').focus();
    }
    
    function saveNewClient(clientId) {
        const name = document.getElementById('modalClientName').value.trim();
        const contactName = document.getElementById('modalClientContactName').value.trim();
        const landline = document.getElementById('modalClientLandline').value.trim();
        const mobile = document.getElementById('modalClientMobile').value.trim();
        const email1 = document.getElementById('modalClientEmail1').value.trim();
        const email2 = document.getElementById('modalClientEmail2').value.trim();
        const address = document.getElementById('modalClientAddress').value.trim();
        const town = document.getElementById('modalClientTown').value.trim();
        const postcode = document.getElementById('modalClientPostcode').value.trim();
        
        if (!name) {
            alert('Client name is required!');
            return;
        }
        
        const db = getClientDatabase();
        db[clientId] = { 
            id: clientId, 
            name, 
            contactName, 
            landline, 
            mobile, 
            email1, 
            email2, 
            address, 
            town, 
            postcode,
            createdDate: new Date().toISOString()
        };
        saveClientDatabase(db);
        
        document.querySelectorAll('div[style*="z-index:5000"], div[style*="z-index:4999"]').forEach(el => el.remove());
        addAdminAlert('NEW_CLIENT', `‚úÖ NEW CLIENT ADDED: "${name}"`, {clientName: name});
        renderClientsList();
    }
    
    
    // Type-ahead dropdown for client search and selection

    function deleteClient(clientId) {
        const db = getClientDatabase();
        
        // Try to find client by ID first
        let client = db[clientId];
        let clientName = client ? client.name : null;
        
        // If not found by ID, try to extract name from the hash-based ID and search
        if (!clientName) {
            // Look through all clients to find matching ID
            Object.values(db).forEach(c => {
                const hashId = 'client-' + btoa(c.name.toLowerCase()).replace(/[^a-zA-Z0-9]/g, '');
                if (hashId === clientId) {
                    client = c;
                    clientName = c.name;
                }
            });
        }
        
        if (!clientName) {
            console.error(`Client not found: ${clientId}`);
            return;
        }
        
        // 1. Delete from database if it exists
        if (client && client.id) {
            delete db[client.id];
            saveClientDatabase(db);
            console.log(`‚úì Deleted ${clientName} from database`);
        }
        
        // 2. Remove ALL jobs with this client from job history
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const originalCount = history.length;
        const filteredHistory = history.filter(job => job.client && job.client.toLowerCase() !== clientName.toLowerCase());
        localStorage.setItem('jobHistory', JSON.stringify(filteredHistory));
        console.log(`‚úì Removed ${originalCount - filteredHistory.length} jobs for ${clientName} from jobHistory`);
        
        // 3. Remove from legacy clients array
        if (typeof clients !== 'undefined' && Array.isArray(clients)) {
            const originalLen = clients.length;
            clients = clients.filter(c => c && c.toLowerCase() !== clientName.toLowerCase());
            console.log(`‚úì Removed from legacy clients array (${originalLen} ‚Üí ${clients.length})`);
        }
        
        addAdminAlert('CLIENT_DELETED', `üóëÔ∏è CLIENT DELETED: "${clientName}"`, {clientName: clientName});
        
        // Refresh the lists
        renderClientsList(); // Admin tab
        populateClientDropdown(); // Measure tab
        console.log(`‚úì Client lists refreshed`);
    }
    
    function renderPricingMatrix() {
        const target = document.getElementById('admin-pricing-matrix');
        if (!target) return;
        
        
        let html = `
            <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
                <button onclick="clearFirebaseProfilesData()" style="background:#2196f3; color:#fff; border:none; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">
                    üîÑ SYNC TO FIREBASE (Keep Assignments)
                </button>
                <button onclick="diagnoseStorage()" style="background:#9c27b0; color:#fff; border:none; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;" title="Debug: Check console (F12) to see what's in storage">
                    üîç DIAGNOSE STORAGE
                </button>
            </div>
            <p style="font-size:10px; color:#666; margin-bottom:15px; background:#fffaf0; padding:10px; border-radius:4px; border-left:3px solid #ff9500;">
                <strong style="color:#2196f3;">‚úì Sync to Firebase:</strong> Clears stale Firebase, keeps YOUR current assignments<br>
                <strong style="color:#9c27b0;">üîç Diagnose:</strong> Shows exactly what's in browser storage (check console F12)
            </p>
            
            <table style="width:100%; border-collapse:collapse; font-size:10px; background:#fff;">
                <tr style="background:#000; color:var(--gs); font-weight:900;">
                    <th style="padding:8px; text-align:left; width:150px;">Profile</th>
                    <th style="padding:8px; text-align:center;">Matt</th>
                    <th style="padding:8px; text-align:center;">Satin</th>
                    <th style="padding:8px; text-align:center;">Semi-Gloss</th>
                    <th style="padding:8px; text-align:center;">Gloss</th>
                </tr>
        `;
        
        const sortedTiers = getSortedTierNames();
        sortedTiers.forEach(tierName => {
            html += `<tr style="background:#eee;"><td colspan="5" style="padding:8px; font-weight:900; color:#000;">${tierName}</td></tr>`;
            
            const tier = masterMatrix[tierName];
            Object.keys(tier).forEach(code => {
                const data = tier[code];
                const profileName = data[0];
                const prices = data.slice(1);
                
                html += `<tr>
                    <td style="padding:8px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:900; cursor:pointer;" onclick="editDoorName('${tierName}', ${code}, '${profileName}')" title="Click to edit name">${profileName}</div>
                                <div style="font-size:9px; color:#999;">(${code})</div>
                            </div>
                            <div style="display:flex; gap:4px;">
                                <button onclick="editDoorTier('${tierName}', ${code}, '${profileName}')" style="background:#2196f3; color:#fff; border:none; padding:4px 6px; border-radius:3px; font-weight:900; font-size:9px; cursor:pointer;" title="Change tier">üîÑ</button>
                                <button onclick="deleteDoorFromMatrix('${tierName}', ${code}, '${profileName}')" style="background:#ff3b30; color:#fff; border:none; padding:4px 6px; border-radius:3px; font-weight:900; font-size:9px; cursor:pointer;" title="Delete door">‚úï</button>
                            </div>
                        </div>
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[0]}" onchange="updatePricingMatrix('${tierName}', ${code}, 0, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[1]}" onchange="updatePricingMatrix('${tierName}', ${code}, 1, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[2]}" onchange="updatePricingMatrix('${tierName}', ${code}, 2, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[3]}" onchange="updatePricingMatrix('${tierName}', ${code}, 3, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                </tr>`;
            });
        });
        
        // GET UNALLOCATED DOORS FIRST (before using them in HTML)
        const unallocatedDoors = getUnallocatedDoors();
        
        // Unallocated Doors Section
        html += `<tr style="background:#fff3cd; border-top:3px solid #ffb300;"><td colspan="5" style="padding:12px; font-weight:900; color:#000; font-size:12px;">‚ö†Ô∏è UNALLOCATED DOORS (${unallocatedDoors.length} to assign)</td></tr>
        <tr style="background:#ffe0b2;"><td colspan="5" style="padding:10px; font-size:10px; color:#000; border-bottom:2px solid #ff9800;">
            <strong>üìã HOW TO ALLOCATE:</strong><br>
            1Ô∏è‚É£ Set prices for each finish (or use defaults)<br>
            2Ô∏è‚É£ Select a tier from the dropdown<br>
            3Ô∏è‚É£ Click <strong>‚úì ASSIGN TO TIER</strong><br>
            üóëÔ∏è To delete a door permanently: use the <strong>‚úï button in this table</strong>
        </td></tr>`;
        
        if (unallocatedDoors.length > 0) {
            unallocatedDoors.forEach(door => {
                html += `<tr style="background:#fffaf0;">
                    <td style="padding:8px; max-width:150px;">
                        <div style="font-weight:900; word-break:break-word;">${door.name}</div>
                        <div style="font-size:9px; color:#999;">Unassigned</div>
                    </td>
                    <td colspan="5" style="padding:8px; text-align:center;">
                        <div style="display:flex; gap:5px; margin-bottom:5px; flex-wrap:wrap; justify-content:center;">
                            <input type="number" inputmode="numeric" id="unalloc_matt_${door.code}" value="125" placeholder="Matt" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                            <input type="number" inputmode="numeric" id="unalloc_satin_${door.code}" value="125" placeholder="Satin" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                            <input type="number" inputmode="numeric" id="unalloc_semigloss_${door.code}" value="152" placeholder="Semi" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                            <input type="number" inputmode="numeric" id="unalloc_gloss_${door.code}" value="152" placeholder="Gloss" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                        </div>
                        <select id="unalloc_tier_${door.code}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:10px; margin-bottom:5px;">
                            <option value="">Select Tier...</option>
                            ${getSortedTierNames().map(t => `<option value="${t}">${t}</option>`).join('')}
                        </select>
                        <div style="display:flex; gap:5px;">
                            <button onclick="assignDoorToTier('${door.code}', '${door.name}')" style="flex:1; padding:8px; background:#34c759; color:#fff; border:none; border-radius:4px; font-weight:900; font-size:11px; cursor:pointer; box-shadow:0 2px 4px rgba(0,0,0,0.1);">‚úì ASSIGN</button>
                            <button onclick="deleteUnallocatedDoor('${door.code}', '${door.name}')" style="padding:8px 6px; background:#ff3b30; color:#fff; border:none; border-radius:4px; font-weight:900; font-size:11px; cursor:pointer;" title="Delete door permanently">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>`;
            });
        } else {
            html += `<tr style="background:#fffaf0;"><td colspan="5" style="padding:12px; text-align:center; color:#999; font-size:11px;">‚úì All doors allocated!</td></tr>`;
        }
        
        html += `</table>`;
        target.innerHTML = html;
    }
    
    function getUnallocatedDoors() {
        // Get doors that are in database but not in price matrix tiers
        const doorsInMatrix = new Set();
        Object.values(masterMatrix).forEach(tier => {
            Object.keys(tier).forEach(code => {
                const doorName = tier[code][0];
                // Add both the full name and the base name (without code suffix)
                doorsInMatrix.add(doorName);
                // Also add without parenthetical code suffix
                const baseNameOnly = doorName.split('(')[0].trim();
                doorsInMatrix.add(baseNameOnly);
            });
        });
        
        console.log('üîç Doors in matrix:', Array.from(doorsInMatrix));
        console.log('üìã All profiles:', profiles);
        
        const unallocated = [];
        profiles.forEach((profileName, idx) => {
            // Extract base name (without code suffix like "(101)")
            const baseName = profileName.split('(')[0].trim();
            
            // Check if either full name or base name is in matrix
            const isAllocated = doorsInMatrix.has(profileName) || doorsInMatrix.has(baseName);
            
            if (!isAllocated) {
                console.warn(`  ‚ö†Ô∏è NOT FOUND: "${profileName}" (base: "${baseName}")`);
                unallocated.push({ name: profileName, code: 9000 + idx });
            } else {
                console.log(`  ‚úì ALLOCATED: "${profileName}"`);
            }
        });
        
        console.log(`Final unallocated: ${unallocated.length}`, unallocated);
        return unallocated;
    }
    
    function assignDoorToTier(code, doorName) {
        const tier = document.getElementById(`unalloc_tier_${code}`).value;
        if (!tier) {
            alert('Please select a tier');
            return;
        }
        
        const matt = parseFloat(document.getElementById(`unalloc_matt_${code}`).value) || 125;
        const satin = parseFloat(document.getElementById(`unalloc_satin_${code}`).value) || 125;
        const semiGloss = parseFloat(document.getElementById(`unalloc_semigloss_${code}`).value) || 152;
        const gloss = parseFloat(document.getElementById(`unalloc_gloss_${code}`).value) || 152;
        
        console.log(`‚úÖ ASSIGNING: "${doorName}" ‚Üí ${tier}`);
        console.log(`  Before: ${profiles.length} profiles in array`);
        console.log(`  Prices: Matt=${matt}, Satin=${satin}, Semi=${semiGloss}, Gloss=${gloss}`);
        
        // Add to tier
        const newCode = parseInt(Object.keys(masterMatrix[tier]).sort().reverse()[0]) + 1;
        masterMatrix[tier][newCode] = [doorName, matt, satin, semiGloss, gloss];
        console.log(`  ‚úì Added to masterMatrix[${tier}][${newCode}]`);
        
        localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
        
        // NOTE: DO NOT remove from profiles array!
        // Door should remain in profiles (ALL doors) and just be marked as allocated in masterMatrix
        console.log(`  ‚ÑπÔ∏è Door REMAINS in profiles array (${profiles.length} profiles)`);
        console.log(`  ‚ÑπÔ∏è Door will no longer appear in unallocated section (because it's now in ${tier})`);
        
        // Sync to Firebase
        syncProfilesToFirebase();
        
        renderPricingMatrix();
        refreshLists(); // Update measure tab dropdown
        notify(`‚úì ${doorName} assigned to ${tier}`);
    }
    
    function deleteUnallocatedDoor(code, doorName) {
        console.log(`üóëÔ∏è DELETE BUTTON CLICKED for: ${doorName}`);
        if (!confirm(`üö® DELETE PERMANENTLY: "${doorName}"?\n\nThis will remove it from your profile database!`)) {
            console.log(`  ‚úó Deletion cancelled`);
            return;
        }
        
        console.log(`  ‚úì User confirmed deletion`);
        console.log(`  Removing "${doorName}" from profiles array (was ${profiles.length} items)`);
        
        // Remove from profiles array
        profiles = profiles.filter(p => p !== doorName);
        saveProfilesToStorage(); // SAVE TO STORAGE
        console.log(`  ‚úì Removed from profiles array. Now ${profiles.length} items`);
        console.log(`  Current profiles:`, profiles);
        
        // Sync to Firebase
        syncProfilesToFirebase();
        
        renderPricingMatrix();
        refreshLists(); // Update database tab
        notify(`üóëÔ∏è ${doorName} permanently deleted`);
    }
    
    function updatePricingMatrix(tier, code, priceIndex, val) {
        masterMatrix[tier][code][priceIndex + 1] = parseFloat(val);
        localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
        notify('‚úì Price Updated');
    }
    
    // Edit door name in price matrix
    function editDoorName(tier, code, oldName) {
        const newName = prompt(`Edit door name:\n\nCurrent: ${oldName}`, oldName);
        if (newName && newName.trim() !== '' && newName.trim() !== oldName) {
            const trimmed = newName.trim();
            // Update in masterMatrix
            masterMatrix[tier][code][0] = trimmed;
            localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
            
            // Update in profiles array
            const idx = profiles.indexOf(oldName);
            if (idx > -1) {
                profiles[idx] = trimmed;
                saveProfilesToStorage();
            }
            
            renderPricingMatrix();
            notify(`‚úì Renamed to "${trimmed}"`);
        }
    }
    
    // Change door tier in price matrix
    function editDoorTier(tier, code, doorName) {
        const tierNames = getSortedTierNames();
        let selection = 'EXISTING TIERS:\n';
        tierNames.forEach(t => selection += '  ‚Ä¢ ' + t + '\n');
        
        const newTier = prompt(`Move "${doorName}" to which tier?\n\n${selection}\n(Type "Tier X" to move to existing or create new)`, tier);
        
        if (!newTier || newTier === tier) {
            return; // No change or cancelled
        }
        
        const trimmedTier = newTier.trim();
        
        // Get the door data
        const doorData = masterMatrix[tier][code];
        
        // Check if tier exists
        if (!masterMatrix[trimmedTier]) {
            // Create new tier
            masterMatrix[trimmedTier] = {};
            console.log(`‚úì Created new tier: "${trimmedTier}"`);
        }
        
        // Find new code in target tier (next available)
        const newCode = parseInt(Object.keys(masterMatrix[trimmedTier]).sort().reverse()[0] || 0) + 1;
        
        // Move to new tier
        masterMatrix[trimmedTier][newCode] = doorData;
        delete masterMatrix[tier][code];
        
        // If old tier is now empty, delete it
        if (Object.keys(masterMatrix[tier]).length === 0) {
            delete masterMatrix[tier];
            console.log(`‚úì Deleted empty tier: "${tier}"`);
        }
        
        localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
        
        renderPricingMatrix();
        notify(`‚úì Moved to ${trimmedTier}`);
    }
    
    // Delete door from price matrix (returns it to unallocated)
    function deleteDoorFromMatrix(tier, code, doorName) {
        if (!confirm(`Remove "${doorName}" from ${tier}?\n\nIt will appear as unallocated.`)) {
            return;
        }
        
        delete masterMatrix[tier][code];
        localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
        
        renderPricingMatrix();
        notify(`üóëÔ∏è Removed from tier`);
    }

    // TIMELINE EDITOR
    let timelineEditMode = null; // 'default' or jobIdx
    let timelineEditData = {};

    function getDefaultTimeline() {
        const defaults = JSON.parse(localStorage.getItem('defaultTimeline')) || {
            measuring: 2,
            sanding1: 16,
            undercoat: 18,
            sanding2: 20,
            topcoat: 22,
            inspect: 24,
            complete: 25
        };
        return defaults;
    }

    function editDefaultTimeline() {
        timelineEditMode = 'default';
        timelineEditData = getDefaultTimeline();
        renderTimelineEditor();
    }
    
    // Load default settings
    function loadDefaultSettings() {
        const settings = JSON.parse(localStorage.getItem('paintworkz-defaults')) || {};
        return {
            thickness: settings.thickness || 18,
            seReturn: settings.seReturn || 100
        };
    }
    
    // Save default settings
    function saveDefaultSettings() {
        const thickness = parseFloat(document.getElementById('defaultThickness')?.value) || 18;
        const seReturn = parseFloat(document.getElementById('defaultSEReturn')?.value) || 100;
        
        const settings = {
            thickness: thickness,
            seReturn: seReturn
        };
        
        localStorage.setItem('paintworkz-defaults', JSON.stringify(settings));
        showGlobalNotification(`‚úì DEFAULTS SAVED\nThickness: ${thickness}mm ‚Ä¢ SE Return: ${seReturn}mm`, '#e8f5e9', '#34c759');
        console.log('‚úì Default settings saved:', settings);
    }
    
    // Load defaults on page load
    function initializeDefaultSettings() {
        const settings = loadDefaultSettings();
        const thkInput = document.getElementById('defaultThickness');
        const seInput = document.getElementById('defaultSEReturn');
        
        if (thkInput) thkInput.value = settings.thickness;
        if (seInput) seInput.value = settings.seReturn;
        
        // Also set measure tab thickness field to default
        const measureThk = document.getElementById('thk');
        if (measureThk) measureThk.value = settings.thickness;
        
        console.log('‚úì Default settings loaded:', settings);
    }

    function editJobTimeline(jobIdx) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[jobIdx];
        
        if (!job) return;
        
        timelineEditMode = jobIdx;
        timelineEditData = job.timeline || getDefaultTimeline();
        renderTimelineEditor();
    }

    function renderTimelineEditor() {
        const content = document.getElementById('timelineEditorContent');
        if (!content) return; // Safety check
        const isDefault = timelineEditMode === 'default';
        
        content.innerHTML = `
            <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Measuring Phase End Day</label>
                    <input type="number" id="edit_measuring" value="${timelineEditData.measuring || 2}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Sanding 1 Phase End Day</label>
                    <input type="number" id="edit_sanding1" value="${timelineEditData.sanding1 || 16}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Undercoat Phase End Day</label>
                    <input type="number" id="edit_undercoat" value="${timelineEditData.undercoat || 18}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Sanding 2 Phase End Day</label>
                    <input type="number" id="edit_sanding2" value="${timelineEditData.sanding2 || 20}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Top Coat Phase End Day</label>
                    <input type="number" id="edit_topcoat" value="${timelineEditData.topcoat || 22}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Inspect & Wrap Phase End Day</label>
                    <input type="number" id="edit_inspect" value="${timelineEditData.inspect || 24}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Complete Day (Job Finished)</label>
                    <input type="number" id="edit_complete" value="${timelineEditData.complete || 25}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div id="timelinePreview" style="background:#e8f5e9; padding:12px; border-radius:6px; border-left:4px solid #34c759; margin-top:15px;">
                    <div style="font-size:10px; color:#333; font-weight:700; line-height:1.6;">
                        <strong style="font-size:11px;">üìÖ Timeline Preview:</strong><br>
                        Days 0-2: Measuring<br>
                        Days 2-16: Sanding 1<br>
                        Days 16-18: Undercoat<br>
                        Days 18-20: Sanding 2<br>
                        Days 20-22: Top Coat<br>
                        Days 22-24: Inspect & Wrap<br>
                        Days 24-25: Complete
                    </div>
                </div>
            </div>
        `;
        
        updateTimelinePreview();
        document.getElementById('timelineModal').style.display = 'flex';
    }

    function updateTimelinePreview() {
        const measuring = parseInt(document.getElementById('edit_measuring')?.value) || 2;
        const sanding1 = parseInt(document.getElementById('edit_sanding1')?.value) || 16;
        const undercoat = parseInt(document.getElementById('edit_undercoat')?.value) || 18;
        const sanding2 = parseInt(document.getElementById('edit_sanding2')?.value) || 20;
        const topcoat = parseInt(document.getElementById('edit_topcoat')?.value) || 22;
        const inspect = parseInt(document.getElementById('edit_inspect')?.value) || 24;
        const complete = parseInt(document.getElementById('edit_complete')?.value) || 25;
        
        const preview = document.getElementById('timelinePreview');
        if (preview) {
            preview.innerHTML = `
                <div style="font-size:10px; color:#333; font-weight:700; line-height:1.6;">
                    <strong style="font-size:11px;">üìÖ Timeline Preview:</strong><br>
                    Days 0-${measuring}: <span style="color:#2196f3; font-weight:900;">Measuring</span><br>
                    Days ${measuring}-${sanding1}: <span style="color:#ff9500; font-weight:900;">Sanding 1</span><br>
                    Days ${sanding1}-${undercoat}: <span style="color:#8b4513; font-weight:900;">Undercoat</span><br>
                    Days ${undercoat}-${sanding2}: <span style="color:#ff9500; font-weight:900;">Sanding 2</span><br>
                    Days ${sanding2}-${topcoat}: <span style="color:#9c27b0; font-weight:900;">Top Coat</span><br>
                    Days ${topcoat}-${inspect}: <span style="color:#673ab7; font-weight:900;">Inspect & Wrap</span><br>
                    Days ${inspect}-${complete}: <span style="color:#34c759; font-weight:900;">Complete</span>
                </div>
            `;
        }
    }

    function saveTimelineEdit() {
        const measuring = parseInt(document.getElementById('edit_measuring').value);
        const sanding1 = parseInt(document.getElementById('edit_sanding1').value);
        const undercoat = parseInt(document.getElementById('edit_undercoat').value);
        const sanding2 = parseInt(document.getElementById('edit_sanding2').value);
        const topcoat = parseInt(document.getElementById('edit_topcoat').value);
        const inspect = parseInt(document.getElementById('edit_inspect').value);
        const complete = parseInt(document.getElementById('edit_complete').value);
        
        // Validate order
        if (measuring >= sanding1 || sanding1 >= undercoat || undercoat >= sanding2 || sanding2 >= topcoat || topcoat >= inspect || inspect >= complete) {
            alert('Timeline days must be in ascending order!');
            return;
        }
        
        const timeline = { measuring, sanding1, undercoat, sanding2, topcoat, inspect, complete };
        
        if (timelineEditMode === 'default') {
            // Save default timeline
            localStorage.setItem('defaultTimeline', JSON.stringify(timeline));
            notify('‚úì Default Timeline Updated');
        } else {
            // Save job-specific timeline
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const job = history[timelineEditMode];
            if (job) {
                job.timeline = timeline;
                history[timelineEditMode] = job;
                localStorage.setItem('jobHistory', JSON.stringify(history));
                notify('‚úì Job Timeline Updated');
            }
        }
        
        closeTimelineModal();
        renderScheduleCalendar();
    }

    function closeTimelineModal() {
        document.getElementById('timelineModal').style.display = 'none';
        timelineEditMode = null;
    }

    function prevScheduleMonth() {
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() - 1);
        renderScheduleCalendar();
    }

    function nextScheduleMonth() {
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() + 1);
        renderScheduleCalendar();
    }
    
    function toggleJobsChart() {
        const wrapper = document.getElementById('ganttWrapper');
        const monthYear = document.getElementById('scheduleMonthYear');
        const btn = document.getElementById('jobsChartToggleBtn');
        
        if (!wrapper) return;
        
        const isMinimized = localStorage.getItem('jobsChartMinimized') === 'true';
        
        if (isMinimized) {
            // Restore (maximize)
            wrapper.style.display = 'block';
            monthYear.style.display = 'block';
            btn.textContent = '‚àí';
            btn.style.background = '#2196f3';
            btn.title = 'Minimize';
            localStorage.setItem('jobsChartMinimized', 'false');
            console.log('üìä Jobs Chart maximized');
        } else {
            // Minimize
            wrapper.style.display = 'none';
            monthYear.style.display = 'none';
            btn.textContent = '+';
            btn.style.background = '#666';
            btn.title = 'Maximize';
            localStorage.setItem('jobsChartMinimized', 'true');
            console.log('üìä Jobs Chart minimized');
        }
    }
    
    // Restore Jobs Chart state on page load
    function restoreJobsChartState() {
        const isMinimized = localStorage.getItem('jobsChartMinimized') === 'true';
        if (isMinimized) {
            const wrapper = document.getElementById('ganttWrapper');
            const monthYear = document.getElementById('scheduleMonthYear');
            const btn = document.getElementById('jobsChartToggleBtn');
            if (wrapper && monthYear && btn) {
                wrapper.style.display = 'none';
                monthYear.style.display = 'none';
                btn.textContent = '+';
                btn.style.background = '#666';
            }
        }
    }
    
    // Restore on page load
    setTimeout(restoreJobsChartState, 500);
    
    function prevAdminScheduleMonth() {
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() - 1);
        renderAdminGanttChart();
    }

    function nextAdminScheduleMonth() {
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() + 1);
        renderAdminGanttChart();
    }
    
    function renderAdminGanttChart() {
        const year = scheduleCalendarDate.getFullYear();
        const month = scheduleCalendarDate.getMonth();
        
        // Set month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        if (document.getElementById('adminScheduleMonthYear')) document.getElementById('adminScheduleMonthYear').innerText = `${monthNames[month]} ${year}`;
        
        const ganttChart = document.getElementById('adminGanttChart');
        if (!ganttChart) return;
        
        try {
            let fullHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            
            // Sort by received date - newest first
            let history = fullHistory
                .filter(job => !job.completed)
                .filter(job => !isJobDeleted(job.jobNum, job.dateReceived, job.client)) // Exclude deleted jobs
                .sort((a, b) => {
                    let dateA = new Date();
                    let dateB = new Date();
                    
                    // Parse dateReceived in DD/MM/YY format
                    if (a.dateReceived) {
                        if (a.dateReceived.includes('/')) {
                            const [day, month, year] = a.dateReceived.split('/');
                            dateA = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                        } else if (a.dateReceived.includes('-')) {
                            dateA = new Date(a.dateReceived);
                        }
                    }
                    
                    if (b.dateReceived) {
                        if (b.dateReceived.includes('/')) {
                            const [day, month, year] = b.dateReceived.split('/');
                            dateB = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                        } else if (b.dateReceived.includes('-')) {
                            dateB = new Date(b.dateReceived);
                        }
                    }
                    
                    return dateB - dateA;
                });
            
            // Build Gantt HTML
            let ganttHTML = '';
            
            // Define phases/timelines
            const phases = ['Prep', 'Paint', 'Assemble', 'Quality'];
            
            // Header
            ganttHTML += `<table style="border-collapse:collapse; width:100%;">
                <tr style="background:#000; color:#fff; border-bottom:3px solid #d4af37;">
                    <th style="padding:12px; text-align:left; width:200px; font-weight:900; font-size:12px;">JOB</th>
                    ${phases.map(p => `<th style="padding:12px; text-align:center; font-weight:900; font-size:11px; border-right:1px solid #fff;">${p}</th>`).join('')}
                </tr>`;
            
            // Rows
            history.forEach((job, idx) => {
                const jobPhases = job.phases || {};
                
                ganttHTML += `<tr style="border-bottom:1px solid #ddd; background:${idx % 2 === 0 ? '#fff' : '#f9f9f9'};">
                    <td style="padding:12px; font-weight:900; font-size:11px; border-right:1px solid #ddd;">
                        <div style="margin-bottom:4px;">#${job.jobNum}</div>
                        <div style="font-size:9px; color:#666;">${job.client}</div>
                    </td>
                    ${phases.map(phase => {
                        const isChecked = jobPhases[phase] || false;
                        return `<td style="text-align:center; padding:8px; border-right:1px solid #ddd;">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleGanttCell(${idx}, '${phase}')" style="width:18px; height:18px; cursor:pointer;">
                        </td>`;
                    }).join('')}
                </tr>`;
            });
            
            ganttHTML += '</table>';
            ganttChart.innerHTML = ganttHTML;
            
        } catch(e) {
            console.error('Error rendering admin Gantt chart:', e);
        }
    }

    function renderJobTasks() {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        let completedTasks = 0;
        let totalTasks = 0;
        
        // Count phases ONLY for ACTIVE (non-completed) jobs
        history.forEach((job, jobIdx) => {
            // Only count tasks for active jobs (not marked as completed)
            if (job.dateReceived && !job.completed) {
                // 7 phases per job: measuring, sanding1, undercoat, sanding2, topcoat, sanding2, topcoat, inspect, complete
                totalTasks += 7;
                
                // Count which phases are completed
                if (job.phases) {
                    if (job.phases.measuring) completedTasks++;
                    if (job.phases.sanding1) completedTasks++;
                    if (job.phases.undercoat) completedTasks++;
                    if (job.phases.sanding2) completedTasks++;
                    if (job.phases.topcoat) completedTasks++;
                    if (job.phases.inspect) completedTasks++;
                    if (job.phases.complete) completedTasks++;
                }
            }
        });
        
        // Update summary
        const activeJobs = history.filter(j => !j.completed).length;
        const totalSqm = history.filter(j => !j.completed).reduce((sum, j) => sum + parseFloat(j.totalSqm || 0), 0);
        
        if (document.getElementById('totalActiveJobs')) document.getElementById('totalActiveJobs').innerText = activeJobs;
        if (document.getElementById('totalTasks')) document.getElementById('totalTasks').innerText = `${completedTasks}/${totalTasks}`;
        if (document.getElementById('totalWorkload')) document.getElementById('totalWorkload').innerText = totalSqm.toFixed(1);
        
        console.log(`üìä Tasks: ${completedTasks}/${totalTasks} | Active Jobs: ${activeJobs}`);
    }

    // PAINT FORMULA MANAGEMENT
    let paintFormulas = JSON.parse(localStorage.getItem('paintFormulas')) || {};

    function openFormulaPopup() {
        const brand = document.getElementById('p-brand').value;
        const color = document.getElementById('p-color').value || "Standard";
        const current = paintFormulas[`${brand}-${color}`] || "10% Thinner, 2:1 Hardener";
        
        let overlay = document.createElement('div');
        overlay.id = 'formula-pop';
        overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
        overlay.innerHTML = `
            <div class="card" style="width:100%; max-width:400px; border:2px solid var(--gs);">
                <h3 style="margin-top:0;">‚öóÔ∏è ${brand} Paint Formula</h3>
                <p style="font-size:10px; color:#666; margin-bottom:10px;">Editing mix for: <strong>${color}</strong></p>
                <label>Formula Mix Instructions:</label>
                <textarea id="fEdit" style="width:100%; height:100px; border-radius:8px; border:1px solid #ccc; padding:10px; font-family:monospace; font-size:12px; margin-bottom:10px; box-sizing:border-box;">${current}</textarea>
                <div style="display:flex; gap:10px;">
                    <button onclick="saveFormula('${brand}','${color}')" style="flex:1; background:var(--gs); color:#000; border:none; padding:12px; border-radius:8px; font-weight:900; cursor:pointer;">‚úì SAVE</button>
                    <button onclick="closeFormulaPopup()" style="flex:1; background:#444; color:#fff; border:none; border-radius:8px; font-weight:900; cursor:pointer;">CLOSE</button>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
    }

    function closeFormulaPopup() {
        const popup = document.getElementById('formula-pop');
        if (popup) popup.remove();
    }

    function saveFormula(brand, color) {
        const val = document.getElementById('fEdit').value;
        paintFormulas[`${brand}-${color}`] = val;
        localStorage.setItem('paintFormulas', JSON.stringify(paintFormulas));
        closeFormulaPopup();
        notify("‚úì Formula Saved");
    }

    // PAINT FORMULA DATABASE FUNCTIONS
    function getPaintFormulas() {
        return JSON.parse(localStorage.getItem('paintFormulaDB')) || [];
    }

    function savePaintFormulas(formulas) {
        localStorage.setItem('paintFormulaDB', JSON.stringify(formulas));
    }

    function openPaintFormulaDatabase() {
        document.getElementById('paintFormulaModal').style.display = 'flex';
        renderPaintFormulaList();
    }

    function renderPaintFormulaList() {
        const formulas = getPaintFormulas();
        const content = document.getElementById('formulaListContent');
        
        if (formulas.length === 0) {
            content.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:11px;">No formulas in database yet</div>';
            return;
        }
        
        content.innerHTML = '';
        formulas.forEach((formula, idx) => {
            content.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="font-weight:900; font-size:11px; color:#000;">${formula.brand} - ${formula.color}</div>
                    <div style="font-size:10px; color:#666; margin-top:3px;">${formula.formula}</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="selectPaintFormula(${idx})" style="border:none; background:#2196f3; color:#fff; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">SELECT</button>
                    <button onclick="deletePaintFormula(${idx})" style="border:none; background:#ff3b3015; color:#ff3b30; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">DELETE</button>
                </div>
            </div>`;
        });
    }

    function searchPaintFormulas() {
        const brand = document.getElementById('formulaSearchBrand').value.toLowerCase();
        const color = document.getElementById('formulaSearchColor').value.toLowerCase();
        const formulas = getPaintFormulas();
        const content = document.getElementById('formulaListContent');
        
        const filtered = formulas.filter(f => 
            f.brand.toLowerCase().includes(brand) && 
            f.color.toLowerCase().includes(color)
        );
        
        if (filtered.length === 0) {
            content.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:11px;">No matching formulas found</div>';
            return;
        }
        
        content.innerHTML = '';
        filtered.forEach((formula, origIdx) => {
            const idx = formulas.indexOf(formula);
            content.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="font-weight:900; font-size:11px; color:#000;">${formula.brand} - ${formula.color}</div>
                    <div style="font-size:10px; color:#666; margin-top:3px;">${formula.formula}</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="selectPaintFormula(${idx})" style="border:none; background:#2196f3; color:#fff; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">SELECT</button>
                    <button onclick="deletePaintFormula(${idx})" style="border:none; background:#ff3b3015; color:#ff3b30; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">DELETE</button>
                </div>
            </div>`;
        });
    }

    function addNewPaintFormula() {
        const brand = document.getElementById('newFormulaBrand').value.trim();
        const color = document.getElementById('newFormulaColor').value.trim();
        const formula = document.getElementById('newFormulaText').value.trim();
        
        if (!brand || !color || !formula) {
            alert('Please fill in all fields');
            return;
        }
        
        const formulas = getPaintFormulas();
        formulas.push({ brand, color, formula });
        savePaintFormulas(formulas);
        
        document.getElementById('newFormulaBrand').value = '';
        document.getElementById('newFormulaColor').value = '';
        document.getElementById('newFormulaText').value = '';
        
        renderPaintFormulaList();
        notify('‚úì Formula Added to Database');
    }

    function selectPaintFormula(idx) {
        const formulas = getPaintFormulas();
        const formula = formulas[idx];
        
        // Populate measure page fields
        document.getElementById('p-brand').value = formula.brand;
        document.getElementById('p-color').value = formula.color;
        document.getElementById('p-code').value = formula.formula;
        
        closePaintFormulaModal();
        notify(`‚úì Selected: ${formula.brand} - ${formula.color}`);
    }

    function deletePaintFormula(idx) {
        if (confirm('Delete this formula?')) {
            const formulas = getPaintFormulas();
            formulas.splice(idx, 1);
            savePaintFormulas(formulas);
            renderPaintFormulaList();
            notify('‚úì Formula Deleted');
        }
    }

    function autoSearchFormula() {
        const brand = document.getElementById('p-brand').value.trim();
        const color = document.getElementById('p-color').value.trim();
        
        if (!brand || !color) return;
        
        const formulas = getPaintFormulas();
        const match = formulas.find(f => 
            f.brand.toLowerCase() === brand.toLowerCase() && 
            f.color.toLowerCase() === color.toLowerCase()
        );
        
        if (match) {
            document.getElementById('p-code').value = match.formula;
            notify(`‚úì Formula: ${match.formula}`);
        } else {
            notify('Formula not found in database');
        }
    }

    function autoSearchFormulaOnType() {
        const brand = document.getElementById('p-brand').value.trim();
        const color = document.getElementById('p-color').value.trim();
        const code = document.getElementById('p-code').value.trim();
        
        // If code field already has text, don't override (user is typing manually)
        if (code && code.length > 0) return;
        
        if (!brand || !color) return;
        
        const formulas = getPaintFormulas();
        const match = formulas.find(f => 
            f.brand.toLowerCase() === brand.toLowerCase() && 
            f.color.toLowerCase() === color.toLowerCase()
        );
        
        if (match) {
            document.getElementById('p-code').value = match.formula;
        }
    }

    // ============ FIREBASE FUNCTIONS ============

    // Login function
    function handleLogin() {
        // Check if Firebase functions are actually available
        if (!window.firebaseAuth || !window.signInWithEmailAndPassword) {
            alert('Firebase not ready yet, please wait a moment and try again');
            return;
        }
        
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        if (!email || !password) {
            errorDiv.textContent = 'Please fill in all fields';
            errorDiv.style.display = 'block';
            return;
        }
        
        window.signInWithEmailAndPassword(email, password)
            .then(() => {
                errorDiv.style.display = 'none';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
            })
            .catch(error => {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            });
    }

    // Signup wrapper function  
    function trySignup() {
        
        if (!window.firebaseReady) {
            // Wait a moment and try again
            setTimeout(() => {
                if (window.firebaseReady) {
                    handleSignup();
                } else {
                    alert('Firebase is still loading. Please wait a moment and try again.');
                }
            }, 1000);
            return;
        }
        
        handleSignup();
    }

    // Signup function
    function handleSignup() {
        
        if (!window.firebaseAuth || !window.createUserWithEmailAndPassword) {
            alert('Firebase not ready yet, please wait a moment and try again');
            return;
        }
        
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        
        if (!email || !password) {
            errorDiv.textContent = 'Please fill in all fields';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (password.length < 6) {
            errorDiv.textContent = 'Password must be at least 6 characters';
            errorDiv.style.display = 'block';
            return;
        }
        
        window.createUserWithEmailAndPassword(email, password)
            .then(() => {
                errorDiv.style.display = 'none';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                notify('Account created! You are now logged in.');
            })
            .catch(error => {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            });
    }

    // Logout function
    function handleLogout() {
        if (confirm('Log out?')) {
            window.signOut();
        }
    }

    // Save job data to Firebase
    function saveJobToFirebase(jobData) {
        if (!window.currentUser) return;
        
        const jobId = jobData.id || Date.now().toString();
        const jobRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'jobs', jobId);
        window.setDoc(jobRef, {
            ...jobData,
            lastModified: new Date().toISOString(),
            userId: window.currentUser.uid
        }, { merge: true });
    }

    // Load all jobs from Firebase
    async function loadAllDataFromFirebase() {
        if (!window.currentUser) return;
        
        try {
            // Build reference to jobs subcollection properly
            const userDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid);
            const jobsCollectionRef = window.collection(userDocRef, 'jobs');
            const snapshot = await window.getDocs(jobsCollectionRef);
            const jobs = [];
            snapshot.forEach(doc => {
                jobs.push({ ...doc.data(), id: doc.id });
            });
            
            // Update localStorage with Firebase data (for compatibility)
            localStorage.setItem('jobHistory', JSON.stringify(jobs));
            fullHistory = jobs;
            history = jobs.filter(j => !j.completed);
            
            // Update UI - wrapped in try/catch
            try {
                if (typeof renderHistory === 'function') renderHistory();
            } catch (e) {
                console.warn('renderHistory error:', e);
            }
        } catch (err) {
            console.error('Error loading jobs from Firebase:', err);
        }
    }

    // Set up real-time listener for jobs
    function setupRealtimeSync() {
        // Guard: Only set up once
        if (window.realtimeSyncActive) {
            console.log('‚ö†Ô∏è Real-time sync already active, skipping duplicate setup');
            return;
        }
        
        if (!window.currentUser) {
            console.warn('setupRealtimeSync: No current user');
            return;
        }
        
        try {
            console.log('üîÑ Setting up real-time sync listener...');
            const userDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid);
            const jobsCollectionRef = window.collection(userDocRef, 'jobs');
            
            // Store the unsubscribe function so we can clean up later
            window.realtimeSyncUnsubscribe = window.onSnapshot(jobsCollectionRef, 
                snapshot => {
                    try {
                        const jobs = [];
                        snapshot.forEach(doc => {
                            jobs.push({ ...doc.data(), id: doc.id });
                        });
                        
                        // Only update if data actually changed
                        const currentHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
                        if (JSON.stringify(currentHistory) !== JSON.stringify(jobs)) {
                            console.log(`üîÑ Real-time update: ${jobs.length} jobs`);
                            localStorage.setItem('jobHistory', JSON.stringify(jobs));
                            
                            // Only re-render if on history tab to avoid excessive re-renders
                            const historySection = document.getElementById('history');
                            if (historySection && historySection.classList.contains('active')) {
                                renderHistory();
                            }
                        }
                    } catch (e) {
                        console.error('Error processing snapshot:', e);
                    }
                }, 
                error => {
                    console.error('Realtime sync error:', error);
                }
            );
            
            console.log('‚úì Real-time sync listener established');
        } catch (e) {
            console.error('setupRealtimeSync error:', e);
        }
    }

    // Track last synced data to avoid redundant syncs
    let lastSyncedData = '';
    let lastSyncTime = 0;
    const SYNC_DEBOUNCE_MS = 2000; // Minimum 2 seconds between syncs
    
    // Helper function to sync all jobs to Firebase
    function syncJobsToFirebase() {
        // Guard: Wait for Firebase to be ready and user to be logged in
        if (!window.firebaseReady || !window.currentUser || !window.firebaseDb || !window.doc || !window.setDoc) {
            console.warn('Firebase not ready or user not logged in. Sync delayed.');
            return;
        }
        
        // Rate limiting - prevent sync spam
        const now = Date.now();
        if (now - lastSyncTime < SYNC_DEBOUNCE_MS) {
            console.log('‚è±Ô∏è Sync rate limited (too soon)');
            return;
        }
        lastSyncTime = now;
        
        try {
            const jobHistory = JSON.parse(localStorage.getItem('jobHistory') || '[]');
            const currentData = JSON.stringify(jobHistory);
            
            // Only sync if data actually changed
            if (currentData === lastSyncedData) {
                console.log('‚ÑπÔ∏è Data unchanged, skipping Firebase sync');
                return;
            }
            
            console.log(`üîÑ Syncing ${jobHistory.length} jobs to Firebase...`);
            lastSyncedData = currentData;
            
            jobHistory.forEach(job => {
                try {
                    const jobId = job.id || job.jobNum || Date.now().toString();
                    const jobDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'jobs', jobId);
                    window.setDoc(jobDoc, {
                        ...job,
                        id: jobId,
                        lastModified: new Date().toISOString(),
                        userId: window.currentUser.uid
                    }, { merge: true }).catch(err => console.error('Firestore sync error for job', jobId, ':', err));
                } catch(e) {
                    console.error('Error syncing individual job:', e);
                }
            });
            
            console.log('‚úì Firebase sync complete');
        } catch (error) {
            console.error('syncJobsToFirebase error:', error);
            // Don't crash the app, just log the error
        }
    }

    // Sync door profiles and price matrix to Firebase
    // This OVERWRITES the Firebase data with current local state
    function syncProfilesToFirebase() {
        if (!window.firebaseReady || !window.currentUser || !window.firebaseDb || !window.doc || !window.setDoc) {
            console.warn('Firebase not ready or user not logged in. Profile sync delayed.');
            return;
        }

        try {
            const configDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'config', 'doorProfiles');
            window.setDoc(configDoc, {
                doorProfiles: profiles,
                masterMatrix: masterMatrix,
                lastModified: new Date().toISOString(),
                userId: window.currentUser.uid,
                syncVersion: Date.now() // Force overwrite of old data
            }, { merge: false }).then(() => {
                console.log(`‚úÖ Profiles synced to Firebase (${profiles.length} profiles, ${Object.keys(masterMatrix).length} tiers)`);
            }).catch(err => {
                console.error('‚ùå Error syncing door profiles to Firebase:', err);
            });
        } catch (error) {
            console.error('syncProfilesToFirebase error:', error);
        }
    }

    // Override localStorage.setItem to auto-sync to Firebase
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
        originalSetItem.call(this, key, value);
        
        // Whenever jobHistory is updated, sync to Firebase
        if (key === 'jobHistory' && window.currentUser) {
            // Retry sync if Firebase isn't quite ready yet
            if (!window.firebaseReady) {
                setTimeout(() => {
                    if (window.currentUser) syncJobsToFirebase();
                }, 500);
            } else {
                syncJobsToFirebase();
            }
        }
    };

    // Attach tab navigation event listeners (run immediately and on DOMContentLoaded for safety)
    function attachTabListeners() {
        document.querySelectorAll('[data-tab]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const tabName = this.getAttribute('data-tab');
                if (typeof tab === 'function') {
                    tab(tabName);
                }
            });
        });
    }
    
    // Try immediately
    setTimeout(attachTabListeners, 100);
    
    // Also attach on DOMContentLoaded in case script runs before DOM is ready
    document.addEventListener('DOMContentLoaded', attachTabListeners);
</script>

</div> <!-- Close appContainer -->
</body>
</html>
