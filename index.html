<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                       PAINTWORKZ PRO 4.8                        ‚ïë
‚ïë                    REVISION TRACKING                            ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë REV 51 | 2026-02-09 | Jobs Chart Toggle + Nuclear Profile Fix  ‚ïë
‚ïë - Added: Minimize/Maximize toggle button for Jobs Chart         ‚ïë
‚ïë - Fixed: NUCLEAR option to clear corrupt profiles (localStorage)‚ïë
‚ïë - Added: Profile corruption detection and auto-cleanup          ‚ïë
‚ïë - Added: Duplicate profile filtering                            ‚ïë
‚ïë - Improved: Firebase sync now uses merge: false (overwrites)    ‚ïë
‚ïë - Previous: Removed admin Gantt, fixed spelling, added numpad   ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <title>PaintWorkz Pro 4.8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <style>
        :root {
            --gold: linear-gradient(145deg, #d4af37, #f9f1b0, #aa841e);
            --rainbow: linear-gradient(90deg, #ff3b30, #ff9500, #ffcc00, #4cd964, #5ac8fa, #007aff, #5856d6);
            --gs: #d4af37;
            --panel-clr: #34c759; --door-clr: #ff9500; --drawer-clr: #2196f3; --custom-clr: #af52de;
            --bg: #f2f2f7;
        }
        body { margin:0; font-family:-apple-system, system-ui, sans-serif; background:var(--bg); padding-bottom:140px; -webkit-tap-highlight-color:transparent; }
        
        header { background:var(--rainbow); padding:env(safe-area-inset-top) 15px 5px; display:flex; align-items:center; justify-content:space-between; border-bottom:4px solid #aa841e; position:sticky; top:0; z-index:1000; height:80px; box-sizing: border-box; }
        .logo-box { background:#000; padding:6px 18px; border-radius:50px; border:2px solid var(--gs); }
        .logo-text { font-weight:900; font-size:20px; background:var(--gold); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .icon-btn { font-size: 28px; padding: 0 10px; cursor: pointer; }

        .nav-tabs { display: flex; background: #000; position: sticky; top: 80px; z-index: 999; overflow-x: auto; border-bottom: 1px solid #333; }
        .nav-btn { flex:1; min-width:80px; padding:12px 0; color:#888; text-align:center; font-weight:900; font-size:10px; text-transform:uppercase; border:none; background:0 0; cursor:pointer; transition:all 0.2s; pointer-events:auto; z-index:100; position:relative; }
        .nav-btn.active { color:#fff; border-bottom:4px solid var(--gs); background:#111; }

        .sub-nav { display: flex; gap: 5px; margin-bottom: 15px; background: #e5e5ea; padding: 4px; border-radius: 10px; }
        .sub-btn { flex: 1; padding: 8px; border: none; border-radius: 7px; font-weight: 800; font-size: 11px; color: #666; background: transparent; cursor:pointer; transition:all 0.2s; }
        .sub-btn.active { background: #fff; color: #000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .container { padding: 15px; max-width: 600px; margin: auto; }
        .view-section { display:none; } .view-section.active { display:block; }
        .card { background:#fff; border-radius:12px; padding:15px; margin-bottom:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position:relative; overflow:visible; }

        label { font-size: 10px; font-weight: 900; color: #666; text-transform: uppercase; margin-bottom: 2px; display: block; }
        input, select { width:100%; height:45px; border-radius:8px; border:1px solid #ccc; padding:0 10px; font-size:16px; box-sizing:border-box; background:#fff; margin-bottom: 8px; font-weight: 600; }
        
        .db-list { max-height: 400px; overflow-y: auto; background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; }
        .db-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; font-weight: 600; }
        .db-del { color: red; font-weight: 900; padding: 5px; cursor:pointer; }
        .add-row { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-small { background: #000; color: var(--gs); border: none; border-radius: 8px; font-weight: 900; width: 60px; height:45px; cursor:pointer; transition:all 0.2s; }
        .btn-small:hover { background: #222; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-card { background: #f2f2f7; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #ddd; cursor: pointer; transition:all 0.2s; }
        .form-card:active { transform: scale(0.98); background: #e5e5ea; }
        .form-card h4 { margin: 0 0 5px; font-size: 14px; color: #333; }
        .form-card p { margin: 0; font-size: 10px; color: #888; font-weight: 600; }

        .bubble-row { display: flex; gap: 6px; margin: 8px 0; }
        .fm-row { display:flex; background:#eee; border-radius:8px; padding:4px; margin-bottom:10px; height: 50px; align-items: center; box-sizing: border-box; }
        .fm-opt { flex:1; text-align:center; height: 42px; line-height: 42px; font-weight:900; font-size:12px; border-radius:6px; color:#aaa; cursor:pointer; transition:all 0.2s; }
        .fm-opt.active { background:#fff; color:#000; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
        
        .bubble-unit { flex: 1; background: #fff; border: 1px solid #ccc; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 50px; box-sizing: border-box; }
        .bubble-unit input { border: none; background: transparent; text-align: center; font-size: 18px; font-weight: 900; height: 25px; margin:0; padding:0; width: 100%; }

        #prof-select { height: 50px !important; margin: 0; }

        .p-card { flex:1; background:#fff; border:2px solid #ddd; border-radius:8px; padding:8px 2px; text-align:center; font-weight:900; font-size:9px; color:#444; display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; transition:all 0.2s; }
        .p-card.active { border-color:var(--gs); background:#fff9e6; color:#000; }
        .p-card svg { width:22px; height:22px; stroke: currentColor; fill:none; stroke-width:2; }

        .edge-row { display:flex; justify-content:space-between; align-items:center; margin:15px 0; gap:6px; }
        .edge-box { flex:1; height:45px; border-radius:8px; border:2px solid #ddd; background:#fff; display:flex; align-items:center; justify-content:center; font-weight:900; color:#ccc; font-size:14px; user-select:none; cursor:pointer; transition:all 0.2s; }
        .edge-box.active { background:#34c759; border-color:#28a745; color:#fff; }
        .edge-box.mode-sel.active { background:#333; border-color:var(--gs); color:var(--gs); }

        .cam-btn { font-size: 38px; cursor: pointer; padding: 0 10px; }
        .add-main-btn { width:100%; background:var(--gold); border:none; padding:20px; border-radius:40px; font-weight:900; font-size:20px; box-shadow:0 4px 15px rgba(212, 175, 55, 0.4); margin-top:10px; cursor:pointer; transition:all 0.2s; }
        .add-main-btn:active { transform: scale(0.98); }

        .part-label { display: flex; align-items: center; gap: 10px; padding: 10px; background: #fff; border-radius: 10px; margin-bottom: 8px; border: 1px solid #eee; position:relative; }
        .pl-qty { background: #000; color: var(--gs); min-width: 40px; height: 40px; border-radius: 8px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:16px; }
        .pl-center { flex:1; }
        .pl-dims { font-size: 18px; font-weight: 900;color: #000;line-height:1.1; }
        .edge-pill { display:inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 900; color: #fff; margin-right: 3px; }
        .pl-right { display: flex; flex-direction: column; align-items: center; min-width: 60px; border-left: 1px solid #eee; }
        .pl-mode { width: 35px; height: 35px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 12px; border: 2px solid; margin-bottom: 4px; }
        .del-btn { color: #ff3b30; font-size: 24px; border: none; background: none; cursor:pointer; transition:all 0.2s; }
        .del-btn:active { transform: scale(1.2); }

        .qty-controls { display:flex; flex-direction:column; align-items:center; gap:2px; min-width:45px; }
        .qty-btn { border:none; background:#eee; width:100%; border-radius:4px; font-weight:900; font-size:16px; cursor:pointer; transition:all 0.2s; padding:0; height:28px; }
        .qty-btn:active { background:#ddd; }

        .sticky-footer { background: #000; position: fixed; bottom: 0; left: 0; right: 0; height: 80px; border-top: 3px solid var(--gs); color: #fff; display: flex; justify-content: space-around; align-items: center; z-index: 2000; }
        .footer-item { text-align:center; }
        .footer-val { font-size:20px; font-weight:900; color:var(--gs); }
        .footer-label { font-size:9px; color:#aaa; }
        
        #toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #222; color: #fff; padding: 12px 25px; border-radius: 30px; font-weight: 900; z-index: 3000; display: none; border: 1px solid var(--gs); animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity:0; transform: translateX(-50%) translateY(20px); } to { opacity:1; transform: translateX(-50%) translateY(0); } }

        .pl-meta { font-size:10px; font-weight:700; color:#666; margin-top:2px; }

        /* COMPLETE JOB STAMP */
        .job-complete-stamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 24px;
            font-weight: 900;
            color: #34c759;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            pointer-events: none;
            text-shadow: 1px 1px 2px rgba(52, 199, 89, 0.2);
            z-index: 50;
            border: 1.5px solid #34c759;
            padding: 2px 12px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.85);
            white-space: nowrap;
            line-height: 1;
        }
    </style>
</head>
<body>
    <!-- Firebase SDK - Modern Modular Approach -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, getDoc, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCddhnoWoJczM2yXemz2evZc-W2x7OnP00",
            authDomain: "paintworkz-42bc0.firebaseapp.com",
            projectId: "paintworkz-42bc0",
            storageBucket: "paintworkz-42bc0.firebasestorage.app",
            messagingSenderId: "298786193879",
            appId: "1:298786193879:web:8fd63ca63c109f8cd14b92"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Export to window for global access - with proper function wrappers
        window.firebaseDb = db;
        window.firebaseAuth = auth;
        
        // Export Firestore functions as window methods
        window.doc = doc;
        window.setDoc = setDoc;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDoc = getDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.getDocs = getDocs;
        
        // Auth functions
        window.createUserWithEmailAndPassword = (email, password) => createUserWithEmailAndPassword(auth, email, password);
        window.signInWithEmailAndPassword = (email, password) => signInWithEmailAndPassword(auth, email, password);
        window.signOut = () => signOut(auth);
        
        window.currentUser = null;
        window.realtimeSyncActive = false; // Guard against multiple listeners
        window.realtimeSyncUnsubscribe = null; // Store unsubscribe function
        
        // Set up auth listener
        onAuthStateChanged(auth, user => {
            window.currentUser = user;
            if (user) {
                const loginScreen = document.getElementById('loginScreen');
                const appContainer = document.getElementById('appContainer');
                if (loginScreen) loginScreen.style.display = 'none';
                if (appContainer) appContainer.style.display = 'block';
                
                // Initialize app (clear form, populate clients)
                setTimeout(() => {
                    if (typeof initializeApp === 'function') {
                        try {
                            initializeApp();
                        } catch(e) {
                            console.error('initializeApp error:', e);
                        }
                    }
                }, 100);
                
                // Load jobs from Firebase ONLY after document is fully loaded
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => {
                        setTimeout(() => {
                            if (window.loadAllDataFromFirebase) {
                                try {
                                    window.loadAllDataFromFirebase();
                                } catch (e) {
                                    console.error('loadAllDataFromFirebase error:', e);
                                }
                            }
                        }, 500);
                    });
                } else {
                    // DOM already loaded
                    setTimeout(() => {
                        if (window.loadAllDataFromFirebase) {
                            try {
                                window.loadAllDataFromFirebase();
                            } catch (e) {
                                console.error('loadAllDataFromFirebase error:', e);
                            }
                        }
                    }, 500);
                }
                
                // Only set up real-time sync ONCE per session (DISABLED by default due to memory issues)
                if (!window.realtimeSyncActive) {
                    // Real-time sync disabled to prevent memory leaks
                    // Users should manually refresh to get latest data from Firebase
                    console.log('‚ÑπÔ∏è Real-time sync disabled (manual refresh recommended)');
                    window.realtimeSyncActive = true;
                }
            } else {
                // Clean up listener when logging out
                if (window.realtimeSyncUnsubscribe) {
                    try {
                        window.realtimeSyncUnsubscribe();
                    } catch (e) {
                        console.warn('Error unsubscribing:', e);
                    }
                    window.realtimeSyncUnsubscribe = null;
                }
                window.realtimeSyncActive = false;
                
                const loginScreen = document.getElementById('loginScreen');
                const appContainer = document.getElementById('appContainer');
                if (loginScreen) loginScreen.style.display = 'block';
                if (appContainer) appContainer.style.display = 'none';
            }
        });
        
        // Set firebaseReady LAST - only after everything is initialized
        window.firebaseReady = true;
    </script>
    <!-- USER INFO -->
    <div id="userInfo"></div>

<!-- TOAST NOTIFICATION -->
<div id="toast" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#34c759; color:#fff; padding:12px 25px; border-radius:25px; font-weight:900; z-index:5000; font-size:11px; box-shadow:0 4px 12px rgba(52, 199, 89, 0.3); animation: slideUp 0.4s ease-out, slideDown 0.4s ease-in 2.6s forwards; white-space:nowrap;"></div>

<style>
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(100px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes slideDown {
    from {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    to {
        opacity: 0;
        transform: translateX(-50%) translateY(100px);
    }
}
</style>

<!-- TIMELINE EDITOR MODAL -->
<div id="timelineModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center; flex-wrap:wrap;">
    <div style="background:#fff; padding:25px; border-radius:12px; width:90%; max-width:500px; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); z-index:1001;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Edit Timeline</h3>
            <button onclick="closeTimelineModal()" style="border:none; background:none; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px;">‚úï</button>
        </div>
        
        <div id="timelineEditorContent"></div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="saveTimelineEdit()" style="flex:1; border:none; background:#34c759; color:#fff; padding:10px; border-radius:6px; font-weight:900; cursor:pointer;">SAVE</button>
            <button onclick="closeTimelineModal()" style="flex:1; border:none; background:#f0f0f0; color:#000; padding:10px; border-radius:6px; font-weight:900; cursor:pointer;">CANCEL</button>
        </div>
    </div>
</div>

<!-- PAINT FORMULA DATABASE MODAL -->
<div id="paintFormulaModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:25px; border-radius:12px; width:95%; max-width:700px; max-height:90vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); z-index:1001;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0;">Paint Formula Database</h3>
            <button onclick="closePaintFormulaModal()" style="border:none; background:none; font-size:24px; cursor:pointer; padding:0; width:30px; height:30px;">‚úï</button>
        </div>
        
        <!-- Search/Filter -->
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="formulaSearchBrand" placeholder="Search by Brand..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:11px;">
            <input type="text" id="formulaSearchColor" placeholder="Search by Color..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:11px;">
            <button onclick="searchPaintFormulas()" style="border:none; background:#2196f3; color:#fff; padding:8px 15px; border-radius:6px; font-weight:900; font-size:10px; cursor:pointer;">üîç SEARCH</button>
        </div>
        
        <!-- Formula List -->
        <div id="formulaList" style="max-height:400px; overflow-y:auto; margin-bottom:15px; border:1px solid #eee; border-radius:6px;">
            <div id="formulaListContent"></div>
        </div>
        
        <!-- Add New Formula -->
        <div style="background:#f9f9f9; padding:15px; border-radius:6px; margin-bottom:15px; border:1px solid #ddd;">
            <h4 style="margin:0 0 10px 0; font-size:12px;">Add New Formula</h4>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                <input type="text" id="newFormulaBrand" placeholder="Brand (e.g., Wattyl)" style="padding:8px; border:1px solid #ddd; border-radius:6px; font-size:10px;">
                <input type="text" id="newFormulaColor" placeholder="Color (e.g., White)" style="padding:8px; border:1px solid #ddd; border-radius:6px; font-size:10px;">
            </div>
            <textarea id="newFormulaText" placeholder="Formula/Code (e.g., W001 - 4 parts base + 1 part hardener)" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; font-size:10px; min-height:60px; box-sizing:border-box;"></textarea>
            <button onclick="addNewPaintFormula()" style="width:100%; border:none; background:#34c759; color:#fff; padding:8px; border-radius:6px; font-weight:900; font-size:10px; cursor:pointer; margin-top:10px;">+ ADD FORMULA</button>
        </div>
        
        <div style="display:flex; gap:10px;">
            <button onclick="closePaintFormulaModal()" style="flex:1; border:none; background:#f0f0f0; color:#000; padding:10px; border-radius:6px; font-weight:900; cursor:pointer;">CLOSE</button>
        </div>
    </div>
</div>

<!-- CALENDAR MODAL -->
<div id="calendarModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:5000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:16px; padding:20px; width:90%; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <button onclick="prevMonth()" style="border:none; background:#f0f0f0; width:40px; height:40px; border-radius:8px; font-weight:900; font-size:18px; cursor:pointer;">‚Üê</button>
            <div style="text-align:center; flex:1;">
                <div id="monthYear" style="font-weight:900; font-size:16px; color:#000;"></div>
            </div>
            <button onclick="nextMonth()" style="border:none; background:#f0f0f0; width:40px; height:40px; border-radius:8px; font-weight:900; font-size:18px; cursor:pointer;">‚Üí</button>
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-bottom:15px;">
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">SU</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">MO</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">TU</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">WE</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">TH</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">FR</div>
            <div style="text-align:center; font-weight:900; font-size:10px; color:#999;">SA</div>
            <div id="calendarDays" style="grid-column:1/-1; display:grid; grid-template-columns:repeat(7,1fr); gap:4px;"></div>
        </div>
        
        <div style="display:flex; gap:8px;">
            <button onclick="closeCalendar()" style="flex:1; border:none; background:#f0f0f0; padding:12px; border-radius:8px; font-weight:900; cursor:pointer;">CANCEL</button>
            <button onclick="selectToday()" style="flex:1; border:none; background:var(--gs); padding:12px; border-radius:8px; font-weight:900; cursor:pointer;">TODAY</button>
        </div>
    </div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginScreen" style="position:fixed; top:0; left:0; right:0; bottom:0; background:linear-gradient(135deg, #d4af37, #f9f1b0); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;">
    <div style="background:#fff; border-radius:20px; padding:30px; width:100%; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <div style="text-align:center; margin-bottom:30px;">
            <h1 style="margin:0; color:#d4af37; font-size:32px;">üé® PaintWorkz</h1>
            <p style="color:#666; margin:10px 0 0; font-size:14px;">Live Sync ‚Ä¢ All Devices</p>
        </div>
        
        <input type="email" id="loginEmail" placeholder="Email" style="margin-bottom:12px; padding:15px;">
        <input type="password" id="loginPassword" placeholder="Password" style="margin-bottom:20px; padding:15px;">
        
        <button onclick="handleLogin()" style="width:100%; background:#d4af37; border:none; padding:15px; border-radius:10px; font-weight:900; font-size:16px; cursor:pointer; margin-bottom:10px;">SIGN IN</button>
        <button onclick="trySignup()" style="width:100%; background:#333; color:#d4af37; border:2px solid #d4af37; padding:15px; border-radius:10px; font-weight:900; font-size:16px; cursor:pointer; font-size:14px;">CREATE ACCOUNT</button>
        
        <div id="loginError" style="color:red; font-weight:900; margin-top:15px; text-align:center; display:none;"></div>
    </div>
</div>

<!-- APP CONTAINER -->
<div id="appContainer" style="display:none;">

<header>
    <div class="icon-btn" onclick="tab('history')">üîç</div>
    <div class="logo-box"><span class="logo-text">PaintWorkz</span></div>
    <div style="display:flex; gap:10px; align-items:center;">
        <div class="icon-btn" onclick="saveJob()">üíæ</div>
    </div>
</header>

<div class="nav-tabs">
    <div class="nav-btn active" id="btn-measure" data-tab="measure">Measure</div>
    <div class="nav-btn" id="btn-history" data-tab="history">History</div>
    <div class="nav-btn" id="btn-db" data-tab="db">Database</div>
    <div class="nav-btn" id="btn-forms" data-tab="forms">Forms</div>
    <div class="nav-btn" id="btn-schedule" data-tab="schedule">Schedule</div>
    <div class="nav-btn" id="btn-admin" data-tab="admin">Admin</div>
</div>

<div class="container">
    
    <div id="measure" class="view-section active">
        <div class="card">
            <div style="display:flex; gap:8px; margin-bottom: 8px;">
                <div style="flex:2">
                    <label>Client</label>
                    <select id="cli"></select>
                </div>
                <div style="flex:1">
                    <label>Date Received</label>
                    <input type="text" id="dRec" placeholder="DD/MM/YY" inputmode="numeric" style="text-align:center;" onclick="openCalendar()">
                </div>
            </div>

            <div style="display:flex; gap:8px; margin-bottom: 8px;">
                <div style="flex:2">
                    <label>Job Name / Reference</label>
                    <input type="text" id="jNm" placeholder="e.g. Smith Residence">
                </div>
                <div style="flex:1">
                    <label>Job #</label>
                    <input type="text" id="jN" placeholder="####" style="text-align:center;">
                </div>
            </div>

            <div style="background:#f9f9f9; padding:10px; border-radius:8px; border:1px solid #eee; margin-bottom:10px;">
                <div style="display:flex; gap:8px; margin-bottom:8px;">
                    <div style="flex:1">
                        <label>Brand</label>
                        <select id="p-brand" style="height:35px; font-size:12px;">
                            <option>Wattyl</option>
                            <option>Dulux</option>
                            <option>Taubmans</option>
                            <option>Haymes</option>
                            <option>British Paints</option>
                            <option>Evic</option>
                            <option>Custom</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>Color Name</label>
                        <input type="text" id="p-color" placeholder="e.g. Lexicon" style="height:35px; font-size:12px;">
                    </div>
                </div>
                <div style="display:flex; gap:8px;">
                    <div style="flex:1">
                        <label>Code / Formula</label>
                        <input type="text" id="p-code" placeholder="Formula (auto-search when typing)" style="height:35px; font-size:12px;" oninput="autoSearchFormulaOnType()">
                    </div>
                    <div style="flex:1">
                        <label>Finish</label>
                        <select id="p-finish" style="height:35px; font-size:12px;">
                            <option>Satin</option><option>Gloss</option><option>Matt</option><option>20% Gloss</option><option>30% Gloss</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <label>Part Type</label>
            <div class="bubble-row">
                <div id="pP" class="p-card active" onclick="setP('Panel')"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="2"></rect></svg>PANEL</div>
                <div id="pD" class="p-card" onclick="setP('Door')"><svg viewBox="0 0 24 24"><path d="M5 3h14v18H5V3zm10 9v1"></path></svg>DOOR</div>
                <div id="pDr" class="p-card" onclick="setP('Drawer')"><svg viewBox="0 0 24 24"><rect x="3" y="5" width="18" height="6" rx="1"></rect><rect x="3" y="13" width="18" height="6" rx="1"></rect></svg>DRAWER</div>
                <div id="pC" class="p-card" onclick="setP('Custom')"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>CUSTOM</div>
            </div>

            <label>Description of Part</label>
            <input type="text" id="desc" placeholder="e.g. Pantry Door Left" style="text-transform: uppercase;">

            <div class="fm-row">
                <div id="fm-flat" class="fm-opt active" onclick="setFM('Flat')">FLAT</div>
                <div id="fm-mould" class="fm-opt" onclick="setFM('Moulded')">MOULDED</div>
            </div>

            <div class="bubble-row">
                <div class="bubble-unit" style="flex:0.8"><input type="number" id="thk" value="18" inputmode="decimal" oninput="up()"><div style="font-size:9px;color:#888;">THICK</div></div>
                <div style="flex:2"><select id="prof-select" oninput="up()"></select></div>
                <div class="bubble-unit" style="flex:0.8"><input type="number" id="qty" value="1" inputmode="numeric"><div style="font-size:9px;color:#888;">QTY</div></div>
            </div>

            <div class="bubble-row">
                <input type="number" id="h" placeholder="Length" inputmode="decimal" oninput="up()" style="height:55px; font-size:22px; text-align:center;">
                <input type="number" id="w" placeholder="Width" inputmode="decimal" oninput="up()" style="height:55px; font-size:22px; text-align:center;">
            </div>

            <label>Edge Treatment</label>
            <div class="edge-row">
                <div class="edge-box" id="E1" onclick="tE(this)">L</div>
                <div class="edge-box" id="E2" onclick="tE(this)">L</div>
                <div class="cam-btn" onclick="snap()">üì∏</div>
                <div class="edge-box" id="E3" onclick="tE(this)">S</div>
                <div class="edge-box" id="E4" onclick="tE(this)">S</div>
            </div>

            <label>Paint Mode</label>
            <div class="edge-row" style="margin-top:5px;">
                <div id="mSS" class="edge-box mode-sel active" onclick="setM('SS')">SS</div>
                <div id="mDS" class="edge-box mode-sel" onclick="setM('DS')">DS</div>
                <div id="mSE" class="edge-box mode-sel" onclick="setM('SE')">SE</div>
            </div>

            <div style="display: flex; flex-direction: column; align-items: center; padding: 15px 0; border-top: 1px solid #eee;">
                <div id="liveSq" style="font-size: 50px; font-weight: 900; color: var(--gs); line-height: 1;">0.000</div>
                <div style="font-size: 10px; font-weight: 900; color: #aaa;">CURRENT PART SQM</div>
            </div>

            <button class="add-main-btn" onclick="addPart()">ADD PART +</button>
        </div>
        <div id="list"></div>
    </div>

    <div id="db" class="view-section">
        <div class="sub-nav">
            <button class="sub-btn active" id="sub-btn-clients" onclick="subTab('clients')">CLIENTS</button>
            <button class="sub-btn" id="sub-btn-profiles" onclick="subTab('profiles')">DOOR PROFILES</button>
            <button class="sub-btn" id="sub-btn-paint" onclick="subTab('paint')">PAINT</button>
        </div>

        <div id="sub-clients" class="sub-section active">
            <div class="card">
                <div class="add-row">
                    <input type="text" id="new-client" placeholder="New Client Name" style="margin-bottom:0;">
                    <button class="btn-small" onclick="addClient()">ADD</button>
                </div>
                <div class="db-list" id="list-clients"></div>
            </div>
        </div>

        <div id="sub-profiles" class="sub-section" style="display:none;">
            <div class="card">
                <h4 style="margin-bottom:15px; font-weight:900;">Door Profiles</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Add new profiles or edit existing names. Profiles are used in your pricing matrix tiers.</p>
                
                <div class="add-row">
                    <input type="text" id="new-profile" placeholder="New Profile Name (e.g., Shaker, Ashlee)" style="margin-bottom:0;">
                    <button class="btn-small" onclick="addProfile()">ADD</button>
                </div>
                <div class="db-list" id="list-profiles" style="margin-top:15px;"></div>
            </div>
        </div>

        <div id="sub-paint" class="sub-section" style="display:none;">
            <div class="card">
                <h4 style="margin-bottom:15px; font-weight:900;">Paint Formula Database</h4>
                <div style="margin-bottom:20px;">
                    <h5 style="margin-bottom:10px; font-weight:900; font-size:12px;">Add New Formula</h5>
                    <div style="background:#f9f9f9; padding:15px; border-radius:8px; border:1px solid #ddd;">
                        <input type="text" id="newPaintBrand" placeholder="Brand (e.g., Wattyl)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px; box-sizing:border-box; font-size:12px;">
                        <input type="text" id="newPaintColor" placeholder="Color (e.g., White)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px; box-sizing:border-box; font-size:12px;">
                        <textarea id="newPaintFormula" placeholder="Formula in grams (e.g., Base 800g + Hard 200g)" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px; box-sizing:border-box; font-size:12px; min-height:60px;"></textarea>
                        <button onclick="addNewPaintFormula()" style="width:100%; padding:10px; background:#34c759; color:#fff; border:none; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">+ ADD FORMULA</button>
                    </div>
                </div>
                
                <div>
                    <h5 style="margin-bottom:10px; font-weight:900; font-size:12px;">Existing Formulas</h5>
                    <div id="paintFormulaList" style="background:#fff; border:1px solid #ddd; border-radius:8px; overflow:hidden;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="forms" class="view-section">
        <div class="card">
            <h3>Generate Form</h3>
            <div class="form-grid">
                <div class="form-card" onclick="genForm('Estimate')"><h4>Estimate</h4><p>Job breakdown only</p></div>
                <div class="form-card" onclick="genForm('Supply Docket')"><h4>Supply Docket</h4><p>Part list for client</p></div>
                <div class="form-card" onclick="genForm('Mixing Card')"><h4>Mixing Card</h4><p>Paint shop formula</p></div>
                <div class="form-card" onclick="genForm('Invoice')"><h4>Invoice</h4><p>Dynamic length billing</p></div>
                <div class="form-card" onclick="genForm('Quote Form')"><h4>Quote Form</h4><p>Raw vs Paint pricing</p></div>
            </div>
        </div>
    </div>

    <div id="history" class="view-section">
        <div class="card">
            <h3>Job History</h3>
            <p style="color:#666; font-size:12px; margin-bottom:15px;">Save your current job using the üíæ button above to add it to history</p>
            
            <!-- Filter Buttons -->
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px;">
                <button onclick="filterHistory('all')" id="filter-all" style="background:#d4af37; color:#000; border:none; padding:8px 14px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">ALL</button>
                <button onclick="filterHistory('active')" id="filter-active" style="background:#f0f0f0; color:#666; border:none; padding:8px 14px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">ACTIVE</button>
                <button onclick="filterHistory('completed')" id="filter-completed" style="background:#f0f0f0; color:#666; border:none; padding:8px 14px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">COMPLETED</button>
            </div>
        </div>
        <div id="history-list"></div>
    </div>
    
    <div id="schedule" class="view-section" style="width:100vw; margin-left:calc(-50vw + 50%); position:relative;">
        <!-- Global Notifications -->
        <div class="card" style="background:#f0fdf4; border-left:5px solid #34c759; margin-left:0; margin-right:0;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:#34c759;">üîî Global Notifications</h3>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="notificationBadge" style="background:#ff3b30; color:#fff; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:12px;">0</span>
                    <button onclick="toggleNotifications()" style="border:none; background:#34c759; color:#fff; padding:6px 12px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚àí</button>
                </div>
            </div>
            <div id="globalNotifications" style="max-height:200px; overflow-y:auto; display:block;">
                <p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p>
            </div>
        </div>

        <div class="card" style="margin-left:0; margin-right:0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Jobs Chart</h3>
                <div style="display:flex; gap:8px;">
                    <button onclick="prevScheduleMonth()" style="border:none; background:#f0f0f0; width:35px; height:35px; border-radius:6px; font-weight:900; cursor:pointer;">‚Üê</button>
                    <button onclick="nextScheduleMonth()" style="border:none; background:#f0f0f0; width:35px; height:35px; border-radius:6px; font-weight:900; cursor:pointer;">‚Üí</button>
                    <button id="jobsChartToggleBtn" onclick="toggleJobsChart()" title="Minimize/Maximize" style="border:none; background:#2196f3; color:#fff; width:35px; height:35px; border-radius:6px; font-weight:900; cursor:pointer; font-size:18px;">‚àí</button>
                </div>
            </div>
            <div id="scheduleMonthYear" style="text-align:center; font-weight:900; font-size:16px; margin-bottom:15px; color:#000;"></div>
        </div>

        <!-- Jobs Chart Timeline - Full Width -->
        <div id="ganttWrapper" style="width:100vw; margin-left:calc(-50vw + 50%); background:#fff; padding:15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow-x:auto; min-height:600px; display:block; visibility:visible;">
            <!-- Jobs Chart Container -->
            <div id="ganttChart" style="min-width:1200px; padding:0; display:flex; flex-direction:column;">
                <!-- Jobs chart will render here -->
            </div>
        </div>

    </div>
    
    <div id="admin" class="view-section">
        <div class="card">
            <h3>Admin Settings</h3>
            <label>App Version</label>
            <input type="text" value="PaintWorkz Pro 4.8 | REV 51" disabled style="background:#f5f5f5; cursor:not-allowed;">
            
            <!-- Admin Sub-Tabs -->
            <div class="sub-nav" style="margin-top:15px;">
                <button class="sub-btn active" onclick="switchAdminTab('general')" id="admin-tab-general">General Settings</button>
                <button class="sub-btn" onclick="switchAdminTab('colours')" id="admin-tab-colours">Colours</button>
                <button class="sub-btn" onclick="switchAdminTab('pricing')" id="admin-tab-pricing">Price Matrix</button>
            </div>
            
            <!-- General Settings Tab -->
            <div id="admin-tab-general-content">
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Default Timeline Settings</h4>
                <p style="font-size:11px; color:#666; margin-bottom:10px;">Edit the default timeline phases for all new jobs</p>
                <button onclick="editDefaultTimeline()" style="border:none; background:#2196f3; color:#fff; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚öôÔ∏è EDIT DEFAULT TIMELINE</button>
                
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Job Completion Alerts</h4>
                <div id="admin-alerts"></div>
                
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">‚ö†Ô∏è Database Maintenance (FIX DUPLICATES)</h4>
                <p style="font-size:11px; color:#d32f2f; margin-bottom:10px; background:#ffebee; padding:10px; border-radius:6px;"><strong>Your history has duplicate jobs!</strong> Click the button below to remove them and see all your jobs in Schedule.</p>
                <button onclick="removeDuplicateJobs()" style="border:none; background:#ff9500; color:#fff; padding:12px 20px; border-radius:6px; font-weight:900; font-size:12px; cursor:pointer; width:100%;">üßπ REMOVE DUPLICATES NOW</button>
            </div>
            
            <!-- Colours Tab -->
            <div id="admin-tab-colours-content" style="display:none;">
                <h4 style="margin-top:20px; margin-bottom:10px; font-weight:900;">Theme Colours</h4>
                <p style="font-size:11px; color:#666; margin-bottom:15px;">Customize colours throughout the app</p>
                <div id="colorCustomizerContent" style="display:grid; grid-template-columns:1fr 1fr; gap:15px;"></div>
            </div>
            
            <!-- Price Matrix Tab -->
            <div id="admin-tab-pricing-content" style="display:none;">
                <div id="admin-pricing-matrix" style="margin-top:15px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- WORKLOAD SUMMARY CONTAINER - Shows only in Schedule/Admin -->
<div id="workloadSummaryContainer" style="display:none; background:#f9f9f9; border-top:1px solid #ddd; border-bottom:1px solid #ddd; padding:15px; margin-bottom:80px;">
    <div class="card" style="margin:0; background:transparent;">
        <h4 style="margin-top:0; margin-bottom:10px;">Workload Summary</h4>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
            <div style="text-align:center; padding:10px;">
                <div id="totalActiveJobs" style="font-size:24px; font-weight:900; color:var(--gs);">0</div>
                <div style="font-size:10px; color:#666; font-weight:700;">Active Jobs</div>
            </div>
            <div style="text-align:center; padding:10px; border-left:1px solid #ddd; border-right:1px solid #ddd;">
                <div id="totalTasks" style="font-size:24px; font-weight:900; color:#ff9500;">0/0</div>
                <div style="font-size:10px; color:#666; font-weight:700;">Tasks Complete</div>
            </div>
            <div style="text-align:center; padding:10px;">
                <div id="totalWorkload" style="font-size:24px; font-weight:900; color:#2196f3;">0</div>
                <div style="font-size:10px; color:#666; font-weight:700;">SQM Workload</div>
            </div>
        </div>
    </div>
</div>

<div class="sticky-footer">
    <div class="footer-item" style="margin-left:15px;"><div class="footer-label">TOTAL SQM</div><div class="footer-val" id="tA">0.000</div></div>
    <div style="flex:1; display:flex; justify-content:center;">
        <div class="icon-btn" onclick="genPDF()" style="color:#fff">üìÑ</div>
    </div>
    <div class="footer-item"><div class="footer-label">PARTS</div><div class="footer-val" id="tQ">0</div></div>
    <div class="icon-btn" onclick="handleLogout()" title="Logout" style="color:#ff3b30; font-size:24px; cursor:pointer; margin-right:15px;">üö™</div>
</div>

<script>
    // ===== PAINTWORKZ REVISION INFO =====
    console.log('%c üé® PaintWorkz Pro 4.8 REV 51 (2026-02-09) ', 'background:#d4af37;color:#000;font-weight:900;padding:8px;border-radius:4px;');
    console.log('‚úÖ CRITICAL FIXES:');
    console.log('‚úì Disabled Firebase real-time sync (memory crashes fixed)');
    console.log('‚úì Improved error handling to prevent crashes');
    console.log('‚úì Door profile persistence fixed');
    console.log('‚úì Job completion toggle working');
    console.log('‚úì Measure sheet clears on save');
    console.log('‚úì Workload summary correctly excludes completed');
    // ====================================
    
    // Firebase already initialized at top of page
    let isSignup = false;

    // Wait for Firebase to be initialized before using it
    function waitForFirebase() {
        if (typeof auth !== 'undefined' && auth !== null) {
            // Firebase is ready, set up auth listener
            window.onAuthStateChanged((user) => {
              if (user) {
                window.currentUser = user;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('userInfo').innerHTML = `
                  <span style="font-weight:900;">üë§ ${user.email.split('@')[0]}</span>
                  <button id="logoutBtn" onclick="logout()" style="background:#ff3b30; color:#fff; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-weight:900; margin-left:10px;">Logout</button>
                `;
                loadDataFromFirestore();
              } else {
                window.currentUser = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('userInfo').innerHTML = '';
              }
            });
        } else {
            // Firebase not ready yet, try again
            setTimeout(waitForFirebase, 100);
        }
    }
    
    // Start waiting for Firebase
    waitForFirebase();

    // Login/Signup Handler
    function handleAuth() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');
      
      if (!email || !password) {
        errorDiv.innerHTML = '‚ö†Ô∏è Please enter email and password';
        return;
      }
      
      if (isSignup) {
        window.createUserWithEmailAndPassword(email, password)
          .then(result => {
            errorDiv.innerHTML = '‚úÖ Account created! Logging in...';
            setTimeout(() => {
              document.getElementById('loginEmail').value = '';
              document.getElementById('loginPassword').value = '';
            }, 1000);
          })
          .catch(error => {
            errorDiv.innerHTML = '‚ùå ' + error.message;
          });
      } else {
        window.signInWithEmailAndPassword(email, password)
          .then(result => {
            errorDiv.innerHTML = '‚úÖ Logged in successfully!';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
          })
          .catch(error => {
            errorDiv.innerHTML = '‚ùå ' + error.message;
          });
      }
    }

    function toggleSignup() {
      isSignup = !isSignup;
      document.getElementById('loginTitle').innerHTML = isSignup ? 'Create Account' : 'PaintWorkz Login';
      document.getElementById('loginBtn').innerHTML = isSignup ? 'Sign Up' : 'Login';
      document.getElementById('toggleBtn').innerHTML = isSignup ? 'Have an account? Login' : "Don't have an account? Sign Up";
      document.getElementById('loginError').innerHTML = '';
    }

    function logout() {
      window.signOut().then(() => {
      });
    }

    // Save data to Firestore
    async function saveDataToFirestore() {
      if (!window.currentUser) {
        return;
      }
      
      try {
        const data = {
          items: items,
          client: document.getElementById('cli')?.value || '',
          dateReceived: document.getElementById('dRec')?.value || '',
          totalSqm: document.getElementById('sqm')?.value || '',
          doorProfiles: doorProfiles,
          paintData: paintData,
          lastSaved: new Date().toISOString()
        };
        
        const measureDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'data', 'measureData');
        await window.setDoc(measureDocRef, data);
        
        const historyDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'history', 'jobs');
        await window.setDoc(historyDocRef, {
          history: history,
          lastUpdated: new Date().toISOString()
        });
        
      } catch (error) {
      }
    }

    // Load data from Firestore
    async function loadDataFromFirestore() {
      if (!window.currentUser) return;
      
      try {
        // Load measure data
        const measureDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'data', 'measureData');
        const measureDoc = await window.getDoc(measureDocRef);
        if (measureDoc.exists()) {
          const data = measureDoc.data();
          items = data.items || [];
          doorProfiles = data.doorProfiles || [];
          paintData = data.paintData || [];
          if (document.getElementById('cli')) document.getElementById('cli').value = data.client || '';
          if (document.getElementById('dRec')) document.getElementById('dRec').value = data.dateReceived || '';
          if (document.getElementById('sqm')) document.getElementById('sqm').value = data.totalSqm || '';
        }
        
        // Load job history
        const historyDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'history', 'jobs');
        const historyDoc = await window.getDoc(historyDocRef);
        if (historyDoc.exists()) {
          history = historyDoc.data().history || [];
        }
        
        // NOTE: Door profiles are NOT loaded from Firebase
        // They are ONLY loaded from localStorage to prevent stale data
        // Firebase is used for backup/sync only, not for restoration
        
        refreshLists();
        renderHistory();
        renderScheduleCalendar();
      } catch (error) {
      }
    }

    // ==================== END FIREBASE SETUP ====================
    let items = [], mode = 'SS', pType = 'Panel', fmState = 'Flat';
    
    // RESTORED MASTER LISTS
    let clients = ["12345ABM", "Absolute Kitchens", "Advanced Cabinetry", "AKC Kitchens", "Braw Creative", "Brian Moloney", "Cabinets & Stone", "Cabinets by Michael", "Chooka", "CKK", "Clover Doors", "Complete Style Joinery", "Concept 2 Reality", "Coronet Kitchens", "Create a Kitchen", "Creative Cabinetry", "Cutting Edge Joinery", "Driscolls Joinery", "Evolution Kitchens and Joinery", "Geoff Frost Builders", "GM Cabinets", "Grampians Joinery", "Grovedale Kitchens", "Gunning Concepts", "Hamilton Sheetmetal", "Harris Cabinets", "Howe Kitchens & Joinery", "Hy-Craft", "Jardines Cabinets", "Joinery by Jarrod", "Jonassons", "Kingston Kabinets", "Kitchens U Build", "Kyle Hendy", "Leighton Park", "Matthews Joinery", "Ocean Grove Joinery", "Onshore", "R J Walter", "Richardson Joinery", "Schier Cabinet Makers", "Snaauws Kitchens", "SRT Cabinetry", "Stawell Joinery", "Stephensons Kitchens", "T&J Kitchens", "Tony Lambert Kitchens", "Total Kitchen Solutions", "Trendset Kitchens", "Troy Turner", "Ultrabuild", "VG Cabinets", "VJS Geelong", "VJS Shepparton", "Walk in Client", "Westend Cabinetry"];
    // Default door profiles
    const DEFAULT_PROFILES = ["Plain (101)", "J-Mould (102)", "Sharknose (103)", "Bevelled Edge (104)", "Ashlee (201)", "Hamilton (202)", "Vertical Grooves (203)", "Tarrone (301)", "Bobby (302)", "Orford (303)", "Shaker (401)", "Shaker 45 (402)", "Shaker w/Lines (403)", "Jack (404)", "Georgia (501)", "Branxholme (502)", "Rosebrook (503)", "Benchtop", "Molding", "Custom"];
    
    let profiles = (function() {
        // Load from localStorage if available
        const saved = localStorage.getItem('doorProfiles');
        if (saved) {
            try {
                const loaded = JSON.parse(saved);
                // Validate it's a real array
                if (Array.isArray(loaded) && loaded.length >= 10) {
                    // Filter out any null/undefined/empty/duplicate entries
                    const cleaned = [];
                    const seen = new Set();
                    loaded.forEach(p => {
                        if (p && typeof p === 'string' && p.trim().length > 0 && !seen.has(p)) {
                            cleaned.push(p);
                            seen.add(p);
                        }
                    });
                    
                    if (cleaned.length !== loaded.length) {
                        console.warn(`‚ö†Ô∏è Removed ${loaded.length - cleaned.length} corrupt/duplicate profile entries`);
                        localStorage.setItem('doorProfiles', JSON.stringify(cleaned));
                        return cleaned;
                    }
                    console.log(`‚úì Loaded ${loaded.length} door profiles from localStorage`);
                    return loaded;
                } else {
                    console.warn('‚ö†Ô∏è Corrupted door profiles (too few items), restoring defaults');
                    localStorage.removeItem('doorProfiles');
                }
            } catch(e) {
                console.error('Error loading door profiles from localStorage:', e);
                console.warn('‚ö†Ô∏è Restoring default door profiles');
                localStorage.removeItem('doorProfiles');
            }
        }
        // Use defaults
        console.log(`‚úì Using default ${DEFAULT_PROFILES.length} door profiles`);
        return [...DEFAULT_PROFILES];
    })();
    
    // Helper function to save profiles to localStorage
    function saveProfilesToStorage() {
        localStorage.setItem('doorProfiles', JSON.stringify(profiles));
        console.log(`‚úì Saved ${profiles.length} door profiles to localStorage`);
    }
    
    // Restore all default profiles
    function restoreDefaultProfiles() {
        profiles = [...DEFAULT_PROFILES];
        saveProfilesToStorage(); // Save to localStorage
        console.log(`‚úì Restored ${profiles.length} default door profiles`);
        syncProfilesToFirebase(); // Sync to Firebase
        renderPricingMatrix();
        checkForNewUnallocatedDoors();
        notify('‚úì Door profiles restored to defaults');
    }
    
    // Clear stale Firebase profile data and force fresh sync
    function clearFirebaseProfilesData() {
        if (!confirm('üö® This will clear old Firebase profile data and reset to defaults.\n\nAre you sure? (Your price matrix will be restored to defaults)')) {
            return;
        }
        
        if (!window.firebaseReady || !window.currentUser) {
            alert('Firebase not ready. Please try again.');
            return;
        }
        
        try {
            console.log('üóëÔ∏è NUCLEAR: Clearing ALL stale profile data (localStorage + Firebase)...');
            
            // 1. Clear localStorage doorProfiles completely
            localStorage.removeItem('doorProfiles');
            console.log('‚úì Cleared localStorage doorProfiles');
            
            // 2. Reset profiles array to defaults
            profiles = [...DEFAULT_PROFILES];
            console.log(`‚úì Reset profiles to ${profiles.length} defaults`);
            
            // 3. Delete the old Firebase document to remove stale data
            const configDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'config', 'doorProfiles');
            window.deleteDoc(configDoc).then(() => {
                console.log('‚úì Deleted old Firebase profile document');
            }).catch(err => {
                console.error('Error deleting Firebase document:', err);
            });
            
            // 4. Force immediate re-sync of fresh defaults
            setTimeout(() => {
                saveProfilesToStorage();
                syncProfilesToFirebase();
                renderPricingMatrix();
                notify('‚úÖ NUCLEAR RESET COMPLETE - All profiles cleared and reset to defaults');
            }, 500);
        } catch (error) {
            console.error('Error clearing profiles:', error);
            alert('Error during reset. Check console.');
        }
    }
    
    // Check for new unallocated doors and show notification
    function checkForNewUnallocatedDoors() {
        // Removed - globalNotifications section no longer exists
    }

    window.onload = () => { 
        refreshLists();
        loadData();
        renderHistory();
        // renderScheduleCalendar(); // Don't render until Schedule tab is clicked
    };

    // LOCAL STORAGE
    function saveData() {
        const jobData = {
            items: items,
            client: document.getElementById('cli').value,
            dateReceived: document.getElementById('dRec').value,
            jobName: document.getElementById('jNm').value,
            jobNum: document.getElementById('jN').value,
            brand: document.getElementById('p-brand').value,
            color: document.getElementById('p-color').value,
            code: document.getElementById('p-code').value,
            finish: document.getElementById('p-finish').value,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem('currentJob', JSON.stringify(jobData));
    }

    // Populate client dropdown with unique clients from history
    function populateClientDropdown() {
        try {
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const clientSelect = document.getElementById('cli');
            if (!clientSelect) {
                console.warn('Client dropdown element not found');
                return;
            }
            
            // Get unique clients
            const clients = [...new Set(history.map(job => job.client).filter(Boolean))];
            clients.sort();
            
            // Clear and rebuild dropdown
            clientSelect.innerHTML = '<option value="">-- Select or type client --</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client;
                option.textContent = client;
                clientSelect.appendChild(option);
            });
            
            console.log(`‚úì Populated ${clients.length} unique clients in dropdown`);
        } catch(e) {
            console.error('Error populating client dropdown:', e);
        }
    }
    
    // Initialize app on page load
    function initializeApp() {
        console.log('üöÄ Initializing PaintWorkz...');
        
        try {
            // Clear measure sheet on fresh load
            items = [];
            
            const cliEl = document.getElementById('cli');
            const dRecEl = document.getElementById('dRec');
            const jNmEl = document.getElementById('jNm');
            const jNEl = document.getElementById('jN');
            const pBrandEl = document.getElementById('p-brand');
            const pColorEl = document.getElementById('p-color');
            const pCodeEl = document.getElementById('p-code');
            const pFinishEl = document.getElementById('p-finish');
            
            if (cliEl) cliEl.value = '';
            if (dRecEl) dRecEl.value = '';
            if (jNmEl) jNmEl.value = '';
            if (jNEl) jNEl.value = '';
            if (pBrandEl) pBrandEl.value = 'Wattyl';
            if (pColorEl) pColorEl.value = '';
            if (pCodeEl) pCodeEl.value = '';
            if (pFinishEl) pFinishEl.value = 'Satin';
            
            const totSqmEl = document.getElementById('tA');
            const totPartsEl = document.getElementById('tQ');
            if (totSqmEl) totSqmEl.innerText = '0.000';
            if (totPartsEl) totPartsEl.innerText = '0';
            
            // Populate client dropdown
            populateClientDropdown();
            
            // Re-render measure sheet
            if (typeof render === 'function') {
                render();
            }
            
            console.log('‚úì App initialized - measure sheet cleared, clients loaded');
        } catch(e) {
            console.error('Error during app initialization:', e);
            console.warn('App continuing despite initialization error - some elements may not be ready yet');
        }
    }
    
    function loadData() {
        const saved = localStorage.getItem('currentJob');
        if (saved) {
            const jobData = JSON.parse(saved);
            items = jobData.items || [];
            document.getElementById('cli').value = jobData.client || '';
            document.getElementById('dRec').value = jobData.dateReceived || '';
            document.getElementById('jNm').value = jobData.jobName || '';
            document.getElementById('jN').value = jobData.jobNum || '';
            document.getElementById('p-brand').value = jobData.brand || 'Wattyl';
            document.getElementById('p-color').value = jobData.color || '';
            document.getElementById('p-code').value = jobData.code || '';
            document.getElementById('p-finish').value = jobData.finish || 'Satin';
            render();
        }
    }

    // Function to clean up duplicate jobs
    function checkForDuplicates() {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const seen = new Set();
        let hasDuplicates = false;
        
        history.forEach(job => {
            const key = `${job.jobNum}|${job.dateReceived}|${job.client}`;
            if (seen.has(key)) {
                hasDuplicates = true;
            }
            seen.add(key);
        });
        
        const warningEl = document.getElementById('duplicateWarning');
        if (warningEl) {
            warningEl.style.display = hasDuplicates ? 'block' : 'none';
        }
    }
    
    function removeDuplicateJobs() {
        try {
            let history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const seen = new Map();
            let cleaned = [];
            let duplicates = 0;
            
            history.forEach(job => {
                // Skip jobs with missing critical fields
                if (!job.jobNum || !job.dateReceived || !job.client) {
                    duplicates++;
                    return;
                }
                
                const key = `${job.jobNum}|${job.dateReceived}|${job.client}`;
                if (!seen.has(key)) {
                    seen.set(key, true);
                    cleaned.push(job);
                } else {
                    duplicates++;
                }
            });
            
            if (duplicates > 0) {
                localStorage.setItem('jobHistory', JSON.stringify(cleaned));
                renderHistory();
                renderJobTasks();
                renderScheduleCalendar();
                notify(`‚úì Cleaned ${duplicates} duplicate/invalid jobs!`);
            } else {
                notify('‚úì No duplicates found');
            }
        } catch(e) {
            console.error('Error removing duplicates:', e);
            notify('‚ö†Ô∏è Error cleaning duplicates');
        }
    }
    
    function saveJobToHistory() {
        const jobData = {
            items: items,
            client: document.getElementById('cli').value,
            dateReceived: document.getElementById('dRec').value,
            jobName: document.getElementById('jNm').value,
            jobNum: document.getElementById('jN').value,
            brand: document.getElementById('p-brand').value,
            color: document.getElementById('p-color').value,
            code: document.getElementById('p-code').value,
            finish: document.getElementById('p-finish').value,
            totalSqm: document.getElementById('tA')?.innerText || '0.000',
            totalParts: document.getElementById('tQ')?.innerText || '0',
            timestamp: new Date().toISOString(),
            savedDate: new Date().toLocaleString('en-AU'),
            completed: false  // Always false when saving new
        };
        
        
        // Get existing history
        let history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        // Check if we're overwriting an existing job
        if (currentEditingJobIndex !== null) {
            if (confirm(`Overwrite existing job #${jobData.jobNum}?`)) {
                history[currentEditingJobIndex] = jobData;
                currentEditingJobIndex = null; // Reset for next job
                notify('‚úì Job Updated');
            } else {
                return; // Don't save if user cancels
            }
        } else {
            // Add new job to history - CHECK FOR DUPLICATES FIRST
            const existingIdx = history.findIndex(j => j.jobNum === jobData.jobNum && j.dateReceived === jobData.dateReceived && j.client === jobData.client);
            
            if (existingIdx !== -1) {
                // Job with same number, date, and client already exists - update it instead
                if (confirm(`Job #${jobData.jobNum} already exists. Replace it?`)) {
                    history[existingIdx] = jobData;
                    notify('‚úì Job Updated (duplicate prevented)');
                } else {
                    return;
                }
            } else {
                // New unique job
                history.unshift(jobData);
                notify('‚úì Job Saved');
            }
        }
        
        // Keep only last 50 jobs
        history = history.slice(0, 50);
        
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        // Sync to Firebase immediately
        if (window.syncJobsToFirebase) {
            try {
                window.syncJobsToFirebase();
                console.log('üîÑ Job saved and synced to Firebase');
            } catch(e) {
                console.error('Firebase sync error on save:', e);
            }
        }
        
        // CLEAR FIRST - before rendering
        console.log('üßπ Starting measure sheet clear...');
        items = [];
        console.log('‚úì Cleared items array');
        
        // Clear all form fields with element existence checks
        try {
            const cliEl = document.getElementById('cli');
            if (cliEl) {
                cliEl.value = '';
                console.log('‚úì Cleared client');
            }
            
            const dRecEl = document.getElementById('dRec');
            if (dRecEl) {
                dRecEl.value = '';
                console.log('‚úì Cleared date received');
            }
            
            const jNmEl = document.getElementById('jNm');
            if (jNmEl) {
                jNmEl.value = '';
                console.log('‚úì Cleared job name');
            }
            
            const jNEl = document.getElementById('jN');
            if (jNEl) {
                jNEl.value = '';
                console.log('‚úì Cleared job number');
            }
            
            const pBrandEl = document.getElementById('p-brand');
            if (pBrandEl) {
                pBrandEl.value = 'Wattyl';
                console.log('‚úì Reset paint brand to Wattyl');
            }
            
            const pColorEl = document.getElementById('p-color');
            if (pColorEl) {
                pColorEl.value = '';
                console.log('‚úì Cleared paint colour');
            }
            
            const pCodeEl = document.getElementById('p-code');
            if (pCodeEl) {
                pCodeEl.value = '';
                console.log('‚úì Cleared paint code');
            }
            
            const pFinishEl = document.getElementById('p-finish');
            if (pFinishEl) {
                pFinishEl.value = 'Satin';
                console.log('‚úì Reset paint finish to Satin');
            }
            
            // Clear totals
            const totSqmEl = document.getElementById('tA');
            if (totSqmEl) {
                totSqmEl.innerText = '0.000';
                console.log('‚úì Cleared total SQM');
            }
            
            const totPartsEl = document.getElementById('tQ');
            if (totPartsEl) {
                totPartsEl.innerText = '0';
                console.log('‚úì Cleared total parts');
            }
        } catch(e) {
            console.error('Error clearing form fields:', e);
        }
        
        console.log('‚úì All form fields cleared');
        
        // Clear the items list from localStorage too
        localStorage.removeItem('currentJob');
        console.log('‚úì Cleared currentJob from localStorage');
        
        // Now render the empty form
        render();
        console.log('‚úì Measure sheet re-rendered (empty)');
        
        // Then update other views
        renderHistory();
        renderJobTasks();
        renderScheduleCalendar();
        
        notify('‚úì Job Saved - Form ready for next entry');
        console.log('üìã Ready for next job entry');
    }

    let historyFilter = 'all';
    
    // Track deleted jobs in this session to prevent Firebase from pulling them back
    let deletedJobsThisSession = new Set();
    
    // Function to create unique job key
    function getJobKey(jobNum, dateReceived, client) {
        return `${jobNum}|${dateReceived}|${client}`;
    }
    
    // Function to check if a job has been deleted in this session
    function isJobDeleted(jobNum, dateReceived, client) {
        const key = getJobKey(jobNum, dateReceived, client);
        return deletedJobsThisSession.has(key);
    }
    
    // Function to mark a job as deleted in this session
    function markJobAsDeleted(jobNum, dateReceived, client) {
        const key = getJobKey(jobNum, dateReceived, client);
        deletedJobsThisSession.add(key);
        console.log(`üìå Marked job as deleted in session: ${key} (Total deleted: ${deletedJobsThisSession.size})`);
    }

    function renderHistory() {
        const historyList = document.getElementById('history-list');
        if (!historyList) return;
        
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        if (history.length === 0) {
            historyList.innerHTML = '';
            return;
        }
        
        // FIRST: Filter out deleted jobs from this session (prevents Firebase resurrection)
        let filteredHistory = history.filter(j => {
            const isDeleted = isJobDeleted(j.jobNum, j.dateReceived, j.client);
            if (isDeleted) {
                console.log(`üö´ Filtering out deleted job #${j.jobNum} from display`);
            }
            return !isDeleted;
        });
        
        // SECOND: Apply active/completed filter
        if (historyFilter === 'active') {
            filteredHistory = filteredHistory.filter(j => !j.completed);
        } else if (historyFilter === 'completed') {
            filteredHistory = filteredHistory.filter(j => j.completed === true);
        }
        
        historyList.innerHTML = '';
        if (filteredHistory.length === 0) {
            historyList.innerHTML = '<div class="card" style="text-align:center; color:#999;">No jobs match this filter</div>';
            return;
        }
        
        filteredHistory.forEach((job, idx) => {
            // Find original index in full history
            const originalIdx = history.indexOf(job);
            
            const jobDate = new Date(job.timestamp);
            const dateStr = jobDate.toLocaleDateString('en-AU');
            const isComplete = job.completed || false;
            
            historyList.innerHTML += `<div class="card" style="border-left:5px solid ${isComplete ? '#34c759' : 'var(--gs)'}; position:relative; ${isComplete ? 'background:#f0fff4;' : ''}; overflow:visible;">
                ${isComplete ? '<div class="job-complete-stamp">‚úì COMPLETE</div>' : ''}
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px; position:relative; z-index:1;">
                    <div style="flex:1;">
                        <div style="font-weight:900; color:#000; font-size:14px;">
                            Job #${job.jobNum || 'N/A'}: ${job.jobName || 'Unnamed'}
                        </div>
                        <div style="font-size:11px; color:#666; font-weight:700;">${job.client || 'No Client'}</div>
                    </div>
                    <div style="font-size:11px; color:#999; font-weight:700; text-align:right;">
                        <div>${dateStr}</div>
                        <div>${new Date(job.timestamp).toLocaleTimeString('en-AU', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                </div>
                <div style="display:flex; gap:15px; padding:10px 0; border-top:1px solid #eee; border-bottom:1px solid #eee; margin-bottom:10px; position:relative; z-index:1;">
                    <div style="flex:1; text-align:center;">
                        <div style="font-size:16px; font-weight:900; color:var(--gs);">${job.totalSqm || '0.000'}</div>
                        <div style="font-size:9px; color:#999; font-weight:700;">SQM</div>
                    </div>
                    <div style="flex:1; text-align:center;">
                        <div style="font-size:16px; font-weight:900; color:var(--gs);">${job.totalParts || '0'}</div>
                        <div style="font-size:9px; color:#999; font-weight:700;">PARTS</div>
                    </div>
                    <div style="flex:1; text-align:center;">
                        <div style="font-size:13px; font-weight:900; color:#666;">${job.color || 'N/A'}</div>
                        <div style="font-size:9px; color:#999; font-weight:700;">${job.brand || 'N/A'}</div>
                    </div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; position:relative; z-index:1;">
                    <button onclick="loadJobFromHistory(${originalIdx})" style="flex:1; min-width:100px; border:none; background:#f0f0f0; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">LOAD</button>
                    ${!isComplete ? `<button onclick="completeJobById('${job.jobNum}', '${job.dateReceived}', '${job.client}')" style="flex:1; min-width:100px; border:none; background:var(--gold); color:#000; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">COMPLETE JOB</button>` : `<button onclick="toggleJobCompleteById('${job.jobNum}', '${job.dateReceived}', '${job.client}')" style="flex:1; min-width:100px; border:none; background:#34c759; color:#fff; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">‚úì COMPLETED</button>`}
                    <button onclick="deleteJobFromHistory(${originalIdx})" style="flex:1; min-width:80px; border:none; background:#ff3b3015; color:#ff3b30; padding:10px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">DELETE</button>
                </div>
            </div>`;
        });
        
        // Update client dropdown with latest clients from history
        populateClientDropdown();
    }

    function filterHistory(filter) {
        historyFilter = filter;
        
        // Update button styles
        document.getElementById('filter-all').style.background = filter === 'all' ? '#d4af37' : '#f0f0f0';
        document.getElementById('filter-all').style.color = filter === 'all' ? '#000' : '#666';
        
        document.getElementById('filter-active').style.background = filter === 'active' ? '#d4af37' : '#f0f0f0';
        document.getElementById('filter-active').style.color = filter === 'active' ? '#000' : '#666';
        
        document.getElementById('filter-completed').style.background = filter === 'completed' ? '#34c759' : '#f0f0f0';
        document.getElementById('filter-completed').style.color = filter === 'completed' ? '#fff' : '#666';
        
        renderHistory();
    }

    // Track the current job being edited (if loaded from history)
    let currentEditingJobIndex = null;

    function loadJobFromHistory(index) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[index];
        
        if (!job) return;
        
        currentEditingJobIndex = index; // Track this job for overwrite
        
        items = job.items || [];
        document.getElementById('cli').value = job.client || '';
        document.getElementById('dRec').value = job.dateReceived || '';
        document.getElementById('jNm').value = job.jobName || '';
        document.getElementById('jN').value = job.jobNum || '';
        document.getElementById('p-brand').value = job.brand || 'Wattyl';
        document.getElementById('p-color').value = job.color || '';
        document.getElementById('p-code').value = job.code || '';
        document.getElementById('p-finish').value = job.finish || 'Satin';
        
        render();
        tab('measure');
        notify('‚úì Job Loaded - Editing (will overwrite on save)');
        saveData();
    }

    // Delete a job from Firebase permanently
    function deleteJobFromFirebase(jobId) {
        if (!window.firebaseReady || !window.currentUser || !window.firebaseDb) {
            console.warn('Firebase not ready, cannot delete');
            return;
        }
        
        try {
            const jobDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'jobs', jobId);
            window.deleteDoc(jobDoc).then(() => {
                console.log(`‚úì Deleted job ${jobId} from Firebase`);
            }).catch(err => {
                console.error('Firebase deletion error:', err);
            });
        } catch(e) {
            console.error('deleteJobFromFirebase error:', e);
        }
    }

    function deleteJobFromHistory(index) {
        if (confirm('Delete this job from history permanently?')) {
            let history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const deletedJob = history[index];
            
            if (!deletedJob) {
                console.error('‚ùå Job not found at index:', index);
                return;
            }
            
            console.log(`üóëÔ∏è Permanently deleting Job #${deletedJob.jobNum}`);
            
            // Mark this deletion in session IMMEDIATELY (before any other operations)
            markJobAsDeleted(deletedJob.jobNum, deletedJob.dateReceived, deletedJob.client);
            
            // Remove from history array
            history.splice(index, 1);
            localStorage.setItem('jobHistory', JSON.stringify(history));
            console.log(`‚úì Removed from localStorage`);
            
            // Verify deletion
            let verifyHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const stillExists = verifyHistory.some(j => j.jobNum === deletedJob.jobNum && j.dateReceived === deletedJob.dateReceived && j.client === deletedJob.client);
            
            if (stillExists) {
                console.error('‚ùå CRITICAL: Job still exists after deletion attempt!');
                notify('‚ö†Ô∏è Error: Job deletion failed');
                return;
            }
            
            console.log(`‚úì Deletion verified - Job #${deletedJob.jobNum} is gone from localStorage`);
            
            // Delete from Firebase DIRECTLY (not just sync)
            const jobId = deletedJob.id || deletedJob.jobNum;
            deleteJobFromFirebase(jobId);
            console.log(`‚úì Deletion sent to Firebase`);
            
            notify('‚úì Job permanently deleted');
            
            // Re-render history (will filter out deleted job even if Firebase brings it back)
            renderHistory();
            renderJobTasks();
            renderScheduleCalendar();
        }
    }

    function completeJobById(jobNum, dateReceived, client) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        // Find job by unique identifiers
        const jobIdx = history.findIndex(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
        
        if (jobIdx < 0) {
            console.error('‚ùå Job not found:', jobNum, dateReceived, client);
            notify('‚ö†Ô∏è Error: Job not found');
            return;
        }
        
        const job = history[jobIdx];
        
        if (confirm(`Complete Job #${job.jobNum}?\n\nThis will:\n‚úì Mark job as complete\n‚úì Generate all PDFs\n‚úì Alert admins`)) {
            // Mark job as complete
            job.completed = true;
            job.completedDate = new Date().toISOString();
            history[jobIdx] = job;
            localStorage.setItem('jobHistory', JSON.stringify(history));
            
            console.log(`‚úÖ Job #${job.jobNum} marked as complete`);
            console.log(`üìÖ Completion date: ${job.completedDate}`);
            
            // Verify it was saved
            const verify = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const verifiedJob = verify.find(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
            if (verifiedJob && verifiedJob.completed) {
                console.log(`‚úì Verified: Job is now marked as completed in localStorage`);
            } else {
                console.error(`‚ùå FAILED: Job completion not saved properly!`);
                notify('‚ö†Ô∏è Error: Failed to save completion status');
                return;
            }
            
            // Sync to Firebase IMMEDIATELY
            if (window.syncJobsToFirebase) {
                try {
                    window.syncJobsToFirebase();
                    console.log('üîÑ Synced completion to Firebase');
                } catch(e) {
                    console.error('Firebase sync error:', e);
                }
            }
            
            // Generate batch PDFs
            generateBatchPDFs(job);
            
            // Alert admins
            alertAdmins(job);
            
            notify('‚úì Job Completed - PDFs Generated');
            
            // Re-render ALL views to show completion
            renderHistory();
            renderJobTasks();
            renderScheduleCalendar();
        }
    }
    
    // Kept for backwards compatibility but calls new function
    function completeJobBatch(index) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const jobAtIndex = history[index];
        if (jobAtIndex) {
            completeJobById(jobAtIndex.jobNum, jobAtIndex.dateReceived, jobAtIndex.client);
        }
    }

    // Toggle job completion by job identifiers (used by buttons in history)
    function toggleJobCompleteById(jobNum, dateReceived, client) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        // Find job by unique identifiers
        const jobIdx = history.findIndex(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
        
        if (jobIdx < 0) {
            console.error('‚ùå Job not found:', jobNum, dateReceived, client);
            notify('‚ö†Ô∏è Error: Job not found');
            return;
        }
        
        const job = history[jobIdx];
        
        if (confirm(`Unmark Job #${job.jobNum} as complete?\n\nThis will reopen the job for re-work.`)) {
            job.completed = false;
            job.completedDate = null;
            history[jobIdx] = job;
            localStorage.setItem('jobHistory', JSON.stringify(history));
            
            console.log(`üìã Job #${job.jobNum} unmarked as complete`);
            
            // Sync to Firebase
            if (window.syncJobsToFirebase) {
                try {
                    window.syncJobsToFirebase();
                    console.log('üîÑ Synced to Firebase');
                } catch(e) {
                    console.error('Firebase sync error:', e);
                }
            }
            
            notify('üîÑ Job reopened - now active again');
            
            // Show GLOBAL RED NOTIFICATION for reactivation
            showGlobalReactivationAlert(job);
            
            // Refresh the view
            renderHistory();
        }
    }

    // Show global red notification when job is reactivated
    function showGlobalReactivationAlert(job) {
        const alertArea = document.getElementById('globalNotifications');
        if (!alertArea) {
            console.log('Global notifications area not found (user not on Schedule tab)');
            return;
        }
        
        const alertId = `reactivation-${job.jobNum}-${Date.now()}`;
        
        // Remove "no notifications yet" placeholder if it exists
        const placeholder = alertArea.querySelector('p');
        if (placeholder) placeholder.remove();
        
        const alertHTML = `
            <div id="${alertId}" style="background:#ff3b30; color:#fff; padding:12px; border-radius:8px; font-weight:900; font-size:12px; margin-bottom:8px; transition:all 0.3s ease;">
                üö® JOB #${job.jobNum} REACTIVATED
            </div>
        `;
        
        alertArea.insertAdjacentHTML('beforeend', alertHTML);
        
        // Strike through after 10 seconds
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.textDecoration = 'line-through';
                alert.style.opacity = '0.5';
                alert.style.background = '#ff3b3080';
            }
        }, 10000);
        
        // Remove after 20 seconds
        setTimeout(() => {
            const alert = document.getElementById(alertId);
            if (alert) {
                alert.style.transition = 'opacity 0.5s ease';
                alert.style.opacity = '0';
                setTimeout(() => {
                    alert.remove();
                    // If no more alerts, show placeholder
                    if (alertArea.children.length === 0) {
                        alertArea.innerHTML = '<p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p>';
                    }
                }, 500);
            }
        }, 20000);
    }

    function generateBatchPDFs(job) {
        const { jsPDF } = window.jspdf;
        
        // Get job items for reference
        const items = job.items || [];
        
        // Create a zip-like multi-page document with all forms
        const doc = new jsPDF();
        let y = 20;
        
        // ===== PAGE 1: ESTIMATE =====
        doc.setFontSize(18);
        doc.text('ESTIMATE', 20, y);
        y += 10;
        doc.setFontSize(10);
        doc.text(`Job #: ${job.jobNum}`, 20, y);
        y += 5;
        doc.text(`Client: ${job.client}`, 20, y);
        y += 5;
        doc.text(`Job: ${job.jobName}`, 20, y);
        y += 5;
        doc.text(`Date: ${job.dateReceived || 'N/A'}`, 20, y);
        y += 10;
        
        // Parts table
        doc.setFontSize(9);
        const headers = ['Description', 'H√óW', 'Qty', 'Profile', 'Mode', 'SQM'];
        const colWidths = [50, 25, 15, 40, 20, 25];
        let x = 20;
        
        doc.setFillColor(0, 0, 0);
        doc.setTextColor(255, 255, 255);
        headers.forEach((h, i) => {
            doc.text(h, x, y);
            x += colWidths[i];
        });
        y += 8;
        doc.setTextColor(0, 0, 0);
        
        let totalSqm = 0;
        items.forEach(it => {
            x = 20;
            const rowSqm = parseFloat(it.sqm) * it.qty;
            totalSqm += rowSqm;
            
            doc.text(it.desc.substring(0, 20), x, y); x += colWidths[0];
            doc.text(`${it.h}√ó${it.w}`, x, y); x += colWidths[1];
            doc.text(it.qty.toString(), x, y); x += colWidths[2];
            doc.text(it.prof.substring(0, 15), x, y); x += colWidths[3];
            doc.text(it.mode, x, y); x += colWidths[4];
            doc.text(rowSqm.toFixed(3), x, y);
            
            y += 8;
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
        });
        
        y += 5;
        doc.setFontSize(11);
        doc.text(`Total SQM: ${totalSqm.toFixed(3)}`, 20, y);
        doc.text(`Total Parts: ${items.length}`, 20, y + 10);
        
        // ===== PAGE 2: SUPPLY DOCKET =====
        doc.addPage();
        y = 20;
        doc.setFontSize(18);
        doc.text('SUPPLY DOCKET', 20, y);
        y += 10;
        doc.setFontSize(10);
        doc.text(`Client: ${job.client}`, 20, y);
        y += 5;
        doc.text(`Job #: ${job.jobNum} - ${job.jobName}`, 20, y);
        y += 5;
        doc.text(`Paint: ${job.brand} - ${job.color}`, 20, y);
        y += 5;
        doc.text(`Code: ${job.code} | Finish: ${job.finish}`, 20, y);
        y += 10;
        
        doc.setFontSize(9);
        x = 20;
        doc.setFillColor(0, 0, 0);
        doc.setTextColor(255, 255, 255);
        headers.forEach((h, i) => {
            doc.text(h, x, y);
            x += colWidths[i];
        });
        y += 8;
        doc.setTextColor(0, 0, 0);
        
        items.forEach(it => {
            x = 20;
            const rowSqm = parseFloat(it.sqm) * it.qty;
            
            doc.text(it.desc.substring(0, 20), x, y); x += colWidths[0];
            doc.text(`${it.h}√ó${it.w}`, x, y); x += colWidths[1];
            doc.text(it.qty.toString(), x, y); x += colWidths[2];
            doc.text(it.prof.substring(0, 15), x, y); x += colWidths[3];
            doc.text(it.mode, x, y); x += colWidths[4];
            doc.text(rowSqm.toFixed(3), x, y);
            
            y += 8;
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
        });
        
        // ===== PAGE 3: MIXING CARD =====
        doc.addPage();
        y = 20;
        doc.setFontSize(18);
        doc.text('MIXING CARD - PAINT SHOP', 20, y);
        y += 12;
        doc.setFontSize(11);
        doc.text(`Brand: ${job.brand}`, 20, y);
        y += 6;
        doc.text(`Color: ${job.color}`, 20, y);
        y += 6;
        doc.text(`Code/Formula: ${job.code}`, 20, y);
        y += 6;
        doc.text(`Finish: ${job.finish}`, 20, y);
        y += 12;
        
        doc.setFontSize(9);
        doc.text(`Total SQM Required: ${totalSqm.toFixed(3)}`, 20, y);
        y += 6;
        doc.text(`Jobs/Items: ${items.length}`, 20, y);
        y += 10;
        
        doc.setFontSize(10);
        doc.text(`Date: ${new Date().toLocaleDateString('en-AU')}`, 20, y);
        y += 6;
        doc.text(`Prepared by: ___________________`, 20, y);
        y += 6;
        doc.text(`Mixed by: ___________________`, 20, y);
        
        // Save combined PDF to localStorage instead of auto-download
        const filename = `Job_${job.jobNum}_${job.client.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        
        // Store PDF in localStorage or just skip auto-download
        try {
            const pdfData = doc.output('datauristring');
            // Could store in localStorage if needed, but for now just acknowledge it's ready
        } catch(e) {
        }
    }

    function alertAdmins(job) {
        const adminAlert = {
            timestamp: new Date().toISOString(),
            type: 'JOB_COMPLETED',
            jobNum: job.jobNum,
            jobName: job.jobName,
            client: job.client,
            totalSqm: job.totalSqm,
            totalParts: job.totalParts,
            completedDate: new Date().toLocaleString('en-AU'),
            message: `üéâ Job #${job.jobNum} (${job.jobName}) for ${job.client} has been COMPLETED. ${job.totalParts} parts, ${job.totalSqm} SQM. PDFs generated.`
        };
        
        // Store admin alerts in localStorage
        let adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        adminAlerts.unshift(adminAlert);
        adminAlerts = adminAlerts.slice(0, 100); // Keep last 100 alerts
        localStorage.setItem('adminAlerts', JSON.stringify(adminAlerts));
        
        // In a real app, this would send to a server/notification service
        
        // Show toast-style notification
        showAdminAlert(adminAlert.message);
    }

    function showAdminAlert(message) {
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = 'position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:#34c759; color:#fff; padding:15px 25px; border-radius:30px; font-weight:900; z-index:4000; font-size:12px; border:2px solid #28a745; box-shadow:0 4px 15px rgba(52, 199, 89, 0.4);';
        alertDiv.innerText = message;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 4000);
    }

    function renderAdminAlerts() {
        const adminAlertsDiv = document.getElementById('admin-alerts');
        if (!adminAlertsDiv) return;
        
        const alerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        
        if (alerts.length === 0) {
            adminAlertsDiv.innerHTML = '<div class="card"><p style="color:#999; text-align:center; font-size:12px;">No job completions yet</p></div>';
            return;
        }
        
        adminAlertsDiv.innerHTML = '';
        alerts.forEach((alert, i) => {
            const alertDate = new Date(alert.timestamp);
            adminAlertsDiv.innerHTML += `<div class="card" style="border-left:5px solid #34c759; background:#f0fdf4;">
                <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                    <div style="flex:1;">
                        <div style="font-weight:900; color:#000; font-size:13px;">‚úì Job #${alert.jobNum}: ${alert.jobName}</div>
                        <div style="font-size:11px; color:#666; font-weight:700;">${alert.client}</div>
                    </div>
                    <div style="font-size:10px; color:#888; font-weight:700; text-align:right;">
                        <div>${alertDate.toLocaleDateString('en-AU')}</div>
                        <div>${alertDate.toLocaleTimeString('en-AU', {hour: '2-digit', minute: '2-digit'})}</div>
                    </div>
                </div>
                <div style="display:flex; gap:10px; padding:8px 0; font-size:11px; font-weight:700; color:#666;">
                    <div>üìä ${alert.totalParts} Parts</div>
                    <div>üìê ${alert.totalSqm} SQM</div>
                </div>
            </div>`;
        });
    }

    function refreshLists() {
        const cliSel = document.getElementById('cli'); 
        cliSel.innerHTML = '';
        clients.sort().forEach(c => { 
            let o = document.createElement('option'); 
            o.innerText=c; 
            cliSel.appendChild(o); 
        });
        
        const profSel = document.getElementById('prof-select'); 
        profSel.innerHTML = '';
        profiles.forEach(p => { 
            let o = document.createElement('option'); 
            o.value=p; 
            o.innerText=p; 
            profSel.appendChild(o); 
        });
        
        renderDB();
    }

    function tab(t) {
        document.querySelectorAll('.view-section, .nav-btn').forEach(x => x.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.getElementById('btn-' + t).classList.add('active');
        
        // Show/hide workload summary based on active tab
        const workloadContainer = document.getElementById('workloadSummaryContainer');
        if (workloadContainer) {
            if (t === 'schedule' || t === 'admin') {
                workloadContainer.style.display = 'block';
            } else {
                workloadContainer.style.display = 'none';
            }
        }
        
        // Render admin alerts when viewing admin tab
        if (t === 'admin') {
            renderAdminAlerts();
        }
        
        // Render schedule calendar when viewing schedule tab
        if (t === 'schedule') {
            renderScheduleCalendar();
        }
    }

    function subTab(t) {
        document.querySelectorAll('.sub-section').forEach(x => x.style.display = 'none');
        document.querySelectorAll('.sub-btn').forEach(x => x.classList.remove('active'));
        document.getElementById('sub-' + t).style.display = 'block';
        document.getElementById('sub-btn-' + t).classList.add('active');
        
        // Special handling for paint tab
        if (t === 'paint') {
            renderPaintFormulaList();
        }
    }

    // DATABASE OPS
    function renderDB() {
        const cL = document.getElementById('list-clients'); 
        cL.innerHTML = '';
        clients.sort().forEach((c, i) => { 
            cL.innerHTML += `<div class="db-item"><span>${c}</span><span class="db-del" onclick="delCli('${c}')">√ó</span></div>`; 
        });
        
        const pL = document.getElementById('list-profiles'); 
        pL.innerHTML = '';
        profiles.sort().forEach((p, i) => { 
            pL.innerHTML += `<div class="db-item" style="display:flex; justify-content:space-between; align-items:center;">
                <span style="flex:1;">${p}</span>
                <button onclick="editProfile('${p}')" style="padding:2px 8px; background:#2196f3; color:#fff; border:none; border-radius:3px; font-size:9px; font-weight:900; cursor:pointer; margin-right:4px;">EDIT</button>
                <span class="db-del" onclick="delProf('${p}')">√ó</span>
            </div>`; 
        });
    }

    function addClient() { 
        let v = document.getElementById('new-client').value.trim(); 
        if(v && !clients.includes(v)){ 
            clients.push(v); 
            document.getElementById('new-client').value=''; 
            refreshLists();
            notify('Client Added');
        } else if (clients.includes(v)) {
            notify('Client Already Exists');
        }
    }
    
    function delCli(name) { 
        if(confirm("Delete " + name + "?")){ 
            clients = clients.filter(x => x !== name); 
            refreshLists();
            notify('Client Deleted');
        } 
    }
    
    function addProfile() { 
        let v = document.getElementById('new-profile').value.trim(); 
        if(v && !profiles.includes(v)){ 
            profiles.push(v); 
            document.getElementById('new-profile').value=''; 
            refreshLists();
            notify('Profile Added');
        } else if (profiles.includes(v)) {
            notify('Profile Already Exists');
        }
    }
    
    function delProf(name) { 
        if(confirm("Delete " + name + "?")){ 
            profiles = profiles.filter(x => x !== name); 
            refreshLists();
            notify('Profile Deleted');
        } 
    }
    
    function editProfile(oldName) {
        const newName = prompt(`Rename profile:\n\n${oldName}`, oldName);
        if (newName && newName.trim() !== '') {
            const trimmed = newName.trim();
            if (trimmed === oldName) {
                return; // No change
            }
            if (profiles.includes(trimmed)) {
                alert('Profile name already exists');
                return;
            }
            profiles = profiles.map(p => p === oldName ? trimmed : p);
            refreshLists();
            notify('Profile Renamed');
        }
    }

    function setFM(v) {
        fmState = v;
        document.querySelectorAll('.fm-opt').forEach(o => o.classList.remove('active'));
        document.getElementById(v==='Flat'?'fm-flat':'fm-mould').classList.add('active');
        up();
    }

    function setP(t) {
        pType = t;
        document.querySelectorAll('.p-card').forEach(c => c.classList.remove('active'));
        const map = {'Panel':'pP', 'Door':'pD', 'Drawer':'pDr', 'Custom':'pC'};
        document.getElementById(map[t]).classList.add('active');
        const allE = ['E1','E2','E3','E4'];
        allE.forEach(id => document.getElementById(id).classList.remove('active'));
        if(t === 'Door' || t === 'Drawer') allE.forEach(id => document.getElementById(id).classList.add('active'));
        else if (mode === 'SE') document.getElementById('E1').classList.add('active');
        up();
    }

    function setM(m) {
        mode = m;
        document.querySelectorAll('.mode-sel').forEach(b => b.classList.remove('active'));
        document.getElementById('m' + m).classList.add('active');
        // REQUIREMENT: SE auto-selects one long edge by default
        if (m === 'SE') {
            document.getElementById('E1').classList.add('active'); 
        }
        up();
    }
    
    function tE(el) { 
        el.classList.toggle('active'); 
        up(); 
    }

    function up() {
        const h = parseFloat(document.getElementById('h').value) || 0;
        const w = parseFloat(document.getElementById('w').value) || 0;
        const thk = parseFloat(document.getElementById('thk').value) || 18;
        const eL = (document.getElementById('E1').classList.contains('active')?1:0) + (document.getElementById('E2').classList.contains('active')?1:0);
        const eS = (document.getElementById('E3').classList.contains('active')?1:0) + (document.getElementById('E4').classList.contains('active')?1:0);
        let area = (h * w);
        if(mode === 'DS') area *= 2;
        if(mode === 'SE') area += ((eL * h) + (eS * w)) * 100;
        area += ((eL * h * thk) + (eS * w * thk));
        if (document.getElementById('liveSq')) document.getElementById('liveSq').innerText = (area / 1000000).toFixed(3);
    }

    function addPart() {
        const h = document.getElementById('h').value;
        const w = document.getElementById('w').value;
        const prof = document.getElementById('prof-select').value;
        const desc = document.getElementById('desc').value || "Part";
        
        if(!h || !w) return;
        const edges = [
            document.getElementById('E1').classList.contains('active'),
            document.getElementById('E2').classList.contains('active'),
            document.getElementById('E3').classList.contains('active'),
            document.getElementById('E4').classList.contains('active')
        ];
        // REQUIREMENT: Deduplication (Add 1 to existing if identical)
        let existing = items.find(it => 
            it.h === h && it.w === w && it.prof === prof && 
            it.fm === fmState && it.mode === mode && 
            JSON.stringify(it.e) === JSON.stringify(edges)
        );
        if (existing) {
            existing.qty += (parseInt(document.getElementById('qty').value) || 1);
            notify("Qty Updated");
        } else {
            const liveSqElement = document.getElementById('liveSq');
            const sqmValue = liveSqElement ? liveSqElement.innerText : '0.000';
            
            items.push({
                h, w, qty: (parseInt(document.getElementById('qty').value) || 1),
                desc: desc.toUpperCase(), prof: prof, fm: fmState,
                mode: mode, e: edges, sqm: sqmValue,
                brand: document.getElementById('p-brand').value,
                color: document.getElementById('p-color').value,
                code: document.getElementById('p-code').value,
                finish: document.getElementById('p-finish').value,
                type: pType,
                thk: document.getElementById('thk').value
            });
            notify("Part Added");
        }
        render();
        saveData(); // Auto-save to LocalStorage
        document.getElementById('h').value = ''; 
        document.getElementById('w').value = '';
        document.getElementById('desc').value = '';
    }

    function render() {
        const l = document.getElementById('list');
        if (!l) return; // Exit if list doesn't exist (not on measure tab)
        
        l.innerHTML = '';
        let tA = 0, tQ = 0;
        
        items.forEach((it, i) => {
            const rowSqm = parseFloat(it.sqm) * it.qty; 
            tA += rowSqm; 
            tQ += it.qty;
            const clr = `var(--${it.type.toLowerCase()}-clr)`;
            let Lc = (it.e[0]?1:0) + (it.e[1]?1:0), Sc = (it.e[2]?1:0) + (it.e[3]?1:0);
            let tL = (Lc ? Lc+'L' : ''), tS = (Sc ? Sc+'S' : '');
            let mC = it.mode === 'SS' ? '#34c759' : (it.mode === 'DS' ? '#ff9500' : '#ff3b30');
            
            l.innerHTML += `<div class="part-label" style="border-left:5px solid ${clr}">
                <div class="qty-controls">
                    <button class="qty-btn" style="border-radius:4px 4px 0 0;" onclick="changeQty(${i}, 1)">+</button>
                    <div class="pl-qty" style="margin:0; border-radius:0;">${it.qty}</div>
                    <button class="qty-btn" style="border-radius:0 0 4px 4px;" onclick="changeQty(${i}, -1)">‚àí</button>
                </div>
                <div class="pl-center">
                    <div style="font-size:10px; font-weight:900; color:${clr}; text-transform:uppercase; line-height:1;">${it.desc} (${it.fm})</div>
                    <div style="font-size:10px; font-weight:700; color:#666; margin-bottom:2px;">${it.brand} - ${it.color} ‚Ä¢ ${it.finish}</div>
                    <div class="pl-dims">${it.h} √ó ${it.w} √ó ${it.thk}</div>
                    <div class="pl-meta"><span style="font-weight:700;">${it.prof}</span> ${tL ? `<span class="edge-pill" style="background:#f44336">${tL}</span>` : ''} ${tS ? `<span class="edge-pill" style="background:#2196f3">${tS}</span>` : ''}</div>
                </div>
                <div class="pl-right">
                    <div class="pl-mode" style="color:${mC}; border-color:${mC}; background:${mC}15">${it.mode}</div>
                    <div style="font-size:11px; font-weight:900;">${rowSqm.toFixed(3)}</div>
                </div>
                <button class="del-btn" onclick="deleteItem(${i})">√ó</button>
            </div>`;
        });
        
        if (document.getElementById('tA')) document.getElementById('tA').innerText = tA.toFixed(3);
        if (document.getElementById('tQ')) document.getElementById('tQ').innerText = tQ;
    }

    function changeQty(index, delta) { 
        try {
            if (index < 0 || index >= items.length) {
                console.error('Invalid item index:', index);
                return;
            }
            items[index].qty += delta; 
            if (items[index].qty < 1) items[index].qty = 1; 
            render();
            saveData();
        } catch(e) {
            console.error('Error changing quantity:', e);
            notify('‚ö†Ô∏è Error updating quantity');
        }
    }

    function deleteItem(index) {
        try {
            if (index < 0 || index >= items.length) {
                console.error('Invalid item index:', index);
                return;
            }
            items.splice(index, 1);
            render();
            saveData();
            notify('Part Removed');
        } catch(e) {
            console.error('Error deleting item:', e);
            notify('‚ö†Ô∏è Error deleting part');
        }
    }

    function notify(m) { 
        const t = document.getElementById('toast');
        if (!t) return; // Exit if toast doesn't exist
        t.innerText = m; 
        t.style.display = 'block'; 
        setTimeout(()=>t.style.display='none', 1500); 
    }

    function genForm(type) { 
        if (items.length === 0) {
            notify('Add parts first');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 20;
        
        // Header
        doc.setFontSize(20);
        doc.text('PaintWorkz Pro', 20, y);
        y += 10;
        doc.setFontSize(10);
        doc.text(`Form Type: ${type}`, 20, y);
        y += 5;
        doc.text(`Client: ${document.getElementById('cli').value}`, 20, y);
        y += 5;
        doc.text(`Job: ${document.getElementById('jNm').value}`, 20, y);
        y += 10;
        
        // Parts table
        doc.setFontSize(9);
        const headers = ['Desc', 'H√óW√óT', 'Qty', 'Prof', 'Mode', 'SQM'];
        const colWidths = [40, 30, 15, 40, 20, 25];
        let x = 20;
        
        // Header row
        doc.setFillColor(0, 0, 0);
        doc.setTextColor(255, 255, 255);
        headers.forEach((h, i) => {
            doc.text(h, x, y);
            x += colWidths[i];
        });
        y += 8;
        doc.setTextColor(0, 0, 0);
        
        // Data rows
        let totalSqm = 0;
        items.forEach(it => {
            x = 20;
            const rowSqm = parseFloat(it.sqm) * it.qty;
            totalSqm += rowSqm;
            
            doc.text(it.desc, x, y); x += colWidths[0];
            doc.text(`${it.h}√ó${it.w}√ó${it.thk}`, x, y); x += colWidths[1];
            doc.text(it.qty.toString(), x, y); x += colWidths[2];
            doc.text(it.prof, x, y); x += colWidths[3];
            doc.text(it.mode, x, y); x += colWidths[4];
            doc.text(rowSqm.toFixed(3), x, y);
            
            y += 8;
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
        });
        
        // Footer
        y += 5;
        doc.setFontSize(11);
        doc.text(`Total SQM: ${totalSqm.toFixed(3)}`, 20, y);
        doc.text(`Total Parts: ${items.length}`, 20, y + 10);
        
        doc.save(`${type.replace(' ', '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
        notify(`${type} PDF Downloaded`);
    }

    function genPDF() {
        genForm('Estimate');
    }

    function saveJob() { 
        try {
            saveData();
            saveJobToHistory(); // This will show its own notification
            
            // Auto-increment job number
            try {
                const currentJobNum = document.getElementById('jN').value;
                if (currentJobNum) {
                    // Extract number from job number (handle formats like "001", "1", "JOB001", etc)
                    const match = currentJobNum.match(/\d+/);
                    if (match) {
                        const nextNum = String(parseInt(match[0]) + 1).padStart(match[0].length, '0');
                        const prefix = currentJobNum.substring(0, currentJobNum.indexOf(match[0]));
                        const suffix = currentJobNum.substring(currentJobNum.indexOf(match[0]) + match[0].length);
                        document.getElementById('jN').value = prefix + nextNum + suffix;
                    }
                }
            } catch(e) {
                console.error('Error auto-incrementing job number:', e);
            }
            
            // Clear measure sheet and panel list
            setTimeout(() => {
                try {
                    items = [];
                    const hEl = document.getElementById('h');
                    if (hEl) hEl.value = '';
                    const wEl = document.getElementById('w');
                    if (wEl) wEl.value = '';
                    const descEl = document.getElementById('desc');
                    if (descEl) descEl.value = '';
                    const jNmEl = document.getElementById('jNm');
                    if (jNmEl) jNmEl.value = '';
                    
                    render(); // Re-render to clear UI
                    tab('history'); // Navigate to history tab
                    renderHistory();
                } catch(e) {
                    console.error('Error clearing measure sheet:', e);
                }
            }, 500);
        } catch(e) {
            console.error('Error in saveJob:', e);
            notify('‚ö†Ô∏è Error saving job');
        }
    }

    function snap() { 
        notify("üì∏ Camera function ready"); 
    }

    function clearAllData() {
        if (confirm('Are you absolutely sure? This will delete all data and cannot be undone.')) {
            items = [];
            currentEditingJobIndex = null; // Reset editing index
            localStorage.removeItem('currentJob');
            document.getElementById('h').value = '';
            document.getElementById('w').value = '';
            document.getElementById('desc').value = '';
            document.getElementById('dRec').value = '';
            document.getElementById('jNm').value = '';
            document.getElementById('jN').value = '';
            render();
            notify('All Data Cleared');
        }
    }
    
    function startNewJob() {
        currentEditingJobIndex = null; // Reset editing index when starting new job
        clearAllData(); // This will also clear the form
    }

    // CALENDAR FUNCTIONALITY
    let calendarDate = new Date();

    function openCalendar() {
        calendarDate = new Date();
        renderCalendar();
        document.getElementById('calendarModal').style.display = 'flex';
    }

    function closeCalendar() {
        document.getElementById('calendarModal').style.display = 'none';
    }

    function prevMonth() {
        calendarDate.setMonth(calendarDate.getMonth() - 1);
        renderCalendar();
    }

    function nextMonth() {
        calendarDate.setMonth(calendarDate.getMonth() + 1);
        renderCalendar();
    }

    function renderCalendar() {
        const year = calendarDate.getFullYear();
        const month = calendarDate.getMonth();
        
        // Set month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        if (document.getElementById('monthYear')) document.getElementById('monthYear').innerText = `${monthNames[month]} ${year}`;
        
        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();
        
        let daysHTML = '';
        
        // Previous month's days
        for (let i = firstDay - 1; i >= 0; i--) {
            daysHTML += `<div style="padding:8px; text-align:center; color:#ccc; font-weight:900; background:#f9f9f9; border-radius:6px;">${daysInPrevMonth - i}</div>`;
        }
        
        // Current month's days
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            const dateStr = `${day.toString().padStart(2, '0')}/${(month + 1).toString().padStart(2, '0')}/${year.toString().slice(-2)}`;
            daysHTML += `<div onclick="selectDate('${dateStr}')" style="padding:8px; text-align:center; font-weight:900; background:${isToday ? 'var(--gs)' : '#fff'}; color:${isToday ? '#000' : '#333'}; border:${isToday ? '2px solid var(--gs)' : '1px solid #eee'}; border-radius:6px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='${isToday ? 'var(--gs)' : '#fff'}'">${day}</div>`;
        }
        
        // Next month's days
        const totalCells = firstDay + daysInMonth;
        const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let day = 1; day <= remainingCells; day++) {
            daysHTML += `<div style="padding:8px; text-align:center; color:#ccc; font-weight:900; background:#f9f9f9; border-radius:6px;">${day}</div>`;
        }
        
        document.getElementById('calendarDays').innerHTML = daysHTML;
    }

    function selectDate(dateStr) {
        document.getElementById('dRec').value = dateStr;
        saveData();
        notify(`Date Set: ${dateStr}`);
        closeCalendar();
        // Refresh schedule calendar
        renderScheduleCalendar();
    }

    function selectToday() {
        const today = new Date();
        const dateStr = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear().toString().slice(-2)}`;
        selectDate(dateStr);
    }

    // SCHEDULE CALENDAR FUNCTIONALITY
    let scheduleCalendarDate = new Date();

    function renderScheduleCalendar() {
        
        // FORCE SCHEDULE CONTAINER TO BE VISIBLE
        const scheduleContainer = document.getElementById('schedule');
        if (scheduleContainer) {
            scheduleContainer.style.display = 'block';
            scheduleContainer.style.visibility = 'visible';
            scheduleContainer.style.minHeight = 'auto';
        }
        
        const year = scheduleCalendarDate.getFullYear();
        const month = scheduleCalendarDate.getMonth();
        
        // Set month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        if (document.getElementById('scheduleMonthYear')) document.getElementById('scheduleMonthYear').innerText = `${monthNames[month]} ${year}`;
        
        renderGanttChart(year, month);
        renderGlobalNotifications();
        renderJobTasks(); // Update workload summary
        checkForDuplicates(); // Show warning if duplicates exist
    }
    
    function renderGanttChart(year, month) {
        // FORCE WRAPPER TO BE VISIBLE
        const ganttWrapper = document.getElementById('ganttWrapper');
        if (ganttWrapper) {
            ganttWrapper.style.display = 'block';
            ganttWrapper.style.visibility = 'visible';
            ganttWrapper.style.opacity = '1';
        }
        
        const ganttChart = document.getElementById('ganttChart');
        if (!ganttChart) {
            return;
        }
        
        // FORCE VISIBILITY BEFORE RENDERING
        ganttChart.style.display = 'flex';
        ganttChart.style.visibility = 'visible';
        ganttChart.style.minHeight = 'auto';
        ganttChart.style.opacity = '1';
        
        // Check if element is visible
        const style = window.getComputedStyle(ganttChart);
        
        try {
            let fullHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            
        
        // Sort by received date - newest first
        let history = fullHistory.filter(job => !job.completed).sort((a, b) => {
            let dateA = new Date();
            let dateB = new Date();
            
            // Parse dateReceived in DD/MM/YY format
            if (a.dateReceived) {
                if (a.dateReceived.includes('/')) {
                    const [day, month, year] = a.dateReceived.split('/');
                    dateA = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                } else if (a.dateReceived.includes('-')) {
                    dateA = new Date(a.dateReceived);
                }
            }
            
            if (b.dateReceived) {
                if (b.dateReceived.includes('/')) {
                    const [day, month, year] = b.dateReceived.split('/');
                    dateB = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                } else if (b.dateReceived.includes('-')) {
                    dateB = new Date(b.dateReceived);
                }
            }
            
            return dateB - dateA;
        });
        
        // Generate all dates for the month - SHOW ALL DAYS
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        // Get all days for this month with weekday info
        const allDays = [];
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            allDays.push({ day, date, isWeekday: isWeekday(date) });
        }
        
        // Create header with dates (ALL DAYS - weekends grayed out)
        const timelineWidth = allDays.length * 28;
        let ganttHTML = '<div style="display:flex; gap:0; margin-bottom:0; position:sticky; top:0; background:#fff; z-index:10; border-bottom:2px solid #ddd; min-height:28px; align-items:stretch;">';
        
        // Job names column - MUST MATCH job info width (170px) - EXACT same styling
        ganttHTML += '<div style="width:170px; min-width:170px; max-width:170px; font-weight:900; font-size:9px; padding:5px 6px; border-right:2px solid #ddd; color:#000; line-height:1.2; background:#f9f9f9; box-sizing:border-box; display:flex; align-items:center;">DATE</div>';
        
        // Wrap date columns in container with exact calculated width
        ganttHTML += `<div style="width:${timelineWidth}px; min-width:${timelineWidth}px; max-width:${timelineWidth}px; display:flex; gap:0; min-height:28px;">`;
        
        // Date columns - ALL DAYS (weekends lighter) - EXACT 28px box
        allDays.forEach(({ day, date, isWeekday: isWD }) => {
            const dayName = ['S', 'M', 'T', 'W', 'T', 'F', 'S'][date.getDay()];
            const bgColor = isWD ? '#f0f0f0' : '#f9f9f9';
            const textColor = isWD ? '#666' : '#ccc';
            ganttHTML += `<div style="width:28px; min-width:28px; max-width:28px; height:28px; text-align:center; font-weight:900; font-size:9px; padding:2px 0; background:${bgColor}; border:1px solid #eee; color:${textColor}; box-sizing:border-box; display:flex; flex-direction:column; align-items:center; justify-content:center; line-height:1.1;">${dayName}<br>${day}</div>`;
        });
        ganttHTML += '</div>';  // Close date columns container
        ganttHTML += '</div>';  // Close header row
        
        // Jobs timeline
        ganttHTML += '<div style="width:100%; display:flex; flex-direction:column; gap:0;">';
        let jobCount = 0;
        history.forEach((job, filteredIdx) => {
            // Find original index in full history
            const originalIdx = fullHistory.findIndex(j => j === job);
            
            if (job && !job.completed) {
                jobCount++;
                // Handle date in DD/MM/YY or YYYY-MM-DD format
                let jobDate = new Date();
                if (job.dateReceived) {
                    try {
                        if (job.dateReceived.includes('/')) {
                            // DD/MM/YY format
                            const [day, jobMonth, jobYear] = job.dateReceived.split('/');
                            jobDate = new Date(parseInt('20' + jobYear), parseInt(jobMonth) - 1, parseInt(day));
                        } else if (job.dateReceived.includes('-')) {
                            // YYYY-MM-DD format
                            jobDate = new Date(job.dateReceived);
                        }
                    } catch (e) {
                        jobDate = new Date(); // Default to today if parsing fails
                    }
                }
                
                // Initialize job phases tracking if not exists
                if (!job.phases) job.phases = {};
                
                // Get custom timeline for this job or use defaults
                const jobTimeline = job.timeline || getDefaultTimeline();
                const measuringEnd = jobTimeline.measuring;
                const sanding1End = jobTimeline.sanding1;
                const undercoatEnd = jobTimeline.undercoat;
                const sanding2End = jobTimeline.sanding2;
                const topCoatEnd = jobTimeline.topcoat;
                const inspectEnd = jobTimeline.inspect;
                const completionDay = jobTimeline.complete;
                // Job header with info and timeline - Alternate background every 2nd job
                const jobBgColor = jobCount % 2 === 0 ? '#ffffff' : '#f5f5f5';
                const timelineWidth = allDays.length * 28;
                ganttHTML += `<div style="margin-bottom:0; padding-bottom:0; display:flex; gap:0; background:${jobBgColor}; border:1px solid #ddd; border-bottom:2px solid #bbb;">
                    <!-- Left Column: Job Info -->
                    <div style="width:170px; min-width:170px; max-width:170px; font-weight:900; font-size:9px; padding:5px 6px; border-right:2px solid #ddd; color:#000; line-height:1.2; background:#f9f9f9; box-sizing:border-box;">
                        <div style="color:#d4af37; font-size:10px;">#${job.jobNum}</div>
                        <div style="font-size:8px; color:#666; margin-top:1px;">${job.client}</div>
                        <div style="font-size:7px; color:#2196f3; font-weight:900; margin-top:1px;">üìê ${parseFloat(job.totalSqm || 0).toFixed(2)} m¬≤</div>
                        <button onclick="editJobTimeline(${originalIdx})" style="font-size:7px; padding:1px 3px; border:none; background:#2196f3; color:#fff; border-radius:2px; cursor:pointer; margin-top:1px; width:100%;">‚úèÔ∏è Edit</button>
                    </div>
                    
                    <!-- Right Column: Timeline bars + Phase checkboxes stacked -->
                    <div style="display:flex; flex-direction:column; gap:0; width:${timelineWidth}px; min-width:${timelineWidth}px; max-width:${timelineWidth}px;">
                        <!-- Timeline bars row -->
                        <div style="display:flex; gap:0;">`;
                
                // Timeline bars - ALL DAYS but NEVER work on weekends
                allDays.forEach(({ day, date: cellDate, isWeekday: isWD }) => {
                    let barHTML = '';
                    
                    // WEEKEND = ALWAYS EMPTY, NO WORK
                    if (!isWD) {
                        barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:#fafafa; border:1px solid #f0f0f0; box-sizing:border-box;"></div>`;
                    }
                    // WEEKDAY ONLY = check phase
                    else if (isWD) {
                        // Weekday - count which working day this is from job start
                        const workingDayNum = getWorkingDayNumber(jobDate, cellDate);
                        
                        if (workingDayNum < 1) {
                            // Before job start
                            barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:#f9f9f9; border:1px solid #eee; box-sizing:border-box;"></div>`;
                        } else {
                            // Job has started - assign to phase
                            let phaseKey = '';
                            let phaseColor = '';
                            let phaseLabel = '';
                            let isStrikeThrough = false;
                            
                            // Assign working day to phase (simple whole day allocation)
                            if (workingDayNum <= measuringEnd) {
                                phaseKey = 'measuring';
                                phaseColor = '#2196f3';
                                phaseLabel = 'M';
                                isStrikeThrough = job.phases && job.phases.measuring;
                            } else if (workingDayNum <= sanding1End) {
                                phaseKey = 'sanding1';
                                phaseColor = '#ff9500';
                                phaseLabel = 'S1';
                                isStrikeThrough = job.phases && job.phases.sanding1;
                            } else if (workingDayNum <= undercoatEnd) {
                                phaseKey = 'undercoat';
                                phaseColor = '#8b4513';
                                phaseLabel = 'U';
                                isStrikeThrough = job.phases && job.phases.undercoat;
                            } else if (workingDayNum <= sanding2End) {
                                phaseKey = 'sanding2';
                                phaseColor = '#ff9500';
                                phaseLabel = 'S2';
                                isStrikeThrough = job.phases && job.phases.sanding2;
                            } else if (workingDayNum <= topCoatEnd) {
                                phaseKey = 'topcoat';
                                phaseColor = '#9c27b0';
                                phaseLabel = 'T';
                                isStrikeThrough = job.phases && job.phases.topcoat;
                            } else if (workingDayNum <= inspectEnd) {
                                phaseKey = 'inspect';
                                phaseColor = '#673ab7';
                                phaseLabel = 'I';
                                isStrikeThrough = job.phases && job.phases.inspect;
                            } else if (workingDayNum <= completionDay) {
                                phaseKey = 'complete';
                                phaseColor = '#34c759';
                                phaseLabel = 'C';
                                isStrikeThrough = job.phases && job.phases.complete;
                            }
                            
                            if (phaseKey) {
                                barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:${phaseColor}; border:1px solid ${phaseColor}; display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:900; color:#fff; position:relative; cursor:pointer; box-sizing:border-box; ${isStrikeThrough ? 'opacity:0.5; text-decoration:line-through;' : ''}" onclick="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', '${phaseKey}')" title="Click to mark complete">
                                    <span>${phaseLabel}</span>
                                    ${isStrikeThrough ? '<svg style="position:absolute; width:24px; height:24px;" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><line x1="3" y1="3" x2="21" y2="21"/></svg>' : ''}
                                </div>`;
                            } else {
                                barHTML = `<div style="width:28px; min-width:28px; max-width:28px; height:28px; background:#f9f9f9; border:1px solid #eee; box-sizing:border-box;"></div>`;
                            }
                        }
                    }
                    
                    ganttHTML += barHTML;
                });
                
                ganttHTML += '</div>';  // Close timeline bars row
                ganttHTML += `<div style="display:flex; gap:8px; padding:4px 6px; background:transparent; flex-wrap:wrap; align-items:center;">
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.measuring ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'measuring')" style="width:13px; height:13px; cursor:pointer;">
                            <span>M</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.sanding1 ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'sanding1')" style="width:13px; height:13px; cursor:pointer;">
                            <span>S1</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.undercoat ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'undercoat')" style="width:13px; height:13px; cursor:pointer;">
                            <span>U</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.sanding2 ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'sanding2')" style="width:13px; height:13px; cursor:pointer;">
                            <span>S2</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.topcoat ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'topcoat')" style="width:13px; height:13px; cursor:pointer;">
                            <span>T</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.inspect ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'inspect')" style="width:13px; height:13px; cursor:pointer;">
                            <span>I</span>
                        </label>
                        <label style="display:flex; align-items:center; gap:3px; font-size:9px; font-weight:700; cursor:pointer;">
                            <input type="checkbox" ${job.phases && job.phases.complete ? 'checked' : ''} onchange="toggleJobPhaseById('${job.jobNum}', '${job.dateReceived}', '${job.client}', 'complete')" style="width:13px; height:13px; cursor:pointer;">
                            <span>C</span>
                        </label>
                        <button onclick="markJobComplete(${originalIdx})" style="border:none; background:#34c759; color:#fff; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">‚úì DONE</button>
                        </div>
                    </div>
                </div>`;
            }
        });
        ganttHTML += '</div>';
        
        // Legend
        ganttHTML += `<div style="margin-top:15px;">
            <div style="background:#f0f0f0; padding:10px; border-radius:6px; margin-bottom:10px;">
                <p style="margin:0 0 8px 0; font-weight:900; font-size:11px; color:#333;">üìÖ Timeline Counts WORKING DAYS ONLY</p>
                <p style="margin:0; font-size:9px; color:#666;"><strong>Example:</strong> If Measuring = 2 days, it shows M/T (Mon-Tue). If Sanding = 8 days starting Wed, it shows W/T/F (3) + skip weekend + M/T/W/T (4) = 8 working days total across 2 weeks</p>
            </div>
            <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:12px; font-size:8px; font-weight:900;">
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#2196f3; border:1px solid #1976d2; border-radius:2px;"></div>
                <span>M = Measuring</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#ff9500; border:1px solid #f57c00; border-radius:2px;"></div>
                <span>S1/S2 = Sanding</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#8b4513; border:1px solid #5c2e0a; border-radius:2px;"></div>
                <span>U = Undercoat</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#9c27b0; border:1px solid #7b1fa2; border-radius:2px;"></div>
                <span>T = Top Coat</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#673ab7; border:1px solid #512da8; border-radius:2px;"></div>
                <span>I = Inspect</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#34c759; border:1px solid #28a745; border-radius:2px;"></div>
                <span>C = Complete</span>
            </div>
            <div style="display:flex; align-items:center; gap:4px;">
                <div style="width:14px; height:14px; background:#fafafa; border:1px solid #f0f0f0; border-radius:2px;"></div>
                <span>Weekend (no work)</span>
            </div>
        </div>`;
        
        ganttChart.innerHTML = ganttHTML;
        
        // COUNT ACTUAL JOB DIVS IN DOM
        const jobDivs = ganttChart.querySelectorAll('div[style*="margin-bottom:12px"]');
        jobDivs.forEach((div, idx) => {
        });
        } catch (error) {
            ganttChart.innerHTML = `<div style="padding:20px; color:#ff3b30; background:#ffebee; border-radius:6px;"><strong>Error loading schedule:</strong> ${error.message}</div>`;
        }
    }


    
    function toggleGanttCell(jobIdx, phaseKey) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[jobIdx];
        
        if (!job) return;
        if (!job.phases) job.phases = {};
        
        job.phases[phaseKey] = !job.phases[phaseKey];
        
        history[jobIdx] = job;
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        // Sync to Firebase in background (async)
        if (window.syncJobsToFirebase) {
            setTimeout(() => window.syncJobsToFirebase(), 100);
        }
        
        // Update workload summary ONLY (don't re-render entire schedule)
        renderJobTasks();
        
        // Show notification
        notify(job.phases[phaseKey] ? `‚úì ${phaseKey} marked complete` : `‚óã ${phaseKey} marked pending`);
    }
    
    function renderGlobalNotifications() {
        const notificationsDiv = document.getElementById('globalNotifications');
        if (!notificationsDiv) return; // Exit if not on Schedule tab
        
        const adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        
        // Update badge count
        updateNotificationBadge();
        
        if (adminAlerts.length === 0) {
            notificationsDiv.innerHTML = '<p style="color:#999; text-align:center; font-size:12px;">No notifications yet</p>';
            return;
        }
        
        let notificationsHTML = '';
        adminAlerts.slice(0, 5).forEach((alert, i) => {
            const alertDate = new Date(alert.timestamp);
            notificationsHTML += `<div style="padding:10px; border-bottom:1px solid #ddd; background:#fff; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:4px;">
                        <div style="font-weight:900; color:#34c759; font-size:11px;">‚úì Job Completed</div>
                        <button onclick="deleteAdminAlert(${i})" style="background:#ff3b30; color:#fff; border:none; padding:4px 8px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer; white-space:nowrap; margin-left:8px;">‚úï DISMISS</button>
                    </div>
                    <div style="font-size:10px; color:#000; font-weight:700; margin:2px 0;">Job #${alert.jobNum}: ${alert.jobName}</div>
                    <div style="font-size:9px; color:#666;">${alert.client} ‚Ä¢ ${alert.totalParts} parts ‚Ä¢ ${alert.totalSqm} SQM</div>
                    <div style="font-size:9px; color:#999; margin-top:4px;">
                        ${alertDate.toLocaleDateString('en-AU')} ${alertDate.toLocaleTimeString('en-AU', {hour: '2-digit', minute: '2-digit'})}
                    </div>
                </div>
            </div>`;
        });
        
        if (adminAlerts.length > 5) {
            notificationsHTML += `<div style="padding:10px; text-align:center; color:#999; font-size:10px;">+${adminAlerts.length - 5} more notifications</div>`;
        }
        
        notificationsDiv.innerHTML = notificationsHTML;
    }
    
    // Toggle notifications visibility and update badge
    function toggleNotifications() {
        const notifDiv = document.getElementById('globalNotifications');
        const badge = document.getElementById('notificationBadge');
        const btn = event.target;
        
        if (notifDiv.style.display === 'none') {
            // Show notifications
            notifDiv.style.display = 'block';
            btn.innerText = '‚àí';
        } else {
            // Hide notifications
            notifDiv.style.display = 'none';
            btn.innerText = '+';
        }
    }
    
    // Update notification badge count
    function updateNotificationBadge() {
        const adminAlerts = JSON.parse(localStorage.getItem('adminAlerts')) || [];
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            badge.innerText = adminAlerts.length;
            badge.style.display = adminAlerts.length > 0 ? 'flex' : 'none';
        }
    }
    
    function checkForNewUnallocatedDoors() {
        const unallocated = getUnallocatedDoors();
        if (unallocated.length > 0) {
            console.log(`‚ö†Ô∏è Found ${unallocated.length} unallocated door(s):`);
            unallocated.forEach(door => console.log(`  - ${door.name}`));
            showUnallocatedDoorsNotification(unallocated);
        }
    }
    
    // Show red notification for unallocated doors
    function showUnallocatedDoorsNotification(unallocated) {
        const alertArea = document.getElementById('globalNotifications');
        if (!alertArea) return;
        
        // Check if notification already exists
        const existingAlert = alertArea.querySelector('[data-alert="unallocated-doors"]');
        if (existingAlert) {
            existingAlert.remove();
        }
        
        // Remove placeholder
        const placeholder = alertArea.querySelector('p');
        if (placeholder) placeholder.remove();
        
        const alertHTML = `
            <div data-alert="unallocated-doors" style="background:#ffebee; border-left:4px solid #ff3b30; padding:12px; margin-bottom:8px; border-radius:4px; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="font-weight:900; color:#ff3b30; margin-bottom:6px; font-size:12px;">
                        ‚ö†Ô∏è ${unallocated.length} DOOR(S) NEED ALLOCATING
                    </div>
                    <div style="color:#d32f2f; font-size:11px;">
                        ${unallocated.map(d => `‚Ä¢ ${d.name}`).join('<br>')}
                    </div>
                    <div style="margin-top:8px; display:flex; gap:8px;">
                        <button onclick="tab('admin'); setTimeout(() => switchAdminTab('pricing'), 200)" style="background:#ff3b30; color:#fff; border:none; padding:6px 12px; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer;">
                            GO TO MATRIX ‚Üí
                        </button>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" style="background:#ff3b30; color:#fff; border:none; padding:6px 12px; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer; white-space:nowrap; margin-left:8px; height:fit-content;">
                    ‚úï DISMISS
                </button>
            </div>
        `;
        
        alertArea.innerHTML += alertHTML;
        console.log(`üîî Shown notification for ${unallocated.length} unallocated door(s)`);
    }

    // Helper function to get the calendar date that corresponds to N working days from a start date
    // Helper function to check if a day is a weekday (Monday-Friday)
    const isWeekday = (date) => {
        const dayOfWeek = date.getDay();
        return dayOfWeek !== 0 && dayOfWeek !== 6; // 0=Sunday, 6=Saturday
    };
    
    // Helper to count working days from start date to a calendar date
    function getWorkingDayNumber(startDate, targetDate) {
        let count = 0;
        let currentDate = new Date(startDate);
        
        while (currentDate <= targetDate) {
            if (isWeekday(currentDate)) {
                count++;
            }
            if (currentDate.toDateString() === targetDate.toDateString()) {
                return count;
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return -1; // Target date is before start date
    }
    
    

    function toggleJobPhaseById(jobNum, dateReceived, client, phaseKey) {
        try {
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            
            // Find job by unique identifiers (not by array index)
            const jobIdx = history.findIndex(j => j.jobNum === jobNum && j.dateReceived === dateReceived && j.client === client);
            
            if (jobIdx < 0) {
                console.error('‚ùå Job not found:', jobNum, dateReceived, client);
                notify('‚ö†Ô∏è Error: Job not found');
                return;
            }
            
            const job = history[jobIdx];
            if (!job.phases) job.phases = {};
            
            // Get current state BEFORE toggle
            const wasComplete = job.phases[phaseKey] || false;
            
            // Toggle the phase
            job.phases[phaseKey] = !wasComplete;
            const isNowComplete = job.phases[phaseKey];
            
            console.log(`üìã Job #${jobNum} - Phase "${phaseKey}": ${wasComplete ? '‚úì' : '‚óã'} ‚Üí ${isNowComplete ? '‚úì' : '‚óã'}`);
            
            // Update in history
            history[jobIdx] = job;
            localStorage.setItem('jobHistory', JSON.stringify(history));
            
            // Sync to Firebase
            if (window.syncJobsToFirebase) {
                try {
                    window.syncJobsToFirebase();
                    console.log('üîÑ Synced to Firebase');
                } catch(e) {
                    console.error('Firebase sync error:', e);
                }
            }
            
            // Update workload summary
            renderJobTasks();
            
            // Show notification
            notify(isNowComplete ? `‚úì ${phaseKey} done` : `‚óã ${phaseKey} reset`);
            
            // Re-render Gantt chart
            renderScheduleCalendar();
            
        } catch(e) {
            console.error('toggleJobPhaseById error:', e);
            notify('‚ö†Ô∏è Error updating phase');
        }
    }

    function toggleJobPhase(jobIdx, phaseKey) {
        toggleGanttCell(jobIdx, phaseKey);
    }

    function markJobComplete(jobIdx) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[jobIdx];
        
        if (!job) {
            alert('Error: Job not found');
            return;
        }
        
        // Check if all phases are complete
        if (!job.phases || !job.phases.measuring || !job.phases.sanding || !job.phases.topcoat || !job.phases.inspect || !job.phases.complete) {
            if (!confirm('Not all phases are marked complete. Complete job anyway?')) {
                return;
            }
        }
        
        
        // Mark job as complete
        job.completed = true;
        job.completedDate = new Date().toISOString();
        
        history[jobIdx] = job;
        localStorage.setItem('jobHistory', JSON.stringify(history));
        
        
        // Generate PDFs and alert admins
        try {
            generateBatchPDFs(job);
        } catch(e) {
        }
        
        try {
            alertAdmins(job);
        } catch(e) {
        }
        
        renderHistory();
        renderScheduleCalendar();
        notify('‚úì Job Marked Complete');
        
        // Switch to History tab to show completed job
        setTimeout(() => {
            tab('history');
            filterHistory('completed');
        }, 500);
    }

    function switchAdminTab(tab) {
        // Hide all admin tabs
        document.getElementById('admin-tab-general-content').style.display = 'none';
        document.getElementById('admin-tab-colours-content').style.display = 'none';
        document.getElementById('admin-tab-pricing-content').style.display = 'none';
        
        // Remove active class from all buttons
        document.getElementById('admin-tab-general').classList.remove('active');
        document.getElementById('admin-tab-colours').classList.remove('active');
        document.getElementById('admin-tab-pricing').classList.remove('active');
        
        // Show selected tab and mark button as active
        if (tab === 'general') {
            document.getElementById('admin-tab-general-content').style.display = 'block';
            document.getElementById('admin-tab-general').classList.add('active');
        } else if (tab === 'colours') {
            document.getElementById('admin-tab-colours-content').style.display = 'block';
            document.getElementById('admin-tab-colours').classList.add('active');
            renderColorCustomizer();
        } else if (tab === 'pricing') {
            document.getElementById('admin-tab-pricing-content').style.display = 'block';
            document.getElementById('admin-tab-pricing').classList.add('active');
            renderPricingMatrix(); // Load pricing matrix when tab opens
            checkForNewUnallocatedDoors(); // Check and notify about unallocated doors
        }
    }

    // PAINT FORMULA MANAGER
    function renderPaintFormulaList() {
        const target = document.getElementById('paintFormulaList');
        if (!target) return;
        
        const formulas = getPaintFormulas();
        
        let html = '';
        
        if (formulas.length === 0) {
            html += `<div style="padding:20px; text-align:center; color:#999; font-size:11px;">No formulas yet. Add one above!</div>`;
        } else {
            formulas.forEach((f, idx) => {
                html += `<div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                    <div style="flex:1;">
                        <div style="font-weight:900; font-size:12px; color:#000;">${f.brand} - ${f.color}</div>
                        <div style="font-size:10px; color:#666; margin-top:3px;">${f.formula}</div>
                    </div>
                    <button onclick="deletePaintFormulaDB(${idx})" style="padding:4px 10px; background:#ff3b3015; color:#ff3b30; border:none; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer;">DELETE</button>
                </div>`;
            });
        }
        
        target.innerHTML = html;
    }
    
    function addNewPaintFormula() {
        const brand = document.getElementById('newPaintBrand')?.value.trim();
        const color = document.getElementById('newPaintColor')?.value.trim();
        const formula = document.getElementById('newPaintFormula')?.value.trim();
        
        if (!brand || !color || !formula) {
            alert('Please fill in all fields');
            return;
        }
        
        const formulas = getPaintFormulas();
        formulas.push({ brand, color, formula });
        savePaintFormulas(formulas);
        
        document.getElementById('newPaintBrand').value = '';
        document.getElementById('newPaintColor').value = '';
        document.getElementById('newPaintFormula').value = '';
        
        renderPaintFormulaList();
        notify('‚úì Formula Added');
    }
    
    function deletePaintFormulaDB(idx) {
        if (confirm('Delete this formula?')) {
            const formulas = getPaintFormulas();
            formulas.splice(idx, 1);
            savePaintFormulas(formulas);
            renderPaintFormulaList();
            notify('‚úì Formula Deleted');
        }
    }

    function renderPaintFormulaManager() {
        // Deprecated - now using Database tab instead
        renderPaintFormulaList();
    }

    // COLOR CUSTOMIZER
    const defaultColors = {
        'Primary Blue': '#2196f3',
        'Gold/Highlight': '#d4af37',
        'Success Green': '#34c759',
        'Sanding Phase 1 (S1)': '#ff9500',
        'Sanding Phase 2 (S2)': '#ff9500',
        'Error Red': '#ff3b30',
        'Measuring Blue (M)': '#2196f3',
        'Undercoat Brown (U)': '#8b4513',
        'TopCoat Purple (T)': '#9c27b0',
        'Inspect Purple (I)': '#673ab7',
        'Complete Green (C)': '#34c759',
        'Background Light': '#f9f9f9',
        'Border Gray': '#ddd',
        'Text Dark': '#000',
        'Text Gray': '#666',
        'PANEL Button': '#34c759',
        'DOOR Button': '#ff9500',
        'DRAWER Button': '#2196f3',
        'CUSTOM Button': '#af52de',
        'FLAT Mode Active': '#fff',
        'FLAT Mode Inactive': '#f5f5f5',
        'MOULDED Mode Active': '#fff',
        'MOULDED Mode Inactive': '#f5f5f5',
        'SS Mode Background': '#333',
        'SS Mode Text': '#d4af37',
        'DS Mode Background': '#333',
        'DS Mode Text': '#d4af37',
        'SE Mode Background': '#333',
        'SE Mode Text': '#d4af37',
        '1LR Edge Active': '#34c759',
        '2SR Edge Active': '#34c759'
    };
    
    const colorDescriptions = {
        'Primary Blue': 'üíæ SAVE button, Edit pencil icons, SQM display (#) in schedule row',
        'Gold/Highlight': 'üè∑Ô∏è Job numbers (#001, #002, #003) displayed in schedule',
        'Success Green': '‚úì SAVE & ‚úì DONE buttons, complete checkmarks, success messages',
        'Sanding Phase 1 (S1)': 'üü† Sanding Phase 1 bar (S1) in Gantt timeline',
        'Sanding Phase 2 (S2)': 'üü† Sanding Phase 2 bar (S2) in Gantt timeline',
        'Error Red': '‚ùå Delete (√ó) buttons throughout app',
        'Measuring Blue (M)': 'üîµ Measuring Phase bar (M) in Gantt timeline',
        'Undercoat Brown (U)': 'üü§ Undercoat Phase bar (U) in Gantt timeline',
        'TopCoat Purple (T)': 'üü£ Top Coat Phase bar (T) in Gantt timeline',
        'Inspect Purple (I)': 'üü£ Inspect & Wrap Phase bar (I) in Gantt timeline',
        'Complete Green (C)': '‚úì Complete Phase bar (C) in Gantt timeline',
        'Background Light': '‚¨ú Checkboxes container, light card backgrounds',
        'Border Gray': '‚îÅ‚îÅ All borders, divider lines, frame edges',
        'Text Dark': 'Primary text color - job titles, headings',
        'Text Gray': 'Secondary text - labels, metadata, timestamps',
        'PANEL Button': 'üü© PANEL button in Measure tab (part type selector)',
        'DOOR Button': 'üü† DOOR button in Measure tab (part type selector)',
        'DRAWER Button': 'üü¶ DRAWER button in Measure tab (part type selector)',
        'CUSTOM Button': 'üü™ CUSTOM button in Measure tab (part type selector)',
        'FLAT Mode Active': 'üî≤ FLAT button when SELECTED (active state)',
        'FLAT Mode Inactive': '‚¨ú FLAT button when NOT selected (inactive state)',
        'MOULDED Mode Active': 'üî≤ MOULDED button when SELECTED (active state)',
        'MOULDED Mode Inactive': '‚¨ú MOULDED button when NOT selected (inactive state)',
        'SS Mode Background': '‚¨õ SS (Single Sided) edge mode background when SELECTED',
        'SS Mode Text': 'üü® SS (Single Sided) edge mode text color when SELECTED',
        'DS Mode Background': '‚¨õ DS (Double Sided) edge mode background when SELECTED',
        'DS Mode Text': 'üü® DS (Double Sided) edge mode text color when SELECTED',
        'SE Mode Background': '‚¨õ SE (Single Edge) mode background when SELECTED',
        'SE Mode Text': 'üü® SE (Single Edge) mode text color when SELECTED',
        '1LR Edge Active': 'üü¢ 1LR (One Left/Right) edge checkbox active color when CHECKED',
        '2SR Edge Active': 'üü¢ 2SR (Two Side Right) edge checkbox active color when CHECKED'
    };
    
    let appColors = JSON.parse(localStorage.getItem('appColors')) || defaultColors;
    
    function renderColorCustomizer() {
        const target = document.getElementById('colorCustomizerContent');
        if (!target) return;
        
        let html = '';
        
        Object.keys(appColors).forEach(colorName => {
            const colorValue = appColors[colorName];
            const description = colorDescriptions[colorName] || '';
            html += `
                <div style="padding:12px; border:1px solid #ddd; border-radius:6px; background:#fff;">
                    <label style="display:block; font-weight:900; font-size:12px; margin-bottom:2px; color:#000;">${colorName}</label>
                    <div style="font-size:10px; color:#666; margin-bottom:10px; line-height:1.4;">${description}</div>
                    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
                        <input type="color" value="${colorValue}" id="color_${colorName.replace(/[^a-zA-Z0-9]/g, '_')}" onchange="updateAppColor('${colorName}', this.value)" style="width:50px; height:40px; border:1px solid #ddd; border-radius:4px; cursor:pointer;">
                        <input type="text" value="${colorValue}" id="colorText_${colorName.replace(/[^a-zA-Z0-9]/g, '_')}" onchange="updateAppColor('${colorName}', this.value)" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:11px; font-family:monospace;">
                    </div>
                    <div style="padding:12px; border-radius:4px; background:${colorValue}; color:${parseInt(colorValue.replace('#', ''), 16) > 0x888888 ? '#000' : '#fff'}; font-weight:900; text-align:center; font-size:12px;">Preview</div>
                </div>
            `;
        });
        
        html += `<div style="grid-column:1/-1; margin-top:10px; padding:10px; background:#f0f0f0; border-radius:6px; text-align:center;">
            <button onclick="resetAppColors()" style="padding:10px 20px; background:#999; color:#fff; border:none; border-radius:6px; font-weight:900; cursor:pointer;">RESET TO DEFAULT</button>
        </div>`;
        
        target.innerHTML = html;
    }
    
    function updateAppColor(colorName, colorValue) {
        appColors[colorName] = colorValue;
        localStorage.setItem('appColors', JSON.stringify(appColors));
        
        const safeId = colorName.replace(/[^a-zA-Z0-9]/g, '_');
        
        // Update color input and text field
        const colorInput = document.getElementById('color_' + safeId);
        const colorText = document.getElementById('colorText_' + safeId);
        
        if (colorInput) colorInput.value = colorValue;
        if (colorText) colorText.value = colorValue;
        
        applyAppColors();
        notify('‚úì Color Updated');
    }
    
    function resetAppColors() {
        if (confirm('Reset all colors to default?')) {
            appColors = JSON.parse(JSON.stringify(defaultColors));
            localStorage.setItem('appColors', JSON.stringify(appColors));
            renderColorCustomizer();
            applyAppColors();
            notify('‚úì Colors Reset');
        }
    }
    
    function applyAppColors() {
        const root = document.documentElement;
        root.style.setProperty('--primary-blue', appColors['Primary Blue']);
        root.style.setProperty('--gold', appColors['Gold/Highlight']);
        root.style.setProperty('--success', appColors['Success Green']);
        root.style.setProperty('--warning', appColors['Warning Orange']);
        root.style.setProperty('--error', appColors['Error Red']);
    }
    
    // Apply colors on page load
    applyAppColors();
    const defaultMasterMatrix = {
        "Tier 1": { 101: ["Plain", 125, 125, 152, 152], 102: ["J-Mould", 148, 148, 171, 171], 103: ["Sharknose", 148, 148, 171, 171], 104: ["Bevelled Edge", 148, 148, 171, 171] },
        "Tier 2": { 201: ["Ashlee", 148, 148, 171, 171], 202: ["Hamilton", 148, 148, 171, 171], 203: ["Vertical Grooves", 148, 148, 171, 171] },
        "Tier 3": { 301: ["Tarrone", 156, 156, 182, 182], 302: ["Bobby", 156, 156, 182, 182], 303: ["Orford", 156, 156, 182, 182] },
        "Tier 4": { 401: ["Shaker", 171, 171, 194, 194], 402: ["Shaker 45", 171, 171, 194, 194], 403: ["Shaker w/Lines", 180, 180, 203, 203], 404: ["Jack", 180, 180, 203, 203] },
        "Tier 5": { 501: ["Georgia", 183, 183, 211, 211], 502: ["Branxholme", 183, 183, 211, 211], 503: ["Rosebrook", 183, 183, 211, 211] },
        "Other": { 600: ["Benchtop", 160, 160, 160, 160], 700: ["Molding", 110, 110, 110, 110] }
    };
    
    // Load from localStorage or use defaults
    let storedMatrix = null;
    try {
        storedMatrix = JSON.parse(localStorage.getItem('masterMatrix'));
    } catch (e) {
        // If parsing fails, use defaults
    }
    
    let masterMatrix = (storedMatrix && Object.keys(storedMatrix).length > 0) ? storedMatrix : defaultMasterMatrix;
    
    // Always ensure defaults are saved
    localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
    
    function renderPricingMatrix() {
        const target = document.getElementById('admin-pricing-matrix');
        if (!target) return;
        
        
        let html = `
            <div style="margin-bottom:15px; display:flex; gap:10px; flex-wrap:wrap;">
                <button onclick="restoreDefaultProfiles()" style="background:#ff9500; color:#fff; border:none; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">
                    üîÑ RESTORE DEFAULT DOOR PROFILES
                </button>
                <button onclick="clearFirebaseProfilesData()" style="background:#d32f2f; color:#fff; border:none; padding:10px 15px; border-radius:6px; font-weight:900; font-size:11px; cursor:pointer;">
                    üóëÔ∏è CLEAR FIREBASE (Fix Stale Data)
                </button>
            </div>
            <p style="font-size:10px; color:#666; margin-bottom:15px;">
                Click "Restore Defaults" to reset to 20 standard profiles. Click "Clear Firebase" if unallocated doors keep reappearing (clears old Firebase data and forces fresh sync).
            </p>
            
            <table style="width:100%; border-collapse:collapse; font-size:10px; background:#fff;">
                <tr style="background:#000; color:var(--gs); font-weight:900;">
                    <th style="padding:8px; text-align:left; width:150px;">Profile</th>
                    <th style="padding:8px; text-align:center;">Matt</th>
                    <th style="padding:8px; text-align:center;">Satin</th>
                    <th style="padding:8px; text-align:center;">Semi-Gloss</th>
                    <th style="padding:8px; text-align:center;">Gloss</th>
                </tr>
        `;
        
        Object.keys(masterMatrix).forEach(tierName => {
            html += `<tr style="background:#eee;"><td colspan="5" style="padding:8px; font-weight:900; color:#000;">${tierName}</td></tr>`;
            
            const tier = masterMatrix[tierName];
            Object.keys(tier).forEach(code => {
                const data = tier[code];
                const profileName = data[0];
                const prices = data.slice(1);
                
                html += `<tr>
                    <td style="padding:8px;">
                        <div style="font-weight:900;">${profileName}</div>
                        <div style="font-size:9px; color:#999;">(${code})</div>
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[0]}" onchange="updatePricingMatrix('${tierName}', ${code}, 0, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[1]}" onchange="updatePricingMatrix('${tierName}', ${code}, 1, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[2]}" onchange="updatePricingMatrix('${tierName}', ${code}, 2, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                    <td style="padding:8px; text-align:center;">
                        <input type="number" inputmode="numeric" value="${prices[3]}" onchange="updatePricingMatrix('${tierName}', ${code}, 3, this.value)" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:4px; text-align:center;"> $
                    </td>
                </tr>`;
            });
        });
        
        // Unallocated Doors Section
        html += `<tr style="background:#fff3cd; border-top:3px solid #ffb300;"><td colspan="5" style="padding:12px; font-weight:900; color:#000; font-size:12px;">‚ö†Ô∏è UNALLOCATED DOORS (Add to a Tier Below)</td></tr>`;
        
        const unallocatedDoors = getUnallocatedDoors();
        if (unallocatedDoors.length > 0) {
            unallocatedDoors.forEach(door => {
                html += `<tr style="background:#fffaf0;">
                    <td style="padding:8px;">
                        <div style="font-weight:900;">${door.name}</div>
                        <div style="font-size:9px; color:#999;">Unassigned</div>
                    </td>
                    <td colspan="4" style="padding:8px; text-align:center;">
                        <div style="display:flex; gap:5px; margin-bottom:5px; flex-wrap:wrap; justify-content:center;">
                            <input type="number" inputmode="numeric" id="unalloc_matt_${door.code}" value="125" placeholder="Matt" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                            <input type="number" inputmode="numeric" id="unalloc_satin_${door.code}" value="125" placeholder="Satin" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                            <input type="number" inputmode="numeric" id="unalloc_semigloss_${door.code}" value="152" placeholder="Semi" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                            <input type="number" inputmode="numeric" id="unalloc_gloss_${door.code}" value="152" placeholder="Gloss" style="width:50px; padding:4px; border:1px solid #ddd; border-radius:4px; text-align:center; font-size:10px;">
                        </div>
                        <select id="unalloc_tier_${door.code}" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px; font-size:10px;">
                            <option value="">Select Tier...</option>
                            <option value="Tier 1">Tier 1</option>
                            <option value="Tier 2">Tier 2</option>
                            <option value="Tier 3">Tier 3</option>
                            <option value="Tier 4">Tier 4</option>
                            <option value="Tier 5">Tier 5</option>
                            <option value="Other">Other</option>
                        </select>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button onclick="assignDoorToTier('${door.code}', '${door.name}')" style="flex:1; padding:4px; background:#34c759; color:#fff; border:none; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer;">‚úì ASSIGN</button>
                            <button onclick="deleteUnallocatedDoor('${door.code}', '${door.name}')" style="flex:1; padding:4px; background:#ff3b30; color:#fff; border:none; border-radius:4px; font-weight:900; font-size:10px; cursor:pointer;">üóëÔ∏è DELETE</button>
                        </div>
                    </td>
                </tr>`;
            });
        } else {
            html += `<tr style="background:#fffaf0;"><td colspan="5" style="padding:12px; text-align:center; color:#999; font-size:11px;">No unallocated doors</td></tr>`;
        }
        
        html += `</table>`;
        target.innerHTML = html;
    }
    
    function getUnallocatedDoors() {
        // Get doors that are in database but not in price matrix tiers
        const doorsInMatrix = new Set();
        Object.values(masterMatrix).forEach(tier => {
            Object.keys(tier).forEach(code => {
                doorsInMatrix.add(tier[code][0]); // Store door name
            });
        });
        
        const unallocated = [];
        profiles.forEach((profileName, idx) => {
            if (!doorsInMatrix.has(profileName)) {
                unallocated.push({ name: profileName, code: 9000 + idx });
            }
        });
        return unallocated;
    }
    
    function assignDoorToTier(code, doorName) {
        const tier = document.getElementById(`unalloc_tier_${code}`).value;
        if (!tier) {
            alert('Please select a tier');
            return;
        }
        
        const matt = parseFloat(document.getElementById(`unalloc_matt_${code}`).value) || 125;
        const satin = parseFloat(document.getElementById(`unalloc_satin_${code}`).value) || 125;
        const semiGloss = parseFloat(document.getElementById(`unalloc_semigloss_${code}`).value) || 152;
        const gloss = parseFloat(document.getElementById(`unalloc_gloss_${code}`).value) || 152;
        
        console.log(`‚úì Assigning ${doorName} to ${tier}`);
        
        // Add to tier
        const newCode = parseInt(Object.keys(masterMatrix[tier]).sort().reverse()[0]) + 1;
        masterMatrix[tier][newCode] = [doorName, matt, satin, semiGloss, gloss];
        
        localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
        
        // Remove from unallocated profiles array
        profiles = profiles.filter(p => p !== doorName);
        saveProfilesToStorage(); // SAVE TO STORAGE - CRITICAL!
        console.log(`‚úì Removed ${doorName} from unallocated. Remaining: ${profiles.length}`);
        
        // Sync to Firebase AND delete old profile data
        syncProfilesToFirebase();
        
        renderPricingMatrix();
        notify(`‚úì ${doorName} assigned to ${tier}`);
    }
    
    function deleteUnallocatedDoor(code, doorName) {
        if (!confirm(`Delete ${doorName}?`)) {
            return;
        }
        
        console.log(`üóëÔ∏è Deleting unallocated door: ${doorName}`);
        
        // Remove from profiles array
        profiles = profiles.filter(p => p !== doorName);
        saveProfilesToStorage(); // SAVE TO STORAGE
        console.log(`‚úì Removed from profiles array. Remaining: ${profiles.length}`);
        
        // Sync to Firebase
        syncProfilesToFirebase();
        
        renderPricingMatrix();
        notify(`üóëÔ∏è ${doorName} deleted`);
    }
    
    function updatePricingMatrix(tier, code, priceIndex, val) {
        masterMatrix[tier][code][priceIndex + 1] = parseFloat(val);
        localStorage.setItem('masterMatrix', JSON.stringify(masterMatrix));
        notify('‚úì Price Updated');
    }

    // TIMELINE EDITOR
    let timelineEditMode = null; // 'default' or jobIdx
    let timelineEditData = {};

    function getDefaultTimeline() {
        const defaults = JSON.parse(localStorage.getItem('defaultTimeline')) || {
            measuring: 2,
            sanding1: 16,
            undercoat: 18,
            sanding2: 20,
            topcoat: 22,
            inspect: 24,
            complete: 25
        };
        return defaults;
    }

    function editDefaultTimeline() {
        timelineEditMode = 'default';
        timelineEditData = getDefaultTimeline();
        renderTimelineEditor();
    }

    function editJobTimeline(jobIdx) {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        const job = history[jobIdx];
        
        if (!job) return;
        
        timelineEditMode = jobIdx;
        timelineEditData = job.timeline || getDefaultTimeline();
        renderTimelineEditor();
    }

    function renderTimelineEditor() {
        const content = document.getElementById('timelineEditorContent');
        if (!content) return; // Safety check
        const isDefault = timelineEditMode === 'default';
        
        content.innerHTML = `
            <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Measuring Phase End Day</label>
                    <input type="number" id="edit_measuring" value="${timelineEditData.measuring || 2}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Sanding 1 Phase End Day</label>
                    <input type="number" id="edit_sanding1" value="${timelineEditData.sanding1 || 16}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Undercoat Phase End Day</label>
                    <input type="number" id="edit_undercoat" value="${timelineEditData.undercoat || 18}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Sanding 2 Phase End Day</label>
                    <input type="number" id="edit_sanding2" value="${timelineEditData.sanding2 || 20}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Top Coat Phase End Day</label>
                    <input type="number" id="edit_topcoat" value="${timelineEditData.topcoat || 22}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Inspect & Wrap Phase End Day</label>
                    <input type="number" id="edit_inspect" value="${timelineEditData.inspect || 24}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div style="margin-bottom:15px;">
                    <label style="display:block; font-weight:900; margin-bottom:5px; font-size:11px;">Complete Day (Job Finished)</label>
                    <input type="number" id="edit_complete" value="${timelineEditData.complete || 25}" min="1" max="30" oninput="updateTimelinePreview()" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; box-sizing:border-box;">
                </div>
                
                <div id="timelinePreview" style="background:#e8f5e9; padding:12px; border-radius:6px; border-left:4px solid #34c759; margin-top:15px;">
                    <div style="font-size:10px; color:#333; font-weight:700; line-height:1.6;">
                        <strong style="font-size:11px;">üìÖ Timeline Preview:</strong><br>
                        Days 0-2: Measuring<br>
                        Days 2-16: Sanding 1<br>
                        Days 16-18: Undercoat<br>
                        Days 18-20: Sanding 2<br>
                        Days 20-22: Top Coat<br>
                        Days 22-24: Inspect & Wrap<br>
                        Days 24-25: Complete
                    </div>
                </div>
            </div>
        `;
        
        updateTimelinePreview();
        document.getElementById('timelineModal').style.display = 'flex';
    }

    function updateTimelinePreview() {
        const measuring = parseInt(document.getElementById('edit_measuring')?.value) || 2;
        const sanding1 = parseInt(document.getElementById('edit_sanding1')?.value) || 16;
        const undercoat = parseInt(document.getElementById('edit_undercoat')?.value) || 18;
        const sanding2 = parseInt(document.getElementById('edit_sanding2')?.value) || 20;
        const topcoat = parseInt(document.getElementById('edit_topcoat')?.value) || 22;
        const inspect = parseInt(document.getElementById('edit_inspect')?.value) || 24;
        const complete = parseInt(document.getElementById('edit_complete')?.value) || 25;
        
        const preview = document.getElementById('timelinePreview');
        if (preview) {
            preview.innerHTML = `
                <div style="font-size:10px; color:#333; font-weight:700; line-height:1.6;">
                    <strong style="font-size:11px;">üìÖ Timeline Preview:</strong><br>
                    Days 0-${measuring}: <span style="color:#2196f3; font-weight:900;">Measuring</span><br>
                    Days ${measuring}-${sanding1}: <span style="color:#ff9500; font-weight:900;">Sanding 1</span><br>
                    Days ${sanding1}-${undercoat}: <span style="color:#8b4513; font-weight:900;">Undercoat</span><br>
                    Days ${undercoat}-${sanding2}: <span style="color:#ff9500; font-weight:900;">Sanding 2</span><br>
                    Days ${sanding2}-${topcoat}: <span style="color:#9c27b0; font-weight:900;">Top Coat</span><br>
                    Days ${topcoat}-${inspect}: <span style="color:#673ab7; font-weight:900;">Inspect & Wrap</span><br>
                    Days ${inspect}-${complete}: <span style="color:#34c759; font-weight:900;">Complete</span>
                </div>
            `;
        }
    }

    function saveTimelineEdit() {
        const measuring = parseInt(document.getElementById('edit_measuring').value);
        const sanding1 = parseInt(document.getElementById('edit_sanding1').value);
        const undercoat = parseInt(document.getElementById('edit_undercoat').value);
        const sanding2 = parseInt(document.getElementById('edit_sanding2').value);
        const topcoat = parseInt(document.getElementById('edit_topcoat').value);
        const inspect = parseInt(document.getElementById('edit_inspect').value);
        const complete = parseInt(document.getElementById('edit_complete').value);
        
        // Validate order
        if (measuring >= sanding1 || sanding1 >= undercoat || undercoat >= sanding2 || sanding2 >= topcoat || topcoat >= inspect || inspect >= complete) {
            alert('Timeline days must be in ascending order!');
            return;
        }
        
        const timeline = { measuring, sanding1, undercoat, sanding2, topcoat, inspect, complete };
        
        if (timelineEditMode === 'default') {
            // Save default timeline
            localStorage.setItem('defaultTimeline', JSON.stringify(timeline));
            notify('‚úì Default Timeline Updated');
        } else {
            // Save job-specific timeline
            const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
            const job = history[timelineEditMode];
            if (job) {
                job.timeline = timeline;
                history[timelineEditMode] = job;
                localStorage.setItem('jobHistory', JSON.stringify(history));
                notify('‚úì Job Timeline Updated');
            }
        }
        
        closeTimelineModal();
        renderScheduleCalendar();
    }

    function closeTimelineModal() {
        document.getElementById('timelineModal').style.display = 'none';
        timelineEditMode = null;
    }

    function prevScheduleMonth() {
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() - 1);
        renderScheduleCalendar();
    }

    function nextScheduleMonth() {
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() + 1);
        renderScheduleCalendar();
    }
    
    function toggleJobsChart() {
        const wrapper = document.getElementById('ganttWrapper');
        const monthYear = document.getElementById('scheduleMonthYear');
        const btn = document.getElementById('jobsChartToggleBtn');
        
        if (!wrapper) return;
        
        const isMinimized = localStorage.getItem('jobsChartMinimized') === 'true';
        
        if (isMinimized) {
            // Restore (maximize)
            wrapper.style.display = 'block';
            monthYear.style.display = 'block';
            btn.textContent = '‚àí';
            btn.style.background = '#2196f3';
            btn.title = 'Minimize';
            localStorage.setItem('jobsChartMinimized', 'false');
            console.log('üìä Jobs Chart maximized');
        } else {
            // Minimize
            wrapper.style.display = 'none';
            monthYear.style.display = 'none';
            btn.textContent = '+';
            btn.style.background = '#666';
            btn.title = 'Maximize';
            localStorage.setItem('jobsChartMinimized', 'true');
            console.log('üìä Jobs Chart minimized');
        }
    }
    
    // Restore Jobs Chart state on page load
    function restoreJobsChartState() {
        const isMinimized = localStorage.getItem('jobsChartMinimized') === 'true';
        if (isMinimized) {
            const wrapper = document.getElementById('ganttWrapper');
            const monthYear = document.getElementById('scheduleMonthYear');
            const btn = document.getElementById('jobsChartToggleBtn');
            if (wrapper && monthYear && btn) {
                wrapper.style.display = 'none';
                monthYear.style.display = 'none';
                btn.textContent = '+';
                btn.style.background = '#666';
            }
        }
    }
    
    // Restore on page load
    setTimeout(restoreJobsChartState, 500);
    
    function prevAdminScheduleMonth() {
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() - 1);
        renderAdminGanttChart();
    }

    function nextAdminScheduleMonth() {
        scheduleCalendarDate.setMonth(scheduleCalendarDate.getMonth() + 1);
        renderAdminGanttChart();
    }
    
    function renderAdminGanttChart() {
        const year = scheduleCalendarDate.getFullYear();
        const month = scheduleCalendarDate.getMonth();
        
        // Set month/year header
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        if (document.getElementById('adminScheduleMonthYear')) document.getElementById('adminScheduleMonthYear').innerText = `${monthNames[month]} ${year}`;
        
        const ganttChart = document.getElementById('adminGanttChart');
        if (!ganttChart) return;
        
        try {
            let fullHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
            
            // Sort by received date - newest first
            let history = fullHistory
                .filter(job => !job.completed)
                .filter(job => !isJobDeleted(job.jobNum, job.dateReceived, job.client)) // Exclude deleted jobs
                .sort((a, b) => {
                    let dateA = new Date();
                    let dateB = new Date();
                    
                    // Parse dateReceived in DD/MM/YY format
                    if (a.dateReceived) {
                        if (a.dateReceived.includes('/')) {
                            const [day, month, year] = a.dateReceived.split('/');
                            dateA = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                        } else if (a.dateReceived.includes('-')) {
                            dateA = new Date(a.dateReceived);
                        }
                    }
                    
                    if (b.dateReceived) {
                        if (b.dateReceived.includes('/')) {
                            const [day, month, year] = b.dateReceived.split('/');
                            dateB = new Date(parseInt('20' + year), parseInt(month) - 1, parseInt(day));
                        } else if (b.dateReceived.includes('-')) {
                            dateB = new Date(b.dateReceived);
                        }
                    }
                    
                    return dateB - dateA;
                });
            
            // Build Gantt HTML
            let ganttHTML = '';
            
            // Define phases/timelines
            const phases = ['Prep', 'Paint', 'Assemble', 'Quality'];
            
            // Header
            ganttHTML += `<table style="border-collapse:collapse; width:100%;">
                <tr style="background:#000; color:#fff; border-bottom:3px solid #d4af37;">
                    <th style="padding:12px; text-align:left; width:200px; font-weight:900; font-size:12px;">JOB</th>
                    ${phases.map(p => `<th style="padding:12px; text-align:center; font-weight:900; font-size:11px; border-right:1px solid #fff;">${p}</th>`).join('')}
                </tr>`;
            
            // Rows
            history.forEach((job, idx) => {
                const jobPhases = job.phases || {};
                
                ganttHTML += `<tr style="border-bottom:1px solid #ddd; background:${idx % 2 === 0 ? '#fff' : '#f9f9f9'};">
                    <td style="padding:12px; font-weight:900; font-size:11px; border-right:1px solid #ddd;">
                        <div style="margin-bottom:4px;">#${job.jobNum}</div>
                        <div style="font-size:9px; color:#666;">${job.client}</div>
                    </td>
                    ${phases.map(phase => {
                        const isChecked = jobPhases[phase] || false;
                        return `<td style="text-align:center; padding:8px; border-right:1px solid #ddd;">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleGanttCell(${idx}, '${phase}')" style="width:18px; height:18px; cursor:pointer;">
                        </td>`;
                    }).join('')}
                </tr>`;
            });
            
            ganttHTML += '</table>';
            ganttChart.innerHTML = ganttHTML;
            
        } catch(e) {
            console.error('Error rendering admin Gantt chart:', e);
        }
    }

    function renderJobTasks() {
        const history = JSON.parse(localStorage.getItem('jobHistory')) || [];
        
        let completedTasks = 0;
        let totalTasks = 0;
        
        // Count phases ONLY for ACTIVE (non-completed) jobs
        history.forEach((job, jobIdx) => {
            // Only count tasks for active jobs (not marked as completed)
            if (job.dateReceived && !job.completed) {
                // 7 phases per job: measuring, sanding1, undercoat, sanding2, topcoat, sanding2, topcoat, inspect, complete
                totalTasks += 7;
                
                // Count which phases are completed
                if (job.phases) {
                    if (job.phases.measuring) completedTasks++;
                    if (job.phases.sanding1) completedTasks++;
                    if (job.phases.undercoat) completedTasks++;
                    if (job.phases.sanding2) completedTasks++;
                    if (job.phases.topcoat) completedTasks++;
                    if (job.phases.inspect) completedTasks++;
                    if (job.phases.complete) completedTasks++;
                }
            }
        });
        
        // Update summary
        const activeJobs = history.filter(j => !j.completed).length;
        const totalSqm = history.filter(j => !j.completed).reduce((sum, j) => sum + parseFloat(j.totalSqm || 0), 0);
        
        if (document.getElementById('totalActiveJobs')) document.getElementById('totalActiveJobs').innerText = activeJobs;
        if (document.getElementById('totalTasks')) document.getElementById('totalTasks').innerText = `${completedTasks}/${totalTasks}`;
        if (document.getElementById('totalWorkload')) document.getElementById('totalWorkload').innerText = totalSqm.toFixed(1);
        
        console.log(`üìä Tasks: ${completedTasks}/${totalTasks} | Active Jobs: ${activeJobs}`);
    }

    // PAINT FORMULA MANAGEMENT
    let paintFormulas = JSON.parse(localStorage.getItem('paintFormulas')) || {};

    function openFormulaPopup() {
        const brand = document.getElementById('p-brand').value;
        const color = document.getElementById('p-color').value || "Standard";
        const current = paintFormulas[`${brand}-${color}`] || "10% Thinner, 2:1 Hardener";
        
        let overlay = document.createElement('div');
        overlay.id = 'formula-pop';
        overlay.style = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:9999; display:flex; align-items:center; justify-content:center; padding:20px; box-sizing:border-box;";
        overlay.innerHTML = `
            <div class="card" style="width:100%; max-width:400px; border:2px solid var(--gs);">
                <h3 style="margin-top:0;">‚öóÔ∏è ${brand} Paint Formula</h3>
                <p style="font-size:10px; color:#666; margin-bottom:10px;">Editing mix for: <strong>${color}</strong></p>
                <label>Formula Mix Instructions:</label>
                <textarea id="fEdit" style="width:100%; height:100px; border-radius:8px; border:1px solid #ccc; padding:10px; font-family:monospace; font-size:12px; margin-bottom:10px; box-sizing:border-box;">${current}</textarea>
                <div style="display:flex; gap:10px;">
                    <button onclick="saveFormula('${brand}','${color}')" style="flex:1; background:var(--gs); color:#000; border:none; padding:12px; border-radius:8px; font-weight:900; cursor:pointer;">‚úì SAVE</button>
                    <button onclick="closeFormulaPopup()" style="flex:1; background:#444; color:#fff; border:none; border-radius:8px; font-weight:900; cursor:pointer;">CLOSE</button>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
    }

    function closeFormulaPopup() {
        const popup = document.getElementById('formula-pop');
        if (popup) popup.remove();
    }

    function saveFormula(brand, color) {
        const val = document.getElementById('fEdit').value;
        paintFormulas[`${brand}-${color}`] = val;
        localStorage.setItem('paintFormulas', JSON.stringify(paintFormulas));
        closeFormulaPopup();
        notify("‚úì Formula Saved");
    }

    // PAINT FORMULA DATABASE FUNCTIONS
    function getPaintFormulas() {
        return JSON.parse(localStorage.getItem('paintFormulaDB')) || [];
    }

    function savePaintFormulas(formulas) {
        localStorage.setItem('paintFormulaDB', JSON.stringify(formulas));
    }

    function openPaintFormulaDatabase() {
        document.getElementById('paintFormulaModal').style.display = 'flex';
        renderPaintFormulaList();
    }

    function closePaintFormulaModal() {
        document.getElementById('paintFormulaModal').style.display = 'none';
    }

    function renderPaintFormulaList() {
        const formulas = getPaintFormulas();
        const content = document.getElementById('formulaListContent');
        
        if (formulas.length === 0) {
            content.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:11px;">No formulas in database yet</div>';
            return;
        }
        
        content.innerHTML = '';
        formulas.forEach((formula, idx) => {
            content.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="font-weight:900; font-size:11px; color:#000;">${formula.brand} - ${formula.color}</div>
                    <div style="font-size:10px; color:#666; margin-top:3px;">${formula.formula}</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="selectPaintFormula(${idx})" style="border:none; background:#2196f3; color:#fff; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">SELECT</button>
                    <button onclick="deletePaintFormula(${idx})" style="border:none; background:#ff3b3015; color:#ff3b30; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">DELETE</button>
                </div>
            </div>`;
        });
    }

    function searchPaintFormulas() {
        const brand = document.getElementById('formulaSearchBrand').value.toLowerCase();
        const color = document.getElementById('formulaSearchColor').value.toLowerCase();
        const formulas = getPaintFormulas();
        const content = document.getElementById('formulaListContent');
        
        const filtered = formulas.filter(f => 
            f.brand.toLowerCase().includes(brand) && 
            f.color.toLowerCase().includes(color)
        );
        
        if (filtered.length === 0) {
            content.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:11px;">No matching formulas found</div>';
            return;
        }
        
        content.innerHTML = '';
        filtered.forEach((formula, origIdx) => {
            const idx = formulas.indexOf(formula);
            content.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:start;">
                <div style="flex:1;">
                    <div style="font-weight:900; font-size:11px; color:#000;">${formula.brand} - ${formula.color}</div>
                    <div style="font-size:10px; color:#666; margin-top:3px;">${formula.formula}</div>
                </div>
                <div style="display:flex; gap:5px;">
                    <button onclick="selectPaintFormula(${idx})" style="border:none; background:#2196f3; color:#fff; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">SELECT</button>
                    <button onclick="deletePaintFormula(${idx})" style="border:none; background:#ff3b3015; color:#ff3b30; padding:4px 10px; border-radius:4px; font-weight:900; font-size:9px; cursor:pointer;">DELETE</button>
                </div>
            </div>`;
        });
    }

    function addNewPaintFormula() {
        const brand = document.getElementById('newFormulaBrand').value.trim();
        const color = document.getElementById('newFormulaColor').value.trim();
        const formula = document.getElementById('newFormulaText').value.trim();
        
        if (!brand || !color || !formula) {
            alert('Please fill in all fields');
            return;
        }
        
        const formulas = getPaintFormulas();
        formulas.push({ brand, color, formula });
        savePaintFormulas(formulas);
        
        document.getElementById('newFormulaBrand').value = '';
        document.getElementById('newFormulaColor').value = '';
        document.getElementById('newFormulaText').value = '';
        
        renderPaintFormulaList();
        notify('‚úì Formula Added to Database');
    }

    function selectPaintFormula(idx) {
        const formulas = getPaintFormulas();
        const formula = formulas[idx];
        
        // Populate measure page fields
        document.getElementById('p-brand').value = formula.brand;
        document.getElementById('p-color').value = formula.color;
        document.getElementById('p-code').value = formula.formula;
        
        closePaintFormulaModal();
        notify(`‚úì Selected: ${formula.brand} - ${formula.color}`);
    }

    function deletePaintFormula(idx) {
        if (confirm('Delete this formula?')) {
            const formulas = getPaintFormulas();
            formulas.splice(idx, 1);
            savePaintFormulas(formulas);
            renderPaintFormulaList();
            notify('‚úì Formula Deleted');
        }
    }

    function autoSearchFormula() {
        const brand = document.getElementById('p-brand').value.trim();
        const color = document.getElementById('p-color').value.trim();
        
        if (!brand || !color) return;
        
        const formulas = getPaintFormulas();
        const match = formulas.find(f => 
            f.brand.toLowerCase() === brand.toLowerCase() && 
            f.color.toLowerCase() === color.toLowerCase()
        );
        
        if (match) {
            document.getElementById('p-code').value = match.formula;
            notify(`‚úì Formula: ${match.formula}`);
        } else {
            notify('Formula not found in database');
        }
    }

    function autoSearchFormulaOnType() {
        const brand = document.getElementById('p-brand').value.trim();
        const color = document.getElementById('p-color').value.trim();
        const code = document.getElementById('p-code').value.trim();
        
        // If code field already has text, don't override (user is typing manually)
        if (code && code.length > 0) return;
        
        if (!brand || !color) return;
        
        const formulas = getPaintFormulas();
        const match = formulas.find(f => 
            f.brand.toLowerCase() === brand.toLowerCase() && 
            f.color.toLowerCase() === color.toLowerCase()
        );
        
        if (match) {
            document.getElementById('p-code').value = match.formula;
        }
    }

    // ============ FIREBASE FUNCTIONS ============

    // Login function
    function handleLogin() {
        // Check if Firebase functions are actually available
        if (!window.firebaseAuth || !window.signInWithEmailAndPassword) {
            alert('Firebase not ready yet, please wait a moment and try again');
            return;
        }
        
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        if (!email || !password) {
            errorDiv.textContent = 'Please fill in all fields';
            errorDiv.style.display = 'block';
            return;
        }
        
        window.signInWithEmailAndPassword(email, password)
            .then(() => {
                errorDiv.style.display = 'none';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
            })
            .catch(error => {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            });
    }

    // Signup wrapper function  
    function trySignup() {
        
        if (!window.firebaseReady) {
            // Wait a moment and try again
            setTimeout(() => {
                if (window.firebaseReady) {
                    handleSignup();
                } else {
                    alert('Firebase is still loading. Please wait a moment and try again.');
                }
            }, 1000);
            return;
        }
        
        handleSignup();
    }

    // Signup function
    function handleSignup() {
        
        if (!window.firebaseAuth || !window.createUserWithEmailAndPassword) {
            alert('Firebase not ready yet, please wait a moment and try again');
            return;
        }
        
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');
        
        
        if (!email || !password) {
            errorDiv.textContent = 'Please fill in all fields';
            errorDiv.style.display = 'block';
            return;
        }
        
        if (password.length < 6) {
            errorDiv.textContent = 'Password must be at least 6 characters';
            errorDiv.style.display = 'block';
            return;
        }
        
        window.createUserWithEmailAndPassword(email, password)
            .then(() => {
                errorDiv.style.display = 'none';
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                notify('Account created! You are now logged in.');
            })
            .catch(error => {
                errorDiv.textContent = error.message;
                errorDiv.style.display = 'block';
            });
    }

    // Logout function
    function handleLogout() {
        if (confirm('Log out?')) {
            window.signOut();
        }
    }

    // Save job data to Firebase
    function saveJobToFirebase(jobData) {
        if (!window.currentUser) return;
        
        const jobId = jobData.id || Date.now().toString();
        const jobRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'jobs', jobId);
        window.setDoc(jobRef, {
            ...jobData,
            lastModified: new Date().toISOString(),
            userId: window.currentUser.uid
        }, { merge: true });
    }

    // Load all jobs from Firebase
    async function loadAllDataFromFirebase() {
        if (!window.currentUser) return;
        
        try {
            // Build reference to jobs subcollection properly
            const userDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid);
            const jobsCollectionRef = window.collection(userDocRef, 'jobs');
            const snapshot = await window.getDocs(jobsCollectionRef);
            const jobs = [];
            snapshot.forEach(doc => {
                jobs.push({ ...doc.data(), id: doc.id });
            });
            
            // Update localStorage with Firebase data (for compatibility)
            localStorage.setItem('jobHistory', JSON.stringify(jobs));
            fullHistory = jobs;
            history = jobs.filter(j => !j.completed);
            
            // Update UI - wrapped in try/catch
            try {
                if (typeof renderHistory === 'function') renderHistory();
            } catch (e) {
                console.warn('renderHistory error:', e);
            }
        } catch (err) {
            console.error('Error loading jobs from Firebase:', err);
        }
    }

    // Set up real-time listener for jobs
    function setupRealtimeSync() {
        // Guard: Only set up once
        if (window.realtimeSyncActive) {
            console.log('‚ö†Ô∏è Real-time sync already active, skipping duplicate setup');
            return;
        }
        
        if (!window.currentUser) {
            console.warn('setupRealtimeSync: No current user');
            return;
        }
        
        try {
            console.log('üîÑ Setting up real-time sync listener...');
            const userDocRef = window.doc(window.firebaseDb, 'users', window.currentUser.uid);
            const jobsCollectionRef = window.collection(userDocRef, 'jobs');
            
            // Store the unsubscribe function so we can clean up later
            window.realtimeSyncUnsubscribe = window.onSnapshot(jobsCollectionRef, 
                snapshot => {
                    try {
                        const jobs = [];
                        snapshot.forEach(doc => {
                            jobs.push({ ...doc.data(), id: doc.id });
                        });
                        
                        // Only update if data actually changed
                        const currentHistory = JSON.parse(localStorage.getItem('jobHistory')) || [];
                        if (JSON.stringify(currentHistory) !== JSON.stringify(jobs)) {
                            console.log(`üîÑ Real-time update: ${jobs.length} jobs`);
                            localStorage.setItem('jobHistory', JSON.stringify(jobs));
                            
                            // Only re-render if on history tab to avoid excessive re-renders
                            const historySection = document.getElementById('history');
                            if (historySection && historySection.classList.contains('active')) {
                                renderHistory();
                            }
                        }
                    } catch (e) {
                        console.error('Error processing snapshot:', e);
                    }
                }, 
                error => {
                    console.error('Realtime sync error:', error);
                }
            );
            
            console.log('‚úì Real-time sync listener established');
        } catch (e) {
            console.error('setupRealtimeSync error:', e);
        }
    }

    // Track last synced data to avoid redundant syncs
    let lastSyncedData = '';
    let lastSyncTime = 0;
    const SYNC_DEBOUNCE_MS = 2000; // Minimum 2 seconds between syncs
    
    // Helper function to sync all jobs to Firebase
    function syncJobsToFirebase() {
        // Guard: Wait for Firebase to be ready and user to be logged in
        if (!window.firebaseReady || !window.currentUser || !window.firebaseDb || !window.doc || !window.setDoc) {
            console.warn('Firebase not ready or user not logged in. Sync delayed.');
            return;
        }
        
        // Rate limiting - prevent sync spam
        const now = Date.now();
        if (now - lastSyncTime < SYNC_DEBOUNCE_MS) {
            console.log('‚è±Ô∏è Sync rate limited (too soon)');
            return;
        }
        lastSyncTime = now;
        
        try {
            const jobHistory = JSON.parse(localStorage.getItem('jobHistory') || '[]');
            const currentData = JSON.stringify(jobHistory);
            
            // Only sync if data actually changed
            if (currentData === lastSyncedData) {
                console.log('‚ÑπÔ∏è Data unchanged, skipping Firebase sync');
                return;
            }
            
            console.log(`üîÑ Syncing ${jobHistory.length} jobs to Firebase...`);
            lastSyncedData = currentData;
            
            jobHistory.forEach(job => {
                try {
                    const jobId = job.id || job.jobNum || Date.now().toString();
                    const jobDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'jobs', jobId);
                    window.setDoc(jobDoc, {
                        ...job,
                        id: jobId,
                        lastModified: new Date().toISOString(),
                        userId: window.currentUser.uid
                    }, { merge: true }).catch(err => console.error('Firestore sync error for job', jobId, ':', err));
                } catch(e) {
                    console.error('Error syncing individual job:', e);
                }
            });
            
            console.log('‚úì Firebase sync complete');
        } catch (error) {
            console.error('syncJobsToFirebase error:', error);
            // Don't crash the app, just log the error
        }
    }

    // Sync door profiles and price matrix to Firebase
    // This OVERWRITES the Firebase data with current local state
    function syncProfilesToFirebase() {
        if (!window.firebaseReady || !window.currentUser || !window.firebaseDb || !window.doc || !window.setDoc) {
            console.warn('Firebase not ready or user not logged in. Profile sync delayed.');
            return;
        }

        try {
            const configDoc = window.doc(window.firebaseDb, 'users', window.currentUser.uid, 'config', 'doorProfiles');
            window.setDoc(configDoc, {
                doorProfiles: profiles,
                masterMatrix: masterMatrix,
                lastModified: new Date().toISOString(),
                userId: window.currentUser.uid,
                syncVersion: Date.now() // Force overwrite of old data
            }, { merge: false }).then(() => {
                console.log(`‚úÖ Profiles synced to Firebase (${profiles.length} profiles, ${Object.keys(masterMatrix).length} tiers)`);
            }).catch(err => {
                console.error('‚ùå Error syncing door profiles to Firebase:', err);
            });
        } catch (error) {
            console.error('syncProfilesToFirebase error:', error);
        }
    }

    // Override localStorage.setItem to auto-sync to Firebase
    const originalSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
        originalSetItem.call(this, key, value);
        
        // Whenever jobHistory is updated, sync to Firebase
        if (key === 'jobHistory' && window.currentUser) {
            // Retry sync if Firebase isn't quite ready yet
            if (!window.firebaseReady) {
                setTimeout(() => {
                    if (window.currentUser) syncJobsToFirebase();
                }, 500);
            } else {
                syncJobsToFirebase();
            }
        }
    };

    // Attach tab navigation event listeners (run immediately and on DOMContentLoaded for safety)
    function attachTabListeners() {
        document.querySelectorAll('[data-tab]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const tabName = this.getAttribute('data-tab');
                if (typeof tab === 'function') {
                    tab(tabName);
                }
            });
        });
    }
    
    // Try immediately
    setTimeout(attachTabListeners, 100);
    
    // Also attach on DOMContentLoaded in case script runs before DOM is ready
    document.addEventListener('DOMContentLoaded', attachTabListeners);
</script>

</div> <!-- Close appContainer -->
</body>
</html>
